/**
 * ä¿¡æ¯æ è®¾ç½®ç•Œé¢
 *
 * è´Ÿè´£ç®¡ç†ä¿¡æ¯æ çš„è®¾ç½®ç•Œé¢ï¼š
 * - åŸºç¡€è®¾ç½®é¢æ¿
 * - APIé…ç½®é¢æ¿
 * - ä¸»é¢˜è®¾ç½®é¢æ¿
 * - é¢æ¿ç®¡ç†ç•Œé¢
 * - è®¾ç½®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
 *
 * @class InfoBarSettings
 */

export class InfoBarSettings {
    constructor(configManager, apiIntegration, eventSystem) {
        console.log('[InfoBarSettings] ğŸ”§ ä¿¡æ¯æ è®¾ç½®ç•Œé¢åˆå§‹åŒ–å¼€å§‹');

        this.configManager = configManager;
        this.apiIntegration = apiIntegration;
        this.eventSystem = eventSystem;

        // ğŸ”§ æ³¨å…¥æ•°æ®æ ¸å¿ƒå¼•ç”¨ï¼Œä¾›æ•°æ®å¯¼å‡º/å¯¼å…¥ä½¿ç”¨
        this.unifiedDataCore = this.configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore || null;

        // ğŸ†• ä¸–ç•Œä¹¦ç®¡ç†å™¨å¼•ç”¨
        this.worldBookManager = null;
        this.worldBookConfigPanel = null;
        this.worldBookConfigPanelInitialized = false;

        // å…¨å±€å¹¶å‘/å»é‡æ§åˆ¶æ ‡è®°
        this._customAPIProcessing = false; // è‡ªå®šä¹‰APIå¤„ç†è¿›è¡Œä¸­
        this._boundHandlers = {}; // å­˜æ”¾å·²ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ï¼Œé¿å…é‡å¤ç»‘å®š

        // ğŸ”§ æ–°å¢ï¼šä¿å­˜ç¼“å­˜æœºåˆ¶
        this._lastSaveTimestamp = null; // ä¸Šæ¬¡ä¿å­˜æ—¶é—´æˆ³ï¼Œç”¨äºé˜²æŠ–
        this._savedConfigsCache = null; // é…ç½®ç¼“å­˜ï¼Œç”¨äºå¿«é€Ÿå¯¹æ¯”
        
        // UIå…ƒç´ å¼•ç”¨
        this.container = null;
        this.modal = null;
        this.currentTab = 'basic';

        // è®¾ç½®é¢æ¿
        // ğŸ”§ é‡æ„ï¼šç§»é™¤15ä¸ªåŸºç¡€é¢æ¿å±æ€§ï¼Œç»Ÿä¸€ä½¿ç”¨customPanelsç®¡ç†
        this.panels = {
            basic: null,
            api: null,
            theme: null,
            panels: null,
            advanced: null
            // ğŸ—‘ï¸ å·²åˆ é™¤15ä¸ªåŸºç¡€é¢æ¿å±æ€§ï¼ˆpersonal, world, interactionç­‰ï¼‰
            // ç°åœ¨æ‰€æœ‰é¢æ¿ï¼ˆé¢„è®¾+è‡ªå®šä¹‰ï¼‰éƒ½é€šè¿‡customPanelsç»Ÿä¸€ç®¡ç†
        };

        // è¡¨å•æ•°æ®
        this.formData = {};
        
        // ğŸ†• NPCæ‰¹é‡æ“ä½œçŠ¶æ€
        this.selectedNpcIds = new Set();
        this.batchDeleteInProgress = false;

        // ğŸ¯ æ–°å¢ï¼šNPC AIæ¨¡å¼æ¥¼å±‚æ£€æµ‹çŠ¶æ€
        this.npcAiUpdateFloorCount = 20; // é»˜è®¤20æ¥¼è§¦å‘æ›´æ–°
        this.lastNpcAiMessageCount = 0;
        this.lastNpcAiUpdateMessageId = 0;
        this.npcAiUpdateInProgress = false;

        // åˆå§‹åŒ–çŠ¶æ€
        this.initialized = false;
        this.visible = false;
        this.errorCount = 0;
        this.settingsLoaded = false;
        this.needsSettingsRefresh = false;

        // ğŸ”§ æ–°å¢ï¼šé˜²æŠ–å®šæ—¶å™¨
        this._memoryStatusRefreshTimeout = null;

        // ç»‘å®šæ–¹æ³•
        this.init = this.init.bind(this);
        this.show = this.show.bind(this);
        this.hide = this.hide.bind(this);
        this.createUI = this.createUI.bind(this);
        this.loadSettings = this.loadSettings.bind(this);
        this.saveSettings = this.saveSettings.bind(this);

        // ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        this.bindChatSwitchListener();

        // ğŸ”§ æ–°å¢ï¼šç«‹å³åº”ç”¨ä¿å­˜çš„æ—¥å¿—çº§åˆ«è®¾ç½®ï¼Œæ— éœ€ç­‰å¾…UIç•Œé¢
        // å¼‚æ­¥è°ƒç”¨ï¼Œä¸é˜»å¡æ„é€ å‡½æ•°
        this.applyEarlyLogLevel().catch(error => {
            console.error('[InfoBarSettings] âŒ æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®å¼‚å¸¸:', error);
        });
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåœ¨æ‰©å±•åŠ è½½æ—©æœŸç«‹å³åº”ç”¨ä¿å­˜çš„æ—¥å¿—çº§åˆ«è®¾ç½®
     * æ— éœ€ç­‰å¾…UIç•Œé¢åŠ è½½ï¼Œç›´æ¥ä»é…ç½®ä¸­è¯»å–å¹¶åº”ç”¨
     */
    async applyEarlyLogLevel() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹åº”ç”¨æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®...');

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶è¯»å–é…ç½®
            const context = SillyTavern.getContext();
            if (!context || !context.extensionSettings) {
                console.log('[InfoBarSettings] âš ï¸ SillyTavernä¸Šä¸‹æ–‡æœªå°±ç»ªï¼Œè·³è¿‡æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®');
                return;
            }

            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            // è¯»å–è°ƒè¯•é…ç½®
            const debugEnabled = configs.debug?.enabled || false;
            const logLevel = configs.debug?.logLevel || 'info';

            console.log('[InfoBarSettings] ğŸ“Š ä»é…ç½®è¯»å–æ—¥å¿—è®¾ç½®:', {
                enabled: debugEnabled,
                level: logLevel
            });

            // ç«‹å³åº”ç”¨æ—¥å¿—çº§åˆ«
            const effectiveLevel = debugEnabled ? logLevel : 'none';
            this.applyConsoleLogLevel(effectiveLevel);

            console.log('[InfoBarSettings] âœ… æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨æ—©æœŸæ—¥å¿—çº§åˆ«å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
     */
    bindChatSwitchListener() {
        try {
            if (this.eventSystem) {
                // ç›‘å¬èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œæ¸…ç†æ€»ç»“æ˜¾ç¤ºçŠ¶æ€å¹¶åˆ·æ–°å†å²åˆ—è¡¨
                this.eventSystem.on('summary:chat:changed', (data) => {
                    if (data.action === 'chat_switched') {
                        console.log('[InfoBarSettings] ğŸ”„ æ”¶åˆ°èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œæ¸…ç†æ€»ç»“æ˜¾ç¤ºçŠ¶æ€å¹¶åˆ·æ–°å†å²åˆ—è¡¨');
                        this.hideSummaryContent();
                        this.refreshSummaryHistoryOnChatSwitch();
                    }
                });

                // ğŸ”§ æ–°å¢ï¼šç›‘å¬èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œåˆ·æ–°NPCåˆ—è¡¨
                this.eventSystem.on('chat:changed', async () => {
                    console.log('[InfoBarSettings] ğŸ”„ æ”¶åˆ°èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œåˆ·æ–°NPCåˆ—è¡¨');
                    
                    // ğŸ¯ æ–°å¢ï¼šé‡ç½®NPC AIæ¨¡å¼æ¥¼å±‚æ£€æµ‹çŠ¶æ€
                    this.lastNpcAiMessageCount = 0;
                    this.lastNpcAiUpdateMessageId = 0;
                    console.log('[InfoBarSettings] ğŸ¯ é‡ç½®NPC AIæ¥¼å±‚æ£€æµ‹çŠ¶æ€');
                    
                    // å»¶è¿Ÿåˆ·æ–°ï¼Œç¡®ä¿NPCæ•°æ®åº“å·²åˆ‡æ¢å®Œæˆ
                    setTimeout(async () => {
                        await this.refreshNPCList();
                        // ğŸ¯ é‡æ–°åˆå§‹åŒ–æ¶ˆæ¯è®¡æ•°
                        this.initNpcAiMessageCount();
                    }, 500);
                });

                // ğŸ”§ æ–°å¢ï¼šåŒæ—¶ç›‘å¬NPCæ•°æ®åº“é‡æ–°åŠ è½½äº‹ä»¶
                this.eventSystem.on('npc:db:reloaded', async () => {
                    console.log('[InfoBarSettings] ğŸ”„ æ”¶åˆ°NPCæ•°æ®åº“é‡æ–°åŠ è½½äº‹ä»¶ï¼Œåˆ·æ–°NPCåˆ—è¡¨');
                    await this.refreshNPCList();
                });

                // ğŸ¯ æ–°å¢ï¼šç›‘å¬æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼ˆæ¥¼å±‚æ£€æµ‹ï¼‰
                this.eventSystem.on('message:received', (data) => {
                    this.handleNpcAiMessageReceived(data);
                });

                // ğŸ”§ æ–°å¢ï¼šç›‘å¬æ€»ç»“å®Œæˆäº‹ä»¶ï¼Œè‡ªåŠ¨è§¦å‘éšè—æ¥¼å±‚
                this.eventSystem.on('summary:completed', async (data) => {
                    console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°æ€»ç»“å®Œæˆäº‹ä»¶ï¼Œæ£€æŸ¥è‡ªåŠ¨éšè—:', data);
                    await this.checkAndExecuteAutoHide();
                });

                console.log('[InfoBarSettings] âœ… èŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®šï¼ˆåŒ…æ‹¬NPC AIæ¥¼å±‚æ£€æµ‹å’Œè‡ªåŠ¨éšè—ï¼‰');
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
    }

    /**
     * èŠå¤©åˆ‡æ¢æ—¶åˆ·æ–°æ€»ç»“å†å²
     */
    async refreshSummaryHistoryOnChatSwitch() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ èŠå¤©åˆ‡æ¢ï¼Œåˆ·æ–°æ€»ç»“å†å²åˆ—è¡¨');

            // æ£€æŸ¥æ€»ç»“é¢æ¿æ˜¯å¦å­˜åœ¨
            const summaryHistorySelect = this.modal?.querySelector('#content-summary-history-select');
            if (!summaryHistorySelect) {
                console.log('[InfoBarSettings] â„¹ï¸ æ€»ç»“å†å²é€‰æ‹©æ¡†ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°');
                return;
            }

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            // è·å–å½“å‰èŠå¤©çš„æ€»ç»“å†å²
            const summaryHistory = await summaryManager.getSummaryHistory();

            // é‡æ–°æ¸²æŸ“æ€»ç»“å†å²é€‰æ‹©æ¡†
            this.renderSummaryHistory(summaryHistory);

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²åˆ—è¡¨å·²åˆ·æ–°ï¼Œå½“å‰èŠå¤©æ€»ç»“æ•°é‡:', summaryHistory.length);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ‰“å¼€é”™è¯¯æ—¥å¿—çª—å£ï¼ˆä»…ä¸´æ—¶æ˜¾ç¤ºï¼Œä¸æŒä¹…åŒ–ï¼‰
     */
    openErrorLogModal() {
        try {
            // ğŸ”§ æ·»åŠ ç§»åŠ¨ç«¯é€‚é…æ ·å¼ï¼ˆå‚è€ƒæ·»åŠ å­—æ®µçª—å£ï¼‰
            if (!document.getElementById('error-log-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'error-log-modal-styles';
                style.textContent = `
                    /* ğŸ”§ é®ç½©å±‚ */
                    .error-log-overlay {
                        position: fixed;
                        inset: 0;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 19999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    
                    .error-log-modal {
                        position: relative;
                        width: 600px;
                        max-width: 95vw;
                        max-height: 80vh;
                        background: var(--theme-bg-primary, #1a1a1a);
                        border: 2px solid var(--theme-border-color, #333);
                        border-radius: 8px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                        z-index: 20000;
                        color: var(--theme-text-primary, #e0e0e0);
                        font-family: monospace;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .error-log-header {
                        padding: 15px;
                        border-bottom: 1px solid var(--theme-border-color, #333);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                    }
                    
                    .error-log-header h4 {
                        margin: 0;
                        color: #ff6b6b;
                        font-size: 16px;
                    }
                    
                    .error-log-header .filter-group {
                        margin-top: 8px;
                    }
                    
                    .error-log-header label {
                        margin-right: 10px;
                        font-size: 12px;
                    }
                    
                    .error-log-header select {
                        background: var(--theme-bg-secondary, #333);
                        color: var(--theme-text-primary, #e0e0e0);
                        border: 1px solid var(--theme-border-color, #555);
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 13px;
                    }
                    
                    .error-log-body {
                        padding: 15px;
                        overflow: auto;
                        flex: 1;
                        min-height: 0;
                    }
                    
                    .error-log-body pre {
                        white-space: pre-wrap;
                        margin: 0;
                        font-size: 12px;
                        line-height: 1.4;
                        color: var(--theme-text-primary, #e0e0e0);
                    }
                    
                    /* ğŸ”§ ç§»åŠ¨ç«¯é€‚é… - å‚è€ƒæ·»åŠ å­—æ®µçª—å£ */
                    @media (max-width: 768px) {
                        .error-log-overlay {
                            padding: 10px !important;
                            align-items: flex-start !important;
                            padding-top: 10vh !important;
                        }
                        
                        .error-log-modal {
                            width: 100% !important;
                            max-width: none !important;
                            max-height: 85vh !important;
                            margin: 0 !important;
                            border-radius: 12px !important;
                        }
                        
                        .error-log-header {
                            padding: 12px 16px !important;
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 12px !important;
                            position: sticky !important;
                            top: 0 !important;
                            z-index: 10 !important;
                            background: var(--theme-bg-primary, #1a1a1a) !important;
                        }
                        
                        .error-log-header h4 {
                            font-size: 15px !important;
                        }
                        
                        .error-log-header .header-content {
                            width: 100% !important;
                            display: flex !important;
                            justify-content: space-between !important;
                            align-items: center !important;
                        }
                        
                        .error-log-header .filter-group {
                            margin-top: 0 !important;
                            width: 100% !important;
                            display: flex !important;
                            align-items: center !important;
                            gap: 10px !important;
                        }
                        
                        .error-log-header select {
                            flex: 1 !important;
                            padding: 10px 12px !important;
                            font-size: 16px !important;
                            min-height: 44px !important;
                            border-radius: 6px !important;
                        }
                        
                        .error-log-header button {
                            min-height: 44px !important;
                            padding: 10px 20px !important;
                            font-size: 15px !important;
                            border-radius: 6px !important;
                            white-space: nowrap !important;
                        }
                        
                        .error-log-body {
                            padding: 16px !important;
                            max-height: calc(85vh - 140px) !important;
                            overflow-y: auto !important;
                            -webkit-overflow-scrolling: touch !important;
                        }
                        
                        .error-log-body pre {
                            font-size: 12px !important;
                            line-height: 1.6 !important;
                            word-break: break-word !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // ğŸ”§ åˆ›å»ºé®ç½©å±‚å®¹å™¨
            const overlay = document.createElement('div');
            overlay.className = 'error-log-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'error-log-modal';

            modal.innerHTML = `
                <div class="error-log-header">
                    <div class="header-content">
                        <h4>ğŸ“‹ ç¨‹åºæ—¥å¿—</h4>
                        <div class="header-buttons" style="display: flex; gap: 8px;">
                            <button class="btn btn-small" data-action="export-error-log" style="background: #51cf66; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ğŸ“¥ å¯¼å‡º</button>
                            <button class="btn btn-small" data-action="close-error-log" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å…³é—­</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>è¿‡æ»¤çº§åˆ«:</label>
                        <select id="log-level-filter">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="error">é”™è¯¯</option>
                            <option value="warn">è­¦å‘Š</option>
                            <option value="info">ä¿¡æ¯</option>
                            <option value="debug">è°ƒè¯•</option>
                        </select>
                    </div>
                </div>
                <div class="error-log-body">
                    <pre id="error-log-content"></pre>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const updateLogs = () => {
                const filter = modal.querySelector('#log-level-filter').value;
                const logs = (window.SillyTavernInfobar?.runtimeLogs || [])
                    .filter(item => filter === 'all' || item.level === filter)
                    .map(item => {
                        const time = new Date(item.time).toLocaleString();
                        const levelIcon = {
                            error: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸', debug: 'ğŸ”§'
                        }[item.level] || 'ğŸ“';
                        return `[${time}] ${levelIcon} ${item.message}`;
                    })
                    .join('\n');
                modal.querySelector('#error-log-content').textContent = logs || 'æš‚æ— æ—¥å¿—è®°å½•';
            };

            // åˆå§‹åŠ è½½
            updateLogs();

            // ç»‘å®šè¿‡æ»¤å™¨å˜åŒ–
            modal.querySelector('#log-level-filter').addEventListener('change', updateLogs);

            // ğŸ”§ å¯¼å‡ºæ—¥å¿—åŠŸèƒ½
            const exportLogs = () => {
                try {
                    // è·å–å½“å‰è¿‡æ»¤å™¨çš„æ—¥å¿—
                    const filter = modal.querySelector('#log-level-filter').value;
                    const logs = (window.SillyTavernInfobar?.runtimeLogs || [])
                        .filter(item => filter === 'all' || item.level === filter)
                        .map(item => {
                            const time = new Date(item.time).toLocaleString();
                            const levelIcon = {
                                error: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸', debug: 'ğŸ”§'
                            }[item.level] || 'ğŸ“';
                            const levelText = item.level.toUpperCase().padEnd(5);
                            return `[${time}] [${levelText}] ${levelIcon} ${item.message}`;
                        })
                        .join('\n');
                    
                    if (!logs) {
                        const original = window.__InfobarConsoleOriginal;
                        if (original) {
                            original.warn('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—');
                        }
                        return;
                    }
                    
                    // æ·»åŠ æ–‡ä»¶å¤´ä¿¡æ¯
                    const header = `Information Bar Integration Tool - ç¨‹åºæ—¥å¿—
å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}
è¿‡æ»¤çº§åˆ«: ${filter === 'all' ? 'å…¨éƒ¨' : filter}
æ—¥å¿—æ•°é‡: ${logs.split('\n').length} æ¡
${'='.repeat(80)}

`;
                    const content = header + logs;
                    
                    // åˆ›å»ºBlobå¹¶ä¸‹è½½
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    // ä½¿ç”¨æ—¶é—´æˆ³å‘½å
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').split('.')[0];
                    a.href = url;
                    a.download = `infobar-logs_${timestamp}.log`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    const original = window.__InfobarConsoleOriginal;
                    if (original) {
                        original.info('[InfoBarSettings] âœ… æ—¥å¿—å·²å¯¼å‡º:', a.download);
                    }
                } catch (error) {
                    const original = window.__InfobarConsoleOriginal;
                    if (original) {
                        original.error('[InfoBarSettings] âŒ å¯¼å‡ºæ—¥å¿—å¤±è´¥:', error);
                    }
                }
            };
            
            modal.querySelector('[data-action="export-error-log"]').onclick = exportLogs;
            
            // ğŸ”§ ç»‘å®šå…³é—­äº‹ä»¶ - å…³é—­æ•´ä¸ªé®ç½©å±‚
            const closeModal = () => {
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            };
            
            modal.querySelector('[data-action="close-error-log"]').onclick = closeModal;
            
            // ğŸ”§ ç‚¹å‡»é®ç½©å±‚èƒŒæ™¯å…³é—­
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            };
        } catch (error) {
            const original = window.__InfobarConsoleOriginal;
            if (original) {
                original.error('[InfoBarSettings] âŒ æ‰“å¼€é”™è¯¯æ—¥å¿—çª—å£å¤±è´¥:', error);
            }
        }
    }

    /**
     * æ‰“å¼€é¡¹ç›®åœ°å€
     */
    openProjectLink() {
        try {
            window.open('https://github.com/loveyouguhan/Information-bar-integration-tool.git', '_blank');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€é¡¹ç›®åœ°å€å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨æ§åˆ¶å°æ—¥å¿—çº§åˆ«è¿‡æ»¤
     * level: 'none' | 'error' | 'warn' | 'info' | 'debug'
     */
    applyConsoleLogLevel(level) {
        try {
            // ä½¿ç”¨å…¨å±€é—¨ç¦ç³»ç»Ÿ
            const original = window.__InfobarConsoleOriginal;
            const enableCollection = window.__InfobarEnableCollection;
            
            if (!original || !enableCollection) {
                console.warn('[InfoBarSettings] âš ï¸ æ§åˆ¶å°é—¨ç¦æœªåˆå§‹åŒ–');
                return;
            }

            const rt = window.SillyTavernInfobar.runtimeLogs;
            
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ–°çš„æ”¶é›†å¼€å…³
            const shouldCollect = level !== 'none';
            
            // æ ¹æ®çº§åˆ«è®¾ç½®è¿‡æ»¤å™¨
            const allows = {
                none: { error: false, warn: false, info: false, debug: false },
                error: { error: true, warn: false, info: false, debug: false },
                warn: { error: true, warn: true, info: false, debug: false },
                info: { error: true, warn: true, info: true, debug: false },
                debug: { error: true, warn: true, info: true, debug: true }
            }[level] || { error: true, warn: true, info: true, debug: true };

            // ğŸ”§ ä¿®å¤ï¼šç¦ç”¨æ¨¡å¼ä¸‹å®Œå…¨æ¢å¤åŸç”Ÿconsoleï¼Œä¸æ”¶é›†ä¸è¾“å‡º
            if (level === 'none') {
                enableCollection(false);
                original.info('[InfoBarSettings] ğŸ“Š å·²ç¦ç”¨è°ƒè¯•æ¨¡å¼ï¼Œåœæ­¢æ”¶é›†æ—¥å¿—');
                return;
            }

            // ğŸ”§ å¯ç”¨æ”¶é›†å¹¶é‡æ–°ç»‘å®šconsoleæ–¹æ³•
            enableCollection(true);
            
            const push = (logLevel, args) => {
                try {
                    const message = Array.from(args).map(v =>
                        typeof v === 'string' ? v :
                        typeof v === 'object' ? JSON.stringify(v) : String(v)
                    ).join(' ');
                    rt.push({ level: logLevel, time: Date.now(), message });
                    // ğŸ”§ ä¿®å¤ï¼šå®Œå…¨ç§»é™¤500æ¡é™åˆ¶ï¼Œå…è®¸æ”¶é›†å’Œå¯¼å‡ºæ‰€æœ‰æ—¥å¿—
                } catch {}
            };

            // é‡æ–°ç»‘å®šconsoleæ–¹æ³•ï¼šæ—¢æ”¶é›†åˆæŒ‰çº§åˆ«è¾“å‡º
            console.log = (...args) => {
                push('debug', args);
                if (allows.debug) original.log(...args);
            };
            console.info = (...args) => {
                push('info', args);
                if (allows.info) original.info(...args);
            };
            console.warn = (...args) => {
                push('warn', args);
                if (allows.warn) original.warn(...args);
            };
            console.error = (...args) => {
                push('error', args);
                if (allows.error) original.error(...args);
            };

            // ä½¿ç”¨åŸç”Ÿconsoleè¾“å‡ºè®¾ç½®ç¡®è®¤
            original.info('[InfoBarSettings] ğŸ“Š æ—¥å¿—çº§åˆ«å·²è®¾ç½®ä¸º:', level);
        } catch (error) {
            const original = window.__InfobarConsoleOriginal;
            if (original) {
                original.error('[InfoBarSettings] âŒ è®¾ç½®æ—¥å¿—çº§åˆ«å¤±è´¥:', error);
            }
        }
    }

    /**
     * ä¿å­˜å½“å‰é…ç½®ä¸ºå‘½åé…ç½®
     */
    async saveSettingsProfile() {
        try {
            const nameInput = this.modal.querySelector('#config-profile-name');
            const name = (nameInput?.value || '').trim();
            if (!name) { this.showMessage('è¯·è¾“å…¥é…ç½®åç§°', 'error'); return; }
            const configs = await this.configManager.getAllConfigs();
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            profiles[name] = configs;
            await this.configManager.setConfig('profiles', profiles, false);
            this.showMessage(`å·²ä¿å­˜é…ç½®: ${name}`, 'success');
            this.refreshProfilesSelect();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
            this.showMessage('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async loadSettingsProfile() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            const name = select?.value;
            if (!name) { this.showMessage('è¯·é€‰æ‹©è¦åŠ è½½çš„é…ç½®', 'error'); return; }
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            const profile = profiles[name];
            if (!profile) { this.showMessage('æœªæ‰¾åˆ°é…ç½®: ' + name, 'error'); return; }
            await this.configManager.setConfigs(profile);
            await this.loadSettings();
            this.showMessage(`å·²åŠ è½½é…ç½®: ${name}`, 'success');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
            this.showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async deleteSettingsProfile() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            const name = select?.value;
            if (!name) { this.showMessage('è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®', 'error'); return; }
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            if (!profiles[name]) { this.showMessage('æœªæ‰¾åˆ°é…ç½®: ' + name, 'error'); return; }
            delete profiles[name];
            await this.configManager.setConfig('profiles', profiles, false);
            this.showMessage(`å·²åˆ é™¤é…ç½®: ${name}`, 'success');
            this.refreshProfilesSelect();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤é…ç½®å¤±è´¥:', error);
            this.showMessage('åˆ é™¤é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async refreshProfilesSelect() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            if (!select) return;
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            const current = select.value;
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªé…ç½®</option>' + Object.keys(profiles).map(name => `<option value="${name}">${name}</option>`).join('');
            if (profiles[current]) select.value = current;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°é…ç½®åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    /**
     * åˆå§‹åŒ–è®¾ç½®ç•Œé¢
     */
    async init() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š å¼€å§‹åˆå§‹åŒ–è®¾ç½®ç•Œé¢...');

            if (!this.configManager) {
                throw new Error('é…ç½®ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—
            await this.initializeCustomAPITaskQueue();

            // åˆ›å»ºUI
            this.createUI();

            // ğŸ”§ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åIDï¼ˆç¡®ä¿è®¾è®¡ä¸€è‡´æ€§ï¼‰
            this.migrateTimestampIdPanels();

            // åŠ è½½å½“å‰è®¾ç½®
            await this.loadSettings();

            // ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–ååˆ·æ–°å¯¼èˆªæ ï¼ŒåŠ¨æ€åˆ›å»ºæ‰€æœ‰é¢æ¿çš„å¯¼èˆªé¡¹
            this.refreshNavigation();

            // æ³¨æ„ï¼šäº‹ä»¶ç»‘å®šå·²åœ¨createUI()ä¸­çš„bindNewEvents()å®Œæˆï¼Œé¿å…é‡å¤ç»‘å®š

            this.initialized = true;

            // ğŸ”§ æ–°å¢ï¼šé¢„ç”Ÿæˆå­—æ®µæ˜ å°„ç¼“å­˜ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤ç”Ÿæˆ
            this.preloadCompleteDisplayNameMapping();

            // ğŸ§¹ åˆå§‹åŒ–æ•°æ®æ¸…ç†å·¥å…·
            await this.initDataCleanupTool();

            console.log('[InfoBarSettings] âœ… è®¾ç½®ç•Œé¢åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * ğŸ§¹ åˆå§‹åŒ–æ•°æ®æ¸…ç†å·¥å…·
     */
    async initDataCleanupTool() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ åˆå§‹åŒ–æ•°æ®æ¸…ç†å·¥å…·...');

            // åŠ¨æ€å¯¼å…¥æ•°æ®æ¸…ç†å·¥å…·
            const { DataCleanupTool } = await import('./DataCleanupTool.js');

            // åˆ›å»ºæ•°æ®æ¸…ç†å·¥å…·å®ä¾‹
            this.dataCleanupTool = new DataCleanupTool(
                this.unifiedDataCore,
                this.eventSystem
            );

            console.log('[InfoBarSettings] âœ… æ•°æ®æ¸…ç†å·¥å…·åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ•°æ®æ¸…ç†å·¥å…·å¤±è´¥:', error);
            this.dataCleanupTool = null;
        }
    }

    /**
     * ğŸ§¹ æ‰“å¼€æ•°æ®æ¸…ç†å·¥å…·
     */
    openDataCleanupTool() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ æ‰“å¼€æ•°æ®æ¸…ç†å·¥å…·...');

            if (!this.dataCleanupTool) {
                this.showMessage('æ•°æ®æ¸…ç†å·¥å…·æœªåˆå§‹åŒ–', 'error');
                return;
            }

            // æ˜¾ç¤ºæ•°æ®æ¸…ç†å·¥å…·ç•Œé¢
            this.dataCleanupTool.show();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€æ•°æ®æ¸…ç†å·¥å…·å¤±è´¥:', error);
            this.showMessage('æ‰“å¼€æ•°æ®æ¸…ç†å·¥å…·å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• æ‰“å¼€æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ç®¡ç†å™¨
     */
    async openRegexScriptManager() {
        try {
            console.log('[InfoBarSettings] ğŸ“ æ‰“å¼€æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ç®¡ç†å™¨...');

            // è·å–RegexScriptPanelå®ä¾‹
            const regexScriptPanel = window.SillyTavernInfobar?.modules?.regexScriptPanel;

            if (!regexScriptPanel) {
                console.warn('[InfoBarSettings] âš ï¸ RegexScriptPanelæœªåˆå§‹åŒ–ï¼Œå°è¯•åŠ¨æ€åŠ è½½...');
                
                // åŠ¨æ€å¯¼å…¥RegexScriptPanel
                const { RegexScriptPanel } = await import('./RegexScriptPanel.js');
                
                // è·å–RegexScriptManagerå®ä¾‹
                const regexScriptManager = window.SillyTavernInfobar?.modules?.regexScriptManager;
                
                if (!regexScriptManager) {
                    throw new Error('RegexScriptManageræœªåˆå§‹åŒ–');
                }
                
                // åˆ›å»ºé¢æ¿å®ä¾‹
                const panel = new RegexScriptPanel({
                    regexScriptManager: regexScriptManager,
                    eventSystem: this.eventSystem
                });
                
                // æ˜¾ç¤ºé¢æ¿
                await panel.show();
                return;
            }

            // æ˜¾ç¤ºæ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ç®¡ç†é¢æ¿
            await regexScriptPanel.show();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ç®¡ç†å™¨å¤±è´¥:', error);
            alert(`æ‰“å¼€æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ç®¡ç†å™¨å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—
     */
    async initializeCustomAPITaskQueue() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—...');

            // åŠ¨æ€å¯¼å…¥ä»»åŠ¡é˜Ÿåˆ—æ¨¡å—
            const { CustomAPITaskQueue } = await import('../core/CustomAPITaskQueue.js');

            // åˆ›å»ºä»»åŠ¡é˜Ÿåˆ—å®ä¾‹
            this.customAPITaskQueue = new CustomAPITaskQueue({
                infoBarSettings: this,
                eventSystem: this.eventSystem
            });

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—å¤±è´¥:', error);
            // å¦‚æœä»»åŠ¡é˜Ÿåˆ—åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸæœ‰é€»è¾‘
            this.customAPITaskQueue = null;
        }
    }

    /**
     * åˆ›å»ºUIç•Œé¢
     */
    createUI() {
        try {
            // åˆ›å»ºæ¨¡æ€æ¡†å®¹å™¨
            this.modal = document.createElement('div');
            this.modal.id = 'info-bar-settings-modal';
            this.modal.className = 'info-bar-settings-modal infobar-modal-new';
            this.modal.style.display = 'none';

            this.modal.innerHTML = `
                <div class="modal-overlay" onclick="this.closest('.info-bar-settings-modal').style.display='none'"></div>
                <div class="modal-container">
                    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
                    <div class="modal-header">
                        <div class="header-left">
                            <h2>ä¿¡æ¯åŠ©æ‰‹</h2>
                        </div>
                        <div class="header-right">
                            <div class="success-notification" style="display: block;">
                                <span class="success-text" id="infobar-version-display">
                                    <span id="current-version">åŠ è½½ä¸­...</span> / <span id="latest-version">æ£€æµ‹ä¸­...</span>
                                </span>
                            </div>
                            <button class="modal-close" onclick="this.closest('.info-bar-settings-modal').style.display='none'">Ã—</button>
                        </div>
                    </div>

                    <!-- ä¸»ä½“å†…å®¹åŒºåŸŸ -->
                    <div class="modal-body">
                        <!-- å·¦ä¾§å¯¼èˆªæ  -->
                        <div class="sidebar-nav">
                            <div class="nav-item active" data-nav="basic">
                                åŸºç¡€è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="api">
                                APIé…ç½®
                            </div>
                            <div class="nav-item" data-nav="promptSettings">
                                æç¤ºè¯è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="memoryEnhancement">
                                è®°å¿†å¢å¼º
                            </div>
                            <div class="nav-item" data-nav="vectorFunction">
                                å‘é‡åŠŸèƒ½
                            </div>
                            <div class="nav-item" data-nav="panelManagement">
                                é¢æ¿ç®¡ç†
                            </div>
                            <div class="nav-item" data-nav="summary">
                                å‰§æƒ…æ€»ç»“
                            </div>
                            <div class="nav-item" data-nav="npc-management">
                                NPCç®¡ç†
                            </div>
                            <div class="nav-item" data-nav="plot-optimization">
                                å‰§æƒ…ä¼˜åŒ–
                            </div>
                            <div class="nav-item" data-nav="data-table-config">
                                æ•°æ®è¡¨æ ¼é…ç½®
                            </div>
                            <!-- ğŸ”§ é‡æ„ï¼šåˆ é™¤15ä¸ªç¡¬ç¼–ç çš„åŸºç¡€é¢æ¿å¯¼èˆªé¡¹ -->
                            <!-- ç°åœ¨é€šè¿‡refreshNavigation()åŠ¨æ€åˆ›å»ºæ‰€æœ‰é¢æ¿çš„å¯¼èˆªé¡¹ -->
                            <div class="nav-item" data-nav="theme">
                                ä¸»é¢˜è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="frontend-display">
                                å‰ç«¯æ˜¾ç¤º
                            </div>
                            <div class="nav-item" data-nav="advanced">
                                é«˜çº§è®¾ç½®
                            </div>

                            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
                            <div class="nav-bottom">
                                <!-- å·²ç§»é™¤æ¢å¤æ‰€æœ‰è®¾ç½®æŒ‰é’® -->
                            </div>
                        </div>

                        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
                        <div class="content-area">
                            <div class="content-panel active" data-content="basic">
                                ${this.createBasicPanelNew()}
                            </div>
                            <div class="content-panel" data-content="api">
                                ${this.createAPIPanel()}
                            </div>
                            <div class="content-panel" data-content="promptSettings">
                                ${this.createPromptSettingsPanel()}
                            </div>
                            <div class="content-panel" data-content="memoryEnhancement">
                                ${this.createMemoryEnhancementPanel()}
                            </div>
                            <div class="content-panel" data-content="vectorFunction">
                                ${this.createVectorFunctionPanel()}
                            </div>
                            <div class="content-panel" data-content="panelManagement">
                                ${this.createPanelManagementPanel()}
                            </div>
                            <div class="content-panel" data-content="summary">
                                ${this.createSummaryPanel()}
                            </div>
                            <div class="content-panel" data-content="npc-management">
                                ${this.createNPCManagementPanel()}
                            </div>
                            <div class="content-panel" data-content="plot-optimization">
                                ${this.createPlotOptimizationPanel()}
                            </div>
                            <div class="content-panel" data-content="data-table-config">
                                ${this.createDataTableConfigPanel()}
                            </div>
                            <div class="content-panel" data-content="theme">
                                ${this.createThemePanel()}
                            </div>
                            <div class="content-panel" data-content="frontend-display">
                                ${this.createFrontendDisplayPanel()}
                            </div>
                            <!-- ğŸ”§ é‡æ„ï¼šåˆ é™¤15ä¸ªåŸºç¡€é¢æ¿çš„å†…å®¹é¢æ¿ -->
                            <!-- ç°åœ¨æ‰€æœ‰é¢æ¿éƒ½é€šè¿‡panelManagementç»Ÿä¸€ç®¡ç† -->
                            <div class="content-panel" data-content="advanced">
                                ${this.createAdvancedPanel()}
                            </div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨æ“ä½œæ  -->
                    <div class="modal-footer">
                        <div class="footer-left">
                            <div id="announcement-display" style="
                                max-width: 600px;
                                font-size: 13px;
                                color: var(--theme-text-secondary, #aaa);
                                line-height: 1.5;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                            ">
                                <span style="color: var(--theme-primary-color, #4CAF50);">ğŸ“¢</span>
                                <span id="announcement-content">åŠ è½½å…¬å‘Šä¸­...</span>
                            </div>
                        </div>
                        <div class="footer-right">
                            <button class="btn-cancel" data-action="close">å–æ¶ˆ</button>
                            <button class="btn-save" data-action="save">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(this.modal);

            // ç»‘å®šæ–°çš„äº‹ä»¶
            this.bindNewEvents();

            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼
            this.addButtonClickFixStyles();

            console.log('[InfoBarSettings] ğŸ¨ æ–°UIç•Œé¢åˆ›å»ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºUIå¤±è´¥:', error);
            throw error;
        }
    }
    /**
     * åˆ›å»ºæ–°çš„åŸºç¡€è®¾ç½®é¢æ¿ - å‚ç›´å¸ƒå±€
     */
    createBasicPanelNew() {
        return `
            <div class="content-header">
                <h3>åŸºç¡€åŠŸèƒ½é…ç½®</h3>
            </div>

            <div class="content-body">


                <!-- å‚ç›´å¸ƒå±€çš„åŠŸèƒ½é…ç½® -->
                <div class="basic-settings-vertical">
                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="integration-system-checkbox" name="basic.integrationSystem.enabled" checked />
                            <label for="integration-system-checkbox" class="checkbox-label">å¯ç”¨æ’ä»¶</label>
                        </div>
                        <div class="setting-desc">å¯ç”¨ä¿¡æ¯æ æ’ä»¶çš„æ‰€æœ‰åŠŸèƒ½</div>
                    </div>

                    <!-- ğŸ”§ éšè—çš„checkboxï¼Œç”¨äºå‘åå…¼å®¹å’ŒåŒå‘åŒæ­¥ -->
                    <div style="display: none;">
                            <input type="checkbox" id="render-in-chat-checkbox" name="basic.renderInChat.enabled" checked />
                            <input type="checkbox" id="table-records-checkbox" name="basic.tableRecords.enabled" />
                        <input type="checkbox" id="default-collapsed-checkbox" name="basic.defaultCollapsed.enabled" />
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="memory-assist-checkbox" name="basic.memoryAssist.enabled" checked />
                            <label for="memory-assist-checkbox" class="checkbox-label">å¯ç”¨è®°å¿†è¾…åŠ©</label>
                        </div>
                        <div class="setting-desc">AIè®°å¿†è¾…åŠ©å’Œä¸Šä¸‹æ–‡ç®¡ç†</div>
                    </div>



                    <!-- æç¤ºè¯æ’å…¥ä½ç½®é…ç½® -->
                    <div class="setting-item">
                        <div class="setting-group">
                            <h4>ğŸ“ æç¤ºè¯æ’å…¥ä½ç½®</h4>
                            <div class="setting-desc" style="margin-bottom: 12px;">é€‰æ‹©ä¿¡æ¯æ æç¤ºè¯åœ¨å¯¹è¯ä¸­çš„æ’å…¥ä½ç½®ï¼Œä¸åŒä½ç½®å¯¹å¯¹è¯çš„å½±å“ç¨‹åº¦ä¸åŒã€‚</div>

                            <div class="prompt-position-config">
                                <div class="form-group">
                                    <label for="prompt-position-mode" class="control-label">æ’å…¥ä½ç½®</label>
                                    <select id="prompt-position-mode" name="basic.promptPosition.mode" class="form-control">
                                        <option value="afterCharacter">è§’è‰²å®šä¹‰ä¹‹å</option>
                                        <option value="beforeCharacter">è§’è‰²å®šä¹‰ä¹‹å‰</option>
                                        <option value="atDepthSystem">@ Dâš™ï¸ - ç³»ç»Ÿè§’è‰²æ¶ˆæ¯</option>
                                        <option value="atDepthUser">@ DğŸ‘¤ - ç”¨æˆ·è§’è‰²æ¶ˆæ¯</option>
                                        <option value="atDepthAssistant">@ DğŸ¤– - åŠ©æ‰‹è§’è‰²æ¶ˆæ¯</option>
                                    </select>
                                </div>

                                <div class="form-group depth-control" style="display: none;">
                                    <label for="prompt-position-depth" class="control-label">æ’å…¥æ·±åº¦</label>
                                    <input type="number" id="prompt-position-depth" name="basic.promptPosition.depth"
                                           class="form-control" min="0" max="10" value="0" step="1">
                                    <div class="setting-desc">æ·±åº¦ 0 ä¸ºæç¤ºè¯åº•éƒ¨ï¼Œæ•°å­—è¶Šå¤§è¶Šé å‰</div>
                                </div>

                                <div class="position-description">
                                    <div id="position-desc-afterCharacter" class="desc-item active">
                                        <span class="desc-impact">ğŸ”¸ è¾ƒå¤§å½±å“</span>
                                        åœ¨è§’è‰²æè¿°å’Œåœºæ™¯ä¹‹åæ’å…¥æ­¤æç¤ºè¯ã€‚å¯¹å¯¹è¯æœ‰æ›´å¤§å½±å“ã€‚
                                    </div>
                                    <div id="position-desc-beforeCharacter" class="desc-item">
                                        <span class="desc-impact">ğŸ”¹ ä¸­ç­‰å½±å“</span>
                                        åœ¨è§’è‰²æè¿°å’Œåœºæ™¯ä¹‹å‰æ’å…¥æ­¤æç¤ºè¯ã€‚å¯¹å¯¹è¯æœ‰ä¸­ç­‰å½±å“ã€‚
                                    </div>
                                    <div id="position-desc-atDepth" class="desc-item">
                                        <span class="desc-impact">ğŸ”§ ç²¾ç¡®æ§åˆ¶</span>
                                        å°†ä¿¡æ¯æ æç¤ºè¯æ’å…¥åˆ°èŠå¤©ä¸­çš„ç‰¹å®šæ·±åº¦å’Œè§’è‰²ç±»å‹ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†å·¥å…·åŒºåŸŸ -->
                <div class="settings-group">
                    <h4>ğŸ› ï¸ ç®¡ç†å·¥å…·</h4>
                    <div class="management-tools">
                        <button class="btn btn-primary" id="variable-manager-btn" data-action="open-variable-manager">
                            <i class="fa fa-code"></i>
                            å˜é‡ç®¡ç†å™¨
                        </button>
                        <div class="tool-desc">ç®¡ç†å…¨å±€å˜é‡ã€å®å®šä¹‰å’Œè‡ªå®šä¹‰å‡½æ•°</div>
                    </div>
                </div>
            </div>
        `;
        // è¿½åŠ è½»é‡æ ·å¼ï¼Œç¡®ä¿é€‰æ‹©æ¡†ä¸åˆ é™¤æŒ‰é’®åŒæ’ä¸”ä¸é®æŒ¡
        const style = document.createElement('style');
        style.id = 'info-bar-settings-summary-inline-style';
        if (!document.getElementById(style.id)) {
            style.textContent = `
                .history-selector-group .history-select-row {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .history-selector-group .summary-history-select {
                    flex: 1 1 auto;
                    min-width: 0;
                    max-width: calc(100% - 90px);
                }
                #content-delete-summary-btn {
                    flex: 0 0 auto;
                    white-space: nowrap;
                }
                /* è°ƒè¯•ä¸é…ç½®è¡Œå¸ƒå±€ä¼˜åŒ– */
                .debug-actions-row { display: flex; gap: 8px; }
                .config-primary-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .config-row { display: flex; align-items: center; gap: 8px; }
                .config-row .setting-select { flex: 1 1 auto; min-width: 0; }
                .config-row-actions { display: flex; gap: 6px; }

                /* æ•°æ®ç®¡ç†åŠŸèƒ½åŒºåŸŸæ ·å¼ */
                .data-management-actions {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 12px !important;
                    margin-top: 8px !important;
                    width: 100% !important;
                }
                .data-export-btn, .data-import-btn {
                    flex: 1 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 6px !important;
                    padding: 10px 16px !important;
                    border: none !important;
                    border-radius: 6px !important;
                    font-size: 14px !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    min-height: 40px !important;
                    white-space: nowrap !important;
                }
                .data-export-btn {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    color: white !important;
                }
                .data-export-btn:hover {
                    background: var(--theme-primary-hover, #e55a2b) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3) !important;
                }
                .data-import-btn {
                    background: var(--theme-bg-secondary, #4a5568) !important;
                    color: white !important;
                    border: 1px solid var(--theme-border-color, #666) !important;
                }
                .data-import-btn:hover {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2) !important;
                }
                .data-management-hint {
                    color: var(--theme-text-secondary, #a0a0a0) !important;
                    font-size: 13px !important;
                    line-height: 1.4 !important;
                    margin-top: 8px !important;
                    padding: 8px 12px !important;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.1)) !important;
                    border-radius: 4px !important;
                    border-left: 3px solid var(--theme-primary-color, #ff6b35) !important;
                }

                /* æç¤ºè¯æ’å…¥ä½ç½®é…ç½®æ ·å¼ */
                .prompt-position-config {
                    margin-top: 12px;
                    padding: 16px;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.05));
                    border-radius: 8px;
                    border: 1px solid var(--theme-border-color, #e2e8f0);
                }
                .prompt-position-config .form-group {
                    margin-bottom: 16px;
                }
                .prompt-position-config .control-label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                    color: var(--theme-text-primary, #333);
                }
                .prompt-position-config .form-control {
                    width: 100%;
                    padding: 8px 12px;
                    border: 1px solid var(--theme-border-color, #d1d5db);
                    border-radius: 4px;
                    background: var(--theme-bg-primary, #fff);
                    color: var(--theme-text-primary, #333);
                }
                .position-description {
                    margin-top: 12px;
                    padding: 12px;
                    background: var(--theme-bg-primary, #fff);
                    border-radius: 6px;
                    border: 1px solid var(--theme-border-color, #e2e8f0);
                }
                .position-description .desc-item {
                    display: none;
                    line-height: 1.5;
                    color: var(--theme-text-primary, #333);
                }
                .position-description .desc-item.active {
                    display: block;
                }
                .desc-impact {
                    display: inline-block;
                    padding: 2px 8px;
                    margin-right: 8px;
                    font-size: 12px;
                    font-weight: 600;
                    border-radius: 12px;
                    background: var(--theme-primary-color, #ff6b35);
                    color: white;
                }
                .depth-control {
                    padding: 12px;
                    background: var(--theme-bg-accent, #f8fafc);
                    border-radius: 6px;
                    border-left: 4px solid var(--theme-primary-color, #ff6b35);
                }
            `;
            document.head.appendChild(style);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼
     */
    addButtonClickFixStyles() {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ ·å¼
            if (document.getElementById('infobar-button-click-fix-styles')) {
                return;
            }

            const style = document.createElement('style');
            style.id = 'infobar-button-click-fix-styles';
            style.textContent = `
                /* ğŸ”§ ä¿®å¤æŒ‰é’®ç‚¹å‡»åŒºåŸŸé—®é¢˜ */
                .info-bar-settings-modal button {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                }

                .info-bar-settings-modal button * {
                    pointer-events: none;
                    user-select: none;
                }

                .info-bar-settings-modal button:disabled {
                    pointer-events: none;
                    cursor: not-allowed;
                }

                .info-bar-settings-modal button:not(:disabled) {
                    pointer-events: auto;
                }

                /* ç¡®ä¿æŒ‰é’®å†…å®¹ä¸ä¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶ */
                .info-bar-settings-modal .btn-icon,
                .info-bar-settings-modal .btn-text {
                    pointer-events: none !important;
                    display: inline-block;
                }

                /* æ¨¡æ€æ¡†æŒ‰é’®æ ·å¼ä¿®å¤ */
                .delete-confirm-dialog button,
                .save-confirm-dialog button {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                    pointer-events: auto;
                }

                .delete-confirm-dialog button *,
                .save-confirm-dialog button * {
                    pointer-events: none;
                    user-select: none;
                }

                /* ğŸ”§ ä¿®å¤ï¼šè‡ªå®šä¹‰å­é¡¹åˆ é™¤æŒ‰é’®æ ·å¼ä¿®å¤ */
                .info-bar-settings-modal .btn-remove-sub-item {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                    pointer-events: auto !important;
                    background: none;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    transition: background-color 0.2s;
                }

                .info-bar-settings-modal .btn-remove-sub-item:hover {
                    background-color: rgba(255, 0, 0, 0.1);
                }

                .info-bar-settings-modal .btn-remove-sub-item * {
                    pointer-events: none !important;
                    user-select: none;
                }

                /* NPCç®¡ç†é¢æ¿æ ·å¼ */
                .npc-list-container {
                    margin-top: 15px;
                }

                .npc-search-bar {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 15px;
                    align-items: center;
                }

                .npc-search-bar input {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid var(--theme-border-color, #ddd);
                    border-radius: 4px;
                    background: var(--theme-bg-secondary, #fff);
                    color: var(--theme-text-primary, #333);
                }

                .npc-cards-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                    gap: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 10px;
                    border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                    border-radius: 6px;
                    background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #111));
                }

                .npc-card {
                    background: var(--theme-bg-primary, var(--SmartThemeBodyColor, #1e1e1e));
                    border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                    border-radius: 8px;
                    padding: 12px;
                    transition: all 0.2s ease;
                    cursor: pointer;
                }

                .npc-card:hover {
                    border-color: var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff));
                    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
                    transform: translateY(-1px);
                }

                .npc-card.selected {
                    background: var(--theme-bg-selected, rgba(0, 123, 255, 0.08)) !important;
                    border-color: var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff)) !important;
                }

                .npc-checkbox:hover {
                    border-color: var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff)) !important;
                    transform: scale(1.1);
                }

                .npc-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                }

                .npc-name {
                    margin: 0;
                    font-size: 14px;
                    font-weight: 600;
                    color: var(--theme-text-primary, #333);
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }

                .npc-appear-count {
                    font-size: 12px;
                    color: var(--theme-text-secondary, #666);
                    background: var(--theme-bg-secondary, #f0f0f0);
                    padding: 2px 6px;
                    border-radius: 10px;
                }

                .npc-card-body {
                    margin-bottom: 10px;
                }

                .npc-info {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }

                .npc-field-count,
                .npc-last-seen {
                    font-size: 12px;
                    color: var(--theme-text-secondary, #666);
                }

                .npc-card-footer {
                    text-align: right;
                }

                .npc-card-actions {
                    display: flex;
                    gap: 8px;
                    justify-content: flex-end;
                    align-items: center;
                }

                .npc-view-btn,
                .npc-delete-btn {
                    font-size: 12px;
                    padding: 4px 8px;
                    border-radius: 4px;
                    transition: all 0.2s ease;
                }

                .npc-delete-btn {
                    background: transparent;
                    border: 1px solid var(--theme-danger-color, #dc3545);
                    color: var(--theme-danger-color, #dc3545);
                }

                .npc-delete-btn:hover {
                    background: var(--theme-danger-color, #dc3545);
                    color: white;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
                }

                .npc-loading,
                .npc-error,
                .npc-empty {
                    text-align: center;
                    padding: 40px 20px;
                    color: var(--theme-text-secondary, #666);
                    font-style: italic;
                }

                .npc-error {
                    color: var(--theme-error-color, #dc3545);
                }

                /* NPCè¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
                .npc-detail-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                }

                .npc-detail-content {
                    background: var(--theme-bg-primary, #fff);
                    border-radius: 8px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80%;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                }

                .npc-detail-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid var(--theme-border-color, #ddd);
                    background: var(--theme-bg-secondary, #f8f9fa);
                }

                .npc-detail-header h3 {
                    margin: 0;
                    color: var(--theme-text-primary, #333);
                }

                .npc-detail-close {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: var(--theme-text-secondary, #666);
                    padding: 0;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .npc-detail-close:hover {
                    color: var(--theme-text-primary, #333);
                }

                .npc-detail-body {
                    padding: 20px;
                    overflow-y: auto;
                }

                .npc-detail-section {
                    margin-bottom: 20px;
                }

                .npc-detail-section h4 {
                    margin: 0 0 10px 0;
                    color: var(--theme-text-primary, #333);
                    border-bottom: 1px solid var(--theme-border-color, #ddd);
                    padding-bottom: 5px;
                }

                .npc-basic-info,
                .npc-fields-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .npc-info-item,
                .npc-field-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 12px;
                    background: var(--theme-bg-secondary, #f8f9fa);
                    border-radius: 4px;
                    border-left: 3px solid var(--theme-primary-color, #007bff);
                }

                .npc-info-item strong,
                .npc-field-item strong {
                    color: var(--theme-text-primary, #333);
                    min-width: 80px;
                }

                .npc-info-item span,
                .npc-field-item span {
                    color: var(--theme-text-secondary, #666);
                    word-break: break-word;
                    text-align: right;
                }

                .npc-no-fields,
                .npc-no-data {
                    text-align: center;
                    padding: 20px;
                    color: var(--theme-text-secondary, #666);
                    font-style: italic;
                }

                .npc-data-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                /* NPCç®¡ç†æŒ‰é’®ç»„æ ·å¼ */
                .button-group {
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                    margin-bottom: 8px;
                }

                .button-group .btn {
                    flex: 0 0 auto;
                    font-size: 12px;
                    padding: 6px 12px;
                    border-radius: 4px;
                    transition: all 0.2s ease;
                }

                .button-group .btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }
            `;

            document.head.appendChild(style);
            console.log('[InfoBarSettings] âœ… æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼å·²æ·»åŠ ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´
     */
    handlePromptPositionModeChange(mode) {
        try {
            const depthControl = this.modal.querySelector('.depth-control');
            const descriptions = this.modal.querySelectorAll('.position-description .desc-item');

            // æ˜¾ç¤º/éšè—æ·±åº¦æ§åˆ¶
            if (mode.startsWith('atDepth')) {
                depthControl.style.display = 'block';
            } else {
                depthControl.style.display = 'none';
            }

            // æ›´æ–°æè¿°æ–‡æœ¬
            descriptions.forEach(desc => desc.classList.remove('active'));

            if (mode === 'beforeCharacter') {
                this.modal.querySelector('#position-desc-beforeCharacter')?.classList.add('active');
            } else if (mode === 'afterCharacter') {
                this.modal.querySelector('#position-desc-afterCharacter')?.classList.add('active');
            } else if (mode.startsWith('atDepth')) {
                this.modal.querySelector('#position-desc-atDepth')?.classList.add('active');
            }

            console.log(`[InfoBarSettings] ğŸ“ æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´ä¸º: ${mode}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šæ–°çš„äº‹ä»¶å¤„ç†
     */
    bindNewEvents() {
        try {
            // å¯¼èˆªåˆ‡æ¢äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                if (e.target.closest('.nav-item')) {
                    const navItem = e.target.closest('.nav-item');
                    const navType = navItem.dataset.nav;
                    this.switchToContent(navType);
                }
            });

            // æç¤ºè¯ä½ç½®é…ç½®äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.id === 'prompt-position-mode') {
                    this.handlePromptPositionModeChange(e.target.value);
                }
                
                // ğŸ†• å»¶è¿Ÿæ€»ç»“å¼€å…³å˜æ›´
                if (e.target.id === 'content-delayed-summary-enabled') {
                    const delayedFloorsRow = this.modal.querySelector('#content-delayed-summary-floors-row');
                    if (delayedFloorsRow) {
                        delayedFloorsRow.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });

            // ğŸ†• ç ´ç”²æç¤ºè¯æ–‡æœ¬æ¡†äº‹ä»¶
            this.modal.addEventListener('input', (e) => {
                if (e.target.id === 'armor-breaking-prompt') {
                    this.updateArmorBreakingStats();
                }
            });

            this.modal.addEventListener('keyup', (e) => {
                if (e.target.id === 'armor-breaking-prompt') {
                    this.updateArmorBreakingStats();
                }
            });

            // ğŸ§  æç¤ºè¯è®¾ç½®äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.name === 'promptSettings.mode' || e.target.id === 'prompt-mode-select') {
                    this.handlePromptModeChange(e.target.value);
                }
            });

            this.modal.addEventListener('input', (e) => {
                if (e.target.id === 'custom-prompt-content') {
                    this.updateCustomPromptStats();
                }
            });

            this.modal.addEventListener('keyup', (e) => {
                if (e.target.id === 'custom-prompt-content') {
                    this.updateCustomPromptStats();
                }
            });

            this.modal.addEventListener('click', (e) => {
                if (e.target.id === 'refresh-preview-btn') {
                    this.refreshPromptPreview();
                }
            });

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨closestæŸ¥æ‰¾å…·æœ‰data-actionå±æ€§çš„çˆ¶å…ƒç´ ï¼Œè§£å†³æŒ‰é’®å†…å­å…ƒç´ ç‚¹å‡»é—®é¢˜
                const actionElement = e.target.closest('[data-action]');
                const action = actionElement?.dataset?.action;

                // ğŸ”§ æ–°å¢ï¼šè¯¦ç»†çš„ç‚¹å‡»äº‹ä»¶è°ƒè¯•ä¿¡æ¯
                if (e.target.closest('button') || actionElement) {
                    console.log('[InfoBarSettings] ğŸ–±ï¸ æŒ‰é’®ç‚¹å‡»äº‹ä»¶:', {
                        target: e.target.tagName + (e.target.className ? '.' + e.target.className : ''),
                        actionElement: actionElement?.tagName + (actionElement?.className ? '.' + actionElement.className : ''),
                        action: action,
                        targetText: e.target.textContent?.trim(),
                        targetParent: e.target.parentElement?.tagName
                    });
                }

                if (action) {
                    // ğŸ”§ ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢é‡å¤è§¦å‘
                    e.preventDefault();
                    e.stopPropagation();
                    this.handleAction(action, e);
                }

                // ğŸ†• APIæ¨¡å¼åˆ‡æ¢æŒ‰é’®
                if (e.target.classList.contains('api-mode-btn')) {
                    const mode = e.target.dataset.mode;
                    this.handleAPIModeChange(mode);
                }

                // ğŸ†• AIè®°å¿†æ€»ç»“APIæ¨¡å¼åˆ‡æ¢æŒ‰é’®
                if (e.target.classList.contains('ai-memory-api-mode-btn')) {
                    const mode = e.target.dataset.mode;
                    this.handleAIMemoryAPIModeChange(mode);
                }

                // ğŸ”§ æ–°å¢ï¼šæ•°æ®è¡¨æ ¼APIæ¨¡å¼åˆ‡æ¢æŒ‰é’®
                if (e.target.classList.contains('data-table-api-mode-btn')) {
                    const mode = e.target.dataset.mode;
                    this.handleDataTableAPIModeChange(mode);
                }

                // APIé…ç½®ç›¸å…³æŒ‰é’®
                if (e.target.id === 'infobar-load-models-btn') {
                    this.loadModelList();
                }
                if (e.target.id === 'infobar-test-connection-btn') {
                    this.testConnection();
                }
                // ğŸ†• æ­£åˆ™è¡¨è¾¾å¼ç®¡ç†æŒ‰é’®
                if (e.target.id === 'regex-script-manager-btn') {
                    this.openRegexScriptManager();
                }

                // NPCç®¡ç†ç›¸å…³æŒ‰é’®
                if (e.target.id === 'npc-sync-now-btn') {
                    this.handleNPCSyncNow();
                }
                if (e.target.id === 'npc-worldbook-sync-now-btn') {
                    this.handleNPCWorldBookSyncNow();
                }
                if (e.target.id === 'npc-refresh-btn') {
                    this.refreshNPCList();
                }
                // ğŸ†• æ–°å¢NPCæŒ‰é’®
                if (e.target.id === 'npc-add-new-btn') {
                    this.showAddNPCDialog();
                }
                // ğŸ†• ç¼–è¾‘NPCæ¨¡æ¿æŒ‰é’®
                if (e.target.id === 'npc-edit-template-btn') {
                    this.showEditNPCTemplateDialog();
                }
                // ğŸ†• AIæ¨¡å¼ç«‹å³æ›´æ–°æŒ‰é’®
                if (e.target.id === 'npc-ai-update-now-btn') {
                    this.updateNPCWithAI();
                }
                // ğŸ†• æ¸…é™¤NPCå˜æ›´æ—¥å¿—æŒ‰é’®
                if (e.target.id === 'npc-clear-change-log-btn') {
                    this.clearNPCChangeLogs();
                }
                // ğŸ†• NPCæ¨¡å¼åˆ‡æ¢
                const npcModeTab = e.target.closest('.npc-mode-tab');
                if (npcModeTab) {
                    const mode = npcModeTab.dataset.mode;
                    this.switchNPCMode(mode);
                }

                // ğŸ†• APIç±»å‹åˆ‡æ¢
                const apiTypeBtn = e.target.closest('.api-type-switch-btn');
                if (apiTypeBtn) {
                    const apiType = apiTypeBtn.dataset.apiType;
                    this.switchAPIType(apiType);
                }

                // ğŸ†• å‘é‡åŒ–APIç›¸å…³æŒ‰é’®
                if (e.target.id === 'infobar-load-vector-models-btn') {
                    this.loadVectorModelList();
                }
                if (e.target.id === 'infobar-test-vector-connection-btn') {
                    this.testVectorConnection();
                }

            // ğŸ†• ç ´ç”²æç¤ºè¯æ–‡æœ¬æ¡†å­—ç¬¦ç»Ÿè®¡
            if (e.target.id === 'armor-breaking-prompt') {
                this.updateArmorBreakingStats();
            }

                // ä¸»é¢˜é¢„è§ˆå¡ç‰‡ç‚¹å‡»äº‹ä»¶
                const themeCard = e.target.closest('.theme-preview-card');
                if (themeCard) {
                    const themeId = themeCard.dataset.theme;
                    if (themeId) {
                        this.selectTheme(themeId);
                    }
                }

                // ä¿¡æ¯æ é£æ ¼é¢„è§ˆå¡ç‰‡ç‚¹å‡»äº‹ä»¶
                const styleCard = e.target.closest('.style-preview-card');
                if (styleCard) {
                    const styleId = styleCard.dataset.style;
                    if (styleId) {
                        this.selectStyle(styleId);
                    }
                }

                // é¢æ¿ç®¡ç†ç›¸å…³äº‹ä»¶
                this.handlePanelManagementEvents(e);

                // å‰ç«¯æ˜¾ç¤ºç›¸å…³äº‹ä»¶
                this.handleFrontendDisplayEvents(e);
            });

            // ä¸‹æ‹‰æ¡†å˜æ›´äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    this.handleCheckboxChange(e);
                }

                // å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´
                if (e.target.name && e.target.name.startsWith('frontendDisplay.')) {
                    this.handleFrontendDisplayChange(e);
                }

                // NPCç®¡ç†è®¾ç½®å˜æ›´
                if (e.target.id === 'npc-auto-sync-enabled') {
                    this.handleNPCAutoSyncChange(e.target.checked);
                }
                if (e.target.id === 'npc-worldbook-sync-enabled') {
                    this.handleNPCWorldBookSyncChange(e.target.checked);
                }

                // APIå¯ç”¨å¼€å…³å˜æ›´
                if (e.target.id === 'api-enabled') {
                    this.handleAPIEnabledChange(e.target.checked);
                }

                // APIæä¾›å•†å˜æ›´
                if (e.target.id === 'infobar-api-provider') {
                    this.handleProviderChange(e.target.value);
                }

                // æ¥å£ç±»å‹å˜æ›´
                if (e.target.id === 'infobar-interface-type') {
                    this.handleInterfaceTypeChange(e.target.value);
                }

                // ğŸ†• å‘é‡åŒ–APIæä¾›å•†å˜æ›´
                if (e.target.id === 'infobar-vector-api-provider') {
                    this.handleVectorProviderChange(e.target.value);
                }
            });

            // èŒƒå›´è¾“å…¥å®æ—¶æ›´æ–°
            this.modal.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan && valueSpan.classList.contains('range-value')) {
                        valueSpan.textContent = e.target.value;
                    }
                }
            });

            console.log('[InfoBarSettings] ğŸ”— æ–°äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šæ–°äº‹ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†é¢æ¿ç®¡ç†ç›¸å…³äº‹ä»¶
     */
    handlePanelManagementEvents(e) {
        try {
            // é¢æ¿åˆ†ç±»æ ‡ç­¾åˆ‡æ¢ï¼ˆç®€åŒ–ï¼šåªæœ‰å…¨éƒ¨é¢æ¿ï¼Œæ— éœ€åˆ‡æ¢ï¼‰
            const categoryTab = e.target.closest('.category-tab');
            if (categoryTab) {
                // åªæœ‰å…¨éƒ¨é¢æ¿åˆ†ç±»ï¼Œæ— éœ€åˆ‡æ¢é€»è¾‘
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆå¤„ç†æŒ‰é’®äº‹ä»¶ï¼Œé¿å…è¢«é¢æ¿åˆ—è¡¨é¡¹ç‚¹å‡»äº‹ä»¶è¦†ç›–
            const actionButton = e.target.closest('[data-action]');
            const action = actionButton?.dataset?.action;
            const panelId = actionButton?.dataset?.panelId;

            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡å¹¶å¤„ç†æŒ‰é’®äº‹ä»¶
            if (actionButton) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°é¢æ¿åˆ—è¡¨é¡¹
            }

            // é¢æ¿åˆ—è¡¨é¡¹é€‰æ‹©
            const panelListItem = e.target.closest('.panel-list-item');
            if (panelListItem && !actionButton) {
                const panelId = panelListItem.dataset.panelId;
                const panelType = panelListItem.dataset.panelType;

                console.log('[InfoBarSettings] ğŸ¯ é¢æ¿åˆ—è¡¨é¡¹ç‚¹å‡»:', { panelId, panelType });

                // ğŸ”§ ä¿®å¤ï¼šéªŒè¯é¢æ¿æ•°æ®æœ‰æ•ˆæ€§
                if (panelId && panelType) {
                    this.selectPanelForEdit(panelId, panelType);
                } else {
                    console.error('[InfoBarSettings] âŒ é¢æ¿åˆ—è¡¨é¡¹æ•°æ®æ— æ•ˆ:', { panelId, panelType });
                }
                return;
            }

            switch (action) {
                case 'add-custom-panel':
                    this.addCustomPanel();
                    break;
                case 'refresh-panels':
                    this.refreshPanelList();
                    break;
                case 'edit-panel':
                    this.editPanel(panelId);
                    break;
                case 'view-panel':
                    this.viewPanel(panelId);
                    break;
                case 'open-html-editor':
                    this.openHTMLTemplateEditor();
                    break;
                case 'duplicate-panel':
                    this.duplicatePanel(panelId);
                    break;
                case 'toggle-panel':
                    this.togglePanel(panelId);
                    break;
                case 'save-panel-properties':
                    this.savePanelProperties();
                    break;
                case 'delete-panel':
                    this.deletePanel();
                    break;
                case 'delete-panel-inline':
                    this.deletePanel();
                    break;
                case 'add-sub-item':
                    this.addSubItem();
                    break;
                case 'select-all-sub-items':
                    this.selectAllSubItems();
                    break;
                case 'deselect-all-sub-items':
                    this.deselectAllSubItems();
                    break;
                case 'edit-sub-item':
                    this.editSubItem(e?.target?.closest('[data-action="edit-sub-item"]') || e?.target);
                    break;
                case 'remove-sub-item':
                    this.removeSubItem(e?.target?.closest('[data-action="remove-sub-item"]') || e?.target);
                    break;
                case 'delete-custom-panel':
                    this.deleteCustomPanelFromContent(actionButton?.dataset?.panelId);
                    break;
                case 'add-custom-field':
                    this.addCustomField(actionButton?.dataset?.panelId);
                    break;
                case 'select-all-fields':
                    this.selectAllCustomFields(actionButton?.dataset?.panelId);
                    break;
                case 'deselect-all-fields':
                    this.deselectAllCustomFields(actionButton?.dataset?.panelId);
                    break;
                case 'edit-custom-field':
                    this.editCustomField(actionButton?.dataset?.panelId, actionButton?.dataset?.fieldKey);
                    break;
                case 'confirm-edit-field':
                    this.confirmEditField(actionButton?.dataset?.panelId, actionButton?.dataset?.fieldKey);
                    break;
                case 'cancel-edit-field':
                    this.cancelEditField(actionButton?.dataset?.panelId, actionButton?.dataset?.fieldKey);
                    break;
                case 'delete-custom-field':
                    this.deleteCustomField(actionButton?.dataset?.panelId, actionButton?.dataset?.fieldKey, actionButton?.dataset?.fieldName);
                    break;
                case 'rename-panel':
                    this.showRenamePanelDialog(actionButton?.dataset?.panelId);
                    break;
                case 'move-panel-up':
                    this.movePanelUp(actionButton?.dataset?.panelId);
                    break;
                case 'move-panel-down':
                    this.movePanelDown(actionButton?.dataset?.panelId);
                    break;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é¢æ¿ç®¡ç†äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†å‰ç«¯æ˜¾ç¤ºç›¸å…³äº‹ä»¶
     */
    handleFrontendDisplayEvents(e) {
        try {
            const action = e.target.dataset.action;

            switch (action) {
                case 'test-panel-popup':
                    this.testPanelPopup();
                    break;
                case 'test-add-panel':
                    // ç§»é™¤é¢„è§ˆç¤ºä¾‹å…¥å£ï¼šè½¬ä¸ºçœŸæ­£è°ƒç”¨ FrontendDisplayManager çš„æ·»åŠ é€»è¾‘
                    try {
                        const infoBarTool = window.SillyTavernInfobar;
                        const fdm = infoBarTool?.modules?.frontendDisplayManager;
                        if (fdm) {
                            // æ¨¡æ‹Ÿåœ¨å½“å‰æœ€åä¸€æ¡AIæ¶ˆæ¯ä¸Šæ‰“å¼€æ·»åŠ èœå•
                            const lastAi = [...document.querySelectorAll('.mes[data-is-user="false"]')].pop();
                            if (lastAi) {
                                fdm.wrapAIMessage(lastAi);
                                const wrapper = fdm.wrappers.get(lastAi.id);
                                const anySlot = wrapper?.querySelector('.add-slot') || wrapper;
                                fdm.showAddPanelMenu('top-1', anySlot, lastAi);
                            }
                        }
                    } catch (_) {}
                    break;
                case 'clear-preview':
                    this.clearPreviewContent();
                    break;
            }

            // å¤„ç†æ·»åŠ æ§½ä½ç‚¹å‡»
            const addSlot = e.target.closest('.add-slot');
            if (addSlot) {
                const position = addSlot.dataset.position;
                this.showAddPanelMenu(position, addSlot);
                return;
            }

            // å¤„ç†æ¼”ç¤ºé¢æ¿æŒ‰é’®ç‚¹å‡»
            const panelButton = e.target.closest('.panel-button.demo');
            if (panelButton) {
                const panelType = panelButton.dataset.panel;
                this.showDemoPanelPopup(panelType);
                return;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰ç«¯æ˜¾ç¤ºäº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´
     */
    handleFrontendDisplayChange(e) {
        try {
            const name = e.target.name;
            const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

            console.log(`[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´: ${name} = ${value}`);

            // æ ¹æ®è®¾ç½®åç§°å¤„ç†ä¸åŒçš„å˜æ›´
            switch (name) {
                case 'frontendDisplay.enabled':
                    this.toggleFrontendDisplaySections(value);
                    this.enableFrontendDisplay(value);
                    break;
                case 'frontendDisplay.position':
                    this.updatePreviewPosition(value);
                    break;
                case 'frontendDisplay.style':
                    this.updatePreviewStyle(value);
                    break;
                case 'frontendDisplay.showAddButtons':
                    this.toggleAddButtons(value);
                    break;
                case 'frontendDisplay.animationEnabled':
                    this.toggleAnimations(value);
                    break;
                default:
                    console.log(`[InfoBarSettings] ğŸ“ ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®: ${name}`);
                    break;
            }

            // ä¿å­˜è®¾ç½®åˆ°é…ç½®ä¸­
            this.saveFrontendDisplaySetting(name, value);

            // æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨çš„è®¾ç½®
            this.updateFrontendDisplayManagerSettings();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®åˆ°é…ç½®ä¸­
     */
    async saveFrontendDisplaySetting(name, value) {
        try {
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è¯»å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();

            // æ›´æ–°å¯¹åº”çš„è®¾ç½®é¡¹
            const settingKey = name.replace('frontendDisplay.', '');
            currentConfig[settingKey] = value;

            // ä¿å­˜é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            console.log(`[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®: ${settingKey} = ${value}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * å¯ç”¨/ç¦ç”¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½
     */
    enableFrontendDisplay(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ”„ ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½`);

            // è·å–å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const frontendDisplayManager = infoBarTool?.modules?.frontendDisplayManager;

            if (frontendDisplayManager) {
                frontendDisplayManager.setEnabled(enabled);
                console.log(`[InfoBarSettings] âœ… å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);

                // å¦‚æœç¦ç”¨ï¼Œè¿˜éœ€è¦æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
                if (!enabled) {
                    this.restoreOriginalInfoBarRendering();
                } else {
                    this.disableOriginalInfoBarRendering();
                }
            } else {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯ç”¨/ç¦ç”¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨è®¾ç½®
     */
    updateFrontendDisplayManagerSettings() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const frontendDisplayManager = infoBarTool?.modules?.frontendDisplayManager;

            if (frontendDisplayManager) {
                // æ”¶é›†å½“å‰è®¾ç½®
                const settings = this.collectFrontendDisplaySettings();
                frontendDisplayManager.updateSettings(settings);
                console.log('[InfoBarSettings] âš™ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®å·²æ›´æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ”¶é›†å‰ç«¯æ˜¾ç¤ºè®¾ç½®
     */
    collectFrontendDisplaySettings() {
        const settings = {};

        try {
            const modal = this.modal;
            if (modal) {
                const inputs = modal.querySelectorAll('[name^="frontendDisplay."]');
                inputs.forEach(input => {
                    const key = input.name.replace('frontendDisplay.', '');
                    settings[key] = input.type === 'checkbox' ? input.checked : input.value;
                });
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
     */
    disableOriginalInfoBarRendering() {
        try {
            console.log('[InfoBarSettings] ğŸš« ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“');

            const infoBarTool = window.SillyTavernInfobar;
            const messageInfoBarRenderer = infoBarTool?.modules?.messageInfoBarRenderer;

            if (messageInfoBarRenderer) {
                // ä¸´æ—¶ç¦ç”¨ä¿¡æ¯æ æ¸²æŸ“å™¨
                messageInfoBarRenderer.frontendDisplayMode = true;
                console.log('[InfoBarSettings] âœ… åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å·²ç¦ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å¤±è´¥:', error);
        }
    }

    /**
     * æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
     */
    restoreOriginalInfoBarRendering() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“');

            const infoBarTool = window.SillyTavernInfobar;
            const messageInfoBarRenderer = infoBarTool?.modules?.messageInfoBarRenderer;

            if (messageInfoBarRenderer) {
                messageInfoBarRenderer.frontendDisplayMode = false;
                console.log('[InfoBarSettings] âœ… åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å·²æ¢å¤');
            }

            // æ˜¾ç¤ºè¢«éšè—çš„ä¿¡æ¯æ 
            const hiddenInfoBars = document.querySelectorAll('.message-infobar[style*="display: none"], .infobar-panel[style*="display: none"]');
            hiddenInfoBars.forEach(infoBar => {
                infoBar.style.display = '';
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢å‰ç«¯æ˜¾ç¤ºç›¸å…³è®¾ç½®åŒºåŸŸçš„æ˜¾ç¤ºçŠ¶æ€
     */
    toggleFrontendDisplaySections(enabled) {
        try {
            const configSection = this.modal.querySelector('.frontend-display-config');
            const previewSection = this.modal.querySelector('.frontend-display-preview');
            const advancedSection = this.modal.querySelector('.frontend-display-advanced');

            if (configSection) {
                configSection.style.display = enabled ? 'block' : 'none';
            }
            if (previewSection) {
                previewSection.style.display = enabled ? 'block' : 'none';
            }
            if (advancedSection) {
                advancedSection.style.display = enabled ? 'block' : 'none';
            }

            console.log(`[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºåŒºåŸŸåˆ‡æ¢: ${enabled ? 'æ˜¾ç¤º' : 'éšè—'}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢å‰ç«¯æ˜¾ç¤ºåŒºåŸŸå¤±è´¥:', error);
        }
    }

    /**
     * æµ‹è¯•é¢æ¿å¼¹çª—
     */
    testPanelPopup() {
        try {
            console.log('[InfoBarSettings] ğŸ§ª æµ‹è¯•é¢æ¿å¼¹çª—');

            // åˆ›å»ºæ¨¡æ‹Ÿçš„é¢æ¿å¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'demo-panel-popup';
            popup.style.setProperty('position', 'fixed', 'important');
            popup.style.setProperty('top', '0', 'important');
            popup.style.setProperty('left', '0', 'important');
            popup.style.setProperty('right', '0', 'important');
            popup.style.setProperty('bottom', '0', 'important');
            popup.style.setProperty('width', '100vw', 'important');
            popup.style.setProperty('height', '100vh', 'important');
            popup.style.setProperty('display', 'flex', 'important');
            popup.style.setProperty('align-items', 'center', 'important');
            popup.style.setProperty('justify-content', 'center', 'important');
            popup.style.setProperty('z-index', '10000', 'important');
            popup.style.setProperty('background', 'rgba(0,0,0,0.5)', 'important');

            popup.innerHTML = `
                <div class="demo-popup-content" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    min-width: 300px;
                    max-width: 90vw;
                    min-height: 200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    position: relative;
                    margin: 0;
                ">
                    <div class="demo-popup-header">
                        <h3>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                        <button class="demo-close-btn">Ã—</button>
                    </div>
                    <div class="demo-popup-body">
                        <div class="demo-field">
                            <span class="field-label">å§“å:</span>
                            <span class="field-value">å¼ ä¸‰</span>
                        </div>
                        <div class="demo-field">
                            <span class="field-label">å¹´é¾„:</span>
                            <span class="field-value">25</span>
                        </div>
                        <div class="demo-field">
                            <span class="field-label">èŒä¸š:</span>
                            <span class="field-value">ç¨‹åºå‘˜</span>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 3000);

            // ç‚¹å‡»å…³é—­æŒ‰é’®
            popup.querySelector('.demo-close-btn').addEventListener('click', () => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•é¢æ¿å¼¹çª—å¤±è´¥:', error);
        }
    }

    /**
     * æµ‹è¯•æ·»åŠ é¢æ¿
     */
    testAddPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ§ª æµ‹è¯•æ·»åŠ é¢æ¿');

            // åˆ›å»ºæ·»åŠ é¢æ¿çš„é€‰æ‹©èœå•
            const menu = document.createElement('div');
            menu.className = 'demo-add-panel-menu';
            menu.innerHTML = `
                <div class="demo-menu-content">
                    <div class="menu-header">
                        <h3>æ·»åŠ åˆ°${area === 'top' ? 'é¡¶éƒ¨' : 'åº•éƒ¨'}åŒºåŸŸ</h3>
                        <button class="menu-close-btn">&times;</button>
                    </div>
                    <div class="menu-body">
                        <div class="menu-layout">
                            <!-- å·¦ä¾§é¢æ¿å¯¼èˆª -->
                            <div class="panel-navigation">
                                <h4>ğŸ“‹ å¯ç”¨çš„é¢æ¿ (${Object.keys(enabledPanels).length})</h4>
                                <div class="panel-list">
                                    ${panelListHtml}
                                </div>
                            </div>

                            <!-- å³ä¾§å­é¡¹åˆ—è¡¨ -->
                            <div class="subitem-list">
                                ${subitemListHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // å®šä½èœå•ï¼ˆç§»åŠ¨ç«¯å…¨å±é®ç½©ï¼Œæ¡Œé¢ç«¯å±…ä¸­ï¼‰
            const isMobile = window.innerWidth <= 768;
            menu.style.position = 'fixed';
            menu.style.zIndex = '10000';
            if (isMobile) {
                // å…¨å±é®ç½©
                menu.style.left = '0';
                menu.style.top = '0';
                menu.style.width = '100vw';
                menu.style.height = '100vh';
                menu.style.background = 'rgba(0, 0, 0, 0.5)';
                menu.style.backdropFilter = 'blur(4px)';
                menu.style.display = 'flex';
                menu.style.alignItems = 'center';
                menu.style.justifyContent = 'center';

                // å†…å®¹å®¹å™¨é™åˆ¶å°ºå¯¸å¹¶å±…ä¸­
                const menuContent = menu.querySelector('.demo-menu-content');
                if (menuContent) {
                    menuContent.style.width = '90vw';
                    menuContent.style.maxWidth = '360px';
                    menuContent.style.maxHeight = '80vh';
                    menuContent.style.overflow = 'auto';
                    menuContent.style.borderRadius = '12px';
                }
            } else {
                // æ¡Œé¢å±…ä¸­
                menu.style.left = '50%';
                menu.style.top = '50%';
                menu.style.transform = 'translate(-50%, -50%)';
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);

            // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆä»…ç§»åŠ¨ç«¯å…¨å±æ—¶ï¼‰
            if (isMobile) {
                menu.addEventListener('click', (evt) => {
                    const content = menu.querySelector('.demo-menu-content');
                    if (content && !content.contains(evt.target)) {
                        menu.remove();
                    }
                });
            }

            // ç»‘å®šå…³é—­æŒ‰é’®
            const closeBtn = menu.querySelector('.menu-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    menu.remove();
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•æ·»åŠ é¢æ¿å¤±è´¥:', error);
        }
    }
    /**
     * åˆ‡æ¢é¢æ¿åˆ†ç±»ï¼ˆç®€åŒ–ç‰ˆï¼šåªæœ‰å…¨éƒ¨é¢æ¿ï¼‰
     */
    switchPanelCategory(category) {
        try {
            // ç®€åŒ–ï¼šåªæœ‰å…¨éƒ¨é¢æ¿åˆ†ç±»ï¼Œæ— éœ€åˆ‡æ¢é€»è¾‘
            console.log(`[InfoBarSettings] ğŸ“‘ é¢æ¿åˆ†ç±»å·²ç®€åŒ–ï¼Œåªæ˜¾ç¤ºå…¨éƒ¨é¢æ¿`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢é¢æ¿åˆ†ç±»å¤±è´¥:', error);
        }
    }

    /**
     * é€‰æ‹©é¢æ¿è¿›è¡Œç¼–è¾‘
     */
    async selectPanelForEdit(panelId, panelType) {
        try {
            console.log(`[InfoBarSettings] ğŸ¯ å¼€å§‹é€‰æ‹©é¢æ¿: ${panelId} (${panelType})`);

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯é¢æ¿IDå’Œç±»å‹çš„æœ‰æ•ˆæ€§
            if (!panelId || !panelType) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæˆ–ç±»å‹æ— æ•ˆ:', { panelId, panelType });
                return;
            }

            // ğŸ”§ æ–°æ¶æ„ï¼šç»Ÿä¸€ä»customPanelsæ£€æŸ¥é¢æ¿æ˜¯å¦å­˜åœ¨
            let panelExists = false;
            const customPanels = this.getCustomPanels();
            panelExists = customPanels.hasOwnProperty(panelId);

            if (!panelExists) {
                console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨:', panelId, panelType);
                this.showMessage(`é¢æ¿ ${panelId} ä¸å­˜åœ¨`, 'error');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šåˆ‡æ¢é¢æ¿å‰è‡ªåŠ¨ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œé¿å…å‹¾é€‰çŠ¶æ€ä¸¢å¤±ï¼ˆé™é»˜ä¿å­˜ï¼Œä¸å¼¹ç¡®è®¤æ¡†ï¼‰
            if (this.currentEditingPanel && this.modal?.querySelector('.panel-properties-form')) {
                try {
                    // ä»…åœ¨è¡¨å•å¯è§æ—¶å°è¯•ä¿å­˜ï¼Œä¸”ä¸æ‰“æ–­ç”¨æˆ·
                    const propertiesForm = this.modal.querySelector('.panel-properties-form');
                    if (propertiesForm && propertiesForm.style.display !== 'none') {
                        // ä½¿ç”¨é™é»˜ä¿å­˜ï¼Œä¸å¼¹ç¡®è®¤å¯¹è¯æ¡†
                        const { id, type } = this.currentEditingPanel;
                        await this.performSavePanelProperties(id, type);
                        console.log('[InfoBarSettings] ğŸ’¾ é™é»˜ä¿å­˜å½“å‰é¢æ¿:', id);
                    }
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ è‡ªåŠ¨ä¿å­˜å½“å‰é¢æ¿å¤±è´¥ï¼Œå°†ç»§ç»­åˆ‡æ¢:', e);
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…é™¤æ‰€æœ‰é¢æ¿çš„é€‰ä¸­çŠ¶æ€ï¼Œç„¶ååªé€‰ä¸­å½“å‰é¢æ¿
            const allPanelItems = this.modal.querySelectorAll('.panel-list-item');
            console.log(`[InfoBarSettings] ğŸ”„ æ¸…é™¤æ‰€æœ‰é¢æ¿é€‰ä¸­çŠ¶æ€ï¼Œå…± ${allPanelItems.length} ä¸ªé¢æ¿`);
            
            allPanelItems.forEach(item => {
                    item.classList.remove('selected');
            });

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨æ‰¾åˆ°è¦é€‰ä¸­çš„é¢æ¿
            const targetPanel = this.modal.querySelector(`.panel-list-item[data-panel-id="${panelId}"][data-panel-type="${panelType}"]`);
            if (targetPanel) {
                targetPanel.classList.add('selected');
                console.log('[InfoBarSettings] âœ… å·²é€‰ä¸­é¢æ¿é¡¹:', panelId, panelType);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°è¦é€‰ä¸­çš„é¢æ¿é¡¹:', panelId, panelType);
            }

            // æ˜¾ç¤ºé¢æ¿å±æ€§è¡¨å•
            this.showPanelProperties(panelId, panelType);

            console.log(`[InfoBarSettings] âœ… é¢æ¿é€‰æ‹©å®Œæˆ: ${panelId} (${panelType})`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©é¢æ¿å¤±è´¥:', error);
            this.showMessage('é€‰æ‹©é¢æ¿å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ˜¾ç¤ºé¢æ¿å±æ€§
     */
    showPanelProperties(panelId, panelType) {
        try {
            const noSelectionMessage = this.modal.querySelector('.no-selection-message');
            const propertiesForm = this.modal.querySelector('.panel-properties-form');
            const saveBtn = this.modal.querySelector('[data-action="save-panel-properties"]');
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œç¡®ä¿é€‰æ‹©å±æ€§åŒºåŸŸçš„åˆ é™¤æŒ‰é’®
            const deleteBtn = this.modal.querySelector('.properties-actions [data-action="delete-panel"]');

            // ğŸ”§ ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºé¢æ¿å±æ€§å‰ï¼Œé¢„é˜²æ€§æ¸…ç†å­é¡¹å®¹å™¨ï¼Œé˜²æ­¢UIæ±¡æŸ“
            const container = this.modal.querySelector('.sub-items-container');
            if (container) {
                container.querySelectorAll('.sub-item-form').forEach(item => item.remove());
                console.log(`[InfoBarSettings] ğŸ§¹ é¢„é˜²æ€§æ¸…ç†å­é¡¹å®¹å™¨ï¼Œå‡†å¤‡æ˜¾ç¤ºé¢æ¿: ${panelId} (${panelType})`);
            }

            // éšè—æ— é€‰æ‹©æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå±æ€§è¡¨å•
            noSelectionMessage.style.display = 'none';
            propertiesForm.style.display = 'block';

            // å¯ç”¨/ç¦ç”¨æŒ‰é’®
            saveBtn.disabled = false;
            deleteBtn.disabled = false; // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿ï¼ˆåŒ…æ‹¬é¢„è®¾ï¼‰éƒ½å¯ä»¥åˆ é™¤

            // åŠ è½½é¢æ¿æ•°æ®åˆ°è¡¨å•
            this.loadPanelDataToForm(panelId, panelType);

            // å­˜å‚¨å½“å‰ç¼–è¾‘çš„é¢æ¿ä¿¡æ¯
            this.currentEditingPanel = { id: panelId, type: panelType };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºé¢æ¿å±æ€§å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿æ·»åŠ å¯¹è¯æ¡†
     */
    showCustomPanelDialog() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿æ·»åŠ å¯¹è¯æ¡†');

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'custom-panel-dialog-overlay';

            // ğŸ”§ è®¾ç½®å®Œç¾å±…ä¸­æ ·å¼ - å‚è€ƒé¢æ¿è§„åˆ™ç¼–è¾‘ç•Œé¢
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                visibility: visible;
                transition: opacity 0.3s ease;
            `;

            dialogOverlay.innerHTML = `
                <div class="custom-panel-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 500px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header" style="
                        padding: 20px 24px 16px;
                        border-bottom: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; color: var(--theme-text-primary, #ffffff); font-size: 18px;">æ·»åŠ è‡ªå®šä¹‰é¢æ¿</h3>
                        <button class="dialog-close-btn" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-secondary, #aaa);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                        ">Ã—</button>
                    </div>
                    <div class="dialog-content" style="padding: 20px 24px;">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="new-panel-name" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é¢æ¿åç§°:</label>
                            <input type="text" id="new-panel-name" placeholder="è¯·è¾“å…¥é¢æ¿åç§°" value="æ–°å»ºé¢æ¿" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                            ">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="new-panel-key" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é”®å:</label>
                            <input type="text" id="new-panel-key" placeholder="è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¿®æ”¹" value="" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                            ">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="new-panel-description" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é¢æ¿è¯´æ˜:</label>
                            <textarea id="new-panel-description" placeholder="è¯·è¾“å…¥é¢æ¿è¯´æ˜" rows="3" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                resize: vertical;
                                min-height: 80px;
                                box-sizing: border-box;
                            ">è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰é¢æ¿</textarea>
                        </div>
                    </div>
                    <div class="dialog-footer" style="
                        padding: 16px 24px 20px;
                        border-top: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button class="btn-cancel" style="
                            padding: 10px 20px;
                            border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                            border-radius: 6px;
                            background: transparent;
                            color: var(--theme-text-secondary, #aaa);
                            cursor: pointer;
                            font-size: 14px;
                        ">å…³é—­</button>
                        <button class="btn-confirm" style="
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            background: var(--theme-primary-color, #4299e1);
                            color: var(--theme-text-primary, #ffffff);
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        ">ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ğŸ”§ æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                dialogOverlay.style.opacity = '1';
            }, 10);

            // ğŸ”§ è°ƒè¯•ï¼šæ£€æŸ¥å¯¹è¯æ¡†åˆå§‹å€¼
            console.log('[InfoBarSettings] ğŸ” å¯¹è¯æ¡†åˆå§‹å€¼æ£€æŸ¥:');
            console.log('  é¢æ¿åç§°é»˜è®¤å€¼:', document.getElementById('new-panel-name').value);
            console.log('  å½“å‰ç¼–è¾‘çš„é¢æ¿:', this.currentEditingPanel);

            // ç”Ÿæˆé»˜è®¤é”®å
            const customPanels = this.getCustomPanels();
            const defaultKey = this.generateKeyFromName('æ–°å»ºé¢æ¿');
            const uniqueKey = this.ensureUniqueKey(defaultKey, customPanels);
            document.getElementById('new-panel-key').value = uniqueKey;

            console.log('  ç”Ÿæˆçš„é»˜è®¤é”®å:', defaultKey, '->', uniqueKey);

            // ğŸ”§ é˜²æŠ¤ï¼šç¡®ä¿é»˜è®¤å€¼ä¸è¢«è¦†ç›–
            setTimeout(() => {
                const currentName = document.getElementById('new-panel-name').value;
                const currentKey = document.getElementById('new-panel-key').value;
                console.log('[InfoBarSettings] ğŸ” å¯¹è¯æ¡†å»¶è¿Ÿæ£€æŸ¥(500mså):');
                console.log('  é¢æ¿åç§°å½“å‰å€¼:', currentName);
                console.log('  é”®åå½“å‰å€¼:', currentKey);

                // å¦‚æœå€¼è¢«æ„å¤–ä¿®æ”¹ï¼Œæ¢å¤é»˜è®¤å€¼
                if (currentName !== 'æ–°å»ºé¢æ¿') {
                    console.warn('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°é¢æ¿åç§°è¢«å¼‚å¸¸ä¿®æ”¹ï¼Œæ¢å¤é»˜è®¤å€¼');
                    document.getElementById('new-panel-name').value = 'æ–°å»ºé¢æ¿';
                    document.getElementById('new-panel-key').value = uniqueKey;
                }
            }, 500);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const confirmBtn = dialogOverlay.querySelector('.btn-confirm');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // é¢æ¿åç§°å˜åŒ–æ—¶è‡ªåŠ¨ç”Ÿæˆé”®å
            const nameInput = document.getElementById('new-panel-name');
            const keyInput = document.getElementById('new-panel-key');

            nameInput.addEventListener('input', (e) => {
                const name = e.target.value.trim();
                console.log('[InfoBarSettings] ğŸ” é¢æ¿åç§°è¾“å…¥å˜åŒ–:', name);
                if (name) {
                    const newKey = this.generateKeyFromName(name);
                    const uniqueKey = this.ensureUniqueKey(newKey, customPanels);
                    console.log('  è‡ªåŠ¨ç”Ÿæˆé”®å:', newKey, '->', uniqueKey);
                    keyInput.value = uniqueKey;
                }
            });

            // ç¡®è®¤æ·»åŠ äº‹ä»¶
            confirmBtn.addEventListener('click', () => {
                const name = document.getElementById('new-panel-name').value.trim();
                const key = document.getElementById('new-panel-key').value.trim();
                const description = document.getElementById('new-panel-description').value.trim();

                // ğŸ”§ è°ƒè¯•ï¼šæ£€æŸ¥ç”¨æˆ·ç¡®è®¤æ—¶çš„å€¼
                console.log('[InfoBarSettings] ğŸ” ç”¨æˆ·ç¡®è®¤æ·»åŠ æ—¶çš„å€¼:');
                console.log('  é¢æ¿åç§°:', name);
                console.log('  é”®å:', key);
                console.log('  é¢æ¿è¯´æ˜:', description);
                console.log('  å½“å‰ç¼–è¾‘çš„é¢æ¿:', this.currentEditingPanel);

                // éªŒè¯è¾“å…¥
                if (!name) {
                    alert('è¯·è¾“å…¥é¢æ¿åç§°');
                    return;
                }

                if (!key) {
                    alert('è¯·è¾“å…¥é”®å');
                    return;
                }

                // éªŒè¯é”®åæ ¼å¼
                if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
                    alert('é”®ååªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´');
                    return;
                }

                // æ£€æŸ¥é”®åæ˜¯å¦å·²å­˜åœ¨
                if (customPanels[key]) {
                    alert('è¯¥é”®åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–é”®å');
                    return;
                }

                // åˆ›å»ºé¢æ¿æ•°æ®
                const panelData = {
                    name: name,
                    key: key,
                    description: description,
                    icon: 'ğŸ¨' // å›ºå®šä½¿ç”¨é»˜è®¤å›¾æ ‡
                };

                // å…³é—­å¯¹è¯æ¡†
                closeDialog();

                // æ‰§è¡Œæ·»åŠ é¢æ¿
                this.addCustomPanel(panelData);
            });

            // é”®åè¾“å…¥éªŒè¯
            keyInput.addEventListener('input', (e) => {
                let value = e.target.value;
                // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
                value = value.replace(/[^a-zA-Z0-9_]/g, '');
                // ä¸èƒ½ä»¥æ•°å­—å¼€å¤´
                if (/^[0-9]/.test(value)) {
                    value = '_' + value;
                }
                e.target.value = value;
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ è‡ªå®šä¹‰é¢æ¿
     */
    async addCustomPanel(panelData = null) {
        try {
            // å¦‚æœæ²¡æœ‰æä¾›é¢æ¿æ•°æ®ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
            if (!panelData) {
                this.showCustomPanelDialog();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ·»åŠ è‡ªå®šä¹‰é¢æ¿:', panelData);

            // ğŸ”§ ä¿®å¤ï¼šåˆ›å»ºæ–°çš„è‡ªå®šä¹‰é¢æ¿ï¼Œä½¿ç”¨é”®åä½œä¸ºID
            const newPanel = {
                id: panelData.key,  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºIDï¼Œç¡®ä¿ä¸ä¿¡æ¯æ ç³»ç»Ÿè®¾è®¡ä¸€è‡´
                name: panelData.name,
                key: panelData.key,
                description: panelData.description,
                icon: panelData.icon,
                type: 'custom',
                enabled: true,
                required: false,
                memoryInject: false,

                prompts: {
                    init: '',
                    insert: '',
                    update: '',
                    delete: ''
                },
                subItems: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            // ä¿å­˜åˆ°è‡ªå®šä¹‰é¢æ¿é…ç½®
            await this.saveCustomPanel(newPanel);

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆæ·»åŠ è‡ªå®šä¹‰é¢æ¿åˆ°å¯¼èˆªï¼‰
            this.refreshNavigation();

            // è‡ªåŠ¨é€‰æ‹©æ–°å»ºçš„é¢æ¿
            this.selectPanelForEdit(newPanel.id, 'custom');

            console.log('[InfoBarSettings] âœ… æ·»åŠ è‡ªå®šä¹‰é¢æ¿æˆåŠŸ:', newPanel.id, 'é”®å:', newPanel.key);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ è‡ªå®šä¹‰é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°é¢æ¿åˆ—è¡¨
     */
    refreshPanelList() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°é¢æ¿åˆ—è¡¨');
                return;
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°é¢æ¿åˆ—è¡¨...');

            // ğŸ”§ ä¿®å¤ï¼šä¿å­˜å½“å‰é€‰ä¸­çš„é¢æ¿IDï¼Œåˆ·æ–°åæ¢å¤é€‰ä¸­çŠ¶æ€
            const currentSelectedPanel = this.modal.querySelector('.panel-list-item.selected');
            const currentSelectedPanelId = currentSelectedPanel?.dataset?.panelId;
            const currentSelectedPanelType = currentSelectedPanel?.dataset?.panelType;

            console.log('[InfoBarSettings] ğŸ“Š å½“å‰é€‰ä¸­é¢æ¿:', currentSelectedPanelId, currentSelectedPanelType);

            // é‡æ–°ç”Ÿæˆé¢æ¿åˆ—è¡¨
            const panelListContainers = this.modal.querySelectorAll('.panel-list');

            panelListContainers.forEach(container => {
                const category = container.dataset.category;
                const newContent = this.createPanelListItems(category);
                console.log(`[InfoBarSettings] ğŸ”„ åˆ·æ–°${category}åˆ†ç±»é¢æ¿åˆ—è¡¨`);
                container.innerHTML = newContent;
            });

            // ğŸ”§ ä¿®å¤ï¼šåˆ·æ–°åç«‹å³æ¢å¤é€‰ä¸­çŠ¶æ€å’ŒæŒ‰é’®çŠ¶æ€ï¼Œä¸ä½¿ç”¨setTimeout
            if (currentSelectedPanelId) {
                // ç«‹å³æŸ¥æ‰¾æ–°æ¸²æŸ“çš„é¢æ¿é¡¹
                    const newSelectedPanel = this.modal.querySelector(`[data-panel-id="${currentSelectedPanelId}"]`);
                    if (newSelectedPanel) {
                    // æ¢å¤é€‰ä¸­çŠ¶æ€
                        newSelectedPanel.classList.add('selected');
                        console.log('[InfoBarSettings] âœ… å·²æ¢å¤é¢æ¿é€‰ä¸­çŠ¶æ€:', currentSelectedPanelId);
                    
                    // ğŸ”§ é‡è¦ä¿®å¤ï¼šæ¢å¤åˆ é™¤æŒ‰é’®å’Œä¿å­˜æŒ‰é’®çš„å¯ç”¨çŠ¶æ€
                    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œç¡®ä¿é€‰æ‹©å±æ€§åŒºåŸŸçš„åˆ é™¤æŒ‰é’®
                    const deleteBtn = this.modal.querySelector('.properties-actions [data-action="delete-panel"]');
                    const saveBtn = this.modal.querySelector('[data-action="save-panel-properties"]');
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        console.log('[InfoBarSettings] âœ… å·²æ¢å¤åˆ é™¤æŒ‰é’®å¯ç”¨çŠ¶æ€');
                    }
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        console.log('[InfoBarSettings] âœ… å·²æ¢å¤ä¿å­˜æŒ‰é’®å¯ç”¨çŠ¶æ€');
                    }
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ åˆ·æ–°åæœªæ‰¾åˆ°ä¹‹å‰é€‰ä¸­çš„é¢æ¿:', currentSelectedPanelId);
                    // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨ç¡®å®æ‰¾ä¸åˆ°é¢æ¿æ—¶æ‰æ¸…ç©ºå±æ€§
                    // è¿™ç§æƒ…å†µåº”è¯¥å¾ˆå°‘å‘ç”Ÿï¼ˆä¾‹å¦‚é¢æ¿è¢«åˆ é™¤ï¼‰
                    if (this.currentEditingPanel && this.currentEditingPanel.id === currentSelectedPanelId) {
                        this.clearPanelProperties();
                    }
                }
            }

            // æ›´æ–°é¢æ¿æ•°é‡
            this.updatePanelCountsDisplay();

            console.log('[InfoBarSettings] âœ… é¢æ¿åˆ—è¡¨åˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°é¢æ¿åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢æ¿æ•°é‡æ˜¾ç¤º
     */
    updatePanelCountsDisplay() {
        try {
            const totalCount = this.getTotalPanelCount();

            // åªæ›´æ–°å…¨éƒ¨é¢æ¿çš„è®¡æ•°
            const allCategoryCount = this.modal.querySelector('[data-category="all"] .category-count');
            if (allCategoryCount) {
                allCategoryCount.textContent = totalCount;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢æ¿æ•°é‡å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°æ˜¾ç¤º
     */
    updateBasicPanelCount() {
        try {
            const countElement = this.modal.querySelector('#basic-settings-count');
            if (!countElement) return;

            // è·å–åŸºç¡€è®¾ç½®é¢æ¿çš„å¤é€‰æ¡†
            const allCheckboxes = this.modal.querySelectorAll('.basic-settings-vertical input[type="checkbox"][name]');
            const enabledCheckboxes = this.modal.querySelectorAll('.basic-settings-vertical input[type="checkbox"][name]:checked');

            const totalCount = allCheckboxes.length;
            const enabledCount = enabledCheckboxes.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            console.log(`[InfoBarSettings] ğŸ“Š åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°æŒ‡å®šé¢æ¿çš„é…ç½®è®¡æ•°æ˜¾ç¤ºå’ŒçŠ¶æ€æ ‡ç­¾
     */
    updatePanelConfigCount(panelName) {
        try {
            const countElement = this.modal.querySelector(`[data-content="${panelName}"] .status-count`);
            const statusBadge = this.modal.querySelector(`[data-content="${panelName}"] .status-badge`);
            if (!countElement) return;

            // è·å–è¯¥é¢æ¿çš„å¤é€‰æ¡†
            const panelContainer = this.modal.querySelector(`[data-content="${panelName}"]`);
            if (!panelContainer) return;

            // ğŸ”§ ä¿®å¤ï¼šæ’é™¤é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†ï¼Œåªè®¡ç®—å­é¡¹å¤é€‰æ¡†
            // é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†çš„nameæ ¼å¼ä¸º "panelName.enabled"
            const allCheckboxes = panelContainer.querySelectorAll(`input[type="checkbox"][name]:not([name="${panelName}.enabled"])`);
            const enabledCheckboxes = panelContainer.querySelectorAll(`input[type="checkbox"][name]:checked:not([name="${panelName}.enabled"])`);

            const totalCount = allCheckboxes.length;
            const enabledCount = enabledCheckboxes.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°çŠ¶æ€æ ‡ç­¾ï¼Œæ ¹æ®é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†çŠ¶æ€
            if (statusBadge) {
                const panelToggle = panelContainer.querySelector(`input[name="${panelName}.enabled"]`);
                if (panelToggle) {
                    const isEnabled = panelToggle.checked;
                    statusBadge.textContent = isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                    statusBadge.className = `status-badge ${isEnabled ? 'enabled' : 'disabled'}`;
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š ${panelName}é¢æ¿é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°${panelName}é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:`, error);
        }
    }

    /**
     * æ ¹æ®å¤é€‰æ¡†æ‰€åœ¨é¢æ¿æ›´æ–°å¯¹åº”çš„è®¡æ•°
     */
    updatePanelCounts(checkbox) {
        try {
            // æ‰¾åˆ°å¤é€‰æ¡†æ‰€åœ¨çš„é¢æ¿
            const panelContainer = checkbox.closest('[data-content]');
            if (!panelContainer) return;

            const panelName = panelContainer.getAttribute('data-content');

            // ğŸ”§ ä¿®å¤ï¼šç‰¹æ®Šé¢æ¿ä¸éœ€è¦æ›´æ–°è®¡æ•°ï¼ˆå®ƒä»¬ä¸æ˜¯é…ç½®é¢æ¿ï¼‰
            const specialPanels = ['memoryEnhancement', 'vectorFunction', 'summary', 'npc-management', 'theme', 'frontend-display', 'advanced', 'promptSettings', 'customAPI'];
            if (specialPanels.includes(panelName)) {
                return;
            }

            // æ ¹æ®é¢æ¿ç±»å‹æ›´æ–°å¯¹åº”çš„è®¡æ•°
            if (panelName === 'basic') {
                this.updateBasicPanelCount();
            } else {
                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰é¢æ¿
                const customPanels = this.getCustomPanels();
                const customPanel = customPanels[panelName];

                if (customPanel) {
                    // è‡ªå®šä¹‰é¢æ¿
                    this.updateCustomPanelCount(panelName, customPanel);
                } else {
                    // ğŸ”§ æ–°æ¶æ„ï¼šç»Ÿä¸€ä½¿ç”¨updateCustomPanelCount
                    this.updateCustomPanelCount(panelName, { subItems: [] });
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢æ¿è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰é¢æ¿çš„é…ç½®è®¡æ•°æ˜¾ç¤º
     */
    updateCustomPanelCount(panelId, panel) {
        try {
            const countElement = this.modal.querySelector(`#${panelId}-panel-count`);
            if (!countElement) {
                // ğŸ”§ ä¿®å¤ï¼šæŸäº›é¢æ¿ä¸éœ€è¦è®¡æ•°å…ƒç´ ï¼Œé™ä½æ—¥å¿—çº§åˆ«é¿å…è¯¯å¯¼
                console.debug(`[InfoBarSettings] æœªæ‰¾åˆ°é¢æ¿è®¡æ•°å…ƒç´ ï¼ˆå¯èƒ½æ˜¯ç‰¹æ®Šé¢æ¿ï¼‰: ${panelId}-panel-count`);
                return;
            }

            // è·å–å½“å‰é¢æ¿çš„æ‰€æœ‰å¤é€‰æ¡†
            const subItems = panel.subItems || [];
            const enabledSubItems = subItems.filter(subItem => {
                const fieldName = subItem.name || subItem.key || subItem.id;
                const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);
                return checkbox && checkbox.checked;
            });

            const totalCount = subItems.length;
            const enabledCount = enabledSubItems.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            console.log(`[InfoBarSettings] ğŸ“Š è‡ªå®šä¹‰é¢æ¿${panel.name}é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:`, error);
        }
    }

    /**
     * æ›´æ–°æ‰€æœ‰é¢æ¿çš„é…ç½®è®¡æ•°
     */
    updateAllPanelCounts() {
        try {
            // æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿è®¡æ•°
            this.updateBasicPanelCount();

            // ğŸ”§ æ–°æ¶æ„ï¼šæ›´æ–°æ‰€æœ‰é¢æ¿è®¡æ•°ï¼ˆä»customPanelsè·å–ï¼‰
            const customPanels = this.getCustomPanels();
            const allPanels = Object.keys(customPanels);

            allPanels.forEach(panelKey => {
                const panel = customPanels[panelKey];
                if (panel) {
                    this.updateCustomPanelCount(panelKey, panel);
                }
            });

            console.log('[InfoBarSettings] ğŸ“Š æ‰€æœ‰é¢æ¿é…ç½®è®¡æ•°å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ‰€æœ‰é¢æ¿è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰é¢æ¿
     */
    async saveCustomPanel(panel) {
        try {
            // ğŸ”§ å‚æ•°éªŒè¯ï¼šç¡®ä¿é¢æ¿æ•°æ®å®Œæ•´æ€§
            if (!panel) {
                console.error('[InfoBarSettings] âŒ é¢æ¿æ•°æ®ä¸ºç©º');
                return false;
            }

            if (!panel.id || panel.id === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ:', panel.id);
                return false;
            }

            if (!panel.name || panel.name === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿åç§°æ— æ•ˆ:', panel.name);
                return false;
            }

            if (!panel.type || panel.type === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿ç±»å‹æ— æ•ˆ:', panel.type);
                return false;
            }

            console.log('[InfoBarSettings] ğŸ“Š ä¿å­˜é¢æ¿æ•°æ®éªŒè¯é€šè¿‡:', panel.id, panel.name);

            // è·å–ç°æœ‰è‡ªå®šä¹‰é¢æ¿
            const customPanels = this.getCustomPanels();

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºå­˜å‚¨é”®ï¼Œç¡®ä¿ä¸ä¿¡æ¯æ ç³»ç»Ÿè®¾è®¡ä¸€è‡´
            customPanels[panel.key] = panel;

            // ä¿å­˜åˆ°å…¨å±€é…ç½®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            window.InfoBarCustomPanels = customPanels;

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜è‡ªå®šä¹‰é¢æ¿æ•°æ®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ğŸ”§ ä¿®å¤ï¼šä¹Ÿå°†è‡ªå®šä¹‰é¢æ¿é…ç½®ä¿å­˜åˆ°æ ¹çº§åˆ«ï¼Œè®©mergeWithEnabledFieldsèƒ½å¤Ÿè¯»å–
            // è¿™æ ·è‡ªå®šä¹‰é¢æ¿çš„å­é¡¹é…ç½®å°±èƒ½è¢«æ­£ç¡®è¯†åˆ«ä¸ºå¯ç”¨å­—æ®µ
            extensionSettings['Information bar integration tool'][panel.key] = {
                enabled: panel.enabled !== false, // é»˜è®¤å¯ç”¨
                subItems: panel.subItems || [],
                description: panel.description || '',
                icon: panel.icon || '',
                type: 'custom',
                key: panel.key,
                name: panel.name
            };

            console.log(`[InfoBarSettings] ğŸ”§ è‡ªå®šä¹‰é¢æ¿é…ç½®å·²åŒæ­¥åˆ°æ ¹çº§åˆ«: ${panel.key}, å­é¡¹æ•°é‡: ${panel.subItems?.length || 0}`);

            // è§¦å‘ SillyTavern ä¿å­˜è®¾ç½®
            context.saveSettingsDebounced();

            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æ˜ å°„æ—¶é‡æ–°ç”Ÿæˆ
            this._cachedCompleteMapping = null;

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿å·²ä¿å­˜:', panel.id);
            return true;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è‡ªå®šä¹‰é¢æ¿å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * ç¼–è¾‘é¢æ¿
     */
    editPanel(panelId) {
        // é€‰æ‹©é¢æ¿è¿›è¡Œç¼–è¾‘ï¼ˆä¸ç‚¹å‡»é¢æ¿é¡¹ç›¸åŒï¼‰
        const panelItem = this.modal.querySelector(`[data-panel-id="${panelId}"]`);
        if (panelItem) {
            const panelType = panelItem.dataset.panelType;
            this.selectPanelForEdit(panelId, panelType);
        }
    }

    /**
     * æŸ¥çœ‹é¢æ¿
     */
    viewPanel(panelId) {
        // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿ï¼ˆåŒ…æ‹¬é¢„è®¾ï¼‰éƒ½å¯ä»¥ç¼–è¾‘
        this.editPanel(panelId);
    }

    /**
     * å¤åˆ¶é¢æ¿
     */
    async duplicatePanel(panelId) {
        try {
            const customPanels = this.getCustomPanels();
            const originalPanel = customPanels[panelId];

            if (!originalPanel) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°è¦å¤åˆ¶çš„é¢æ¿:', panelId);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šåˆ›å»ºå‰¯æœ¬ï¼Œä½¿ç”¨é”®åä½œä¸ºID
            const newKey = `${originalPanel.key}_copy_${Date.now()}`;
            const duplicatedPanel = {
                ...originalPanel,
                id: newKey,  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºID
                name: `${originalPanel.name} - å‰¯æœ¬`,
                key: newKey,
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            // ä¿å­˜å‰¯æœ¬
            await this.saveCustomPanel(duplicatedPanel);

            // åˆ·æ–°åˆ—è¡¨
            this.refreshPanelList();

            console.log('[InfoBarSettings] ğŸ“‹ é¢æ¿å¤åˆ¶å®Œæˆ:', duplicatedPanel.id);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤åˆ¶é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢é¢æ¿å¯ç”¨çŠ¶æ€
     */
    async togglePanel(panelId) {
        try {
            // å¯¹äºåŸºç¡€é¢æ¿ï¼Œåˆ‡æ¢å¯¼èˆªæ˜¾ç¤ºçŠ¶æ€
            // å¯¹äºè‡ªå®šä¹‰é¢æ¿ï¼Œåˆ‡æ¢å¯ç”¨çŠ¶æ€
            const panelItem = this.modal.querySelector(`[data-panel-id="${panelId}"]`);
            const panelType = panelItem?.dataset.panelType;

            if (panelType === 'custom') {
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];

                if (panel) {
                    panel.enabled = !panel.enabled;
                    panel.updatedAt = Date.now();
                    await this.saveCustomPanel(panel);
                }
            }

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢é¢æ¿çŠ¶æ€:', panelId);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢é¢æ¿çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜é¢æ¿å±æ€§
     */
    async savePanelProperties() {
        try {
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿');
                return;
            }

            const { id, type } = this.currentEditingPanel;
            const panelName = this.currentEditingPanel.name || id;

            // æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†
            this.showSaveConfirmDialog(panelName, async () => {
                await this.performSavePanelProperties(id, type);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é¢æ¿å±æ€§å¤±è´¥:', error);
            this.showMessage('é¢æ¿ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ‰§è¡Œä¿å­˜é¢æ¿å±æ€§æ“ä½œ
     */
    async performSavePanelProperties(id, type) {
        try {

            if (type === 'basic') {
                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ä¹Ÿéœ€è¦ä¿å­˜åŠŸèƒ½
                console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜åŸºç¡€é¢æ¿å±æ€§:', id);

                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿å•ç‹¬æ”¶é›†è¡¨å•æ•°æ®ï¼Œä¸åŒ…å«å­é¡¹
            // è¯»å–å½“å‰å‹¾é€‰çŠ¶æ€ï¼Œé¿å…å› DOMé‡ç»˜é€ æˆçŠ¶æ€ä¸¢å¤±
            const form = this.modal.querySelector('.panel-properties-form');
            const memoryInjectChecked = !!form?.querySelector('#panel-memory-inject')?.checked;
            const requiredChecked = !!form?.querySelector('#panel-required')?.checked;

            const formData = this.collectBasicPanelFormData();
            // è¦†ç›–å…³é”®å¸ƒå°”ä½ï¼Œä»¥å½“å‰UIä¸ºå‡†
            formData.memoryInject = memoryInjectChecked;
            formData.required = requiredChecked;

                // ä¿å­˜åˆ°extensionSettings
                const context = SillyTavern.getContext();
                const extensionSettings = context.extensionSettings;

                if (!extensionSettings['Information bar integration tool']) {
                    extensionSettings['Information bar integration tool'] = {};
                }

                if (!extensionSettings['Information bar integration tool'][id]) {
                    extensionSettings['Information bar integration tool'][id] = {};
                }

                // æ›´æ–°åŸºç¡€é¢æ¿é…ç½®
                Object.assign(extensionSettings['Information bar integration tool'][id], formData);

                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ç°åœ¨å…è®¸ä¿å­˜ç”¨æˆ·æ·»åŠ çš„å­é¡¹æ•°æ®
                // ä¸å†åˆ é™¤å­é¡¹æ•°æ®ï¼Œå…è®¸ç”¨æˆ·ä¸ºåŸºç¡€é¢æ¿æ·»åŠ è‡ªå®šä¹‰å­é¡¹
                console.log('[InfoBarSettings] ğŸ’¾ åŸºç¡€é¢æ¿å­é¡¹æ•°æ®å·²ä¿å­˜:', formData.subItems?.length || 0, 'ä¸ª');

                // ä¿å­˜è®¾ç½®
                context.saveSettingsDebounced();

                // ğŸ”§ ä¿®å¤ï¼šæ‰€æœ‰é¢æ¿å·²é€šè¿‡ç»Ÿä¸€æ¸²æŸ“ï¼Œä¸éœ€è¦å•ç‹¬åˆ·æ–°
                console.log('[InfoBarSettings] â„¹ï¸ é¢æ¿é…ç½®å·²ä¿å­˜ï¼Œå­—æ®µå·²åœ¨createCustomPanelContent()ä¸­æ¸²æŸ“');

                console.log('[InfoBarSettings] âœ… åŸºç¡€é¢æ¿å±æ€§ä¿å­˜æˆåŠŸ:', id);
                this.showMessage('åŸºç¡€é¢æ¿ä¿å­˜æˆåŠŸ', 'success');

                return;
            }

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = this.collectPanelFormData();

            // æ”¶é›†å­é¡¹æ•°æ®
            const subItemsData = this.collectSubItemsData();
            formData.subItems = subItemsData;

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', formData);
            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„å­é¡¹æ•°æ®:', subItemsData);

            // æ›´æ–°é¢æ¿é…ç½®
            const customPanels = this.getCustomPanels();
            const panel = customPanels[id];

            if (panel) {
                Object.assign(panel, formData, { updatedAt: Date.now() });
                await this.saveCustomPanel(panel);

                // åˆ·æ–°é¢æ¿åˆ—è¡¨
                this.refreshPanelList();

                // åˆ·æ–°å¯¼èˆªæ ï¼ˆæ›´æ–°è‡ªå®šä¹‰é¢æ¿å†…å®¹ï¼‰
                this.refreshNavigation();

                // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªé¢æ¿çš„å†…å®¹ï¼Œä¹Ÿéœ€è¦æ›´æ–°å³ä¾§å†…å®¹åŒºåŸŸ
                const activeNavItem = this.modal.querySelector('.nav-item.active');
                if (activeNavItem && activeNavItem.dataset.nav === id) {
                    // æ›´æ–°å³ä¾§å†…å®¹é¢æ¿
                    const contentPanel = this.modal.querySelector(`.content-panel[data-content="${id}"]`);
                    if (contentPanel) {
                        contentPanel.innerHTML = this.createCustomPanelContent(panel);
                        console.log('[InfoBarSettings] ğŸ”„ å·²æ›´æ–°å³ä¾§å†…å®¹é¢æ¿æ˜¾ç¤º');
                    }
                }

                console.log('[InfoBarSettings] âœ… é¢æ¿å±æ€§ä¿å­˜æˆåŠŸ:', id, 'åŒ…å«', subItemsData.length, 'ä¸ªå­é¡¹');

                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                this.showMessage('é¢æ¿ä¿å­˜æˆåŠŸ', 'success');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œä¿å­˜é¢æ¿å±æ€§æ“ä½œå¤±è´¥:', error);
            this.showMessage('é¢æ¿ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * åˆ é™¤é¢æ¿
     */
    async deletePanel() {
        try {
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿');
                return;
            }

            const { id, type } = this.currentEditingPanel;

            // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿ï¼ˆåŒ…æ‹¬é¢„è®¾ï¼‰éƒ½å¯ä»¥åˆ é™¤
            // é¢„è®¾é¢æ¿åˆ é™¤åå¯ä»¥é€šè¿‡PresetPanelsManager.restorePreset()æ¢å¤

            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('é¢æ¿', id, async () => {
                await this.performDeletePanel(id);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤é¢æ¿å¤±è´¥:', error);
            this.showMessage('é¢æ¿åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ‰§è¡Œåˆ é™¤é¢æ¿æ“ä½œ
     */
    async performDeletePanel(id) {
        try {
            // ä»è‡ªå®šä¹‰é¢æ¿ä¸­åˆ é™¤
            const customPanels = this.getCustomPanels();
            const panelToDelete = customPanels[id];
            delete customPanels[id];

            // ä¿å­˜é…ç½®
            window.InfoBarCustomPanels = customPanels;

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜è‡ªå®šä¹‰é¢æ¿æ•°æ®
            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ğŸ”§ ä¿®å¤ï¼šä¹Ÿä»æ ¹çº§åˆ«åˆ é™¤è‡ªå®šä¹‰é¢æ¿é…ç½®
            delete extensionSettings['Information bar integration tool'][id];
            console.log(`[InfoBarSettings] ğŸ”§ å·²ä»æ ¹çº§åˆ«åˆ é™¤è‡ªå®šä¹‰é¢æ¿é…ç½®: ${id}`);
            
            // ğŸ“ æ–°æ¶æ„ï¼šé¢„è®¾é¢æ¿åˆ é™¤åä¸ä¼šè‡ªåŠ¨æ¢å¤ï¼ˆå·²åºŸå¼ƒdeletedPresetPanelsæœºåˆ¶ï¼‰
            console.log(`[InfoBarSettings] ğŸ“ é¢æ¿å·²åˆ é™¤: ${id}${panelToDelete?.type === 'preset' ? ' (é¢„è®¾é¢æ¿)' : ''}ï¼Œåç»­ç”±ç”¨æˆ·å®Œå…¨æ§åˆ¶`);

            // è§¦å‘ SillyTavern ä¿å­˜è®¾ç½®
            context.saveSettingsDebounced();

            // æ¸…ç©ºå±æ€§è¡¨å•
            this.clearPanelProperties();

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆç§»é™¤è‡ªå®šä¹‰é¢æ¿ä»å¯¼èˆªï¼‰
            this.refreshNavigation();

            console.log('[InfoBarSettings] ğŸ—‘ï¸ é¢æ¿åˆ é™¤æˆåŠŸ:', id);

            // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
            this.showMessage('é¢æ¿åˆ é™¤æˆåŠŸ', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œåˆ é™¤é¢æ¿æ“ä½œå¤±è´¥:', error);
            this.showMessage('é¢æ¿åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºé‡å‘½åé¢æ¿å¯¹è¯æ¡†
     */
    showRenamePanelDialog(panelId) {
        try {
            console.log('[InfoBarSettings] âœï¸ æ˜¾ç¤ºé‡å‘½åé¢æ¿å¯¹è¯æ¡†:', panelId);

            if (!panelId) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ');
                return;
            }

            // è·å–é¢æ¿ä¿¡æ¯
            const customPanels = this.getCustomPanels();
            const panel = customPanels[panelId];
            if (!panel) {
                console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨:', panelId);
                return;
            }

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯ï¼ˆå‚è€ƒåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†çš„ç§»åŠ¨ç«¯å…¼å®¹æ ·å¼ï¼‰
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'rename-panel-dialog-overlay';

            // ğŸ”§ ç§»åŠ¨ç«¯å…¼å®¹ï¼šä½¿ç”¨ä¸åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†ç›¸åŒçš„æ ·å¼
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                backdrop-filter: blur(4px);
            `;

            dialogOverlay.innerHTML = `
                <div class="rename-panel-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 420px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header" style="
                        padding: 20px;
                        border-bottom: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ç¼–è¾‘é¢æ¿åç§°</h3>
                        <button class="dialog-close-btn" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-primary, #ffffff);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                            transition: background 0.2s;
                        ">Ã—</button>
                    </div>
                    <div class="dialog-content" style="padding: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                            é¢æ¿åç§°
                        </label>
                        <input
                            type="text"
                            id="rename-panel-input"
                            value="${this.escapeHtml(panel.name)}"
                            style="
                                width: 100%;
                                padding: 10px 12px;
                                background: var(--theme-bg-secondary, #1a1a1a);
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                                border-radius: 6px;
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                                transition: border-color 0.2s;
                            "
                            placeholder="è¯·è¾“å…¥é¢æ¿åç§°"
                        />
                    </div>
                    <div class="dialog-footer" style="
                        padding: 16px 20px;
                        border-top: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        gap: 12px;
                        justify-content: flex-end;
                    ">
                        <button class="btn-cancel" data-action="cancel-rename" style="
                            padding: 8px 20px;
                            background: var(--theme-bg-secondary, #1a1a1a);
                            color: var(--theme-text-primary, #ffffff);
                            border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s;
                        ">å–æ¶ˆ</button>
                        <button class="btn-confirm" data-action="confirm-rename" style="
                            padding: 8px 20px;
                            background: var(--theme-primary-color, #007bff);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s;
                        ">ç¡®è®¤</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // èšç„¦è¾“å…¥æ¡†å¹¶é€‰ä¸­æ–‡æœ¬
            const input = dialogOverlay.querySelector('#rename-panel-input');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);

            // ç»‘å®šäº‹ä»¶
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) closeDialog();
            });

            // ç‚¹å‡»å…³é—­æŒ‰é’®
            dialogOverlay.querySelector('.dialog-close-btn').addEventListener('click', closeDialog);
            dialogOverlay.querySelector('[data-action="cancel-rename"]').addEventListener('click', closeDialog);

            // ç¡®è®¤é‡å‘½å
            dialogOverlay.querySelector('[data-action="confirm-rename"]').addEventListener('click', async () => {
                const newName = input.value.trim();
                if (!newName) {
                    this.showMessage('é¢æ¿åç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                // æ›´æ–°é¢æ¿åç§°
                panel.name = newName;
                customPanels[panelId] = panel;

                // ä¿å­˜é…ç½®
                const context = SillyTavern.getContext();
                const extensionSettings = context.extensionSettings;
                if (!extensionSettings['Information bar integration tool']) {
                    extensionSettings['Information bar integration tool'] = {};
                }
                extensionSettings['Information bar integration tool'].customPanels = customPanels;

                // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°å…¨å±€å˜é‡
                window.InfoBarCustomPanels = customPanels;

                context.saveSettingsDebounced();

                // ğŸ”§ ä¿®å¤ï¼šç«‹å³æ›´æ–°å¯¼èˆªæ ä¸­çš„åç§°ï¼ˆä¸åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼‰
                const navItem = this.modal.querySelector(`.nav-item[data-nav="${panelId}"]`);
                if (navItem) {
                    const navText = navItem.querySelector('.nav-text');
                    if (navText) {
                        navText.textContent = newName;
                    }
                }

                // ğŸ”§ ä¿®å¤ï¼šç«‹å³æ›´æ–°å½“å‰æ˜¾ç¤ºçš„å†…å®¹é¢æ¿æ ‡é¢˜
                const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
                if (contentPanel) {
                    const header = contentPanel.querySelector('.content-header h3');
                    if (header) {
                        header.textContent = newName;
                    }

                    // åŒæ—¶æ›´æ–°å¡ç‰‡æ ‡é¢˜
                    const cardTitle = contentPanel.querySelector('.card-title');
                    if (cardTitle) {
                        cardTitle.textContent = newName;
                    }
                }

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.showMessage('é¢æ¿åç§°å·²æ›´æ–°', 'success');

                closeDialog();
            });

            // æ”¯æŒå›è½¦ç¡®è®¤
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    dialogOverlay.querySelector('[data-action="confirm-rename"]').click();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• ä¸Šç§»é¢æ¿
     */
    movePanelUp(panelId) {
        try {
            console.log('[InfoBarSettings] â¬†ï¸ ä¸Šç§»é¢æ¿:', panelId);

            if (!panelId) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ');
                return;
            }

            const customPanels = this.getCustomPanels();
            const panelKeys = Object.keys(customPanels);
            const currentIndex = panelKeys.indexOf(panelId);

            if (currentIndex === -1) {
                console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨:', panelId);
                return;
            }

            if (currentIndex === 0) {
                this.showMessage('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªé¢æ¿äº†', 'info');
                return;
            }

            // äº¤æ¢ä½ç½®
            [panelKeys[currentIndex - 1], panelKeys[currentIndex]] = [panelKeys[currentIndex], panelKeys[currentIndex - 1]];

            // é‡å»ºé¢æ¿å¯¹è±¡ï¼ˆæŒ‰æ–°é¡ºåºï¼‰
            const reorderedPanels = {};
            panelKeys.forEach(key => {
                reorderedPanels[key] = customPanels[key];
            });

            // ä¿å­˜é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            extensionSettings['Information bar integration tool'].customPanels = reorderedPanels;

            // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°å…¨å±€å˜é‡
            window.InfoBarCustomPanels = reorderedPanels;

            context.saveSettingsDebounced();

            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°å¯¼èˆªæ ï¼Œä¿æŒå½“å‰é¢æ¿é€‰ä¸­çŠ¶æ€
            this.refreshNavigation();

            // é‡æ–°é€‰ä¸­å½“å‰é¢æ¿ï¼ˆç¡®ä¿UIçŠ¶æ€æ­£ç¡®ï¼‰
            const navItem = this.modal.querySelector(`.nav-item[data-nav="${panelId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            this.showMessage('é¢æ¿å·²ä¸Šç§»', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸Šç§»é¢æ¿å¤±è´¥:', error);
            this.showMessage('ä¸Šç§»å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• ä¸‹ç§»é¢æ¿
     */
    movePanelDown(panelId) {
        try {
            console.log('[InfoBarSettings] â¬‡ï¸ ä¸‹ç§»é¢æ¿:', panelId);

            if (!panelId) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ');
                return;
            }

            const customPanels = this.getCustomPanels();
            const panelKeys = Object.keys(customPanels);
            const currentIndex = panelKeys.indexOf(panelId);

            if (currentIndex === -1) {
                console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨:', panelId);
                return;
            }

            if (currentIndex === panelKeys.length - 1) {
                this.showMessage('å·²ç»æ˜¯æœ€åä¸€ä¸ªé¢æ¿äº†', 'info');
                return;
            }

            // äº¤æ¢ä½ç½®
            [panelKeys[currentIndex], panelKeys[currentIndex + 1]] = [panelKeys[currentIndex + 1], panelKeys[currentIndex]];

            // é‡å»ºé¢æ¿å¯¹è±¡ï¼ˆæŒ‰æ–°é¡ºåºï¼‰
            const reorderedPanels = {};
            panelKeys.forEach(key => {
                reorderedPanels[key] = customPanels[key];
            });

            // ä¿å­˜é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            extensionSettings['Information bar integration tool'].customPanels = reorderedPanels;

            // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°å…¨å±€å˜é‡
            window.InfoBarCustomPanels = reorderedPanels;

            context.saveSettingsDebounced();

            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°å¯¼èˆªæ ï¼Œä¿æŒå½“å‰é¢æ¿é€‰ä¸­çŠ¶æ€
            this.refreshNavigation();

            // é‡æ–°é€‰ä¸­å½“å‰é¢æ¿ï¼ˆç¡®ä¿UIçŠ¶æ€æ­£ç¡®ï¼‰
            const navItem = this.modal.querySelector(`.nav-item[data-nav="${panelId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            this.showMessage('é¢æ¿å·²ä¸‹ç§»', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸‹ç§»é¢æ¿å¤±è´¥:', error);
            this.showMessage('ä¸‹ç§»å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ˜¾ç¤ºå­é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showSubItemDialog() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºå­é¡¹æ·»åŠ å¯¹è¯æ¡†');

            // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œæ— æ³•æ·»åŠ å­é¡¹');
                alert('è¯·å…ˆé€‰æ‹©è¦æ·»åŠ å­é¡¹çš„é¢æ¿');
                return;
            }

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'sub-item-dialog-overlay';

            // ğŸ”§ è®¾ç½®å®Œç¾å±…ä¸­æ ·å¼ - å‚è€ƒé¢æ¿è§„åˆ™ç¼–è¾‘ç•Œé¢
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                visibility: visible;
                transition: opacity 0.3s ease;
            `;

            dialogOverlay.innerHTML = `
                <div class="sub-item-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 450px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header" style="
                        padding: 20px 24px 16px;
                        border-bottom: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; color: var(--theme-text-primary, #ffffff); font-size: 18px;">æ·»åŠ å­é¡¹åˆ°é¢æ¿: ${this.currentEditingPanel.name}</h3>
                        <button class="dialog-close-btn" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-secondary, #aaa);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                        ">Ã—</button>
                    </div>
                    <div class="dialog-content" style="padding: 20px 24px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="subitem-name" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">å­é¡¹åç§°:</label>
                            <input type="text" id="subitem-name" placeholder="è¯·è¾“å…¥å­é¡¹åç§°" value="æ–°å»ºå­é¡¹" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                                margin-bottom: 8px;
                            ">
                            <small class="form-help" style="
                                color: var(--theme-text-secondary, #aaa);
                                font-size: 12px;
                                display: block;
                            ">æ³¨æ„ï¼šå­é¡¹åç§°å°†ç›´æ¥ä½œä¸ºé”®åä½¿ç”¨</small>
                        </div>
                    </div>
                    <div class="dialog-footer" style="
                        padding: 16px 24px 20px;
                        border-top: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button class="btn-cancel" style="
                            padding: 10px 20px;
                            border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                            border-radius: 6px;
                            background: transparent;
                            color: var(--theme-text-secondary, #aaa);
                            cursor: pointer;
                            font-size: 14px;
                        ">å…³é—­</button>
                        <button class="btn-confirm" style="
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            background: var(--theme-primary-color, #4299e1);
                            color: var(--theme-text-primary, #ffffff);
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        ">ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ğŸ”§ æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                dialogOverlay.style.opacity = '1';
            }, 10);

            // ä¸éœ€è¦ç”Ÿæˆé”®åï¼Œåç§°å°±æ˜¯é”®å

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const confirmBtn = dialogOverlay.querySelector('.btn-confirm');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤æ·»åŠ äº‹ä»¶
            confirmBtn.addEventListener('click', () => {
                const name = document.getElementById('subitem-name').value.trim();

                // éªŒè¯è¾“å…¥
                if (!name) {
                    alert('è¯·è¾“å…¥å­é¡¹åç§°');
                    return;
                }

                // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆåœ¨å½“å‰é¢æ¿çš„å­é¡¹ä¸­ï¼‰
                const existingSubItems = this.currentEditingPanel.subItems || [];
                if (existingSubItems.some(item => item.name === name || item.key === name)) {
                    alert('è¯¥å­é¡¹åç§°åœ¨å½“å‰é¢æ¿ä¸­å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                    return;
                }

                // åˆ›å»ºå­é¡¹æ•°æ®ï¼ˆåç§°å°±æ˜¯é”®åï¼‰
                const subItemData = {
                    name: name,
                    key: name,
                    description: ''
                };

                // å…³é—­å¯¹è¯æ¡†
                closeDialog();

                // æ‰§è¡Œæ·»åŠ å­é¡¹
                this.addSubItem(subItemData);
            });

            // å­é¡¹åç§°è¾“å…¥æ—¶è¿›è¡ŒåŸºç¡€éªŒè¯
            const nameInput = document.getElementById('subitem-name');
            nameInput.addEventListener('input', (e) => {
                // å¯ä»¥æ·»åŠ ä¸€äº›åŸºç¡€çš„åç§°éªŒè¯é€»è¾‘
                const value = e.target.value;
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ åç§°æ ¼å¼éªŒè¯
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå­é¡¹å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * ä»é¢æ¿åç§°ç”Ÿæˆè‹±æ–‡é”®å
     */
    generateKeyFromName(name) {
        // åŸºç¡€çš„ä¸­æ–‡åˆ°è‹±æ–‡æ˜ å°„
        const chineseToEnglish = {
            'æ–°å»º': 'new',
            'é¢æ¿': 'panel',
            'è‡ªå®šä¹‰': 'custom',
            'ç”¨æˆ·': 'user',
            'è®¾ç½®': 'settings',
            'é…ç½®': 'config',
            'ç®¡ç†': 'manage',
            'ç³»ç»Ÿ': 'system',
            'æ•°æ®': 'data',
            'ä¿¡æ¯': 'info',
            'äº¤äº’': 'interaction',
            'å¯¹è±¡': 'object',
            'ä¸ªäºº': 'personal',
            'ä»»åŠ¡': 'task',
            'ä¸–ç•Œ': 'world',
            'ç»„ç»‡': 'organization',
            'æ–°é—»': 'news',
            'åº“å­˜': 'inventory',
            'èƒ½åŠ›': 'ability',
            'å‰§æƒ…': 'plot',
            'ä¿®çœŸ': 'cultivation',
            'å¥‡å¹»': 'fantasy',
            'ç°ä»£': 'modern',
            'å†å²': 'historical',
            'é­”æ³•': 'magic',
            'è®­ç»ƒ': 'training'
        };

        let key = name.toLowerCase();

        // æ›¿æ¢ä¸­æ–‡å­—ç¬¦ä¸ºè‹±æ–‡ï¼ˆåœ¨æ›¿æ¢æ—¶æ·»åŠ åˆ†éš”ç¬¦ï¼‰
        for (const [chinese, english] of Object.entries(chineseToEnglish)) {
            key = key.replace(new RegExp(chinese, 'g'), `_${english}_`);
        }

        // ç§»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯æ•°å­—ä¸‹åˆ’çº¿
        key = key.replace(/[^a-zA-Z0-9]/g, '_');

        // ç§»é™¤è¿ç»­çš„ä¸‹åˆ’çº¿
        key = key.replace(/_+/g, '_');

        // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
        key = key.replace(/^_+|_+$/g, '');

        // å¦‚æœé”®åä¸ºç©ºæˆ–ä»¥æ•°å­—å¼€å¤´ï¼Œæ·»åŠ å‰ç¼€
        if (!key || /^[0-9]/.test(key)) {
            key = 'custom_' + key;
        }

        return key || 'custom_panel';
    }

    /**
     * ç¡®ä¿é”®åå”¯ä¸€æ€§
     */
    ensureUniqueKey(baseKey, existingPanels) {
        let uniqueKey = baseKey;
        let counter = 1;

        while (existingPanels[uniqueKey]) {
            uniqueKey = `${baseKey}_${counter}`;
            counter++;
        }

        return uniqueKey;
    }

    /**
     * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
     */
    showDeleteConfirmDialog(type, name, onConfirm) {
        try {
            console.log(`[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†: ${type} - ${name}`);

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'delete-confirm-dialog-overlay';
            
            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ å†…è”æ ·å¼ï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ­£ç¡®å±…ä¸­
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                backdrop-filter: blur(4px);
            `;
            
            dialogOverlay.innerHTML = `
                <div class="delete-confirm-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 420px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header">
                        <h3>ç¡®è®¤åˆ é™¤</h3>
                        <button class="dialog-close-btn">Ã—</button>
                    </div>
                    <div class="dialog-content">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-message">
                            <p>æ‚¨ç¡®å®šè¦åˆ é™¤${type}"<strong>${name}</strong>"å—ï¼Ÿ</p>
                            <p class="warning-text">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œåˆ é™¤åæ‰€æœ‰ç›¸å…³æ•°æ®å°†ä¸¢å¤±ã€‚</p>
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-delete">ç¡®è®¤åˆ é™¤</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const deleteBtn = dialogOverlay.querySelector('.btn-delete');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤åˆ é™¤äº‹ä»¶
            deleteBtn.addEventListener('click', () => {
                closeDialog();
                if (onConfirm) {
                    onConfirm();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†
     */
    showSaveConfirmDialog(panelName, onConfirm) {
        try {
            console.log(`[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†: ${panelName}`);

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'save-confirm-dialog-overlay';
            dialogOverlay.innerHTML = `
                <div class="save-confirm-dialog">
                    <div class="dialog-header">
                        <h3>ç¡®è®¤ä¿å­˜</h3>
                        <button class="dialog-close-btn">Ã—</button>
                    </div>
                    <div class="dialog-content">
                        <div class="info-icon">ğŸ’¾</div>
                        <div class="info-message">
                            <p>æ‚¨ç¡®å®šè¦ä¿å­˜é¢æ¿"<strong>${panelName}</strong>"çš„é…ç½®å—ï¼Ÿ</p>
                            <p class="info-text">ä¿å­˜åæ–°çš„é…ç½®å°†ç”Ÿæ•ˆã€‚</p>
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-save">ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const saveBtn = dialogOverlay.querySelector('.btn-save');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤ä¿å­˜äº‹ä»¶
            saveBtn.addEventListener('click', () => {
                closeDialog();
                if (onConfirm) {
                    onConfirm();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹
     */
    addSubItem(subItemData = null) {
        try {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œæ— æ³•æ·»åŠ å­é¡¹');
                return;
            }

            // å¦‚æœæ²¡æœ‰æä¾›å­é¡¹æ•°æ®ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
            if (!subItemData) {
                this.showSubItemDialog();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“ å½“å‰ç¼–è¾‘é¢æ¿:', this.currentEditingPanel);
            console.log('[InfoBarSettings] ğŸ“Š æ·»åŠ å­é¡¹:', subItemData);

            // åˆ›å»ºæ–°çš„å­é¡¹
            const newSubItem = {
                id: `sub_${Date.now()}`,
                name: subItemData.name,
                key: subItemData.key,
                description: subItemData.description || ''
            };

            // æ·»åŠ åˆ°å­é¡¹å®¹å™¨ï¼ˆUIæ˜¾ç¤ºï¼‰
            this.addSubItemToContainer(newSubItem);

            console.log('[InfoBarSettings] â• æ·»åŠ å­é¡¹åˆ°é¢æ¿:', this.currentEditingPanel.id, 'å­é¡¹:', newSubItem.id);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * åˆ é™¤å­é¡¹
     */
    removeSubItem(buttonElement) {
        try {
            // æ‰¾åˆ°å­é¡¹è¡¨å•å…ƒç´ 
            const subItemForm = buttonElement.closest('.sub-item-form');
            if (!subItemForm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹è¡¨å•');
                return;
            }

            const subItemId = subItemForm.dataset.subItemId;
            const subItemName = subItemForm.querySelector('.sub-item-name')?.value || subItemId;

            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('å­é¡¹', subItemName, () => {
                this.performRemoveSubItem(subItemForm, subItemId);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * æ‰§è¡Œåˆ é™¤å­é¡¹æ“ä½œ
     */
    performRemoveSubItem(subItemForm, subItemId) {
        try {
            // 1) å…ˆä»UIç§»é™¤
            subItemForm.remove();

            // 2) è¯»å–å½“å‰ç¼–è¾‘çš„é¢æ¿ä¿¡æ¯
            const current = this.currentEditingPanel || {};
            const panelId = current.id;
            const panelType = current.type;

            // 3) è·å–è¢«åˆ å­é¡¹çš„åç§°/é”®åï¼Œä¾¿äºå¤šæ¡ä»¶åŒ¹é…
            const nameInput = subItemForm.querySelector?.('.sub-item-name');
            const subItemName = (nameInput?.value || '').trim();
            const subItemKey = subItemName ? subItemName.toLowerCase().replace(/\s+/g, '_') : null;

            // 4) æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
            const container = this.modal.querySelector('.sub-items-container');
            const remainingSubItems = container.querySelectorAll('.sub-item-form');
            const emptyMessage = container.querySelector('.empty-sub-items');
            if (remainingSubItems.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }

            // 5) æŒä¹…åŒ–åˆ é™¤åˆ°é…ç½®ï¼ˆæ ¹å› ï¼šä¹‹å‰ä»…åˆ UIï¼Œæœªå†™å…¥é…ç½®ï¼Œåˆ‡æ¢ååˆè¢«é…ç½®æ¢å¤ï¼‰
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            if (!panelId) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ç¡®å®šå½“å‰é¢æ¿IDï¼Œè·³è¿‡æŒä¹…åŒ–åˆ é™¤');
            } else if (panelType === 'custom' || panelType === 'preset') {
                // è‡ªå®šä¹‰é¢æ¿/é¢„è®¾é¢æ¿ï¼šä» customPanels ä¸ æ ¹çº§é•œåƒé…ç½® åŒæ­¥åˆ é™¤
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];
                if (panel && Array.isArray(panel.subItems)) {
                    const before = panel.subItems.length;
                    panel.subItems = panel.subItems.filter(item =>
                        item.id !== subItemId && item.key !== subItemKey && item.name !== subItemName
                    );
                    const after = panel.subItems.length;
                    console.log(`[InfoBarSettings] ğŸ§¹ é¢æ¿ ${panelId} å­é¡¹å·²ä»å†…å­˜åˆ é™¤: ${before} -> ${after}`);

                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ ‡è®°é¢„è®¾é¢æ¿ä¸ºç”¨æˆ·å·²ä¿®æ”¹
                    if (panel.type === 'preset') {
                        panel.userModified = true;
                        console.log(`[InfoBarSettings] ğŸ”’ é¢„è®¾é¢æ¿ ${panelId} å·²æ ‡è®°ä¸ºç”¨æˆ·ä¿®æ”¹ï¼Œå°†ä¸å†è‡ªåŠ¨æ›´æ–°å­—æ®µ`);
                    }

                    // ğŸ”§ ç«‹å³ä¿å­˜åˆ°extensionSettingsï¼Œç¡®ä¿åˆ·æ–°é¡µé¢åä¸ä¼šæ¢å¤
                    extensionSettings['Information bar integration tool'].customPanels = customPanels;
                    console.log(`[InfoBarSettings] ğŸ’¾ å·²ç«‹å³ä¿å­˜customPanelsåˆ°extensionSettings`);

                    // æ ¹çº§é•œåƒï¼ˆç”¨äºæ•°æ®è¡¨æ ¼/å…¶ä»–æ¨¡å—è¯»å–ï¼‰
                    const mirrorKey = panel.key || panelId;
                    if (!extensionSettings['Information bar integration tool'][mirrorKey]) {
                        extensionSettings['Information bar integration tool'][mirrorKey] = { enabled: panel.enabled !== false };
                    }
                    extensionSettings['Information bar integration tool'][mirrorKey].subItems = panel.subItems;
                }
            }

            // 6) ä¿å­˜å¹¶æ›´æ–°è®¡æ•°/é€šçŸ¥
            if (typeof context.saveSettingsDebounced === 'function') {
                context.saveSettingsDebounced();
            }

            if (panelId) {
                // æ›´æ–°é¢æ¿è®¡æ•°æ˜¾ç¤º
                this.updatePanelConfigCount(panelId);

                // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿ç»Ÿä¸€åˆ·æ–°æ–¹å¼
                // é‡æ–°æ¸²æŸ“é¢æ¿åŒºå—ï¼ˆå¯¼èˆªä¸å†…å®¹ï¼‰
                this.refreshNavigation();
                // ğŸ”§ ä¿®å¤ï¼šä¸éœ€è¦å•ç‹¬åˆ·æ–°ï¼ŒcreateCustomPanelContent()å·²åŒ…å«æ‰€æœ‰å­—æ®µ

                // é€šçŸ¥å…¶ä»–æ¨¡å—ï¼ˆå¦‚æ•°æ®è¡¨æ ¼ï¼‰
                if (this.eventSystem) {
                    this.eventSystem.emit('panel:config:changed', {
                        panelId,
                        panelType: panelType || 'custom',
                        subItemRemoved: true,
                        removedId: subItemId,
                        timestamp: Date.now()
                    });
                }
            }

            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å­é¡¹æˆåŠŸï¼ˆå·²æŒä¹…åŒ–ï¼‰:', { panelId, panelType, subItemId, subItemName });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œåˆ é™¤å­é¡¹æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå…¨é€‰æ‰€æœ‰å­é¡¹
     */
    selectAllSubItems() {
        try {
            console.log('[InfoBarSettings] â˜‘ï¸ å…¨é€‰æ‰€æœ‰å­é¡¹');
            
            const container = this.modal.querySelector('.sub-items-container');
            if (!container) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹å®¹å™¨');
                return;
            }
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°çŠ¶æ€
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            console.log(`[InfoBarSettings] âœ… å·²å…¨é€‰ ${checkboxes.length} ä¸ªå­é¡¹`);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å…¨é€‰å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå…¨ä¸é€‰æ‰€æœ‰å­é¡¹
     */
    deselectAllSubItems() {
        try {
            console.log('[InfoBarSettings] â˜ å…¨ä¸é€‰æ‰€æœ‰å­é¡¹');
            
            const container = this.modal.querySelector('.sub-items-container');
            if (!container) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹å®¹å™¨');
                return;
            }
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°çŠ¶æ€
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            console.log(`[InfoBarSettings] âœ… å·²å–æ¶ˆé€‰æ‹© ${checkboxes.length} ä¸ªå­é¡¹`);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å–æ¶ˆé€‰æ‹©å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç¼–è¾‘å­é¡¹
     */
    editSubItem(buttonElement) {
        try {
            // æ‰¾åˆ°å­é¡¹è¡¨å•å…ƒç´ 
            const subItemForm = buttonElement.closest('.sub-item-form');
            if (!subItemForm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹è¡¨å•');
                return;
            }
            
            const nameInput = subItemForm.querySelector('.sub-item-name');
            if (!nameInput) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹åç§°è¾“å…¥æ¡†');
                return;
            }
            
            // èšç„¦åˆ°è¾“å…¥æ¡†å¹¶é€‰ä¸­æ–‡æœ¬
            nameInput.focus();
            nameInput.select();
            
            console.log('[InfoBarSettings] âœï¸ å¼€å§‹ç¼–è¾‘å­é¡¹');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¼–è¾‘å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä»å†…å®¹åŒºåˆ é™¤è‡ªå®šä¹‰é¢æ¿
     */
    deleteCustomPanelFromContent(panelId) {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤è‡ªå®šä¹‰é¢æ¿:', panelId);
            
            if (!panelId) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ');
                return;
            }
            
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('é¢æ¿', panelId, async () => {
                await this.performDeletePanel(panelId);
                
                // åˆ é™¤ååˆ‡æ¢åˆ°åŸºç¡€è®¾ç½®
                this.switchToContent('basic');
            });
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤è‡ªå®šä¹‰é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼ˆç›´æ¥å¼¹çª—ï¼Œä¸è·³è½¬ï¼‰
     */
    addCustomField(panelId) {
        try {
            console.log('[InfoBarSettings] â• æ·»åŠ å­—æ®µåˆ°é¢æ¿:', panelId);
            
            // ç›´æ¥æ˜¾ç¤ºæ·»åŠ å­—æ®µå¯¹è¯æ¡†
            this.showAddCustomFieldDialog(panelId);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­—æ®µå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºæ·»åŠ è‡ªå®šä¹‰å­—æ®µå¯¹è¯æ¡†
     */
    showAddCustomFieldDialog(panelId) {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºæ·»åŠ å­—æ®µå¯¹è¯æ¡†:', panelId);
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'sub-item-dialog-overlay';
            
            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ å†…è”æ ·å¼ï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ­£ç¡®å±…ä¸­
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                backdrop-filter: blur(4px);
            `;
            
            dialogOverlay.innerHTML = `
                <div class="sub-item-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 450px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header">
                        <h3>æ·»åŠ å­—æ®µ</h3>
                        <button class="dialog-close-btn">Ã—</button>
                    </div>
                    <div class="dialog-content">
                        <div class="form-group">
                            <label for="field-name">å­—æ®µåç§°</label>
                            <input type="text" id="field-name" placeholder="è¯·è¾“å…¥å­—æ®µåç§°" />
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-confirm">æ·»åŠ </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialogOverlay);
            
            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const confirmBtn = dialogOverlay.querySelector('.btn-confirm');
            const nameInput = dialogOverlay.querySelector('#field-name');
            
            const closeDialog = () => dialogOverlay.remove();
            
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) closeDialog();
            });
            
            // ç¡®è®¤æ·»åŠ 
            confirmBtn.addEventListener('click', async () => {
                const fieldName = nameInput.value.trim();
                
                if (!fieldName) {
                    this.showMessage('å­—æ®µåç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                // è‡ªåŠ¨ç”Ÿæˆé”®å
                const fieldKey = this.generateKeyFromName(fieldName);
                
                // æ·»åŠ å­—æ®µåˆ°é¢æ¿
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];
                
                if (!panel) {
                    console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨');
                    return;
                }
                
                // åˆ›å»ºæ–°å­—æ®µ
                const newField = {
                    id: `field_${Date.now()}`,
                    name: fieldName,
                    key: fieldKey,
                    enabled: true
                };
                
                // æ·»åŠ åˆ°é¢æ¿
                if (!panel.subItems) {
                    panel.subItems = [];
                }
                panel.subItems.push(newField);
                
                // ä¿å­˜é…ç½®
                await this.saveCustomPanel(panel);
                
                // åˆ·æ–°å†…å®¹é¢æ¿æ˜¾ç¤º
                const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
                if (contentPanel) {
                    contentPanel.innerHTML = this.createCustomPanelContent(panel);
                    this.applyThemeToCustomSubItems(contentPanel, panelId);
                }
                
                closeDialog();
                this.showMessage('å­—æ®µæ·»åŠ æˆåŠŸ', 'success');
                console.log('[InfoBarSettings] âœ… å­—æ®µæ·»åŠ æˆåŠŸ');
            });
            
            // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
            setTimeout(() => nameInput.focus(), 100);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ·»åŠ å­—æ®µå¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå…¨é€‰è‡ªå®šä¹‰é¢æ¿å­—æ®µ
     */
    selectAllCustomFields(panelId) {
        try {
            console.log('[InfoBarSettings] â˜‘ï¸ å…¨é€‰å­—æ®µ:', panelId);
            
            const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å†…å®¹é¢æ¿');
                return;
            }
            
            const checkboxes = contentPanel.querySelectorAll('.sub-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            console.log(`[InfoBarSettings] âœ… å·²å…¨é€‰ ${checkboxes.length} ä¸ªå­—æ®µ`);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å…¨é€‰å­—æ®µå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå…¨ä¸é€‰è‡ªå®šä¹‰é¢æ¿å­—æ®µ
     */
    deselectAllCustomFields(panelId) {
        try {
            console.log('[InfoBarSettings] â˜ å…¨ä¸é€‰å­—æ®µ:', panelId);
            
            const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å†…å®¹é¢æ¿');
                return;
            }
            
            const checkboxes = contentPanel.querySelectorAll('.sub-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            console.log(`[InfoBarSettings] âœ… å·²å–æ¶ˆé€‰æ‹© ${checkboxes.length} ä¸ªå­—æ®µ`);
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å–æ¶ˆé€‰æ‹©å­—æ®µå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç¼–è¾‘è‡ªå®šä¹‰å­—æ®µï¼ˆå†…è”ç¼–è¾‘æ¨¡å¼ï¼‰
     */
    editCustomField(panelId, fieldKey) {
        try {
            console.log('[InfoBarSettings] âœï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼:', panelId, fieldKey);
            
            // æ‰¾åˆ°å¯¹åº”çš„å­é¡¹å…ƒç´ 
            const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å†…å®¹é¢æ¿');
                return;
            }
            
            const subItem = contentPanel.querySelector(`.sub-item[data-field-key="${fieldKey}"]`);
            if (!subItem) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹å…ƒç´ ');
                return;
            }
            
            // è·å–å…ƒç´ 
            const label = subItem.querySelector('.checkbox-label');
            const editInput = subItem.querySelector('.field-name-edit-input');
            const actions = subItem.querySelector('.sub-item-inline-actions');
            const editBtn = subItem.querySelector('.btn-edit-field');
            const deleteBtn = subItem.querySelector('.btn-delete-field');
            const confirmBtn = subItem.querySelector('.btn-confirm-edit');
            const cancelBtn = subItem.querySelector('.btn-cancel-edit');
            
            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            label.style.display = 'none';
            editInput.style.display = 'inline-block';
            editInput.focus();
            editInput.select();
            
            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            confirmBtn.style.display = 'inline-flex';
            cancelBtn.style.display = 'inline-flex';
            
            // æ ‡è®°ç¼–è¾‘æ¨¡å¼
            actions.dataset.mode = 'edit';
            
            console.log('[InfoBarSettings] âœ… å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¼–è¾‘å­—æ®µå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç¡®è®¤ç¼–è¾‘å­—æ®µ
     */
    confirmEditField(panelId, fieldKey) {
        try {
            console.log('[InfoBarSettings] âœ“ ç¡®è®¤ç¼–è¾‘å­—æ®µ:', panelId, fieldKey);
            
            const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
            const subItem = contentPanel?.querySelector(`.sub-item[data-field-key="${fieldKey}"]`);
            
            if (!subItem) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹å…ƒç´ ');
                return;
            }
            
            const label = subItem.querySelector('.checkbox-label');
            const editInput = subItem.querySelector('.field-name-edit-input');
            const newName = editInput.value.trim();
            
            if (!newName) {
                this.showMessage('å­—æ®µåç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            // æ›´æ–°å­—æ®µåç§°
            const originalName = label.dataset.originalName;
            
            // æ›´æ–°é…ç½®
            const customPanels = this.getCustomPanels();
            const panel = customPanels[panelId];
            
            if (panel && panel.subItems) {
                const fieldIndex = panel.subItems.findIndex(item => 
                    item.name === originalName || item.key === fieldKey
                );
                
                if (fieldIndex !== -1) {
                    panel.subItems[fieldIndex].name = newName;
                    
                    // ä¿å­˜é…ç½®
                    this.saveCustomPanel(panel);
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    contentPanel.innerHTML = this.createCustomPanelContent(panel);
                    this.applyThemeToCustomSubItems(contentPanel, panelId);
                    
                    console.log('[InfoBarSettings] âœ… å­—æ®µåç§°å·²æ›´æ–°');
                    this.showMessage('å­—æ®µç¼–è¾‘æˆåŠŸ', 'success');
                }
            }
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¡®è®¤ç¼–è¾‘å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå–æ¶ˆç¼–è¾‘å­—æ®µ
     */
    cancelEditField(panelId, fieldKey) {
        try {
            console.log('[InfoBarSettings] âœ• å–æ¶ˆç¼–è¾‘å­—æ®µ:', panelId, fieldKey);
            
            const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
            const subItem = contentPanel?.querySelector(`.sub-item[data-field-key="${fieldKey}"]`);
            
            if (!subItem) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹å…ƒç´ ');
                return;
            }
            
            // è·å–å…ƒç´ 
            const label = subItem.querySelector('.checkbox-label');
            const editInput = subItem.querySelector('.field-name-edit-input');
            const actions = subItem.querySelector('.sub-item-inline-actions');
            const editBtn = subItem.querySelector('.btn-edit-field');
            const deleteBtn = subItem.querySelector('.btn-delete-field');
            const confirmBtn = subItem.querySelector('.btn-confirm-edit');
            const cancelBtn = subItem.querySelector('.btn-cancel-edit');
            
            // æ¢å¤åŸå§‹å€¼
            editInput.value = label.dataset.originalName || label.textContent.trim();
            
            // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
            label.style.display = '';
            editInput.style.display = 'none';
            
            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            editBtn.style.display = 'inline-flex';
            deleteBtn.style.display = 'inline-flex';
            confirmBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // æ ‡è®°æŸ¥çœ‹æ¨¡å¼
            actions.dataset.mode = 'view';
            
            console.log('[InfoBarSettings] âœ… å·²é€€å‡ºç¼–è¾‘æ¨¡å¼');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å–æ¶ˆç¼–è¾‘å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ é™¤è‡ªå®šä¹‰å­—æ®µ
     */
    deleteCustomField(panelId, fieldKey, fieldName) {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å­—æ®µ:', panelId, fieldKey, fieldName);
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('å­—æ®µ', fieldName || fieldKey, async () => {
                // è·å–é¢æ¿é…ç½®
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];
                
                if (!panel || !panel.subItems) {
                    console.error('[InfoBarSettings] âŒ é¢æ¿æˆ–å­é¡¹ä¸å­˜åœ¨');
                    return;
                }
                
                // åˆ é™¤å­—æ®µï¼ˆé€šè¿‡keyæˆ–nameåŒ¹é…ï¼‰
                panel.subItems = panel.subItems.filter(item => 
                    item.key !== fieldKey && item.name !== fieldName
                );
                
                // ä¿å­˜é…ç½®
                await this.saveCustomPanel(panel);
                
                // åˆ·æ–°å†…å®¹é¢æ¿æ˜¾ç¤º
                const contentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
                if (contentPanel) {
                    contentPanel.innerHTML = this.createCustomPanelContent(panel);
                    this.applyThemeToCustomSubItems(contentPanel, panelId);
                }
                
                console.log('[InfoBarSettings] âœ… å­—æ®µåˆ é™¤æˆåŠŸ');
                this.showMessage('å­—æ®µåˆ é™¤æˆåŠŸ', 'success');
            });
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤å­—æ®µå¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹ï¼Œæ˜¾ç¤ºç”¨æˆ·æ·»åŠ çš„å­é¡¹
     */
    refreshBasicPanelContent(panelId) {
        try {
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥modalæ˜¯å¦å·²ç»åœ¨DOMä¸­å¹¶ä¸”å¯è§
            if (!document.body.contains(this.modal) || this.modal.style.display === 'none') {
                console.log(`[InfoBarSettings] âš ï¸ Modalæœªæ˜¾ç¤ºæˆ–ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹`);
                return;
            }

            // è·å–å¯¹åº”çš„å†…å®¹é¢æ¿
            const contentPanel = this.modal.querySelector(`[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°åŸºç¡€é¢æ¿ ${panelId} çš„å†…å®¹é¢æ¿`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä»é…ç½®ä¸­è·å–è¯¥é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼Œé¿å…äº¤å‰æ±¡æŸ“
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const savedConfig = extensionSettings['Information bar integration tool']?.[panelId];

            // ğŸ”§ ä¿®å¤ï¼šåªè·å–å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹
            const customSubItems = savedConfig?.subItems || [];

            if (customSubItems.length === 0) {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰è‡ªå®šä¹‰å­é¡¹ï¼Œè·³è¿‡åˆ·æ–°`);
                // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const existingCustomArea = contentPanel.querySelector('.custom-sub-items-area');
                if (existingCustomArea) {
                    existingCustomArea.remove();
                    console.log(`[InfoBarSettings] ğŸ§¹ å·²æ¸…ç†åŸºç¡€é¢æ¿ ${panelId} çš„æ—§è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ`);
                }
                return;
            }

            // æŸ¥æ‰¾å­é¡¹å®¹å™¨
            let subItemsContainer = contentPanel.querySelector('.sub-items');
            if (!subItemsContainer) {
                console.log(`[InfoBarSettings] âš ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰å­é¡¹å®¹å™¨`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯è‡ªå®šä¹‰å­é¡¹æ˜¯å¦çœŸçš„å±äºå½“å‰é¢æ¿
            const validCustomSubItems = customSubItems.filter(subItem => {
                // æ£€æŸ¥å­é¡¹æ˜¯å¦æœ‰æ˜ç¡®çš„é¢æ¿å½’å±æ ‡è®°
                if (subItem.panelId && subItem.panelId !== panelId) {
                    console.warn(`[InfoBarSettings] âš ï¸ å‘ç°é”™è¯¯å½’å±çš„è‡ªå®šä¹‰å­é¡¹: ${subItem.name} å±äº ${subItem.panelId}ï¼Œä½†è¢«æ·»åŠ åˆ° ${panelId}`);
                    return false;
                }
                return true;
            });

            // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹çš„HTML
            let customSubItemsHTML = '';
            validCustomSubItems.forEach((subItem, index) => {
                const checkboxId = `${panelId}-custom-${index}`;
                const fieldName = `${panelId}.${subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_')}.enabled`;

                customSubItemsHTML += `
                    <div class="sub-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox"
                                   id="${checkboxId}"
                                   name="${fieldName}"
                                   ${subItem.enabled !== false ? 'checked' : ''} />
                            <label for="${checkboxId}" class="checkbox-label">${subItem.displayName || subItem.name}</label>
                        </div>
                    </div>
                `;
            });

            if (customSubItemsHTML) {
                // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰å­é¡¹åŒºåŸŸï¼Œé¿å…é‡å¤æ·»åŠ 
                const existingCustomAreas = contentPanel.querySelectorAll('.custom-sub-items-area');
                existingCustomAreas.forEach(area => area.remove());

                // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const customArea = document.createElement('div');
                customArea.className = 'custom-sub-items-area';
                customArea.setAttribute('data-panel-id', panelId); // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿IDæ ‡è®°
                customArea.innerHTML = `
                    <div class="sub-item-section">
                        <h4 class="section-title">ğŸ”§ è‡ªå®šä¹‰å­é¡¹</h4>
                        <div class="sub-item-row">
                            ${customSubItemsHTML}
                        </div>
                    </div>
                `;

                // æ’å…¥åˆ°å­é¡¹å®¹å™¨çš„æœ«å°¾
                subItemsContainer.appendChild(customArea);

                // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                this.applyThemeToCustomSubItems(customArea, panelId);

                console.log(`[InfoBarSettings] âœ… å·²ä¸ºåŸºç¡€é¢æ¿ ${panelId} æ·»åŠ  ${validCustomSubItems.length} ä¸ªè‡ªå®šä¹‰å­é¡¹`);

                // æ›´æ–°é¢æ¿è®¡æ•°
                this.updatePanelConfigCount(panelId);
            } else {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰æœ‰æ•ˆçš„è‡ªå®šä¹‰å­é¡¹`);
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹å¤±è´¥:`, error);
        }
    }

    /**
     * ğŸ”§ é‡æ„ï¼šåˆ·æ–°æ‰€æœ‰é¢æ¿å†…å®¹ï¼ˆç»Ÿä¸€ä»customPanelsè·å–ï¼‰
     */
    refreshAllBasicPanelContent() {
        try {
            // ğŸ”§ é‡è¦ä¿®å¤ï¼šæ‰€æœ‰é¢æ¿ç°åœ¨éƒ½é€šè¿‡createCustomPanelContent()ç»Ÿä¸€æ¸²æŸ“
            // ä¸å†éœ€è¦å•ç‹¬åˆ·æ–°"è‡ªå®šä¹‰å­é¡¹"åŒºåŸŸ
            console.log('[InfoBarSettings] â„¹ï¸ æ‰€æœ‰é¢æ¿å·²é€šè¿‡ç»Ÿä¸€æ¸²æŸ“ï¼Œè·³è¿‡æ—§çš„åˆ·æ–°é€»è¾‘');
            return;
            
            // ä»¥ä¸‹ä»£ç å·²åºŸå¼ƒ
            /*
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰é¢æ¿å†…å®¹...');

            const customPanels = this.getCustomPanels();
            let refreshedCount = 0;

            Object.entries(customPanels).forEach(([panelKey, panel]) => {
                if (panel && panel.subItems && panel.subItems.length > 0) {
                    // åˆ·æ–°é¢æ¿å†…å®¹
                    this.refreshBasicPanelContent(panelKey);
                    refreshedCount++;
                }
            });

            console.log(`[InfoBarSettings] âœ… å·²åˆ·æ–° ${refreshedCount} ä¸ªåŸºç¡€é¢æ¿çš„å†…å®¹`);
            */

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æ‰€æœ‰åŸºç¡€é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹ï¼ˆå¿½ç•¥modalå¯è§æ€§æ£€æŸ¥ï¼‰
     */
    forceRefreshBasicPanelContent(panelId) {
        try {
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡å¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹');
                return;
            }

            // è·å–å¯¹åº”çš„å†…å®¹é¢æ¿
            const contentPanel = this.modal.querySelector(`[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°åŸºç¡€é¢æ¿ ${panelId} çš„å†…å®¹é¢æ¿`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä»é…ç½®ä¸­è·å–è¯¥é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼Œé¿å…äº¤å‰æ±¡æŸ“
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const savedConfig = extensionSettings['Information bar integration tool']?.[panelId];

            // ğŸ”§ ä¿®å¤ï¼šåªè·å–å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹
            const customSubItems = savedConfig?.subItems || [];

            if (customSubItems.length === 0) {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰è‡ªå®šä¹‰å­é¡¹ï¼Œè·³è¿‡å¼ºåˆ¶åˆ·æ–°`);
                return;
            }

            // æŸ¥æ‰¾å­é¡¹å®¹å™¨
            let subItemsContainer = contentPanel.querySelector('.sub-items');
            if (!subItemsContainer) {
                console.log(`[InfoBarSettings] âš ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰å­é¡¹å®¹å™¨`);
                return;
            }

            // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹çš„HTML
            let customSubItemsHTML = '';
            panelData.subItems.forEach((subItem, index) => {
                const checkboxId = `${panelId}-custom-${index}`;
                const fieldName = `${panelId}.${subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_')}.enabled`;

                customSubItemsHTML += `
                    <div class="sub-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox"
                                   id="${checkboxId}"
                                   name="${fieldName}"
                                   ${subItem.enabled !== false ? 'checked' : ''} />
                            <label for="${checkboxId}" class="checkbox-label">${subItem.displayName || subItem.name}</label>
                        </div>
                    </div>
                `;
            });

            if (customSubItemsHTML) {
                // å¦‚æœå·²ç»å­˜åœ¨è‡ªå®šä¹‰å­é¡¹åŒºåŸŸï¼Œå…ˆåˆ é™¤
                const existingCustomArea = contentPanel.querySelector('.custom-sub-items-area');
                if (existingCustomArea) {
                    existingCustomArea.remove();
                }

                // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const customArea = document.createElement('div');
                customArea.className = 'custom-sub-items-area';
                customArea.innerHTML = `
                    <div class="sub-item-section">
                        <h4 class="section-title">ğŸ”§ è‡ªå®šä¹‰å­é¡¹</h4>
                        <div class="sub-item-row">
                            ${customSubItemsHTML}
                        </div>
                    </div>
                `;

                // æ’å…¥åˆ°å­é¡¹å®¹å™¨çš„æœ«å°¾
                subItemsContainer.appendChild(customArea);

                // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                this.applyThemeToCustomSubItems(customArea, panelId);

                console.log(`[InfoBarSettings] âœ… å·²å¼ºåˆ¶ä¸ºåŸºç¡€é¢æ¿ ${panelId} æ·»åŠ  ${panelData.subItems.length} ä¸ªè‡ªå®šä¹‰å­é¡¹`);

                // æ›´æ–°é¢æ¿è®¡æ•°
                this.updatePanelConfigCount(panelId);
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ å¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹å¤±è´¥:`, error);
        }
    }

    /**
     * åˆ·æ–°å¯¼èˆªæ ï¼ˆæ·»åŠ /ç§»é™¤è‡ªå®šä¹‰é¢æ¿ï¼‰
     */
    refreshNavigation() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°å¯¼èˆªæ ');
                return;
            }

            const sidebar = this.modal.querySelector('.sidebar-nav');
            const contentArea = this.modal.querySelector('.content-area');
            if (!sidebar || !contentArea) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å¯¼èˆªæ æˆ–å†…å®¹åŒºåŸŸ');
                console.log('[InfoBarSettings] ğŸ” æ¨¡æ€æ¡†ç»“æ„:', this.modal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                if (this.modal) {
                    console.log('[InfoBarSettings] ğŸ” æŸ¥æ‰¾ .sidebar-nav:', !!this.modal.querySelector('.sidebar-nav'));
                    console.log('[InfoBarSettings] ğŸ” æŸ¥æ‰¾ .content-area:', !!this.modal.querySelector('.content-area'));
                }
                return;
            }

            // è·å–è‡ªå®šä¹‰é¢æ¿
            const customPanels = this.getCustomPanels();
            const customPanelArray = Object.values(customPanels);

            // ğŸ”§ æ›´ç¨³å¥çš„å»é‡æ¸…ç†ï¼šæŒ‰IDé›†åˆå’Œæ ‡è®°æ¸…ç†ï¼Œé¿å…é‡å¤
            const customIds = new Set(customPanelArray.map(p => p.id));

            // 1) æ¸…ç†å¸¦æ ‡è®°çš„æ•°æ®
            sidebar.querySelectorAll('.nav-item[data-custom="true"]').forEach(nav => nav.remove());
            contentArea.querySelectorAll('.content-panel[data-custom="true"]').forEach(panel => panel.remove());

            // 2) å…¼å®¹æ—§å…ƒç´ ï¼šæŒ‰IDåŒ¹é…æ¸…ç†
            sidebar.querySelectorAll('.nav-item').forEach(nav => {
                const id = nav.dataset.nav;
                if (id && customIds.has(id)) {
                    nav.remove();
                }
            });
            contentArea.querySelectorAll('.content-panel').forEach(panel => {
                const id = panel.dataset.content;
                if (id && customIds.has(id)) {
                    panel.remove();
                }
            });

            console.log('[InfoBarSettings] ğŸ“Š è·å–åˆ°çš„è‡ªå®šä¹‰é¢æ¿æ•°æ®:', customPanels);
            console.log('[InfoBarSettings] ğŸ“Š è½¬æ¢åçš„æ•°ç»„é•¿åº¦:', customPanelArray.length);

            // æ‰¾åˆ°ä¸»é¢˜è®¾ç½®å¯¼èˆªé¡¹ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥è‡ªå®šä¹‰é¢æ¿
            const themeNavItem = sidebar.querySelector('.nav-item[data-nav="theme"]');

            // ä¸ºæ¯ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå¯¼èˆªé¡¹å’Œå†…å®¹é¢æ¿
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å¯¼èˆªï¼Œæ•°ç»„é•¿åº¦:', customPanelArray.length);

            customPanelArray.forEach((panel, index) => {
                console.log(`[InfoBarSettings] ğŸ”§ åˆ›å»ºç¬¬${index + 1}ä¸ªè‡ªå®šä¹‰é¢æ¿:`, panel.id, panel.name);

                // åˆ›å»ºå¯¼èˆªé¡¹
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.dataset.nav = panel.id;
                navItem.dataset.custom = 'true';
                // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨æ–‡æœ¬å†…å®¹ï¼Œä¸ä½¿ç”¨spanåŒ…è£¹ï¼Œä¿æŒä¸åŸºç¡€é¢æ¿ä¸€è‡´
                navItem.textContent = panel.name;

                // åœ¨ä¸»é¢˜è®¾ç½®ä¹‹å‰æ’å…¥å¯¼èˆªé¡¹
                if (themeNavItem) {
                    sidebar.insertBefore(navItem, themeNavItem);
                } else {
                    sidebar.appendChild(navItem);
                }

                // åˆ›å»ºå†…å®¹é¢æ¿
                const contentPanel = document.createElement('div');
                contentPanel.className = 'content-panel';
                contentPanel.dataset.content = panel.id;
                contentPanel.dataset.custom = 'true';
                contentPanel.innerHTML = this.createCustomPanelContent(panel);

                // æ·»åŠ åˆ°å†…å®¹åŒºåŸŸ
                contentArea.appendChild(contentPanel);

                // åº”ç”¨ä¸»é¢˜å¹¶ç»‘å®šè‡ªå®šä¹‰å­é¡¹äº¤äº’ï¼ˆç¡®ä¿å¤é€‰æ¡†äº‹ä»¶ä¸æ ·å¼ï¼‰
                this.applyThemeToCustomSubItems(contentPanel, panel.id);

                console.log(`[InfoBarSettings] âœ… ç¬¬${index + 1}ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå®Œæˆ`);
            });

            // åº”ç”¨å½“å‰ä¸»é¢˜åˆ°æ–°åˆ›å»ºçš„è‡ªå®šä¹‰é¢æ¿
            this.applyCurrentThemeToCustomPanels();

            // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼åˆ°æ‰€æœ‰å¯¼èˆªé¡¹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰é¢æ¿ï¼‰
            this.applyNavItemTheme();

            console.log('[InfoBarSettings] ğŸ”„ å¯¼èˆªæ å·²åˆ·æ–°ï¼Œæ·»åŠ äº†', customPanelArray.length, 'ä¸ªè‡ªå®šä¹‰é¢æ¿');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°å¯¼èˆªæ å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
     */
    applyThemeToCustomSubItems(customArea, panelId) {
        try {
            if (!customArea) return;

            // è·å–å½“å‰ä¸»é¢˜é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const currentTheme = configs.theme?.current || 'neon-blue';

            // åº”ç”¨ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
            const subItemSection = customArea.querySelector('.sub-item-section');
            if (subItemSection) {
                subItemSection.setAttribute('data-theme', currentTheme);

                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰å¤é€‰æ¡†
                const checkboxes = customArea.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.setAttribute('data-theme', currentTheme);

                    // ğŸ”§ ä¿®å¤ï¼šä¸ºæ¯ä¸ªè‡ªå®šä¹‰å­é¡¹å¤é€‰æ¡†ç»‘å®šå˜æ›´äº‹ä»¶ï¼ŒåŒæ­¥æ•°æ®è¡¨æ ¼
                    checkbox.addEventListener('change', (e) => {
                        this.handleCustomSubItemChange(e, panelId);
                    });
                });

                // åº”ç”¨ä¸»é¢˜åˆ°æ ‡ç­¾
                const labels = customArea.querySelectorAll('.checkbox-label');
                labels.forEach(label => {
                    label.setAttribute('data-theme', currentTheme);
                });

                console.log(`[InfoBarSettings] ğŸ¨ å·²åº”ç”¨ä¸»é¢˜ ${currentTheme} åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†è‡ªå®šä¹‰å­é¡¹å¤é€‰æ¡†å˜æ›´äº‹ä»¶ï¼ŒåŒæ­¥æ•°æ®è¡¨æ ¼
     */
    handleCustomSubItemChange(event, panelId) {
        try {
            const checkbox = event.target;
            const fieldName = checkbox.name;
            const isEnabled = checkbox.checked;

            console.log(`[InfoBarSettings] ğŸ”„ åŸºç¡€é¢æ¿ ${panelId} è‡ªå®šä¹‰å­é¡¹å˜æ›´: ${fieldName} = ${isEnabled}`);

            // è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°
            if (this.eventSystem) {
                this.eventSystem.emit('panel:config:changed', {
                    panelId: panelId,
                    panelType: 'basic',
                    subItemChanged: true,
                    fieldName: fieldName,
                    enabled: isEnabled,
                    timestamp: Date.now()
                });
                console.log('[InfoBarSettings] ğŸ“‹ å·²è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°');
            }

            // ç«‹å³ä¿å­˜å˜æ›´åˆ°é…ç½®ä¸­
            this.saveCustomSubItemState(panelId, fieldName, isEnabled);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªå®šä¹‰å­é¡¹å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€åˆ°é…ç½®
     */
    saveCustomSubItemState(panelId, fieldName, isEnabled) {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // è·å–åŸºç¡€é¢æ¿é…ç½®
            const panelConfig = extensionSettings['Information bar integration tool'][panelId];
            if (panelConfig && panelConfig.subItems) {
                // æŸ¥æ‰¾å¯¹åº”çš„å­é¡¹å¹¶æ›´æ–°çŠ¶æ€
                const subItemKey = fieldName.split('.')[1]; // ä» 'panelId.key.enabled' ä¸­æå– key
                const subItem = panelConfig.subItems.find(item =>
                    item.key === subItemKey ||
                    item.name.toLowerCase().replace(/\s+/g, '_') === subItemKey
                );

                if (subItem) {
                    subItem.enabled = isEnabled;
                    console.log(`[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€: ${subItem.name} = ${isEnabled}`);

                    // ä¿å­˜åˆ° SillyTavern
                    context.saveSettingsDebounced();
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨å½“å‰ä¸»é¢˜åˆ°è‡ªå®šä¹‰é¢æ¿
     */
    applyCurrentThemeToCustomPanels() {
        try {
            // è·å–å½“å‰ä¸»é¢˜
            const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
            if (!activeThemeCard) {
                console.log('[InfoBarSettings] ğŸ¨ æœªæ‰¾åˆ°æ¿€æ´»çš„ä¸»é¢˜ï¼Œè·³è¿‡è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨');
                return;
            }

            const themeId = activeThemeCard.getAttribute('data-theme');
            const theme = this.getThemeById(themeId);
            if (!theme) {
                console.log('[InfoBarSettings] ğŸ¨ æœªæ‰¾åˆ°ä¸»é¢˜é…ç½®ï¼Œè·³è¿‡è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿å¯¼èˆªé¡¹ï¼ˆä½¿ç”¨é”®åIDæ ¼å¼ï¼‰
            const customNavItems = this.modal.querySelectorAll('.nav-item[data-nav^="Custom"]');
            const customContentPanels = this.modal.querySelectorAll('.content-panel[data-content^="Custom"]');

            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜åˆ°', customNavItems.length, 'ä¸ªè‡ªå®šä¹‰å¯¼èˆªé¡¹');

            // åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å¯¼èˆªé¡¹
            customNavItems.forEach(navItem => {
                navItem.style.backgroundColor = theme.colors.bg;
                navItem.style.color = theme.colors.text;
                navItem.style.borderColor = theme.colors.border;
            });

            // åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å†…å®¹é¢æ¿
            customContentPanels.forEach(contentPanel => {
                contentPanel.style.backgroundColor = theme.colors.bg;
                contentPanel.style.color = theme.colors.text;
                contentPanel.style.borderColor = theme.colors.border;
            });

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å†…å®¹
     */
    createCustomPanelContent(panel) {
        // è®¡ç®—å­é¡¹é…ç½®çŠ¶æ€
        const subItems = panel.subItems || [];
        const enabledSubItems = subItems.filter(item => item.enabled !== false);
        const statusText = `${enabledSubItems.length}/${subItems.length} é¡¹å·²é…ç½®`;

        return `
            <div class="content-header">
                <div class="header-with-actions">
                <h3>${panel.name}</h3>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button type="button" class="btn-icon-header" data-action="rename-panel" data-panel-id="${panel.id}" title="ç¼–è¾‘åç§°">
                            âœï¸
                        </button>
                        <button type="button" class="btn-icon-header" data-action="move-panel-up" data-panel-id="${panel.id}" title="ä¸Šç§»é¢æ¿">
                            â¬†ï¸
                        </button>
                        <button type="button" class="btn-icon-header" data-action="move-panel-down" data-panel-id="${panel.id}" title="ä¸‹ç§»é¢æ¿">
                            â¬‡ï¸
                        </button>
                        <button type="button" class="btn-icon-header btn-delete-panel-header" data-action="delete-custom-panel" data-panel-id="${panel.id}" title="åˆ é™¤æ­¤é¢æ¿">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-body">
                <!-- è‡ªå®šä¹‰é¢æ¿å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“„</div>
                            <div class="card-text">
                                <div class="card-title">${panel.name}</div>
                                <div class="card-subtitle">${panel.description}</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" name="${panel.key}.enabled" id="${panel.id}-enabled" ${panel.enabled ? 'checked' : ''} />
                                <label for="${panel.id}-enabled" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge ${panel.enabled ? 'enabled' : 'disabled'}">${panel.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</span>
                            <span class="status-count" id="${panel.id}-panel-count">${statusText}</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items-section-wrapper">
                    <div class="sub-items-section-header">
                        <h4>é…ç½®é€‰é¡¹</h4>
                        <div class="sub-items-quick-actions">
                            <button type="button" class="btn-icon-header" data-action="add-custom-field" data-panel-id="${panel.id}" title="æ·»åŠ å­—æ®µ">
                                â•
                            </button>
                            <button type="button" class="btn-icon-header" data-action="select-all-fields" data-panel-id="${panel.id}" title="å…¨é€‰">
                                â˜‘ï¸
                            </button>
                            <button type="button" class="btn-icon-header" data-action="deselect-all-fields" data-panel-id="${panel.id}" title="å…¨ä¸é€‰">
                                â˜
                            </button>
                        </div>
                    </div>
                <div class="sub-items">
                        ${this.createCustomPanelSubItems(panel.subItems || [], panel.id)}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å­é¡¹ï¼ˆä¸åŸºç¡€é¢æ¿ä¸€è‡´çš„ä¸¤åˆ—å¸ƒå±€ï¼‰
     */
    createCustomPanelSubItems(subItems, panelId) {
        if (!subItems || subItems.length === 0) {
            return `
                <div class="empty-sub-items">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">æš‚æ— å­é¡¹é…ç½®</div>
                </div>
            `;
        }

        // å°†å­é¡¹æŒ‰ä¸¤ä¸ªä¸€ç»„åˆ†ç»„ï¼Œå®ç°ä¸¤åˆ—å¸ƒå±€
        const rows = [];
        for (let i = 0; i < subItems.length; i += 2) {
            const leftItem = subItems[i];
            const rightItem = subItems[i + 1];

            const leftItemHtml = this.createSubItemHtmlWithActions(leftItem, panelId);
            const rightItemHtml = rightItem ? this.createSubItemHtmlWithActions(rightItem, panelId) : '<div class="sub-item"></div>'; // ç©ºå ä½ç¬¦

            rows.push(`
                <div class="sub-item-row">
                    ${leftItemHtml}
                    ${rightItemHtml}
                </div>
            `);
        }

        return rows.join('');
    }

    /**
     * åˆ›å»ºå•ä¸ªå­é¡¹HTMLï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤šè¡Œæ•°æ®é…ç½®ï¼‰
     */
    createSubItemHtml(subItem) {
        if (!subItem) return '<div class="sub-item"></div>';

        // ç¡®ä¿å­é¡¹æœ‰enabledå±æ€§ï¼Œé»˜è®¤ä¸ºtrue
        const isEnabled = subItem.enabled !== false;
        // ä½¿ç”¨å­é¡¹çš„nameä½œä¸ºè¡¨å•å­—æ®µåï¼Œç¡®ä¿èƒ½è¢«collectFormDataæ”¶é›†
        const fieldName = subItem.name || subItem.key || subItem.id;

        return `
            <div class="sub-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox"
                           id="${subItem.id}"
                           name="${fieldName}"
                           ${isEnabled ? 'checked' : ''} />
                    <label for="${subItem.id}" class="checkbox-label">
                        ${subItem.name}
                    </label>
                </div>
            </div>
        `;
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ›å»ºå¸¦æ“ä½œå›¾æ ‡çš„å­é¡¹HTML
     */
    createSubItemHtmlWithActions(subItem, panelId) {
        if (!subItem) return '<div class="sub-item"></div>';

        // ğŸ”§ é‡è¦ä¿®å¤ï¼šç¡®ä¿æ˜¾ç¤ºåç§°æ˜¯ä¸­æ–‡
        let displayName = subItem.name;
        
        // 1. ä¼˜å…ˆä½¿ç”¨ displayNameï¼ˆå¦‚æœå­˜åœ¨ä¸”æ˜¯ä¸­æ–‡ï¼‰
        if (subItem.displayName && !this.isEnglishName(subItem.displayName)) {
            displayName = subItem.displayName;
            console.log(`[InfoBarSettings] ğŸ”§ ä½¿ç”¨displayName: ${displayName}`);
        }
        // 2. å¦‚æœnameæ˜¯è‹±æ–‡ï¼Œå°è¯•ä»æ˜ å°„è¡¨è·å–ä¸­æ–‡å
        else if (this.isEnglishName(displayName)) {
            // ä¼˜å…ˆç”¨keyæŸ¥æ‰¾
            let chineseName = this.getChineseNameForField(panelId, subItem.key);
            
            // å¦‚æœkeyæŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•ç”¨nameæŸ¥æ‰¾
            if (!chineseName && subItem.name !== subItem.key) {
                chineseName = this.getChineseNameForField(panelId, subItem.name);
            }
            
            // å¦‚æœæ‰¾åˆ°äº†ä¸­æ–‡åï¼Œä½¿ç”¨å®ƒ
            if (chineseName) {
                displayName = chineseName;
                console.log(`[InfoBarSettings] âœ… å­—æ®µåè½¬æ¢: ${subItem.name} (key: ${subItem.key}) -> ${displayName}`);
            } else {
                console.warn(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å­—æ®µæ˜ å°„: panelId=${panelId}, name=${subItem.name}, key=${subItem.key}`);
            }
        }
        
        // ç¡®ä¿å­é¡¹æœ‰enabledå±æ€§ï¼Œé»˜è®¤ä¸ºtrue
        const isEnabled = subItem.enabled !== false;
        // ä½¿ç”¨å­é¡¹çš„nameä½œä¸ºè¡¨å•å­—æ®µåï¼Œç¡®ä¿èƒ½è¢«collectFormDataæ”¶é›†
        const fieldName = subItem.name || subItem.key || subItem.id;
        const subItemKey = subItem.key || subItem.id;

        return `
            <div class="sub-item sub-item-with-actions" data-field-key="${subItemKey}" data-panel-id="${panelId}">
                <div class="checkbox-wrapper">
                    <input type="checkbox"
                           id="${subItem.id}"
                           name="${fieldName}"
                           ${isEnabled ? 'checked' : ''} />
                    <label for="${subItem.id}" class="checkbox-label" data-original-name="${fieldName}">
                        ${displayName}
                    </label>
                    <input type="text" class="field-name-edit-input" style="display: none;" value="${displayName}" />
                </div>
                <div class="sub-item-inline-actions" data-mode="view">
                    <button type="button" class="btn-icon-micro btn-edit-field" data-action="edit-custom-field" data-panel-id="${panelId}" data-field-key="${subItemKey}" data-field-name="${fieldName}" title="ç¼–è¾‘å­—æ®µ">
                        âœï¸
                    </button>
                    <button type="button" class="btn-icon-micro btn-delete-field" data-action="delete-custom-field" data-panel-id="${panelId}" data-field-key="${subItemKey}" data-field-name="${fieldName}" title="åˆ é™¤å­—æ®µ">
                        ğŸ—‘ï¸
                    </button>
                    <button type="button" class="btn-icon-micro btn-confirm-edit" data-action="confirm-edit-field" data-panel-id="${panelId}" data-field-key="${subItemKey}" style="display: none;" title="ç¡®è®¤">
                        âœ“
                    </button>
                    <button type="button" class="btn-icon-micro btn-cancel-edit" data-action="cancel-edit-field" data-panel-id="${panelId}" data-field-key="${subItemKey}" style="display: none;" title="å–æ¶ˆ">
                        âœ•
                    </button>
                </div>
            </div>
        `;
    }



    /**
     * æ”¶é›†åŸºç¡€é¢æ¿è¡¨å•æ•°æ®ï¼ˆä¸åŒ…å«å­é¡¹ï¼‰
     */
    collectBasicPanelFormData() {
        try {
            const form = this.modal.querySelector('.panel-properties-form');
            const formData = {};

            // åŸºæœ¬ä¿¡æ¯ï¼ˆåŸºç¡€é¢æ¿çš„nameå’Œkeyä¸ä¿å­˜ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
            // formData.name = form.querySelector('#panel-name')?.value || '';  // åŸºç¡€é¢æ¿åç§°ä¸å¯ä¿®æ”¹
            // formData.key = form.querySelector('#panel-key')?.value || '';    // åŸºç¡€é¢æ¿é”®åä¸å¯ä¿®æ”¹
            formData.description = form.querySelector('#panel-description')?.value || '';
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // formData.icon = form.querySelector('#panel-icon')?.value || 'ğŸ¨';

            // é…ç½®é€‰é¡¹
            formData.required = form.querySelector('#panel-required')?.checked || false;
            formData.memoryInject = form.querySelector('#panel-memory-inject')?.checked || false;


            // æç¤ºè¯é…ç½®
            formData.prompts = {
                init: form.querySelector('#panel-prompt-init')?.value || '',
                insert: form.querySelector('#panel-prompt-insert')?.value || '',
                update: form.querySelector('#panel-prompt-update')?.value || '',
                delete: form.querySelector('#panel-prompt-delete')?.value || ''
            };

            // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ä¹Ÿéœ€è¦ä¿å­˜ç”¨æˆ·æ·»åŠ çš„å­é¡¹æ•°æ®
            formData.subItems = this.collectSubItemsData();

            console.log('[InfoBarSettings] ğŸ“Š åŸºç¡€é¢æ¿è¡¨å•æ•°æ®ï¼ˆå«å­é¡¹ï¼‰:', formData);
            return formData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†åŸºç¡€é¢æ¿è¡¨å•æ•°æ®å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ”¶é›†é¢æ¿è¡¨å•æ•°æ®
     */
    collectPanelFormData() {
        try {
            const form = this.modal.querySelector('.panel-properties-form');
            const formData = {};

            // åŸºæœ¬ä¿¡æ¯
            formData.name = form.querySelector('#panel-name')?.value || '';
            formData.key = form.querySelector('#panel-key')?.value || '';
            formData.description = form.querySelector('#panel-description')?.value || '';
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // formData.icon = form.querySelector('#panel-icon')?.value || 'ğŸ¨';

            // é…ç½®é€‰é¡¹
            formData.required = form.querySelector('#panel-required')?.checked || false;
            formData.memoryInject = form.querySelector('#panel-memory-inject')?.checked || false;


            // æç¤ºè¯é…ç½®
            formData.prompts = {
                init: form.querySelector('#panel-prompt-init')?.value || '',
                insert: form.querySelector('#panel-prompt-insert')?.value || '',
                update: form.querySelector('#panel-prompt-update')?.value || '',
                delete: form.querySelector('#panel-prompt-delete')?.value || ''
            };

            // å­é¡¹é…ç½®ï¼ˆä»å­é¡¹å®¹å™¨æ”¶é›†ï¼‰
            formData.subItems = this.collectSubItemsData();

            return formData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†é¢æ¿è¡¨å•æ•°æ®å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ”¶é›†å­é¡¹æ•°æ®ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤šè¡Œæ•°æ®é…ç½®ï¼‰
     */
    collectSubItemsData() {
        try {
            const subItems = [];

            // ğŸ”§ ä¿®å¤ï¼šè·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿IDï¼Œç¡®ä¿å­é¡¹å½’å±æ­£ç¡®
            const currentPanelId = this.currentEditingPanel?.id;
            if (!currentPanelId) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ç¡®å®šå½“å‰ç¼–è¾‘çš„é¢æ¿IDï¼Œè·³è¿‡å­é¡¹æ”¶é›†');
                return [];
            }

            const subItemElements = this.modal.querySelectorAll('.sub-item-form');

            subItemElements.forEach(element => {
                const name = element.querySelector('.sub-item-name')?.value || '';
                if (name.trim()) { // åªæœ‰åç§°ä¸ä¸ºç©ºæ‰æ·»åŠ 
                    const subItemId = element.dataset.subItemId;
                    const subItemName = name.trim();

                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è·å–è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å¯ç”¨çŠ¶æ€
                    // è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å¤é€‰æ¡†nameå°±æ˜¯å­é¡¹åç§°æœ¬èº«
                    const checkbox = this.modal.querySelector(`input[name="${subItemName}"]`);
                    const isEnabled = checkbox ? checkbox.checked : true; // å¦‚æœæ‰¾ä¸åˆ°å¤é€‰æ¡†ï¼Œé»˜è®¤å¯ç”¨

                    const subItem = {
                        id: subItemId,
                        name: subItemName,
                        key: subItemName.toLowerCase().replace(/\s+/g, '_'), // åç§°è½¬æ¢ä¸ºé”®å
                        displayName: subItemName, // ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æ˜¾ç¤ºåç§°
                        enabled: isEnabled, // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¤é€‰æ¡†çš„çœŸå®çŠ¶æ€
                        value: '', // æ·»åŠ é»˜è®¤å€¼å­—æ®µ
                        panelId: currentPanelId // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿å½’å±æ ‡è®°
                    };

                    console.log(`[InfoBarSettings] ğŸ“Š æ”¶é›†å­é¡¹: ${subItemName} enabled=${isEnabled} panelId=${currentPanelId}`);
                    subItems.push(subItem);
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šåªä»å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹åŒºåŸŸæ”¶é›†å­é¡¹è®¾ç½®
            const currentPanelContent = this.modal.querySelector(`[data-content="${currentPanelId}"]`);
            if (currentPanelContent) {
                const customSubItemsArea = currentPanelContent.querySelector('.custom-sub-items-area');
                if (customSubItemsArea) {
                    const existingSubItems = customSubItemsArea.querySelectorAll('.sub-item');
                    existingSubItems.forEach(subItemElement => {
                        const checkbox = subItemElement.querySelector('input[type="checkbox"]');

                        if (checkbox) {
                            const fieldName = checkbox.getAttribute('name');
                            const isEnabled = checkbox.checked;

                            // ğŸ”§ ä¿®å¤ï¼šæå–å­é¡¹åç§°ï¼Œå»é™¤é¢æ¿å‰ç¼€
                            const subItemName = fieldName.replace(`${currentPanelId}.`, '').replace('.enabled', '');

                            // æŸ¥æ‰¾æ˜¯å¦å·²åœ¨subItemsä¸­å­˜åœ¨
                            let existingSubItem = subItems.find(item =>
                                item.name === subItemName || item.key === subItemName
                            );

                            if (existingSubItem) {
                                // æ›´æ–°å·²å­˜åœ¨çš„å­é¡¹
                                existingSubItem.enabled = isEnabled;
                            } else {
                                // ğŸ”§ ä¿®å¤ï¼šåªæ·»åŠ å±äºå½“å‰é¢æ¿çš„å­é¡¹
                                if (fieldName.startsWith(`${currentPanelId}.`)) {
                                    const subItem = {
                                        id: `existing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                        name: subItemName,
                                        key: subItemName.toLowerCase().replace(/\s+/g, '_'),
                                        displayName: subItemName,
                                        enabled: isEnabled,
                                        value: '',
                                        panelId: currentPanelId // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿å½’å±æ ‡è®°
                                    };
                                    subItems.push(subItem);
                                    console.log(`[InfoBarSettings] ğŸ“Š æ”¶é›†ç°æœ‰å­é¡¹é…ç½®: ${subItemName} enabled=${isEnabled} panelId=${currentPanelId}`);
                                }
                            }
                        }
                    });
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„å­é¡¹æ•°æ®è¯¦æƒ…:', subItems);
            return subItems;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å­é¡¹æ•°æ®å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * è·å–å­é¡¹é»˜è®¤å€¼
     */
    getSubItemDefaultValue(element) {
        const type = element.querySelector('.sub-item-type')?.value;
        const defaultInput = element.querySelector('.sub-item-default');

        switch (type) {
            case 'checkbox':
                return defaultInput?.checked || false;
            case 'number':
                return parseFloat(defaultInput?.value) || 0;
            default:
                return defaultInput?.value || '';
        }
    }
    /**
     * è·å–å­é¡¹é€‰é¡¹ï¼ˆç”¨äºselectç±»å‹ï¼‰
     */
    getSubItemOptions(element) {
        try {
            const optionsContainer = element.querySelector('.sub-item-options');
            const optionInputs = optionsContainer?.querySelectorAll('.option-input');
            const options = [];

            optionInputs?.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    options.push(value);
                }
            });

            return options;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å­é¡¹é€‰é¡¹å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * åŠ è½½é¢æ¿æ•°æ®åˆ°è¡¨å•
     */
    loadPanelDataToForm(panelId, panelType) {
        try {
            // ğŸ”§ æ–°æ¶æ„ï¼šç»Ÿä¸€ä»customPanelsè·å–æ‰€æœ‰é¢æ¿æ•°æ®
            const customPanels = this.getCustomPanels();
            let panelData = customPanels[panelId];

            if (!panelData) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°é¢æ¿æ•°æ®:', panelId);
                return;
            }

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            this.fillBasicPanelInfo(panelData, panelType);

            // å¡«å……æç¤ºè¯é…ç½®
            this.fillPanelPrompts(panelData, panelType);

            // å¡«å……å­é¡¹é…ç½®
            this.fillSubItems(panelData.subItems || []);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é¢æ¿æ•°æ®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ—‘ï¸ å·²åºŸå¼ƒï¼šè·å–åŸºç¡€é¢æ¿æ•°æ®ï¼ˆç°åœ¨ç»Ÿä¸€ä»customPanelsè·å–ï¼‰
     */
    getBasicPanelData(panelId) {
        // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿éƒ½ä»customPanelsè·å–ï¼Œä¸å†ä½¿ç”¨ç¡¬ç¼–ç 
        console.warn('[InfoBarSettings] âš ï¸ getBasicPanelDataå·²åºŸå¼ƒï¼Œè¯·ç›´æ¥ä»customPanelsè·å–');
        
        // å°è¯•ä»customPanelsè·å–
        try {
            const customPanels = this.getCustomPanels();
            return customPanels[panelId] || null;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–é¢æ¿æ•°æ®å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * å¡«å……åŸºæœ¬é¢æ¿ä¿¡æ¯
     */
    fillBasicPanelInfo(panelData, panelType) {
        const form = this.modal.querySelector('.panel-properties-form');

        form.querySelector('#panel-name').value = panelData.name || '';
        form.querySelector('#panel-key').value = panelData.key || '';
        form.querySelector('#panel-description').value = panelData.description || '';
        // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
        // form.querySelector('#panel-icon').value = panelData.icon || 'ğŸ¨';

        form.querySelector('#panel-required').checked = !!panelData.required;
        form.querySelector('#panel-memory-inject').checked = !!panelData.memoryInject;

        // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿å®Œå…¨ä¸€æ ·ï¼Œå…¨éƒ¨å¯ç¼–è¾‘ï¼Œæ— ä»»ä½•é™åˆ¶
        form.querySelector('#panel-name').readOnly = false;
        form.querySelector('#panel-key').readOnly = false;
        form.querySelector('#panel-description').readOnly = false;
        form.querySelector('#panel-required').disabled = false;
        form.querySelector('#panel-memory-inject').disabled = false;

        // ç§»é™¤åªè¯»æ ·å¼ç±»
        form.querySelector('#panel-name').classList.remove('readonly-input');
        form.querySelector('#panel-key').classList.remove('readonly-input');
        form.querySelector('#panel-description').classList.remove('readonly-input');
    }

    /**
     * å¡«å……æç¤ºè¯é…ç½®
     */
    fillPanelPrompts(panelData, panelType) {
        const form = this.modal.querySelector('.panel-properties-form');
        const prompts = panelData.prompts || {};

        const initInput = form.querySelector('#panel-prompt-init');
        const insertInput = form.querySelector('#panel-prompt-insert');
        const updateInput = form.querySelector('#panel-prompt-update');
        const deleteInput = form.querySelector('#panel-prompt-delete');

        if (initInput) initInput.value = prompts.init || '';
        if (insertInput) insertInput.value = prompts.insert || '';
        if (updateInput) updateInput.value = prompts.update || '';
        if (deleteInput) deleteInput.value = prompts.delete || '';

        // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿å®Œå…¨ä¸€æ ·ï¼Œæç¤ºè¯å…¨éƒ¨å¯ç¼–è¾‘
        if (initInput) {
            initInput.readOnly = false;
            initInput.classList.remove('readonly-input');
        }
        if (insertInput) {
            insertInput.readOnly = false;
            insertInput.classList.remove('readonly-input');
        }
        if (updateInput) {
            updateInput.readOnly = false;
            updateInput.classList.remove('readonly-input');
        }
        if (deleteInput) {
            deleteInput.readOnly = false;
            deleteInput.classList.remove('readonly-input');
        }
    }

    /**
     * å¡«å……å­é¡¹é…ç½®
     */
    fillSubItems(subItems) {
        try {
            const container = this.modal.querySelector('.sub-items-container');
            const emptyMessage = container.querySelector('.empty-sub-items');

            // ğŸ”§ ä¿®å¤ï¼šæ— è®ºæ˜¯å¦æœ‰å­é¡¹ï¼Œéƒ½å…ˆæ¸…ç©ºç°æœ‰å­é¡¹ï¼Œé˜²æ­¢UIæ±¡æŸ“
            container.querySelectorAll('.sub-item-form').forEach(item => item.remove());

            if (subItems.length === 0) {
                emptyMessage.style.display = 'block';
                console.log('[InfoBarSettings] ğŸ§¹ å­é¡¹å®¹å™¨å·²æ¸…ç†ï¼Œæ˜¾ç¤ºç©ºæ¶ˆæ¯');
                return;
            }

            emptyMessage.style.display = 'none';

            // æ·»åŠ å­é¡¹
            subItems.forEach(subItem => {
                this.addSubItemToContainer(subItem);
            });

            console.log(`[InfoBarSettings] ğŸ“Š å·²å¡«å…… ${subItems.length} ä¸ªå­é¡¹åˆ°å®¹å™¨`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¡«å……å­é¡¹é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹åˆ°å®¹å™¨
     */
    addSubItemToContainer(subItem) {
        try {
            const container = this.modal.querySelector('.sub-items-container');
            const emptyMessage = container.querySelector('.empty-sub-items');

            // éšè—ç©ºæ¶ˆæ¯
            emptyMessage.style.display = 'none';

            // åˆ›å»ºå­é¡¹è¡¨å•
            const subItemForm = this.createSubItemForm(subItem);
            container.appendChild(subItemForm);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹åˆ°å®¹å™¨å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºå­é¡¹è¡¨å•ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    createSubItemForm(subItem) {
        const formElement = document.createElement('div');
        formElement.className = 'sub-item-form simplified';
        formElement.dataset.subItemId = subItem.id;

        formElement.innerHTML = `
            <div class="sub-item-simple">
                <div class="sub-item-input-group">
                    <input type="text" class="sub-item-name" value="${subItem.name || ''}" placeholder="å­é¡¹åç§°" />
                </div>
                <div class="sub-item-actions-inline">
                    <button type="button" class="btn-icon-tiny" data-action="edit-sub-item" title="ä¿®æ”¹">
                        âœï¸
                    </button>
                    <button type="button" class="btn-icon-tiny btn-remove-sub-item" data-action="remove-sub-item" title="åˆ é™¤">
                        ğŸ—‘ï¸
                </button>
                </div>
            </div>
        `;

        return formElement;
    }

    /**
     * åˆ›å»ºå­é¡¹é»˜è®¤å€¼è¾“å…¥
     */
    createSubItemDefaultInput(subItem) {
        switch (subItem.type) {
            case 'checkbox':
                return `<input type="checkbox" class="sub-item-default" ${subItem.defaultValue ? 'checked' : ''} />`;
            case 'number':
                return `<input type="number" class="sub-item-default" value="${subItem.defaultValue || 0}" />`;
            case 'textarea':
                return `<textarea class="sub-item-default" rows="3">${subItem.defaultValue || ''}</textarea>`;
            default:
                return `<input type="text" class="sub-item-default" value="${subItem.defaultValue || ''}" />`;
        }
    }

    /**
     * åˆ›å»ºå­é¡¹é€‰é¡¹åŒºåŸŸï¼ˆç”¨äºselectç±»å‹ï¼‰
     */
    createSubItemOptionsSection(options) {
        const optionsHtml = options.map((option, index) => `
            <div class="option-item">
                <input type="text" class="option-input" value="${option}" placeholder="é€‰é¡¹${index + 1}" />
                <button type="button" class="btn-icon btn-remove-option">ğŸ—‘ï¸</button>
            </div>
        `).join('');

        return `
            <div class="form-group sub-item-options-section">
                <label>é€‰é¡¹é…ç½®</label>
                <div class="sub-item-options">
                    ${optionsHtml}
                </div>
                <button type="button" class="btn-small btn-add-option">æ·»åŠ é€‰é¡¹</button>
            </div>
        `;
    }

    /**
     * æ¸…ç©ºé¢æ¿å±æ€§
     */
    clearPanelProperties() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç©ºé¢æ¿å±æ€§');
                return;
            }

            const noSelectionMessage = this.modal.querySelector('.no-selection-message');
            const propertiesForm = this.modal.querySelector('.panel-properties-form');
            const saveBtn = this.modal.querySelector('[data-action="save-panel-properties"]');
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œç¡®ä¿é€‰æ‹©å±æ€§åŒºåŸŸçš„åˆ é™¤æŒ‰é’®
            const deleteBtn = this.modal.querySelector('.properties-actions [data-action="delete-panel"]');

            // æ˜¾ç¤ºæ— é€‰æ‹©æ¶ˆæ¯ï¼Œéšè—å±æ€§è¡¨å•
            if (noSelectionMessage) noSelectionMessage.style.display = 'block';
            if (propertiesForm) propertiesForm.style.display = 'none';

            // ç¦ç”¨æŒ‰é’®
            if (saveBtn) saveBtn.disabled = true;
            if (deleteBtn) deleteBtn.disabled = true;

            // æ¸…ç©ºå½“å‰ç¼–è¾‘é¢æ¿ä¿¡æ¯
            this.currentEditingPanel = null;

            // æ¸…é™¤é¢æ¿åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            this.modal.querySelectorAll('.panel-list-item').forEach(item => {
                item.classList.remove('selected');
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢æ¿å±æ€§å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢å†…å®¹é¢æ¿
     */
    switchToContent(contentType) {
        try {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            this.modal.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            this.modal.querySelector(`[data-nav="${contentType}"]`).classList.add('active');

            // ğŸ”§ ä¿®å¤ï¼šé‡æ–°åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
            this.applyNavItemTheme();

            // æ›´æ–°å†…å®¹é¢æ¿
            this.modal.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            this.modal.querySelector(`[data-content="${contentType}"]`).classList.add('active');

            // ğŸ”§ æ–°å¢ï¼šæ€»ç»“é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'summary') {
                this.initSummaryPanelContent();
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å¢å¼ºé¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'memoryEnhancement') {
                this.initMemoryEnhancementPanelContent();
            }

            // ğŸ­ æ–°å¢ï¼šNPCç®¡ç†é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'npc-management') {
                this.initNPCManagementPanelContent();
            }

            // ğŸ“– æ–°å¢ï¼šå‰§æƒ…ä¼˜åŒ–é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'plot-optimization') {
                this.initPlotOptimizationPanelContent();
            }

            // ğŸ“Š æ–°å¢ï¼šæ•°æ®è¡¨æ ¼é…ç½®é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'data-table-config') {
                this.initDataTableConfigPanelContent();
            }

            // ğŸ”Œ æ–°å¢ï¼šAPIé…ç½®é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'api') {
                this.initAPIPanelContent();
            }

            // ğŸ”® æ–°å¢ï¼šå‘é‡åŠŸèƒ½é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'vectorFunction') {
                this.initVectorFunctionPanelContent();
            }

            console.log(`[InfoBarSettings] ğŸ“‘ åˆ‡æ¢åˆ°å†…å®¹: ${contentType}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹
     */
    initSummaryPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹...');

            // è·å–æ€»ç»“ç®¡ç†å™¨å®ä¾‹
            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool || !infoBarTool.modules || !infoBarTool.modules.summaryManager) {
                console.error('[InfoBarSettings] âŒ æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                this.showMessage('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            const summaryManager = infoBarTool.modules.summaryManager;

            // åŠ è½½å½“å‰è®¾ç½®
            this.loadSummarySettings();

            // åŠ è½½æ€»ç»“å†å²
            this.loadSummaryHistory();

            // ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶
            this.bindSummaryPanelEvents();

            // ğŸ†• ç»‘å®šå‘é‡åŒ–æ€»ç»“äº‹ä»¶ç›‘å¬å™¨
            this.bindVectorizedSummaryEvents();

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹å¤±è´¥:', error);
            this.showMessage('åˆå§‹åŒ–æ€»ç»“é¢æ¿å¤±è´¥', 'error');
        }
    }

    /**
     * ğŸ†• ç»‘å®šå‘é‡åŒ–æ€»ç»“äº‹ä»¶ç›‘å¬å™¨
     */
    bindVectorizedSummaryEvents() {
        try {
            console.log('[InfoBarSettings] ğŸ”— ç»‘å®šå‘é‡åŒ–æ€»ç»“äº‹ä»¶ç›‘å¬å™¨...');

            const infoBarTool = window.SillyTavernInfobar;
            const eventSystem = infoBarTool?.eventSource || infoBarTool?.modules?.eventSystem;

            if (!eventSystem) {
                console.warn('[InfoBarSettings] âš ï¸ äº‹ä»¶ç³»ç»Ÿæœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šå‘é‡åŒ–æ€»ç»“äº‹ä»¶');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šç›‘å¬AIè®°å¿†æ€»ç»“åˆ›å»ºäº‹ä»¶ï¼Œç«‹å³åˆ·æ–°UI
            eventSystem.on('ai-summary:created', (data) => {
                console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°AIè®°å¿†æ€»ç»“åˆ›å»ºäº‹ä»¶:', data);

                // ğŸ”§ ä¿®å¤ï¼šæ— è®ºè®¾ç½®é¢æ¿æ˜¯å¦æ‰“å¼€ï¼Œéƒ½åˆ·æ–°æ•°æ®ï¼ˆç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
                // åªæ˜¯åœ¨é¢æ¿æ‰“å¼€æ—¶æ‰åˆ·æ–°UIæ˜¾ç¤º
                if (this.modal && this.visible) {
                    const vectorizedSettings = this.modal.querySelector('.vectorized-summary-settings');
                    if (vectorizedSettings && vectorizedSettings.style.display !== 'none') {
                        console.log('[InfoBarSettings] ğŸ”„ ç«‹å³åˆ·æ–°AIè®°å¿†æ€»ç»“åˆ—è¡¨...');
                        // ä½¿ç”¨setTimeoutç¡®ä¿æ•°æ®å·²ç»ä¿å­˜
                        setTimeout(() => {
                            this.loadAIMemorySummaryList();
                        }, 100);
                    }
                }
            });

            // ğŸ”§ æ–°å¢ï¼šç›‘å¬å‘é‡åŒ–æ€»ç»“å¾…å¤„ç†åˆ—è¡¨æ›´æ–°äº‹ä»¶
            eventSystem.on('vectorized-summary:pending-updated', (data) => {
                console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°å‘é‡åŒ–æ€»ç»“å¾…å¤„ç†åˆ—è¡¨æ›´æ–°äº‹ä»¶:', data);

                if (this.modal && this.visible) {
                    const vectorizedSettings = this.modal.querySelector('.vectorized-summary-settings');
                    if (vectorizedSettings && vectorizedSettings.style.display !== 'none') {
                        console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°AIè®°å¿†æ€»ç»“åˆ—è¡¨ï¼ˆå¾…å¤„ç†åˆ—è¡¨æ›´æ–°ï¼‰...');
                        setTimeout(() => {
                            this.loadAIMemorySummaryList();
                        }, 100);
                    }
                }
            });

            // ğŸ”§ æ–°å¢ï¼šç›‘å¬å‘é‡åŒ–æ€»ç»“å®Œæˆäº‹ä»¶
            eventSystem.on('vectorized-summary:completed', (data) => {
                console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°å‘é‡åŒ–æ€»ç»“å®Œæˆäº‹ä»¶:', data);

                if (this.modal && this.visible) {
                    const vectorizedSettings = this.modal.querySelector('.vectorized-summary-settings');
                    if (vectorizedSettings && vectorizedSettings.style.display !== 'none') {
                        console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°å‘é‡åŒ–æ€»ç»“è®°å½•åˆ—è¡¨...');
                        setTimeout(() => {
                            this.loadAIMemorySummaryList();
                            this.loadVectorizedSummaryList();
                        }, 100);
                    }
                }
            });

            console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ€»ç»“äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šå‘é‡åŒ–æ€»ç»“äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†æ“ä½œæŒ‰é’®
     */
    handleAction(action, event = null) {
        try {
            switch (action) {
                case 'close':
                    this.hide();
                    break;
                case 'save':
                    this.saveSettings();
                    break;
                case 'clear-cache':
                    this.clearAllCaches();
                    break;
                case 'initialize-plugin':
                    this.initializePlugin();
                    break;
                case 'clear-panel-data':
                    this.clearPanelData();
                    break;
                case 'export':
                    this.exportSettings();
                    break;
                case 'export-custom':
                    this.exportCustomSettings();
                    break;
                case 'import':
                    this.importSettings();
                    break;
                case 'open-data-cleanup':
                    this.openDataCleanupTool();
                    break;
                case 'open-error-log':
                    this.openErrorLogModal();
                    break;
                case 'open-project-link':
                    this.openProjectLink();
                    break;
                case 'save-profile':
                    this.saveSettingsProfile();
                    break;
                case 'load-profile':
                    this.loadSettingsProfile();
                    break;
                case 'delete-profile':
                    this.deleteSettingsProfile();
                    break;
                case 'export-data':
                    console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å‡ºæ•°æ®...');
                    this.exportData().catch(error => {
                        console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                        this.showMessage('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
                    });
                    break;
                case 'import-data':
                    console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ•°æ®...');
                    this.importData().catch(error => {
                        console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                        this.showMessage('å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                    });
                    break;
                case 'open-variable-manager':
                    console.log('[InfoBarSettings] ğŸ”§ æ‰“å¼€å˜é‡ç®¡ç†å™¨...');
                    this.openVariableManager();
                    break;
                case 'open-status-bar-editor':
                    console.log('[InfoBarSettings] ğŸ¨ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨...');
                    this.openStatusBarEditor();
                    break;

                case 'show-data-info':
                    console.log('[InfoBarSettings] ğŸ“Š æ˜¾ç¤ºæ•°æ®ä¿¡æ¯...');
                    this.showDataInfoPanel();
                    break;
                case 'clear-memory-database':
                    console.log('[InfoBarSettings] ğŸ§¹ æ¸…ç©ºAIè®°å¿†æ•°æ®åº“...');
                    this.clearMemoryDatabaseUI();
                    break;

                // ğŸ†• é¢„è®¾ç®¡ç†æ“ä½œ
                case 'export-preset':
                    console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œå¯¼å‡ºé¢„è®¾...');
                    this.exportPreset();
                    break;
                case 'import-preset':
                    console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œå¯¼å…¥é¢„è®¾...');
                    this.importPreset();
                    break;
                case 'load-preset-panels':
                    console.log('[InfoBarSettings] ğŸš€ æ‰§è¡ŒåŠ è½½é¢„è®¾é¢æ¿...');
                    this.loadPresetPanels();
                    break;
                case 'load-preset-rules':
                    console.log('[InfoBarSettings] ğŸš€ æ‰§è¡ŒåŠ è½½é¢„è®¾è§„åˆ™...');
                    this.loadPresetRules();
                    break;
                case 'switch-preset':
                    const presetId = event?.target?.closest('[data-action]')?.dataset?.presetId;
                    if (presetId) {
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œåˆ‡æ¢é¢„è®¾:', presetId);
                        this.switchPreset(presetId);
                    }
                    break;
                case 'delete-preset':
                    const deletePresetId = event?.target?.closest('[data-action]')?.dataset?.presetId;
                    if (deletePresetId) {
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œåˆ é™¤é¢„è®¾:', deletePresetId);
                        this.deletePreset(deletePresetId);
                    }
                    break;

                default:
                    console.log(`[InfoBarSettings] ğŸ”˜ å¤„ç†æ“ä½œ: ${action}`);
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ¸…ç©ºAIè®°å¿†æ•°æ®åº“ï¼ˆUIæ–¹æ³•ï¼‰
     */
    async clearMemoryDatabaseUI() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ å‡†å¤‡æ¸…ç©ºAIè®°å¿†æ•°æ®åº“...');

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const confirmed = confirm(
                'ç¡®å®šè¦æ¸…ç©ºAIè®°å¿†æ•°æ®åº“å—ï¼Ÿ\n\n' +
                'æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è®°å¿†æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\n' +
                'â€¢ æ„ŸçŸ¥è®°å¿†ï¼ˆæœ€æ–°è®°å¿†ï¼‰\n' +
                'â€¢ çŸ­æœŸè®°å¿†ï¼ˆè¿‘æœŸè®°å¿†ï¼‰\n' +
                'â€¢ é•¿æœŸè®°å¿†ï¼ˆé‡è¦è®°å¿†ï¼‰\n' +
                'â€¢ æ·±åº¦å½’æ¡£ï¼ˆå†å²è®°å¿†ï¼‰\n\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ¸…ç©ºåAIå°†ä¸å†è®°å¾—ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚'
            );

            if (!confirmed) {
                console.log('[InfoBarSettings] ğŸš« ç”¨æˆ·å–æ¶ˆæ¸…ç©ºæ“ä½œ');
                return;
            }

            // è·å–AIè®°å¿†æ³¨å…¥å™¨æ¨¡å—
            const aiMemoryInjector = window.SillyTavernInfobar?.modules?.aiMemoryDatabaseInjector;

            if (!aiMemoryInjector) {
                console.error('[InfoBarSettings] âŒ AIè®°å¿†æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨');
                this.showNotification('âŒ AIè®°å¿†æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨', 'error');
                return;
            }

            // æ‰§è¡Œæ¸…ç©ºæ“ä½œ
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ¸…ç©ºAIè®°å¿†æ•°æ®åº“...');
            const success = aiMemoryInjector.clearMemoryDatabase();

            if (success) {
                console.log('[InfoBarSettings] âœ… AIè®°å¿†æ•°æ®åº“å·²æ¸…ç©º');
                this.showNotification('âœ… AIè®°å¿†æ•°æ®åº“å·²æˆåŠŸæ¸…ç©º', 'success');

                // ğŸ”§ åˆ·æ–°è®°å¿†å¢å¼ºé¢æ¿çš„çŠ¶æ€æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (this.visible && this.modal) {
                    const refreshBtn = this.modal.querySelector('#refresh-memory-status');
                    if (refreshBtn) {
                        console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º...');
                        this.refreshMemoryStatus();
                    }
                }
            } else {
                console.error('[InfoBarSettings] âŒ æ¸…ç©ºAIè®°å¿†æ•°æ®åº“å¤±è´¥');
                this.showNotification('âŒ æ¸…ç©ºAIè®°å¿†æ•°æ®åº“å¤±è´¥', 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºAIè®°å¿†æ•°æ®åº“å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†å¤é€‰æ¡†å˜æ›´
     */
    handleCheckboxChange(e) {
        try {
            const name = e.target.name;
            const checked = e.target.checked;

            console.log(`[InfoBarSettings] â˜‘ï¸ å¤é€‰æ¡†å˜æ›´: ${name} = ${checked}`);

            // ğŸ†• ç‰¹æ®Šå¤„ç†"å¯ç”¨æ•°æ®è¡¨æ ¼"å¤é€‰æ¡† - å®æ—¶åˆ›å»º/åˆ é™¤èœå•æŒ‰é’®å¹¶æ˜¾ç¤º/éšè—APIæ¨¡å¼é€‰æ‹©
            if (name === 'basic.tableRecords.enabled') {
                this.handleTableRecordsToggle(checked);

                // æ˜¾ç¤º/éšè—APIæ¨¡å¼é€‰æ‹©åŒºåŸŸ
                const apiModeSelection = this.modal.querySelector('#api-mode-selection');
                if (apiModeSelection) {
                    apiModeSelection.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] ğŸ“Š APIæ¨¡å¼é€‰æ‹©åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);

                    // å¦‚æœæ˜¾ç¤ºï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                    if (checked) {
                        this.restoreAPIModeButtonState();
                    }
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šå¤„ç†è‡ªå®šä¹‰é¢æ¿å¯ç”¨/ç¦ç”¨çŠ¶æ€
            if (name && name.endsWith('.enabled')) {
                const panelId = name.replace('.enabled', '');

                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰é¢æ¿
                const customPanels = this.getCustomPanels();
                if (customPanels[panelId]) {
                    console.log(`[InfoBarSettings] ğŸ”§ æ›´æ–°è‡ªå®šä¹‰é¢æ¿çŠ¶æ€: ${panelId}.enabled = ${checked}`);
                    customPanels[panelId].enabled = checked;
                    customPanels[panelId].updatedAt = Date.now();

                    // ç«‹å³ä¿å­˜åˆ°é…ç½®
                    this.saveCustomPanel(customPanels[panelId]);
                    console.log(`[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿ ${panelId} çŠ¶æ€å·²ä¿å­˜: ${checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®æ›´æ–°çŠ¶æ€å¾½ç« ï¼ˆä½¿ç”¨å½“å‰é¢æ¿çš„çŠ¶æ€å¾½ç« ï¼‰
                    const activeContentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
                    if (activeContentPanel) {
                        const statusBadge = activeContentPanel.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                            statusBadge.className = `status-badge ${checked ? 'enabled' : 'disabled'}`;
                            console.log(`[InfoBarSettings] ğŸ¨ æ›´æ–°çŠ¶æ€å¾½ç« : ${panelId} -> ${checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}`);
                        } else {
                            console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°çŠ¶æ€å¾½ç« : ${panelId}`);
                        }

                        // å­é¡¹åŒºåŸŸå§‹ç»ˆä¿æŒå¯è§ï¼Œä¸æ ¹æ®å¯ç”¨çŠ¶æ€éšè—
                        console.log(`[InfoBarSettings] ğŸ“‹ å­é¡¹åŒºåŸŸä¿æŒå¯è§ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯é…ç½®é¡¹`);
                    } else {
                        console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å½“å‰é¢æ¿å®¹å™¨: ${panelId}`);
                    }
                }
            }

            // ç‰¹æ®Šå¤„ç†APIé…ç½®å¼€å…³
            if (name === 'apiConfig.enabled') {
                const apiConfigContent = this.modal.querySelector('.api-config-content');
                if (apiConfigContent) {
                    apiConfigContent.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] ğŸ”Œ APIé…ç½®åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                }
            }

            // ğŸ†• ç‰¹æ®Šå¤„ç†ç ´ç”²æç¤ºè¯å¼€å…³
            if (name === 'apiConfig.enableArmorBreaking') {
                const armorBreakingSection = this.modal.querySelector('.armor-breaking-config-section');
                if (armorBreakingSection) {
                    armorBreakingSection.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] ğŸ›¡ï¸ ç ´ç”²æç¤ºè¯é…ç½®åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                }
            }

            // ğŸ†• ç‰¹æ®Šå¤„ç†å»¶è¿Ÿç”Ÿæˆå¼€å…³
            if (name === 'apiConfig.delayedGeneration') {
                const delayedGenerationConfig = this.modal.querySelector('.delayed-generation-config');
                if (delayedGenerationConfig) {
                    delayedGenerationConfig.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] â±ï¸ å»¶è¿Ÿç”Ÿæˆé…ç½®åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                }
            }

            // å¦‚æœæ˜¯ä¸»å¼€å…³ï¼Œæ§åˆ¶ç›¸å…³å­é¡¹
            if (name && name.includes('.enabled')) {
                const baseName = name.replace('.enabled', '');
                const relatedInputs = this.modal.querySelectorAll(`[name^="${baseName}."]`);
                relatedInputs.forEach(input => {
                    if (input !== e.target) {
                        input.disabled = !checked;
                    }
                });
            }

            // æ›´æ–°å¯¹åº”é¢æ¿çš„é…ç½®è®¡æ•°
            this.updatePanelCounts(e.target);

            // ğŸ”§ ä¿®å¤ï¼šä¸å†è‡ªåŠ¨ä¿å­˜ï¼Œåªåœ¨ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ—¶ä¿å­˜
            // è¿™æ ·å¯ä»¥é¿å…ä¸SillyTavernçš„ä¿å­˜æœºåˆ¶å†²çª

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å¤é€‰æ¡†å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ¢å¤APIæ¨¡å¼æŒ‰é’®çŠ¶æ€
     */
    restoreAPIModeButtonState() {
        try {
            const context = SillyTavern.getContext();
            const apiConfig = context.extensionSettings['Information bar integration tool']?.apiConfig;
            const currentMode = apiConfig?.enabled === true ? 'custom' : 'main';

            const buttons = this.modal.querySelectorAll('.api-mode-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.mode === currentMode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                }
            });

            // æ¢å¤æè¿°æ–‡æœ¬æ˜¾ç¤ºçŠ¶æ€
            const mainDesc = this.modal.querySelector('.main-mode-desc');
            const customDesc = this.modal.querySelector('.custom-mode-desc');
            if (mainDesc && customDesc) {
                mainDesc.style.display = currentMode === 'main' ? 'block' : 'none';
                customDesc.style.display = currentMode === 'custom' ? 'block' : 'none';
            }

            console.log('[InfoBarSettings] ğŸ”„ å·²æ¢å¤APIæ¨¡å¼æŒ‰é’®çŠ¶æ€:', currentMode);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤APIæ¨¡å¼æŒ‰é’®çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†APIæ¨¡å¼åˆ‡æ¢
     */
    async handleAPIModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢APIæ¨¡å¼:', mode);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = this.modal.querySelectorAll('.api-mode-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                }
            });

            // æ›´æ–°æè¿°æ–‡æœ¬
            const mainDesc = this.modal.querySelector('.main-mode-desc');
            const customDesc = this.modal.querySelector('.custom-mode-desc');
            if (mainDesc && customDesc) {
                mainDesc.style.display = mode === 'main' ? 'block' : 'none';
                customDesc.style.display = mode === 'custom' ? 'block' : 'none';
            }

            // æ›´æ–°é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            if (!extensionSettings['Information bar integration tool'].apiConfig) {
                extensionSettings['Information bar integration tool'].apiConfig = {};
            }
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿basicé…ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool'].basic) {
                extensionSettings['Information bar integration tool'].basic = {};
            }

            const enabled = (mode === 'custom');
            extensionSettings['Information bar integration tool'].apiConfig.enabled = enabled;
            
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¿å­˜apiGenerationModeåˆ°basicé…ç½®ä¸­
            extensionSettings['Information bar integration tool'].basic.apiGenerationMode = mode;
            console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜APIç”Ÿæˆæ¨¡å¼åˆ°é…ç½®:', mode);

            // è°ƒç”¨APIå¯ç”¨çŠ¶æ€å˜æ›´å¤„ç†
            await this.handleAPIEnabledChange(enabled);

            // ä¿å­˜é…ç½®
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] âœ… APIæ¨¡å¼å·²åˆ‡æ¢:', mode, '(enabled:', enabled, ')');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢APIæ¨¡å¼å¤±è´¥:', error);
            this.showNotification('âŒ åˆ‡æ¢APIæ¨¡å¼å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†æ•°æ®è¡¨æ ¼APIæ¨¡å¼åˆ‡æ¢
     */
    async handleDataTableAPIModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ“Š åˆ‡æ¢æ•°æ®è¡¨æ ¼APIæ¨¡å¼:', mode);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = this.modal.querySelectorAll('.data-table-api-mode-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                    btn.style.fontWeight = '500';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                    btn.style.fontWeight = 'normal';
                    btn.classList.remove('active');
                }
            });

            // æ›´æ–°æè¿°æ–‡æœ¬
            const mainDesc = this.modal.querySelector('.main-mode-desc');
            const customDesc = this.modal.querySelector('.custom-mode-desc');
            if (mainDesc && customDesc) {
                mainDesc.style.display = mode === 'main' ? 'block' : 'none';
                customDesc.style.display = mode === 'custom' ? 'block' : 'none';
            }

            // ä¿å­˜é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            if (!configs.basic) configs.basic = {};
            if (!configs.basic.tableRecords) configs.basic.tableRecords = {};

            configs.basic.tableRecords.apiMode = mode;

            extensionSettings['Information bar integration tool'] = configs;
            await context.saveSettingsDebounced();

            console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼APIæ¨¡å¼å·²ä¿å­˜:', mode);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ•°æ®è¡¨æ ¼APIæ¨¡å¼å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†AIè®°å¿†æ€»ç»“APIæ¨¡å¼åˆ‡æ¢
     */
    async handleAIMemoryAPIModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢AIè®°å¿†æ€»ç»“APIæ¨¡å¼:', mode);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = this.modal.querySelectorAll('.ai-memory-api-mode-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                }
            });

            // æ›´æ–°æè¿°æ–‡æœ¬
            const autoDesc = this.modal.querySelector('.ai-memory-mode-description .auto-mode-desc');
            const mainDesc = this.modal.querySelector('.ai-memory-mode-description .main-mode-desc');
            const customDesc = this.modal.querySelector('.ai-memory-mode-description .custom-mode-desc');
            if (autoDesc && mainDesc && customDesc) {
                autoDesc.style.display = mode === 'auto' ? 'block' : 'none';
                mainDesc.style.display = mode === 'main' ? 'block' : 'none';
                customDesc.style.display = mode === 'custom' ? 'block' : 'none';
            }

            // æ›´æ–°é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            if (!extensionSettings['Information bar integration tool'].memoryEnhancement) {
                extensionSettings['Information bar integration tool'].memoryEnhancement = {};
            }
            if (!extensionSettings['Information bar integration tool'].memoryEnhancement.ai) {
                extensionSettings['Information bar integration tool'].memoryEnhancement.ai = {};
            }

            // ä¿å­˜APIæ¨¡å¼é…ç½®
            extensionSettings['Information bar integration tool'].memoryEnhancement.ai.apiMode = mode;

            // ä¿å­˜é…ç½®
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] âœ… AIè®°å¿†æ€»ç»“APIæ¨¡å¼å·²åˆ‡æ¢:', mode);
            this.showMessage(`âœ… AIè®°å¿†æ€»ç»“APIæ¨¡å¼å·²åˆ‡æ¢ä¸º: ${mode === 'auto' ? 'è‡ªåŠ¨æ¨¡å¼' : mode === 'main' ? 'ä¸»APIæ¨¡å¼' : 'è‡ªå®šä¹‰APIæ¨¡å¼'}`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢AIè®°å¿†æ€»ç»“APIæ¨¡å¼å¤±è´¥:', error);
            this.showNotification('âŒ åˆ‡æ¢APIæ¨¡å¼å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• å¤„ç†"å¯ç”¨æ•°æ®è¡¨æ ¼"å¤é€‰æ¡†åˆ‡æ¢
     * ğŸ”§ ä¿®å¤ï¼šåªæ›´æ–°UIï¼ˆåˆ›å»º/åˆ é™¤æŒ‰é’®ï¼‰ï¼Œä¸è§¦å‘ä¿å­˜
     * é…ç½®ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ—¶ç»Ÿä¸€ä¿å­˜
     */
    handleTableRecordsToggle(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ“Š æ•°æ®è¡¨æ ¼åŠŸèƒ½${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ï¼ˆä»…æ›´æ–°UIï¼‰`);

            const extensionMenu = document.querySelector('#extensionsMenu');
            if (!extensionMenu) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ‰©å±•èœå•');
                return;
            }

            const existingButton = document.getElementById('infobar-table-menu-item');

            if (enabled) {
                // ğŸ”§ ä¿®å¤ï¼šå®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç¡®ä¿å¯ä»¥é‡å¤ç»‘å®š
                const handleTableClick = (e) => {
                    e.preventDefault();
                    console.log('[InfoBarSettings] ğŸ” ç‚¹å‡»æ•°æ®è¡¨æ ¼æŒ‰é’®');
                    
                    const dataTable = window.SillyTavernInfobar?.modules?.dataTable;
                    
                    if (dataTable && typeof dataTable.show === 'function') {
                        console.log('[InfoBarSettings] âœ… è°ƒç”¨ dataTable.show()');
                        dataTable.show();
                    } else {
                        console.error('[InfoBarSettings] âŒ æ•°æ®è¡¨æ ¼æ¨¡å—æœªæ‰¾åˆ°æˆ–æœªåˆå§‹åŒ–');
                        console.error('[InfoBarSettings] ğŸ“Š dataTable:', dataTable);
                    }
                };

                // å¯ç”¨ï¼šå¦‚æœæŒ‰é’®ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
                if (!existingButton) {
                    const tableMenuItem = document.createElement('a');
                    tableMenuItem.id = 'infobar-table-menu-item';
                    tableMenuItem.className = 'dropdown-item';
                    tableMenuItem.href = '#';
                    tableMenuItem.innerHTML = '<i class="fa-solid fa-table"></i> æ•°æ®è¡¨æ ¼';

                    // ç»‘å®šäº‹ä»¶
                    tableMenuItem.addEventListener('click', handleTableClick);

                    // æ’å…¥åˆ°"ä¿¡æ¯åŠ©æ‰‹"æŒ‰é’®ä¹‹å
                    const settingsButton = document.getElementById('infobar-settings-menu-item');
                    if (settingsButton && settingsButton.nextSibling) {
                        extensionMenu.insertBefore(tableMenuItem, settingsButton.nextSibling);
                    } else {
                        extensionMenu.appendChild(tableMenuItem);
                    }

                    console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼æŒ‰é’®å·²åˆ›å»ºå¹¶ç»‘å®šäº‹ä»¶');
                } else {
                    // ğŸ”§ ä¿®å¤ï¼šæŒ‰é’®å·²å­˜åœ¨æ—¶ï¼Œç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶é‡æ–°ç»‘å®š
                    console.log('[InfoBarSettings] ğŸ”„ æ•°æ®è¡¨æ ¼æŒ‰é’®å·²å­˜åœ¨ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶');
                    
                    // å…‹éš†èŠ‚ç‚¹ä»¥ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                    const newButton = existingButton.cloneNode(true);
                    existingButton.parentNode.replaceChild(newButton, existingButton);
                    
                    // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
                    newButton.addEventListener('click', handleTableClick);
                    
                    console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼æŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
                }
            } else {
                // ç¦ç”¨ï¼šå¦‚æœæŒ‰é’®å­˜åœ¨ï¼Œåˆ™åˆ é™¤
                if (existingButton) {
                    existingButton.remove();
                    console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼æŒ‰é’®å·²åˆ é™¤');
                } else {
                    console.log('[InfoBarSettings] â„¹ï¸ æ•°æ®è¡¨æ ¼æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤');
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ•°æ®è¡¨æ ¼åˆ‡æ¢å¤±è´¥:', error);
        }
    }

    // ğŸ”§ ä¿®å¤ï¼šç§»é™¤è‡ªåŠ¨ä¿å­˜æœºåˆ¶ï¼Œé¿å…ä¸SillyTavernä¿å­˜æœºåˆ¶å†²çª
    // æ‰€æœ‰é…ç½®å˜æ›´åªåœ¨ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ—¶ç»Ÿä¸€ä¿å­˜
    /**
     * åˆ›å»ºAPIé…ç½®é¢æ¿
     */
    createAPIPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ”Œ è‡ªå®šä¹‰APIé…ç½®</h3>
                <div style="font-size: 13px; color: var(--theme-text-secondary, #999); margin-top: 8px;">
                    ğŸ’¡ æç¤ºï¼šåœ¨"åŸºç¡€è®¾ç½®"ä¸­å¯ç”¨æ•°æ®è¡¨æ ¼åï¼Œå¯é€‰æ‹©ä½¿ç”¨è‡ªå®šä¹‰APIæ¨¡å¼
                </div>
            </div>

            <div class="content-body">
                <!-- ğŸ†• APIç±»å‹åˆ‡æ¢æŒ‰é’® -->
                <div class="settings-group">
                    <h4>APIé…ç½®ç±»å‹</h4>
                    <div class="form-group">
                        <div class="api-type-switch-buttons" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="api-type-switch-btn active" data-api-type="general" style="
                                flex: 1;
                                padding: 10px 20px;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-weight: 500;
                            ">
                                ğŸ¤– é€šç”¨API
                            </button>
                            <button type="button" class="api-type-switch-btn" data-api-type="vector" style="
                                flex: 1;
                                padding: 10px 20px;
                                background: var(--theme-bg-secondary, #2a2a2a);
                                color: var(--theme-text-primary, #e0e0e0);
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                ğŸ§  å‘é‡åŒ–API
                            </button>
                        </div>
                        <small>é€šç”¨APIï¼šç”¨äºä¿¡æ¯æ æ•°æ®ç”Ÿæˆ | å‘é‡åŒ–APIï¼šç”¨äºè®°å¿†å‘é‡åŒ–å’Œè¯­ä¹‰æœç´¢</small>
                    </div>
                </div>

                <!-- é€šç”¨APIé…ç½®åŒºåŸŸ -->
                <div class="general-api-config-section"


                <!-- APIæä¾›å•†é€‰æ‹© -->
                <div class="settings-group">
                    <h4>APIè¿æ¥æ¨¡å¼</h4>
                    <div class="form-group">
                        <label>APIè¿æ¥æ¨¡å¼</label>
                        <select id="infobar-api-provider" name="apiConfig.provider">
                            <option value="">è¯·é€‰æ‹©è¿æ¥æ¨¡å¼</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="localproxy">é€šç”¨å…¨å…¼å®¹ï¼ˆSilly Tavernåç«¯ï¼‰</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                        <small>Geminiå¯ç›´æ¥ä½¿ç”¨è°·æ­Œå®˜æ–¹å¯†é’¥ã€‚é€šç”¨å…¨å…¼å®¹å¯é€‚é…å¸‚é¢ä¸Šå¤§éƒ¨åˆ†è‡ªå®šä¹‰ï¼Œåä»£ç­‰ç­‰APIã€‚è‡ªå®šä¹‰APIå¯å…¼å®¹éƒ¨åˆ†APIè¿æ¥ï¼Œéƒ¨åˆ†APIæ— æ³•æ­£å¸¸è·å–æ¨¡å‹ã€‚</small>
                    </div>
                </div>

                <!-- æ¥å£ç±»å‹é€‰æ‹© -->
                <div class="settings-group" id="infobar-interface-type-group">
                    <h4>é€‰æ‹©æ¥å£ç±»å‹</h4>
                    <div class="form-group">
                        <label>æ¥å£ç±»å‹</label>
                        <select id="infobar-interface-type" name="apiConfig.format">
                            <option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†</option>
                        </select>
                        <small>é€‰æ‹©APIæ¥å£çš„è°ƒç”¨æ–¹å¼</small>
                    </div>
                </div>

                <!-- åŸºç¡€URLé…ç½® -->
                <div class="settings-group" id="infobar-base-url-group">
                    <h4>åŸºç¡€URL</h4>
                    <div class="form-group">
                        <label>APIåŸºç¡€URL</label>
                        <input type="url" id="infobar-api-base-url" name="apiConfig.baseUrl" placeholder="https://api.example.com" />
                        <small>APIæœåŠ¡çš„åŸºç¡€åœ°å€</small>
                    </div>
                </div>

                <!-- APIå¯†é’¥é…ç½® -->
                <div class="settings-group">
                    <h4>APIå¯†é’¥</h4>
                    <div class="form-group">
                        <label>APIå¯†é’¥</label>
                        <input type="password" id="infobar-api-key" name="apiConfig.apiKey" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥" />
                        <small>ä»APIæä¾›å•†è·å–çš„è®¿é—®å¯†é’¥</small>
                    </div>
                </div>

                <!-- æ¨¡å‹é€‰æ‹© -->
                <div class="settings-group">
                    <h4>æ¨¡å‹é€‰æ‹©</h4>
                    <div class="form-group">
                        <label>AIæ¨¡å‹</label>
                        <select id="infobar-api-model" name="apiConfig.model">
                            <option value="">è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨</option>
                        </select>
                        <small>é€‰æ‹©è¦ä½¿ç”¨çš„AIæ¨¡å‹</small>
                    </div>
                </div>

                <!-- åŠ è½½æ¨¡å‹åˆ—è¡¨æŒ‰é’® -->
                <div class="settings-group">
                    <h4>æ¨¡å‹åˆ—è¡¨ç®¡ç†</h4>
                    <div class="form-group">
                        <button type="button" id="infobar-load-models-btn" class="btn btn-primary">ğŸ”„ é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨</button>
                        <small>é‡æ–°ä»APIè·å–æœ€æ–°çš„æ¨¡å‹åˆ—è¡¨ï¼ˆä¼šæ¶ˆè€—APIé¢åº¦ï¼‰</small>
                    </div>
                </div>

                <!-- æµ‹è¯•è¿æ¥æŒ‰é’® -->
                <div class="settings-group">
                    <h4>æµ‹è¯•è¿æ¥</h4>
                    <div class="form-group">
                        <button type="button" id="infobar-test-connection-btn" class="btn btn-secondary">ğŸ” æµ‹è¯•è¿æ¥</button>
                        <small>æµ‹è¯•APIè¿æ¥æ˜¯å¦æ­£å¸¸</small>
                    </div>

                    <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                    <div class="form-group" style="margin-top: 12px;">
                        <div id="infobar-connection-status" class="connection-status">
                            â³ æœªæµ‹è¯•è¿æ¥
                        </div>
                        <small>æ˜¾ç¤ºAPIè¿æ¥å’Œæ¨¡å‹åŠ è½½çŠ¶æ€</small>
                    </div>
                </div>

                <!-- æ¨¡å‹å‚æ•°é…ç½® -->
                <div class="settings-group">
                    <h4>æ¨¡å‹å‚æ•°</h4>
                    <div class="form-group">
                        <label>æ¸©åº¦ (0-2)</label>
                        <input type="range" name="apiConfig.temperature" min="0" max="2" step="0.1" value="0.7" />
                        <span class="range-value">0.7</span>
                        <small>æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ï¼Œå€¼è¶Šé«˜è¶Šéšæœº</small>
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§ä»¤ç‰Œæ•°</label>
                        <input type="number" name="apiConfig.maxTokens" min="1" max="100000" step="100" value="20000" />
                        <small>ç”Ÿæˆæ–‡æœ¬çš„æœ€å¤§é•¿åº¦</small>
                    </div>
                </div>

                <!-- è¿æ¥è®¾ç½® -->
                <div class="settings-group">
                    <h4>è¿æ¥è®¾ç½®</h4>
                    <div class="form-group">
                        <label>é‡è¯•æ¬¡æ•°</label>
                        <input type="number" name="apiConfig.retryCount" min="0" max="10" step="1" value="3" />
                        <small>è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°</small>
                    </div>
                </div>

                <!-- ğŸ†• é€šç”¨åŠŸèƒ½è®¾ç½® -->
                <div class="settings-group">
                    <h4>ğŸŒ é€šç”¨åŠŸèƒ½è®¾ç½®</h4>
                    <small style="display: block; margin-bottom: 12px; color: var(--theme-text-secondary, #888);">
                        ä»¥ä¸‹è®¾ç½®é€‚ç”¨äºæ‰€æœ‰ä½¿ç”¨é€šç”¨APIçš„åŠŸèƒ½ï¼ˆæ•°æ®è¡¨æ ¼ã€å‰§æƒ…ä¼˜åŒ–ã€AIè®°å¿†æ€»ç»“ç­‰ï¼‰
                    </small>

                    <!-- è¯»å–ä¸–ç•Œä¹¦ -->
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-include-worldbook" name="apiConfig.includeWorldBook" />
                            <label for="api-include-worldbook" class="checkbox-label">è¯»å–ä¸–ç•Œä¹¦</label>
                        </div>
                        <small>å¯ç”¨æ—¶å°†SillyTavernä¸–ç•Œä¹¦å†…å®¹æ³¨å…¥åˆ°é€šç”¨APIè¯·æ±‚ä¸­</small>
                    </div>

                    <!-- ä¸–ç•Œä¹¦æ¥æºé€‰æ‹© -->
                    <div class="form-group" id="worldbook-source-selection" style="display: none; margin-left: 30px;">
                        <label>ä¸–ç•Œä¹¦æ¥æº</label>
                        <select id="api-worldbook-source" name="apiConfig.worldbookSource">
                            <option value="default">é»˜è®¤ä¸–ç•Œä¹¦ï¼ˆä½¿ç”¨å½“å‰è§’è‰²ç»‘å®šçš„ä¸–ç•Œä¹¦ï¼‰</option>
                            <option value="all">å…¨éƒ¨ä¸–ç•Œä¹¦ï¼ˆè¯»å–æ‰€æœ‰å¯ç”¨ä¸–ç•Œä¹¦ï¼‰</option>
                            <option value="custom">è‡ªå®šä¹‰é€‰æ‹©ï¼ˆæ‰‹åŠ¨é€‰æ‹©éœ€è¦è¯»å–çš„ä¸–ç•Œä¹¦ï¼‰</option>
                        </select>
                        <small>
                            â€¢ é»˜è®¤ä¸–ç•Œä¹¦ï¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰è§’è‰²å¡ç»‘å®šçš„ä¸–ç•Œä¹¦<br>
                            â€¢ å…¨éƒ¨ä¸–ç•Œä¹¦ï¼šè¯»å–SillyTavernä¸­æ‰€æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦<br>
                            â€¢ è‡ªå®šä¹‰é€‰æ‹©ï¼šåœ¨ä¸‹æ–¹æ‰‹åŠ¨é€‰æ‹©éœ€è¦è¯»å–çš„ä¸–ç•Œä¹¦
                        </small>
                    </div>

                    <!-- è‡ªå®šä¹‰ä¸–ç•Œä¹¦é€‰æ‹©åŒºåŸŸ -->
                    <div class="form-group" id="custom-worldbook-selection" style="display: none; margin-left: 30px; margin-top: 12px;">
                        <label>é€‰æ‹©ä¸–ç•Œä¹¦</label>
                        <div id="worldbook-list-container" style="
                            max-height: 300px;
                            overflow-y: auto;
                            padding: 12px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                        ">
                            <div style="text-align: center; color: var(--theme-text-secondary, #888); padding: 20px;">
                                åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨ä¸­...
                            </div>
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button type="button" id="worldbook-select-all-btn" class="btn btn-secondary" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                                âœ… å…¨é€‰
                            </button>
                            <button type="button" id="worldbook-deselect-all-btn" class="btn btn-secondary" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                                âŒ å–æ¶ˆå…¨é€‰
                            </button>
                        </div>
                        <small style="display: block; margin-top: 8px;">
                            é€‰ä¸­çš„ä¸–ç•Œä¹¦å°†åœ¨è°ƒç”¨é€šç”¨APIæ—¶ä¸€èµ·è¯»å–å¹¶æ³¨å…¥åˆ°è¯·æ±‚ä¸­
                        </small>
                    </div>

                    <!-- è¯·æ±‚è¯¢é—® -->
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-request-confirmation" name="apiConfig.requestConfirmation" />
                            <label for="api-request-confirmation" class="checkbox-label">è¯·æ±‚è¯¢é—®</label>
                        </div>
                        <small>å¯ç”¨åï¼Œåœ¨è°ƒç”¨é€šç”¨APIå‰ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­</small>
                    </div>

                    <!-- ç ´ç”²æç¤ºè¯é…ç½® -->
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-enable-armor-breaking" name="apiConfig.enableArmorBreaking" />
                            <label for="api-enable-armor-breaking" class="checkbox-label">å¯ç”¨ç ´ç”²æç¤ºè¯</label>
                        </div>
                        <small>å¯ç”¨ååœ¨æ™ºèƒ½æç¤ºè¯é¡¶éƒ¨æ˜¾ç¤ºç ´ç”²æç¤ºè¯ï¼Œç”¨äºçªç ´AIé™åˆ¶</small>
                    </div>
                </div>

                <!-- ğŸ†• ç ´ç”²æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group armor-breaking-config-section" style="display: none;">
                    <h4>ğŸ›¡ï¸ ç ´ç”²æç¤ºè¯é…ç½®</h4>
                    <div class="form-group">
                        <label>ç ´ç”²æç¤ºè¯å†…å®¹</label>
                        <textarea id="armor-breaking-prompt" name="apiConfig.armorBreakingPrompt"
                                  rows="6"
                                  placeholder="è¯·è¾“å…¥ç ´ç”²æç¤ºè¯å†…å®¹ï¼Œå°†åœ¨æ™ºèƒ½æç¤ºè¯é¡¶éƒ¨æ˜¾ç¤º..."
                                  style="width: 100%; min-height: 120px; resize: vertical; font-family: monospace; font-size: 13px;"></textarea>
                        <small>æ­¤æç¤ºè¯å°†åœ¨æ™ºèƒ½æç¤ºè¯çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºï¼Œç”¨äºçªç ´AIçš„æŸäº›é™åˆ¶ã€‚è¯·è°¨æ…ä½¿ç”¨ã€‚</small>
                    </div>
                    <div class="form-group">
                        <div class="armor-breaking-stats">
                            <span class="char-count">å­—ç¬¦æ•°: <span id="armor-breaking-char-count">0</span></span>
                            <span class="word-count">å•è¯æ•°: <span id="armor-breaking-word-count">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• ä¸–ç•Œä¹¦é…ç½®é¢æ¿ -->
                <div class="settings-group worldbook-config-section" style="display: none;">
                    <h4>ğŸ“š ä¸–ç•Œä¹¦ç®¡ç†é…ç½®</h4>
                    <div id="worldbook-config-container">
                        <!-- ä¸–ç•Œä¹¦é…ç½®é¢æ¿å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        <div style="padding: 20px; text-align: center; color: var(--theme-text-secondary, #aaa);">
                            æ­£åœ¨åŠ è½½ä¸–ç•Œä¹¦é…ç½®...
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• æ­£åˆ™è¡¨è¾¾å¼ç®¡ç† -->
                <div class="settings-group">
                    <h4>æ­£åˆ™è¡¨è¾¾å¼ç®¡ç†</h4>
                    <div class="form-group">
                        <button type="button" id="regex-script-manager-btn" class="btn btn-secondary">ğŸ“ æ­£åˆ™è¡¨è¾¾å¼ç®¡ç†</button>
                        <small>ç®¡ç†ç”¨äºè‡ªå®šä¹‰APIçš„æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ï¼Œå¯ä»SillyTavernå¯¼å…¥æˆ–åˆ›å»ºæ–°è„šæœ¬</small>
                    </div>
                </div>
                </div>

                <!-- ğŸ†• å‘é‡åŒ–APIé…ç½®åŒºåŸŸ -->
                <div class="vector-api-config-section" style="display: none;">
                    <!-- è¿æ¥æ¨¡å¼é€‰æ‹© -->
                    <div class="settings-group">
                        <h4>è¿æ¥æ¨¡å¼</h4>
                        <div class="form-group">
                            <label>è¿æ¥æ¨¡å¼</label>
                            <select id="infobar-vector-api-provider" name="vectorAPIConfig.provider">
                                <option value="">è¯·é€‰æ‹©è¿æ¥æ¨¡å¼</option>
                                <option value="localproxy">é€šç”¨å…¨å…¼å®¹ï¼ˆSilly Tavernåç«¯ï¼‰</option>
                                <option value="siliconflow">æµåŠ¨ç¡…åŸº</option>
                                <option value="custom">è‡ªå®šä¹‰API</option>
                            </select>
                            <small>é€‰æ‹©å‘é‡åŒ–APIçš„è¿æ¥æ–¹å¼ï¼ˆé€šç”¨å…¨å…¼å®¹ä½¿ç”¨SillyTavernåç«¯ä»£ç†ï¼ŒæµåŠ¨ç¡…åŸºä½¿ç”¨å®˜æ–¹APIï¼Œè‡ªå®šä¹‰APIç›´æ¥è¿æ¥ï¼‰</small>
                        </div>
                    </div>

                    <!-- åŸºç¡€URLé…ç½® -->
                    <div class="settings-group" id="vector-base-url-group">
                        <h4>åŸºç¡€URL</h4>
                        <div class="form-group">
                            <label>APIåŸºç¡€URL</label>
                            <input type="url" id="infobar-vector-api-base-url" name="vectorAPIConfig.baseUrl" placeholder="http://127.0.0.1:7861/v1" />
                            <small>å‘é‡åŒ–APIæœåŠ¡çš„åŸºç¡€åœ°å€ï¼ˆæ ¹æ®è¿æ¥æ¨¡å¼è‡ªåŠ¨è®¾ç½®ï¼‰</small>
                        </div>
                    </div>

                    <!-- APIå¯†é’¥é…ç½® -->
                    <div class="settings-group">
                        <h4>APIå¯†é’¥</h4>
                        <div class="form-group">
                            <label>APIå¯†é’¥</label>
                            <input type="password" id="infobar-vector-api-key" name="vectorAPIConfig.apiKey" placeholder="sk-..." />
                            <small>è®¿é—®å‘é‡åŒ–APIæ‰€éœ€çš„å¯†é’¥</small>
                        </div>
                    </div>

                    <!-- å‘é‡åŒ–æ¨¡å‹é…ç½® -->
                    <div class="settings-group">
                        <h4>å‘é‡åŒ–æ¨¡å‹</h4>
                        <div class="form-group">
                            <label>Embeddingæ¨¡å‹</label>
                            <select id="infobar-vector-api-model" name="vectorAPIConfig.model">
                                <option value="">-- è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨ --</option>
                            </select>
                            <small>ä»APIè·å–å¯ç”¨çš„embeddingæ¨¡å‹åˆ—è¡¨</small>
                        </div>
                        <div class="form-group">
                            <label>é‡æ’åºæ¨¡å‹</label>
                            <select id="infobar-vector-api-rerank-model" name="vectorAPIConfig.rerankModel">
                                <option value="">-- ä¸ä½¿ç”¨é‡æ’åº --</option>
                                <option value="jina-reranker-v2-base-multilingual">Jina Reranker v2 Base (å¤šè¯­è¨€)</option>
                                <option value="jina-reranker-v1-base-en">Jina Reranker v1 Base (è‹±æ–‡)</option>
                                <option value="bge-reranker-v2-m3">BGE Reranker v2 M3</option>
                                <option value="bge-reranker-base">BGE Reranker Base</option>
                            </select>
                            <small>ğŸ¯ é‡æ’åºæ¨¡å‹ç”¨äºå¤šè·¯å¬å›åçš„ç²¾å‡†ç­›é€‰ï¼ˆä½¿ç”¨ç›¸åŒçš„APIåœ°å€å’Œå¯†é’¥ï¼‰</small>
                        </div>
                    </div>

                    <!-- åŠ è½½æ¨¡å‹åˆ—è¡¨æŒ‰é’® -->
                    <div class="settings-group">
                        <h4>æ¨¡å‹åˆ—è¡¨ç®¡ç†</h4>
                        <div class="form-group">
                            <button type="button" id="infobar-load-vector-models-btn" class="btn btn-primary">ğŸ”„ é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨</button>
                            <small>é‡æ–°ä»APIè·å–æœ€æ–°çš„embeddingæ¨¡å‹åˆ—è¡¨ï¼ˆä¼šæ¶ˆè€—APIé¢åº¦ï¼‰</small>
                        </div>
                    </div>

                    <!-- æµ‹è¯•è¿æ¥æŒ‰é’® -->
                    <div class="settings-group">
                        <h4>æµ‹è¯•è¿æ¥</h4>
                        <div class="form-group">
                            <button type="button" id="infobar-test-vector-connection-btn" class="btn btn-secondary">ğŸ” æµ‹è¯•è¿æ¥</button>
                            <small>æµ‹è¯•å‘é‡åŒ–APIè¿æ¥æ˜¯å¦æ­£å¸¸</small>
                        </div>

                        <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                        <div class="form-group" style="margin-top: 12px;">
                            <div id="infobar-vector-model-status" class="connection-status">
                                â³ æœªæµ‹è¯•è¿æ¥
                            </div>
                            <small>æ˜¾ç¤ºå‘é‡åŒ–APIè¿æ¥å’Œæ¨¡å‹åŠ è½½çŠ¶æ€</small>
                        </div>
                    </div>

                    <!-- é«˜çº§é…ç½® -->
                    <div class="settings-group">
                        <h4>é«˜çº§é…ç½®</h4>
                        <div class="form-group">
                            <label>å‘é‡ç»´åº¦</label>
                            <input type="number" id="infobar-vector-api-dimensions" name="vectorAPIConfig.dimensions" placeholder="384" min="128" max="4096" />
                            <small>å‘é‡çš„ç»´åº¦å¤§å°ï¼ˆé€šå¸¸ç”±æ¨¡å‹å†³å®šï¼Œå¦‚text-embedding-ada-002ä¸º1536ï¼‰</small>
                        </div>
                        <div class="form-group">
                            <label>æ‰¹å¤„ç†å¤§å°</label>
                            <input type="number" id="infobar-vector-api-batch-size" name="vectorAPIConfig.batchSize" placeholder="50" min="1" max="100" />
                            <small>æ‰¹é‡å¤„ç†æ–‡æœ¬æ—¶æ¯æ‰¹çš„æ•°é‡</small>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¯ é‡æ’åºæ¨¡å‹å‚æ•°</label>
                            <textarea id="infobar-vector-api-rerank-params" name="vectorAPIConfig.rerankParams" rows="3" placeholder='{"temperature": 0.7, "max_tokens": 100}' style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                                font-family: monospace;
                                resize: vertical;
                            "></textarea>
                            <small>é‡æ’åºæ¨¡å‹çš„é¢å¤–å‚æ•°ï¼ˆJSONæ ¼å¼ï¼Œå¯é€‰ï¼‰</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºè®°å¿†å¢å¼ºé¢æ¿
     */
    createMemoryEnhancementPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ§  è®°å¿†å¢å¼º</h3>
                <div class="header-description">
                    <p>é…ç½®å››å±‚è®°å¿†æ¶æ„ï¼šAIè®°å¿†æ€»ç»“ã€è¯­ä¹‰æœç´¢ã€æ·±åº¦è®°å¿†ç®¡ç†ã€æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</p>
                </div>
            </div>

            <div class="content-body">
                <!-- ğŸ¯ è®°å¿†ç³»ç»ŸçŠ¶æ€å¯è§†åŒ– -->
                <div class="memory-status-visualization" id="memory-status-visualization">
                    <div class="status-header">
                        <h4>ğŸ“Š è®°å¿†çŠ¶æ€æ˜¾ç¤º</h4>
                        <button class="refresh-status-btn" id="refresh-memory-status" title="åˆ·æ–°çŠ¶æ€">ğŸ”„</button>
                    </div>

                    <!-- å››å±‚è®°å¿†çŠ¶æ€å¡ç‰‡ -->
                    <div class="memory-layers-status">
                        <div class="memory-layer-card" data-layer="sensory">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ‘ï¸</span>
                                <span class="layer-name">æ„ŸçŸ¥è®°å¿†å±‚</span>
                                <span class="layer-status" id="sensory-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="sensory-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å®¹é‡:</span>
                                    <span class="stat-value" id="sensory-capacity">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="shortTerm">
                            <div class="layer-header">
                                <span class="layer-icon">âš¡</span>
                                <span class="layer-name">çŸ­æœŸè®°å¿†å±‚</span>
                                <span class="layer-status" id="shortterm-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="shortterm-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é‡è¦æ€§:</span>
                                    <span class="stat-value" id="shortterm-importance">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="longTerm">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ§ </span>
                                <span class="layer-name">é•¿æœŸè®°å¿†å±‚</span>
                                <span class="layer-status" id="longterm-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="longterm-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è¿ç§»:</span>
                                    <span class="stat-value" id="longterm-migrations">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="deepArchive">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ“š</span>
                                <span class="layer-name">æ·±åº¦å½’æ¡£å±‚</span>
                                <span class="layer-status" id="archive-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="archive-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹ç¼©:</span>
                                    <span class="stat-value" id="archive-compression">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¨¡å—çŠ¶æ€æ¦‚è§ˆ -->
                    <div class="modules-status">
                        <div class="module-status-card" data-module="aiSummarizer">
                            <div class="module-header">
                                <span class="module-icon">ğŸ¤–</span>
                                <span class="module-name">AIè®°å¿†æ€»ç»“</span>
                                <span class="module-status" id="ai-summarizer-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">é˜Ÿåˆ—:</span>
                                    <span class="stat-value" id="ai-summarizer-queue">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç¼“å­˜:</span>
                                    <span class="stat-value" id="ai-summarizer-cache">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="vectorSearch">
                            <div class="module-header">
                                <span class="module-icon">ğŸ”</span>
                                <span class="module-name">è¯­ä¹‰æœç´¢</span>
                                <span class="module-status" id="vector-search-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ç´¢å¼•:</span>
                                    <span class="stat-value" id="vector-search-index">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‘½ä¸­ç‡:</span>
                                    <span class="stat-value" id="vector-search-hitrate">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="classifier">
                            <div class="module-header">
                                <span class="module-icon">ğŸ¯</span>
                                <span class="module-name">æ™ºèƒ½åˆ†ç±»</span>
                                <span class="module-status" id="classifier-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">åˆ†ç±»:</span>
                                    <span class="stat-value" id="classifier-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç½®ä¿¡åº¦:</span>
                                    <span class="stat-value" id="classifier-confidence">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="injector">
                            <div class="module-header">
                                <span class="module-icon">ğŸ’‰</span>
                                <span class="module-name">è®°å¿†æ³¨å…¥</span>
                                <span class="module-status" id="injector-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ³¨å…¥:</span>
                                    <span class="stat-value" id="injector-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é”™è¯¯:</span>
                                    <span class="stat-value" id="injector-errors">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“çŠ¶æ€å¡ç‰‡ -->
                        <div class="module-status-card ai-memory-database-card" data-module="aiMemoryDatabase">
                            <div class="module-header">
                                <span class="module-icon">ğŸ—„ï¸</span>
                                <span class="module-name">AIè®°å¿†æ•°æ®åº“</span>
                                <span class="module-status" id="ai-memory-database-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">è®°å¿†æ•°:</span>
                                    <span class="stat-value" id="ai-memory-database-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å…³é”®è¯:</span>
                                    <span class="stat-value" id="ai-memory-database-keywords">-</span>
                                </div>
                            </div>
                            <!-- ğŸ¯ å¯è§†åŒ–è¿›åº¦æ¡ -->
                            <div class="ai-db-visualization">
                                <div class="visualization-row">
                                    <span class="viz-label">ç´¢å¼•å®Œæ•´åº¦:</span>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="ai-db-index-progress">
                                            <div class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                        <span class="progress-text" id="ai-db-index-text">0%</span>
                                    </div>
                                </div>
                                <div class="visualization-row">
                                    <span class="viz-label">å¹³å‡é‡è¦æ€§:</span>
                                    <div class="importance-indicator">
                                        <div class="importance-bar" id="ai-db-importance-bar">
                                            <div class="importance-fill" style="width: 0%;"></div>
                                        </div>
                                        <span class="importance-value" id="ai-db-importance-value">0.00</span>
                                    </div>
                                </div>
                                <div class="visualization-row">
                                    <span class="viz-label">åˆ†ç±»åˆ†å¸ƒ:</span>
                                    <div class="category-distribution" id="ai-db-categories">
                                        <span class="no-data">æš‚æ— æ•°æ®</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ğŸ†• æ–°å¢å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—çŠ¶æ€ -->
                        <div class="module-status-card" data-module="memoryMaintenance">
                            <div class="module-header">
                                <span class="module-icon">ğŸ”§</span>
                                <span class="module-name">è®°å¿†è‡ªåŠ¨ç»´æŠ¤</span>
                                <span class="module-status" id="memory-maintenance-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ¸…ç†:</span>
                                    <span class="stat-value" id="memory-maintenance-cleanups">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹ç¼©:</span>
                                    <span class="stat-value" id="memory-maintenance-compressions">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="contextualRetrieval">
                            <div class="module-header">
                                <span class="module-icon">ğŸ”</span>
                                <span class="module-name">ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢</span>
                                <span class="module-status" id="contextual-retrieval-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æŸ¥è¯¢:</span>
                                    <span class="stat-value" id="contextual-retrieval-queries">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç¼“å­˜:</span>
                                    <span class="stat-value" id="contextual-retrieval-cache-hits">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="userProfile">
                            <div class="module-header">
                                <span class="module-icon">ğŸ‘¤</span>
                                <span class="module-name">ç”¨æˆ·ç”»åƒ</span>
                                <span class="module-status" id="user-profile-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ç”»åƒ:</span>
                                    <span class="stat-value" id="user-profile-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç½®ä¿¡åº¦:</span>
                                    <span class="stat-value" id="user-profile-confidence">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="knowledgeGraph">
                            <div class="module-header">
                                <span class="module-icon">ğŸ•¸ï¸</span>
                                <span class="module-name">çŸ¥è¯†å›¾è°±</span>
                                <span class="module-status" id="knowledge-graph-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ä¸‰å…ƒç»„:</span>
                                    <span class="stat-value" id="knowledge-graph-triples">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å®ä½“:</span>
                                    <span class="stat-value" id="knowledge-graph-entities">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="timeAware">
                            <div class="module-header">
                                <span class="module-icon">â°</span>
                                <span class="module-name">æ—¶é—´æ„ŸçŸ¥è®°å¿†</span>
                                <span class="module-status" id="time-aware-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">äº‹ä»¶:</span>
                                    <span class="stat-value" id="time-aware-events">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è¡°å‡:</span>
                                    <span class="stat-value" id="time-aware-decayed">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="stIntegration">
                            <div class="module-header">
                                <span class="module-icon">ğŸ”—</span>
                                <span class="module-name">SillyTaverné›†æˆ</span>
                                <span class="module-status" id="st-integration-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ³¨å…¥:</span>
                                    <span class="stat-value" id="st-integration-injections">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è€—æ—¶:</span>
                                    <span class="stat-value" id="st-integration-avg-time">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹çŠ¶æ€å¡ç‰‡ -->
                        <div class="module-status-card" data-module="storyPlanning">
                            <div class="module-header">
                                <span class="module-icon">ğŸ“–</span>
                                <span class="module-name">å‰§æƒ…è§„åˆ’åŠ©æ‰‹</span>
                                <span class="module-status" id="story-planning-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">è§„åˆ’æ¬¡æ•°:</span>
                                    <span class="stat-value" id="story-planning-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å»ºè®®æ•°:</span>
                                    <span class="stat-value" id="story-planning-suggestions">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—å¯ç”¨é€‰é¡¹ -->
                <div class="setting-row enhancement-modules-section">
                    <h5 style="color: #FF9800; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸš€ è®°å¿†å¢å¼ºæ ¸å¿ƒåŠŸèƒ½</h5>
                    <div class="setting-hint" style="margin-bottom: 15px;">ä»¥ä¸‹åŠŸèƒ½é»˜è®¤ç¦ç”¨ï¼Œè¯·æ ¹æ®éœ€è¦å¯ç”¨</div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-maintenance-enabled" />
                            <span class="checkbox-text">ğŸ”§ è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿ</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨æ¸…ç†ã€å‹ç¼©å’Œè´¨é‡è¯„ä¼°è®°å¿†æ•°æ®</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="contextual-retrieval-enabled" />
                            <span class="checkbox-text">ğŸ” ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢</span>
                        </label>
                        <div class="setting-hint">æ··åˆæ£€ç´¢ã€é‡æ’åºå’Œè¯­ä¹‰ç¼“å­˜</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="user-profile-enabled" />
                            <span class="checkbox-text">ğŸ‘¤ ç”¨æˆ·ç”»åƒç®¡ç†</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·åå¥½å’Œä¸ªæ€§åŒ–è®°å¿†</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="knowledge-graph-enabled" />
                            <span class="checkbox-text">ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±ç®¡ç†</span>
                        </label>
                        <div class="setting-hint">ä¸‰å…ƒç»„æå–ã€å›¾è°±æŸ¥è¯¢å’Œæ¨ç†</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="time-aware-enabled" />
                            <span class="checkbox-text">â° æ—¶é—´æ„ŸçŸ¥è®°å¿†</span>
                        </label>
                        <div class="setting-hint">æ—¶é—´çº¿ç®¡ç†ã€é—å¿˜æ›²çº¿å’Œé—´éš”é‡å¤</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="st-integration-enabled" />
                            <span class="checkbox-text">ğŸ”— SillyTavernæ·±åº¦é›†æˆ</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨è®°å¿†æ³¨å…¥å’Œäº‹ä»¶é›†æˆ</div>
                    </div>
                </div>

                <!-- ğŸš€ AIè®°å¿†æ€»ç»“è®¾ç½® -->
                <div class="setting-row ai-memory-section">
                    <h5 style="color: #4CAF50; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ§  AIè®°å¿†æ€»ç»“</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-memory-enabled" />
                            <span class="checkbox-text">å¯ç”¨AIè®°å¿†æ€»ç»“</span>
                        </label>
                        <div class="setting-hint">ä½¿ç”¨AIæ™ºèƒ½åˆ†æå’Œæ€»ç»“æ¶ˆæ¯å†…å®¹ <span style="color: #FF9800;">âš ï¸ éœ€è¦é…åˆæ·±åº¦è®°å¿†ç®¡ç†å™¨ä½¿ç”¨</span></div>
                    </div>
                </div>

                <div class="setting-row ai-memory-options" id="memory-ai-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #4CAF50; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-message-level-summary" />
                            <span class="checkbox-text">æ¶ˆæ¯çº§åˆ«æ€»ç»“</span>
                        </label>
                        <div class="setting-hint">ä¸ºæ¯æ¡é‡è¦æ¶ˆæ¯ç”Ÿæˆæ™ºèƒ½æ€»ç»“</div>
                    </div>
                </div>

                <div class="setting-row ai-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #4CAF50; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-ai-importance-threshold">é‡è¦æ€§é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-ai-importance-threshold" min="0.1" max="1.0" step="0.1" value="0.6" />
                            <span class="input-unit" id="memory-ai-importance-value">60%</span>
                        </div>
                        <div class="setting-hint">åªæ€»ç»“é‡è¦æ€§è¶…è¿‡æ­¤é˜ˆå€¼çš„æ¶ˆæ¯</div>
                    </div>
                </div>

                <!-- ğŸ†• AIè®°å¿†æ€»ç»“APIæ¨¡å¼é€‰æ‹© -->
                <div class="setting-row ai-memory-options ai-memory-api-mode-selection" id="ai-memory-api-mode-selection" style="display: none; margin-left: 20px; border-left: 2px solid #4CAF50; padding-left: 15px;">
                    <div class="setting-group">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--theme-text-primary, #e0e0e0);">ğŸ“Š æ•°æ®ç”Ÿæˆæ¨¡å¼</h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button type="button" class="ai-memory-api-mode-btn" data-mode="auto" style="
                                flex: 1;
                                padding: 10px 14px;
                                background: linear-gradient(135deg, #4CAF50, #45a049);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-weight: 500;
                                font-size: 12px;
                            ">
                                ğŸ”„ è‡ªåŠ¨æ¨¡å¼
                            </button>
                            <button type="button" class="ai-memory-api-mode-btn" data-mode="main" style="
                                flex: 1;
                                padding: 10px 14px;
                                background: var(--theme-bg-tertiary, #1a1a1a);
                                color: var(--theme-text-primary, #e0e0e0);
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 12px;
                            ">
                                ğŸ¯ ä¸»APIæ¨¡å¼
                            </button>
                            <button type="button" class="ai-memory-api-mode-btn" data-mode="custom" style="
                                flex: 1;
                                padding: 10px 14px;
                                background: var(--theme-bg-tertiary, #1a1a1a);
                                color: var(--theme-text-primary, #e0e0e0);
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 12px;
                            ">
                                ğŸ”Œ è‡ªå®šä¹‰APIæ¨¡å¼
                            </button>
                        </div>
                        <div class="ai-memory-mode-description" style="font-size: 12px; color: var(--theme-text-secondary, #999); line-height: 1.5;">
                            <div class="auto-mode-desc" style="display: block;">
                                <strong style="color: #4CAF50;">è‡ªåŠ¨æ¨¡å¼ï¼š</strong>è·Ÿéšå…¨å±€è‡ªå®šä¹‰APIé…ç½®ï¼Œå¦‚æœå…¨å±€å¯ç”¨è‡ªå®šä¹‰APIåˆ™ä½¿ç”¨è‡ªå®šä¹‰APIï¼Œå¦åˆ™ä½¿ç”¨ä¸»API
                            </div>
                            <div class="main-mode-desc" style="display: none;">
                                <strong style="color: #667eea;">ä¸»APIæ¨¡å¼ï¼š</strong>å¼ºåˆ¶ä½¿ç”¨SillyTavernä¸»APIç”ŸæˆAIè®°å¿†æ€»ç»“ï¼Œæ™ºèƒ½æç¤ºè¯ä¼šæ³¨å…¥åˆ°ä¸»APIå¯¹è¯ä¸­
                            </div>
                            <div class="custom-mode-desc" style="display: none;">
                                <strong style="color: #f59e0b;">è‡ªå®šä¹‰APIæ¨¡å¼ï¼š</strong>å¼ºåˆ¶ä½¿ç”¨ç‹¬ç«‹çš„è‡ªå®šä¹‰APIç”ŸæˆAIè®°å¿†æ€»ç»“ï¼Œæ™ºèƒ½æç¤ºè¯ä¸ä¼šæ³¨å…¥ä¸»APIï¼ˆéœ€åœ¨APIé…ç½®é¢æ¿ä¸­è®¾ç½®ï¼‰
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“è®¾ç½® -->
                <div class="setting-row ai-memory-database-section">
                    <h5 style="color: #9C27B0; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-memory-database-enabled" />
                            <span class="checkbox-text">å¯ç”¨AIè®°å¿†æ•°æ®åº“</span>
                        </label>
                        <div class="setting-hint">åŸºäºå…³é”®è¯å’Œé‡è¦æ€§çš„æ™ºèƒ½è®°å¿†ç´¢å¼•å’Œæ£€ç´¢ç³»ç»Ÿ <span style="color: #FF9800;">âš ï¸ åªåœ¨ä¸»APIç”Ÿæˆå‰§æƒ…æ—¶æ³¨å…¥</span></div>
                    </div>
                </div>

                <div class="setting-row ai-memory-database-options" id="memory-ai-memory-database-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-db-auto-indexing" checked />
                            <span class="checkbox-text">è‡ªåŠ¨ç´¢å¼•æ–°è®°å¿†</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨å»ºç«‹AIè®°å¿†æ€»ç»“çš„å…³é”®è¯ç´¢å¼•</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-db-thinking-interface" checked />
                            <span class="checkbox-text">å¯ç”¨AIæ€è€ƒæ¥å£</span>
                        </label>
                        <div class="setting-hint">å…è®¸AIåœ¨ä¸»APIç”Ÿæˆæ—¶é€šè¿‡å…³é”®è¯ä¸»åŠ¨æ£€ç´¢è®°å¿†</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-ai-db-max-results">æœ€å¤§æ£€ç´¢ç»“æœæ•°</label>
                        <div class="input-group">
                            <input type="range" id="memory-ai-db-max-results" min="5" max="50" step="5" value="20" />
                            <span class="input-unit" id="memory-ai-db-max-results-value">20</span>
                        </div>
                        <div class="setting-hint">å•æ¬¡æ£€ç´¢è¿”å›çš„æœ€å¤§è®°å¿†æ•°é‡</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-ai-db-min-importance">æœ€å°é‡è¦æ€§è¿‡æ»¤</label>
                        <div class="input-group">
                            <input type="range" id="memory-ai-db-min-importance" min="0.0" max="1.0" step="0.1" value="0.5" />
                            <span class="input-unit" id="memory-ai-db-min-importance-value">50%</span>
                        </div>
                        <div class="setting-hint">åªç´¢å¼•é‡è¦æ€§é«˜äºæ­¤å€¼çš„è®°å¿†</div>
                    </div>
                </div>

                <!-- ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹è®¾ç½® -->
                <div class="setting-row story-planning-section">
                    <h5 style="color: #E91E63; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-story-planning-enabled" />
                            <span class="checkbox-text">å¯ç”¨å‰§æƒ…è§„åˆ’åŠ©æ‰‹</span>
                        </label>
                        <div class="setting-hint">åŸºäºAIè®°å¿†æ•°æ®åº“çš„æ™ºèƒ½å‰§æƒ…è§„åˆ’å’Œå»ºè®®ç³»ç»Ÿ <span style="color: #FF9800;">âš ï¸ éœ€è¦å¯ç”¨AIè®°å¿†æ•°æ®åº“</span></div>
                    </div>
                </div>

                <div class="setting-row story-planning-options" id="memory-story-planning-options" style="display: none; margin-left: 20px; border-left: 2px solid #E91E63; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-sp-auto-activate" checked />
                            <span class="checkbox-text">è‡ªåŠ¨æ¿€æ´»è§„åˆ’</span>
                        </label>
                        <div class="setting-hint">åœ¨ç”¨æˆ·å‘é€æ¶ˆæ¯å‰è‡ªåŠ¨åˆ†æå¹¶ç”Ÿæˆå‰§æƒ…è§„åˆ’å»ºè®®</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-sp-semantic-analysis" checked />
                            <span class="checkbox-text">å¯ç”¨è¯­ä¹‰åˆ†æ</span>
                        </label>
                        <div class="setting-hint">æ·±åº¦åˆ†ææ¶ˆæ¯å†…å®¹çš„è¯­ä¹‰å’Œæƒ…æ„Ÿ</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-sp-timeline-aware" checked />
                            <span class="checkbox-text">å¯ç”¨æ—¶é—´çº¿æ„ŸçŸ¥</span>
                        </label>
                        <div class="setting-hint">è€ƒè™‘äº‹ä»¶çš„æ—¶é—´é¡ºåºå’Œå‘å±•è¶‹åŠ¿</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-sp-plot-continuity" checked />
                            <span class="checkbox-text">å¯ç”¨å‰§æƒ…è¿ç»­æ€§æ£€æŸ¥</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨æ£€æµ‹å‰§æƒ…ä¸è¿ç»­æˆ–çŸ›ç›¾ä¹‹å¤„</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-sp-detail-level">å»ºè®®è¯¦ç»†ç¨‹åº¦</label>
                        <select id="memory-sp-detail-level" class="setting-select">
                            <option value="brief">ç®€è¦</option>
                            <option value="detailed" selected>è¯¦ç»†</option>
                            <option value="comprehensive">å…¨é¢</option>
                        </select>
                        <div class="setting-hint">æ§åˆ¶å‰§æƒ…è§„åˆ’å»ºè®®çš„è¯¦ç»†ç¨‹åº¦</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-sp-max-keywords">æœ€å¤§å…³é”®è¯æ•°é‡</label>
                        <div class="input-group">
                            <input type="range" id="memory-sp-max-keywords" min="5" max="20" step="1" value="10" />
                            <span class="input-unit" id="memory-sp-max-keywords-value">10</span>
                        </div>
                        <div class="setting-hint">ä»æ¶ˆæ¯ä¸­æå–çš„æœ€å¤§å…³é”®è¯æ•°é‡</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-sp-max-memories">æœ€å¤§è®°å¿†æ£€ç´¢æ•°</label>
                        <div class="input-group">
                            <input type="range" id="memory-sp-max-memories" min="5" max="30" step="5" value="15" />
                            <span class="input-unit" id="memory-sp-max-memories-value">15</span>
                        </div>
                        <div class="setting-hint">å•æ¬¡è§„åˆ’æ£€ç´¢çš„æœ€å¤§è®°å¿†æ•°é‡</div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label" for="memory-sp-min-importance">æœ€å°è®°å¿†é‡è¦æ€§</label>
                        <div class="input-group">
                            <input type="range" id="memory-sp-min-importance" min="0.0" max="1.0" step="0.1" value="0.5" />
                            <span class="input-unit" id="memory-sp-min-importance-value">50%</span>
                        </div>
                        <div class="setting-hint">åªä½¿ç”¨é‡è¦æ€§é«˜äºæ­¤å€¼çš„è®°å¿†è¿›è¡Œè§„åˆ’</div>
                    </div>
                </div>

                <!-- ğŸ”§ è¯­ä¹‰æœç´¢åŠŸèƒ½å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨å‘é‡åŠŸèƒ½é¢æ¿çš„AIè‡ªåŠ¨æ£€ç´¢ -->

                <!-- ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†è®¾ç½® -->
                <div class="setting-row deep-memory-section">
                    <h5 style="color: #9C27B0; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-deep-memory-enabled" />
                            <span class="checkbox-text">å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†</span>
                        </label>
                        <div class="setting-hint">åŸºäºè®¤çŸ¥å¿ƒç†å­¦çš„å››å±‚è®°å¿†æ¶æ„ç®¡ç†</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" id="memory-deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-auto-memory-migration" />
                            <span class="checkbox-text">è‡ªåŠ¨è®°å¿†è¿ç§»</span>
                        </label>
                        <div class="setting-hint">æ ¹æ®é‡è¦æ€§è‡ªåŠ¨åœ¨è®°å¿†å±‚çº§é—´è¿ç§»</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-memory-importance-threshold">è®°å¿†é‡è¦æ€§é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-memory-importance-threshold" min="0.1" max="1.0" step="0.05" value="0.6" />
                            <span class="input-unit" id="memory-memory-importance-value">60%</span>
                        </div>
                        <div class="setting-hint">çŸ­æœŸè®°å¿†å‡çº§ä¸ºé•¿æœŸè®°å¿†çš„é‡è¦æ€§é˜ˆå€¼</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-memory-conflict-resolution" />
                            <span class="checkbox-text">è®°å¿†å†²çªè§£å†³</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨æ£€æµ‹å’Œè§£å†³çŸ›ç›¾çš„è®°å¿†å†…å®¹</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-memory-capacity">è®°å¿†å®¹é‡è®¾ç½®</label>
                        <div class="memory-capacity-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">æ„ŸçŸ¥è®°å¿†</label>
                                <input type="number" id="memory-sensory-capacity" min="50" max="500" value="100" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">çŸ­æœŸè®°å¿†</label>
                                <input type="number" id="memory-short-term-capacity" min="200" max="2000" value="500" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">é•¿æœŸè®°å¿†</label>
                                <input type="number" id="memory-long-term-capacity" min="1000" max="10000" value="5000" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">æ·±åº¦å½’æ¡£</label>
                                <input type="number" id="memory-deep-archive-capacity" min="10000" max="100000" value="50000" style="width: 100%;" />
                            </div>
                        </div>
                        <div class="setting-hint">å„è®°å¿†å±‚çº§çš„æœ€å¤§å®¹é‡è®¾ç½®</div>
                    </div>
                </div>

                <!-- ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½® -->
                <div class="setting-row intelligent-classifier-section">
                    <h5 style="color: #FF5722; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-intelligent-classifier-enabled" />
                            <span class="checkbox-text">å¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</span>
                        </label>
                        <div class="setting-hint">AIé©±åŠ¨çš„æ™ºèƒ½è®°å¿†åˆ†ç±»ç³»ç»Ÿ <span style="color: #FF9800;">âš ï¸ éœ€è¦é…åˆæ·±åº¦è®°å¿†ç®¡ç†å™¨ä½¿ç”¨</span></div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" id="memory-intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-semantic-clustering" />
                            <span class="checkbox-text">è¯­ä¹‰èšç±»åˆ†æ</span>
                        </label>
                        <div class="setting-hint">åŸºäºå‘é‡ç©ºé—´çš„è¯­ä¹‰èšç±»</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-temporal-pattern-recognition" />
                            <span class="checkbox-text">æ—¶åºæ¨¡å¼è¯†åˆ«</span>
                        </label>
                        <div class="setting-hint">è¯†åˆ«è®°å¿†çš„æ—¶é—´æ¨¡å¼å’Œå‘¨æœŸæ€§</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-importance-prediction" />
                            <span class="checkbox-text">é‡è¦æ€§é¢„æµ‹</span>
                        </label>
                        <div class="setting-hint">é¢„æµ‹è®°å¿†çš„æœªæ¥é‡è¦æ€§</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-classification-confidence-threshold">åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-classification-confidence-threshold" min="0.5" max="1.0" step="0.05" value="0.7" />
                            <span class="input-unit" id="memory-classification-confidence-value">70%</span>
                        </div>
                        <div class="setting-hint">åˆ†ç±»å†³ç­–çš„æœ€ä½ç½®ä¿¡åº¦è¦æ±‚</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-adaptive-learning" />
                            <span class="checkbox-text">è‡ªé€‚åº”å­¦ä¹ </span>
                        </label>
                        <div class="setting-hint">ä»ç”¨æˆ·åé¦ˆä¸­å­¦ä¹ å’Œæ”¹è¿›</div>
                    </div>
                </div>

                <!-- ğŸ—‘ï¸ æ•°æ®æ¸…ç†å·¥å…· -->
                <div class="setting-row memory-cleanup-section" style="margin-top: 30px; border-top: 2px solid var(--SmartThemeBorderColor, #333); padding-top: 20px;">
                    <h5 style="color: #F44336; margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">ğŸ—‘ï¸ æ•°æ®æ¸…ç†å·¥å…·</h5>
                    <div class="setting-hint" style="margin-bottom: 15px; color: #FF9800;">
                        âš ï¸ è­¦å‘Šï¼šæ¸…ç†æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼å»ºè®®åœ¨æ¸…ç†å‰å…ˆå¯¼å‡ºå¤‡ä»½æ•°æ®ã€‚
                    </div>

                    <div class="cleanup-buttons-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <!-- æ¸…ç†AIè®°å¿†æ•°æ®åº“ -->
                        <div class="cleanup-button-wrapper">
                            <button class="cleanup-btn" id="cleanup-ai-memory-database" style="
                                width: 100%;
                                padding: 8px 16px;
                                background: linear-gradient(135deg, #FF5722 0%, #F44336 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
                            ">
                                ğŸ—‘ï¸ æ¸…ç†è®°å¿†ç´¢å¼•
                            </button>
                            <div class="setting-hint" style="margin-top: 8px; font-size: 12px;">
                                æ¸…ç©ºAIè®°å¿†æ•°æ®åº“çš„å…³é”®è¯ç´¢å¼•å’Œæ£€ç´¢ç¼“å­˜
                            </div>
                        </div>

                        <!-- æ¸…ç†å‘é‡åŒ–æ•°æ® -->
                        <div class="cleanup-button-wrapper">
                            <button class="cleanup-btn" id="cleanup-vector-data" style="
                                width: 100%;
                                padding: 8px 16px;
                                background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
                            ">
                                ğŸ—‘ï¸ æ¸…ç†å‘é‡åŒ–æ•°æ®
                            </button>
                            <div class="setting-hint" style="margin-top: 8px; font-size: 12px;">
                                æ¸…ç©ºæ‰€æœ‰å‘é‡ç´¢å¼•å’ŒåµŒå…¥æ•°æ®
                            </div>
                        </div>

                        <!-- æ¸…ç†æ·±åº¦è®°å¿†æ•°æ® -->
                        <div class="cleanup-button-wrapper">
                            <button class="cleanup-btn" id="cleanup-deep-memory" style="
                                width: 100%;
                                padding: 8px 16px;
                                background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
                            ">
                                ğŸ—‘ï¸ æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®
                            </button>
                            <div class="setting-hint" style="margin-top: 8px; font-size: 12px;">
                                æ¸…ç©ºå››å±‚è®°å¿†æ¶æ„ä¸­çš„æ‰€æœ‰æ•°æ®
                            </div>
                        </div>

                        <!-- æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ® -->
                        <div class="cleanup-button-wrapper">
                            <button class="cleanup-btn" id="cleanup-knowledge-graph" style="
                                width: 100%;
                                padding: 8px 16px;
                                background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
                            ">
                                ğŸ—‘ï¸ æ¸…ç†çŸ¥è¯†å›¾è°±
                            </button>
                            <div class="setting-hint" style="margin-top: 8px; font-size: 12px;">
                                æ¸…ç©ºæ‰€æœ‰çŸ¥è¯†å›¾è°±ä¸‰å…ƒç»„å’Œå…³ç³»æ•°æ®
                            </div>
                        </div>
                    </div>

                    <!-- å±é™©æ“ä½œï¼šæ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ® -->
                    <div class="cleanup-danger-zone" style="margin-top: 25px; padding: 15px; background: rgba(244, 67, 54, 0.1); border: 2px solid #F44336; border-radius: 8px;">
                        <h6 style="color: #F44336; margin: 0 0 10px 0; font-size: 13px; font-weight: 600;">
                            âš ï¸ å±é™©æ“ä½œåŒºåŸŸ
                        </h6>
                        <button class="cleanup-btn-danger" id="cleanup-all-memory-data" style="
                            width: 100%;
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
                            color: white;
                            border: 2px solid #F44336;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.4);
                        ">
                            ğŸ’¥ æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®ï¼ˆå±é™©ï¼‰
                        </button>
                        <div class="setting-hint" style="margin-top: 10px; font-size: 12px; color: #F44336;">
                            âš ï¸ æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰è®°å¿†å¢å¼ºç›¸å…³æ•°æ®ï¼ŒåŒ…æ‹¬AIè®°å¿†ã€å‘é‡æ•°æ®ã€æ·±åº¦è®°å¿†ã€çŸ¥è¯†å›¾è°±ã€ç”¨æˆ·ç”»åƒç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ åˆ›å»ºå‘é‡åŠŸèƒ½é¢æ¿
     */
    createVectorFunctionPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ”® å‘é‡åŠŸèƒ½ - è¯­æ–™åº“çŸ¥è¯†åº“</h3>
                <div class="header-description">
                    <p>ä¸Šä¼ åŒäººæ–‡å°è¯´ï¼Œå‘é‡åŒ–å¤„ç†åæ„å»ºå¯æ£€ç´¢çš„çŸ¥è¯†åº“ï¼Œä¸ºAIæä¾›å¤–æŒ‚çŸ¥è¯†</p>
                    <p style="color: #FFA726; font-size: 12px; margin-top: 8px; padding: 8px; background: rgba(255, 167, 38, 0.1); border-radius: 4px;">
                        ğŸ’¡ æç¤ºï¼šå‘é‡åŒ–APIé…ç½®è¯·å‰å¾€"è‡ªå®šä¹‰API"é¢æ¿ â†’ ç‚¹å‡»"ğŸ§  å‘é‡åŒ–API"æŒ‰é’®è¿›è¡Œè®¾ç½®
                    </p>
                </div>
            </div>

            <div class="content-body">
                <!-- ğŸ“ å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ -->
                <div class="vector-file-management-section">
                    <h4 style="color: #9C27B0; margin: 15px 0 10px 0;">ğŸ“ å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ</h4>

                    <!-- æ–‡ä»¶ç±»å‹æ ‡ç­¾é¡µ -->
                    <div class="vector-file-tabs" style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--theme-border-color, #333); padding-bottom: 10px;">
                        <button class="vector-file-tab active" data-file-type="corpus" style="
                            flex: 1;
                            padding: 10px 16px;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: none;
                            border-radius: 6px 6px 0 0;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                        ">
                            ğŸ“š è¯­æ–™åº“
                        </button>
                        <button class="vector-file-tab" data-file-type="summary" style="
                            flex: 1;
                            padding: 10px 16px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            color: var(--theme-text-primary, #ddd);
                            border: none;
                            border-radius: 6px 6px 0 0;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                        ">
                            ğŸ“ æ€»ç»“
                        </button>
                        <button class="vector-file-tab" data-file-type="memory" style="
                            flex: 1;
                            padding: 10px 16px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            color: var(--theme-text-primary, #ddd);
                            border: none;
                            border-radius: 6px 6px 0 0;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                        ">
                            ğŸ§  è®°å¿†
                        </button>
                    </div>

                    <!-- ä½œç”¨åŸŸåˆ‡æ¢ -->
                    <div class="vector-scope-toggle" style="margin-bottom: 15px; padding: 12px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: var(--theme-text-primary, #ddd);">ä½œç”¨åŸŸæ¨¡å¼ï¼š</span>
                                <span id="current-scope-mode" style="color: var(--theme-primary-color, #4CAF50); font-weight: 600; margin-left: 8px;">å±€éƒ¨æ¨¡å¼</span>
                            </div>
                            <button id="toggle-scope-btn" class="btn btn-secondary" style="padding: 6px 16px; font-size: 13px;">
                                ğŸ”„ åˆ‡æ¢ä¸ºå…¨å±€æ¨¡å¼
                            </button>
                        </div>
                        <div class="setting-hint" style="margin-top: 8px; font-size: 12px;">
                            <strong>å±€éƒ¨æ¨¡å¼ï¼š</strong>åªåœ¨å½“å‰èŠå¤©ä¸­æ˜¾ç¤ºå’Œæ£€ç´¢ | <strong>å…¨å±€æ¨¡å¼ï¼š</strong>åœ¨æ‰€æœ‰èŠå¤©ä¸­æ˜¾ç¤ºå’Œæ£€ç´¢
                        </div>
                    </div>

                    <!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
                    <div id="vector-file-list-container" style="min-height: 200px; padding: 15px; background: var(--theme-bg-primary, #1a1a1a); border: 1px solid var(--theme-border-color, #333); border-radius: 6px;">
                        <div style="text-align: center; padding: 40px; color: var(--theme-text-secondary, #888);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‚</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">æš‚æ— å‘é‡åŒ–æ–‡ä»¶</div>
                            <div style="font-size: 13px;">è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶è¿›è¡Œå‘é‡åŒ–å¤„ç†</div>
                        </div>
                    </div>
                </div>

                <div style="margin: 20px 0; border-top: 2px solid var(--theme-border-color, #333);"></div>
                <!-- ğŸ“š è¯­æ–™åº“ç®¡ç†åŒºåŸŸ -->
                <div class="vector-corpus-section">
                    <h4 style="color: #4CAF50; margin: 15px 0 10px 0;">ğŸ“š è¯­æ–™åº“ç®¡ç†</h4>

                    <!-- è¯­æ–™åº“åˆ—è¡¨ -->
                    <div class="corpus-list-container" style="
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 20px;
                        background: var(--theme-bg-secondary, #1a1a1a);
                    ">
                        <div class="corpus-list-header" style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                        ">
                            <span style="font-weight: 600; color: var(--theme-text-primary, #ddd);">
                                å·²ä¸Šä¼ çš„è¯­æ–™åº“ (<span id="corpus-count">0</span>)
                            </span>
                            <button id="refresh-corpus-list" style="
                                padding: 6px 12px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                                cursor: pointer;
                            ">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>

                        <div id="corpus-list" style="
                            max-height: 300px;
                            overflow-y: auto;
                        ">
                            <div class="no-corpus" style="
                                text-align: center;
                                padding: 40px 20px;
                                color: var(--theme-text-secondary, #888);
                            ">
                                æš‚æ— è¯­æ–™åº“ï¼Œè¯·ä¸Šä¼ å°è¯´æ–‡ä»¶
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="file-upload-section" style="
                        border: 2px dashed var(--theme-border-color, #333);
                        border-radius: 8px;
                        padding: 30px;
                        text-align: center;
                        margin-bottom: 20px;
                        background: var(--theme-bg-secondary, #1a1a1a);
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " id="file-upload-area">
                        <div class="upload-icon" style="font-size: 48px; margin-bottom: 15px;">ğŸ“¤</div>
                        <div class="upload-text" style="
                            font-size: 16px;
                            color: var(--theme-text-primary, #ddd);
                            margin-bottom: 10px;
                        ">
                            ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ 
                        </div>
                        <div class="upload-hint" style="
                            font-size: 12px;
                            color: var(--theme-text-secondary, #888);
                        ">
                            æ”¯æŒ .txt, .md æ ¼å¼çš„å°è¯´æ–‡ä»¶
                        </div>
                        <input type="file" id="novel-file-input" accept=".txt,.md" style="display: none;">
                    </div>

                    <!-- ä¸Šä¼ è¿›åº¦æ˜¾ç¤º -->
                    <div id="upload-progress-container" style="display: none; margin-top: 15px; padding: 15px; background: var(--theme-bg-secondary, #1a1a1a); border-radius: 8px; border: 1px solid var(--theme-border-color, #333);">
                        <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="progress-text" style="color: var(--theme-text-primary, #ddd); font-size: 14px; font-weight: 600;">å¤„ç†ä¸­...</span>
                            <button id="abort-vectorization-btn" style="
                                padding: 4px 12px;
                                background: linear-gradient(135deg, #f44336, #e91e63);
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: 600;
                                transition: all 0.2s;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ğŸ›‘ ä¸­æ­¢
                            </button>
                        </div>
                        <div style="
                            width: 100%;
                            height: 24px;
                            background: var(--theme-bg-primary, #111);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 12px;
                            overflow: hidden;
                            position: relative;
                        ">
                            <div id="progress-bar" style="
                                height: 100%;
                                width: 0%;
                                background: linear-gradient(90deg, #4CAF50, #8BC34A);
                                transition: width 0.3s ease;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <span id="progress-percentage" style="
                                    position: absolute;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    color: var(--theme-text-primary, #ddd);
                                    font-size: 12px;
                                    font-weight: 600;
                                    text-shadow: 0 0 4px rgba(0,0,0,0.5);
                                ">0%</span>
                            </div>
                        </div>
                        <div id="progress-details" style="margin-top: 8px; color: var(--theme-text-secondary, #888); font-size: 12px;">
                            å‡†å¤‡ä¸­...
                        </div>
                    </div>
                </div>

                <!-- âš™ï¸ åˆ†å—é…ç½®åŒºåŸŸ -->
                <div class="vectorization-config-section">
                    <h4 style="color: #2196F3; margin: 15px 0 10px 0;">âš™ï¸ åˆ†å—é…ç½®</h4>

                    <div class="setting-row">
                        <label>åˆ†å—å¤§å°</label>
                        <input type="number" id="vector-chunk-size" value="500" min="100" max="2000" step="100" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 4px;
                            background: var(--theme-bg-primary, #111);
                            color: var(--theme-text-primary, #ddd);
                        ">
                        <div class="setting-hint">å°†å°è¯´å†…å®¹åˆ†å‰²ä¸ºå¤šå¤§çš„å—è¿›è¡Œå‘é‡åŒ–ï¼ˆå­—ç¬¦æ•°ï¼‰</div>
                    </div>

                    <div class="setting-row">
                        <label>é‡å å¤§å°</label>
                        <input type="number" id="vector-overlap-size" value="50" min="0" max="500" step="10" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 4px;
                            background: var(--theme-bg-primary, #111);
                            color: var(--theme-text-primary, #ddd);
                        ">
                        <div class="setting-hint">ç›¸é‚»å—ä¹‹é—´çš„é‡å å­—ç¬¦æ•°ï¼Œç”¨äºä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§</div>
                    </div>

                    <div class="setting-row">
                        <label>æ‰¹å¤„ç†å¤§å°</label>
                        <input type="number" id="vector-batch-size" value="10" min="1" max="50" step="1" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 4px;
                            background: var(--theme-bg-primary, #111);
                            color: var(--theme-text-primary, #ddd);
                        ">
                        <div class="setting-hint">æ¯æ‰¹å¤„ç†çš„å—æ•°ï¼Œè¾ƒå°çš„å€¼å¯ä»¥é¿å…å†…å­˜é—®é¢˜ï¼ˆæ¨è10ï¼‰</div>
                    </div>
                </div>

                <!-- ğŸ§  æ™ºèƒ½åˆ†æé…ç½®åŒºåŸŸ -->
                <div class="smart-analysis-section">
                    <h4 style="color: #FF6B6B; margin: 15px 0 10px 0;">ğŸ§  æ™ºèƒ½åˆ†æåŠŸèƒ½</h4>
                    <div style="
                        padding: 12px;
                        background: rgba(255, 107, 107, 0.1);
                        border-radius: 6px;
                        border-left: 3px solid #FF6B6B;
                        margin-bottom: 15px;
                    ">
                        <p style="margin: 0; font-size: 13px; color: var(--theme-text-primary, #ddd);">
                            ğŸ’¡ å¯ç”¨æ™ºèƒ½åˆ†æåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–å‰§æƒ…æ¢—æ¦‚ã€æ–‡é£ç‰¹å¾ã€æ—¶é—´çº¿å’Œå…³é”®åœºæ™¯ï¼Œè®©AIæ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨è¯­æ–™åº“å†…å®¹
                        </p>
                    </div>

                    <div class="setting-row">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="enable-smart-analysis" style="width: auto;">
                            <span>å¯ç”¨æ™ºèƒ½åˆ†æ</span>
                        </label>
                        <div class="setting-hint">å‘é‡åŒ–æ—¶è‡ªåŠ¨åˆ†æå°è¯´å†…å®¹ï¼Œæå–å…³é”®ä¿¡æ¯</div>
                    </div>

                    <div id="smart-analysis-options" style="display: none; margin-top: 15px; padding-left: 20px;">
                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="extract-plot-summary" checked style="width: auto;">
                                <span>ğŸ“– æå–å‰§æƒ…æ¢—æ¦‚</span>
                            </label>
                            <div class="setting-hint">è‡ªåŠ¨ç”Ÿæˆå°è¯´çš„å‰§æƒ…æ¢—æ¦‚å’Œä¸»è¦æƒ…èŠ‚</div>
                        </div>

                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="analyze-writing-style" checked style="width: auto;">
                                <span>âœï¸ åˆ†ææ–‡é£ç‰¹å¾</span>
                            </label>
                            <div class="setting-hint">åˆ†æå°è¯´çš„å†™ä½œé£æ ¼ã€è¯­è¨€ç‰¹ç‚¹ã€å¸¸ç”¨è¯æ±‡ç­‰</div>
                        </div>

                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="extract-timeline" checked style="width: auto;">
                                <span>â° æå–æ—¶é—´çº¿</span>
                            </label>
                            <div class="setting-hint">è¯†åˆ«å¹¶æ•´ç†å°è¯´ä¸­çš„æ—¶é—´çº¿å’Œäº‹ä»¶é¡ºåº</div>
                        </div>

                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="mark-key-scenes" checked style="width: auto;">
                                <span>ğŸ¬ æ ‡è®°å…³é”®åœºæ™¯</span>
                            </label>
                            <div class="setting-hint">è¯†åˆ«é‡è¦çš„å‰§æƒ…è½¬æŠ˜ç‚¹å’Œå…³é”®åœºæ™¯</div>
                        </div>

                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="extract-characters" checked style="width: auto;">
                                <span>ğŸ‘¥ æå–è§’è‰²ä¿¡æ¯</span>
                            </label>
                            <div class="setting-hint">è¯†åˆ«ä¸»è¦è§’è‰²åŠå…¶ç‰¹å¾ã€å…³ç³»</div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ” AIæ£€ç´¢é…ç½®åŒºåŸŸ -->
                <div class="ai-retrieval-section">
                    <h4 style="color: #9C27B0; margin: 15px 0 10px 0;">ğŸ” AIæ£€ç´¢é…ç½®</h4>
                    <div style="
                        padding: 12px;
                        background: rgba(156, 39, 176, 0.1);
                        border-radius: 6px;
                        border-left: 3px solid #9C27B0;
                        margin-bottom: 15px;
                    ">
                        <p style="margin: 0; font-size: 13px; color: var(--theme-text-primary, #ddd);">
                            ğŸ’¡ å¯ç”¨åï¼ŒAIåœ¨å¯¹è¯æ—¶ä¼šè‡ªåŠ¨æ£€ç´¢ç›¸å…³çš„è¯­æ–™åº“å†…å®¹ï¼Œå¹¶æ³¨å…¥åˆ°æç¤ºè¯ä¸­
                        </p>
                    </div>

                    <div class="setting-row">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="enable-ai-retrieval" style="width: auto;">
                            <span>å¯ç”¨AIè‡ªåŠ¨æ£€ç´¢</span>
                        </label>
                        <div class="setting-hint">AIå¯¹è¯æ—¶è‡ªåŠ¨æ£€ç´¢è¯­æ–™åº“ä¸­çš„ç›¸å…³å†…å®¹</div>
                    </div>

                    <div id="ai-retrieval-options" style="display: none; margin-top: 15px; padding-left: 20px;">
                        <div class="setting-row">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="enable-multi-recall" style="width: auto;">
                                <span>ğŸ¯ å¯ç”¨å¤šè·¯å¬å›+é‡æ’åº</span>
                            </label>
                            <div class="setting-hint" style="color: #FFA726;">
                                <strong>æ™ºèƒ½æ£€ç´¢å¢å¼ºï¼š</strong>å…³é”®è¯æ£€ç´¢+è¯­ä¹‰æ£€ç´¢åŒè·¯å¬å›ï¼Œé‡æ’åºæ¨¡å‹ç²¾å‡†ç­›é€‰ï¼Œé¢„æµ‹æ€§æ£€ç´¢æå‰åŒ¹é…ç”¨æˆ·æ„å›¾
                                <br>
                                <small style="color: #888;">éœ€è¦åœ¨"è‡ªå®šä¹‰API â†’ å‘é‡åŒ–API"ä¸­é…ç½®é‡æ’åºæ¨¡å‹</small>
                            </div>
                        </div>

                        <div class="setting-row">
                            <label>æ£€ç´¢æ•°é‡</label>
                            <input type="number" id="retrieval-top-k" value="10" min="1" max="50" step="1" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">æ¯æ¬¡æ£€ç´¢è¿”å›çš„æœ€ç›¸å…³å†…å®¹æ•°é‡ï¼ˆé»˜è®¤ï¼š10ï¼‰</div>
                        </div>

                        <div class="setting-row">
                            <label>ç›¸ä¼¼åº¦é˜ˆå€¼</label>
                            <input type="number" id="retrieval-threshold" value="0.5" min="0" max="1" step="0.05" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">åªè¿”å›ç›¸ä¼¼åº¦é«˜äºæ­¤é˜ˆå€¼çš„å†…å®¹ï¼ˆ0-1ï¼Œé»˜è®¤ï¼š0.5ï¼‰</div>
                        </div>

                        <div class="setting-row" id="rerank-threshold-row" style="display: none;">
                            <label>é‡æ’åºé˜ˆå€¼</label>
                            <input type="number" id="rerank-threshold" value="10" min="0" max="100" step="1" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">åªæœ‰å½“æ£€ç´¢æ•°é‡é«˜äºæ­¤é˜ˆå€¼æ—¶æ‰è°ƒç”¨é‡æ’åºæ¨¡å‹ï¼ˆé»˜è®¤ï¼š10ï¼Œè®¾ä¸º0åˆ™æ€»æ˜¯ä½¿ç”¨é‡æ’åºï¼‰</div>
                        </div>

                        <div class="setting-row">
                            <label>æ³¨å…¥ä½ç½®</label>
                            <select id="retrieval-injection-position" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                                <option value="system">ç³»ç»Ÿæç¤ºè¯</option>
                                <option value="after_character">è§’è‰²æè¿°å</option>
                                <option value="before_examples">ç¤ºä¾‹å¯¹è¯å‰</option>
                                <option value="chat_history">èŠå¤©å†å²ä¸­</option>
                            </select>
                            <div class="setting-hint">æ£€ç´¢åˆ°çš„å†…å®¹æ³¨å…¥åˆ°æç¤ºè¯çš„ä½ç½®</div>
                        </div>

                        <div class="setting-row">
                            <label>æ£€ç´¢æ¥æº</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="enable-corpus-retrieval" checked style="width: auto;">
                                    <span>è¯­æ–™åº“æ£€ç´¢</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="enable-memory-retrieval" checked style="width: auto;">
                                    <span>è®°å¿†æ£€ç´¢</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="enable-summary-retrieval" checked style="width: auto;">
                                    <span>æ€»ç»“æ£€ç´¢</span>
                                </label>
                            </div>
                            <div class="setting-hint">é€‰æ‹©è¦æ£€ç´¢çš„æ•°æ®æ¥æº</div>
                        </div>

                        <div class="setting-row">
                            <label>ç¼“å­˜è¶…æ—¶</label>
                            <input type="number" id="retrieval-cache-timeout" value="5000" min="0" max="60000" step="1000" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">æŸ¥è¯¢ç»“æœç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤æ£€ç´¢</div>
                        </div>

                        <div class="setting-row">
                            <label>æ³¨å…¥æ·±åº¦</label>
                            <input type="number" id="retrieval-injection-depth" value="0" min="0" max="10" step="1" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">æç¤ºè¯æ³¨å…¥æ·±åº¦ï¼ˆ0=æœ€é¡¶å±‚ï¼‰</div>
                        </div>

                        <div class="setting-row">
                            <label>æ³¨å…¥ä¼˜å…ˆçº§</label>
                            <input type="number" id="retrieval-injection-priority" value="0" min="-100" max="100" step="1" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #111);
                                color: var(--theme-text-primary, #ddd);
                            ">
                            <div class="setting-hint">æç¤ºè¯æ³¨å…¥ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæç¤ºè¯è®¾ç½®é¢æ¿
     */
    createPromptSettingsPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ§  æç¤ºè¯è®¾ç½®</h3>
                <div class="header-description">
                    <p>é…ç½®AIæç¤ºè¯çš„ç”Ÿæˆæ–¹å¼ï¼šæ™ºèƒ½æç¤ºè¯æˆ–è‡ªå®šä¹‰æç¤ºè¯</p>
                </div>
            </div>

            <div class="content-body">
                <!-- æç¤ºè¯æ¨¡å¼é€‰æ‹© -->
                <div class="settings-group">
                    <h4>ğŸ“‹ æç¤ºè¯æ¨¡å¼</h4>
                    <div class="form-group">
                        <label>é€‰æ‹©æç¤ºè¯æ¨¡å¼</label>
                        <select id="prompt-mode-select" name="promptSettings.mode" style="width: 100%; padding: 8px; border-radius: 4px;">
                            <option value="smart">ğŸ§  æ™ºèƒ½æç¤ºè¯ - ä½¿ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–çš„æç¤ºè¯å†…å®¹</option>
                            <option value="custom">âœï¸ è‡ªå®šä¹‰æç¤ºè¯ - ä½¿ç”¨æ‚¨è‡ªå®šä¹‰çš„æç¤ºè¯å†…å®¹ï¼Œå…³é—­æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ</option>
                        </select>
                        <small>é€‰æ‹©æç¤ºè¯çš„ç”Ÿæˆæ–¹å¼</small>
                    </div>
                </div>

                <!-- æ™ºèƒ½æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group smart-prompt-config" id="smart-prompt-config">
                    <h4>ğŸ§  æ™ºèƒ½æç¤ºè¯é…ç½®</h4>
                    <div class="smart-prompt-info">
                        <div class="info-card">
                            <div class="info-icon">âœ…</div>
                            <div class="info-content">
                                <h5>æ™ºèƒ½æç¤ºè¯å·²å¯ç”¨</h5>
                                <p>ç³»ç»Ÿå°†æ ¹æ®å½“å‰é¢æ¿é…ç½®å’Œæ•°æ®çŠ¶æ€è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–çš„æç¤ºè¯</p>
                                <ul>
                                    <li>è‡ªåŠ¨åˆ†ææ•°æ®å®Œæ•´æ€§</li>
                                    <li>æ™ºèƒ½é€‰æ‹©æ›´æ–°ç­–ç•¥</li>
                                    <li>åŠ¨æ€ç”Ÿæˆæ ¼å¼çº¦æŸ</li>
                                    <li>ä¼˜åŒ–AIå“åº”è´¨é‡</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group custom-prompt-config" id="custom-prompt-config" style="display: none;">
                    <h4>âœï¸ è‡ªå®šä¹‰æç¤ºè¯é…ç½®</h4>
                    <div class="form-group">
                        <label>è‡ªå®šä¹‰æç¤ºè¯å†…å®¹</label>
                        <textarea id="custom-prompt-content" name="promptSettings.customContent"
                                  rows="12"
                                  placeholder="è¯·è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯å†…å®¹...

ç¤ºä¾‹ï¼š
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®æ•´ç†å‘˜ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„å¯¹è¯å†…å®¹ï¼Œæå–å¹¶æ•´ç†ç›¸å…³ä¿¡æ¯ã€‚

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
1. ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼šadd é¢æ¿å(è¡Œå· {&quot;åˆ—å·&quot;,&quot;å€¼&quot;})
2. ç¡®ä¿æ•°æ®å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
3. ä¿æŒæ ¼å¼çš„ä¸€è‡´æ€§

è¯·å¼€å§‹å¤„ç†..."
                                  style="width: 100%; min-height: 300px; resize: vertical; font-family: monospace; font-size: 13px;"></textarea>
                        <small>è‡ªå®šä¹‰æç¤ºè¯å°†å®Œå…¨æ›¿ä»£æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿã€‚è¯·ç¡®ä¿åŒ…å«å¿…è¦çš„æ ¼å¼è¦æ±‚å’ŒæŒ‡å¯¼è¯´æ˜ã€‚</small>
                    </div>
                    <div class="form-group">
                        <div class="custom-prompt-stats">
                            <span class="char-count">å­—ç¬¦æ•°: <span id="custom-prompt-char-count">0</span></span>
                            <span class="word-count">å•è¯æ•°: <span id="custom-prompt-word-count">0</span></span>
                            <span class="line-count">è¡Œæ•°: <span id="custom-prompt-line-count">0</span></span>
                        </div>
                    </div>
                    <div class="custom-prompt-warning">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-content">
                            <h5>æ³¨æ„äº‹é¡¹</h5>
                            <p>å¯ç”¨è‡ªå®šä¹‰æç¤ºè¯åï¼Œæ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå°†è¢«å®Œå…¨å…³é—­ã€‚è¯·ç¡®ä¿æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯åŒ…å«ï¼š</p>
                            <ul>
                                <li>æ˜ç¡®çš„æ•°æ®æå–æŒ‡å¯¼</li>
                                <li>æ­£ç¡®çš„è¾“å‡ºæ ¼å¼è¦æ±‚</li>
                                <li>å¿…è¦çš„çº¦æŸå’Œé™åˆ¶è¯´æ˜</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯é¢„è§ˆåŒºåŸŸ -->
                <div class="settings-group">
                    <h4>ğŸ‘ï¸ æç¤ºè¯é¢„è§ˆ</h4>
                    <div class="prompt-preview-container">
                        <div class="preview-toolbar">
                            <button class="btn btn-secondary" id="refresh-preview-btn">
                                <i class="fas fa-refresh"></i> åˆ·æ–°é¢„è§ˆ
                            </button>
                            <span class="preview-status" id="preview-status">å‡†å¤‡å°±ç»ª</span>
                        </div>
                        <div class="prompt-preview" id="prompt-preview">
                            <div class="preview-placeholder">
                                ç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"æŸ¥çœ‹å½“å‰æç¤ºè¯å†…å®¹
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºä¸»é¢˜è®¾ç½®é¢æ¿
     */
    createThemePanel() {
        return `
            <div class="settings-group">
                <div class="theme-header-controls" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div class="theme-header-left">
                        <h3>ğŸ¨ ä¸»é¢˜é¢„è§ˆé€‰æ‹©</h3>
                        <p class="theme-description">é€‰æ‹©æ‚¨å–œæ¬¢çš„ä¸»é¢˜é£æ ¼ï¼Œç‚¹å‡»é¢„è§ˆå›¾å³å¯åº”ç”¨</p>
                    </div>
                    <div class="theme-header-right">
                        <button class="btn btn-primary status-bar-editor-btn" data-action="open-status-bar-editor" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                            <i class="fas fa-edit"></i> çŠ¶æ€æ ç¼–è¾‘
                        </button>
                    </div>
                </div>

                <div class="theme-gallery">
                    ${this.createThemePreviewGrid()}
                </div>
            </div>

            <div class="settings-group">
                <h3>ğŸ­ ä¿¡æ¯æ é£æ ¼é€‰æ‹©</h3>
                <p class="style-description">é€‰æ‹©ä¿¡æ¯æ çš„æ˜¾ç¤ºæ–¹å¼å’Œå¸ƒå±€é£æ ¼</p>

                <div class="style-gallery">
                    ${this.createStylePreviewGrid()}
                </div>
            </div>



            <div class="settings-group custom-theme-group" style="display: none;">
                <h3>è‡ªå®šä¹‰ä¸»é¢˜</h3>
                <div class="color-picker-group">
                    <div class="form-group">
                        <label>ä¸»è‰²è°ƒ</label>
                        <input type="color" name="theme.custom.primary" value="#007bff" />
                    </div>
                    <div class="form-group">
                        <label>èƒŒæ™¯è‰²</label>
                        <input type="color" name="theme.custom.background" value="#1a1a1a" />
                    </div>
                    <div class="form-group">
                        <label>æ–‡å­—è‰²</label>
                        <input type="color" name="theme.custom.text" value="#ffffff" />
                    </div>
                    <div class="form-group">
                        <label>è¾¹æ¡†è‰²</label>
                        <input type="color" name="theme.custom.border" value="#333333" />
                    </div>
                </div>

                <div class="theme-preview">
                    <h4>å®æ—¶é¢„è§ˆ</h4>
                    <div class="preview-box custom-preview">
                        <div class="preview-header">ç¤ºä¾‹æ ‡é¢˜</div>
                        <div class="preview-content">ç¤ºä¾‹å†…å®¹æ–‡å­—</div>
                        <div class="preview-button">ç¤ºä¾‹æŒ‰é’®</div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºé¢æ¿ç®¡ç†é¢æ¿
     */
    createPanelManagementPanel() {
        return `
            <div class="content-header">
                <h3>é¢æ¿ç®¡ç†</h3>
                <div class="header-actions">
                    <button class="btn-action btn-add" data-action="add-custom-panel">
                        æ·»åŠ è‡ªå®šä¹‰é¢æ¿
                    </button>
                    <button class="btn-action btn-refresh" data-action="refresh-panels">
                        åˆ·æ–°
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- é¢æ¿ç®¡ç†ä¸»ä½“ -->
                <div class="panel-management-container">
                    <!-- å·¦ä¾§é¢æ¿åˆ—è¡¨ -->
                    <div class="panel-list-section">
                        <!-- é¢æ¿åˆ†ç±»æ ‡ç­¾ -->
                        <div class="panel-categories">
                            <div class="category-tab active" data-category="all">
                                <span class="category-text">å…¨éƒ¨é¢æ¿</span>
                                <span class="category-count">${this.getTotalPanelCount()}</span>
                            </div>
                        </div>

                        <!-- é¢æ¿åˆ—è¡¨ -->
                        <div class="panel-list-container">
                            <div class="panel-list" data-category="all">
                                ${this.createPanelListItems('all')}
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§é¢æ¿å±æ€§ -->
                    <div class="panel-properties-section">
                        <div class="properties-header">
                            <h4>é¢æ¿å±æ€§</h4>
                            <div class="properties-actions">
                                <button class="btn-small btn-save" data-action="save-panel-properties" disabled style="pointer-events: auto;">
                                    <span class="btn-icon" style="pointer-events: none;">ğŸ’¾</span>
                                    <span class="btn-text" style="pointer-events: none;">ä¿å­˜</span>
                                </button>
                                <button class="btn-small btn-delete" data-action="delete-panel" disabled style="pointer-events: auto;">
                                    <span class="btn-icon" style="pointer-events: none;">ğŸ—‘ï¸</span>
                                    <span class="btn-text" style="pointer-events: none;">åˆ é™¤</span>
                                </button>
                            </div>
                        </div>

                        <div class="properties-content">
                            <div class="no-selection-message">
                                <div class="message-icon">ğŸ›ï¸</div>
                                <div class="message-text">è¯·é€‰æ‹©ä¸€ä¸ªé¢æ¿æ¥æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</div>
                            </div>

                            <!-- é¢æ¿å±æ€§è¡¨å•ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
                            <div class="panel-properties-form" style="display: none;">
                                ${this.createPanelPropertiesForm()}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæ€»ç»“é¢æ¿
     */
    createSummaryPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ“– å‰§æƒ…æ€»ç»“</h3>
                <div class="header-actions">
                    <button class="btn-action btn-manual-summary" id="header-manual-summary-btn">
                        <span class="btn-icon">ğŸ–Šï¸</span>
                        <span class="btn-text">æ‰‹åŠ¨æ€»ç»“</span>
                    </button>
                    <button class="btn-action btn-refresh" id="header-refresh-summary-btn">
                        <span class="btn-icon">ğŸ”„</span>
                        <span class="btn-text">åˆ·æ–°</span>
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- ğŸ†• æ€»ç»“æ¨¡å¼åˆ‡æ¢ -->
                <div class="summary-mode-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--theme-border-color, #333); padding-bottom: 10px;">
                    <button type="button" class="summary-mode-tab active" data-mode="traditional" style="
                        flex: 1;
                        padding: 10px 16px;
                        background: var(--theme-primary-color, #4CAF50);
                        color: white;
                        border: 1px solid var(--theme-primary-color, #4CAF50);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-weight: 500;
                    ">
                        ğŸ“ ä¼ ç»Ÿæ€»ç»“
                    </button>
                    <button type="button" class="summary-mode-tab" data-mode="vectorized" style="
                        flex: 1;
                        padding: 10px 16px;
                        background: var(--theme-bg-secondary, #2a2a2a);
                        color: var(--theme-text-primary, #e0e0e0);
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-weight: 500;
                    ">
                        ğŸ”® å‘é‡åŒ–æ€»ç»“
                    </button>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 6px; font-size: 13px; color: var(--theme-text-secondary, #aaa);">
                    <span class="summary-mode-description">ä¼ ç»Ÿæ€»ç»“ï¼šä½¿ç”¨è‡ªå®šä¹‰APIç”Ÿæˆå‰§æƒ…æ€»ç»“ | å‘é‡åŒ–æ€»ç»“ï¼šå°†AIè®°å¿†æ€»ç»“å‘é‡åŒ–å­˜å‚¨ï¼Œæ™ºèƒ½æ£€ç´¢</span>
                </div>

                <!-- ä¼ ç»Ÿæ€»ç»“è®¾ç½®åŒºåŸŸ -->
                <div class="traditional-summary-settings">
                <!-- æ€»ç»“è®¾ç½®åŒºåŸŸ -->
                <div class="summary-settings-container">
                    <div class="settings-section">
                        <h4>âš™ï¸ æ€»ç»“è®¾ç½®</h4>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-auto-summary-enabled" />
                                    <span class="checkbox-text">å¯ç”¨è‡ªåŠ¨æ€»ç»“</span>
                                </label>
                                <div class="setting-hint">è¾¾åˆ°è®¾å®šæ¥¼å±‚æ•°åè‡ªåŠ¨ç”Ÿæˆæ€»ç»“</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-inject-summary-enabled" />
                                    <span class="checkbox-text">å¯ç”¨æ€»ç»“æ³¨å…¥</span>
                                </label>
                                <div class="setting-hint">å°†æ€»ç»“å†…å®¹ä½œä¸ºè®°å¿†æ³¨å…¥ç»™ä¸»APIï¼Œå¸®åŠ©AIä¿æŒå‰§æƒ…è¿è´¯æ€§</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-summary-use-regex" checked />
                                    <span class="checkbox-text">ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤</span>
                                </label>
                                <div class="setting-hint">å¯ç”¨åï¼Œåœ¨è·å–æ€»ç»“æ¶ˆæ¯æ—¶åº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ ‡ç­¾å†…å®¹ï¼ˆé»˜è®¤å¯ç”¨ï¼‰</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-floor-count">æ€»ç»“æ¥¼å±‚æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-summary-floor-count" min="5" max="100" value="20" />
                                    <span class="input-unit">æ¡æ¶ˆæ¯</span>
                                </div>
                                <div class="setting-hint">æ¯éš”å¤šå°‘æ¡æ¶ˆæ¯è¿›è¡Œä¸€æ¬¡æ€»ç»“</div>
                            </div>
                        </div>

                        <!-- ğŸ†• æ–°å¢ï¼šå»¶è¿Ÿæ€»ç»“åŠŸèƒ½ -->
                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-delayed-summary-enabled" name="delayedSummaryEnabled" />
                                    <span class="checkbox-text">å¯ç”¨å»¶è¿Ÿæ€»ç»“</span>
                                </label>
                                <div class="setting-hint">å»¶è¿ŸæŒ‡å®šæ¥¼å±‚åå†è§¦å‘æ€»ç»“ï¼Œé¿å…è¿‡æ—©æ€»ç»“å½±å“å¯¹è¯æµç•…æ€§</div>
                            </div>
                        </div>

                        <div class="setting-row" id="content-delayed-summary-floors-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label" for="content-delayed-summary-floors">å»¶è¿Ÿæ¥¼å±‚æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-delayed-summary-floors" name="delayedSummaryFloors" min="1" max="50" value="5" />
                                    <span class="input-unit">å±‚</span>
                                </div>
                                <div class="setting-hint">ä¾‹å¦‚ï¼šæ€»ç»“æ¥¼å±‚æ•°20ï¼Œå»¶è¿Ÿ5å±‚ï¼Œåˆ™åœ¨ç¬¬25å±‚æ€»ç»“ç¬¬0-20å±‚çš„å†…å®¹</div>
                            </div>
                        </div>

                        <!-- ğŸ†• æ–°å¢ï¼šæ‰‹åŠ¨æ€»ç»“èŒƒå›´é€‰æ‹© -->
                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-range-mode">æ‰‹åŠ¨æ€»ç»“æ¨¡å¼</label>
                                <select id="content-summary-range-mode" class="setting-select">
                                    <option value="recent">æ€»ç»“æœ€è¿‘Nå±‚</option>
                                    <option value="custom">è‡ªå®šä¹‰èŒƒå›´</option>
                                </select>
                                <div class="setting-hint">é€‰æ‹©æ‰‹åŠ¨æ€»ç»“æ—¶ä½¿ç”¨çš„èŒƒå›´æ¨¡å¼</div>
                            </div>
                        </div>

                        <div class="setting-row" id="content-custom-range-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label">è‡ªå®šä¹‰æ€»ç»“èŒƒå›´</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div class="input-group" style="flex: 1;">
                                        <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">èµ·å§‹æ¥¼å±‚</label>
                                        <input type="number" id="content-custom-range-start" min="1" value="1" style="width: 100%;" />
                                    </div>
                                    <span style="color: var(--SmartThemeQuoteColor, #888);">è‡³</span>
                                    <div class="input-group" style="flex: 1;">
                                        <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">ç»“æŸæ¥¼å±‚</label>
                                        <input type="number" id="content-custom-range-end" min="1" value="20" style="width: 100%;" />
                                    </div>
                                </div>
                                <div class="setting-hint">æŒ‡å®šè¦æ€»ç»“çš„æ¥¼å±‚èŒƒå›´ï¼ˆæ¥¼å±‚å·ä»1å¼€å§‹ï¼‰</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-type">æ€»ç»“ç±»å‹</label>
                                <select id="content-summary-type" class="setting-select">
                                    <option value="small">å°æ€»ç»“ (çº¦150å­—)</option>
                                    <option value="large">å¤§æ€»ç»“ (çº¦400å­—)</option>
                                    <option value="custom">è‡ªå®šä¹‰å­—æ•°</option>
                                </select>
                            </div>
                        </div>

                        <div class="setting-row" id="content-custom-word-count-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-word-count">æ€»ç»“å­—æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-summary-word-count" min="50" max="1000" value="300" />
                                    <span class="input-unit">å­—</span>
                                </div>
                                <div class="setting-hint">è‡ªå®šä¹‰æ€»ç»“çš„å­—æ•°èŒƒå›´</div>
                            </div>
                        </div>



                        <!-- ğŸ†• æ–°å¢ï¼šè‡ªå®šä¹‰æç¤ºè¯é€‰é¡¹ -->
                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-use-custom-prompt" />
                                    <span class="checkbox-text">ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯</span>
                                </label>
                                <div class="setting-hint">å¯ç”¨åï¼Œä½¿ç”¨æ‚¨è‡ªå®šä¹‰çš„æç¤ºè¯å†…å®¹è¿›è¡Œæ€»ç»“ç”Ÿæˆ</div>
                            </div>
                        </div>

                        <!-- ğŸ†• æ–°å¢ï¼šè‡ªå®šä¹‰æç¤ºè¯é…ç½®åŒºåŸŸ -->
                        <div class="setting-row custom-prompt-section" id="content-custom-prompt-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label">è‡ªå®šä¹‰æ€»ç»“æç¤ºè¯</label>
                                <textarea id="content-custom-prompt" rows="8" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ€»ç»“æç¤ºè¯...

ç¤ºä¾‹ï¼š
è¯·æ ¹æ®ä»¥ä¸‹å¯¹è¯å†…å®¹ç”Ÿæˆç®€æ´çš„å‰§æƒ…æ€»ç»“ï¼ŒåŒ…æ‹¬ï¼š
1. ä¸»è¦äº‹ä»¶å’Œæƒ…èŠ‚å‘å±•
2. è§’è‰²è¡Œä¸ºå’Œæƒ…æ„Ÿå˜åŒ–
3. é‡è¦å¯¹è¯å’Œå†³å®š
4. åœºæ™¯å’Œæ—¶é—´å˜åŒ–

è¦æ±‚ï¼š
- æ€»ç»“é•¿åº¦çº¦200-300å­—
- ä¿æŒå®¢è§‚ä¸­æ€§çš„å™è¿°
- çªå‡ºå…³é”®å‰§æƒ…è½¬æŠ˜ç‚¹" style="width: 100%; resize: vertical; font-family: monospace; font-size: 13px; min-height: 200px;"></textarea>
                                <div class="setting-hint">è‡ªå®šä¹‰çš„æç¤ºè¯å°†å®Œå…¨æ›¿ä»£ç³»ç»Ÿé»˜è®¤çš„æ€»ç»“ç”Ÿæˆæç¤ºè¯</div>
                                <div class="custom-prompt-stats" style="margin-top: 8px; display: flex; gap: 20px; font-size: 12px; color: var(--theme-text-secondary, #aaa);">
                                    <span>å­—ç¬¦æ•°: <span id="content-custom-prompt-char-count">0</span></span>
                                    <span>è¡Œæ•°: <span id="content-custom-prompt-line-count">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½® -->
                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-auto-hide-enabled" />
                                    <span class="checkbox-text">å¯ç”¨è‡ªåŠ¨éšè—å·²æ€»ç»“æ¥¼å±‚</span>
                                </label>
                                <div class="setting-hint">è‡ªåŠ¨éšè—å·²ç»æ€»ç»“è¿‡çš„æ¥¼å±‚å†…å®¹ï¼Œå‡å°‘ç•Œé¢æ··ä¹±</div>
                            </div>
                        </div>

                        <div class="setting-row" id="content-auto-hide-threshold-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label" for="content-auto-hide-threshold">ä¿ç•™æœ€æ–°æ¥¼å±‚æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-auto-hide-threshold" min="10" max="200" value="30" />
                                    <span class="input-unit">ä¸ªæ¥¼å±‚</span>
                                </div>
                                <div class="setting-hint">ä¿ç•™æœ€æ–°çš„Nä¸ªæ¥¼å±‚ä¸éšè—</div>
                            </div>
                        </div>

                        <!-- ğŸ†• ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–è®¾ç½® -->
                        <div class="setting-row" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--theme-border-color, #333);">
                            <div class="setting-group">
                                <h5 style="color: #9C27B0; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ”® ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–</h5>
                                <label class="setting-label">
                                    <input type="checkbox" id="content-vectorize-summary-enabled" />
                                    <span class="checkbox-text">å¯ç”¨ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–</span>
                                </label>
                                <div class="setting-hint">å¯ç”¨åï¼Œä¼ ç»Ÿæ€»ç»“å†…å®¹å°†è‡ªåŠ¨å‘é‡åŒ–å­˜å‚¨åˆ°SillyTavernå‘é‡APIï¼Œæ”¯æŒæ™ºèƒ½æ£€ç´¢</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ€»ç»“å†å²åŒºåŸŸ -->
                <div class="summary-history-container">
                    <div class="history-section">
                        <h4>ğŸ“š æ€»ç»“å†å²</h4>

                        <!-- ğŸš€ æ€»ç»“ç±»å‹ç­›é€‰ï¼šå·²ç®€åŒ–ï¼Œåªä¿ç•™æ€»ç»“è®°å½• -->
                        <div class="summary-filter-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--SmartThemeBorderColor, #333);">
                            <button class="filter-tab active" data-filter="all" style="background: none; border: none; padding: 8px 16px; color: var(--SmartThemeQuoteColor, #888); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">æ€»ç»“è®°å½•</button>
                        </div>

                        <div class="history-selector-group">
                            <label class="setting-label" for="content-summary-history-select">é€‰æ‹©æ€»ç»“è®°å½•</label>
                            <select id="content-summary-history-select" class="setting-select summary-history-select" style="margin-bottom: 10px;">
                                    <option value="">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ€»ç»“è®°å½•</option>
                                </select>
                            <div class="history-action-buttons" style="display: flex; gap: 10px;">
                                <button id="content-upload-to-worldbook-btn" class="btn btn-small" title="ä¸Šä¼ å½“å‰æ€»ç»“åˆ°ä¸–ç•Œä¹¦" style="flex: 1; background: var(--SmartThemeAccentColor, #4a9eff);">ğŸ“š ä¸Šä¼ </button>
                                <button id="content-delete-summary-btn" class="btn btn-small" title="åˆ é™¤å½“å‰é€‰æ‹©çš„æ€»ç»“" style="flex: 1;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                            <div class="setting-hint" style="margin-top: 8px;">é€‰æ‹©æ€»ç»“è®°å½•åï¼Œä¸‹æ–¹å°†æ˜¾ç¤ºè¯¦ç»†å†…å®¹ã€‚å¯ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦ä½œä¸ºå‰§æƒ…è®°å¿†</div>
                        </div>

                        <!-- ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½® -->
                        <div class="worldbook-upload-config" style="margin-top: 15px; padding: 12px; background: var(--theme-bg-secondary, #2a2a2a); border: 1px solid var(--theme-border-color, #333); border-radius: 6px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--theme-primary-color, #4CAF50); font-size: 14px;">ğŸ“š ä¸–ç•Œä¹¦ä¸Šä¼ è®¾ç½®</h5>

                            <div class="setting-row" style="margin-bottom: 12px;">
                                <label class="setting-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="worldbook-auto-upload" class="setting-checkbox" style="width: 18px; height: 18px;">
                                    <span>è‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“</span>
                                </label>
                                <div class="setting-hint">å¯ç”¨åï¼Œæ–°ç”Ÿæˆçš„æ€»ç»“å°†è‡ªåŠ¨ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦</div>
                            </div>

                            <div class="setting-row" style="margin-bottom: 12px;">
                                <label class="setting-label" for="worldbook-entry-format" style="color: var(--theme-text-primary, #e0e0e0);">æ¡ç›®å‘½åæ ¼å¼</label>
                                <select id="worldbook-entry-format" class="setting-select" style="background: var(--theme-bg-primary, #1a1a1a); color: var(--theme-text-primary, #e0e0e0); border-color: var(--theme-border-color, #333);">
                                    <option value="auto">è‡ªåŠ¨å‘½åï¼ˆå‰§æƒ…æ€»ç»“ #1ã€AIè®°å¿† #1ï¼‰</option>
                                    <option value="floor_range">æ¥¼å±‚èŒƒå›´ï¼ˆæ¥¼å±‚ #1-10ï¼‰</option>
                                    <option value="custom">è‡ªå®šä¹‰åç§°</option>
                                </select>
                            </div>

                            <div class="setting-row" id="worldbook-custom-name-row" style="display: none; margin-bottom: 12px;">
                                <label class="setting-label" for="worldbook-custom-name" style="color: var(--theme-text-primary, #e0e0e0);">è‡ªå®šä¹‰æ¡ç›®åç§°</label>
                                <input type="text" id="worldbook-custom-name" class="setting-input" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¡ç›®åç§°" style="background: var(--theme-bg-primary, #1a1a1a); color: var(--theme-text-primary, #e0e0e0); border-color: var(--theme-border-color, #333);">
                            </div>

                            <div class="setting-row" style="margin-bottom: 12px;">
                                <label class="setting-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="worldbook-add-timestamp" class="setting-checkbox" checked style="width: 18px; height: 18px;">
                                    <span style="color: var(--theme-text-primary, #e0e0e0);">æ·»åŠ æ—¶é—´æˆ³</span>
                                </label>
                                <div class="setting-hint">åœ¨æ¡ç›®å†…å®¹ä¸­æ·»åŠ ç”Ÿæˆæ—¶é—´ä¿¡æ¯</div>
                            </div>

                            <div class="setting-row" style="margin-bottom: 12px;">
                                <label class="setting-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="worldbook-use-tags" class="setting-checkbox" checked style="width: 18px; height: 18px;">
                                    <span style="color: var(--theme-text-primary, #e0e0e0);">ä½¿ç”¨å†…å®¹æ ‡ç­¾</span>
                                </label>
                                <div class="setting-hint">ä¸ºæ€»ç»“å†…å®¹æ·»åŠ XMLæ ‡ç­¾ä»¥ä¾¿è¯†åˆ«ç±»å‹</div>
                            </div>

                            <div class="worldbook-batch-actions" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border-color, #333);">
                                <button id="worldbook-batch-upload-btn" class="btn btn-small" style="background: var(--theme-primary-color, #4CAF50); color: white;">ğŸ“¤ æ‰¹é‡ä¸Šä¼ æ‰€æœ‰æ€»ç»“</button>
                                <span class="setting-hint" style="margin-left: 8px;">å°†å½“å‰èŠå¤©çš„æ‰€æœ‰æ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ€»ç»“å†…å®¹æŸ¥çœ‹åŒºåŸŸ -->
                <div class="summary-content-container" id="content-summary-content-section" style="display: none;">
                    <div class="content-section">
                        <div class="content-header-info">
                            <h4>ğŸ“„ æ€»ç»“å†…å®¹</h4>
                            <div class="content-meta">
                                <span class="content-title" id="content-summary-title"></span>
                                <span class="content-date" id="content-summary-date"></span>
                            </div>
                        </div>
                        <div class="content-body-text" id="content-summary-content-body"></div>
                    </div>
                </div>
                </div>
                <!-- ä¼ ç»Ÿæ€»ç»“è®¾ç½®åŒºåŸŸç»“æŸ -->

                <!-- ğŸ†• å‘é‡åŒ–æ€»ç»“è®¾ç½®åŒºåŸŸ -->
                <div class="vectorized-summary-settings" style="display: none;">
                    <div class="summary-settings-container">
                        <div class="settings-section">
                            <h4>âš™ï¸ å‘é‡åŒ–æ€»ç»“è®¾ç½®</h4>

                            <div class="setting-row">
                                <div class="setting-group">
                                    <label class="setting-label">
                                        <input type="checkbox" id="vectorized-summary-enabled" />
                                        <span class="checkbox-text">å¯ç”¨å‘é‡åŒ–æ€»ç»“</span>
                                    </label>
                                    <div class="setting-hint">å¯ç”¨åï¼ŒAIè®°å¿†æ€»ç»“å°†è‡ªåŠ¨å‘é‡åŒ–å­˜å‚¨ï¼Œæ”¯æŒæ™ºèƒ½æ£€ç´¢</div>
                                </div>
                            </div>

                            <div class="setting-row">
                                <div class="setting-group">
                                    <label class="setting-label" for="vectorized-summary-floor-count">æ€»ç»“æ¥¼å±‚</label>
                                    <div class="input-group">
                                        <input type="number" id="vectorized-summary-floor-count" min="5" max="100" value="20" />
                                        <span class="input-unit">æ¡æ¶ˆæ¯</span>
                                    </div>
                                    <div class="setting-hint">æ¯éš”å¤šå°‘æ¡æ¶ˆæ¯è¿›è¡Œä¸€æ¬¡å‘é‡åŒ–æ€»ç»“</div>
                                </div>
                            </div>

                            <div class="setting-row">
                                <div class="setting-group">
                                    <label class="setting-label">
                                        <input type="checkbox" id="vectorized-auto-hide-enabled" />
                                        <span class="checkbox-text">å¯ç”¨è‡ªåŠ¨éšè—å·²æ€»ç»“æ¥¼å±‚</span>
                                    </label>
                                    <div class="setting-hint">è‡ªåŠ¨éšè—å·²ç»å‘é‡åŒ–æ€»ç»“çš„æ¥¼å±‚å†…å®¹</div>
                                </div>
                            </div>

                            <div class="setting-row" id="vectorized-keep-recent-row" style="display: none;">
                                <div class="setting-group">
                                    <label class="setting-label" for="vectorized-keep-recent-count">ä¿ç•™æœ€æ–°æ¥¼å±‚æ•°</label>
                                    <div class="input-group">
                                        <input type="number" id="vectorized-keep-recent-count" min="1" max="50" value="10" />
                                        <span class="input-unit">æ¡æ¶ˆæ¯</span>
                                    </div>
                                    <div class="setting-hint">éšè—æ—¶ä¿ç•™æœ€æ–°çš„Næ¡æ¶ˆæ¯ä¸éšè—</div>
                                </div>
                            </div>

                            <div class="setting-row">
                                <div class="setting-group">
                                    <div style="padding: 12px; background: var(--theme-bg-secondary, #1a1a1a); border: 1px solid var(--theme-border-color, #333); border-radius: 6px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="font-size: 18px;">âš ï¸</span>
                                            <span style="font-weight: 500; color: #ff9800;">å‰ç½®æ¡ä»¶æ£€æŸ¥</span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--theme-text-secondary, #aaa); line-height: 1.6;">
                                            å‘é‡åŒ–æ€»ç»“åŠŸèƒ½éœ€è¦å¯ç”¨<strong style="color: #4CAF50;">AIè®°å¿†æ€»ç»“</strong>åŠŸèƒ½ã€‚<br>
                                            è¯·å‰å¾€<strong>è®°å¿†å¢å¼º</strong>é¢æ¿ï¼Œå¯ç”¨<strong>AIè®°å¿†æ€»ç»“</strong>å’Œ<strong>æ¶ˆæ¯çº§åˆ«æ€»ç»“</strong>ã€‚
                                        </div>
                                        <div id="ai-memory-status" style="margin-top: 10px; padding: 8px; background: var(--theme-bg-hover, #2a2a2a); border-radius: 4px; font-size: 12px;">
                                            <span style="color: var(--theme-text-secondary, #888);">çŠ¶æ€æ£€æŸ¥ä¸­...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AIè®°å¿†æ€»ç»“è®°å½• -->
                    <div class="summary-history-container">
                        <div class="history-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">ğŸ§  AIè®°å¿†æ€»ç»“è®°å½•</h4>
                                <button id="manual-vectorize-btn" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px; background: var(--theme-primary-color, #4CAF50); border: none; border-radius: 4px; color: white; cursor: pointer; transition: all 0.2s;">
                                    ğŸ”® æ‰‹åŠ¨å‘é‡åŒ–
                                </button>
                            </div>
                            <div class="setting-hint" style="margin-bottom: 15px;">æ˜¾ç¤ºå¾…å‘é‡åŒ–çš„AIè®°å¿†æ€»ç»“ï¼Œè¾¾åˆ°æ€»ç»“æ¥¼å±‚åå°†è‡ªåŠ¨å‘é‡åŒ–ï¼Œæˆ–ç‚¹å‡»"æ‰‹åŠ¨å‘é‡åŒ–"æŒ‰é’®ç«‹å³å‘é‡åŒ–</div>

                            <!-- å‘é‡åŒ–è¿›åº¦æ¡ -->
                            <div id="vectorize-progress-container" style="display: none; margin-bottom: 15px; padding: 12px; background: var(--theme-bg-tertiary, #1a1a1a); border: 1px solid var(--theme-border-color, #333); border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 16px;">â³</span>
                                    <span id="vectorize-progress-text" style="font-weight: 500; color: var(--theme-primary-color, #4CAF50);">æ­£åœ¨å‘é‡åŒ–...</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 3px; overflow: hidden;">
                                    <div id="vectorize-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--theme-primary-color, #4CAF50), var(--theme-success-color, #10b981)); transition: width 0.3s;"></div>
                                </div>
                                <div id="vectorize-progress-detail" style="margin-top: 8px; font-size: 12px; color: var(--theme-text-secondary, #888);">
                                    å‡†å¤‡ä¸­...
                                </div>
                            </div>

                            <div id="ai-memory-summary-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--theme-border-color, #333); border-radius: 6px; padding: 10px; background: var(--theme-bg-secondary, #2a2a2a);">
                                <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                                    æš‚æ— AIè®°å¿†æ€»ç»“è®°å½•
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å·²å‘é‡åŒ–æ€»ç»“è®°å½• -->
                    <div class="summary-history-container">
                        <div class="history-section">
                            <h4>ğŸ“¦ å·²å‘é‡åŒ–æ€»ç»“è®°å½•</h4>
                            <div class="setting-hint" style="margin-bottom: 15px;">æ˜¾ç¤ºå·²å®Œæˆå‘é‡åŒ–çš„æ€»ç»“è®°å½•</div>

                            <div id="vectorized-summary-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--theme-border-color, #333); border-radius: 6px; padding: 10px; background: var(--theme-bg-secondary, #2a2a2a);">
                                <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                                    æš‚æ— å‘é‡åŒ–æ€»ç»“è®°å½•
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- å‘é‡åŒ–æ€»ç»“è®¾ç½®åŒºåŸŸç»“æŸ -->
            </div>
        `;
    }

    /**
     * è·å–é¢æ¿æ€»æ•°
     */
    getTotalPanelCount() {
        return this.getBasicPanelCount() + this.getCustomPanelCount();
    }

    /**
     * è·å–åŸºç¡€é¢æ¿æ•°é‡
     */
    getBasicPanelCount() {
        const basicPanels = [
            // ç§»é™¤åŸºç¡€è®¾ç½®é¢æ¿ï¼Œå®ƒæ˜¯ç³»ç»Ÿè®¾ç½®ï¼Œä¸æ˜¯é¢æ¿
            'personal', 'interaction', 'tasks', 'world', 'organization',
            'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy',
            'modern', 'historical', 'magic', 'training'
        ];
        return basicPanels.length;
    }

    /**
     * è·å–è‡ªå®šä¹‰é¢æ¿æ•°é‡
     */
    getCustomPanelCount() {
        // ä»é…ç½®ä¸­è·å–è‡ªå®šä¹‰é¢æ¿æ•°é‡
        const customPanels = this.getCustomPanels();
        return Object.keys(customPanels).length;
    }

    /**
     * è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®
     */
    getCustomPanels() {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // è·å–è‡ªå®šä¹‰é¢æ¿æ•°æ®
            const customPanels = extensionSettings['Information bar integration tool'].customPanels || {};

            // åŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            window.InfoBarCustomPanels = customPanels;

            console.log('[InfoBarSettings] ğŸ“Š è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®:', customPanels);
            return customPanels;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®å¤±è´¥:', error);
            return window.InfoBarCustomPanels || {};
        }
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„é¢æ¿é”®å
     */
    generateUniqueKey(customPanels) {
        try {
            // è·å–æ‰€æœ‰ç°æœ‰çš„é”®å
            const existingKeys = Object.values(customPanels).map(panel => panel.key).filter(key => key);

            console.log('[InfoBarSettings] ğŸ” ç°æœ‰é”®å:', existingKeys);

            // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰é¢æ¿ï¼Œè¿”å› 'Custom'
            if (existingKeys.length === 0) {
                return 'Custom';
            }

            // æ£€æŸ¥ 'Custom' æ˜¯å¦å·²å­˜åœ¨
            if (!existingKeys.includes('Custom')) {
                return 'Custom';
            }

            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ•°å­—åç¼€
            let counter = 1;
            let newKey;
            do {
                newKey = `Custom${counter}`;
                counter++;
            } while (existingKeys.includes(newKey));

            console.log('[InfoBarSettings] âœ… ç”Ÿæˆå”¯ä¸€é”®å:', newKey);
            return newKey;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆå”¯ä¸€é”®åå¤±è´¥:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³
            return `Custom_${Date.now()}`;
        }
    }

    /**
     * ğŸ”§ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åID
     */
    migrateTimestampIdPanels() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const customPanels = configs.customPanels || {};

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åID');

            const migratedPanels = {};
            let migratedCount = 0;

            Object.entries(customPanels).forEach(([panelId, panel]) => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¶é—´æˆ³IDæ ¼å¼ï¼ˆcustom_æ•°å­—ï¼‰
                if (panelId.startsWith('custom_') && /^custom_\d+$/.test(panelId)) {
                    console.log(`[InfoBarSettings] ğŸ”„ è¿ç§»é¢æ¿: ${panelId} -> ${panel.key}`);

                    // æ›´æ–°é¢æ¿çš„IDä¸ºé”®å
                    panel.id = panel.key;

                    // ä½¿ç”¨é”®åä½œä¸ºå­˜å‚¨é”®
                    migratedPanels[panel.key] = panel;
                    migratedCount++;
                } else {
                    // ä¿æŒç°æœ‰çš„é¢æ¿
                    migratedPanels[panelId] = panel;
                }
            });

            if (migratedCount > 0) {
                // æ›´æ–°é…ç½®
                extensionSettings['Information bar integration tool'].customPanels = migratedPanels;

                // ä¿å­˜é…ç½®
                context.saveSettingsDebounced();

                console.log(`[InfoBarSettings] âœ… æˆåŠŸè¿ç§» ${migratedCount} ä¸ªé¢æ¿åˆ°é”®åID`);
                return migratedCount;
            } else {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰éœ€è¦è¿ç§»çš„æ—¶é—´æˆ³IDé¢æ¿');
                return 0;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿å¤±è´¥:', error);
            return 0;
        }
    }

    /**
     * ä¿®å¤é‡å¤é”®åé—®é¢˜
     */
    async fixDuplicateKeys() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹ä¿®å¤é‡å¤é”®åé—®é¢˜...');

            const customPanels = this.getCustomPanels();
            const keyCount = {};
            const duplicateKeys = [];

            // ç»Ÿè®¡é”®åä½¿ç”¨æ¬¡æ•°
            for (const [panelId, panel] of Object.entries(customPanels)) {
                const key = panel.key;
                if (key) {
                    keyCount[key] = (keyCount[key] || 0) + 1;
                    if (keyCount[key] > 1) {
                        duplicateKeys.push(key);
                    }
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š é”®åç»Ÿè®¡:', keyCount);
            console.log('[InfoBarSettings] âš ï¸ é‡å¤é”®å:', duplicateKeys);

            if (duplicateKeys.length === 0) {
                console.log('[InfoBarSettings] âœ… æ²¡æœ‰å‘ç°é‡å¤é”®å');
                return;
            }

            // ä¿®å¤é‡å¤é”®å
            let fixedCount = 0;
            for (const [panelId, panel] of Object.entries(customPanels)) {
                const key = panel.key;
                if (duplicateKeys.includes(key)) {
                    // ä¸ºé‡å¤çš„é”®åç”Ÿæˆæ–°çš„å”¯ä¸€é”®å
                    const newKey = this.generateUniqueKey(customPanels);
                    panel.key = newKey;
                    customPanels[panelId] = panel;
                    fixedCount++;

                    console.log(`[InfoBarSettings] ğŸ”§ ä¿®å¤é¢æ¿ ${panelId}: ${key} -> ${newKey}`);

                    // æ›´æ–°customPanelsä»¥é¿å…åç»­å†²çª
                    break; // ä¸€æ¬¡åªä¿®å¤ä¸€ä¸ªï¼Œç„¶åé‡æ–°æ£€æŸ¥
                }
            }

            if (fixedCount > 0) {
                // ä¿å­˜ä¿®å¤åçš„é…ç½®
                await this.saveAllCustomPanels(customPanels);
                console.log(`[InfoBarSettings] âœ… å·²ä¿®å¤ ${fixedCount} ä¸ªé‡å¤é”®å`);

                // é€’å½’ä¿®å¤å‰©ä½™çš„é‡å¤é”®å
                await this.fixDuplicateKeys();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿®å¤é‡å¤é”®åå¤±è´¥:', error);
        }
    }
    /**
     * ä¿å­˜æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®
     */
    async saveAllCustomPanels(customPanels) {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ä¿å­˜åˆ°SillyTavern
            await context.saveSettingsDebounced();

            // åŒæ­¥åˆ°å…¨å±€å˜é‡
            window.InfoBarCustomPanels = customPanels;

            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æ˜ å°„æ—¶é‡æ–°ç”Ÿæˆ
            this._cachedCompleteMapping = null;

            console.log('[InfoBarSettings] âœ… æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®å·²ä¿å­˜');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ”§ é‡æ„ï¼šåˆ›å»ºé¢æ¿åˆ—è¡¨é¡¹ï¼ˆæ‰€æœ‰é¢æ¿ç»Ÿä¸€æ˜¾ç¤ºï¼Œæ— åˆ†ç±»ï¼‰
     */
    createPanelListItems(category) {
        // ğŸ”§ æ–°æ¶æ„ï¼šæ‰€æœ‰é¢æ¿ç»Ÿä¸€ä»customPanelsè·å–ï¼Œä¸åŒºåˆ†ç±»å‹
        const customPanels = this.getCustomPanels();
        let panels = [];

        Object.entries(customPanels).forEach(([key, panel]) => {
            if (!panel) return;
            // ä¸å†æŒ‰typeè¿‡æ»¤ï¼Œæ‰€æœ‰é¢æ¿éƒ½æ˜¾ç¤º
            panels.push({ ...panel, id: key });
        });

        if (panels.length === 0) {
            return `
                <div class="empty-panel-list">
                    <div class="empty-icon">ğŸ“­</div>
                    <div class="empty-text">æš‚æ— é¢æ¿</div>
                </div>
            `;
        }

        return panels.map(panel => this.createPanelListItem(panel)).join('');
    }

    /**
     * ğŸ—‘ï¸ å·²åºŸå¼ƒï¼šè·å–åŸºç¡€é¢æ¿é¡¹ï¼ˆç°åœ¨æ‰€æœ‰é¢æ¿ç»Ÿä¸€è·å–ï¼‰
     */
    getBasicPanelItems() {
        // ğŸ”§ æ–°æ¶æ„ï¼šè¿”å›æ‰€æœ‰é¢æ¿ï¼Œä¸åŒºåˆ†ç±»å‹
        return this.getAllPanelItems();
    }

    /**
     * ğŸ—‘ï¸ å·²åºŸå¼ƒï¼šè·å–è‡ªå®šä¹‰é¢æ¿é¡¹ï¼ˆç°åœ¨æ‰€æœ‰é¢æ¿ç»Ÿä¸€è·å–ï¼‰
     */
    getCustomPanelItems() {
        // ğŸ”§ æ–°æ¶æ„ï¼šè¿”å›æ‰€æœ‰é¢æ¿ï¼Œä¸åŒºåˆ†ç±»å‹
        return this.getAllPanelItems();
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–æ‰€æœ‰é¢æ¿é¡¹ï¼ˆç»Ÿä¸€æ–¹æ³•ï¼‰
     */
    getAllPanelItems() {
        const customPanels = this.getCustomPanels();
        return Object.entries(customPanels).map(([key, panel]) => ({
            ...panel,
            id: key
        }));
    }

    /**
     * ğŸ”§ é‡æ„ï¼šåˆ›å»ºå•ä¸ªé¢æ¿åˆ—è¡¨é¡¹ï¼ˆæ‰€æœ‰é¢æ¿ç»Ÿä¸€æ˜¾ç¤ºï¼Œæ— åŒºåˆ†ï¼‰
     */
    createPanelListItem(panel) {
        // ğŸ”§ æ–°æ¶æ„ï¼šé¢„è®¾å’Œè‡ªå®šä¹‰é¢æ¿å®Œå…¨ä¸€æ ·ï¼Œä¸åšä»»ä½•åŒºåˆ†
        return `
            <div class="panel-list-item" data-panel-id="${panel.id}" data-panel-type="${panel.type}">
                <div class="panel-item-info">
                    <div class="panel-item-name">${panel.name}</div>
                </div>
                <div class="panel-item-actions">
                    <button class="btn-icon" data-action="edit-panel" data-panel-id="${panel.id}" title="ç¼–è¾‘">
                        ç¼–è¾‘
                    </button>
                    <button class="btn-icon" data-action="duplicate-panel" data-panel-id="${panel.id}" title="å¤åˆ¶">
                        å¤åˆ¶
                    </button>
                    <button class="btn-icon" data-action="rename-panel" data-panel-id="${panel.id}" title="ç¼–è¾‘åç§°">
                        âœï¸
                    </button>
                    <button class="btn-icon" data-action="move-panel-up" data-panel-id="${panel.id}" title="ä¸Šç§»é¢æ¿">
                        â¬†ï¸
                    </button>
                    <button class="btn-icon" data-action="move-panel-down" data-panel-id="${panel.id}" title="ä¸‹ç§»é¢æ¿">
                        â¬‡ï¸
                    </button>
                    <button class="btn-icon" data-action="delete-panel" data-panel-id="${panel.id}" title="åˆ é™¤">
                        åˆ é™¤
                    </button>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºé¢æ¿å±æ€§è¡¨å•
     */
    createPanelPropertiesForm() {
        return `
            <div class="properties-form">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-section">
                    <div class="section-header-with-actions">
                    <h5>åŸºæœ¬ä¿¡æ¯</h5>
                        <button type="button" class="btn-icon-small btn-delete-panel-inline" data-action="delete-panel-inline" title="åˆ é™¤æ­¤é¢æ¿">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="panel-name">é¢æ¿åç§°</label>
                        <input type="text" id="panel-name" name="panel.name" placeholder="è¯·è¾“å…¥é¢æ¿åç§°" />
                    </div>
                    <div class="form-group">
                        <label for="panel-key">é”®å</label>
                        <input type="text" id="panel-key" name="panel.key" placeholder="è¯·è¾“å…¥é”®åï¼ˆç”¨äºé…ç½®å­˜å‚¨ï¼‰" />
                        <div class="form-hint">é”®åç”¨äºé…ç½®å­˜å‚¨ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡å’Œä¸‹åˆ’çº¿</div>
                    </div>
                    <div class="form-group">
                        <label for="panel-description">é¢æ¿è¯´æ˜</label>
                        <textarea id="panel-description" name="panel.description" rows="3" placeholder="è¯·è¾“å…¥é¢æ¿è¯´æ˜"></textarea>
                    </div>
                </div>

                <!-- é…ç½®é€‰é¡¹ -->
                <div class="form-section">
                    <h5>é…ç½®é€‰é¡¹</h5>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="panel-required" name="panel.required" />
                            <span>æ˜¯å¦å¿…å¡«</span>
                        </label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="panel-memory-inject" name="panel.memoryInject" />
                            <span>æ˜¯å¦æ³¨å…¥è®°å¿†</span>
                        </label>
                    </div>

                </div>



                <!-- å­é¡¹é…ç½® -->
                <div class="form-section">
                    <div class="section-header-with-actions">
                    <h5>å­é¡¹é…ç½®</h5>
                        <div class="sub-items-actions">
                            <button type="button" class="btn-icon-small" data-action="add-sub-item" title="æ·»åŠ å­—æ®µ">
                                â•
                            </button>
                            <button type="button" class="btn-icon-small" data-action="select-all-sub-items" title="å…¨é€‰">
                                â˜‘ï¸
                            </button>
                            <button type="button" class="btn-icon-small" data-action="deselect-all-sub-items" title="å…¨ä¸é€‰">
                                â˜
                            </button>
                        </div>
                    </div>
                    <div class="sub-items-header" style="display: none;">
                        <span>å­é¡¹åˆ—è¡¨</span>
                        <button type="button" class="btn-small btn-add-sub-item" data-action="add-sub-item">
                            <span class="btn-icon" style="pointer-events: none;">â•</span>
                            <span class="btn-text" style="pointer-events: none;">æ–°å¢å­é¡¹</span>
                        </button>
                    </div>
                    <div class="sub-items-container">
                        <div class="empty-sub-items">
                            <div class="empty-icon">ğŸ“</div>
                            <div class="empty-text">æš‚æ— å­é¡¹ï¼Œç‚¹å‡»"æ–°å¢å­é¡¹"æ·»åŠ </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå‰ç«¯æ˜¾ç¤ºé¢æ¿
     */
    createFrontendDisplayPanel() {
        return `
            <div class="settings-group">
                <h3>ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®</h3>
                <p class="frontend-description">å¯ç”¨å‰ç«¯æ˜¾ç¤ºåï¼ŒAIæ¶ˆæ¯å°†åŒ…è£¹åœ¨ä¿¡æ¯æ æ¡†æ¶ä¸­ï¼Œæä¾›äº¤äº’å¼çš„é¢æ¿å’Œå­é¡¹æ˜¾ç¤º</p>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.enabled" />
                        <span>å¯ç”¨å‰ç«¯æ˜¾ç¤º</span>
                    </label>
                    <p class="help-text">å¯ç”¨åï¼ŒAIæ¶ˆæ¯åŒºåŸŸå°†æ˜¾ç¤ºäº¤äº’å¼çš„ä¿¡æ¯æ é¢„è§ˆç•Œé¢</p>
                </div>
            </div>

            <div class="settings-group frontend-display-config" style="display: none;">
                <h3>ğŸ“Š æ˜¾ç¤ºé…ç½®</h3>

                <div class="form-group">
                    <label>æ˜¾ç¤ºæ ·å¼</label>
                    <select name="frontendDisplay.style">
                        <option value="left">å·¦å¯¹é½</option>
                        <option value="center">å±…ä¸­æ˜¾ç¤º</option>
                        <option value="right">å³å¯¹é½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.showAddButtons" checked />
                        <span>æ˜¾ç¤ºæ·»åŠ æŒ‰é’®</span>
                    </label>
                    <p class="help-text">åœ¨é¢„è§ˆçª—å£ä¸Šä¸‹æ–¹æ˜¾ç¤ºå¯ç‚¹å‡»çš„æ·»åŠ æ¡†æ¡†</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.animationEnabled" checked />
                        <span>å¯ç”¨åŠ¨ç”»æ•ˆæœ</span>
                    </label>
                </div>
            </div>

            <div class="settings-group frontend-display-preview" style="display: none;">
                <h3>ğŸ® äº¤äº’é¢„è§ˆ</h3>
                <p class="preview-description">é¢„è§ˆå‰ç«¯æ˜¾ç¤ºçš„äº¤äº’æ•ˆæœ</p>

                <div class="frontend-preview-container">
                    <!-- é¡¶éƒ¨é¢„è§ˆåŒºåŸŸ -->
                    <div class="preview-section">
                        <h4>ğŸ” é¡¶éƒ¨é¢„è§ˆå†…å®¹</h4>
                        <div class="ai-message-wrapper top-preview">
                            <div class="add-panel-slots top-slots">
                                <div class="add-slot" data-position="top-1" data-area="top">+</div>
                                <div class="add-slot" data-position="top-2" data-area="top">+</div>
                                <div class="add-slot" data-position="top-3" data-area="top">+</div>
                            </div>

                            <div class="embedded-panels top-embedded-panels">
                                <!-- ç”¨æˆ·æ·»åŠ çš„é¡¶éƒ¨é¢æ¿å’Œå­é¡¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>

                    <!-- AIæ¶ˆæ¯å†…å®¹ -->
                    <div class="ai-message-preview">
                        <div class="message-content">
                            <p>è¿™æ˜¯AIæ¶ˆæ¯çš„é¢„è§ˆå†…å®¹...</p>
                        </div>
                    </div>

                    <!-- åº•éƒ¨é¢„è§ˆåŒºåŸŸ -->
                    <div class="preview-section">
                        <h4>ğŸ”½ åº•éƒ¨é¢„è§ˆå†…å®¹</h4>
                        <div class="ai-message-wrapper bottom-preview">
                            <div class="embedded-panels bottom-embedded-panels">
                                <!-- ç”¨æˆ·æ·»åŠ çš„åº•éƒ¨é¢æ¿å’Œå­é¡¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>

                            <div class="add-panel-slots bottom-slots">
                                <div class="add-slot" data-position="bottom-1" data-area="bottom">+</div>
                                <div class="add-slot" data-position="bottom-2" data-area="bottom">+</div>
                                <div class="add-slot" data-position="bottom-3" data-area="bottom">+</div>
                            </div>
                        </div>
                    </div>
                </div>

                                    <div class="preview-actions">
                        <button class="btn" data-action="test-panel-popup">æµ‹è¯•é¢æ¿å¼¹çª—</button>
                        <button class="btn" data-action="test-add-panel">æµ‹è¯•æ·»åŠ é¢æ¿</button>
                        <button class="btn" data-action="clear-preview">æ¸…ç©ºé¢„è§ˆ</button>
                    </div>
            </div>


        `;
    }

    /**
     * åˆ›å»ºé«˜çº§è®¾ç½®é¢æ¿
     */
    createAdvancedPanel() {
        return `
            <div class="settings-group">
                <h3>è°ƒè¯•è®¾ç½®</h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="debug.enabled" />
                        <span>å¯ç”¨è°ƒè¯•æ¨¡å¼</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>æ—¥å¿—çº§åˆ«</label>
                    <select name="debug.logLevel">
                        <option value="error">é”™è¯¯</option>
                        <option value="warn">è­¦å‘Š</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="debug">è°ƒè¯•</option>
                    </select>
                </div>
                <div class="form-group debug-actions-row">
                    <button class="btn" data-action="open-error-log">é”™è¯¯æ—¥å¿—</button>
                    <button class="btn" data-action="open-project-link">é¡¹ç›®åœ°å€</button>
                </div>
            </div>

            <div class="settings-group">
                <h3>é¢„è®¾ç®¡ç†</h3>

                <!-- é¢„è®¾æ“ä½œæŒ‰é’® -->
                <div class="form-group">
                    <div class="preset-actions-row" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-primary" data-action="export-preset" title="å¯¼å‡ºå½“å‰é…ç½®ä¸ºé¢„è®¾">
                            ğŸ“¤ å¯¼å‡ºé¢„è®¾
                        </button>
                        <button class="btn" data-action="import-preset" title="å¯¼å…¥é¢„è®¾é…ç½®">
                            ğŸ“¥ å¯¼å…¥é¢„è®¾
                        </button>
                        <button class="btn btn-warning" data-action="load-preset-panels" title="é‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿">
                            ğŸ”„ åŠ è½½é¢„è®¾é¢æ¿
                        </button>
                        <button class="btn btn-warning" data-action="load-preset-rules" title="é‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿çš„è§„åˆ™">
                            ğŸ“‹ åŠ è½½é¢„è®¾è§„åˆ™
                        </button>
                    </div>
                </div>

                <!-- é¢„è®¾åˆ—è¡¨ -->
                <div class="form-group">
                    <label>å·²å¯¼å…¥çš„é¢„è®¾</label>
                    <div id="preset-list-container" class="preset-list-container">
                        <!-- é¢„è®¾åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ•°æ®æ¸…ç†æŒ‰é’® -->
                <div class="form-group">
                    <button class="btn btn-warning" data-action="open-data-cleanup" title="æ¸…ç†settings.jsonä¸­çš„å¤§å‹æ•°æ®">
                        ğŸ§¹ æ•°æ®æ¸…ç†å·¥å…·
                    </button>
                </div>
            </div>

            <div class="settings-group">
                <h3>æ•°æ®ç®¡ç†</h3>
                <div class="form-group">
                    <label>æ•°æ®èŒƒå›´</label>
                    <select id="data-scope-select" name="dataManagement.scope">
                        <option value="current">å½“å‰èŠå¤©</option>
                        <option value="all">æ‰€æœ‰èŠå¤©</option>
                    </select>
                    <small>é€‰æ‹©è¦å¯¼å‡ºæˆ–å¯¼å…¥çš„æ•°æ®èŒƒå›´</small>
                </div>
                <div class="form-group">
                    <label>æ•°æ®æ ¼å¼</label>
                    <select id="data-format-select" name="dataManagement.format">
                        <option value="json">JSONæ ¼å¼</option>
                        <option value="csv">CSVæ ¼å¼</option>
                        <option value="xml">XMLæ ¼å¼</option>
                    </select>
                    <small>é€‰æ‹©å¯¼å‡ºæˆ–å¯¼å…¥çš„æ•°æ®æ ¼å¼</small>
                </div>
                <div class="form-group">
                    <div class="data-management-actions">
                        <button class="btn btn-primary data-export-btn" data-action="export-data">
                            ğŸ“¤ å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="btn btn-secondary data-import-btn" data-action="import-data">
                            ğŸ“¥ å¯¼å…¥æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <small class="data-management-hint">
                        ğŸ’¡ å¯¼å‡ºåŠŸèƒ½å°†åŒ…å«èŠå¤©ä¿¡æ¯ã€æ¶ˆæ¯è®°å½•å’Œä¿¡æ¯æ æ•°æ®ã€‚å¯¼å…¥å‰è¯·ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ã€‚
                    </small>
                </div>
            </div>

            <div class="settings-group danger-zone">
                <h3>å±é™©æ“ä½œ</h3>
                <div class="form-group">
                    <button class="btn btn-danger" data-action="clear-cache">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
                    <button class="btn btn-danger" data-action="initialize-plugin">åˆå§‹åŒ–æ’ä»¶</button>
                    <button class="btn btn-danger" data-action="clear-panel-data">æ¸…ç©ºé¢æ¿æ•°æ®</button>
                </div>
                <div class="form-group">
                    <small class="text-muted">
                        âš ï¸ å±é™©æ“ä½œè¯´æ˜ï¼š<br>
                        â€¢ åˆå§‹åŒ–æ’ä»¶ï¼šå°†æ’ä»¶æ¢å¤åˆ°åˆšå®‰è£…çš„çŠ¶æ€ï¼Œæ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®ã€è‡ªå®šä¹‰å†…å®¹å’Œè§„åˆ™<br>
                        â€¢ æ¸…ç©ºé¢æ¿æ•°æ®ï¼šæ¸…ç©ºæ‰€æœ‰èŠå¤©ä¸­çš„é¢æ¿æ•°æ®ï¼Œä½†ä¿ç•™é…ç½®å’Œè§„åˆ™
                    </small>
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    bindEvents() {
        try {
            // æ¨¡æ€æ¡†äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                const actionEl = e.target.closest('[data-action]');
                const action = actionEl?.dataset?.action;

                if (action) {
                    console.log('[InfoBarSettings] ğŸ”˜ å¤„ç†æ“ä½œ:', action, 'å…ƒç´ :', actionEl);
                    console.log('[InfoBarSettings] ğŸ” Switchè¯­å¥å³å°†å¤„ç†action:', action);
                }

                switch (action) {
                    case 'close':
                    case 'cancel':
                        this.hide();
                        break;
                    case 'save':
                        this.saveSettings();
                        break;
                    // resetäº‹ä»¶å·²ç§»é™¤
                    case 'export':
                        this.exportSettings();
                        break;
                    case 'import':
                        this.importSettings();
                        break;
                    case 'test-api':
                        this.testAPIConnection();
                        break;
                    case 'load-models':
                        this.loadAPIModels();
                        break;
                    case 'open-error-log':
                        this.openErrorLogModal();
                        break;
                    case 'open-project-link':
                        this.openProjectLink();
                        break;
                    case 'save-profile':
                        this.saveSettingsProfile();
                        break;
                    case 'load-profile':
                        this.loadSettingsProfile();
                        break;
                    case 'delete-profile':
                        this.deleteSettingsProfile();
                        break;
                    case 'export-preset':
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œå¯¼å‡ºé¢„è®¾...');
                        this.exportPreset();
                        break;
                    case 'import-preset':
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡Œå¯¼å…¥é¢„è®¾...');
                        this.importPreset();
                        break;
                    case 'load-preset-panels':
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡ŒåŠ è½½é¢„è®¾é¢æ¿...');
                        this.loadPresetPanels();
                        break;
                    case 'load-preset-rules':
                        console.log('[InfoBarSettings] ğŸš€ æ‰§è¡ŒåŠ è½½é¢„è®¾è§„åˆ™...');
                        this.loadPresetRules();
                        break;
                    case 'switch-preset':
                        const presetId = actionEl.dataset.presetId;
                        if (presetId) {
                            this.switchPreset(presetId);
                        }
                        break;
                    case 'delete-preset':
                        const deletePresetId = actionEl.dataset.presetId;
                        if (deletePresetId) {
                            this.deletePreset(deletePresetId);
                        }
                        break;
                    case 'export-data':
                        console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å‡ºæ•°æ®...');
                        this.exportData().catch(error => {
                            console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                            this.showMessage('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
                        });
                        break;
                    case 'import-data':
                        console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ•°æ®...');
                        this.importData().catch(error => {
                            console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                            this.showMessage('å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                        });
                        break;
                    default:
                        if (action) {
                            console.log('[InfoBarSettings] âš ï¸ æœªå¤„ç†çš„æ“ä½œ:', action);
                        }
                        break;
                }
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢
            this.modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    this.switchTab(e.target.dataset.tab);
                }
            });

            // è¡¨å•å˜æ›´äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                this.handleFormChange(e);
            });

            // èŒƒå›´è¾“å…¥å®æ—¶æ›´æ–°
            this.modal.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan && valueSpan.classList.contains('range-value')) {
                        valueSpan.textContent = e.target.value;
                    }
                }
            });

            console.log('[InfoBarSettings] ğŸ”— äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šäº‹ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ”§ é‡æ„ï¼šåˆå§‹åŒ–æ‰€æœ‰é¢æ¿çš„å­é¡¹æ˜¾ç¤ºï¼ˆç»Ÿä¸€ä»customPanelsè·å–ï¼‰
     */
    initAllBasicPanelCustomSubItems() {
        try {
            // ğŸ”§ é‡è¦ä¿®å¤ï¼šæ‰€æœ‰é¢æ¿ç°åœ¨éƒ½é€šè¿‡createCustomPanelContent()ç»Ÿä¸€æ¸²æŸ“
            // ä¸å†éœ€è¦å•ç‹¬æ·»åŠ "è‡ªå®šä¹‰å­é¡¹"åŒºåŸŸï¼Œå¦åˆ™ä¼šå¯¼è‡´å­—æ®µé‡å¤æ˜¾ç¤º
            console.log('[InfoBarSettings] â„¹ï¸ æ‰€æœ‰é¢æ¿å·²é€šè¿‡ç»Ÿä¸€æ¸²æŸ“ï¼Œè·³è¿‡æ—§çš„è‡ªå®šä¹‰å­é¡¹åˆå§‹åŒ–é€»è¾‘');
            return;
            
            // ä»¥ä¸‹ä»£ç å·²åºŸå¼ƒï¼Œä¿ç•™ä»…ä¾›å‚è€ƒ
            /*
            const customPanels = this.getCustomPanels();

            Object.entries(customPanels).forEach(([panelKey, panel]) => {
                if (panel && panel.subItems && panel.subItems.length > 0) {
                    this.refreshBasicPanelContent(panelKey);
                    console.log(`[InfoBarSettings] ğŸ”„ å·²åˆå§‹åŒ–é¢æ¿ ${panelKey} çš„å­é¡¹æ˜¾ç¤º`);
                }
            });
            */

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºè®¾ç½®ç•Œé¢
     */
    async show() {
        try {
            if (!this.initialized) {
                await this.init();
            }

            // åªåœ¨é¦–æ¬¡æ˜¾ç¤ºæˆ–æ˜ç¡®éœ€è¦åˆ·æ–°æ—¶åŠ è½½è®¾ç½®
            if (!this.settingsLoaded || this.needsSettingsRefresh) {
                console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½æœ€æ–°è®¾ç½®...');
                await this.loadSettings();
                this.settingsLoaded = true;
                this.needsSettingsRefresh = false;
            } else {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨å·²ç¼“å­˜çš„è®¾ç½®');
            }

            // ç¡®ä¿æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½
            this.ensureDataManagementStyles();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            this.modal.style.display = 'flex';
            this.visible = true;

            // ğŸ†• å¯åŠ¨ç‰ˆæœ¬æ£€æµ‹
            this.checkVersion();

            // ğŸ†• åŠ è½½å…¬å‘Š
            this.loadAnnouncement();

            // ğŸ”§ ä¿®å¤ï¼šå»¶è¿Ÿåˆå§‹åŒ–åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­é¡¹ï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½
            setTimeout(() => {
                this.initAllBasicPanelCustomSubItems();
                // åˆ·æ–°å·²ä¿å­˜é…ç½®ä¸‹æ‹‰
                this.refreshProfilesSelect();
                // ğŸ†• åˆ·æ–°é¢„è®¾åˆ—è¡¨
                this.refreshPresetList();
                // ğŸ†• åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿
                this.initWorldBookConfigPanel();
                // åº”ç”¨è°ƒè¯•çº§åˆ«åˆ°æ§åˆ¶å°
                const enabled = this.modal.querySelector('[name="debug.enabled"]')?.checked;
                const level = this.modal.querySelector('[name="debug.logLevel"]').value || 'info';
                this.applyConsoleLogLevel(enabled ? level : 'none');
            }, 100); // 100mså»¶è¿Ÿç¡®ä¿DOMæ¸²æŸ“å®Œæˆ

            // è§¦å‘æ˜¾ç¤ºäº‹ä»¶
            if (this.eventSystem) {
                this.eventSystem.emit('ui:show', {
                    component: 'InfoBarSettings',
                    timestamp: Date.now()
                });
            }

            console.log('[InfoBarSettings] ğŸ‘ï¸ è®¾ç½®ç•Œé¢å·²æ˜¾ç¤º');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºç•Œé¢å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * éšè—è®¾ç½®ç•Œé¢
     */
    hide() {
        try {
            this.modal.style.display = 'none';
            this.visible = false;

            // è§¦å‘éšè—äº‹ä»¶
            if (this.eventSystem) {
                this.eventSystem.emit('ui:hide', {
                    component: 'InfoBarSettings',
                    timestamp: Date.now()
                });
            }

            console.log('[InfoBarSettings] ğŸ‘ï¸ è®¾ç½®ç•Œé¢å·²éšè—');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éšè—ç•Œé¢å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * åˆ‡æ¢æ ‡ç­¾é¡µ
     */
    switchTab(tabName) {
        try {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            this.modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // æ›´æ–°é¢æ¿æ˜¾ç¤ºçŠ¶æ€
            this.modal.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.panel === tabName);
            });

            this.currentTab = tabName;

            console.log(`[InfoBarSettings] ğŸ“‘ åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);

            // ğŸ”§ ä¿®å¤ï¼šåˆ‡æ¢åˆ°NPCç®¡ç†æ ‡ç­¾æ—¶ï¼Œåˆå§‹åŒ–é¢æ¿å†…å®¹
            if (tabName === 'npc') {
                console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢åˆ°NPCç®¡ç†æ ‡ç­¾ï¼Œåˆå§‹åŒ–é¢æ¿å†…å®¹');
                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    this.initNPCManagementPanelContent();
                }, 100);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥:', error);
            this.handleError(error);
        }
    }
    /**
     * ğŸ”§ é…ç½®å®Œæ•´æ€§æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤
     */
    async validateAndRestoreConfigs(configs) {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹é…ç½®å®Œæ•´æ€§æ£€æŸ¥...');

            // å®šä¹‰å¿…éœ€çš„é…ç½®é”®
            const requiredConfigs = [
                'memoryEnhancement',
                'vectorFunction',
                'summarySettings',
                'vectorizedSummary',
                'apiConfig',
                'vectorAPIConfig',
                'customPanels',
                'promptSettings'
            ];

            const missingConfigs = [];
            const restoredConfigs = [];

            // æ£€æŸ¥æ¯ä¸ªå¿…éœ€é…ç½®æ˜¯å¦å­˜åœ¨
            for (const configKey of requiredConfigs) {
                // ğŸ”§ ä¿®å¤ï¼šåªæ£€æŸ¥é…ç½®æ˜¯å¦ä¸º undefined æˆ– nullï¼Œä¸æ£€æŸ¥ç©ºå¯¹è±¡
                // ç©ºå¯¹è±¡å¯èƒ½æ˜¯ç”¨æˆ·æœ‰æ„è®¾ç½®çš„ï¼ˆæ¯”å¦‚ç¦ç”¨äº†æ‰€æœ‰åŠŸèƒ½ï¼‰
                // è¿™æ ·å¯ä»¥é¿å…ä¸å…¶ä»–æ’ä»¶çš„ä¿å­˜æ“ä½œå†²çª
                if (configs[configKey] === undefined || configs[configKey] === null) {
                    missingConfigs.push(configKey);
                    console.warn(`[InfoBarSettings] âš ï¸ é…ç½®ç¼ºå¤±: ${configKey}`);

                    // å°è¯•ä»é»˜è®¤é…ç½®æ¢å¤
                    const defaultConfig = this.getDefaultConfig(configKey);
                    if (defaultConfig) {
                        configs[configKey] = defaultConfig;
                        restoredConfigs.push(configKey);
                        console.log(`[InfoBarSettings] âœ… å·²æ¢å¤é»˜è®¤é…ç½®: ${configKey}`);
                    }
                }
            }

            // å¦‚æœæœ‰é…ç½®è¢«æ¢å¤ï¼Œä¿å­˜åˆ°settings.json
            if (restoredConfigs.length > 0) {
                console.log(`[InfoBarSettings] ğŸ’¾ ä¿å­˜æ¢å¤çš„é…ç½®: ${restoredConfigs.join(', ')}`);
                const context = SillyTavern.getContext();
                if (context.saveSettingsDebounced) {
                    await context.saveSettingsDebounced();
                }
                this.showMessage(`âš ï¸ æ£€æµ‹åˆ°${restoredConfigs.length}ä¸ªé…ç½®ç¼ºå¤±ï¼Œå·²è‡ªåŠ¨æ¢å¤é»˜è®¤å€¼`, 'warning');
            }

            // æ‰“å°é…ç½®å®Œæ•´æ€§æŠ¥å‘Š
            console.log('[InfoBarSettings] ğŸ“Š é…ç½®å®Œæ•´æ€§æŠ¥å‘Š:', {
                total: requiredConfigs.length,
                missing: missingConfigs.length,
                restored: restoredConfigs.length,
                missingList: missingConfigs,
                restoredList: restoredConfigs
            });

            // ğŸ”§ å…³é”®ä¿®å¤ï¼šè‡ªåŠ¨ä¿®å¤APIæ¨¡å¼é…ç½®ä¸ä¸€è‡´é—®é¢˜
            // å¦‚æœapiConfig.enabledä¸ºtrueï¼Œä½†basic.apiGenerationModeæœªè®¾ç½®ï¼Œåˆ™è‡ªåŠ¨è®¾ç½®ä¸º'custom'
            if (configs.apiConfig?.enabled === true) {
                if (!configs.basic) {
                    configs.basic = {};
                }
                if (!configs.basic.apiGenerationMode) {
                    configs.basic.apiGenerationMode = 'custom';
                    console.log('[InfoBarSettings] ğŸ”§ è‡ªåŠ¨ä¿®å¤ï¼šæ£€æµ‹åˆ°è‡ªå®šä¹‰APIå·²å¯ç”¨ä½†ç¼ºå°‘apiGenerationModeé…ç½®ï¼Œå·²è‡ªåŠ¨è®¾ç½®ä¸º"custom"');
                    
                    // ä¿å­˜ä¿®å¤åçš„é…ç½®
                    const context = SillyTavern.getContext();
                    if (context.saveSettingsDebounced) {
                        await context.saveSettingsDebounced();
                    }
                }
            } else if (configs.apiConfig?.enabled === false || !configs.apiConfig?.enabled) {
                // å¦‚æœè‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œç¡®ä¿apiGenerationModeä¸º'main'
                if (!configs.basic) {
                    configs.basic = {};
                }
                if (configs.basic.apiGenerationMode !== 'main') {
                    configs.basic.apiGenerationMode = 'main';
                    console.log('[InfoBarSettings] ğŸ”§ è‡ªåŠ¨ä¿®å¤ï¼šæ£€æµ‹åˆ°è‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œå·²è‡ªåŠ¨è®¾ç½®apiGenerationModeä¸º"main"');
                    
                    // ä¿å­˜ä¿®å¤åçš„é…ç½®
                    const context = SillyTavern.getContext();
                    if (context.saveSettingsDebounced) {
                        await context.saveSettingsDebounced();
                    }
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é…ç½®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ è·å–é»˜è®¤é…ç½®
     */
    getDefaultConfig(configKey) {
        const defaults = {
            memoryEnhancement: {
                ai: {
                    enabled: false,
                    messageLevelSummary: false,
                    importanceThreshold: 0.5
                },
                aiDatabase: {
                    enabled: false,
                    autoIndexing: true,
                    minKeywordLength: 2,
                    maxKeywordsPerMemory: 10
                }
            },
            vectorFunction: {
                chunkSize: 500,
                overlapSize: 50,
                batchSize: 10,
                enableSmartAnalysis: false,
                extractPlotSummary: true,
                analyzeWritingStyle: true,
                extractTimeline: true,
                markKeyScenes: true,
                extractCharacters: true,
                enableAIRetrieval: false,
                enableMultiRecall: false, // ğŸ†• å¤šè·¯å¬å›+é‡æ’åº
                retrievalTopK: 5,
                retrievalInjectionPosition: 'system'
            },
            summarySettings: {
                autoSummaryEnabled: false,
                summaryFloorCount: 20,
                summaryType: 'small',
                summaryWordCount: 300,
                injectSummaryEnabled: false,
                autoHideEnabled: false,
                autoHideThreshold: 30,
                autoUploadNewSummary: false,
                worldBookEntryFormat: 'auto',
                worldBookCustomEntryName: '',
                worldBookAddTimestamp: true,
                worldBookUseContentTags: true,
                useRegexFilter: false,
                npcMode: 'panel',
                npcAiUpdateFloor: 20,
                npcAiUseRegex: false,
                useCustomPrompt: false,
                customPrompt: '',
                // ğŸ†• ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–è®¾ç½®
                vectorizeSummaryEnabled: false,
                vectorizeSummaryFloorCount: 100
            },
            vectorizedSummary: {
                settings: {
                    mode: 'traditional',
                    enabled: false,
                    floorCount: 20,
                    autoHideEnabled: false,
                    keepRecentCount: 10
                }
            },
            apiConfig: {
                enabled: false,
                provider: 'gemini',
                format: 'native',
                endpoint: '',
                apiKey: '',
                model: 'gemini-pro',
                temperature: 0.7,
                maxTokens: 2000,
                retryCount: 3,
                extraPrompt: ''
            },
            vectorAPIConfig: {
                provider: 'localproxy',
                baseUrl: '',
                apiKey: '',
                model: '',
                dimensions: 1536,
                batchSize: 100
            },
            customPanels: {},
            promptSettings: {
                mode: 'smart',
                customContent: ''
            }
        };

        return defaults[configKey] || null;
    }

    /**
     * åŠ è½½è®¾ç½®åˆ°è¡¨å•
     */
    async loadSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ å¼€å§‹åŠ è½½è®¾ç½®...');

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            const configs = extensionSettings['Information bar integration tool'];

            // ğŸ”§ æ–°å¢ï¼šé…ç½®å®Œæ•´æ€§æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤
            await this.validateAndRestoreConfigs(configs);

            // ç‰¹åˆ«å¤„ç†å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼Œç¡®ä¿ä»FrontendDisplayManagerè¯»å–æœ€æ–°çŠ¶æ€
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
                            if (fdm) {
                const frontendDisplayConfig = await fdm.getSavedFrontendDisplayConfig();
                if (frontendDisplayConfig) {
                    configs.frontendDisplay = frontendDisplayConfig;
                    console.log('[InfoBarSettings] ğŸ“± å·²åŠ è½½å‰ç«¯æ˜¾ç¤ºé…ç½®:', frontendDisplayConfig);

                    // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“é¢„è§ˆå†…å®¹
                    this.renderFrontendDisplayPreview(frontendDisplayConfig);
                }
            }

            // å¡«å……è¡¨å• - é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
            this.loadNestedConfigs(configs);

            // æ ¹æ®åŠ è½½çš„å‰ç«¯æ˜¾ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè®¾ç½®UIåŒºåŸŸçš„æ˜¾ç¤º/éšè—
            if (configs.frontendDisplay && typeof configs.frontendDisplay.enabled === 'boolean') {
                this.toggleFrontendDisplaySections(configs.frontendDisplay.enabled);
                console.log('[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºåŒºåŸŸçŠ¶æ€å·²è®¾ç½®:', configs.frontendDisplay.enabled);
            }

            // ç‰¹åˆ«å¤„ç†è‡ªå®šä¹‰é¢æ¿é…ç½®ï¼Œç¡®ä¿è®¾ç½®åˆ°å…¨å±€å˜é‡
            if (configs.customPanels && typeof configs.customPanels === 'object') {
                window.InfoBarCustomPanels = configs.customPanels;
                console.log('[InfoBarSettings] ğŸ“Š å·²åŠ è½½è‡ªå®šä¹‰é¢æ¿é…ç½®:', Object.keys(configs.customPanels).length, 'ä¸ªé¢æ¿');

                // æ‰“å°è¯¦ç»†çš„é¢æ¿ä¿¡æ¯ç”¨äºè°ƒè¯•
                for (const [panelId, panel] of Object.entries(configs.customPanels)) {
                    console.log(`[InfoBarSettings] ğŸ“‹ é¢æ¿ ${panelId}:`, panel.name, panel.enabled ? '(å¯ç”¨)' : '(ç¦ç”¨)');
                }

                // è®¾ç½®è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
                this.loadCustomPanelSubItemStates(configs.customPanels);
            } else {
                // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡
                window.InfoBarCustomPanels = {};
                console.log('[InfoBarSettings] ğŸ“Š åˆå§‹åŒ–ç©ºçš„è‡ªå®šä¹‰é¢æ¿é…ç½®');
            }

            // ğŸ”§ æ–°å¢ï¼šåŠ è½½åŸºç¡€é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
            this.loadBasicPanelSubItemStates(configs);

            // ç‰¹åˆ«å¤„ç†ä¸»é¢˜é…ç½®
            if (configs.theme && configs.theme.current) {
                const themeId = configs.theme.current;
                console.log('[InfoBarSettings] ğŸ¨ åŠ è½½ä¸»é¢˜é…ç½®:', themeId);

                // æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
                this.updateThemeCardStates(themeId);

                // åº”ç”¨ä¸»é¢˜
                const theme = this.getThemeById(themeId);
                if (theme) {
                    this.applyTheme(theme);
                    this.updateCurrentThemeInfo(theme);
                }
            }

            // ç‰¹åˆ«å¤„ç†é£æ ¼é…ç½®
            if (configs.style && configs.style.current) {
                const styleId = configs.style.current;
                console.log('[InfoBarSettings] ğŸ­ åŠ è½½é£æ ¼é…ç½®:', styleId);

                // æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
                this.updateStyleCardStates(styleId);

                // åº”ç”¨é£æ ¼
                const style = this.getStyleById(styleId);
                if (style) {
                    this.applyStyle(style);
                    this.updateCurrentStyleInfo(style);
                }
            }

            // æ›´æ–°APIçŠ¶æ€
            if (this.apiIntegration) {
                this.updateAPIStatus();
            }

            // ğŸ†• æ¢å¤APIæ¨¡å¼çŠ¶æ€
            const tableRecordsEnabled = configs.basic?.tableRecords?.enabled === true;
            const apiModeSelection = this.modal.querySelector('#api-mode-selection');
            if (apiModeSelection) {
                apiModeSelection.style.display = tableRecordsEnabled ? 'block' : 'none';
                console.log('[InfoBarSettings] ğŸ“Š APIæ¨¡å¼é€‰æ‹©åŒºåŸŸåˆå§‹çŠ¶æ€:', tableRecordsEnabled ? 'æ˜¾ç¤º' : 'éšè—');
            }

            // æ¢å¤APIæ¨¡å¼æŒ‰é’®çŠ¶æ€
            const apiEnabled = configs.apiConfig?.enabled === true;
            const currentMode = apiEnabled ? 'custom' : 'main';
            const buttons = this.modal.querySelectorAll('.api-mode-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.mode === currentMode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                }
            });

            // æ¢å¤æè¿°æ–‡æœ¬æ˜¾ç¤ºçŠ¶æ€
            const mainDesc = this.modal.querySelector('.main-mode-desc');
            const customDesc = this.modal.querySelector('.custom-mode-desc');
            if (mainDesc && customDesc) {
                mainDesc.style.display = currentMode === 'main' ? 'block' : 'none';
                customDesc.style.display = currentMode === 'custom' ? 'block' : 'none';
            }

            console.log('[InfoBarSettings] ğŸ”„ å·²æ¢å¤APIæ¨¡å¼çŠ¶æ€:', currentMode);

            // ğŸ†• åŠ è½½å‘é‡åŒ–APIé…ç½®
            if (configs.vectorAPIConfig) {
                console.log('[InfoBarSettings] ğŸ§  åŠ è½½å‘é‡åŒ–APIé…ç½®...', configs.vectorAPIConfig);

                // åŠ è½½è¿æ¥æ¨¡å¼
                const vectorProviderEl = this.modal.querySelector('#infobar-vector-api-provider');
                if (vectorProviderEl && configs.vectorAPIConfig.provider) {
                    vectorProviderEl.value = configs.vectorAPIConfig.provider;
                    // è§¦å‘provider changeäº‹ä»¶ä»¥è®¾ç½®é»˜è®¤URL
                    this.handleVectorProviderChange(configs.vectorAPIConfig.provider);
                    console.log('[InfoBarSettings] âœ… å‘é‡åŒ–Providerå·²åŠ è½½:', configs.vectorAPIConfig.provider);
                }

                // åŠ è½½åŸºç¡€URL
                const vectorBaseUrlEl = this.modal.querySelector('#infobar-vector-api-base-url');
                if (vectorBaseUrlEl && configs.vectorAPIConfig.baseUrl) {
                    vectorBaseUrlEl.value = configs.vectorAPIConfig.baseUrl;
                    console.log('[InfoBarSettings] âœ… å‘é‡åŒ–BaseURLå·²åŠ è½½:', configs.vectorAPIConfig.baseUrl);
                }

                // åŠ è½½APIå¯†é’¥
                const vectorApiKeyEl = this.modal.querySelector('#infobar-vector-api-key');
                if (vectorApiKeyEl && configs.vectorAPIConfig.apiKey) {
                    vectorApiKeyEl.value = configs.vectorAPIConfig.apiKey;
                    console.log('[InfoBarSettings] âœ… å‘é‡åŒ–APIå¯†é’¥å·²åŠ è½½');
                }

                // åŠ è½½å‘é‡åŒ–æ¨¡å‹
                const vectorModelEl = this.modal.querySelector('#infobar-vector-api-model');
                if (vectorModelEl && configs.vectorAPIConfig.model) {
                    // å¦‚æœæ¨¡å‹ä¸‹æ‹‰æ¡†ä¸ºç©ºï¼Œå…ˆæ·»åŠ ä¿å­˜çš„æ¨¡å‹ä½œä¸ºé€‰é¡¹
                    if (vectorModelEl.options.length <= 1) {
                        const option = document.createElement('option');
                        option.value = configs.vectorAPIConfig.model;
                        option.textContent = configs.vectorAPIConfig.model;
                        vectorModelEl.appendChild(option);
                        console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ¨¡å‹é€‰é¡¹å·²æ·»åŠ :', configs.vectorAPIConfig.model);
                    }
                    vectorModelEl.value = configs.vectorAPIConfig.model;
                    console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ¨¡å‹å·²åŠ è½½:', configs.vectorAPIConfig.model);
                }

                // åŠ è½½å‘é‡ç»´åº¦
                const vectorDimensionsEl = this.modal.querySelector('#infobar-vector-api-dimensions');
                if (vectorDimensionsEl && configs.vectorAPIConfig.dimensions) {
                    vectorDimensionsEl.value = configs.vectorAPIConfig.dimensions;
                    console.log('[InfoBarSettings] âœ… å‘é‡ç»´åº¦å·²åŠ è½½:', configs.vectorAPIConfig.dimensions);
                }

                // åŠ è½½æ‰¹å¤„ç†å¤§å°
                const vectorBatchSizeEl = this.modal.querySelector('#infobar-vector-api-batch-size');
                if (vectorBatchSizeEl && configs.vectorAPIConfig.batchSize) {
                    vectorBatchSizeEl.value = configs.vectorAPIConfig.batchSize;
                    console.log('[InfoBarSettings] âœ… æ‰¹å¤„ç†å¤§å°å·²åŠ è½½:', configs.vectorAPIConfig.batchSize);
                }

                // ğŸ†• åŠ è½½é‡æ’åºæ¨¡å‹
                const vectorRerankModelEl = this.modal.querySelector('#infobar-vector-api-rerank-model');
                if (vectorRerankModelEl && configs.vectorAPIConfig.rerankModel) {
                    vectorRerankModelEl.value = configs.vectorAPIConfig.rerankModel;
                    console.log('[InfoBarSettings] âœ… é‡æ’åºæ¨¡å‹å·²åŠ è½½:', configs.vectorAPIConfig.rerankModel);
                }

                // ğŸ†• åŠ è½½é‡æ’åºæ¨¡å‹å‚æ•°
                const vectorRerankParamsEl = this.modal.querySelector('#infobar-vector-api-rerank-params');
                if (vectorRerankParamsEl && configs.vectorAPIConfig.rerankParams) {
                    vectorRerankParamsEl.value = typeof configs.vectorAPIConfig.rerankParams === 'string'
                        ? configs.vectorAPIConfig.rerankParams
                        : JSON.stringify(configs.vectorAPIConfig.rerankParams, null, 2);
                    console.log('[InfoBarSettings] âœ… é‡æ’åºæ¨¡å‹å‚æ•°å·²åŠ è½½');
                }

                console.log('[InfoBarSettings] âœ… å‘é‡åŒ–APIé…ç½®åŠ è½½å®Œæˆ');
            }

            // ğŸ†• æ¢å¤APIç±»å‹é€‰æ‹©çŠ¶æ€
            const currentAPIType = configs.currentAPIType || 'general';
            this.switchAPIType(currentAPIType);

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½å¤„ç†APIæ¨¡å‹é…ç½® - ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œé¿å…ä¸å¿…è¦çš„APIè°ƒç”¨
            if (configs.apiConfig && configs.apiConfig.model && configs.apiConfig.provider && configs.apiConfig.apiKey) {
                console.log('[InfoBarSettings] ğŸ”„ æ£€æµ‹åˆ°ä¿å­˜çš„æ¨¡å‹é…ç½®ï¼Œæ™ºèƒ½åŠ è½½æ¨¡å‹åˆ—è¡¨...');
                console.log('[InfoBarSettings] ğŸ“‹ ä¿å­˜çš„æ¨¡å‹:', configs.apiConfig.model);
                console.log('[InfoBarSettings] ğŸ¢ æä¾›å•†:', configs.apiConfig.provider);

                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIå·²å®Œå…¨æ¸²æŸ“
                setTimeout(async () => {
                    try {
                        // ğŸ”§ æ–°å¢ï¼šä¼˜å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½æ¨¡å‹åˆ—è¡¨
                        const cachedModels = await this.loadCachedModelList(configs.apiConfig);

                        if (cachedModels && cachedModels.length > 0) {
                            console.log('[InfoBarSettings] âœ… ä½¿ç”¨ç¼“å­˜çš„æ¨¡å‹åˆ—è¡¨ï¼Œé¿å…APIè°ƒç”¨');
                            this.populateModelSelect(cachedModels);

                            // æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©
                            const modelSelect = this.modal.querySelector('#infobar-api-model');
                            if (modelSelect && configs.apiConfig.model) {
                                modelSelect.value = configs.apiConfig.model;
                                console.log('[InfoBarSettings] âœ… å·²æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©:', configs.apiConfig.model);
                            }
                        } else {
                            console.log('[InfoBarSettings] âš ï¸ ç¼“å­˜ä¸­æ— æœ‰æ•ˆæ¨¡å‹åˆ—è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨åŠ è½½');
                            // æ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼Œä¸è‡ªåŠ¨è°ƒç”¨API
                            this.showModelLoadingHint();
                        }
                    } catch (error) {
                        console.error('[InfoBarSettings] âŒ æ™ºèƒ½åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                        this.showModelLoadingHint();
                    }
                }, 500);
            }

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆåŠ è½½è‡ªå®šä¹‰é¢æ¿ï¼‰
            this.refreshNavigation();

            // æ›´æ–°æ‰€æœ‰é¢æ¿çš„é…ç½®è®¡æ•°
            this.updateAllPanelCounts();

            // ğŸ”§ ä¿®å¤ï¼šæ¢å¤æç¤ºè¯æ’å…¥ä½ç½®UIçŠ¶æ€
            const promptPositionMode = configs.basic?.promptPosition?.mode || 'afterCharacter';
            console.log('[InfoBarSettings] ğŸ“ æ¢å¤æç¤ºè¯ä½ç½®UIçŠ¶æ€:', promptPositionMode);
            this.handlePromptPositionModeChange(promptPositionMode);

            // ğŸ§  åŠ è½½æç¤ºè¯è®¾ç½®
            await this.loadPromptSettings();

            // ğŸ”§ æ–°å¢ï¼šæ¢å¤ä¼ ç»Ÿæ€»ç»“è®¾ç½®
            if (configs.summarySettings) {
                console.log('[InfoBarSettings] ğŸ“ æ¢å¤ä¼ ç»Ÿæ€»ç»“è®¾ç½®:', configs.summarySettings);

                const autoSummaryEnabled = this.modal.querySelector('#content-auto-summary-enabled');
                if (autoSummaryEnabled) {
                    autoSummaryEnabled.checked = configs.summarySettings.autoSummaryEnabled || false;
                }

                const summaryFloorCount = this.modal.querySelector('#content-summary-floor-count');
                if (summaryFloorCount) {
                    summaryFloorCount.value = configs.summarySettings.summaryFloorCount || 20;
                }

                const summaryType = this.modal.querySelector('#content-summary-type');
                if (summaryType) {
                    summaryType.value = configs.summarySettings.summaryType || 'small';
                }

                const summaryWordCount = this.modal.querySelector('#content-summary-word-count');
                if (summaryWordCount) {
                    summaryWordCount.value = configs.summarySettings.summaryWordCount || 300;
                }

                const injectSummaryEnabled = this.modal.querySelector('#content-inject-summary-enabled');
                if (injectSummaryEnabled) {
                    injectSummaryEnabled.checked = configs.summarySettings.injectSummaryEnabled || false;
                }

                const useRegexFilter = this.modal.querySelector('#content-summary-use-regex');
                if (useRegexFilter) {
                    useRegexFilter.checked = configs.summarySettings.useRegexFilter || false;
                }

                const autoHideEnabled = this.modal.querySelector('#content-auto-hide-enabled');
                if (autoHideEnabled) {
                    autoHideEnabled.checked = configs.summarySettings.autoHideEnabled || false;
                }

                const useCustomPrompt = this.modal.querySelector('#content-use-custom-prompt');
                if (useCustomPrompt) {
                    useCustomPrompt.checked = configs.summarySettings.useCustomPrompt || false;
                }

                const customPrompt = this.modal.querySelector('#content-custom-prompt');
                if (customPrompt) {
                    customPrompt.value = configs.summarySettings.customPrompt || '';
                }
            }

            // ğŸ”§ æ–°å¢ï¼šæ¢å¤å‘é‡åŒ–æ€»ç»“è®¾ç½®
            if (configs.vectorizedSummary && configs.vectorizedSummary.settings) {
                const vectorizedSettings = configs.vectorizedSummary.settings;
                console.log('[InfoBarSettings] ğŸ”® æ¢å¤å‘é‡åŒ–æ€»ç»“è®¾ç½®:', vectorizedSettings);

                // æ¢å¤æ¨¡å¼çŠ¶æ€
                const summaryMode = vectorizedSettings.mode || 'traditional';
                this.handleSummaryModeChange(summaryMode);

                // æ¢å¤å‘é‡åŒ–æ€»ç»“å¯ç”¨çŠ¶æ€
                const vectorizedEnabled = this.modal.querySelector('#vectorized-summary-enabled');
                if (vectorizedEnabled) {
                    vectorizedEnabled.checked = vectorizedSettings.enabled || false;
                }

                // æ¢å¤æ€»ç»“æ¥¼å±‚æ•°
                const vectorizedFloorCount = this.modal.querySelector('#vectorized-summary-floor-count');
                if (vectorizedFloorCount) {
                    vectorizedFloorCount.value = vectorizedSettings.floorCount || 20;
                }

                // æ¢å¤è‡ªåŠ¨éšè—å¯ç”¨çŠ¶æ€
                const vectorizedAutoHide = this.modal.querySelector('#vectorized-auto-hide-enabled');
                if (vectorizedAutoHide) {
                    vectorizedAutoHide.checked = vectorizedSettings.autoHideEnabled || false;

                    // æ ¹æ®è‡ªåŠ¨éšè—çŠ¶æ€æ˜¾ç¤º/éšè—ä¿ç•™æœ€æ–°æ¥¼å±‚æ•°è¾“å…¥æ¡†
                    const keepRecentRow = this.modal.querySelector('#vectorized-keep-recent-row');
                    if (keepRecentRow) {
                        keepRecentRow.style.display = vectorizedSettings.autoHideEnabled ? 'block' : 'none';
                    }
                }

                // æ¢å¤ä¿ç•™æœ€æ–°æ¥¼å±‚æ•°
                const keepRecentCount = this.modal.querySelector('#vectorized-keep-recent-count');
                if (keepRecentCount) {
                    keepRecentCount.value = vectorizedSettings.keepRecentCount || 10;
                }
            }

            console.log('[InfoBarSettings] âœ… è®¾ç½®åŠ è½½å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è®¾ç½®å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * é€’å½’åŠ è½½åµŒå¥—é…ç½®
     */
    loadNestedConfigs(configs, prefix = '') {
        try {
            for (const [key, value] of Object.entries(configs)) {
                const fullKey = prefix ? `${prefix}.${key}` : key;

                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
                    this.loadNestedConfigs(value, fullKey);
                } else {
                    // è®¾ç½®è¡¨å•å€¼
                    this.setFormValue(fullKey, value);
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½åµŒå¥—é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * è®¾ç½®è¡¨å•å€¼
     */
    setFormValue(name, value) {
        try {
            const element = this.modal.querySelector(`[name="${name}"]`);

            if (!element) {
                return;
            }

            if (element.type === 'checkbox') {
                element.checked = Boolean(value);
                
                // ğŸ†• ç‰¹æ®Šå¤„ç†ç ´ç”²æç¤ºè¯å¼€å…³ - åŠ è½½è®¾ç½®æ—¶åŒæ­¥æ˜¾ç¤º/éšè—é…ç½®åŒºåŸŸ
                if (name === 'apiConfig.enableArmorBreaking') {
                    const armorBreakingSection = this.modal.querySelector('.armor-breaking-config-section');
                    if (armorBreakingSection) {
                        armorBreakingSection.style.display = element.checked ? 'block' : 'none';
                        console.log(`[InfoBarSettings] ğŸ›¡ï¸ åŠ è½½è®¾ç½®æ—¶ï¼šç ´ç”²æç¤ºè¯é…ç½®åŒºåŸŸ${element.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                    }
                }

                // ğŸ†• ç‰¹æ®Šå¤„ç†å»¶è¿Ÿç”Ÿæˆå¼€å…³ - åŠ è½½è®¾ç½®æ—¶åŒæ­¥æ˜¾ç¤º/éšè—é…ç½®åŒºåŸŸ
                if (name === 'apiConfig.delayedGeneration') {
                    const delayedGenerationConfig = this.modal.querySelector('.delayed-generation-config');
                    if (delayedGenerationConfig) {
                        delayedGenerationConfig.style.display = element.checked ? 'block' : 'none';
                        console.log(`[InfoBarSettings] â±ï¸ åŠ è½½è®¾ç½®æ—¶ï¼šå»¶è¿Ÿç”Ÿæˆé…ç½®åŒºåŸŸ${element.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                    }
                }
            } else if (element.type === 'radio') {
                // ğŸ”§ ä¿®å¤ï¼šå•é€‰æ¡†ç‰¹æ®Šå¤„ç†ï¼Œåªè®¾ç½®checkedçŠ¶æ€ï¼Œä¸ä¿®æ”¹valueå±æ€§
                if (element.value === value) {
                    element.checked = true;
                } else {
                    element.checked = false;
                }
            } else if (element.type === 'range') {
                element.value = value;
                const valueSpan = element.nextElementSibling;
                if (valueSpan && valueSpan.classList.contains('range-value')) {
                    valueSpan.textContent = value;
                }
            } else {
                // ç‰¹æ®Šå¤„ç†æ¥å£ç±»å‹é€‰æ‹©å™¨
                if (name === 'apiConfig.format' && element.id === 'infobar-interface-type') {
                    // å¦‚æœæ˜¯æ¥å£ç±»å‹é€‰æ‹©å™¨ï¼Œéœ€è¦å…ˆè§¦å‘æä¾›å•†å˜æ›´æ¥ç”Ÿæˆé€‰é¡¹
                    const providerElement = this.modal.querySelector('[name="apiConfig.provider"]');
                    if (providerElement && providerElement.value) {
                        this.handleProviderChange(providerElement.value);
                        // å»¶è¿Ÿè®¾ç½®å€¼ï¼Œç­‰å¾…é€‰é¡¹ç”Ÿæˆ
                        setTimeout(() => {
                            element.value = value || '';
                            console.log('[InfoBarSettings] âœ… å·²æ¢å¤æ¥å£ç±»å‹:', value);
                        }, 100);
                    } else {
                        element.value = value || '';
                    }
                } else {
                    element.value = value || '';
                }
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ è®¾ç½®è¡¨å•å€¼å¤±è´¥ (${name}):`, error);
        }
    }

    /**
     * ä¿å­˜è®¾ç½®
     */
    async saveSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ å¼€å§‹ä¿å­˜è®¾ç½®...');

            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ä¿å­˜é”ï¼Œé˜²æ­¢å¹¶å‘ä¿å­˜å¯¼è‡´æ•°æ®å†²çª
            if (this._isSaving) {
                console.warn('[InfoBarSettings] âš ï¸ æ­£åœ¨ä¿å­˜ä¸­ï¼Œè·³è¿‡é‡å¤ä¿å­˜è¯·æ±‚');
                this.showMessage('æ­£åœ¨ä¿å­˜ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }

            // è®¾ç½®ä¿å­˜é”
            this._isSaving = true;

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥ç¼“å­˜ï¼Œé¿å…é‡å¤ä¿å­˜ï¼ˆ5ç§’å†…ï¼‰
            const now = Date.now();
            if (this._lastSaveTimestamp && (now - this._lastSaveTimestamp) < 5000) {
                console.log('[InfoBarSettings] â¸ï¸ 5ç§’å†…å·²ä¿å­˜è¿‡ï¼Œä½¿ç”¨ç¼“å­˜ï¼Œè·³è¿‡é‡å¤ä¿å­˜');
                // å³ä½¿è·³è¿‡ä¹Ÿè¦éšè—ç•Œé¢å’Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this._isSaving = false; // é‡Šæ”¾é”
                this.hide();
                this.showMessage('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                return;
            }

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = this.collectFormData();

            // ç¡®ä¿è‡ªå®šä¹‰é¢æ¿æ•°æ®åŒ…å«åœ¨ä¿å­˜çš„é…ç½®ä¸­ï¼Œå¹¶æ›´æ–°å­é¡¹å‹¾é€‰çŠ¶æ€
            const customPanels = this.getCustomPanels();
            if (customPanels && Object.keys(customPanels).length > 0) {
                // æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
                this.updateCustomPanelSubItemStates(customPanels, formData);
                formData.customPanels = customPanels;
                console.log('[InfoBarSettings] ğŸ“Š åŒ…å«è‡ªå®šä¹‰é¢æ¿æ•°æ®:', Object.keys(customPanels).length, 'ä¸ªé¢æ¿');
            }

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ğŸ”§ ä¿®å¤ï¼šä¿å­˜åŸºç¡€è®¾ç½®è¡¨å•æ•°æ®æ—¶ï¼Œä¿ç•™apiConfig.modelCacheã€apiConfig.enabledå’ŒcustomSelectedWorldbooks
            // é¿å…è¦†ç›–æ¨¡å‹ç¼“å­˜å’ŒAPIæ¨¡å¼è®¾ç½®ï¼Œé˜²æ­¢å½±å“å…¶ä»–æ’ä»¶
            const existingApiConfig = extensionSettings['Information bar integration tool'].apiConfig || {};
            const existingModelCache = existingApiConfig.modelCache || {};
            const existingApiEnabled = existingApiConfig.enabled; // ğŸ”§ æ–°å¢ï¼šä¿ç•™APIå¯ç”¨çŠ¶æ€
            const existingCustomWorldbooks = existingApiConfig.customSelectedWorldbooks || []; // ğŸ”§ æ–°å¢ï¼šä¿ç•™é€‰ä¸­çš„ä¸–ç•Œä¹¦

            // åˆå¹¶è¡¨å•æ•°æ®
            Object.assign(extensionSettings['Information bar integration tool'], formData);

            // æ¢å¤æ¨¡å‹ç¼“å­˜ã€APIå¯ç”¨çŠ¶æ€å’Œé€‰ä¸­çš„ä¸–ç•Œä¹¦
            if (extensionSettings['Information bar integration tool'].apiConfig) {
                if (!extensionSettings['Information bar integration tool'].apiConfig.modelCache) {
                    extensionSettings['Information bar integration tool'].apiConfig.modelCache = {};
                }
                Object.assign(extensionSettings['Information bar integration tool'].apiConfig.modelCache, existingModelCache);

                // ğŸ”§ æ–°å¢ï¼šæ¢å¤APIå¯ç”¨çŠ¶æ€ï¼ˆæ•°æ®è¡¨æ ¼APIæ¨¡å¼ï¼‰
                if (existingApiEnabled !== undefined) {
                    extensionSettings['Information bar integration tool'].apiConfig.enabled = existingApiEnabled;
                    console.log('[InfoBarSettings] ğŸ”§ å·²ä¿ç•™apiConfig.enabled:', existingApiEnabled);
                }

                // ğŸ”§ æ–°å¢ï¼šæ¢å¤é€‰ä¸­çš„ä¸–ç•Œä¹¦åˆ—è¡¨
                if (existingCustomWorldbooks.length > 0) {
                    extensionSettings['Information bar integration tool'].apiConfig.customSelectedWorldbooks = existingCustomWorldbooks;
                    console.log('[InfoBarSettings] ğŸ”§ å·²ä¿ç•™customSelectedWorldbooks:', existingCustomWorldbooks.length, 'æœ¬');
                }

                console.log('[InfoBarSettings] ğŸ”§ å·²ä¿ç•™apiConfig.modelCacheï¼Œé¿å…è¦†ç›–æ¨¡å‹ç¼“å­˜');
            }

            // é¢å¤–æ”¶é›†è®°å¿†å¢å¼ºé¢æ¿çš„è®¾ç½®ï¼ˆè¿™äº›æ§ä»¶å¤§å¤šæ²¡æœ‰ nameï¼Œéœ€è¦å•ç‹¬å¤„ç†ï¼‰
            if (typeof this.collectMemoryEnhancementFormData === 'function') {
                const memoryEnhancementData = this.collectMemoryEnhancementFormData();
                if (memoryEnhancementData && typeof memoryEnhancementData === 'object') {
                    extensionSettings['Information bar integration tool'].memoryEnhancement = memoryEnhancementData;
                    console.log('[InfoBarSettings] ğŸ§  å·²æ”¶é›†è®°å¿†å¢å¼ºè®¾ç½®å¹¶å†™å…¥é…ç½®');

                    // ğŸ”§ ä¿®å¤ï¼šåŒæ­¥è®¾ç½®åˆ°å„ä¸ªè®°å¿†å¢å¼ºæ¨¡å—
                    await this.syncMemoryEnhancementSettingsToModules(memoryEnhancementData);
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šé¢å¤–æ”¶é›†NPCç®¡ç†é¢æ¿çš„è®¾ç½®ï¼ˆè¿™äº›æ§ä»¶æ²¡æœ‰ name å±æ€§ï¼‰
            const npcSettings = this.collectNPCManagementSettings();
            if (npcSettings && typeof npcSettings === 'object') {
                Object.assign(extensionSettings['Information bar integration tool'], npcSettings);
                console.log('[InfoBarSettings] ğŸ­ å·²æ”¶é›†NPCç®¡ç†è®¾ç½®å¹¶å†™å…¥é…ç½®:', npcSettings);
            }

            // ğŸ“– æ–°å¢ï¼šæ”¶é›†å‰§æƒ…ä¼˜åŒ–é…ç½®
            const plotOptimizationSettings = this.collectPlotOptimizationSettings();
            if (plotOptimizationSettings && typeof plotOptimizationSettings === 'object') {
                extensionSettings['Information bar integration tool'].plotOptimization = plotOptimizationSettings;
                console.log('[InfoBarSettings] ğŸ“– å·²æ”¶é›†å‰§æƒ…ä¼˜åŒ–é…ç½®:', plotOptimizationSettings);

                // åŒæ­¥åˆ°å‰§æƒ…ä¼˜åŒ–ç³»ç»Ÿ
                const plotOptimizationSystem = window.SillyTavernInfobar?.modules?.plotOptimizationSystem;
                if (plotOptimizationSystem) {
                    Object.assign(plotOptimizationSystem.config, plotOptimizationSettings);
                    await plotOptimizationSystem.setEnabled(plotOptimizationSettings.enabled);
                    console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‰§æƒ…ä¼˜åŒ–é…ç½®åˆ°PlotOptimizationSystemæ¨¡å—');
                }
            }

            // ğŸ“Š æ–°å¢ï¼šæ”¶é›†æ•°æ®è¡¨æ ¼é…ç½®
            const dataTableSettings = this.collectDataTableSettings();
            if (dataTableSettings && typeof dataTableSettings === 'object') {
                // æ›´æ–°basicé…ç½®
                if (!extensionSettings['Information bar integration tool'].basic) {
                    extensionSettings['Information bar integration tool'].basic = {};
                }
                
                extensionSettings['Information bar integration tool'].basic.renderInChat = {
                    enabled: dataTableSettings.renderInChatEnabled
                };

                extensionSettings['Information bar integration tool'].basic.tableRecords = {
                    enabled: dataTableSettings.enabled,
                    apiMode: dataTableSettings.apiMode  // ğŸ”§ ä¿®å¤ï¼šä¿å­˜APIæ¨¡å¼é…ç½®
                };

                extensionSettings['Information bar integration tool'].basic.defaultCollapsed = {
                    enabled: dataTableSettings.defaultCollapsedEnabled
                };

                // æ›´æ–°apiConfigä¸­çš„æ•°æ®è¡¨æ ¼ç›¸å…³é…ç½®
                Object.assign(extensionSettings['Information bar integration tool'].apiConfig, {
                    mergeMessages: dataTableSettings.mergeMessages,
                    delayedGeneration: dataTableSettings.delayedGeneration,
                    delayFloors: dataTableSettings.delayFloors,
                    minMessageLength: dataTableSettings.minMessageLength,
                    tableRecordsAPIMode: dataTableSettings.apiMode,
                    useRegexFilter: dataTableSettings.useRegexFilter
                });
                
                // æ³¨æ„ï¼šincludeWorldBookå’ŒrequestConfirmationç°åœ¨é€šè¿‡APIé…ç½®é¢æ¿çš„nameå±æ€§ç›´æ¥ä¿å­˜

                console.log('[InfoBarSettings] ğŸ“Š å·²æ”¶é›†æ•°æ®è¡¨æ ¼é…ç½®:', dataTableSettings);
            }

            // ğŸ†• æ”¶é›†å‘é‡åŒ–APIé…ç½®
            const vectorAPIConfig = this.collectVectorAPIConfig();
            if (vectorAPIConfig && typeof vectorAPIConfig === 'object') {
                extensionSettings['Information bar integration tool'].vectorAPIConfig = vectorAPIConfig;
                console.log('[InfoBarSettings] ğŸ§  å·²æ”¶é›†å‘é‡åŒ–APIé…ç½®:', vectorAPIConfig);

                // åŒæ­¥åˆ°VectorizedMemoryRetrievalæ¨¡å—
                const vectorizedMemoryRetrieval = window.SillyTavernInfobar?.modules?.vectorizedMemoryRetrieval;
                if (vectorizedMemoryRetrieval) {
                    await vectorizedMemoryRetrieval.updateSettings({
                        useCustomVectorAPI: true,
                        customVectorAPI: {
                            url: vectorAPIConfig.baseUrl,
                            apiKey: vectorAPIConfig.apiKey,
                            model: vectorAPIConfig.model
                        }
                    });
                    console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‘é‡åŒ–APIé…ç½®åˆ°VectorizedMemoryRetrievalæ¨¡å—');
                }
            }

            // ğŸ”§ æ–°å¢ï¼šæ”¶é›†å‘é‡åŠŸèƒ½é…ç½®
            if (typeof this.collectVectorFunctionSettings === 'function') {
                const vectorFunctionSettings = this.collectVectorFunctionSettings();
                if (vectorFunctionSettings && typeof vectorFunctionSettings === 'object') {
                    extensionSettings['Information bar integration tool'].vectorFunction = vectorFunctionSettings;
                    console.log('[InfoBarSettings] ğŸ”® å·²æ”¶é›†å‘é‡åŠŸèƒ½é…ç½®:', vectorFunctionSettings);

                    // åŒæ­¥åˆ°CorpusRetrievalæ¨¡å—
                    const corpusRetrieval = window.SillyTavernInfobar?.modules?.corpusRetrieval;
                    if (corpusRetrieval) {
                        corpusRetrieval.loadConfig();
                        console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‘é‡åŠŸèƒ½é…ç½®åˆ°CorpusRetrievalæ¨¡å—');
                    }

                    // ğŸ”§ ä¿®å¤ï¼šåŒæ­¥åˆ°UnifiedVectorRetrievalæ¨¡å—ï¼ˆé‡è¦ï¼ï¼‰
                    const unifiedVectorRetrieval = window.SillyTavernInfobar?.modules?.unifiedVectorRetrieval;
                    if (unifiedVectorRetrieval) {
                        unifiedVectorRetrieval.loadConfig();
                        console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‘é‡åŠŸèƒ½é…ç½®åˆ°UnifiedVectorRetrievalæ¨¡å—');
                    }
                }
            }

            // ğŸ”§ æ–°å¢ï¼šæ”¶é›†ä¼ ç»Ÿæ€»ç»“é…ç½®
            if (typeof this.getCurrentSummarySettings === 'function') {
                const summarySettings = this.getCurrentSummarySettings();
                if (summarySettings && typeof summarySettings === 'object') {
                    extensionSettings['Information bar integration tool'].summarySettings = summarySettings;
                    console.log('[InfoBarSettings] ğŸ“ å·²æ”¶é›†ä¼ ç»Ÿæ€»ç»“é…ç½®:', summarySettings);

                    // åŒæ­¥åˆ°SummaryManageræ¨¡å—
                    const summaryManager = window.SillyTavernInfobar?.modules?.summaryManager;
                    if (summaryManager && typeof summaryManager.updateSettings === 'function') {
                        summaryManager.updateSettings(summarySettings);
                        console.log('[InfoBarSettings] âœ… å·²åŒæ­¥ä¼ ç»Ÿæ€»ç»“é…ç½®åˆ°SummaryManageræ¨¡å—');
                    }
                }
            }

            // ğŸ”§ æ–°å¢ï¼šæ”¶é›†å‘é‡åŒ–æ€»ç»“é…ç½®
            if (typeof this.collectVectorizedSummarySettings === 'function') {
                const vectorizedSummarySettings = this.collectVectorizedSummarySettings();
                if (vectorizedSummarySettings && typeof vectorizedSummarySettings === 'object') {
                    // ä¿å­˜åˆ°æ‰©å±•è®¾ç½®
                    if (!extensionSettings['Information bar integration tool'].vectorizedSummary) {
                        extensionSettings['Information bar integration tool'].vectorizedSummary = {};
                    }
                    extensionSettings['Information bar integration tool'].vectorizedSummary.settings = vectorizedSummarySettings;
                    console.log('[InfoBarSettings] ğŸ”® å·²æ”¶é›†å‘é‡åŒ–æ€»ç»“é…ç½®:', vectorizedSummarySettings);

                    // åŒæ­¥åˆ°VectorizedSummaryManageræ¨¡å—
                    const vectorizedSummaryManager = window.SillyTavernInfobar?.modules?.vectorizedSummaryManager;
                    if (vectorizedSummaryManager) {
                        vectorizedSummaryManager.settings = vectorizedSummarySettings;
                        console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‘é‡åŒ–æ€»ç»“é…ç½®åˆ°VectorizedSummaryManageræ¨¡å—');
                    }
                }
            }

            // ğŸ”§ æ–°å¢ï¼šè§¦å‘ä¿å­˜å‰äº‹ä»¶ï¼Œå…è®¸å…¶ä»–æ¨¡å—ä¿å­˜è‡ªå·±çš„é…ç½®
            if (this.eventSystem) {
                this.eventSystem.emit('settings:before-save', {
                    extensionSettings: extensionSettings['Information bar integration tool'],
                    timestamp: now
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šåªè°ƒç”¨ä¸€æ¬¡ä¿å­˜ï¼Œé¿å…ä¸SillyTavernä¿å­˜æœºåˆ¶å†²çª
            // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œè®©SillyTavernè‡ªå·±å†³å®šä½•æ—¶çœŸæ­£å†™å…¥æ–‡ä»¶
            if (context.saveSettingsDebounced) {
                await context.saveSettingsDebounced();
                console.log('[InfoBarSettings] ğŸ’¾ å·²è§¦å‘é…ç½®ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ saveSettingsDebouncedä¸å¯ç”¨');
            }

            // ğŸ”§ æ–°å¢ï¼šæ›´æ–°ç¼“å­˜æ—¶é—´æˆ³
            this._lastSaveTimestamp = now;

            // ğŸ”§ æ–°å¢ï¼šä¿å­˜é…ç½®ç¼“å­˜ï¼ˆç”¨äºéªŒè¯ï¼‰
            this._savedConfigsCache = JSON.parse(JSON.stringify(extensionSettings['Information bar integration tool']));

            console.log('[InfoBarSettings] ğŸ’¾ é…ç½®å·²æŒä¹…åŒ–åˆ°settings.json');

            // ğŸ”§ æ–°å¢ï¼šéªŒè¯é…ç½®å®Œæ•´æ€§
            await this.validateConfigIntegrity();

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯å…³é”®é…ç½®æ˜¯å¦æˆåŠŸä¿å­˜
            const savedConfig = extensionSettings['Information bar integration tool'];
            const missingConfigs = [];
            if (!savedConfig.memoryEnhancement) missingConfigs.push('memoryEnhancement');
            if (!savedConfig.vectorFunction) missingConfigs.push('vectorFunction');
            if (!savedConfig.summarySettings) missingConfigs.push('summarySettings');
            if (!savedConfig.vectorizedSummary) missingConfigs.push('vectorizedSummary');
            if (!savedConfig.vectorAPIConfig) missingConfigs.push('vectorAPIConfig');
            if (!savedConfig.apiConfig) missingConfigs.push('apiConfig');

            if (missingConfigs.length > 0) {
                console.error('[InfoBarSettings] âŒ ä»¥ä¸‹é…ç½®æœªæˆåŠŸä¿å­˜:', missingConfigs);
                this.showMessage(`âš ï¸ éƒ¨åˆ†é…ç½®å¯èƒ½æœªä¿å­˜: ${missingConfigs.join(', ')}`, 'warning');
            } else {
                console.log('[InfoBarSettings] âœ… æ‰€æœ‰å…³é”®é…ç½®å·²éªŒè¯ä¿å­˜');
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…é™¤å­—æ®µæ˜ å°„ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æ—¶é‡æ–°ç”Ÿæˆæœ€æ–°æ˜ å°„
            this._cachedCompleteMapping = null;
            console.log('[InfoBarSettings] ğŸ”„ å·²æ¸…é™¤å­—æ®µæ˜ å°„ç¼“å­˜');

            // ğŸ”§ ä¿®å¤ï¼šæ‰€æœ‰é¢æ¿å·²é€šè¿‡ç»Ÿä¸€æ¸²æŸ“ï¼Œä¸éœ€è¦é¢å¤–åˆ·æ–°

            // è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°
            if (this.eventSystem) {
                this.eventSystem.emit('panel:config:changed', {
                    timestamp: Date.now(),
                    formData: formData
                });
                console.log('[InfoBarSettings] ğŸ“‹ å·²è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶');
            }

            // å¦‚æœAPIé…ç½®æœ‰å˜åŒ–ï¼Œæ›´æ–°APIé›†æˆ
            if (this.hasAPIConfigChanged(formData)) {
                await this.apiIntegration.updateConfig(formData.apiConfig || {});
            }

            // æ ‡è®°éœ€è¦åˆ·æ–°è®¾ç½®
            this.needsSettingsRefresh = true;

            // ç«‹å³éšè—ç•Œé¢
            this.hide();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            this.showMessage('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');

            // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å¯ç”¨æ—¶æ‰æ£€æŸ¥å¹¶é‡æ–°åŒ…è£…AIæ¶ˆæ¯
            setTimeout(() => {
                // æ£€æŸ¥å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½æ˜¯å¦å¯ç”¨
                const configManager = window.SillyTavernInfobar?.modules?.configManager;
                if (configManager) {
                    const frontendConfig = configManager.getFrontendDisplayConfig();
                    if (frontendConfig && frontendConfig.enabled) {
                        console.log('[InfoBarSettings] ğŸ”„ å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å·²å¯ç”¨ï¼Œæ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…çŠ¶æ€');
                        this.ensureAIMessagesWrapped();
                    } else {
                        console.log('[InfoBarSettings] â¹ï¸ å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡AIæ¶ˆæ¯åŒ…è£…æ£€æŸ¥');
                    }
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é…ç½®ç®¡ç†å™¨ï¼Œè·³è¿‡AIæ¶ˆæ¯åŒ…è£…æ£€æŸ¥');
                }
            }, 500);

            console.log('[InfoBarSettings] âœ… è®¾ç½®ä¿å­˜å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è®¾ç½®å¤±è´¥:', error);
            this.showMessage('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            this.handleError(error);
        } finally {
            // ğŸ”§ ä¿®å¤ï¼šæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½è¦é‡Šæ”¾ä¿å­˜é”
            this._isSaving = false;
            console.log('[InfoBarSettings] ğŸ”“ ä¿å­˜é”å·²é‡Šæ”¾');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šéªŒè¯é…ç½®å®Œæ•´æ€§
     * ç¡®ä¿æ‰€æœ‰é¢æ¿çš„é…ç½®éƒ½æ­£ç¡®ä¿å­˜åˆ°settings.jsonä¸­
     */
    async validateConfigIntegrity() {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹éªŒè¯é…ç½®å®Œæ•´æ€§...');

            const context = SillyTavern.getContext();
            const savedSettings = context.extensionSettings['Information bar integration tool'];

            const validationReport = {
                timestamp: Date.now(),
                checks: [],
                warnings: [],
                errors: [],
                totalChecks: 0,
                passedChecks: 0,
                failedChecks: 0
            };

            // 1. éªŒè¯åŸºç¡€è®¾ç½®
            validationReport.checks.push('åŸºç¡€è®¾ç½®');
            if (savedSettings.enabled !== undefined) {
                validationReport.passedChecks++;
            } else {
                validationReport.failedChecks++;
                validationReport.errors.push('åŸºç¡€è®¾ç½®: enabled æœªä¿å­˜');
            }

            // 2. éªŒè¯è®°å¿†å¢å¼ºé…ç½®
            validationReport.checks.push('è®°å¿†å¢å¼ºé…ç½®');
            if (savedSettings.memoryEnhancement) {
                const memoryKeys = ['ai', 'aiDatabase', 'vector', 'deep'];
                let memoryValid = true;
                for (const key of memoryKeys) {
                    if (!savedSettings.memoryEnhancement[key]) {
                        validationReport.warnings.push(`è®°å¿†å¢å¼ºé…ç½®: ${key} å¯èƒ½æœªä¿å­˜`);
                        memoryValid = false;
                    }
                }
                if (memoryValid) {
                    validationReport.passedChecks++;
                }
            } else {
                validationReport.failedChecks++;
                validationReport.warnings.push('è®°å¿†å¢å¼ºé…ç½®æ•´ä½“æœªä¿å­˜');
            }

            // 3. éªŒè¯å‘é‡åŠŸèƒ½é…ç½®
            validationReport.checks.push('å‘é‡åŠŸèƒ½é…ç½®');
            if (savedSettings.vectorFunction) {
                validationReport.passedChecks++;
            } else {
                validationReport.warnings.push('å‘é‡åŠŸèƒ½é…ç½®æœªä¿å­˜ï¼ˆå¯èƒ½æœªä½¿ç”¨ï¼‰');
            }

            // 4. éªŒè¯æ€»ç»“é…ç½®
            validationReport.checks.push('ä¼ ç»Ÿæ€»ç»“é…ç½®');
            if (savedSettings.summarySettings) {
                validationReport.passedChecks++;
            } else {
                validationReport.warnings.push('ä¼ ç»Ÿæ€»ç»“é…ç½®æœªä¿å­˜');
            }

            // 5. éªŒè¯å‘é‡åŒ–æ€»ç»“é…ç½®
            validationReport.checks.push('å‘é‡åŒ–æ€»ç»“é…ç½®');
            if (savedSettings.vectorizedSummary?.settings) {
                validationReport.passedChecks++;
            } else {
                validationReport.warnings.push('å‘é‡åŒ–æ€»ç»“é…ç½®æœªä¿å­˜');
            }

            // 6. éªŒè¯è‡ªå®šä¹‰é¢æ¿é…ç½®
            validationReport.checks.push('è‡ªå®šä¹‰é¢æ¿é…ç½®');
            if (savedSettings.customPanels && Object.keys(savedSettings.customPanels).length > 0) {
                validationReport.passedChecks++;
                console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿é…ç½®å·²ä¿å­˜:', Object.keys(savedSettings.customPanels).length, 'ä¸ªé¢æ¿');
            } else {
                validationReport.warnings.push('è‡ªå®šä¹‰é¢æ¿é…ç½®ä¸ºç©º');
            }

            validationReport.totalChecks = validationReport.checks.length;

            // è¾“å‡ºéªŒè¯æŠ¥å‘Š
            console.log('[InfoBarSettings] ğŸ“Š é…ç½®å®Œæ•´æ€§éªŒè¯æŠ¥å‘Š:', {
                æ€»æ£€æŸ¥é¡¹: validationReport.totalChecks,
                é€šè¿‡: validationReport.passedChecks,
                è­¦å‘Šæ•°: validationReport.warnings.length,
                é”™è¯¯æ•°: validationReport.errors.length
            });

            if (validationReport.warnings.length > 0) {
                console.warn('[InfoBarSettings] âš ï¸ é…ç½®éªŒè¯è­¦å‘Š:', validationReport.warnings);
            }

            if (validationReport.warnings.length === 0) {
                console.log('[InfoBarSettings] âœ… é…ç½®å®Œæ•´æ€§éªŒè¯é€šè¿‡ï¼æ‰€æœ‰é…ç½®å·²æ­£ç¡®ä¿å­˜');
            }

            return validationReport;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é…ç½®å®Œæ•´æ€§éªŒè¯å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * æ”¶é›†è¡¨å•æ•°æ®
     */
    collectFormData() {
        const formData = {};

        // è·å–æ‰€æœ‰è¡¨å•å…ƒç´ 
        const elements = this.modal.querySelectorAll('input, select, textarea');

        elements.forEach(element => {
            const name = element.name;
            if (!name) return;

            let value;
            if (element.type === 'checkbox') {
                value = element.checked;
            } else if (element.type === 'radio') {
                // ä»…é‡‡é›†è¢«é€‰ä¸­çš„å•é€‰é¡¹ï¼Œé¿å…æœªé€‰é¡¹è¦†ç›–
                if (!element.checked) return;
                value = element.value;
            } else if (element.type === 'number' || element.type === 'range') {
                value = parseFloat(element.value) || 0;
            } else {
                value = element.value;
            }

            // å¤„ç†åµŒå¥—å±æ€§
            if (name.includes('.')) {
                this.setNestedProperty(formData, name, value);
            } else {
                formData[name] = value;
            }
        });

        // æ”¶é›†å½“å‰é€‰ä¸­çš„ä¸»é¢˜
        const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
        if (activeThemeCard) {
            const themeId = activeThemeCard.getAttribute('data-theme');
            if (themeId) {
                formData.theme = {
                    current: themeId,
                    lastUpdated: new Date().toISOString()
                };
                console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°ä¸»é¢˜æ•°æ®:', themeId);
            }
        }

        // æ”¶é›†å½“å‰é€‰ä¸­çš„é£æ ¼
        const activeStyleCard = this.modal.querySelector('.style-preview-card.active');
        if (activeStyleCard) {
            const styleId = activeStyleCard.getAttribute('data-style');
            if (styleId) {
                formData.style = {
                    current: styleId,
                    lastUpdated: new Date().toISOString()
                };
                console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°é£æ ¼æ•°æ®:', styleId);
            }
        }

        // å¤„ç†åŸºç¡€é¢æ¿é…ç½®ï¼Œè½¬æ¢ä¸ºDataTableæœŸæœ›çš„æ ¼å¼
        this.processBasicPanelsConfig(formData);

        console.log('[InfoBarSettings] ğŸ“Š è¡¨å•æ•°æ®æ”¶é›†å®Œæˆï¼ŒåŒ…å«', Object.keys(formData).length, 'ä¸ªé…ç½®é¡¹');
        return formData;
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåŒæ­¥è®°å¿†å¢å¼ºè®¾ç½®åˆ°å„ä¸ªæ¨¡å—
     */
    async syncMemoryEnhancementSettingsToModules(memoryEnhancementData) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åŒæ­¥è®°å¿†å¢å¼ºè®¾ç½®åˆ°å„æ¨¡å—...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool || !infoBarTool.modules) {
                console.warn('[InfoBarSettings] âš ï¸ InfoBarå·¥å…·æœªæ‰¾åˆ°ï¼Œæ— æ³•åŒæ­¥è®¾ç½®');
                return;
            }

            const modules = infoBarTool.modules;

            // 1. åŒæ­¥DeepMemoryManagerè®¾ç½®
            if (modules.deepMemoryManager && memoryEnhancementData.deep) {
                await modules.deepMemoryManager.updateSettings({
                    enabled: memoryEnhancementData.deep.enabled,
                    autoMemoryMigration: memoryEnhancementData.deep.autoMemoryMigration,
                    memoryConflictResolution: memoryEnhancementData.deep.conflictResolution,
                    sensoryMemoryCapacity: memoryEnhancementData.deep.capacities?.sensory,
                    shortTermMemoryCapacity: memoryEnhancementData.deep.capacities?.shortTerm,
                    longTermMemoryCapacity: memoryEnhancementData.deep.capacities?.longTerm,
                    deepArchiveCapacity: memoryEnhancementData.deep.capacities?.deepArchive
                });
                console.log('[InfoBarSettings] âœ… DeepMemoryManagerè®¾ç½®å·²åŒæ­¥');
            }

            // 1.5. åŒæ­¥AIMemoryDatabaseè®¾ç½®
            if (memoryEnhancementData.aiDatabase) {
                if (modules.aiMemoryDatabase) {
                    modules.aiMemoryDatabase.config.enabled = memoryEnhancementData.aiDatabase.enabled;
                    modules.aiMemoryDatabase.config.autoIndexing = memoryEnhancementData.aiDatabase.autoIndexing;
                    modules.aiMemoryDatabase.config.enableThinkingInterface = memoryEnhancementData.aiDatabase.enableThinkingInterface;
                    modules.aiMemoryDatabase.config.maxSearchResults = memoryEnhancementData.aiDatabase.maxSearchResults || 20;
                    await modules.aiMemoryDatabase.saveConfig();
                    console.log('[InfoBarSettings] âœ… AIMemoryDatabaseè®¾ç½®å·²åŒæ­¥');
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ AIMemoryDatabaseæ¨¡å—æœªæ‰¾åˆ°ï¼Œé…ç½®æ— æ³•åŒæ­¥');
                    console.warn('[InfoBarSettings] å¯ç”¨æ¨¡å—:', Object.keys(modules));
                }
            }

            // ğŸ”§ VectorizedMemoryRetrievalåŒæ­¥å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨å‘é‡åŠŸèƒ½é¢æ¿çš„AIè‡ªåŠ¨æ£€ç´¢

            // 3. åŒæ­¥IntelligentMemoryClassifierè®¾ç½®
            if (modules.intelligentMemoryClassifier && memoryEnhancementData.classifier) {
                await modules.intelligentMemoryClassifier.updateSettings({
                    enabled: memoryEnhancementData.classifier.enabled,
                    semanticClustering: memoryEnhancementData.classifier.semanticClustering,
                    temporalPatternRecognition: memoryEnhancementData.classifier.temporalPatternRecognition,
                    importancePrediction: memoryEnhancementData.classifier.importancePrediction,
                    classificationConfidenceThreshold: memoryEnhancementData.classifier.classificationConfidenceThreshold,
                    adaptiveLearning: memoryEnhancementData.classifier.adaptiveLearning
                });
                console.log('[InfoBarSettings] âœ… IntelligentMemoryClassifierè®¾ç½®å·²åŒæ­¥');
            }

            // 4. åŒæ­¥å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾ç½®
            if (memoryEnhancementData.enhancement) {
                const enhancement = memoryEnhancementData.enhancement;

                // MemoryMaintenanceSystem
                if (modules.memoryMaintenanceSystem) {
                    await modules.memoryMaintenanceSystem.updateSettings({
                        enabled: enhancement.memoryMaintenance
                    });
                    console.log('[InfoBarSettings] âœ… MemoryMaintenanceSystemè®¾ç½®å·²åŒæ­¥');
                }

                // ContextualRetrieval
                if (modules.contextualRetrieval) {
                    await modules.contextualRetrieval.updateSettings({
                        enabled: enhancement.contextualRetrieval
                    });
                    console.log('[InfoBarSettings] âœ… ContextualRetrievalè®¾ç½®å·²åŒæ­¥');
                }

                // UserProfileManager
                if (modules.userProfileManager) {
                    await modules.userProfileManager.updateSettings({
                        enabled: enhancement.userProfile
                    });
                    console.log('[InfoBarSettings] âœ… UserProfileManagerè®¾ç½®å·²åŒæ­¥');
                }

                // KnowledgeGraphManager
                if (modules.knowledgeGraphManager) {
                    await modules.knowledgeGraphManager.updateSettings({
                        enabled: enhancement.knowledgeGraph
                    });
                    console.log('[InfoBarSettings] âœ… KnowledgeGraphManagerè®¾ç½®å·²åŒæ­¥');
                }

                // TimeAwareMemoryManager
                if (modules.timeAwareMemoryManager) {
                    await modules.timeAwareMemoryManager.updateSettings({
                        enabled: enhancement.timeAware
                    });
                    console.log('[InfoBarSettings] âœ… TimeAwareMemoryManagerè®¾ç½®å·²åŒæ­¥');
                }
            }

            // 5. åŒæ­¥å‰§æƒ…è§„åˆ’åŠ©æ‰‹è®¾ç½®
            if (memoryEnhancementData.storyPlanning && modules.storyPlanningAssistant) {
                const spSettings = memoryEnhancementData.storyPlanning;
                
                // æ›´æ–°é…ç½®
                modules.storyPlanningAssistant.config.enabled = spSettings.enabled;
                modules.storyPlanningAssistant.config.autoActivate = spSettings.autoActivate;
                modules.storyPlanningAssistant.config.enableSemanticAnalysis = spSettings.enableSemanticAnalysis;
                modules.storyPlanningAssistant.config.enableTimelineAware = spSettings.enableTimelineAware;
                modules.storyPlanningAssistant.config.enablePlotContinuity = spSettings.enablePlotContinuity;
                modules.storyPlanningAssistant.config.suggestionDetailLevel = spSettings.suggestionDetailLevel;
                modules.storyPlanningAssistant.config.maxKeywords = spSettings.maxKeywords;
                modules.storyPlanningAssistant.config.maxMemoryResults = spSettings.maxMemoryResults;
                modules.storyPlanningAssistant.config.minMemoryImportance = spSettings.minMemoryImportance;
                
                // ä¿å­˜é…ç½®
                await modules.storyPlanningAssistant.saveConfig();
                console.log('[InfoBarSettings] âœ… StoryPlanningAssistantè®¾ç½®å·²åŒæ­¥');
            }

            console.log('[InfoBarSettings] âœ… æ‰€æœ‰è®°å¿†å¢å¼ºæ¨¡å—è®¾ç½®åŒæ­¥å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŒæ­¥è®°å¿†å¢å¼ºè®¾ç½®åˆ°æ¨¡å—å¤±è´¥:', error);
        }
    }

    /**
     * æ”¶é›†è®°å¿†å¢å¼ºé¢æ¿çš„è®¾ç½®ï¼ˆä½¿ç”¨å…ƒç´ IDï¼‰
     */
    collectMemoryEnhancementFormData() {
        try {
            const getBool = (id) => !!this.modal.querySelector(`#${id}`)?.checked;
            const getNum = (id) => {
                const el = this.modal.querySelector(`#${id}`);
                if (!el) return undefined;
                const v = el.type === 'number' ? parseInt(el.value, 10) : parseFloat(el.value);
                return isNaN(v) ? undefined : v;
            };
            const getVal = (id) => this.modal.querySelector(`#${id}`)?.value;

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿AIè®°å¿†æ€»ç»“è®¾ç½®ä¸åç«¯æ¨¡å—åŒæ­¥
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            const aiMemorySummarizer = summaryManager?.aiMemorySummarizer;

            // ä¼˜å…ˆä½¿ç”¨åç«¯æ¨¡å—çš„å½“å‰è®¾ç½®ï¼Œç¡®ä¿ä¸å®é™…çŠ¶æ€åŒæ­¥
            const aiSettings = aiMemorySummarizer?.settings || {};

            // ğŸ†• è·å–AIè®°å¿†æ€»ç»“APIæ¨¡å¼
            const getAPIMode = () => {
                // ğŸ”§ ä¿®å¤ï¼šä»UIæŒ‰é’®çŠ¶æ€è¯»å–APIæ¨¡å¼ï¼Œè€Œä¸æ˜¯ä»æ‰©å±•è®¾ç½®è¯»å–
                const activeBtn = this.modal?.querySelector('.ai-memory-api-mode-btn[style*="linear-gradient"]');
                if (activeBtn) {
                    return activeBtn.dataset.mode || 'auto';
                }

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¿€æ´»çš„æŒ‰é’®ï¼Œä»æ‰©å±•è®¾ç½®è¯»å–
                const context = SillyTavern.getContext();
                const savedMode = context.extensionSettings['Information bar integration tool']?.memoryEnhancement?.ai?.apiMode;
                return savedMode || 'auto';
            };

            const data = {
                ai: {
                    enabled: aiSettings.enabled !== undefined ? aiSettings.enabled : getBool('memory-ai-memory-enabled'),
                    messageLevelSummary: aiSettings.messageLevelSummary !== undefined ? aiSettings.messageLevelSummary : getBool('memory-ai-message-level-summary'),
                    importanceThreshold: aiSettings.importanceThreshold !== undefined ? aiSettings.importanceThreshold : getNum('memory-ai-importance-threshold'),
                    apiMode: getAPIMode()  // ğŸ†• æ·»åŠ APIæ¨¡å¼é…ç½®
                },
                aiDatabase: {
                    enabled: getBool('memory-ai-memory-database-enabled'),
                    autoIndexing: getBool('memory-ai-db-auto-indexing'),
                    enableThinkingInterface: getBool('memory-ai-db-thinking-interface'),
                    maxSearchResults: getNum('memory-ai-db-max-results') || 20,
                    minImportance: getNum('memory-ai-db-min-importance') || 0.5
                },
                // ğŸ”§ vectoré…ç½®å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨å‘é‡åŠŸèƒ½é¢æ¿çš„AIè‡ªåŠ¨æ£€ç´¢
                deep: {
                    enabled: getBool('memory-deep-memory-enabled'),
                    autoMemoryMigration: getBool('memory-auto-memory-migration'),
                    memoryImportanceThreshold: getNum('memory-memory-importance-threshold'),
                    conflictResolution: getBool('memory-memory-conflict-resolution'),
                    capacities: {
                        sensory: getNum('memory-sensory-capacity'),
                        shortTerm: getNum('memory-short-term-capacity'),
                        longTerm: getNum('memory-long-term-capacity'),
                        deepArchive: getNum('memory-deep-archive-capacity')
                    }
                },
                classifier: {
                    enabled: getBool('memory-intelligent-classifier-enabled'),
                    semanticClustering: getBool('memory-semantic-clustering'),
                    temporalPatternRecognition: getBool('memory-temporal-pattern-recognition'),
                    importancePrediction: getBool('memory-importance-prediction'),
                    classificationConfidenceThreshold: getNum('memory-classification-confidence-threshold'),
                    adaptiveLearning: getBool('memory-adaptive-learning')
                },
                enhancement: {
                    memoryMaintenance: getBool('memory-maintenance-enabled'),
                    contextualRetrieval: getBool('contextual-retrieval-enabled'),
                    userProfile: getBool('user-profile-enabled'),
                    knowledgeGraph: getBool('knowledge-graph-enabled'),
                    timeAware: getBool('time-aware-enabled'),
                    stIntegration: getBool('st-integration-enabled')
                },
                storyPlanning: {
                    enabled: getBool('memory-story-planning-enabled'),
                    autoActivate: getBool('memory-sp-auto-activate'),
                    enableSemanticAnalysis: getBool('memory-sp-semantic-analysis'),
                    enableTimelineAware: getBool('memory-sp-timeline-aware'),
                    enablePlotContinuity: getBool('memory-sp-plot-continuity'),
                    suggestionDetailLevel: getVal('memory-sp-detail-level') || 'detailed',
                    maxKeywords: getNum('memory-sp-max-keywords') || 10,
                    maxMemoryResults: getNum('memory-sp-max-memories') || 15,
                    minMemoryImportance: getNum('memory-sp-min-importance') || 0.5
                }
            };

            return data;
        } catch (err) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†è®°å¿†å¢å¼ºè¡¨å•å¤±è´¥:', err);
            return undefined;
        }
    }


    /**
     * åŠ è½½è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€åˆ°è¡¨å•
     */
    loadCustomPanelSubItemStates(customPanels) {
        try {
            // éå†æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿
            for (const [panelId, panel] of Object.entries(customPanels)) {
                if (panel.subItems && Array.isArray(panel.subItems)) {
                    // è®¾ç½®æ¯ä¸ªå­é¡¹çš„å‹¾é€‰çŠ¶æ€
                    panel.subItems.forEach(subItem => {
                        const fieldName = subItem.name || subItem.key || subItem.id;
                        const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);
                        if (checkbox && checkbox.type === 'checkbox') {
                            checkbox.checked = subItem.enabled !== false;
                            console.log(`[InfoBarSettings] ğŸ“Š è®¾ç½®å­é¡¹å‹¾é€‰çŠ¶æ€: ${fieldName} = ${checkbox.checked}`);
                        }
                    });
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ é‡æ„ï¼šåŠ è½½é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€ï¼ˆç»Ÿä¸€ä»customPanelsè·å–ï¼‰
     */
    loadBasicPanelSubItemStates(configs) {
        try {
            const customPanels = configs.customPanels || {};

            // éå†æ‰€æœ‰é¢æ¿
            Object.entries(customPanels).forEach(([panelKey, panelConfig]) => {
                if (panelConfig && typeof panelConfig === 'object') {
                    console.log(`[InfoBarSettings] ğŸ“Š åŠ è½½é¢æ¿ ${panelKey} çš„å­é¡¹çŠ¶æ€`);

                    // éå†é¢æ¿çš„æ‰€æœ‰å­é¡¹
                    Object.keys(panelConfig).forEach(subItemKey => {
                        if (subItemKey !== 'enabled' && typeof panelConfig[subItemKey] === 'object' &&
                            panelConfig[subItemKey] && typeof panelConfig[subItemKey].enabled === 'boolean') {

                            const fieldName = `${panelKey}.${subItemKey}.enabled`;  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨panelKeyè€Œä¸æ˜¯panelId
                            const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);

                            if (checkbox && checkbox.type === 'checkbox') {
                                checkbox.checked = panelConfig[subItemKey].enabled;
                                console.log(`[InfoBarSettings] ğŸ“Š è®¾ç½®é¢æ¿å­é¡¹å‹¾é€‰çŠ¶æ€: ${fieldName} = ${checkbox.checked}`);
                            }
                        }
                    });
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
     * ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä»DOMè¯»å–å¤é€‰æ¡†çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¾èµ–formData
     */
    updateCustomPanelSubItemStates(customPanels, formData) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€...');

            // éå†æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿
            for (const [panelId, panel] of Object.entries(customPanels)) {
                if (!panel.subItems || !Array.isArray(panel.subItems)) {
                    continue;
                }

                console.log(`[InfoBarSettings] ğŸ“Š å¤„ç†é¢æ¿: ${panelId}, ${panel.subItems.length} ä¸ªå­—æ®µ`);

                // æ›´æ–°æ¯ä¸ªå­é¡¹çš„enabledçŠ¶æ€
                panel.subItems.forEach((subItem, index) => {
                    // ğŸ”§ é‡è¦ä¿®å¤ï¼šä¼˜å…ˆä»DOMè¯»å–å¤é€‰æ¡†çš„å®é™…checkedçŠ¶æ€
                    // è¿™æ ·å¯ä»¥ç¡®ä¿ç”¨æˆ·åœ¨UIä¸­çš„å‹¾é€‰æ“ä½œè¢«æ­£ç¡®ä¿å­˜
                    const fieldName = subItem.name || subItem.key || subItem.id;
                    const checkbox = this.modal.querySelector(`input[type="checkbox"][name="${fieldName}"]`);

                    let newState = subItem.enabled; // é»˜è®¤ä¿æŒåŸçŠ¶æ€
                    let source = 'default';

                    if (checkbox) {
                        // ä»DOMè¯»å–å®é™…çš„checkedçŠ¶æ€
                        newState = checkbox.checked;
                        source = 'DOM';
                    } else {
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä»formDataè¯»å–
                        const possibleFieldNames = [
                            subItem.name,
                            subItem.key,
                            subItem.id,
                            `${panelId}.${subItem.key}.enabled`,
                            `${panelId}.${subItem.name}.enabled`
                        ].filter(Boolean);

                        for (const fname of possibleFieldNames) {
                            if (formData.hasOwnProperty(fname)) {
                                newState = formData[fname];
                                source = 'formData';
                                break;
                            }
                        }
                    }

                    // æ›´æ–°çŠ¶æ€
                    if (subItem.enabled !== newState) {
                        console.log(`[InfoBarSettings] ğŸ“Š æ›´æ–°å­—æ®µ [${index}] "${subItem.name}": ${subItem.enabled} -> ${newState} (æ¥æº: ${source})`);
                        subItem.enabled = newState;
                    }
                });
            }

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€æ›´æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†åŸºç¡€é¢æ¿é…ç½®ï¼Œè½¬æ¢ä¸ºDataTableæœŸæœ›çš„æ ¼å¼
     */
    processBasicPanelsConfig(formData) {
        try {
            // åˆå§‹åŒ–basicPanelså¯¹è±¡
            if (!formData.basicPanels) {
                formData.basicPanels = {};
            }

            // ğŸ”§ é‡æ„ï¼šå¤„ç†customPanelsï¼ˆç°åœ¨æ‰€æœ‰é¢æ¿éƒ½åœ¨è¿™é‡Œï¼‰
            const customPanels = formData.customPanels || {};
            
            console.log(`[InfoBarSettings] ğŸ“Š å¤„ç† ${Object.keys(customPanels).length} ä¸ªé¢æ¿çš„æ•°æ®`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†åŸºç¡€é¢æ¿é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºè‹±æ–‡åç§°
     */
    isEnglishName(name) {
        if (!name || typeof name !== 'string') return false;
        // å¦‚æœåŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œåˆ™ä¸æ˜¯è‹±æ–‡
        return !/[\u4e00-\u9fa5]/.test(name);
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ ¹æ®é¢æ¿IDå’Œå­—æ®µkeyè·å–ä¸­æ–‡åç§°
     */
    getChineseNameForField(panelId, fieldKey) {
        if (!panelId || !fieldKey) return null;
        
        try {
            // ğŸ”§ é‡è¦ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æ˜ å°„è¡¨ï¼ˆæœ€å¯é ï¼‰
            // å› ä¸ºäº‘ç«¯æ•°æ®ä¸­çš„keyæ˜¯è‹±æ–‡ï¼Œä½†PresetPanelsManagerä¸­çš„keyæ˜¯ä¸­æ–‡ï¼Œæ— æ³•åŒ¹é…
            const chineseName = this.getSubItemDisplayName(panelId, fieldKey);
            
            // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†æ˜ å°„ï¼ˆè¿”å›å€¼ä¸åŸkeyä¸åŒï¼Œä¸”ä¸æ˜¯è‹±æ–‡ï¼‰
            if (chineseName) {
                // å¦‚æœè¿”å›çš„æ˜¯ä¸­æ–‡ï¼Œè¯´æ˜æ‰¾åˆ°äº†æ˜ å°„
                if (!this.isEnglishName(chineseName)) {
                    return chineseName;
                }
                // å¦‚æœè¿”å›çš„è¿˜æ˜¯è‹±æ–‡ï¼Œä½†ä¸åŸkeyä¸åŒï¼Œä¹Ÿå¯èƒ½æ˜¯æ˜ å°„ï¼ˆå¦‚ "name" -> "å§“å" çš„æƒ…å†µï¼‰
                if (chineseName !== fieldKey && !this.isEnglishName(chineseName)) {
                    return chineseName;
                }
            }
            
            // å¤‡ç”¨ï¼šå°è¯•ä»PresetPanelsManagerè·å–ï¼ˆç”¨äºæ–°å¢çš„è‡ªå®šä¹‰å­—æ®µï¼‰
            const presets = window.SillyTavernInfobar?.PresetPanelsManager?.getPresets?.() || {};
            const preset = presets[panelId];
            
            if (preset && preset.subItems) {
                const field = preset.subItems.find(item => item.key === fieldKey || item.name === fieldKey);
                if (field && field.name && !this.isEnglishName(field.name)) {
                    return field.name;
                }
            }
            
            // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å›nullï¼ˆè®©è°ƒç”¨è€…çŸ¥é“æ²¡æ‰¾åˆ°ï¼‰
            return null;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å­—æ®µä¸­æ–‡åå¤±è´¥:', error);
            return null;
        }
    }

    /**
     * è·å–å­é¡¹æ˜¾ç¤ºåç§°ï¼ˆæ”¯æŒæ—§ç‰ˆcol_Xæ ¼å¼keyçš„å…¼å®¹æ˜ å°„ï¼‰
     */
    getSubItemDisplayName(panelType, key) {
        const displayNames = {
            personal: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å§“å', 'age': 'å¹´é¾„', 'gender': 'æ€§åˆ«', 'occupation': 'èŒä¸š',
                'height': 'èº«é«˜', 'weight': 'ä½“é‡', 'bloodType': 'è¡€å‹', 'zodiac': 'æ˜Ÿåº§',
                'birthday': 'ç”Ÿæ—¥', 'birthplace': 'å‡ºç”Ÿåœ°', 'nationality': 'å›½ç±', 'ethnicity': 'æ°‘æ—',
                'hairColor': 'å‘è‰²', 'hairStyle': 'å‘å‹', 'eyeColor': 'çœ¼è‰²', 'skinColor': 'è‚¤è‰²',
                'bodyType': 'ä½“å‹', 'facialFeatures': 'é¢éƒ¨ç‰¹å¾', 'scars': 'ç–¤ç—•', 'tattoos': 'çº¹èº«',
                'accessories': 'é…é¥°', 'clothingStyle': 'ç©¿ç€é£æ ¼', 'appearance': 'å¤–è²Œ', 'voice': 'å£°éŸ³',
                'personality': 'æ€§æ ¼', 'temperament': 'æ€§æƒ…', 'attitude': 'æ€åº¦', 'values': 'ä»·å€¼è§‚',
                'beliefs': 'ä¿¡å¿µ', 'fears': 'ææƒ§', 'dreams': 'æ¢¦æƒ³', 'goals': 'äººç”Ÿç›®æ ‡',
                'intelligence': 'æ™ºåŠ›', 'strength': 'åŠ›é‡', 'charisma': 'é­…åŠ›', 'luck': 'è¿æ°”',
                'perception': 'æ„ŸçŸ¥', 'willpower': 'æ„å¿—åŠ›', 'reactionSpeed': 'ååº”é€Ÿåº¦', 'learningAbility': 'å­¦ä¹ èƒ½åŠ›',
                'familyBackground': 'å®¶åº­èƒŒæ™¯', 'education': 'æ•™è‚²ç»å†', 'workExperience': 'å·¥ä½œç»å†', 'income': 'æ”¶å…¥',
                'socialStatus': 'ç¤¾ä¼šåœ°ä½', 'relationships': 'äººé™…å…³ç³»', 'loveStatus': 'æ‹çˆ±çŠ¶æ€', 'maritalStatus': 'å©šå§»çŠ¶æ€',
                'hobbies': 'çˆ±å¥½', 'sports': 'è¿åŠ¨', 'music': 'éŸ³ä¹', 'art': 'è‰ºæœ¯',
                'reading': 'é˜…è¯»', 'gaming': 'æ¸¸æˆ', 'travel': 'æ—…è¡Œ', 'cooking': 'çƒ¹é¥ª',
                'skills': 'æŠ€èƒ½ç‰¹é•¿', 'languages': 'è¯­è¨€èƒ½åŠ›', 'habits': 'ç”Ÿæ´»ä¹ æƒ¯', 'healthStatus': 'å¥åº·çŠ¶æ€',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å§“å': 'å§“å', 'å¹´é¾„': 'å¹´é¾„', 'æ€§åˆ«': 'æ€§åˆ«', 'èŒä¸š': 'èŒä¸š',
                'èº«é«˜': 'èº«é«˜', 'ä½“é‡': 'ä½“é‡', 'è¡€å‹': 'è¡€å‹', 'æ˜Ÿåº§': 'æ˜Ÿåº§',
                'ç”Ÿæ—¥': 'ç”Ÿæ—¥', 'å‡ºç”Ÿåœ°': 'å‡ºç”Ÿåœ°', 'å›½ç±': 'å›½ç±', 'æ°‘æ—': 'æ°‘æ—',
                'å‘è‰²': 'å‘è‰²', 'å‘å‹': 'å‘å‹', 'çœ¼è‰²': 'çœ¼è‰²', 'è‚¤è‰²': 'è‚¤è‰²',
                'ä½“å‹': 'ä½“å‹', 'é¢éƒ¨ç‰¹å¾': 'é¢éƒ¨ç‰¹å¾', 'ç–¤ç—•': 'ç–¤ç—•', 'çº¹èº«': 'çº¹èº«',
                'é…é¥°': 'é…é¥°', 'ç©¿ç€é£æ ¼': 'ç©¿ç€é£æ ¼', 'å¤–è²Œ': 'å¤–è²Œ', 'å£°éŸ³': 'å£°éŸ³',
                'æ€§æ ¼': 'æ€§æ ¼', 'æ€§æƒ…': 'æ€§æƒ…', 'æ€åº¦': 'æ€åº¦', 'ä»·å€¼è§‚': 'ä»·å€¼è§‚',
                'ä¿¡å¿µ': 'ä¿¡å¿µ', 'ææƒ§': 'ææƒ§', 'æ¢¦æƒ³': 'æ¢¦æƒ³', 'äººç”Ÿç›®æ ‡': 'äººç”Ÿç›®æ ‡',
                'æ™ºåŠ›': 'æ™ºåŠ›', 'åŠ›é‡': 'åŠ›é‡', 'é­…åŠ›': 'é­…åŠ›', 'è¿æ°”': 'è¿æ°”',
                'æ„ŸçŸ¥': 'æ„ŸçŸ¥', 'æ„å¿—åŠ›': 'æ„å¿—åŠ›', 'ååº”é€Ÿåº¦': 'ååº”é€Ÿåº¦', 'å­¦ä¹ èƒ½åŠ›': 'å­¦ä¹ èƒ½åŠ›',
                'å®¶åº­èƒŒæ™¯': 'å®¶åº­èƒŒæ™¯', 'æ•™è‚²ç»å†': 'æ•™è‚²ç»å†', 'å·¥ä½œç»å†': 'å·¥ä½œç»å†', 'æ”¶å…¥': 'æ”¶å…¥',
                'ç¤¾ä¼šåœ°ä½': 'ç¤¾ä¼šåœ°ä½', 'äººé™…å…³ç³»': 'äººé™…å…³ç³»', 'æ‹çˆ±çŠ¶æ€': 'æ‹çˆ±çŠ¶æ€', 'å©šå§»çŠ¶æ€': 'å©šå§»çŠ¶æ€',
                'çˆ±å¥½': 'çˆ±å¥½', 'è¿åŠ¨': 'è¿åŠ¨', 'éŸ³ä¹': 'éŸ³ä¹', 'è‰ºæœ¯': 'è‰ºæœ¯',
                'é˜…è¯»': 'é˜…è¯»', 'æ¸¸æˆ': 'æ¸¸æˆ', 'æ—…è¡Œ': 'æ—…è¡Œ', 'çƒ¹é¥ª': 'çƒ¹é¥ª',
                'æŠ€èƒ½ç‰¹é•¿': 'æŠ€èƒ½ç‰¹é•¿', 'è¯­è¨€èƒ½åŠ›': 'è¯­è¨€èƒ½åŠ›', 'ç”Ÿæ´»ä¹ æƒ¯': 'ç”Ÿæ´»ä¹ æƒ¯', 'å¥åº·çŠ¶æ€': 'å¥åº·çŠ¶æ€',
                'ç§æ—': 'ç§æ—', 'èŒä¸šç±»åˆ«': 'èŒä¸šç±»åˆ«'
            },
            world: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ä¸–ç•Œåç§°', 'type': 'ä¸–ç•Œç±»å‹', 'genre': 'ä¸–ç•Œé£æ ¼', 'theme': 'ä¸–ç•Œä¸»é¢˜',
                'history': 'ä¸–ç•Œå†å²', 'mythology': 'ç¥è¯ä¼ è¯´', 'lore': 'ä¸–ç•Œè®¾å®š',
                'geography': 'åœ°ç†ç¯å¢ƒ', 'climate': 'æ°”å€™æ¡ä»¶', 'terrain': 'åœ°å½¢åœ°è²Œ', 'biomes': 'ç”Ÿç‰©ç¾¤è½',
                'locations': 'é‡è¦åœ°ç‚¹', 'landmarks': 'åœ°æ ‡å»ºç­‘', 'cities': 'åŸå¸‚è®¾å®š', 'dungeons': 'åœ°ä¸‹åŸ',
                'time': 'æ—¶é—´è®¾å®š', 'calendar': 'å†æ³•ç³»ç»Ÿ', 'seasons': 'å­£èŠ‚å˜åŒ–', 'dayNight': 'æ˜¼å¤œå¾ªç¯',
                'weather': 'å¤©æ°”ç³»ç»Ÿ', 'events': 'ä¸–ç•Œäº‹ä»¶', 'festivals': 'èŠ‚æ—¥åº†å…¸', 'disasters': 'è‡ªç„¶ç¾å®³',
                'cultures': 'æ–‡åŒ–è®¾å®š', 'languages': 'è¯­è¨€ç³»ç»Ÿ', 'religions': 'å®—æ•™ä¿¡ä»°', 'customs': 'é£ä¿—ä¹ æƒ¯',
                'politics': 'æ”¿æ²»ä½“ç³»', 'economy': 'ç»æµç³»ç»Ÿ', 'technology': 'ç§‘æŠ€æ°´å¹³', 'magic': 'é­”æ³•ç³»ç»Ÿ',
                'races': 'ç§æ—è®¾å®š', 'creatures': 'ç”Ÿç‰©è®¾å®š', 'monsters': 'æ€ªç‰©è®¾å®š', 'npcs': 'NPCè®¾å®š',
                'factions': 'åŠ¿åŠ›ç»„ç»‡', 'conflicts': 'å†²çªçŸ›ç›¾', 'alliances': 'è”ç›Ÿå…³ç³»', 'wars': 'æˆ˜äº‰å†å²',
                'resources': 'èµ„æºåˆ†å¸ƒ', 'materials': 'ææ–™è®¾å®š', 'artifacts': 'ç¥å™¨æ–‡ç‰©', 'currency': 'è´§å¸ç³»ç»Ÿ',
                'trade': 'è´¸æ˜“ä½“ç³»', 'markets': 'å¸‚åœºè®¾å®š', 'guilds': 'å…¬ä¼šç»„ç»‡', 'transportation': 'äº¤é€šè¿è¾“',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸–ç•Œåç§°': 'ä¸–ç•Œåç§°', 'ä¸–ç•Œç±»å‹': 'ä¸–ç•Œç±»å‹', 'ä¸–ç•Œé£æ ¼': 'ä¸–ç•Œé£æ ¼', 'ä¸–ç•Œä¸»é¢˜': 'ä¸–ç•Œä¸»é¢˜',
                'ä¸–ç•Œæè¿°': 'ä¸–ç•Œæè¿°', 'ä¸–ç•Œå†å²': 'ä¸–ç•Œå†å²', 'ç¥è¯ä¼ è¯´': 'ç¥è¯ä¼ è¯´', 'ä¸–ç•Œè®¾å®š': 'ä¸–ç•Œè®¾å®š',
                'åœ°ç†ç¯å¢ƒ': 'åœ°ç†ç¯å¢ƒ', 'æ°”å€™æ¡ä»¶': 'æ°”å€™æ¡ä»¶', 'åœ°å½¢åœ°è²Œ': 'åœ°å½¢åœ°è²Œ', 'ç”Ÿç‰©ç¾¤è½': 'ç”Ÿç‰©ç¾¤è½',
                'é‡è¦åœ°ç‚¹': 'é‡è¦åœ°ç‚¹', 'åœ°æ ‡å»ºç­‘': 'åœ°æ ‡å»ºç­‘', 'åŸå¸‚è®¾å®š': 'åŸå¸‚è®¾å®š', 'åœ°ä¸‹åŸ': 'åœ°ä¸‹åŸ',
                'æ—¶é—´è®¾å®š': 'æ—¶é—´è®¾å®š', 'å†æ³•ç³»ç»Ÿ': 'å†æ³•ç³»ç»Ÿ', 'å­£èŠ‚å˜åŒ–': 'å­£èŠ‚å˜åŒ–', 'æ˜¼å¤œå¾ªç¯': 'æ˜¼å¤œå¾ªç¯',
                'å¤©æ°”ç³»ç»Ÿ': 'å¤©æ°”ç³»ç»Ÿ', 'ä¸–ç•Œäº‹ä»¶': 'ä¸–ç•Œäº‹ä»¶', 'èŠ‚æ—¥åº†å…¸': 'èŠ‚æ—¥åº†å…¸', 'è‡ªç„¶ç¾å®³': 'è‡ªç„¶ç¾å®³',
                'æ–‡åŒ–è®¾å®š': 'æ–‡åŒ–è®¾å®š', 'è¯­è¨€ç³»ç»Ÿ': 'è¯­è¨€ç³»ç»Ÿ', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'é£ä¿—ä¹ æƒ¯': 'é£ä¿—ä¹ æƒ¯',
                'æ”¿æ²»ä½“ç³»': 'æ”¿æ²»ä½“ç³»', 'ç»æµç³»ç»Ÿ': 'ç»æµç³»ç»Ÿ', 'ç§‘æŠ€æ°´å¹³': 'ç§‘æŠ€æ°´å¹³', 'é­”æ³•ç³»ç»Ÿ': 'é­”æ³•ç³»ç»Ÿ',
                'ç§æ—è®¾å®š': 'ç§æ—è®¾å®š', 'ç”Ÿç‰©è®¾å®š': 'ç”Ÿç‰©è®¾å®š', 'æ€ªç‰©è®¾å®š': 'æ€ªç‰©è®¾å®š', 'NPCè®¾å®š': 'NPCè®¾å®š',
                'åŠ¿åŠ›ç»„ç»‡': 'åŠ¿åŠ›ç»„ç»‡', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾', 'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'æˆ˜äº‰å†å²': 'æˆ˜äº‰å†å²',
                'èµ„æºåˆ†å¸ƒ': 'èµ„æºåˆ†å¸ƒ', 'ææ–™è®¾å®š': 'ææ–™è®¾å®š', 'ç¥å™¨æ–‡ç‰©': 'ç¥å™¨æ–‡ç‰©', 'è´§å¸ç³»ç»Ÿ': 'è´§å¸ç³»ç»Ÿ',
                'è´¸æ˜“ä½“ç³»': 'è´¸æ˜“ä½“ç³»', 'å¸‚åœºè®¾å®š': 'å¸‚åœºè®¾å®š', 'å…¬ä¼šç»„ç»‡': 'å…¬ä¼šç»„ç»‡', 'äº¤é€šè¿è¾“': 'äº¤é€šè¿è¾“',
                'ä½ç½®': 'ä½ç½®', 'ç¯å¢ƒ': 'ç¯å¢ƒ', 'æ°›å›´': 'æ°›å›´', 'å­£èŠ‚': 'å­£èŠ‚',
                'æ–‡åŒ–': 'æ–‡åŒ–'
            },
            interaction: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å¯¹è±¡åç§°', 'type': 'å¯¹è±¡ç±»å‹', 'status': 'å½“å‰çŠ¶æ€', 'location': 'æ‰€åœ¨ä½ç½®',
                'mood': 'æƒ…ç»ªçŠ¶æ€', 'activity': 'å½“å‰æ´»åŠ¨', 'availability': 'å¯ç”¨æ€§', 'priority': 'ä¼˜å…ˆçº§',
                'relationship': 'å…³ç³»ç±»å‹', 'intimacy': 'äº²å¯†åº¦', 'trust': 'ä¿¡ä»»åº¦', 'friendship': 'å‹è°Šåº¦',
                'romance': 'æµªæ¼«åº¦', 'respect': 'å°Šé‡åº¦', 'dependency': 'ä¾èµ–åº¦', 'conflict': 'å†²çªåº¦',
                'history': 'å†å²è®°å½•', 'frequency': 'äº’åŠ¨é¢‘ç‡', 'duration': 'äº’åŠ¨æ—¶é•¿', 'quality': 'äº’åŠ¨è´¨é‡',
                'topics': 'è¯é¢˜åå¥½', 'emotions': 'æƒ…æ„ŸçŠ¶æ€', 'milestones': 'é‡è¦èŠ‚ç‚¹', 'memories': 'å…±åŒå›å¿†',
                'autoRecord': 'è‡ªåŠ¨è®°å½•', 'notifications': 'é€šçŸ¥è®¾ç½®', 'analysis': 'å…³ç³»åˆ†æ', 'suggestions': 'å»ºè®®æç¤º',
                'network': 'ç¤¾äº¤ç½‘ç»œ', 'groups': 'ç¾¤ä½“å…³ç³»', 'influence': 'å½±å“åŠ›', 'reputation': 'å£°èª‰åº¦',
                'alliances': 'è”ç›Ÿå…³ç³»', 'rivalries': 'ç«äº‰å…³ç³»', 'mentorship': 'å¸ˆå¾’å…³ç³»', 'hierarchy': 'ç­‰çº§å…³ç³»',
                'communicationStyle': 'æ²Ÿé€šé£æ ¼', 'preferredTopics': 'åå¥½è¯é¢˜', 'avoidedTopics': 'å›é¿è¯é¢˜', 'boundaries': 'è¾¹ç•Œè®¾å®š',
                'comfortLevel': 'èˆ’é€‚åº¦', 'energyLevel': 'æ´»è·ƒåº¦', 'responseTime': 'å“åº”æ—¶é—´', 'engagement': 'å‚ä¸åº¦',
                'specialEvents': 'ç‰¹æ®Šäº‹ä»¶', 'achievements': 'æˆå°±è®°å½•', 'challenges': 'æŒ‘æˆ˜ä»»åŠ¡', 'growth': 'æˆé•¿è½¨è¿¹',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¯¹è±¡åç§°': 'å¯¹è±¡åç§°', 'å¯¹è±¡ç±»å‹': 'å¯¹è±¡ç±»å‹', 'å½“å‰çŠ¶æ€': 'å½“å‰çŠ¶æ€', 'æ‰€åœ¨ä½ç½®': 'æ‰€åœ¨ä½ç½®',
                'æƒ…ç»ªçŠ¶æ€': 'æƒ…ç»ªçŠ¶æ€', 'å½“å‰æ´»åŠ¨': 'å½“å‰æ´»åŠ¨', 'å¯ç”¨æ€§': 'å¯ç”¨æ€§', 'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§',
                'å…³ç³»ç±»å‹': 'å…³ç³»ç±»å‹', 'äº²å¯†åº¦': 'äº²å¯†åº¦', 'ä¿¡ä»»åº¦': 'ä¿¡ä»»åº¦', 'å‹è°Šåº¦': 'å‹è°Šåº¦',
                'æµªæ¼«åº¦': 'æµªæ¼«åº¦', 'å°Šé‡åº¦': 'å°Šé‡åº¦', 'ä¾èµ–åº¦': 'ä¾èµ–åº¦', 'å†²çªåº¦': 'å†²çªåº¦',
                'å†å²è®°å½•': 'å†å²è®°å½•', 'äº’åŠ¨é¢‘ç‡': 'äº’åŠ¨é¢‘ç‡', 'äº’åŠ¨æ—¶é•¿': 'äº’åŠ¨æ—¶é•¿', 'äº’åŠ¨è´¨é‡': 'äº’åŠ¨è´¨é‡',
                'è¯é¢˜åå¥½': 'è¯é¢˜åå¥½', 'æƒ…æ„ŸçŠ¶æ€': 'æƒ…æ„ŸçŠ¶æ€', 'é‡è¦èŠ‚ç‚¹': 'é‡è¦èŠ‚ç‚¹', 'å…±åŒå›å¿†': 'å…±åŒå›å¿†',
                'è‡ªåŠ¨è®°å½•': 'è‡ªåŠ¨è®°å½•', 'é€šçŸ¥è®¾ç½®': 'é€šçŸ¥è®¾ç½®', 'å…³ç³»åˆ†æ': 'å…³ç³»åˆ†æ', 'å»ºè®®æç¤º': 'å»ºè®®æç¤º',
                'ç¤¾äº¤ç½‘ç»œ': 'ç¤¾äº¤ç½‘ç»œ', 'ç¾¤ä½“å…³ç³»': 'ç¾¤ä½“å…³ç³»', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å£°èª‰åº¦': 'å£°èª‰åº¦',
                'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'ç«äº‰å…³ç³»': 'ç«äº‰å…³ç³»', 'å¸ˆå¾’å…³ç³»': 'å¸ˆå¾’å…³ç³»', 'ç­‰çº§å…³ç³»': 'ç­‰çº§å…³ç³»',
                'æ²Ÿé€šé£æ ¼': 'æ²Ÿé€šé£æ ¼', 'åå¥½è¯é¢˜': 'åå¥½è¯é¢˜', 'å›é¿è¯é¢˜': 'å›é¿è¯é¢˜', 'è¾¹ç•Œè®¾å®š': 'è¾¹ç•Œè®¾å®š',
                'èˆ’é€‚åº¦': 'èˆ’é€‚åº¦', 'æ´»è·ƒåº¦': 'æ´»è·ƒåº¦', 'å“åº”æ—¶é—´': 'å“åº”æ—¶é—´', 'å‚ä¸åº¦': 'å‚ä¸åº¦',
                'ç‰¹æ®Šäº‹ä»¶': 'ç‰¹æ®Šäº‹ä»¶', 'æˆå°±è®°å½•': 'æˆå°±è®°å½•', 'æŒ‘æˆ˜ä»»åŠ¡': 'æŒ‘æˆ˜ä»»åŠ¡', 'æˆé•¿è½¨è¿¹': 'æˆé•¿è½¨è¿¹',
                'NPCå§“å': 'NPCå§“å', 'NPCæ€§æ ¼': 'NPCæ€§æ ¼', 'NPCçŠ¶æ€': 'NPCçŠ¶æ€',
                'æ€åº¦': 'æ€åº¦', 'å¯¹è¯ä¸»é¢˜': 'å¯¹è¯ä¸»é¢˜', 'äº¤äº’å†å²': 'äº¤äº’å†å²',
                'å¥½æ„Ÿåº¦': 'å¥½æ„Ÿåº¦', 'ç¤¾äº¤èƒŒæ™¯': 'ç¤¾äº¤èƒŒæ™¯'
            },
            tasks: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'creation': 'ä»»åŠ¡åˆ›å»º', 'editing': 'ä»»åŠ¡ç¼–è¾‘', 'deletion': 'ä»»åŠ¡åˆ é™¤', 'completion': 'ä»»åŠ¡å®Œæˆ',
                'priority': 'ä¼˜å…ˆçº§', 'deadline': 'æˆªæ­¢æ—¥æœŸ', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'status': 'çŠ¶æ€ç®¡ç†',
                'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ', 'projects': 'é¡¹ç›®ç®¡ç†', 'milestones': 'é‡Œç¨‹ç¢‘',
                'subtasks': 'å­ä»»åŠ¡', 'dependencies': 'ä¾èµ–å…³ç³»', 'templates': 'ä»»åŠ¡æ¨¡æ¿', 'recurring': 'é‡å¤ä»»åŠ¡',
                'notifications': 'é€šçŸ¥æé†’', 'reminders': 'æé†’è®¾ç½®', 'alerts': 'è­¦æŠ¥é€šçŸ¥', 'dailySummary': 'æ¯æ—¥æ€»ç»“',
                'weeklyReview': 'å‘¨æŠ¥å›é¡¾', 'achievementBadges': 'æˆå°±å¾½ç« ', 'productivityStats': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'timeTracking': 'æ—¶é—´è·Ÿè¸ª',
                'assignment': 'ä»»åŠ¡åˆ†é…', 'collaboration': 'åä½œåŠŸèƒ½', 'comments': 'è¯„è®ºç³»ç»Ÿ', 'attachments': 'é™„ä»¶ç®¡ç†',
                'sharing': 'å…±äº«åŠŸèƒ½', 'permissions': 'æƒé™ç®¡ç†', 'approval': 'å®¡æ‰¹æµç¨‹', 'delegation': 'ä»»åŠ¡å§”æ´¾',
                'listView': 'åˆ—è¡¨è§†å›¾', 'kanbanView': 'çœ‹æ¿è§†å›¾', 'calendarView': 'æ—¥å†è§†å›¾', 'ganttView': 'ç”˜ç‰¹å›¾',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'search': 'æœç´¢åŠŸèƒ½', 'grouping': 'åˆ†ç»„åŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',
                'archive': 'å½’æ¡£ç®¡ç†', 'history': 'å†å²è®°å½•', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶', 'recovery': 'æ¢å¤åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä»»åŠ¡åˆ›å»º': 'ä»»åŠ¡åˆ›å»º', 'ä»»åŠ¡ç¼–è¾‘': 'ä»»åŠ¡ç¼–è¾‘', 'ä»»åŠ¡åˆ é™¤': 'ä»»åŠ¡åˆ é™¤', 'ä»»åŠ¡å®Œæˆ': 'ä»»åŠ¡å®Œæˆ',
                'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§', 'æˆªæ­¢æ—¥æœŸ': 'æˆªæ­¢æ—¥æœŸ', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'çŠ¶æ€ç®¡ç†': 'çŠ¶æ€ç®¡ç†',
                'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ', 'é¡¹ç›®ç®¡ç†': 'é¡¹ç›®ç®¡ç†', 'é‡Œç¨‹ç¢‘': 'é‡Œç¨‹ç¢‘',
                'å­ä»»åŠ¡': 'å­ä»»åŠ¡', 'ä¾èµ–å…³ç³»': 'ä¾èµ–å…³ç³»', 'ä»»åŠ¡æ¨¡æ¿': 'ä»»åŠ¡æ¨¡æ¿', 'é‡å¤ä»»åŠ¡': 'é‡å¤ä»»åŠ¡',
                'é€šçŸ¥æé†’': 'é€šçŸ¥æé†’', 'æé†’è®¾ç½®': 'æé†’è®¾ç½®', 'è­¦æŠ¥é€šçŸ¥': 'è­¦æŠ¥é€šçŸ¥', 'æ¯æ—¥æ€»ç»“': 'æ¯æ—¥æ€»ç»“',
                'å‘¨æŠ¥å›é¡¾': 'å‘¨æŠ¥å›é¡¾', 'æˆå°±å¾½ç« ': 'æˆå°±å¾½ç« ', 'ç”Ÿäº§åŠ›ç»Ÿè®¡': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'æ—¶é—´è·Ÿè¸ª': 'æ—¶é—´è·Ÿè¸ª',
                'ä»»åŠ¡åˆ†é…': 'ä»»åŠ¡åˆ†é…', 'åä½œåŠŸèƒ½': 'åä½œåŠŸèƒ½', 'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'é™„ä»¶ç®¡ç†': 'é™„ä»¶ç®¡ç†',
                'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'æƒé™ç®¡ç†': 'æƒé™ç®¡ç†', 'å®¡æ‰¹æµç¨‹': 'å®¡æ‰¹æµç¨‹', 'ä»»åŠ¡å§”æ´¾': 'ä»»åŠ¡å§”æ´¾',
                'åˆ—è¡¨è§†å›¾': 'åˆ—è¡¨è§†å›¾', 'çœ‹æ¿è§†å›¾': 'çœ‹æ¿è§†å›¾', 'æ—¥å†è§†å›¾': 'æ—¥å†è§†å›¾', 'ç”˜ç‰¹å›¾': 'ç”˜ç‰¹å›¾',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'æœç´¢åŠŸèƒ½': 'æœç´¢åŠŸèƒ½', 'åˆ†ç»„åŠŸèƒ½': 'åˆ†ç»„åŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½',
                'å½’æ¡£ç®¡ç†': 'å½’æ¡£ç®¡ç†', 'å†å²è®°å½•': 'å†å²è®°å½•', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶', 'æ¢å¤åŠŸèƒ½': 'æ¢å¤åŠŸèƒ½'
            },
            organization: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ç»„ç»‡åç§°', 'type': 'ç»„ç»‡ç±»å‹', 'purpose': 'ç»„ç»‡æè¿°', 'history': 'ç»„ç»‡å†å²',
                'founding': 'æˆç«‹èƒŒæ™¯', 'motto': 'ç»„ç»‡æ ¼è¨€', 'values': 'æ ¸å¿ƒä»·å€¼',
                'hierarchy': 'å±‚çº§ç»“æ„', 'departments': 'éƒ¨é—¨è®¾ç½®', 'leadership': 'é¢†å¯¼å±‚', 'council': 'ç†äº‹ä¼š',
                'positions': 'èŒä½è®¾ç½®', 'ranks': 'ç­‰çº§åˆ¶åº¦', 'promotion': 'æ™‹å‡æœºåˆ¶', 'authority': 'æƒé™åˆ†é…',
                'members': 'æˆå‘˜ç®¡ç†', 'recruitment': 'æ‹›å‹Ÿåˆ¶åº¦', 'training': 'åŸ¹è®­ä½“ç³»', 'evaluation': 'è€ƒæ ¸è¯„ä¼°',
                'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šåˆ¶åº¦', 'benefits': 'ç¦åˆ©å¾…é‡', 'retirement': 'é€€ä¼‘åˆ¶åº¦',
                'rules': 'ç»„ç»‡è§„åˆ™', 'code': 'è¡Œä¸ºå‡†åˆ™', 'ethics': 'é“å¾·è§„èŒƒ', 'discipline': 'çºªå¾‹åˆ¶åº¦',
                'procedures': 'æ“ä½œæµç¨‹', 'protocols': 'åè®®è§„èŒƒ', 'standards': 'æ ‡å‡†åˆ¶åº¦', 'compliance': 'åˆè§„ç®¡ç†',
                'allies': 'ç›Ÿå‹å…³ç³»', 'enemies': 'æ•Œå¯¹å…³ç³»', 'neutral': 'ä¸­ç«‹å…³ç³»', 'partnerships': 'åˆä½œä¼™ä¼´',
                'reputation': 'ç»„ç»‡å£°èª‰', 'influence': 'å½±å“åŠ›', 'diplomacy': 'å¤–äº¤å…³ç³»', 'treaties': 'æ¡çº¦åè®®',
                'finances': 'è´¢åŠ¡çŠ¶å†µ', 'assets': 'èµ„äº§ç®¡ç†', 'facilities': 'è®¾æ–½è®¾å¤‡', 'equipment': 'è£…å¤‡å™¨æ',
                'technology': 'æŠ€æœ¯èµ„æº', 'knowledge': 'çŸ¥è¯†åº“', 'archives': 'æ¡£æ¡ˆç®¡ç†', 'secrets': 'æœºå¯†ä¿¡æ¯',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç»„ç»‡åç§°': 'ç»„ç»‡åç§°', 'ç»„ç»‡ç±»å‹': 'ç»„ç»‡ç±»å‹', 'ç»„ç»‡æè¿°': 'ç»„ç»‡æè¿°', 'ç»„ç»‡ç›®æ ‡': 'ç»„ç»‡ç›®æ ‡',
                'ç»„ç»‡å†å²': 'ç»„ç»‡å†å²', 'æˆç«‹èƒŒæ™¯': 'æˆç«‹èƒŒæ™¯', 'ç»„ç»‡æ ¼è¨€': 'ç»„ç»‡æ ¼è¨€', 'æ ¸å¿ƒä»·å€¼': 'æ ¸å¿ƒä»·å€¼',
                'å±‚çº§ç»“æ„': 'å±‚çº§ç»“æ„', 'éƒ¨é—¨è®¾ç½®': 'éƒ¨é—¨è®¾ç½®', 'é¢†å¯¼å±‚': 'é¢†å¯¼å±‚', 'ç†äº‹ä¼š': 'ç†äº‹ä¼š',
                'èŒä½è®¾ç½®': 'èŒä½è®¾ç½®', 'ç­‰çº§åˆ¶åº¦': 'ç­‰çº§åˆ¶åº¦', 'æ™‹å‡æœºåˆ¶': 'æ™‹å‡æœºåˆ¶', 'æƒé™åˆ†é…': 'æƒé™åˆ†é…',
                'æˆå‘˜ç®¡ç†': 'æˆå‘˜ç®¡ç†', 'æ‹›å‹Ÿåˆ¶åº¦': 'æ‹›å‹Ÿåˆ¶åº¦', 'åŸ¹è®­ä½“ç³»': 'åŸ¹è®­ä½“ç³»', 'è€ƒæ ¸è¯„ä¼°': 'è€ƒæ ¸è¯„ä¼°',
                'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šåˆ¶åº¦': 'æƒ©ç½šåˆ¶åº¦', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'é€€ä¼‘åˆ¶åº¦': 'é€€ä¼‘åˆ¶åº¦',
                'ç»„ç»‡è§„åˆ™': 'ç»„ç»‡è§„åˆ™', 'è¡Œä¸ºå‡†åˆ™': 'è¡Œä¸ºå‡†åˆ™', 'é“å¾·è§„èŒƒ': 'é“å¾·è§„èŒƒ', 'çºªå¾‹åˆ¶åº¦': 'çºªå¾‹åˆ¶åº¦',
                'æ“ä½œæµç¨‹': 'æ“ä½œæµç¨‹', 'åè®®è§„èŒƒ': 'åè®®è§„èŒƒ', 'æ ‡å‡†åˆ¶åº¦': 'æ ‡å‡†åˆ¶åº¦', 'åˆè§„ç®¡ç†': 'åˆè§„ç®¡ç†',
                'ç›Ÿå‹å…³ç³»': 'ç›Ÿå‹å…³ç³»', 'æ•Œå¯¹å…³ç³»': 'æ•Œå¯¹å…³ç³»', 'ä¸­ç«‹å…³ç³»': 'ä¸­ç«‹å…³ç³»', 'åˆä½œä¼™ä¼´': 'åˆä½œä¼™ä¼´',
                'ç»„ç»‡å£°èª‰': 'ç»„ç»‡å£°èª‰', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å¤–äº¤å…³ç³»': 'å¤–äº¤å…³ç³»', 'æ¡çº¦åè®®': 'æ¡çº¦åè®®',
                'è´¢åŠ¡çŠ¶å†µ': 'è´¢åŠ¡çŠ¶å†µ', 'èµ„äº§ç®¡ç†': 'èµ„äº§ç®¡ç†', 'è®¾æ–½è®¾å¤‡': 'è®¾æ–½è®¾å¤‡', 'è£…å¤‡å™¨æ': 'è£…å¤‡å™¨æ',
                'æŠ€æœ¯èµ„æº': 'æŠ€æœ¯èµ„æº', 'çŸ¥è¯†åº“': 'çŸ¥è¯†åº“', 'æ¡£æ¡ˆç®¡ç†': 'æ¡£æ¡ˆç®¡ç†', 'æœºå¯†ä¿¡æ¯': 'æœºå¯†ä¿¡æ¯'
            },
            news: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'breaking': 'çªå‘æ–°é—»', 'politics': 'æ”¿æ²»æ–°é—»', 'economy': 'ç»æµæ–°é—»', 'social': 'ç¤¾ä¼šæ–°é—»',
                'military': 'å†›äº‹æ–°é—»', 'technology': 'ç§‘æŠ€æ–°é—»', 'culture': 'æ–‡åŒ–æ–°é—»', 'sports': 'ä½“è‚²æ–°é—»',
                'official': 'å®˜æ–¹å…¬å‘Š', 'media': 'åª’ä½“æŠ¥é“', 'rumors': 'ä¼ è¨€æ¶ˆæ¯', 'insider': 'å†…å¹•æ¶ˆæ¯',
                'witness': 'ç›®å‡»æŠ¥å‘Š', 'intelligence': 'æƒ…æŠ¥ä¿¡æ¯', 'leaked': 'æ³„éœ²æ¶ˆæ¯', 'anonymous': 'åŒ¿åçˆ†æ–™',
                'creation': 'æ–°é—»åˆ›å»º', 'editing': 'æ–°é—»ç¼–è¾‘', 'review': 'æ–°é—»å®¡æ ¸', 'publishing': 'æ–°é—»å‘å¸ƒ',
                'archiving': 'æ–°é—»å½’æ¡£', 'deletion': 'æ–°é—»åˆ é™¤', 'backup': 'å¤‡ä»½ç®¡ç†', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶',
                'broadcast': 'å¹¿æ’­å‘å¸ƒ', 'newsletter': 'æ–°é—»ç®€æŠ¥', 'alerts': 'æ–°é—»è­¦æŠ¥', 'digest': 'æ–°é—»æ‘˜è¦',
                'socialMedia': 'ç¤¾äº¤åª’ä½“', 'forums': 'è®ºå›è®¨è®º', 'messaging': 'æ¶ˆæ¯æ¨é€', 'email': 'é‚®ä»¶é€šçŸ¥',
                'comments': 'è¯„è®ºç³»ç»Ÿ', 'likes': 'ç‚¹èµåŠŸèƒ½', 'sharing': 'åˆ†äº«åŠŸèƒ½', 'bookmarks': 'æ”¶è—åŠŸèƒ½',
                'ratings': 'è¯„åˆ†ç³»ç»Ÿ', 'polls': 'æŠ•ç¥¨è°ƒæŸ¥', 'discussions': 'è®¨è®ºåŒº', 'feedback': 'åé¦ˆç³»ç»Ÿ',
                'analytics': 'æ•°æ®åˆ†æ', 'metrics': 'æŒ‡æ ‡ç»Ÿè®¡', 'trends': 'è¶‹åŠ¿åˆ†æ', 'reports': 'æŠ¥å‘Šç”Ÿæˆ',
                'monitoring': 'ç›‘æ§ç³»ç»Ÿ', 'alertsSystem': 'è­¦æŠ¥ç³»ç»Ÿ', 'automation': 'è‡ªåŠ¨åŒ–', 'aiAnalysis': 'AIåˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'çªå‘æ–°é—»': 'çªå‘æ–°é—»', 'æ”¿æ²»æ–°é—»': 'æ”¿æ²»æ–°é—»', 'ç»æµæ–°é—»': 'ç»æµæ–°é—»', 'ç¤¾ä¼šæ–°é—»': 'ç¤¾ä¼šæ–°é—»',
                'å†›äº‹æ–°é—»': 'å†›äº‹æ–°é—»', 'ç§‘æŠ€æ–°é—»': 'ç§‘æŠ€æ–°é—»', 'æ–‡åŒ–æ–°é—»': 'æ–‡åŒ–æ–°é—»', 'ä½“è‚²æ–°é—»': 'ä½“è‚²æ–°é—»',
                'å®˜æ–¹å…¬å‘Š': 'å®˜æ–¹å…¬å‘Š', 'åª’ä½“æŠ¥é“': 'åª’ä½“æŠ¥é“', 'ä¼ è¨€æ¶ˆæ¯': 'ä¼ è¨€æ¶ˆæ¯', 'å†…å¹•æ¶ˆæ¯': 'å†…å¹•æ¶ˆæ¯',
                'ç›®å‡»æŠ¥å‘Š': 'ç›®å‡»æŠ¥å‘Š', 'æƒ…æŠ¥ä¿¡æ¯': 'æƒ…æŠ¥ä¿¡æ¯', 'æ³„éœ²æ¶ˆæ¯': 'æ³„éœ²æ¶ˆæ¯', 'åŒ¿åçˆ†æ–™': 'åŒ¿åçˆ†æ–™',
                'æ–°é—»åˆ›å»º': 'æ–°é—»åˆ›å»º', 'æ–°é—»ç¼–è¾‘': 'æ–°é—»ç¼–è¾‘', 'æ–°é—»å®¡æ ¸': 'æ–°é—»å®¡æ ¸', 'æ–°é—»å‘å¸ƒ': 'æ–°é—»å‘å¸ƒ',
                'æ–°é—»å½’æ¡£': 'æ–°é—»å½’æ¡£', 'æ–°é—»åˆ é™¤': 'æ–°é—»åˆ é™¤', 'å¤‡ä»½ç®¡ç†': 'å¤‡ä»½ç®¡ç†', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶',
                'å¹¿æ’­å‘å¸ƒ': 'å¹¿æ’­å‘å¸ƒ', 'æ–°é—»ç®€æŠ¥': 'æ–°é—»ç®€æŠ¥', 'æ–°é—»è­¦æŠ¥': 'æ–°é—»è­¦æŠ¥', 'æ–°é—»æ‘˜è¦': 'æ–°é—»æ‘˜è¦',
                'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'è®ºå›è®¨è®º': 'è®ºå›è®¨è®º', 'æ¶ˆæ¯æ¨é€': 'æ¶ˆæ¯æ¨é€', 'é‚®ä»¶é€šçŸ¥': 'é‚®ä»¶é€šçŸ¥',
                'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'ç‚¹èµåŠŸèƒ½': 'ç‚¹èµåŠŸèƒ½', 'åˆ†äº«åŠŸèƒ½': 'åˆ†äº«åŠŸèƒ½', 'æ”¶è—åŠŸèƒ½': 'æ”¶è—åŠŸèƒ½',
                'è¯„åˆ†ç³»ç»Ÿ': 'è¯„åˆ†ç³»ç»Ÿ', 'æŠ•ç¥¨è°ƒæŸ¥': 'æŠ•ç¥¨è°ƒæŸ¥', 'è®¨è®ºåŒº': 'è®¨è®ºåŒº', 'åé¦ˆç³»ç»Ÿ': 'åé¦ˆç³»ç»Ÿ',
                'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'æŒ‡æ ‡ç»Ÿè®¡': 'æŒ‡æ ‡ç»Ÿè®¡', 'è¶‹åŠ¿åˆ†æ': 'è¶‹åŠ¿åˆ†æ', 'æŠ¥å‘Šç”Ÿæˆ': 'æŠ¥å‘Šç”Ÿæˆ',
                'ç›‘æ§ç³»ç»Ÿ': 'ç›‘æ§ç³»ç»Ÿ', 'è­¦æŠ¥ç³»ç»Ÿ': 'è­¦æŠ¥ç³»ç»Ÿ', 'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIåˆ†æ': 'AIåˆ†æ',
                'äº‹ä»¶': 'äº‹ä»¶'
            },
            inventory: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'storage': 'ç‰©å“å­˜å‚¨', 'retrieval': 'ç‰©å“å–å‡º', 'organization': 'ç‰©å“æ•´ç†', 'search': 'ç‰©å“æœç´¢',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ',
                'weapons': 'æ­¦å™¨è£…å¤‡', 'armor': 'é˜²å…·è£…å¤‡', 'accessories': 'é¥°å“é…ä»¶', 'consumables': 'æ¶ˆè€—å“',
                'materials': 'ææ–™ç‰©å“', 'tools': 'å·¥å…·å™¨æ¢°', 'books': 'ä¹¦ç±æ–‡çŒ®', 'treasures': 'çå®æ”¶è—',
                'capacity': 'å®¹é‡ç®¡ç†', 'weight': 'é‡é‡é™åˆ¶', 'stacking': 'å †å åŠŸèƒ½', 'expansion': 'æ‰©å®¹å‡çº§',
                'compartments': 'åˆ†éš”ç®¡ç†', 'protection': 'ä¿æŠ¤åŠŸèƒ½', 'durability': 'è€ä¹…åº¦', 'repair': 'ä¿®ç†ç»´æŠ¤',
                'trading': 'äº¤æ˜“åŠŸèƒ½', 'selling': 'å‡ºå”®åŠŸèƒ½', 'buying': 'è´­ä¹°åŠŸèƒ½', 'auction': 'æ‹å–ç³»ç»Ÿ',
                'gifting': 'èµ é€åŠŸèƒ½', 'lending': 'å€Ÿç”¨åŠŸèƒ½', 'sharing': 'å…±äº«åŠŸèƒ½', 'banking': 'é“¶è¡Œå­˜å‚¨',
                'crafting': 'åˆ¶ä½œåŠŸèƒ½', 'recipes': 'é…æ–¹ç®¡ç†', 'enhancement': 'å¼ºåŒ–åŠŸèƒ½', 'enchanting': 'é™„é­”åŠŸèƒ½',
                'upgrading': 'å‡çº§åŠŸèƒ½', 'combining': 'åˆæˆåŠŸèƒ½', 'dismantling': 'æ‹†è§£åŠŸèƒ½', 'recycling': 'å›æ”¶åŠŸèƒ½',
                'automation': 'è‡ªåŠ¨åŒ–', 'aiSorting': 'AIæ•´ç†', 'recommendations': 'æ¨èç³»ç»Ÿ', 'analytics': 'æ•°æ®åˆ†æ',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½', 'security': 'å®‰å…¨ä¿æŠ¤', 'history': 'å†å²è®°å½•',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‰©å“å­˜å‚¨': 'ç‰©å“å­˜å‚¨', 'ç‰©å“å–å‡º': 'ç‰©å“å–å‡º', 'ç‰©å“æ•´ç†': 'ç‰©å“æ•´ç†', 'ç‰©å“æœç´¢': 'ç‰©å“æœç´¢',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ',
                'æ­¦å™¨è£…å¤‡': 'æ­¦å™¨è£…å¤‡', 'é˜²å…·è£…å¤‡': 'é˜²å…·è£…å¤‡', 'é¥°å“é…ä»¶': 'é¥°å“é…ä»¶', 'æ¶ˆè€—å“': 'æ¶ˆè€—å“',
                'ææ–™ç‰©å“': 'ææ–™ç‰©å“', 'å·¥å…·å™¨æ¢°': 'å·¥å…·å™¨æ¢°', 'ä¹¦ç±æ–‡çŒ®': 'ä¹¦ç±æ–‡çŒ®', 'çå®æ”¶è—': 'çå®æ”¶è—',
                'å®¹é‡ç®¡ç†': 'å®¹é‡ç®¡ç†', 'é‡é‡é™åˆ¶': 'é‡é‡é™åˆ¶', 'å †å åŠŸèƒ½': 'å †å åŠŸèƒ½', 'æ‰©å®¹å‡çº§': 'æ‰©å®¹å‡çº§',
                'åˆ†éš”ç®¡ç†': 'åˆ†éš”ç®¡ç†', 'ä¿æŠ¤åŠŸèƒ½': 'ä¿æŠ¤åŠŸèƒ½', 'è€ä¹…åº¦': 'è€ä¹…åº¦', 'ä¿®ç†ç»´æŠ¤': 'ä¿®ç†ç»´æŠ¤',
                'äº¤æ˜“åŠŸèƒ½': 'äº¤æ˜“åŠŸèƒ½', 'å‡ºå”®åŠŸèƒ½': 'å‡ºå”®åŠŸèƒ½', 'è´­ä¹°åŠŸèƒ½': 'è´­ä¹°åŠŸèƒ½', 'æ‹å–ç³»ç»Ÿ': 'æ‹å–ç³»ç»Ÿ',
                'èµ é€åŠŸèƒ½': 'èµ é€åŠŸèƒ½', 'å€Ÿç”¨åŠŸèƒ½': 'å€Ÿç”¨åŠŸèƒ½', 'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'é“¶è¡Œå­˜å‚¨': 'é“¶è¡Œå­˜å‚¨',
                'åˆ¶ä½œåŠŸèƒ½': 'åˆ¶ä½œåŠŸèƒ½', 'é…æ–¹ç®¡ç†': 'é…æ–¹ç®¡ç†', 'å¼ºåŒ–åŠŸèƒ½': 'å¼ºåŒ–åŠŸèƒ½', 'é™„é­”åŠŸèƒ½': 'é™„é­”åŠŸèƒ½',
                'å‡çº§åŠŸèƒ½': 'å‡çº§åŠŸèƒ½', 'åˆæˆåŠŸèƒ½': 'åˆæˆåŠŸèƒ½', 'æ‹†è§£åŠŸèƒ½': 'æ‹†è§£åŠŸèƒ½', 'å›æ”¶åŠŸèƒ½': 'å›æ”¶åŠŸèƒ½',
                'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIæ•´ç†': 'AIæ•´ç†', 'æ¨èç³»ç»Ÿ': 'æ¨èç³»ç»Ÿ', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½', 'å®‰å…¨ä¿æŠ¤': 'å®‰å…¨ä¿æŠ¤', 'å†å²è®°å½•': 'å†å²è®°å½•',
                'é‡‘å¸': 'é‡‘å¸', 'æ­¦å™¨': 'æ­¦å™¨', 'æŠ¤ç”²': 'æŠ¤ç”²', 'é“å…·': 'é“å…·'
            },
            abilities: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'strength': 'åŠ›é‡å±æ€§', 'agility': 'æ•æ·å±æ€§', 'intelligence': 'æ™ºåŠ›å±æ€§', 'constitution': 'ä½“è´¨å±æ€§',
                'wisdom': 'æ™ºæ…§å±æ€§', 'charisma': 'é­…åŠ›å±æ€§', 'luck': 'å¹¸è¿å±æ€§', 'perception': 'æ„ŸçŸ¥å±æ€§',
                'swordsmanship': 'å‰‘æœ¯æŠ€èƒ½', 'archery': 'å°„ç®­æŠ€èƒ½', 'magic': 'é­”æ³•æŠ€èƒ½', 'defense': 'é˜²å¾¡æŠ€èƒ½',
                'martialArts': 'æ­¦æœ¯æŠ€èƒ½', 'stealth': 'æ½œè¡ŒæŠ€èƒ½', 'tactics': 'æˆ˜æœ¯æŠ€èƒ½', 'healing': 'æ²»ç–—æŠ€èƒ½',
                'crafting': 'åˆ¶ä½œæŠ€èƒ½', 'cooking': 'çƒ¹é¥ªæŠ€èƒ½', 'farming': 'å†œä¸šæŠ€èƒ½', 'mining': 'é‡‡çŸ¿æŠ€èƒ½',
                'fishing': 'é’“é±¼æŠ€èƒ½', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'trading': 'è´¸æ˜“æŠ€èƒ½', 'negotiation': 'è°ˆåˆ¤æŠ€èƒ½',
                'research': 'ç ”ç©¶æŠ€èƒ½', 'investigation': 'è°ƒæŸ¥æŠ€èƒ½', 'languages': 'è¯­è¨€æŠ€èƒ½', 'history': 'å†å²çŸ¥è¯†',
                'medicine': 'åŒ»å­¦çŸ¥è¯†', 'alchemy': 'ç‚¼é‡‘æœ¯', 'engineering': 'å·¥ç¨‹å­¦', 'astronomy': 'å¤©æ–‡å­¦',
                'persuasion': 'è¯´æœæŠ€èƒ½', 'deception': 'æ¬ºéª—æŠ€èƒ½', 'intimidation': 'å¨å“æŠ€èƒ½', 'performance': 'è¡¨æ¼”æŠ€èƒ½',
                'leadership': 'é¢†å¯¼èƒ½åŠ›', 'empathy': 'å…±æƒ…èƒ½åŠ›', 'insight': 'æ´å¯Ÿèƒ½åŠ›', 'networking': 'ç¤¾äº¤èƒ½åŠ›',
                'telepathy': 'å¿ƒçµæ„Ÿåº”', 'telekinesis': 'å¿µåŠ¨åŠ›', 'precognition': 'é¢„çŸ¥èƒ½åŠ›', 'shapeshifting': 'å˜å½¢èƒ½åŠ›',
                'invisibility': 'éšèº«èƒ½åŠ›', 'flight': 'é£è¡Œèƒ½åŠ›', 'regeneration': 'å†ç”Ÿèƒ½åŠ›', 'immortality': 'ä¸æœ½èƒ½åŠ›',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŠ›é‡å±æ€§': 'åŠ›é‡å±æ€§', 'æ•æ·å±æ€§': 'æ•æ·å±æ€§', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'ä½“è´¨å±æ€§': 'ä½“è´¨å±æ€§',
                'æ™ºæ…§å±æ€§': 'æ™ºæ…§å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§', 'å¹¸è¿å±æ€§': 'å¹¸è¿å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§',
                'å‰‘æœ¯æŠ€èƒ½': 'å‰‘æœ¯æŠ€èƒ½', 'å°„ç®­æŠ€èƒ½': 'å°„ç®­æŠ€èƒ½', 'é­”æ³•æŠ€èƒ½': 'é­”æ³•æŠ€èƒ½', 'é˜²å¾¡æŠ€èƒ½': 'é˜²å¾¡æŠ€èƒ½',
                'æ­¦æœ¯æŠ€èƒ½': 'æ­¦æœ¯æŠ€èƒ½', 'æ½œè¡ŒæŠ€èƒ½': 'æ½œè¡ŒæŠ€èƒ½', 'æˆ˜æœ¯æŠ€èƒ½': 'æˆ˜æœ¯æŠ€èƒ½', 'æ²»ç–—æŠ€èƒ½': 'æ²»ç–—æŠ€èƒ½',
                'åˆ¶ä½œæŠ€èƒ½': 'åˆ¶ä½œæŠ€èƒ½', 'çƒ¹é¥ªæŠ€èƒ½': 'çƒ¹é¥ªæŠ€èƒ½', 'å†œä¸šæŠ€èƒ½': 'å†œä¸šæŠ€èƒ½', 'é‡‡çŸ¿æŠ€èƒ½': 'é‡‡çŸ¿æŠ€èƒ½',
                'é’“é±¼æŠ€èƒ½': 'é’“é±¼æŠ€èƒ½', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'è´¸æ˜“æŠ€èƒ½': 'è´¸æ˜“æŠ€èƒ½', 'è°ˆåˆ¤æŠ€èƒ½': 'è°ˆåˆ¤æŠ€èƒ½',
                'ç ”ç©¶æŠ€èƒ½': 'ç ”ç©¶æŠ€èƒ½', 'è°ƒæŸ¥æŠ€èƒ½': 'è°ƒæŸ¥æŠ€èƒ½', 'è¯­è¨€æŠ€èƒ½': 'è¯­è¨€æŠ€èƒ½', 'å†å²çŸ¥è¯†': 'å†å²çŸ¥è¯†',
                'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'ç‚¼é‡‘æœ¯': 'ç‚¼é‡‘æœ¯', 'å·¥ç¨‹å­¦': 'å·¥ç¨‹å­¦', 'å¤©æ–‡å­¦': 'å¤©æ–‡å­¦',
                'è¯´æœæŠ€èƒ½': 'è¯´æœæŠ€èƒ½', 'æ¬ºéª—æŠ€èƒ½': 'æ¬ºéª—æŠ€èƒ½', 'å¨å“æŠ€èƒ½': 'å¨å“æŠ€èƒ½', 'è¡¨æ¼”æŠ€èƒ½': 'è¡¨æ¼”æŠ€èƒ½',
                'é¢†å¯¼èƒ½åŠ›': 'é¢†å¯¼èƒ½åŠ›', 'å…±æƒ…èƒ½åŠ›': 'å…±æƒ…èƒ½åŠ›', 'æ´å¯Ÿèƒ½åŠ›': 'æ´å¯Ÿèƒ½åŠ›', 'ç¤¾äº¤èƒ½åŠ›': 'ç¤¾äº¤èƒ½åŠ›',
                'å¿ƒçµæ„Ÿåº”': 'å¿ƒçµæ„Ÿåº”', 'å¿µåŠ¨åŠ›': 'å¿µåŠ¨åŠ›', 'é¢„çŸ¥èƒ½åŠ›': 'é¢„çŸ¥èƒ½åŠ›', 'å˜å½¢èƒ½åŠ›': 'å˜å½¢èƒ½åŠ›',
                'éšèº«èƒ½åŠ›': 'éšèº«èƒ½åŠ›', 'é£è¡Œèƒ½åŠ›': 'é£è¡Œèƒ½åŠ›', 'å†ç”Ÿèƒ½åŠ›': 'å†ç”Ÿèƒ½åŠ›', 'ä¸æœ½èƒ½åŠ›': 'ä¸æœ½èƒ½åŠ›'
            },
            plot: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'mainStory': 'ä¸»çº¿å‰§æƒ…', 'sideQuests': 'æ”¯çº¿ä»»åŠ¡', 'subplots': 'å­å‰§æƒ…', 'backstory': 'èƒŒæ™¯æ•…äº‹',
                'prologue': 'åºç« ', 'epilogue': 'å°¾å£°', 'flashbacks': 'å›å¿†ç‰‡æ®µ', 'foreshadowing': 'ä¼ç¬”é“ºå«',
                'exposition': 'èƒŒæ™¯è¯´æ˜', 'risingAction': 'æƒ…èŠ‚å‘å±•', 'climax': 'é«˜æ½®éƒ¨åˆ†', 'fallingAction': 'æƒ…èŠ‚å›è½',
                'resolution': 'é—®é¢˜è§£å†³', 'denouement': 'ç»“å±€æ”¶å°¾', 'cliffhanger': 'æ‚¬å¿µç»“å°¾', 'twist': 'å‰§æƒ…è½¬æŠ˜',
                'characterArc': 'è§’è‰²æˆé•¿', 'relationships': 'äººç‰©å…³ç³»', 'motivations': 'åŠ¨æœºé©±åŠ¨', 'conflicts': 'å†²çªçŸ›ç›¾',
                'internalConflicts': 'å†…å¿ƒå†²çª', 'externalConflicts': 'å¤–éƒ¨å†²çª', 'moralDilemmas': 'é“å¾·å›°å¢ƒ', 'sacrifices': 'ç‰ºç‰²é€‰æ‹©',
                'dialogue': 'å¯¹è¯ç³»ç»Ÿ', 'narration': 'å™è¿°æå†™', 'monologue': 'ç‹¬ç™½è¡¨è¾¾', 'symbolism': 'è±¡å¾æ„ä¹‰',
                'themes': 'ä¸»é¢˜æ€æƒ³', 'mood': 'æƒ…ç»ªæ°›å›´', 'tone': 'è¯­è°ƒé£æ ¼', 'pacing': 'èŠ‚å¥æ§åˆ¶',
                'choices': 'é€‰æ‹©åˆ†æ”¯', 'consequences': 'åæœå½±å“', 'branching': 'åˆ†æ”¯å‰§æƒ…', 'multipleEndings': 'å¤šé‡ç»“å±€',
                'playerAgency': 'ç©å®¶ä¸»å¯¼', 'emergentNarrative': 'æ¶Œç°å™äº‹', 'proceduralGeneration': 'ç¨‹åºç”Ÿæˆ', 'adaptiveStorytelling': 'è‡ªé€‚åº”å™äº‹',
                'timeline': 'æ—¶é—´çº¿', 'notes': 'å‰§æƒ…ç¬”è®°', 'bookmarks': 'ä¹¦ç­¾æ ‡è®°', 'saveStates': 'å­˜æ¡£çŠ¶æ€',
                'autoSave': 'è‡ªåŠ¨ä¿å­˜', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'analytics': 'æ•°æ®åˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸»çº¿å‰§æƒ…': 'ä¸»çº¿å‰§æƒ…', 'æ”¯çº¿ä»»åŠ¡': 'æ”¯çº¿ä»»åŠ¡', 'å­å‰§æƒ…': 'å­å‰§æƒ…', 'èƒŒæ™¯æ•…äº‹': 'èƒŒæ™¯æ•…äº‹',
                'åºç« ': 'åºç« ', 'å°¾å£°': 'å°¾å£°', 'å›å¿†ç‰‡æ®µ': 'å›å¿†ç‰‡æ®µ', 'ä¼ç¬”é“ºå«': 'ä¼ç¬”é“ºå«',
                'èƒŒæ™¯è¯´æ˜': 'èƒŒæ™¯è¯´æ˜', 'æƒ…èŠ‚å‘å±•': 'æƒ…èŠ‚å‘å±•', 'é«˜æ½®éƒ¨åˆ†': 'é«˜æ½®éƒ¨åˆ†', 'æƒ…èŠ‚å›è½': 'æƒ…èŠ‚å›è½',
                'é—®é¢˜è§£å†³': 'é—®é¢˜è§£å†³', 'ç»“å±€æ”¶å°¾': 'ç»“å±€æ”¶å°¾', 'æ‚¬å¿µç»“å°¾': 'æ‚¬å¿µç»“å°¾', 'å‰§æƒ…è½¬æŠ˜': 'å‰§æƒ…è½¬æŠ˜',
                'è§’è‰²æˆé•¿': 'è§’è‰²æˆé•¿', 'äººç‰©å…³ç³»': 'äººç‰©å…³ç³»', 'åŠ¨æœºé©±åŠ¨': 'åŠ¨æœºé©±åŠ¨', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾',
                'å†…å¿ƒå†²çª': 'å†…å¿ƒå†²çª', 'å¤–éƒ¨å†²çª': 'å¤–éƒ¨å†²çª', 'é“å¾·å›°å¢ƒ': 'é“å¾·å›°å¢ƒ', 'ç‰ºç‰²é€‰æ‹©': 'ç‰ºç‰²é€‰æ‹©',
                'å¯¹è¯ç³»ç»Ÿ': 'å¯¹è¯ç³»ç»Ÿ', 'å™è¿°æå†™': 'å™è¿°æå†™', 'ç‹¬ç™½è¡¨è¾¾': 'ç‹¬ç™½è¡¨è¾¾', 'è±¡å¾æ„ä¹‰': 'è±¡å¾æ„ä¹‰',
                'ä¸»é¢˜æ€æƒ³': 'ä¸»é¢˜æ€æƒ³', 'æƒ…ç»ªæ°›å›´': 'æƒ…ç»ªæ°›å›´', 'è¯­è°ƒé£æ ¼': 'è¯­è°ƒé£æ ¼', 'èŠ‚å¥æ§åˆ¶': 'èŠ‚å¥æ§åˆ¶',
                'é€‰æ‹©åˆ†æ”¯': 'é€‰æ‹©åˆ†æ”¯', 'åæœå½±å“': 'åæœå½±å“', 'åˆ†æ”¯å‰§æƒ…': 'åˆ†æ”¯å‰§æƒ…', 'å¤šé‡ç»“å±€': 'å¤šé‡ç»“å±€',
                'ç©å®¶ä¸»å¯¼': 'ç©å®¶ä¸»å¯¼', 'æ¶Œç°å™äº‹': 'æ¶Œç°å™äº‹', 'ç¨‹åºç”Ÿæˆ': 'ç¨‹åºç”Ÿæˆ', 'è‡ªé€‚åº”å™äº‹': 'è‡ªé€‚åº”å™äº‹',
                'æ—¶é—´çº¿': 'æ—¶é—´çº¿', 'å‰§æƒ…ç¬”è®°': 'å‰§æƒ…ç¬”è®°', 'ä¹¦ç­¾æ ‡è®°': 'ä¹¦ç­¾æ ‡è®°', 'å­˜æ¡£çŠ¶æ€': 'å­˜æ¡£çŠ¶æ€',
                'è‡ªåŠ¨ä¿å­˜': 'è‡ªåŠ¨ä¿å­˜', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ'
            },
            cultivation: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'qiRefining': 'ç‚¼æ°”æœŸ', 'foundation': 'ç­‘åŸºæœŸ', 'goldenCore': 'é‡‘ä¸¹æœŸ', 'nascentSoul': 'å…ƒå©´æœŸ',
                'soulTransformation': 'åŒ–ç¥æœŸ', 'voidRefinement': 'ç‚¼è™šæœŸ', 'bodyIntegration': 'åˆä½“æœŸ', 'mahayana': 'å¤§ä¹˜æœŸ',
                'tribulation': 'æ¸¡åŠ«æœŸ', 'immortal': 'çœŸä»™', 'trueImmortal': 'å¤©ä»™', 'goldenImmortal': 'é‡‘ä»™',
                'breathingTechnique': 'å‘¼å¸æ³•', 'bodyRefining': 'ç‚¼ä½“æœ¯', 'soulCultivation': 'ç¥é­‚ä¿®ç‚¼', 'dualCultivation': 'åŒä¿®åŠŸæ³•',
                'swordCultivation': 'å‰‘ä¿®ä¹‹é“', 'alchemy': 'ç‚¼ä¸¹æœ¯', 'formation': 'é˜µæ³•', 'talisman': 'ç¬¦ç®“',
                'spiritualPower': 'çµåŠ›å€¼', 'spiritualRoot': 'çµæ ¹', 'meridians': 'ç»è„‰', 'dantian': 'ä¸¹ç”°',
                'divineSense': 'ç¥è¯†', 'lifeSpan': 'å¯¿å‘½', 'karma': 'å› æœ', 'heavenlyDao': 'å¤©é“',
                'flyingSword': 'é£å‰‘', 'magicTreasure': 'æ³•å®', 'spiritualArmor': 'çµç”²', 'storageRing': 'å‚¨ç‰©æˆ’',
                'spiritBeast': 'çµå…½', 'puppet': 'å‚€å„¡', 'avatar': 'åŒ–èº«', 'clone': 'åˆ†èº«',
                'spiritStone': 'çµçŸ³', 'spiritHerb': 'çµè‰', 'pill': 'ä¸¹è¯', 'spiritVein': 'çµè„‰',
                'caveMansion': 'æ´åºœ', 'secretRealm': 'ç§˜å¢ƒ', 'inheritance': 'ä¼ æ‰¿', 'opportunity': 'æœºç¼˜',
                'meditation': 'æ‰“å', 'tribulationCrossing': 'æ¸¡åŠ«', 'enlightenment': 'é¡¿æ‚Ÿ', 'breakthrough': 'çªç ´',
                'sect': 'å®—é—¨', 'masterDisciple': 'å¸ˆå¾’', 'daoCompanion': 'é“ä¾£', 'immortalAscension': 'é£å‡',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‚¼æ°”æœŸ': 'ç‚¼æ°”æœŸ', 'ç­‘åŸºæœŸ': 'ç­‘åŸºæœŸ', 'é‡‘ä¸¹æœŸ': 'é‡‘ä¸¹æœŸ', 'å…ƒå©´æœŸ': 'å…ƒå©´æœŸ',
                'åŒ–ç¥æœŸ': 'åŒ–ç¥æœŸ', 'ç‚¼è™šæœŸ': 'ç‚¼è™šæœŸ', 'åˆä½“æœŸ': 'åˆä½“æœŸ', 'å¤§ä¹˜æœŸ': 'å¤§ä¹˜æœŸ',
                'æ¸¡åŠ«æœŸ': 'æ¸¡åŠ«æœŸ', 'çœŸä»™': 'çœŸä»™', 'å¤©ä»™': 'å¤©ä»™', 'é‡‘ä»™': 'é‡‘ä»™',
                'å‘¼å¸æ³•': 'å‘¼å¸æ³•', 'ç‚¼ä½“æœ¯': 'ç‚¼ä½“æœ¯', 'ç¥é­‚ä¿®ç‚¼': 'ç¥é­‚ä¿®ç‚¼', 'åŒä¿®åŠŸæ³•': 'åŒä¿®åŠŸæ³•',
                'å‰‘ä¿®ä¹‹é“': 'å‰‘ä¿®ä¹‹é“', 'ç‚¼ä¸¹æœ¯': 'ç‚¼ä¸¹æœ¯', 'é˜µæ³•': 'é˜µæ³•', 'ç¬¦ç®“': 'ç¬¦ç®“',
                'çµåŠ›å€¼': 'çµåŠ›å€¼', 'çµæ ¹': 'çµæ ¹', 'ç»è„‰': 'ç»è„‰', 'ä¸¹ç”°': 'ä¸¹ç”°',
                'ç¥è¯†': 'ç¥è¯†', 'å¯¿å‘½': 'å¯¿å‘½', 'å› æœ': 'å› æœ', 'å¤©é“': 'å¤©é“',
                'é£å‰‘': 'é£å‰‘', 'æ³•å®': 'æ³•å®', 'çµç”²': 'çµç”²', 'å‚¨ç‰©æˆ’': 'å‚¨ç‰©æˆ’',
                'çµå…½': 'çµå…½', 'å‚€å„¡': 'å‚€å„¡', 'åŒ–èº«': 'åŒ–èº«', 'åˆ†èº«': 'åˆ†èº«',
                'çµçŸ³': 'çµçŸ³', 'çµè‰': 'çµè‰', 'ä¸¹è¯': 'ä¸¹è¯', 'çµè„‰': 'çµè„‰',
                'æ´åºœ': 'æ´åºœ', 'ç§˜å¢ƒ': 'ç§˜å¢ƒ', 'ä¼ æ‰¿': 'ä¼ æ‰¿', 'æœºç¼˜': 'æœºç¼˜',
                'æ‰“å': 'æ‰“å', 'æ¸¡åŠ«': 'æ¸¡åŠ«', 'é¡¿æ‚Ÿ': 'é¡¿æ‚Ÿ', 'çªç ´': 'çªç ´',
                'å®—é—¨': 'å®—é—¨', 'å¸ˆå¾’': 'å¸ˆå¾’', 'é“ä¾£': 'é“ä¾£', 'é£å‡': 'é£å‡'
            },
            fantasy: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'human': 'äººç±»ç§æ—', 'elf': 'ç²¾çµç§æ—', 'dwarf': 'çŸ®äººç§æ—', 'orc': 'å…½äººç§æ—',
                'dragon': 'é¾™æ—', 'demon': 'æ¶é­”', 'angel': 'å¤©ä½¿', 'undead': 'ä¸æ­»æ—',
                'halfling': 'åŠèº«äºº', 'giant': 'å·¨äººæ—', 'fairy': 'ä»™çµ', 'vampire': 'å¸è¡€é¬¼',
                'fireMagic': 'ç«ç³»é­”æ³•', 'waterMagic': 'æ°´ç³»é­”æ³•', 'earthMagic': 'åœŸç³»é­”æ³•', 'airMagic': 'é£ç³»é­”æ³•',
                'lightMagic': 'å…‰ç³»é­”æ³•', 'darkMagic': 'æš—ç³»é­”æ³•', 'natureMagic': 'è‡ªç„¶é­”æ³•', 'spaceMagic': 'ç©ºé—´é­”æ³•',
                'timeMagic': 'æ—¶é—´é­”æ³•', 'necromancy': 'æ­»çµæ³•æœ¯', 'illusionMagic': 'å¹»æœ¯é­”æ³•', 'enchantment': 'é™„é­”æœ¯',
                'warrior': 'æˆ˜å£«èŒä¸š', 'mage': 'æ³•å¸ˆèŒä¸š', 'archer': 'å¼“ç®­æ‰‹', 'rogue': 'ç›—è´¼èŒä¸š',
                'priest': 'ç‰§å¸ˆèŒä¸š', 'paladin': 'åœ£éª‘å£«', 'druid': 'å¾·é²ä¼Š', 'warlock': 'æœ¯å£«èŒä¸š',
                'bard': 'åŸæ¸¸è¯—äºº', 'monk': 'æ­¦åƒ§èŒä¸š', 'ranger': 'æ¸¸ä¾ èŒä¸š', 'assassin': 'åˆºå®¢èŒä¸š',
                'phoenix': 'å‡¤å‡°', 'unicorn': 'ç‹¬è§’å…½', 'griffin': 'ç‹®é¹«', 'pegasus': 'é£é©¬',
                'kraken': 'æµ·æ€ª', 'chimera': 'å¥‡ç¾æ‹‰', 'basilisk': 'è›‡æ€ª', 'hydra': 'ä¹å¤´è›‡',
                'legendaryWeapon': 'ä¼ è¯´æ­¦å™¨', 'magicArmor': 'é­”æ³•æŠ¤ç”²', 'artifact': 'ç¥å™¨', 'relic': 'åœ£ç‰©',
                'magicCrystal': 'é­”æ³•æ°´æ™¶', 'enchantedItem': 'é™„é­”ç‰©å“', 'potion': 'é­”æ³•è¯æ°´', 'scroll': 'é­”æ³•å·è½´',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'äººç±»ç§æ—': 'äººç±»ç§æ—', 'ç²¾çµç§æ—': 'ç²¾çµç§æ—', 'çŸ®äººç§æ—': 'çŸ®äººç§æ—', 'å…½äººç§æ—': 'å…½äººç§æ—',
                'é¾™æ—': 'é¾™æ—', 'æ¶é­”': 'æ¶é­”', 'å¤©ä½¿': 'å¤©ä½¿', 'ä¸æ­»æ—': 'ä¸æ­»æ—',
                'åŠèº«äºº': 'åŠèº«äºº', 'å·¨äººæ—': 'å·¨äººæ—', 'ä»™çµ': 'ä»™çµ', 'å¸è¡€é¬¼': 'å¸è¡€é¬¼',
                'ç«ç³»é­”æ³•': 'ç«ç³»é­”æ³•', 'æ°´ç³»é­”æ³•': 'æ°´ç³»é­”æ³•', 'åœŸç³»é­”æ³•': 'åœŸç³»é­”æ³•', 'é£ç³»é­”æ³•': 'é£ç³»é­”æ³•',
                'å…‰ç³»é­”æ³•': 'å…‰ç³»é­”æ³•', 'æš—ç³»é­”æ³•': 'æš—ç³»é­”æ³•', 'è‡ªç„¶é­”æ³•': 'è‡ªç„¶é­”æ³•', 'ç©ºé—´é­”æ³•': 'ç©ºé—´é­”æ³•',
                'æ—¶é—´é­”æ³•': 'æ—¶é—´é­”æ³•', 'æ­»çµæ³•æœ¯': 'æ­»çµæ³•æœ¯', 'å¹»æœ¯é­”æ³•': 'å¹»æœ¯é­”æ³•', 'é™„é­”æœ¯': 'é™„é­”æœ¯',
                'æˆ˜å£«èŒä¸š': 'æˆ˜å£«èŒä¸š', 'æ³•å¸ˆèŒä¸š': 'æ³•å¸ˆèŒä¸š', 'å¼“ç®­æ‰‹': 'å¼“ç®­æ‰‹', 'ç›—è´¼èŒä¸š': 'ç›—è´¼èŒä¸š',
                'ç‰§å¸ˆèŒä¸š': 'ç‰§å¸ˆèŒä¸š', 'åœ£éª‘å£«': 'åœ£éª‘å£«', 'å¾·é²ä¼Š': 'å¾·é²ä¼Š', 'æœ¯å£«èŒä¸š': 'æœ¯å£«èŒä¸š',
                'åŸæ¸¸è¯—äºº': 'åŸæ¸¸è¯—äºº', 'æ­¦åƒ§èŒä¸š': 'æ­¦åƒ§èŒä¸š', 'æ¸¸ä¾ èŒä¸š': 'æ¸¸ä¾ èŒä¸š', 'åˆºå®¢èŒä¸š': 'åˆºå®¢èŒä¸š',
                'å‡¤å‡°': 'å‡¤å‡°', 'ç‹¬è§’å…½': 'ç‹¬è§’å…½', 'ç‹®é¹«': 'ç‹®é¹«', 'é£é©¬': 'é£é©¬',
                'æµ·æ€ª': 'æµ·æ€ª', 'å¥‡ç¾æ‹‰': 'å¥‡ç¾æ‹‰', 'è›‡æ€ª': 'è›‡æ€ª', 'ä¹å¤´è›‡': 'ä¹å¤´è›‡',
                'ä¼ è¯´æ­¦å™¨': 'ä¼ è¯´æ­¦å™¨', 'é­”æ³•æŠ¤ç”²': 'é­”æ³•æŠ¤ç”²', 'ç¥å™¨': 'ç¥å™¨', 'åœ£ç‰©': 'åœ£ç‰©',
                'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é™„é­”ç‰©å“': 'é™„é­”ç‰©å“', 'é­”æ³•è¯æ°´': 'é­”æ³•è¯æ°´', 'é­”æ³•å·è½´': 'é­”æ³•å·è½´'
            },
            modern: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'city': 'åŸå¸‚ç¯å¢ƒ', 'district': 'åŒºåŸŸè®¾å®š', 'housing': 'ä½æˆ¿æƒ…å†µ', 'transport': 'äº¤é€šå·¥å…·',
                'neighborhood': 'ç¤¾åŒºç¯å¢ƒ', 'facilities': 'è®¾æ–½é…å¥—', 'cost': 'ç”Ÿæ´»æˆæœ¬', 'safety': 'å®‰å…¨çŠ¶å†µ',
                'pollution': 'ç¯å¢ƒæ±¡æŸ“', 'job': 'èŒä¸šå·¥ä½œ', 'company': 'å…¬å¸ä¼ä¸š', 'position': 'èŒä½ç­‰çº§',
                'income': 'æ”¶å…¥æ°´å¹³', 'worktime': 'å·¥ä½œæ—¶é—´', 'benefits': 'ç¦åˆ©å¾…é‡', 'career': 'èŒä¸šå‘å±•',
                'skills': 'æŠ€èƒ½è¦æ±‚', 'education': 'æ•™è‚²èƒŒæ™¯', 'smartphone': 'æ™ºèƒ½æ‰‹æœº', 'computer': 'ç”µè„‘è®¾å¤‡',
                'internet': 'ç½‘ç»œè¿æ¥', 'social': 'ç¤¾äº¤åª’ä½“', 'gaming': 'æ¸¸æˆå¨±ä¹', 'streaming': 'æµåª’ä½“',
                'shopping': 'è´­ç‰©æ¶ˆè´¹', 'payment': 'æ”¯ä»˜æ–¹å¼', 'ai': 'äººå·¥æ™ºèƒ½', 'health': 'å¥åº·ç®¡ç†',
                'fitness': 'å¥èº«è¿åŠ¨', 'diet': 'é¥®é£Ÿä¹ æƒ¯', 'sleep': 'ç¡çœ è´¨é‡', 'medical': 'åŒ»ç–—ä¿å¥',
                'stress': 'å‹åŠ›ç®¡ç†', 'mental': 'å¿ƒç†å¥åº·', 'checkup': 'ä½“æ£€æ£€æŸ¥', 'budget': 'é¢„ç®—ç®¡ç†',
                'brands': 'å“ç‰Œåå¥½', 'fashion': 'æ—¶å°šæ½®æµ', 'luxury': 'å¥¢ä¾ˆæ¶ˆè´¹', 'investment': 'æŠ•èµ„ç†è´¢',
                'saving': 'å‚¨è“„è®¡åˆ’', 'credit': 'ä¿¡ç”¨è®°å½•', 'insurance': 'ä¿é™©ä¿éšœ', 'movies': 'ç”µå½±å¨±ä¹',
                'music': 'éŸ³ä¹æ¬£èµ', 'books': 'é˜…è¯»ä¹ æƒ¯', 'travel': 'æ—…æ¸¸å‡ºè¡Œ', 'sports': 'ä½“è‚²è¿åŠ¨',
                'hobbies': 'å…´è¶£çˆ±å¥½', 'clubs': 'ä¿±ä¹éƒ¨', 'events': 'æ´»åŠ¨å‚ä¸',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŸå¸‚ç¯å¢ƒ': 'åŸå¸‚ç¯å¢ƒ', 'åŒºåŸŸè®¾å®š': 'åŒºåŸŸè®¾å®š', 'ä½æˆ¿æƒ…å†µ': 'ä½æˆ¿æƒ…å†µ', 'äº¤é€šå·¥å…·': 'äº¤é€šå·¥å…·',
                'ç¤¾åŒºç¯å¢ƒ': 'ç¤¾åŒºç¯å¢ƒ', 'è®¾æ–½é…å¥—': 'è®¾æ–½é…å¥—', 'ç”Ÿæ´»æˆæœ¬': 'ç”Ÿæ´»æˆæœ¬', 'å®‰å…¨çŠ¶å†µ': 'å®‰å…¨çŠ¶å†µ',
                'ç¯å¢ƒæ±¡æŸ“': 'ç¯å¢ƒæ±¡æŸ“', 'èŒä¸šå·¥ä½œ': 'èŒä¸šå·¥ä½œ', 'å…¬å¸ä¼ä¸š': 'å…¬å¸ä¼ä¸š', 'èŒä½ç­‰çº§': 'èŒä½ç­‰çº§',
                'æ”¶å…¥æ°´å¹³': 'æ”¶å…¥æ°´å¹³', 'å·¥ä½œæ—¶é—´': 'å·¥ä½œæ—¶é—´', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'èŒä¸šå‘å±•': 'èŒä¸šå‘å±•',
                'æŠ€èƒ½è¦æ±‚': 'æŠ€èƒ½è¦æ±‚', 'æ•™è‚²èƒŒæ™¯': 'æ•™è‚²èƒŒæ™¯', 'æ™ºèƒ½æ‰‹æœº': 'æ™ºèƒ½æ‰‹æœº', 'ç”µè„‘è®¾å¤‡': 'ç”µè„‘è®¾å¤‡',
                'ç½‘ç»œè¿æ¥': 'ç½‘ç»œè¿æ¥', 'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'æ¸¸æˆå¨±ä¹': 'æ¸¸æˆå¨±ä¹', 'æµåª’ä½“': 'æµåª’ä½“',
                'è´­ç‰©æ¶ˆè´¹': 'è´­ç‰©æ¶ˆè´¹', 'æ”¯ä»˜æ–¹å¼': 'æ”¯ä»˜æ–¹å¼', 'äººå·¥æ™ºèƒ½': 'äººå·¥æ™ºèƒ½', 'å¥åº·ç®¡ç†': 'å¥åº·ç®¡ç†',
                'å¥èº«è¿åŠ¨': 'å¥èº«è¿åŠ¨', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'ç¡çœ è´¨é‡': 'ç¡çœ è´¨é‡', 'åŒ»ç–—ä¿å¥': 'åŒ»ç–—ä¿å¥',
                'å‹åŠ›ç®¡ç†': 'å‹åŠ›ç®¡ç†', 'å¿ƒç†å¥åº·': 'å¿ƒç†å¥åº·', 'ä½“æ£€æ£€æŸ¥': 'ä½“æ£€æ£€æŸ¥', 'é¢„ç®—ç®¡ç†': 'é¢„ç®—ç®¡ç†',
                'å“ç‰Œåå¥½': 'å“ç‰Œåå¥½', 'æ—¶å°šæ½®æµ': 'æ—¶å°šæ½®æµ', 'å¥¢ä¾ˆæ¶ˆè´¹': 'å¥¢ä¾ˆæ¶ˆè´¹', 'æŠ•èµ„ç†è´¢': 'æŠ•èµ„ç†è´¢',
                'å‚¨è“„è®¡åˆ’': 'å‚¨è“„è®¡åˆ’', 'ä¿¡ç”¨è®°å½•': 'ä¿¡ç”¨è®°å½•', 'ä¿é™©ä¿éšœ': 'ä¿é™©ä¿éšœ', 'ç”µå½±å¨±ä¹': 'ç”µå½±å¨±ä¹',
                'éŸ³ä¹æ¬£èµ': 'éŸ³ä¹æ¬£èµ', 'é˜…è¯»ä¹ æƒ¯': 'é˜…è¯»ä¹ æƒ¯', 'æ—…æ¸¸å‡ºè¡Œ': 'æ—…æ¸¸å‡ºè¡Œ', 'ä½“è‚²è¿åŠ¨': 'ä½“è‚²è¿åŠ¨',
                'å…´è¶£çˆ±å¥½': 'å…´è¶£çˆ±å¥½', 'ä¿±ä¹éƒ¨': 'ä¿±ä¹éƒ¨', 'æ´»åŠ¨å‚ä¸': 'æ´»åŠ¨å‚ä¸'
            },
            historical: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'dynasty': 'æœä»£èƒŒæ™¯', 'period': 'å†å²æ—¶æœŸ', 'emperor': 'çš‡å¸å›ä¸»', 'capital': 'éƒ½åŸé¦–åºœ',
                'region': 'åœ°åŸŸåˆ†å¸ƒ', 'events': 'å†å²äº‹ä»¶', 'wars': 'æˆ˜äº‰å†²çª', 'politics': 'æ”¿æ²»åˆ¶åº¦',
                'economy': 'ç»æµçŠ¶å†µ', 'class': 'ç¤¾ä¼šé˜¶å±‚', 'title': 'çˆµä½å¤´è¡”', 'family': 'å®¶æ—èƒŒæ™¯',
                'wealth': 'è´¢å¯ŒçŠ¶å†µ', 'land': 'åœŸåœ°è´¢äº§', 'servants': 'ä»†ä»éšä»', 'influence': 'å½±å“åŠ›',
                'reputation': 'åå£°å£°èª‰', 'connections': 'äººè„‰å…³ç³»', 'education': 'æ•™è‚²ç¨‹åº¦', 'poetry': 'è¯—è¯æ–‡å­¦',
                'calligraphy': 'ä¹¦æ³•è‰ºæœ¯', 'music': 'éŸ³ä¹æ‰è‰º', 'chess': 'æ£‹è‰ºæŠ€å·§', 'classics': 'ç»å…¸å­¦é—®',
                'philosophy': 'å“²å­¦æ€æƒ³', 'etiquette': 'ç¤¼ä»ªè§„èŒƒ', 'language': 'è¯­è¨€æ–‡å­—', 'martial': 'æ­¦è‰ºä¿®ä¸º',
                'weapons': 'å…µå™¨ä½¿ç”¨', 'archery': 'å°„ç®­æŠ€è‰º', 'horsemanship': 'éª‘æœ¯æŠ€èƒ½', 'strategy': 'å…µæ³•è°‹ç•¥',
                'bodyguard': 'æŠ¤å«éšä»', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'survival': 'ç”Ÿå­˜æŠ€èƒ½', 'residence': 'å±…ä½ç¯å¢ƒ',
                'clothing': 'æœé¥°é£æ ¼', 'food': 'é¥®é£Ÿä¹ æƒ¯', 'transport': 'å‡ºè¡Œæ–¹å¼', 'entertainment': 'å¨±ä¹æ´»åŠ¨',
                'festivals': 'èŠ‚åº†æ´»åŠ¨', 'religion': 'å®—æ•™ä¿¡ä»°', 'medicine': 'åŒ»å­¦çŸ¥è¯†', 'profession': 'èŒä¸šèº«ä»½',
                'crafts': 'æ‰‹å·¥æŠ€è‰º', 'trade': 'å•†è´¸æ´»åŠ¨', 'farming': 'å†œä¸šç”Ÿäº§', 'administration': 'è¡Œæ”¿ç®¡ç†',
                'teaching': 'æ•™å­¦ä¼ æˆ', 'healing': 'åŒ»ç–—æ•‘æ²»', 'construction': 'å»ºç­‘è¥é€ ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»£èƒŒæ™¯': 'æœä»£èƒŒæ™¯', 'å†å²æ—¶æœŸ': 'å†å²æ—¶æœŸ', 'çš‡å¸å›ä¸»': 'çš‡å¸å›ä¸»', 'éƒ½åŸé¦–åºœ': 'éƒ½åŸé¦–åºœ',
                'åœ°åŸŸåˆ†å¸ƒ': 'åœ°åŸŸåˆ†å¸ƒ', 'å†å²äº‹ä»¶': 'å†å²äº‹ä»¶', 'æˆ˜äº‰å†²çª': 'æˆ˜äº‰å†²çª', 'æ”¿æ²»åˆ¶åº¦': 'æ”¿æ²»åˆ¶åº¦',
                'ç»æµçŠ¶å†µ': 'ç»æµçŠ¶å†µ', 'ç¤¾ä¼šé˜¶å±‚': 'ç¤¾ä¼šé˜¶å±‚', 'çˆµä½å¤´è¡”': 'çˆµä½å¤´è¡”', 'å®¶æ—èƒŒæ™¯': 'å®¶æ—èƒŒæ™¯',
                'è´¢å¯ŒçŠ¶å†µ': 'è´¢å¯ŒçŠ¶å†µ', 'åœŸåœ°è´¢äº§': 'åœŸåœ°è´¢äº§', 'ä»†ä»éšä»': 'ä»†ä»éšä»', 'å½±å“åŠ›': 'å½±å“åŠ›',
                'åå£°å£°èª‰': 'åå£°å£°èª‰', 'äººè„‰å…³ç³»': 'äººè„‰å…³ç³»', 'æ•™è‚²ç¨‹åº¦': 'æ•™è‚²ç¨‹åº¦', 'è¯—è¯æ–‡å­¦': 'è¯—è¯æ–‡å­¦',
                'ä¹¦æ³•è‰ºæœ¯': 'ä¹¦æ³•è‰ºæœ¯', 'éŸ³ä¹æ‰è‰º': 'éŸ³ä¹æ‰è‰º', 'æ£‹è‰ºæŠ€å·§': 'æ£‹è‰ºæŠ€å·§', 'ç»å…¸å­¦é—®': 'ç»å…¸å­¦é—®',
                'å“²å­¦æ€æƒ³': 'å“²å­¦æ€æƒ³', 'ç¤¼ä»ªè§„èŒƒ': 'ç¤¼ä»ªè§„èŒƒ', 'è¯­è¨€æ–‡å­—': 'è¯­è¨€æ–‡å­—', 'æ­¦è‰ºä¿®ä¸º': 'æ­¦è‰ºä¿®ä¸º',
                'å…µå™¨ä½¿ç”¨': 'å…µå™¨ä½¿ç”¨', 'å°„ç®­æŠ€è‰º': 'å°„ç®­æŠ€è‰º', 'éª‘æœ¯æŠ€èƒ½': 'éª‘æœ¯æŠ€èƒ½', 'å…µæ³•è°‹ç•¥': 'å…µæ³•è°‹ç•¥',
                'æŠ¤å«éšä»': 'æŠ¤å«éšä»', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'ç”Ÿå­˜æŠ€èƒ½': 'ç”Ÿå­˜æŠ€èƒ½', 'å±…ä½ç¯å¢ƒ': 'å±…ä½ç¯å¢ƒ',
                'æœé¥°é£æ ¼': 'æœé¥°é£æ ¼', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'å‡ºè¡Œæ–¹å¼': 'å‡ºè¡Œæ–¹å¼', 'å¨±ä¹æ´»åŠ¨': 'å¨±ä¹æ´»åŠ¨',
                'èŠ‚åº†æ´»åŠ¨': 'èŠ‚åº†æ´»åŠ¨', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'èŒä¸šèº«ä»½': 'èŒä¸šèº«ä»½',
                'æ‰‹å·¥æŠ€è‰º': 'æ‰‹å·¥æŠ€è‰º', 'å•†è´¸æ´»åŠ¨': 'å•†è´¸æ´»åŠ¨', 'å†œä¸šç”Ÿäº§': 'å†œä¸šç”Ÿäº§', 'è¡Œæ”¿ç®¡ç†': 'è¡Œæ”¿ç®¡ç†',
                'æ•™å­¦ä¼ æˆ': 'æ•™å­¦ä¼ æˆ', 'åŒ»ç–—æ•‘æ²»': 'åŒ»ç–—æ•‘æ²»', 'å»ºç­‘è¥é€ ': 'å»ºç­‘è¥é€ '
            },
            magic: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'evocation': 'å¡‘èƒ½ç³»', 'illusion': 'å¹»æœ¯ç³»', 'enchantment': 'æƒ‘æ§ç³»', 'necromancy': 'æ­»çµç³»',
                'divination': 'é¢„è¨€ç³»', 'transmutation': 'å˜åŒ–ç³»', 'conjuration': 'å’’æ³•ç³»', 'abjuration': 'é˜²æŠ¤ç³»',
                'elemental': 'å…ƒç´ æ³•æœ¯', 'cantrip': 'æˆæ³•æ³•æœ¯', 'level1': 'ä¸€ç¯æ³•æœ¯', 'level2': 'äºŒç¯æ³•æœ¯',
                'level3': 'ä¸‰ç¯æ³•æœ¯', 'level4': 'å››ç¯æ³•æœ¯', 'level5': 'äº”ç¯æ³•æœ¯', 'level6': 'å…­ç¯æ³•æœ¯',
                'level7': 'ä¸ƒç¯æ³•æœ¯', 'level8': 'å…«ç¯æ³•æœ¯', 'level9': 'ä¹ç¯æ³•æœ¯', 'level': 'æ³•æœ¯ç­‰çº§',
                'mana': 'æ³•åŠ›å€¼', 'intelligence': 'æ™ºåŠ›å±æ€§', 'wisdom': 'æ„ŸçŸ¥å±æ€§', 'charisma': 'é­…åŠ›å±æ€§',
                'concentration': 'ä¸“æ³¨èƒ½åŠ›', 'spellpower': 'æ³•æœ¯å¼ºåº¦', 'resistance': 'é­”æ³•æŠ—æ€§', 'regeneration': 'æ³•åŠ›å›å¤',
                'spellbook': 'æ³•æœ¯ä¹¦', 'known': 'å·²çŸ¥æ³•æœ¯', 'prepared': 'å‡†å¤‡æ³•æœ¯', 'slots': 'æ³•æœ¯ä½',
                'components': 'æ–½æ³•ææ–™', 'rituals': 'ä»ªå¼æ³•æœ¯', 'metamagic': 'è¶…é­”ä¸“é•¿', 'scrolls': 'æ³•æœ¯å·è½´',
                'fire': 'ç«å…ƒç´ ', 'water': 'æ°´å…ƒç´ ', 'earth': 'åœŸå…ƒç´ ', 'air': 'é£å…ƒç´ ',
                'lightning': 'é›·ç”µ', 'ice': 'å†°éœœ', 'light': 'å…‰æ˜', 'dark': 'é»‘æš—',
                'staff': 'æ³•æ–', 'wand': 'é­”æ–', 'orb': 'æ³•çƒ', 'robe': 'æ³•è¢',
                'amulet': 'æŠ¤ç¬¦', 'ring': 'é­”æ³•æˆ’æŒ‡', 'crystal': 'é­”æ³•æ°´æ™¶', 'tome': 'é­”æ³•å…¸ç±',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¡‘èƒ½ç³»': 'å¡‘èƒ½ç³»', 'å¹»æœ¯ç³»': 'å¹»æœ¯ç³»', 'æƒ‘æ§ç³»': 'æƒ‘æ§ç³»', 'æ­»çµç³»': 'æ­»çµç³»',
                'é¢„è¨€ç³»': 'é¢„è¨€ç³»', 'å˜åŒ–ç³»': 'å˜åŒ–ç³»', 'å’’æ³•ç³»': 'å’’æ³•ç³»', 'é˜²æŠ¤ç³»': 'é˜²æŠ¤ç³»',
                'å…ƒç´ æ³•æœ¯': 'å…ƒç´ æ³•æœ¯', 'æˆæ³•æ³•æœ¯': 'æˆæ³•æ³•æœ¯', 'ä¸€ç¯æ³•æœ¯': 'ä¸€ç¯æ³•æœ¯', 'äºŒç¯æ³•æœ¯': 'äºŒç¯æ³•æœ¯',
                'ä¸‰ç¯æ³•æœ¯': 'ä¸‰ç¯æ³•æœ¯', 'å››ç¯æ³•æœ¯': 'å››ç¯æ³•æœ¯', 'äº”ç¯æ³•æœ¯': 'äº”ç¯æ³•æœ¯', 'å…­ç¯æ³•æœ¯': 'å…­ç¯æ³•æœ¯',
                'ä¸ƒç¯æ³•æœ¯': 'ä¸ƒç¯æ³•æœ¯', 'å…«ç¯æ³•æœ¯': 'å…«ç¯æ³•æœ¯', 'ä¹ç¯æ³•æœ¯': 'ä¹ç¯æ³•æœ¯', 'æ³•æœ¯ç­‰çº§': 'æ³•æœ¯ç­‰çº§',
                'æ³•åŠ›å€¼': 'æ³•åŠ›å€¼', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§',
                'ä¸“æ³¨èƒ½åŠ›': 'ä¸“æ³¨èƒ½åŠ›', 'æ³•æœ¯å¼ºåº¦': 'æ³•æœ¯å¼ºåº¦', 'é­”æ³•æŠ—æ€§': 'é­”æ³•æŠ—æ€§', 'æ³•åŠ›å›å¤': 'æ³•åŠ›å›å¤',
                'æ³•æœ¯ä¹¦': 'æ³•æœ¯ä¹¦', 'å·²çŸ¥æ³•æœ¯': 'å·²çŸ¥æ³•æœ¯', 'å‡†å¤‡æ³•æœ¯': 'å‡†å¤‡æ³•æœ¯', 'æ³•æœ¯ä½': 'æ³•æœ¯ä½',
                'æ–½æ³•ææ–™': 'æ–½æ³•ææ–™', 'ä»ªå¼æ³•æœ¯': 'ä»ªå¼æ³•æœ¯', 'è¶…é­”ä¸“é•¿': 'è¶…é­”ä¸“é•¿', 'æ³•æœ¯å·è½´': 'æ³•æœ¯å·è½´',
                'ç«å…ƒç´ ': 'ç«å…ƒç´ ', 'æ°´å…ƒç´ ': 'æ°´å…ƒç´ ', 'åœŸå…ƒç´ ': 'åœŸå…ƒç´ ', 'é£å…ƒç´ ': 'é£å…ƒç´ ',
                'é›·ç”µ': 'é›·ç”µ', 'å†°éœœ': 'å†°éœœ', 'å…‰æ˜': 'å…‰æ˜', 'é»‘æš—': 'é»‘æš—',
                'æ³•æ–': 'æ³•æ–', 'é­”æ–': 'é­”æ–', 'æ³•çƒ': 'æ³•çƒ', 'æ³•è¢': 'æ³•è¢',
                'æŠ¤ç¬¦': 'æŠ¤ç¬¦', 'é­”æ³•æˆ’æŒ‡': 'é­”æ³•æˆ’æŒ‡', 'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é­”æ³•å…¸ç±': 'é­”æ³•å…¸ç±'
            },
            training: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'obedience': 'æœä»è®­ç»ƒ', 'discipline': 'çºªå¾‹è®­ç»ƒ', 'etiquette': 'ç¤¼ä»ªè®­ç»ƒ', 'posture': 'å§¿æ€è®­ç»ƒ',
                'speech': 'è¨€è¯­è®­ç»ƒ', 'behavior': 'è¡Œä¸ºè®­ç»ƒ', 'attention': 'æ³¨æ„åŠ›è®­ç»ƒ', 'patience': 'è€å¿ƒè®­ç»ƒ',
                'focus': 'ä¸“æ³¨è®­ç»ƒ', 'service': 'æœåŠ¡è®­ç»ƒ', 'cooking': 'çƒ¹é¥ªè®­ç»ƒ', 'cleaning': 'æ¸…æ´è®­ç»ƒ',
                'massage': 'æŒ‰æ‘©è®­ç»ƒ', 'entertainment': 'å¨±ä¹è®­ç»ƒ', 'music': 'éŸ³ä¹è®­ç»ƒ', 'dance': 'èˆè¹ˆè®­ç»ƒ',
                'art': 'è‰ºæœ¯è®­ç»ƒ', 'language': 'è¯­è¨€è®­ç»ƒ', 'strength': 'åŠ›é‡è®­ç»ƒ', 'endurance': 'è€åŠ›è®­ç»ƒ',
                'flexibility': 'æŸ”éŸ§è®­ç»ƒ', 'balance': 'å¹³è¡¡è®­ç»ƒ', 'coordination': 'åè°ƒè®­ç»ƒ', 'agility': 'æ•æ·è®­ç»ƒ',
                'stamina': 'ä½“èƒ½è®­ç»ƒ', 'recovery': 'æ¢å¤è®­ç»ƒ', 'confidence': 'è‡ªä¿¡è®­ç»ƒ', 'stress': 'æŠ—å‹è®­ç»ƒ',
                'emotion': 'æƒ…ç»ªè®­ç»ƒ', 'memory': 'è®°å¿†è®­ç»ƒ', 'logic': 'é€»è¾‘è®­ç»ƒ', 'creativity': 'åˆ›é€ è®­ç»ƒ',
                'meditation': 'å†¥æƒ³è®­ç»ƒ', 'mindfulness': 'æ­£å¿µè®­ç»ƒ', 'intensity': 'å¼ºåº¦è®¾ç½®', 'duration': 'æŒç»­æ—¶é—´',
                'frequency': 'è®­ç»ƒé¢‘ç‡', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šæœºåˆ¶',
                'schedule': 'è®­ç»ƒè®¡åˆ’', 'evaluation': 'è¯„ä¼°ç³»ç»Ÿ', 'auto': 'è‡ªåŠ¨è®­ç»ƒ', 'adaptive': 'è‡ªé€‚åº”è®­ç»ƒ',
                'ai': 'AIè¾…åŠ©', 'analytics': 'æ•°æ®åˆ†æ', 'reports': 'è®­ç»ƒæŠ¥å‘Š', 'export': 'å¯¼å‡ºåŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»è®­ç»ƒ': 'æœä»è®­ç»ƒ', 'çºªå¾‹è®­ç»ƒ': 'çºªå¾‹è®­ç»ƒ', 'ç¤¼ä»ªè®­ç»ƒ': 'ç¤¼ä»ªè®­ç»ƒ', 'å§¿æ€è®­ç»ƒ': 'å§¿æ€è®­ç»ƒ',
                'è¨€è¯­è®­ç»ƒ': 'è¨€è¯­è®­ç»ƒ', 'è¡Œä¸ºè®­ç»ƒ': 'è¡Œä¸ºè®­ç»ƒ', 'æ³¨æ„åŠ›è®­ç»ƒ': 'æ³¨æ„åŠ›è®­ç»ƒ', 'è€å¿ƒè®­ç»ƒ': 'è€å¿ƒè®­ç»ƒ',
                'ä¸“æ³¨è®­ç»ƒ': 'ä¸“æ³¨è®­ç»ƒ', 'æœåŠ¡è®­ç»ƒ': 'æœåŠ¡è®­ç»ƒ', 'çƒ¹é¥ªè®­ç»ƒ': 'çƒ¹é¥ªè®­ç»ƒ', 'æ¸…æ´è®­ç»ƒ': 'æ¸…æ´è®­ç»ƒ',
                'æŒ‰æ‘©è®­ç»ƒ': 'æŒ‰æ‘©è®­ç»ƒ', 'å¨±ä¹è®­ç»ƒ': 'å¨±ä¹è®­ç»ƒ', 'éŸ³ä¹è®­ç»ƒ': 'éŸ³ä¹è®­ç»ƒ', 'èˆè¹ˆè®­ç»ƒ': 'èˆè¹ˆè®­ç»ƒ',
                'è‰ºæœ¯è®­ç»ƒ': 'è‰ºæœ¯è®­ç»ƒ', 'è¯­è¨€è®­ç»ƒ': 'è¯­è¨€è®­ç»ƒ', 'åŠ›é‡è®­ç»ƒ': 'åŠ›é‡è®­ç»ƒ', 'è€åŠ›è®­ç»ƒ': 'è€åŠ›è®­ç»ƒ',
                'æŸ”éŸ§è®­ç»ƒ': 'æŸ”éŸ§è®­ç»ƒ', 'å¹³è¡¡è®­ç»ƒ': 'å¹³è¡¡è®­ç»ƒ', 'åè°ƒè®­ç»ƒ': 'åè°ƒè®­ç»ƒ', 'æ•æ·è®­ç»ƒ': 'æ•æ·è®­ç»ƒ',
                'ä½“èƒ½è®­ç»ƒ': 'ä½“èƒ½è®­ç»ƒ', 'æ¢å¤è®­ç»ƒ': 'æ¢å¤è®­ç»ƒ', 'è‡ªä¿¡è®­ç»ƒ': 'è‡ªä¿¡è®­ç»ƒ', 'æŠ—å‹è®­ç»ƒ': 'æŠ—å‹è®­ç»ƒ',
                'æƒ…ç»ªè®­ç»ƒ': 'æƒ…ç»ªè®­ç»ƒ', 'è®°å¿†è®­ç»ƒ': 'è®°å¿†è®­ç»ƒ', 'é€»è¾‘è®­ç»ƒ': 'é€»è¾‘è®­ç»ƒ', 'åˆ›é€ è®­ç»ƒ': 'åˆ›é€ è®­ç»ƒ',
                'å†¥æƒ³è®­ç»ƒ': 'å†¥æƒ³è®­ç»ƒ', 'æ­£å¿µè®­ç»ƒ': 'æ­£å¿µè®­ç»ƒ', 'å¼ºåº¦è®¾ç½®': 'å¼ºåº¦è®¾ç½®', 'æŒç»­æ—¶é—´': 'æŒç»­æ—¶é—´',
                'è®­ç»ƒé¢‘ç‡': 'è®­ç»ƒé¢‘ç‡', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šæœºåˆ¶': 'æƒ©ç½šæœºåˆ¶',
                'è®­ç»ƒè®¡åˆ’': 'è®­ç»ƒè®¡åˆ’', 'è¯„ä¼°ç³»ç»Ÿ': 'è¯„ä¼°ç³»ç»Ÿ', 'è‡ªåŠ¨è®­ç»ƒ': 'è‡ªåŠ¨è®­ç»ƒ', 'è‡ªé€‚åº”è®­ç»ƒ': 'è‡ªé€‚åº”è®­ç»ƒ',
                'AIè¾…åŠ©': 'AIè¾…åŠ©', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'è®­ç»ƒæŠ¥å‘Š': 'è®­ç»ƒæŠ¥å‘Š', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½'
            }
        };

        return displayNames[panelType]?.[key] || key;
    }

    /**
     * è·å–å­é¡¹é»˜è®¤å€¼
     */
    getDefaultSubItemValue(panelType, key) {
        const defaultValues = {
            personal: {
                name: 'æ—å¤©', age: '25', gender: 'ç”·', occupation: 'è½¯ä»¶å·¥ç¨‹å¸ˆ',
                personality: 'å¼€æœ—ã€å‹å–„', hobbies: 'ç¼–ç¨‹ã€é˜…è¯»ã€éŸ³ä¹', height: '175cm',
                weight: '70kg', bloodType: 'Oå‹'
            },
            world: {
                name: 'ç°ä»£éƒ½å¸‚', type: 'ç°å®ä¸–ç•Œ', genre: 'éƒ½å¸‚ç”Ÿæ´»',
                description: 'ç¹åçš„ç°ä»£éƒ½å¸‚ç¯å¢ƒ', geography: 'æ²¿æµ·åŸå¸‚', locations: 'å¸‚ä¸­å¿ƒã€å•†ä¸šåŒº',
                time: '2024å¹´ç°ä»£'
            },
            interaction: {
                name: 'å°é›…', type: 'æœ‹å‹', status: 'åœ¨çº¿',
                location: 'å’–å•¡å…', activity: 'èŠå¤©', relationship: 'å¥½å‹',
                intimacy: 'å‹å¥½', history: 'è®¤è¯†3å¹´', autoRecord: 'å¼€å¯'
            }
        };

        return defaultValues[panelType]?.[key] || '';
    }

    /**
     * è®¾ç½®åµŒå¥—å±æ€§
     */
    setNestedProperty(obj, path, value) {
        const keys = path.split('.');
        let current = obj;

        for (let i = 0; i < keys.length - 1; i++) {
            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ä¸­é—´èŠ‚ç‚¹æ˜¯å¦æ˜¯å¯¹è±¡ç±»å‹
            // å¦‚æœä¸å­˜åœ¨æˆ–è€…ä¸æ˜¯å¯¹è±¡ï¼ˆæ¯”å¦‚æ˜¯å¸ƒå°”å€¼ã€å­—ç¬¦ä¸²ç­‰ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°å¯¹è±¡
            if (!current[keys[i]] || typeof current[keys[i]] !== 'object' || Array.isArray(current[keys[i]])) {
                current[keys[i]] = {};
            }
            current = current[keys[i]];
        }

        current[keys[keys.length - 1]] = value;
    }

    /**
     * ğŸ†• æ›´æ–°ç ´ç”²æç¤ºè¯ç»Ÿè®¡ä¿¡æ¯
     */
    updateArmorBreakingStats() {
        try {
            const textarea = this.modal.querySelector('#armor-breaking-prompt');
            const charCountSpan = this.modal.querySelector('#armor-breaking-char-count');
            const wordCountSpan = this.modal.querySelector('#armor-breaking-word-count');

            if (!textarea || !charCountSpan || !wordCountSpan) return;

            const text = textarea.value || '';
            const charCount = text.length;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;

            charCountSpan.textContent = charCount;
            wordCountSpan.textContent = wordCount;

            // æ ¹æ®å­—ç¬¦æ•°é‡è®¾ç½®é¢œè‰²æç¤º
            if (charCount > 1000) {
                charCountSpan.style.color = '#ff6b6b'; // çº¢è‰²è­¦å‘Š
            } else if (charCount > 500) {
                charCountSpan.style.color = '#ffa726'; // æ©™è‰²æé†’
            } else {
                charCountSpan.style.color = ''; // é»˜è®¤é¢œè‰²
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ç ´ç”²æç¤ºè¯ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    /**
     * æ£€æŸ¥APIé…ç½®æ˜¯å¦æœ‰å˜åŒ–
     */
    hasAPIConfigChanged(formData) {
        return Object.keys(formData).some(key => key.startsWith('apiConfig.'));
    }

    /**
     * æµ‹è¯•APIè¿æ¥
     */
    async testAPIConnection() {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹æµ‹è¯•APIè¿æ¥...');

            // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
            this.updateConnectionStatus('testing', 'æµ‹è¯•ä¸­...');

            const result = await this.apiIntegration.testConnection();

            if (result.success) {
                this.updateConnectionStatus('success', 'è¿æ¥æˆåŠŸ');
                this.showMessage('APIè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
            } else {
                this.updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
                this.showMessage('APIè¿æ¥æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•APIè¿æ¥å¤±è´¥:', error);
            this.updateConnectionStatus('error', 'æµ‹è¯•å¼‚å¸¸');
            this.showMessage('APIè¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error.message, 'error');
        }
    }

    /**
     * åŠ è½½APIæ¨¡å‹
     */
    async loadAPIModels() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ å¼€å§‹åŠ è½½APIæ¨¡å‹...');

            const models = await this.apiIntegration.loadModels();
            const modelSelect = this.modal.querySelector('[name="apiConfig.model"]');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';

            // æ·»åŠ æ¨¡å‹é€‰é¡¹
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                option.title = model.description;
                modelSelect.appendChild(option);
            });

            this.showMessage(`æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½APIæ¨¡å‹å¤±è´¥:', error);
            this.showMessage('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
     */
    updateConnectionStatus(status, message) {
        const statusElement = this.modal.querySelector('[data-status="connection"]');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `status-value status-${status}`;
        }
    }

    /**
     * æ›´æ–°APIçŠ¶æ€
     */
    updateAPIStatus() {
        if (!this.apiIntegration) return;

        const stats = this.apiIntegration.getStats();
        const statsElement = this.modal.querySelector('[data-status="stats"]');

        if (statsElement) {
            statsElement.textContent = `${stats.success}/${stats.total} (${stats.successRate})`;
        }
    }
    /**
     * æ˜¾ç¤ºé¡¶éƒ¨æç¤ºæ¶ˆæ¯
     */
    showMessage(message, type = 'info') {
        try {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºé¡¶éƒ¨æç¤º
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;

            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            let bgColor = 'var(--theme-bg-secondary, #2d3748)';
            let borderColor = 'var(--theme-border-color, #4a5568)';
            let textColor = 'var(--theme-text-primary, #ffffff)';
            let icon = 'â„¹ï¸';

            if (type === 'success') {
                bgColor = 'var(--theme-primary-color, #4299e1)';
                borderColor = 'var(--theme-primary-color, #4299e1)';
                textColor = '#ffffff';
                icon = 'âœ…';
            } else if (type === 'error') {
                bgColor = '#f56565';
                borderColor = '#f56565';
                textColor = '#ffffff';
                icon = 'âŒ';
            } else if (type === 'warning') {
                bgColor = '#ed8936';
                borderColor = '#ed8936';
                textColor = '#ffffff';
                icon = 'âš ï¸';
            }

            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(-100%);
                background: ${bgColor};
                color: ${textColor};
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                font-weight: 500;
                min-width: 200px;
                max-width: 400px;
                transition: transform 0.3s ease;
                border: 1px solid ${borderColor};
            `;

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-text">${message}</span>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // è§¦å‘è¿›å…¥åŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.transform = 'translateX(-50%) translateY(-100%)';
                    setTimeout(() => {
                        if (toast && toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 3000);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥:', error);
            // é™çº§åˆ°æµè§ˆå™¨åŸç”Ÿæç¤º
            alert(message);
        }
    }

    /**
     * åˆå§‹åŒ–æ’ä»¶ - æ¢å¤åˆ°åˆšå®‰è£…çš„çŠ¶æ€
     * @param {boolean} skipConfirmation - æ˜¯å¦è·³è¿‡ç¡®è®¤å¯¹è¯æ¡†ï¼ˆç”¨äºç¨‹åºåŒ–è°ƒç”¨ï¼‰
     */
    async initializePlugin(skipConfirmation = false) {
        try {
            // åªæœ‰åœ¨éè·³è¿‡ç¡®è®¤æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (!skipConfirmation) {
                const confirmMessage = 'âš ï¸ å±é™©æ“ä½œç¡®è®¤\n\n' +
                    'æ­¤æ“ä½œå°†ï¼š\n' +
                    'â€¢ å®Œå…¨æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®å’ŒèŠå¤©è®°å½•ä¸­çš„é¢æ¿æ•°æ®\n' +
                    'â€¢ åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿å’Œå­é¡¹\n' +
                    'â€¢ é‡ç½®æ‰€æœ‰é…ç½®åˆ°é»˜è®¤å€¼\n' +
                    'â€¢ æ¸…é™¤æ‰€æœ‰å­—æ®µè§„åˆ™å’Œé¢æ¿è§„åˆ™\n' +
                    'â€¢ æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å’Œæ‰©å±•è®¾ç½®\n' +
                    'â€¢ æ¸…é™¤æ‰€æœ‰localStorageæ•°æ®\n' +
                    'â€¢ è‡ªåŠ¨åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½æ’ä»¶\n\n' +
                    'æ’ä»¶å°†å®Œå…¨æ¢å¤åˆ°åˆšå®‰è£…æ—¶çš„çŠ¶æ€ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\n' +
                    'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';

                if (!confirm(confirmMessage)) {
                    return;
                }

                // äºŒæ¬¡ç¡®è®¤
                if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦å®Œå…¨åˆå§‹åŒ–æ’ä»¶å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ï¼')) {
                    return;
                }
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹å®Œå…¨åˆå§‹åŒ–æ’ä»¶...');

            // === ç¬¬1æ­¥ï¼šè·å–å¿…è¦çš„å¼•ç”¨ ===
            const configManager = this.configManager || window.SillyTavernInfobar?.modules?.configManager;
            const dataCore = configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore;
            const context = window.SillyTavern?.getContext?.();

            // === ç¬¬2æ­¥ï¼šæ¸…ç©ºæ•°æ®æ ¸å¿ƒçš„æ‰€æœ‰æ•°æ® ===
            if (dataCore) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®æ ¸å¿ƒæ‰€æœ‰æ•°æ®...');
                await dataCore.clearAllData('all');

                // æ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„
                if (dataCore.cache) dataCore.cache.clear();
                if (dataCore.data) dataCore.data.clear();
                if (dataCore.recentEntries) dataCore.recentEntries.length = 0;
                if (dataCore.chatDataCache) dataCore.chatDataCache.clear();
            }

            // === ç¬¬3æ­¥ï¼šæ¸…ç©ºé…ç½®ç®¡ç†å™¨æ‰€æœ‰æ•°æ® ===
            if (configManager) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºé…ç½®ç®¡ç†å™¨æ‰€æœ‰æ•°æ®...');
                if (configManager.configCache) configManager.configCache.clear();

                // è°ƒç”¨é…ç½®ç®¡ç†å™¨çš„æ¸…ç©ºæ–¹æ³•
                if (typeof configManager.clearAllData === 'function') {
                    await configManager.clearAllData();
                }
            }

            // === ç¬¬4æ­¥ï¼šå®Œå…¨æ¸…ç©º SillyTavern extensionSettings ===
            if (context && context.extensionSettings) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºSillyTavernæ‰©å±•è®¾ç½®...');

                let clearedConfigs = 0;

                // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„æ‰©å±•é…ç½®é”®åå˜ä½“
                const configKeysToDelete = [
                    'Information bar integration tool',
                    'information_bar_integration_tool',
                    'Information Integration Tool',
                    'advanced-infobar-system',
                    'infobar',
                    'InfoBar',
                    'information-bar',
                    'sillyTavernInfobar'
                ];

                configKeysToDelete.forEach(key => {
                    if (context.extensionSettings[key]) {
                        delete context.extensionSettings[key];
                        clearedConfigs++;
                        console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤æ‰©å±•é…ç½®: ${key}`);
                    }
                });

                // æ‰«ææ‰€æœ‰æ‰©å±•é…ç½®ï¼ŒæŸ¥æ‰¾å¯èƒ½é—æ¼çš„ä¿¡æ¯æ ç›¸å…³é…ç½®
                const allExtensionKeys = Object.keys(context.extensionSettings);
                const suspiciousKeys = allExtensionKeys.filter(key =>
                    key.toLowerCase().includes('infobar') ||
                    key.toLowerCase().includes('information') ||
                    key.toLowerCase().includes('bar') ||
                    key.toLowerCase().includes('integration')
                );

                suspiciousKeys.forEach(key => {
                    if (!configKeysToDelete.includes(key)) {
                        const config = context.extensionSettings[key];
                        if (config && typeof config === 'object') {
                            // æ£€æŸ¥é…ç½®å†…å®¹æ˜¯å¦åŒ…å«ä¿¡æ¯æ ç›¸å…³æ•°æ®
                            const configStr = JSON.stringify(config).toLowerCase();
                            if (configStr.includes('infobar') || configStr.includes('panel') || configStr.includes('field')) {
                                delete context.extensionSettings[key];
                                clearedConfigs++;
                                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤å¯ç–‘æ‰©å±•é…ç½®: ${key}`);
                            }
                        }
                    }
                });

                console.log(`[InfoBarSettings] ğŸ“Š æ€»å…±æ¸…ç†äº† ${clearedConfigs} ä¸ªæ‰©å±•é…ç½®`);

                // ä¿å­˜æ¸…ç©ºçš„è®¾ç½®
                if (typeof context.saveSettings === 'function') {
                    await context.saveSettings();
                }
            }

            // === ç¬¬5æ­¥ï¼šæ¸…ç©ºlocalStorageä¸­çš„æ‰€æœ‰ç›¸å…³æ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºlocalStorageç›¸å…³æ•°æ®...');
            const keysToRemove = [];

            // å¢å¼ºçš„æ¨¡å¼åŒ¹é…åˆ—è¡¨
            const patterns = [
                'Information bar integration tool',
                'information_bar_integration_tool',
                'Information_bar_integration_tool',
                'infobar',
                'InfoBar',
                'SillyTavernInfobar',
                'information',
                'panel',
                'field',
                'integration',
                'backup_'
            ];

            // æ‰«ææ‰€æœ‰localStorageé”®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    const keyLower = key.toLowerCase();

                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ¨¡å¼
                    const shouldRemove = patterns.some(pattern => {
                        const patternLower = pattern.toLowerCase();
                        return keyLower.includes(patternLower);
                    });

                    if (shouldRemove) {
                        keysToRemove.push(key);
                    }
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š æ‰¾åˆ° ${keysToRemove.length} ä¸ªè¦åˆ é™¤çš„localStorageé”®`);

            // åˆ é™¤æ‰¾åˆ°çš„æ‰€æœ‰ç›¸å…³é”®
            keysToRemove.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    localStorage.removeItem(key);
                    console.log(`[InfoBarSettings] ğŸ—‘ï¸ å·²åˆ é™¤localStorageé”®: ${key} (å€¼é•¿åº¦: ${value ? value.length : 0})`);
                } catch (e) {
                    console.warn(`[InfoBarSettings] âš ï¸ åˆ é™¤localStorageé”®å¤±è´¥: ${key}`, e);
                }
            });

            // === ç¬¬6æ­¥ï¼šé‡ç½®å…¨å±€å˜é‡å’Œæ¨¡å—çŠ¶æ€ ===
            console.log('[InfoBarSettings] ğŸ”„ é‡ç½®å…¨å±€å˜é‡å’Œæ¨¡å—çŠ¶æ€...');

            let destroyedModules = 0;
            let clearedGlobals = 0;

            // æ¸…ç†å…¨å±€å¯¹è±¡
            if (window.SillyTavernInfobar) {
                console.log('[InfoBarSettings] ğŸ” å‘ç° window.SillyTavernInfobarï¼Œå¼€å§‹æ·±åº¦æ¸…ç†...');

                // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨å’Œæ¸…ç†æ¨¡å—çŠ¶æ€
                if (window.SillyTavernInfobar.modules) {
                    const moduleNames = Object.keys(window.SillyTavernInfobar.modules);
                    console.log('[InfoBarSettings] ğŸ“Š å‘ç°æ¨¡å—:', moduleNames);

                    Object.entries(window.SillyTavernInfobar.modules).forEach(([name, module]) => {
                        try {
                            if (module) {
                                // æ¸…ç†æ¨¡å—å†…éƒ¨çŠ¶æ€
                                if (module.eventSystem && typeof module.eventSystem.removeAllListeners === 'function') {
                                    module.eventSystem.removeAllListeners();
                                }

                                // æ¸…ç†å®šæ—¶å™¨
                                if (module.syncTimer) {
                                    clearInterval(module.syncTimer);
                                    module.syncTimer = null;
                                }
                                if (module.backupTimer) {
                                    clearInterval(module.backupTimer);
                                    module.backupTimer = null;
                                }

                                // æ¸…ç†ç¼“å­˜
                                if (module.cache && typeof module.cache.clear === 'function') {
                                    module.cache.clear();
                                }

                                // è°ƒç”¨æ¨¡å—é”€æ¯æ–¹æ³•
                                if (typeof module.destroy === 'function') {
                                    module.destroy();
                                }

                                destroyedModules++;
                                console.log(`[InfoBarSettings] âœ… æ¨¡å— ${name} å·²é”€æ¯`);
                            }
                        } catch (e) {
                            console.warn(`[InfoBarSettings] âš ï¸ æ¨¡å— ${name} é”€æ¯å¤±è´¥:`, e);
                        }
                    });
                }

                // æ¸…ç†äº‹ä»¶ç³»ç»Ÿ
                if (window.SillyTavernInfobar.eventSource) {
                    try {
                        window.SillyTavernInfobar.eventSource.removeAllListeners?.();
                        delete window.SillyTavernInfobar.eventSource;
                        console.log('[InfoBarSettings] âœ… äº‹ä»¶ç³»ç»Ÿå·²æ¸…ç†');
                    } catch (e) {
                        console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†äº‹ä»¶ç³»ç»Ÿå¤±è´¥:', e);
                    }
                }

                // å®Œå…¨æ¸…ç©ºå…¨å±€å¯¹è±¡
                delete window.SillyTavernInfobar;
                clearedGlobals++;
                console.log('[InfoBarSettings] âœ… window.SillyTavernInfobar å·²å®Œå…¨åˆ é™¤');
            }

            // æ¸…ç†å…¶ä»–å¯èƒ½çš„å…¨å±€å¼•ç”¨
            const globalReferencesToClear = [
                'InfoBarData',
                'informationBarTool',
                'infoBarTool',
                'InfoBarTool',
                'SillyTavernInfoBarData',
                'InfoBarIntegrationTool'
            ];

            globalReferencesToClear.forEach(refName => {
                if (window[refName]) {
                    delete window[refName];
                    clearedGlobals++;
                    console.log(`[InfoBarSettings] âœ… å·²æ¸…ç†å…¨å±€å¼•ç”¨: window.${refName}`);
                }
            });

            console.log(`[InfoBarSettings] ğŸ“Š å…¨å±€æ¸…ç†ç»Ÿè®¡: é”€æ¯æ¨¡å— ${destroyedModules} ä¸ªï¼Œæ¸…ç†å…¨å±€å¼•ç”¨ ${clearedGlobals} ä¸ª`);

            // === ç¬¬7æ­¥ï¼šæ¸…ç†chatMetadataä¸­çš„æ®‹ç•™æ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†chatMetadataä¸­çš„æ®‹ç•™æ•°æ®...');
            await this.clearChatMetadataInfobarData();

            // === ç¬¬8æ­¥ï¼šæ¸…ç†STScriptå˜é‡ç³»ç»Ÿæ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†STScriptå˜é‡ç³»ç»Ÿæ•°æ®...');
            await this.clearSTScriptVariables();

            // === ç¬¬9æ­¥ï¼šæ¸…ç†äº‹ä»¶ç›‘å¬å™¨ ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨...');

            // ç§»é™¤DOMäº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('input', this.handleInput);
            document.removeEventListener('change', this.handleChange);
            document.removeEventListener('click', this.handleClick);

            // === ç¬¬10æ­¥ï¼šå…³é—­è®¾ç½®çª—å£ ===
            if (this.modal) {
                this.modal.style.display = 'none';
            }

            console.log('[InfoBarSettings] âœ… æ’ä»¶å®Œå…¨åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡åˆ·æ–°é¡µé¢...');

            // === ç¬¬11æ­¥ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è‡ªåŠ¨åˆ·æ–°é¡µé¢ ===
            const successMessage = 'âœ… æ’ä»¶å·²å®Œå…¨åˆå§‹åŒ–åˆ°åˆšå®‰è£…çš„çŠ¶æ€ï¼\n\né¡µé¢å°†åœ¨3ç§’åè‡ªåŠ¨åˆ·æ–°ä»¥é‡æ–°åŠ è½½æ’ä»¶...';

            // ä½¿ç”¨åŸç”Ÿalertç¡®ä¿æ¶ˆæ¯æ˜¾ç¤º
            alert(successMessage);

            // å»¶è¿Ÿåˆ·æ–°ç»™ç”¨æˆ·æ—¶é—´çœ‹åˆ°æ¶ˆæ¯
            setTimeout(() => {
                console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨åˆ·æ–°é¡µé¢...');
                window.location.reload();
            }, 3000);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ’ä»¶å¤±è´¥:', error);

            // ç¡®ä¿é”™è¯¯æ¶ˆæ¯èƒ½æ˜¾ç¤º
            const errorMessage = 'âŒ æ’ä»¶åˆå§‹åŒ–å¤±è´¥: ' + error.message + '\n\nå»ºè®®æ‰‹åŠ¨åˆ·æ–°é¡µé¢åé‡è¯•ã€‚';
            alert(errorMessage);
        }
    }

    /**
     * æ¸…ç†chatMetadataä¸­çš„ä¿¡æ¯æ æ•°æ®
     */
    async clearChatMetadataInfobarData() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†chatMetadataä¸­çš„ä¿¡æ¯æ æ•°æ®...');

            const context = SillyTavern?.getContext?.();
            if (!context) {
                console.warn('[InfoBarSettings] âš ï¸ SillyTavernä¸Šä¸‹æ–‡ä¸å¯ç”¨ï¼Œè·³è¿‡chatMetadataæ¸…ç†');
                return;
            }

            const chatMetadata = context.chat_metadata || context.chatMetadata;
            if (!chatMetadata) {
                console.warn('[InfoBarSettings] âš ï¸ chatMetadataä¸å¯ç”¨ï¼Œè·³è¿‡æ¸…ç†');
                return;
            }

            let clearedCount = 0;

            // === 1. æ¸…ç†ç‰¹å®šçš„ä¿¡æ¯æ é”® ===
            const specificInfobarKeys = [
                'information_bar_integration_tool',
                'Information_bar_integration_tool',
                'infobar_data',
                'panels',
                'panel_data',
                'field_data'
            ];

            specificInfobarKeys.forEach(key => {
                if (chatMetadata.hasOwnProperty(key)) {
                    delete chatMetadata[key];
                    clearedCount++;
                    console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤chatMetadataé”®: ${key}`);
                }
            });

            // === 2. æ‰«æå¹¶æ¸…ç†æ‰€æœ‰chat_*æ ¼å¼çš„æ•°æ® ===
            const allKeys = Object.keys(chatMetadata);
            const chatKeys = allKeys.filter(key =>
                key.startsWith('chat_') &&
                (key.includes('infobar') || key.includes('information') || key.includes('panel'))
            );

            chatKeys.forEach(key => {
                delete chatMetadata[key];
                clearedCount++;
                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤chatMetadataé”®: ${key}`);
            });

            // === 3. æ¸…ç†panels.*æ ¼å¼çš„é¢æ¿æ•°æ®ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰ ===
            const panelsKeys = allKeys.filter(key => key.startsWith('panels.'));
            console.log(`[InfoBarSettings] ğŸ” å‘ç° ${panelsKeys.length} ä¸ªpanels.*é”®:`, panelsKeys);

            panelsKeys.forEach(key => {
                delete chatMetadata[key];
                clearedCount++;
                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤é¢æ¿æ•°æ®é”®: ${key}`);
            });

            // === 4. æ¸…ç†æ‰€æœ‰åŒ…å«ä¿¡æ¯æ ç›¸å…³çš„é”® ===
            const infobarRelatedKeys = allKeys.filter(key =>
                !key.startsWith('panels.') && // æ’é™¤å·²å¤„ç†çš„panels.*é”®
                !specificInfobarKeys.includes(key) &&
                !chatKeys.includes(key) && (
                    key.toLowerCase().includes('infobar') ||
                    key.toLowerCase().includes('information') ||
                    key.toLowerCase().includes('panel') ||
                    key.toLowerCase().includes('field')
                )
            );

            infobarRelatedKeys.forEach(key => {
                const value = chatMetadata[key];
                // æ£€æŸ¥å€¼æ˜¯å¦åŒ…å«ä¿¡æ¯æ ç›¸å…³æ•°æ®
                if (value && typeof value === 'object') {
                    const valueStr = JSON.stringify(value).toLowerCase();
                    if (valueStr.includes('infobar') || valueStr.includes('panel') || valueStr.includes('field')) {
                        delete chatMetadata[key];
                        clearedCount++;
                        console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤åŒ…å«ä¿¡æ¯æ æ•°æ®çš„chatMetadataé”®: ${key}`);
                    }
                } else {
                    // å¯¹äºéå¯¹è±¡å€¼ï¼Œä¹Ÿæ£€æŸ¥é”®å
                    delete chatMetadata[key];
                    clearedCount++;
                    console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤ä¿¡æ¯æ ç›¸å…³é”®: ${key}`);
                }
            });

            // === 5. ä¿å­˜æ¸…ç†åçš„chatMetadata ===
            if (clearedCount > 0) {
                if (typeof context.saveChatMetadata === 'function') {
                    await context.saveChatMetadata();
                    console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜æ¸…ç†åçš„chatMetadata');
                } else if (typeof context.saveMetadata === 'function') {
                    await context.saveMetadata();
                    console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜æ¸…ç†åçš„metadata');
                }
            }

            console.log(`[InfoBarSettings] âœ… chatMetadataæ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${clearedCount} ä¸ªé”®`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†chatMetadataå¤±è´¥:', error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åˆå§‹åŒ–è¿‡ç¨‹ç»§ç»­
        }
    }

    /**
     * æ¸…ç†STScriptå˜é‡ç³»ç»Ÿä¸­çš„æ‰€æœ‰ä¿¡æ¯æ æ•°æ®
     */
    async clearSTScriptVariables() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†STScriptå˜é‡...');

            const context = SillyTavern?.getContext?.();
            if (!context || typeof context.executeSlashCommands !== 'function') {
                console.warn('[InfoBarSettings] âš ï¸ STScriptåŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡å˜é‡æ¸…ç†');
                return;
            }

            let clearedCount = 0;

            // === 1. æ¸…ç†ä¸»è¦çš„infobaråµŒå¥—ç»“æ„å˜é‡ ===
            try {
                // å…ˆæ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨
                const currentValue = context.substituteParams('{{getvar::infobar}}');
                if (currentValue && currentValue.trim() && !currentValue.includes('{{getvar::')) {
                    console.log('[InfoBarSettings] ğŸ” å‘ç°ä¸»infobarå˜é‡ï¼Œå†…å®¹é•¿åº¦:', currentValue.length);

                    // å¼ºåˆ¶æ¸…ç†ä¸»infobarå˜é‡ - ä½¿ç”¨ç©ºå€¼è¦†ç›–
                    await context.executeSlashCommands('/setvar key=infobar value=""');

                    // éªŒè¯æ¸…ç†ç»“æœ
                    const afterClear = context.substituteParams('{{getvar::infobar}}');
                    if (!afterClear || afterClear.trim() === '' || afterClear.includes('{{getvar::')) {
                        console.log('[InfoBarSettings] âœ… ä¸»infobarå˜é‡å·²æˆåŠŸæ¸…ç†');
                        clearedCount++;
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ ä¸»infobarå˜é‡æ¸…ç†å¯èƒ½ä¸å®Œå…¨ï¼Œå‰©ä½™:', afterClear.substring(0, 100));
                        // å°è¯•ç¬¬äºŒæ¬¡æ¸…ç†
                        await context.executeSlashCommands('/setvar key=infobar ');
                        clearedCount++;
                    }
                } else {
                    console.log('[InfoBarSettings] â„¹ï¸ ä¸»infobarå˜é‡ä¸å­˜åœ¨æˆ–å·²ä¸ºç©º');
                }
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†ä¸»infobarå˜é‡å¤±è´¥:', e);
            }

            // === 2. æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡ ===
            try {
                await context.executeSlashCommands('/setvar key=infobar_sync_rules ');
                clearedCount++;
                console.log('[InfoBarSettings] âœ… å·²æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡');
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡å¤±è´¥:', e);
            }

            // === 3. æ¸…ç†æ‰€æœ‰é¢æ¿ç›¸å…³çš„åˆ†æ•£å˜é‡ ===
            const panelNames = [
                'personal', 'world', 'interaction', 'tasks', 'inventory', 'abilities',
                'organization', 'news', 'plot', 'cultivation', 'fantasy', 'modern',
                'historical', 'magic', 'training'
            ];

            const commonFieldNames = [
                'name', 'age', 'gender', 'appearance', 'posture', 'mood', 'location', 'room',
                'environment', 'object', 'health', 'energy', 'consciousness', 'type', 'genre',
                'description', 'status', 'priority', 'deadline', 'progress', 'category',
                'weapons', 'armor', 'items', 'storage', 'capacity', 'strength', 'agility',
                'intelligence', 'skills', 'leadership', 'influence', 'reputation', 'lastUpdated'
            ];

            // æ¸…ç†é¢æ¿æ•´ä½“å˜é‡
            for (const panelName of panelNames) {
                try {
                    await context.executeSlashCommands(`/setvar key=infobar_${panelName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            // æ¸…ç†é¢æ¿å­—æ®µå˜é‡
            for (const panelName of panelNames) {
                for (const fieldName of commonFieldNames) {
                    try {
                        await context.executeSlashCommands(`/setvar key=infobar_${panelName}_${fieldName} `);
                        clearedCount++;
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                    }
                }
            }

            // === 4. æ¸…ç†æ€»ç»“ç›¸å…³å˜é‡ ===
            const summaryVars = [
                'summary_count', 'summary_latest', 'summary_latest_timestamp', 'summary_latest_type',
                'summary_all', 'summary_timeline',
                'summary_1', 'summary_1_timestamp', 'summary_1_type',
                'summary_2', 'summary_2_timestamp', 'summary_2_type',
                'summary_3', 'summary_3_timestamp', 'summary_3_type'
            ];

            for (const varName of summaryVars) {
                try {
                    await context.executeSlashCommands(`/setvar key=${varName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            // === 5. æ¸…ç†å…¶ä»–å¯èƒ½çš„æ’ä»¶ç›¸å…³å˜é‡ ===
            const otherVars = [
                'infobar_enabled', 'infobar_version', 'infobar_config', 'infobar_theme',
                'infobar_auto_sync', 'infobar_debug', 'infobar_status'
            ];

            for (const varName of otherVars) {
                try {
                    await context.executeSlashCommands(`/setvar key=${varName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            console.log(`[InfoBarSettings] âœ… STScriptå˜é‡æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${clearedCount} ä¸ªå˜é‡`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†STScriptå˜é‡å¤±è´¥:', error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åˆå§‹åŒ–è¿‡ç¨‹ç»§ç»­
        }
    }

    /**
     * æ¸…ç©ºé¢æ¿æ•°æ® - åªæ¸…ç©ºæ•°æ®ï¼Œä¿ç•™é…ç½®
     */
    async clearPanelData() {
        try {
            const confirmMessage = 'âš ï¸ ç¡®è®¤æ¸…ç©ºé¢æ¿æ•°æ®\n\n' +
                'æ­¤æ“ä½œå°†ï¼š\n' +
                'â€¢ æ¸…ç©ºæ‰€æœ‰èŠå¤©ä¸­çš„é¢æ¿æ•°æ®\n' +
                'â€¢ ä¿ç•™é¢æ¿é…ç½®å’Œè§„åˆ™è®¾ç½®\n' +
                'â€¢ ä¿ç•™è‡ªå®šä¹‰é¢æ¿å’Œå­é¡¹å®šä¹‰\n\n' +
                'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';

            if (!confirm(confirmMessage)) {
                return;
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ¸…ç©ºé¢æ¿æ•°æ®...');

            const dataCore = this.configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore;

            if (dataCore) {
                // åªæ¸…ç©ºèŠå¤©æ•°æ®ï¼Œä¿ç•™é…ç½®
                await dataCore.clearAllData('chat');

                console.log('[InfoBarSettings] âœ… é¢æ¿æ•°æ®æ¸…ç©ºå®Œæˆ');
                this.showMessage('æ‰€æœ‰é¢æ¿æ•°æ®å·²æ¸…ç©º', 'success');
            } else {
                throw new Error('æ— æ³•è·å–æ•°æ®æ ¸å¿ƒ');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢æ¿æ•°æ®å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºé¢æ¿æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆå…¨å±€ä¸èŠå¤©èŒƒå›´ï¼‰
     */
    async clearAllCaches() {
        try {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†åˆ é™¤å…¨å±€ä¸èŠå¤©èŒƒå›´çš„ç¼“å­˜ã€‚')) {
                return;
            }

            const configManager = this.configManager || window.SillyTavernInfobar?.modules?.configManager;
            if (configManager && configManager.dataCore) {
                // æ¸…ç©ºå…¨å±€ä¸èŠå¤©æ•°æ®
                await configManager.dataCore.clearAllData('all');
                // é‡æ–°åŠ è½½é…ç½®ç¼“å­˜
                await configManager.loadAllConfigs?.();
            }

            this.showMessage('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤', 'success');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
            this.showMessage('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    // resetAllSettingsæ–¹æ³•å·²åˆ é™¤ï¼Œæ›¿æ¢ä¸ºinitializePluginå’ŒclearPanelDataæ–¹æ³•

    /**
     * å¯¼å‡ºè®¾ç½®
     */
    async exportSettings() {
        try {
            // ä¼˜å…ˆä½¿ç”¨é…ç½®ç®¡ç†å™¨å¯¼å‡º
            const exportData = await this.configManager.exportConfigs();

            // å…œåº•å¢å¼ºï¼šç¡®ä¿åŒ…å«åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ã€è‡ªå®šä¹‰é¢æ¿å®šä¹‰ï¼Œä»¥åŠå‰ç«¯æ˜¾ç¤ºé…ç½®
            try {
                const context = SillyTavern.getContext();
                const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};

                // è‡ªå®šä¹‰é¢æ¿ï¼ˆå«å­é¡¹ï¼‰
                if (extensionSettings.customPanels && !exportData.configs.customPanels) {
                    exportData.configs.customPanels = extensionSettings.customPanels;
                }

                // ğŸ”§ æ–°æ¶æ„ï¼šcustomPanelså·²åŒ…å«æ‰€æœ‰é¢æ¿é…ç½®ï¼Œæ— éœ€å•ç‹¬å¯¼å‡ºåŸºç¡€é¢æ¿
                console.log('[InfoBarSettings] ğŸ“¦ customPanelså·²åŒ…å«æ‰€æœ‰é¢æ¿é…ç½®');

                // å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼ˆå¦‚æœæœªè¢«æ”¶é›†ï¼‰
                if (!exportData.configs.frontendDisplay) {
                    const fd = await this.configManager.getFrontendDisplayConfig();
                    exportData.configs.frontendDisplay = fd;
                }
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ å¯¼å‡ºå¢å¼ºåˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°éè‡´å‘½é”™è¯¯:', e);
            }

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `info-bar-settings-${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage('è®¾ç½®å¯¼å‡ºæˆåŠŸ', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºè®¾ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºè®¾ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å‡ºè‡ªå®šä¹‰é…ç½®
     */
    async exportCustomSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¯¼å‡ºè‡ªå®šä¹‰é…ç½®...');

            // è·å–ç”¨æˆ·é€‰æ‹©çš„å¯¼å‡ºé€‰é¡¹
            const exportOptions = this.getExportOptions();
            console.log('[InfoBarSettings] ğŸ“‹ å¯¼å‡ºé€‰é¡¹:', exportOptions);

            if (!exportOptions.hasAnySelection) {
                this.showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯¼å‡ºé€‰é¡¹', 'warning');
                return;
            }

            // æ„å»ºå¯¼å‡ºæ•°æ®
            const exportData = {
                metadata: {
                    version: '1.0.0',
                    exportTime: new Date().toISOString(),
                    exportOptions: exportOptions
                },
                configs: {}
            };

            // å¯¼å‡ºé¢æ¿é…ç½®
            if (exportOptions.panelConfigs) {
                console.log('[InfoBarSettings] ğŸ“Š å¯¼å‡ºé¢æ¿é…ç½®...');
                await this.addPanelConfigsToExport(exportData);
            }

            // å¯¼å‡ºé¢æ¿è§„åˆ™
            if (exportOptions.panelRules) {
                console.log('[InfoBarSettings] ğŸ“‹ å¯¼å‡ºé¢æ¿è§„åˆ™...');
                await this.addPanelRulesToExport(exportData);
            }

            // å¯¼å‡ºå­—æ®µè§„åˆ™
            if (exportOptions.fieldRules) {
                console.log('[InfoBarSettings] ğŸ”§ å¯¼å‡ºå­—æ®µè§„åˆ™...');
                await this.addFieldRulesToExport(exportData);
            }

            // å¯¼å‡ºä¸»é¢˜è®¾ç½®
            if (exportOptions.themeSettings) {
                console.log('[InfoBarSettings] ğŸ¨ å¯¼å‡ºä¸»é¢˜è®¾ç½®...');
                await this.addThemeSettingsToExport(exportData);
            }

            // å¯¼å‡ºAPIè®¾ç½®
            if (exportOptions.apiSettings) {
                console.log('[InfoBarSettings] ğŸ”Œ å¯¼å‡ºAPIè®¾ç½®...');
                await this.addApiSettingsToExport(exportData);
            }

            // å¯¼å‡ºæ‰€æœ‰è®¾ç½®
            if (exportOptions.allSettings) {
                console.log('[InfoBarSettings] ğŸŒ å¯¼å‡ºæ‰€æœ‰è®¾ç½®...');
                await this.addAllSettingsToExport(exportData);
            }

            // ç”Ÿæˆæ–‡ä»¶å
            const selectedTypes = [];
            if (exportOptions.panelConfigs) selectedTypes.push('panels');
            if (exportOptions.panelRules) selectedTypes.push('panel-rules');
            if (exportOptions.fieldRules) selectedTypes.push('field-rules');
            if (exportOptions.themeSettings) selectedTypes.push('theme');
            if (exportOptions.apiSettings) selectedTypes.push('api');
            if (exportOptions.allSettings) selectedTypes.push('all');

            const fileName = `info-bar-${selectedTypes.join('-')}-${Date.now()}.json`;

            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage(`é…ç½®å¯¼å‡ºæˆåŠŸ: ${fileName}`, 'success');
            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é…ç½®å¯¼å‡ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºè‡ªå®šä¹‰é…ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å…¥è®¾ç½®
     */
    async importSettings() {
        try {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);

                    await this.configManager.importConfigs(importData);
                    await this.loadSettings();

                    this.showMessage('è®¾ç½®å¯¼å…¥æˆåŠŸ', 'success');

                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å¯¼å…¥è®¾ç½®å¤±è´¥:', error);
                    this.showMessage('å¯¼å…¥è®¾ç½®å¤±è´¥: ' + error.message, 'error');
                }
            };

            input.click();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å…¥è®¾ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å…¥è®¾ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†è¡¨å•å˜æ›´
     */
    handleFormChange(e) {
        try {
            // è°ƒè¯•è®¾ç½®å˜æ›´ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«åŠ¨æ€è®¾ç½®æ§åˆ¶å°è¿‡æ»¤
            if (e.target.name === 'debug.enabled' || e.target.name === 'debug.logLevel') {
                const enabled = this.modal.querySelector('[name="debug.enabled"]')?.checked;
                const level = this.modal.querySelector('[name="debug.logLevel"]').value || 'info';
                this.applyConsoleLogLevel(enabled ? level : 'none');
            }
            // ä¸»é¢˜åˆ‡æ¢ç‰¹æ®Šå¤„ç†
            if (e.target.name === 'theme.current') {
                const customGroup = this.modal.querySelector('.custom-theme-group');
                if (customGroup) {
                    customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
                }
            }

            // å®æ—¶é¢„è§ˆä¸»é¢˜å˜åŒ–
            if (e.target.name && e.target.name.startsWith('theme.custom.')) {
                this.updateThemePreview();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è¡¨å•å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°ä¸»é¢˜é¢„è§ˆ
     */
    updateThemePreview() {
        try {
            const previewBox = this.modal.querySelector('.preview-box');
            if (!previewBox) return;

            const customColors = {
                primary: this.modal.querySelector('[name="theme.custom.primary"]')?.value,
                background: this.modal.querySelector('[name="theme.custom.background"]')?.value,
                text: this.modal.querySelector('[name="theme.custom.text"]')?.value,
                border: this.modal.querySelector('[name="theme.custom.border"]')?.value
            };

            // åº”ç”¨é¢„è§ˆæ ·å¼
            previewBox.style.backgroundColor = customColors.background;
            previewBox.style.color = customColors.text;
            previewBox.style.borderColor = customColors.border;

            const previewButton = previewBox.querySelector('.preview-button');
            if (previewButton) {
                previewButton.style.backgroundColor = customColors.primary;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸»é¢˜é¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºä¸ªäººä¿¡æ¯é¢æ¿
     */
    createPersonalPanel() {
        return `
            <div class="content-header">
                <h3>ä¸ªäººä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‘¤</div>
                            <div class="card-text">
                                <div class="card-title">ä¸ªäººä¿¡æ¯</div>
                                <div class="card-subtitle">è§’è‰²è‡ªèº«çš„åŸºç¡€ä¿¡æ¯</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="personal-info-toggle" name="personal.enabled" checked />
                                <label for="personal-info-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count" id="personal-panel-count">0/0 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="name-checkbox" name="personal.name.enabled" checked />
                                <label for="name-checkbox" class="checkbox-label">å§“å</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="age-checkbox" name="personal.age.enabled" checked />
                                <label for="age-checkbox" class="checkbox-label">å¹´é¾„</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="gender-checkbox" name="personal.gender.enabled" checked />
                                <label for="gender-checkbox" class="checkbox-label">æ€§åˆ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="occupation-checkbox" name="personal.occupation.enabled" checked />
                                <label for="occupation-checkbox" class="checkbox-label">èŒä¸š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="height-checkbox" name="personal.height.enabled" />
                                <label for="height-checkbox" class="checkbox-label">èº«é«˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="weight-checkbox" name="personal.weight.enabled" />
                                <label for="weight-checkbox" class="checkbox-label">ä½“é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="blood-type-checkbox" name="personal.bloodType.enabled" />
                                <label for="blood-type-checkbox" class="checkbox-label">è¡€å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="zodiac-checkbox" name="personal.zodiac.enabled" />
                                <label for="zodiac-checkbox" class="checkbox-label">æ˜Ÿåº§</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="birthday-checkbox" name="personal.birthday.enabled" />
                                <label for="birthday-checkbox" class="checkbox-label">ç”Ÿæ—¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="birthplace-checkbox" name="personal.birthplace.enabled" />
                                <label for="birthplace-checkbox" class="checkbox-label">å‡ºç”Ÿåœ°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="nationality-checkbox" name="personal.nationality.enabled" />
                                <label for="nationality-checkbox" class="checkbox-label">å›½ç±</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="ethnicity-checkbox" name="personal.ethnicity.enabled" />
                                <label for="ethnicity-checkbox" class="checkbox-label">æ°‘æ—</label>
                            </div>
                        </div>
                    </div>

                    <!-- å¤–è§‚ç‰¹å¾ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hair-color-checkbox" name="personal.hairColor.enabled" />
                                <label for="hair-color-checkbox" class="checkbox-label">å‘è‰²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hair-style-checkbox" name="personal.hairStyle.enabled" />
                                <label for="hair-style-checkbox" class="checkbox-label">å‘å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="eye-color-checkbox" name="personal.eyeColor.enabled" />
                                <label for="eye-color-checkbox" class="checkbox-label">çœ¼è‰²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="skin-color-checkbox" name="personal.skinColor.enabled" />
                                <label for="skin-color-checkbox" class="checkbox-label">è‚¤è‰²</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="body-type-checkbox" name="personal.bodyType.enabled" />
                                <label for="body-type-checkbox" class="checkbox-label">ä½“å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="facial-features-checkbox" name="personal.facialFeatures.enabled" />
                                <label for="facial-features-checkbox" class="checkbox-label">é¢éƒ¨ç‰¹å¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="scars-checkbox" name="personal.scars.enabled" />
                                <label for="scars-checkbox" class="checkbox-label">ç–¤ç—•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tattoos-checkbox" name="personal.tattoos.enabled" />
                                <label for="tattoos-checkbox" class="checkbox-label">çº¹èº«</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="accessories-checkbox" name="personal.accessories.enabled" />
                                <label for="accessories-checkbox" class="checkbox-label">é¥°å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="clothing-style-checkbox" name="personal.clothingStyle.enabled" />
                                <label for="clothing-style-checkbox" class="checkbox-label">æœè£…é£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="appearance-checkbox" name="personal.appearance.enabled" checked />
                                <label for="appearance-checkbox" class="checkbox-label">å¤–è§‚æè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="voice-checkbox" name="personal.voice.enabled" />
                                <label for="voice-checkbox" class="checkbox-label">å£°éŸ³ç‰¹å¾</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ€§æ ¼ç‰¹è´¨ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="personality-checkbox" name="personal.personality.enabled" checked />
                                <label for="personality-checkbox" class="checkbox-label">æ€§æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="temperament-checkbox" name="personal.temperament.enabled" />
                                <label for="temperament-checkbox" class="checkbox-label">æ°”è´¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="attitude-checkbox" name="personal.attitude.enabled" />
                                <label for="attitude-checkbox" class="checkbox-label">æ€åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="values-checkbox" name="personal.values.enabled" />
                                <label for="values-checkbox" class="checkbox-label">ä»·å€¼è§‚</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="beliefs-checkbox" name="personal.beliefs.enabled" />
                                <label for="beliefs-checkbox" class="checkbox-label">ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fears-checkbox" name="personal.fears.enabled" />
                                <label for="fears-checkbox" class="checkbox-label">ææƒ§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="dreams-checkbox" name="personal.dreams.enabled" />
                                <label for="dreams-checkbox" class="checkbox-label">æ¢¦æƒ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="goals-checkbox" name="personal.goals.enabled" />
                                <label for="goals-checkbox" class="checkbox-label">ç›®æ ‡</label>
                            </div>
                        </div>
                    </div>

                    <!-- èƒ½åŠ›å±æ€§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="intelligence-checkbox" name="personal.intelligence.enabled" />
                                <label for="intelligence-checkbox" class="checkbox-label">æ™ºåŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="strength-checkbox" name="personal.strength.enabled" />
                                <label for="strength-checkbox" class="checkbox-label">ä½“åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="charisma-checkbox" name="personal.charisma.enabled" />
                                <label for="charisma-checkbox" class="checkbox-label">é­…åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="luck-checkbox" name="personal.luck.enabled" />
                                <label for="luck-checkbox" class="checkbox-label">è¿æ°”</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="perception-checkbox" name="personal.perception.enabled" />
                                <label for="perception-checkbox" class="checkbox-label">æ„ŸçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="willpower-checkbox" name="personal.willpower.enabled" />
                                <label for="willpower-checkbox" class="checkbox-label">æ„å¿—åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="reaction-speed-checkbox" name="personal.reactionSpeed.enabled" />
                                <label for="reaction-speed-checkbox" class="checkbox-label">ååº”é€Ÿåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="learning-ability-checkbox" name="personal.learningAbility.enabled" />
                                <label for="learning-ability-checkbox" class="checkbox-label">å­¦ä¹ èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾ä¼šå…³ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="family-background-checkbox" name="personal.familyBackground.enabled" />
                                <label for="family-background-checkbox" class="checkbox-label">å®¶åº­èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="education-checkbox" name="personal.education.enabled" />
                                <label for="education-checkbox" class="checkbox-label">æ•™è‚²ç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="work-experience-checkbox" name="personal.workExperience.enabled" />
                                <label for="work-experience-checkbox" class="checkbox-label">å·¥ä½œç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="income-checkbox" name="personal.income.enabled" />
                                <label for="income-checkbox" class="checkbox-label">æ”¶å…¥</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="social-status-checkbox" name="personal.socialStatus.enabled" />
                                <label for="social-status-checkbox" class="checkbox-label">ç¤¾ä¼šåœ°ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="relationships-checkbox" name="personal.relationships.enabled" />
                                <label for="relationships-checkbox" class="checkbox-label">äººé™…å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="love-status-checkbox" name="personal.loveStatus.enabled" />
                                <label for="love-status-checkbox" class="checkbox-label">æ‹çˆ±çŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="marital-status-checkbox" name="personal.maritalStatus.enabled" />
                                <label for="marital-status-checkbox" class="checkbox-label">å©šå§»çŠ¶æ€</label>
                            </div>
                        </div>
                    </div>
                    <!-- å…´è¶£çˆ±å¥½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hobbies-checkbox" name="personal.hobbies.enabled" />
                                <label for="hobbies-checkbox" class="checkbox-label">å…´è¶£çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="sports-checkbox" name="personal.sports.enabled" />
                                <label for="sports-checkbox" class="checkbox-label">è¿åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="music-checkbox" name="personal.music.enabled" />
                                <label for="music-checkbox" class="checkbox-label">éŸ³ä¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="art-checkbox" name="personal.art.enabled" />
                                <label for="art-checkbox" class="checkbox-label">è‰ºæœ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="reading-checkbox" name="personal.reading.enabled" />
                                <label for="reading-checkbox" class="checkbox-label">é˜…è¯»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="gaming-checkbox" name="personal.gaming.enabled" />
                                <label for="gaming-checkbox" class="checkbox-label">æ¸¸æˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="travel-checkbox" name="personal.travel.enabled" />
                                <label for="travel-checkbox" class="checkbox-label">æ—…è¡Œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cooking-checkbox" name="personal.cooking.enabled" />
                                <label for="cooking-checkbox" class="checkbox-label">çƒ¹é¥ª</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="skills-checkbox" name="personal.skills.enabled" />
                                <label for="skills-checkbox" class="checkbox-label">æŠ€èƒ½ç‰¹é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="languages-checkbox" name="personal.languages.enabled" />
                                <label for="languages-checkbox" class="checkbox-label">è¯­è¨€èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="habits-checkbox" name="personal.habits.enabled" />
                                <label for="habits-checkbox" class="checkbox-label">ç”Ÿæ´»ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="health-status-checkbox" name="personal.healthStatus.enabled" />
                                <label for="health-status-checkbox" class="checkbox-label">å¥åº·çŠ¶æ€</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="action-buttons">
                    <button class="btn-action btn-all">å…¨é€‰</button>
                    <button class="btn-action btn-none">å…¨ä¸é€‰</button>
                    <button class="btn-action btn-basic">åŸºç¡€ä¿¡æ¯</button>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºäº¤äº’å¯¹è±¡é¢æ¿
     */
    createInteractionPanel() {
        return `
            <div class="content-header">
                <h3>äº¤äº’å¯¹è±¡é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- äº¤äº’å¯¹è±¡å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‘¥</div>
                            <div class="card-text">
                                <div class="card-title">äº¤äº’å¯¹è±¡</div>
                                <div class="card-subtitle">è§’è‰²äº¤äº’å’Œå…³ç³»ç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="interaction-toggle" name="interaction.enabled" checked />
                                <label for="interaction-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count" id="interaction-panel-count">0/0 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-name-checkbox" name="interaction.name.enabled" checked />
                                <label for="interaction-name-checkbox" class="checkbox-label">å¯¹è±¡åç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-type-checkbox" name="interaction.type.enabled" checked />
                                <label for="interaction-type-checkbox" class="checkbox-label">å¯¹è±¡ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-status-checkbox" name="interaction.status.enabled" checked />
                                <label for="interaction-status-checkbox" class="checkbox-label">åœ¨çº¿çŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-location-checkbox" name="interaction.location.enabled" />
                                <label for="interaction-location-checkbox" class="checkbox-label">æ‰€åœ¨ä½ç½®</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-mood-checkbox" name="interaction.mood.enabled" />
                                <label for="interaction-mood-checkbox" class="checkbox-label">æƒ…ç»ªçŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-activity-checkbox" name="interaction.activity.enabled" />
                                <label for="interaction-activity-checkbox" class="checkbox-label">å½“å‰æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-availability-checkbox" name="interaction.availability.enabled" />
                                <label for="interaction-availability-checkbox" class="checkbox-label">å¯ç”¨æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-priority-checkbox" name="interaction.priority.enabled" />
                                <label for="interaction-priority-checkbox" class="checkbox-label">ä¼˜å…ˆçº§</label>
                            </div>
                        </div>
                    </div>

                    <!-- å…³ç³»ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-relationship-checkbox" name="interaction.relationship.enabled" checked />
                                <label for="interaction-relationship-checkbox" class="checkbox-label">å…³ç³»ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-intimacy-checkbox" name="interaction.intimacy.enabled" checked />
                                <label for="interaction-intimacy-checkbox" class="checkbox-label">äº²å¯†åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-trust-checkbox" name="interaction.trust.enabled" />
                                <label for="interaction-trust-checkbox" class="checkbox-label">ä¿¡ä»»åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-friendship-checkbox" name="interaction.friendship.enabled" />
                                <label for="interaction-friendship-checkbox" class="checkbox-label">å‹å¥½åº¦</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-romance-checkbox" name="interaction.romance.enabled" />
                                <label for="interaction-romance-checkbox" class="checkbox-label">æµªæ¼«åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-respect-checkbox" name="interaction.respect.enabled" />
                                <label for="interaction-respect-checkbox" class="checkbox-label">å°Šé‡åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-dependency-checkbox" name="interaction.dependency.enabled" />
                                <label for="interaction-dependency-checkbox" class="checkbox-label">ä¾èµ–åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-conflict-checkbox" name="interaction.conflict.enabled" />
                                <label for="interaction-conflict-checkbox" class="checkbox-label">å†²çªåº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’å†å² -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-history-checkbox" name="interaction.history.enabled" checked />
                                <label for="interaction-history-checkbox" class="checkbox-label">äº¤äº’å†å²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-frequency-checkbox" name="interaction.frequency.enabled" />
                                <label for="interaction-frequency-checkbox" class="checkbox-label">äº¤äº’é¢‘ç‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-duration-checkbox" name="interaction.duration.enabled" />
                                <label for="interaction-duration-checkbox" class="checkbox-label">äº¤äº’æ—¶é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-quality-checkbox" name="interaction.quality.enabled" />
                                <label for="interaction-quality-checkbox" class="checkbox-label">äº¤äº’è´¨é‡</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-topics-checkbox" name="interaction.topics.enabled" />
                                <label for="interaction-topics-checkbox" class="checkbox-label">è¯é¢˜è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-emotions-checkbox" name="interaction.emotions.enabled" />
                                <label for="interaction-emotions-checkbox" class="checkbox-label">æƒ…æ„Ÿå˜åŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-milestones-checkbox" name="interaction.milestones.enabled" />
                                <label for="interaction-milestones-checkbox" class="checkbox-label">é‡è¦èŠ‚ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-memories-checkbox" name="interaction.memories.enabled" />
                                <label for="interaction-memories-checkbox" class="checkbox-label">å…±åŒå›å¿†</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’è®¾ç½® -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-auto-record-checkbox" name="interaction.autoRecord.enabled" checked />
                                <label for="interaction-auto-record-checkbox" class="checkbox-label">è‡ªåŠ¨è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-notifications-checkbox" name="interaction.notifications.enabled" />
                                <label for="interaction-notifications-checkbox" class="checkbox-label">äº¤äº’é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-analysis-checkbox" name="interaction.analysis.enabled" />
                                <label for="interaction-analysis-checkbox" class="checkbox-label">è¡Œä¸ºåˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-suggestions-checkbox" name="interaction.suggestions.enabled" />
                                <label for="interaction-suggestions-checkbox" class="checkbox-label">å»ºè®®æç¤º</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾äº¤ç½‘ç»œ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-network-checkbox" name="interaction.network.enabled" />
                                <label for="interaction-network-checkbox" class="checkbox-label">ç¤¾äº¤ç½‘ç»œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-groups-checkbox" name="interaction.groups.enabled" />
                                <label for="interaction-groups-checkbox" class="checkbox-label">ç¾¤ç»„å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-influence-checkbox" name="interaction.influence.enabled" />
                                <label for="interaction-influence-checkbox" class="checkbox-label">å½±å“åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-reputation-checkbox" name="interaction.reputation.enabled" />
                                <label for="interaction-reputation-checkbox" class="checkbox-label">å£°èª‰</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-alliances-checkbox" name="interaction.alliances.enabled" />
                                <label for="interaction-alliances-checkbox" class="checkbox-label">è”ç›Ÿå…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-rivalries-checkbox" name="interaction.rivalries.enabled" />
                                <label for="interaction-rivalries-checkbox" class="checkbox-label">ç«äº‰å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-mentorship-checkbox" name="interaction.mentorship.enabled" />
                                <label for="interaction-mentorship-checkbox" class="checkbox-label">å¸ˆå¾’å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-hierarchy-checkbox" name="interaction.hierarchy.enabled" />
                                <label for="interaction-hierarchy-checkbox" class="checkbox-label">ç­‰çº§å…³ç³»</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’åå¥½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-communication-style-checkbox" name="interaction.communicationStyle.enabled" />
                                <label for="interaction-communication-style-checkbox" class="checkbox-label">æ²Ÿé€šé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-preferred-topics-checkbox" name="interaction.preferredTopics.enabled" />
                                <label for="interaction-preferred-topics-checkbox" class="checkbox-label">åå¥½è¯é¢˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-avoided-topics-checkbox" name="interaction.avoidedTopics.enabled" />
                                <label for="interaction-avoided-topics-checkbox" class="checkbox-label">é¿å…è¯é¢˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-boundaries-checkbox" name="interaction.boundaries.enabled" />
                                <label for="interaction-boundaries-checkbox" class="checkbox-label">äº¤äº’è¾¹ç•Œ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-comfort-level-checkbox" name="interaction.comfortLevel.enabled" />
                                <label for="interaction-comfort-level-checkbox" class="checkbox-label">èˆ’é€‚åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-energy-level-checkbox" name="interaction.energyLevel.enabled" />
                                <label for="interaction-energy-level-checkbox" class="checkbox-label">æ´»è·ƒåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-response-time-checkbox" name="interaction.responseTime.enabled" />
                                <label for="interaction-response-time-checkbox" class="checkbox-label">å“åº”æ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-engagement-checkbox" name="interaction.engagement.enabled" />
                                <label for="interaction-engagement-checkbox" class="checkbox-label">å‚ä¸åº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰¹æ®ŠçŠ¶æ€ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-special-events-checkbox" name="interaction.specialEvents.enabled" />
                                <label for="interaction-special-events-checkbox" class="checkbox-label">ç‰¹æ®Šäº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-achievements-checkbox" name="interaction.achievements.enabled" />
                                <label for="interaction-achievements-checkbox" class="checkbox-label">æˆå°±è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-challenges-checkbox" name="interaction.challenges.enabled" />
                                <label for="interaction-challenges-checkbox" class="checkbox-label">æŒ‘æˆ˜è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-growth-checkbox" name="interaction.growth.enabled" />
                                <label for="interaction-growth-checkbox" class="checkbox-label">æˆé•¿è½¨è¿¹</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºNPCç®¡ç†é¢æ¿
     */
    createNPCManagementPanel() {
        return `
            <div class="content-header">
                <h3>NPCæ•°æ®åº“ç®¡ç†</h3>
                <p class="content-description">ç®¡ç†å½“å‰èŠå¤©ä¸­çš„NPCæ•°æ®ï¼Œæ”¯æŒæ•°æ®åŒæ­¥å’Œä¸–ç•Œä¹¦é›†æˆ</p>
            </div>

            <!-- ğŸ†• NPCç®¡ç†æ¨¡å¼åˆ‡æ¢ -->
            <div class="settings-group">
                <h4>NPCæ•°æ®ç®¡ç†æ¨¡å¼</h4>
                <div class="form-group">
                    <div class="npc-mode-tabs" style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="npc-mode-tab active" data-mode="panel" style="
                            flex: 1;
                            padding: 10px 16px;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: 1px solid var(--theme-primary-color, #4CAF50);
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            ğŸ“Š é¢æ¿æ¨¡å¼
                        </button>
                        <button type="button" class="npc-mode-tab" data-mode="ai" style="
                            flex: 1;
                            padding: 10px 16px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            color: var(--theme-text-primary, #e0e0e0);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            ğŸ¤– AIæ¨¡å¼
                        </button>
                    </div>
                    <small>é¢æ¿æ¨¡å¼ï¼šä»interactioné¢æ¿è·å–NPCæ•°æ® | AIæ¨¡å¼ï¼šè°ƒç”¨è‡ªå®šä¹‰APIæ™ºèƒ½æå–NPCæ•°æ®</small>
                </div>
            </div>

            <!-- é¢æ¿æ¨¡å¼è®¾ç½®åŒºåŸŸ -->
            <div class="npc-panel-mode-settings">
                <div class="settings-group">
                    <h4>å¯ç”¨NPCæ•°æ®åº“ç®¡ç†</h4>
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="npc-auto-sync-enabled" ${this.getNPCAutoSyncEnabled() ? 'checked' : ''}>
                        <label for="npc-auto-sync-enabled" class="checkbox-label">è‡ªåŠ¨åŒæ­¥NPCæ•°æ®</label>
                    </div>
                    <small>å½“æ£€æµ‹åˆ°äº¤äº’å¯¹è±¡é¢æ¿æ•°æ®æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°NPCæ•°æ®åº“</small>
                </div>
            </div>

            <div class="settings-group">
                    <h4>NPCæ•°æ®è·å–é¢æ¿</h4>
                <div class="form-group">
                    <label>é€‰æ‹©NPCæ•°æ®æ¥æºé¢æ¿</label>
                    <select id="npc-source-panel-select" class="setting-select" style="width: 100%; padding: 8px; border-radius: 4px;">
                        <option value="interaction">äº¤äº’å¯¹è±¡é¢æ¿ï¼ˆé»˜è®¤ï¼‰</option>
                        <!-- åŠ¨æ€é¢æ¿é€‰é¡¹å°†åœ¨åˆå§‹åŒ–æ—¶æ·»åŠ  -->
                    </select>
                    <small>é€‰æ‹©ä»å“ªä¸ªé¢æ¿è·å–NPCæ•°æ®ã€‚é»˜è®¤ä»äº¤äº’å¯¹è±¡é¢æ¿è·å–ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå®šä¹‰é¢æ¿</small>
                    </div>
                </div>
            </div>

            <!-- ğŸ†• AIæ¨¡å¼è®¾ç½®åŒºåŸŸ -->
            <div class="npc-ai-mode-settings" style="display: none;">
            <div class="settings-group">
                    <h4>AIæ¨¡å¼è®¾ç½®</h4>
                    
                    <!-- ğŸ†• NPCä¿¡æ¯æ¨¡æ¿ -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="margin: 0;">NPCä¿¡æ¯æ¨¡æ¿</label>
                            <button type="button" id="npc-edit-template-btn" class="btn btn-small" style="
                                padding: 6px 12px;
                                font-size: 12px;
                                background: var(--theme-accent-color, #4CAF50);
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='var(--theme-accent-color, #4CAF50)'">
                                ğŸ“ ç¼–è¾‘æ¨¡æ¿
                            </button>
                        </div>
                        <small>å®šä¹‰NPCä¿¡æ¯çš„æ ‡å‡†å­—æ®µï¼ŒAIå°†æ ¹æ®æ­¤æ¨¡æ¿ç”Ÿæˆå’Œæ›´æ–°NPCæ•°æ®</small>
                    </div>
                    
                    <!-- ğŸ†• è·¯äººè§’è‰²è¿‡æ»¤ -->
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="npc-ai-filter-minor-roles" checked>
                            <label for="npc-ai-filter-minor-roles" class="checkbox-label">è¿‡æ»¤è·¯äººè§’è‰²</label>
                        </div>
                        <small>å¯ç”¨åï¼ŒAIå°†è‡ªåŠ¨è¿‡æ»¤æ— å…³ç´§è¦çš„è·¯äººè§’è‰²ï¼ˆå¦‚ï¼šæ¸…æ´å·¥ã€ç”²ä¹™ä¸™ã€è·¯äººç­‰ï¼‰</small>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="npc-ai-use-regex" checked>
                            <label for="npc-ai-use-regex" class="checkbox-label">ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤</label>
                        </div>
                        <small>å¯ç”¨åï¼Œåœ¨è·å–æ¶ˆæ¯æ—¶åº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ ‡ç­¾å†…å®¹ï¼ˆé»˜è®¤å¯ç”¨ï¼‰</small>
                    </div>
                    
                    <div class="form-group">
                        <label>æ•°æ®æ›´æ–°æ¥¼å±‚</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="npc-ai-update-floor" min="5" max="100" value="20" style="
                                flex: 1;
                                padding: 8px 12px;
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                background: var(--theme-bg-primary, #1a1a1a);
                                color: var(--theme-text-primary, #e0e0e0);
                            ">
                            <span style="color: var(--theme-text-secondary, #888);">æ¡æ¶ˆæ¯</span>
                        </div>
                        <small>æ¯éš”å¤šå°‘æ¡æ¶ˆæ¯è‡ªåŠ¨è°ƒç”¨AIæ›´æ–°NPCæ•°æ®</small>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="npc-ai-update-now-btn" class="btn btn-primary" style="
                            width: 100%;
                            padding: 10px 16px;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='var(--theme-primary-color, #4CAF50)'">
                            ğŸ¤– ç«‹å³æ›´æ–°NPCæ•°æ®
                        </button>
                        <small>æ‰‹åŠ¨è§¦å‘AIåˆ†æå¹¶æ›´æ–°NPCæ•°æ®</small>
                    </div>
                    
                    <!-- ğŸ†• å˜æ›´çŠ¶æ€æ˜¾ç¤ºæ  -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="margin: 0; color: var(--theme-text-primary, #e0e0e0);">ğŸ“Š å˜æ›´çŠ¶æ€</h5>
                            <button type="button" id="npc-clear-change-log-btn" class="btn btn-small" style="
                                padding: 4px 10px;
                                font-size: 12px;
                                background: var(--theme-bg-secondary, #2a2a2a);
                                color: var(--theme-text-secondary, #888);
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                cursor: pointer;
                            " onmouseover="this.style.color='var(--theme-text-primary, #e0e0e0)'" onmouseout="this.style.color='var(--theme-text-secondary, #888)'">
                                ğŸ—‘ï¸ æ¸…é™¤
                            </button>
                        </div>
                        <div id="npc-change-log" style="
                            max-height: 200px;
                            overflow-y: auto;
                            padding: 12px;
                            background: var(--theme-bg-primary, #1a1a1a);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                            font-size: 13px;
                            color: var(--theme-text-secondary, #888);
                            -webkit-overflow-scrolling: touch;
                        ">
                            <div class="npc-change-empty">æš‚æ— å˜æ›´è®°å½•</div>
                        </div>
                        <small>æ˜¾ç¤ºæœ€è¿‘çš„NPCæ•°æ®å˜æ›´è®°å½•ï¼ˆæœ€å¤š50æ¡ï¼‰</small>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4>ä¸–ç•Œä¹¦åŒæ­¥</h4>
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="npc-worldbook-sync-enabled" ${this.getNPCWorldBookSyncEnabled() ? 'checked' : ''}>
                        <label for="npc-worldbook-sync-enabled" class="checkbox-label">å¯ç”¨ä¸–ç•Œä¹¦åŒæ­¥</label>
                    </div>
                    <small>è‡ªåŠ¨å°†NPCæ•°æ®åŒæ­¥åˆ°ä¸–ç•Œä¹¦ä¸­ï¼Œä¾¿äºAIè®°å¿†å’Œå¼•ç”¨</small>
                </div>
                
                <div class="form-group">
                    <label>NPCæ•°æ®ä¸–ç•Œä¹¦</label>
                    <select id="npc-target-worldbook-select" class="setting-select" style="width: 100%; padding: 8px; border-radius: 4px;">
                        <option value="auto">è§’è‰²é“¾æ¥çš„ä¸»è¦ä¸–ç•Œä¹¦ï¼ˆé»˜è®¤ï¼‰</option>
                        <!-- åŠ¨æ€ä¸–ç•Œä¹¦é€‰é¡¹å°†åœ¨åˆå§‹åŒ–æ—¶æ·»åŠ  -->
                    </select>
                    <small>é€‰æ‹©åŒæ­¥NPCæ•°æ®çš„ç›®æ ‡ä¸–ç•Œä¹¦ã€‚é»˜è®¤ä½¿ç”¨è§’è‰²é“¾æ¥çš„ä¸»è¦ä¸–ç•Œä¹¦</small>
                </div>
            </div>

            <div class="settings-group npc-panel-mode-settings">
                <h4>æ‰‹åŠ¨æ“ä½œ</h4>
                <div class="form-group">
                    <div class="button-group" style="display: flex; gap: 10px;">
                        <button type="button" id="npc-sync-now-btn" class="btn btn-sm" style="
                            flex: 1;
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                            border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                            padding: 8px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff))'" onmouseout="this.style.background='var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a))'">
                            ğŸ”„ ç«‹å³åŒæ­¥NPCæ•°æ®
                        </button>
                        <button type="button" id="npc-worldbook-sync-now-btn" class="btn btn-sm" style="
                            flex: 1;
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                            border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                            padding: 8px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='var(--theme-success-color, var(--SmartThemeQuoteColor, #28a745))'" onmouseout="this.style.background='var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a))'">
                            ğŸŒ åŒæ­¥åˆ°ä¸–ç•Œä¹¦
                        </button>
                    </div>
                    <small>æ‰‹åŠ¨æ‰§è¡Œæ•°æ®åŒæ­¥æ“ä½œ</small>
                </div>
            </div>

            <div class="settings-group">
                <h4>NPCåˆ—è¡¨</h4>
                <div class="npc-list-container">
                    <div class="npc-search-bar" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                        <input type="text" id="npc-search-input" placeholder="æœç´¢NPC..." class="form-control" style="flex: 1;">
                        <!-- ğŸ†• AIæ¨¡å¼ä¸‹æ˜¾ç¤ºæ–°å¢NPCæŒ‰é’® -->
                        <button type="button" id="npc-add-new-btn" class="btn npc-ai-mode-only" style="
                            display: none;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='var(--theme-primary-color, #4CAF50)'">
                            â• æ–°å¢NPC
                        </button>
                        <button type="button" id="npc-refresh-btn" class="btn" style="
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                            border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                            padding: 8px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='var(--theme-bg-hover, var(--SmartThemeQuoteColor, #333))'" onmouseout="this.style.background='var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a))'">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    
                    <!-- ğŸ†• æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                    <div class="npc-batch-toolbar" style="
                        display: flex;
                        gap: 8px;
                        align-items: center;
                        padding: 8px;
                        margin-top: 8px;
                        background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #1a1a1a));
                        border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                        border-radius: 4px;
                    ">
                        <button 
                            type="button"
                            id="npc-select-all-btn" 
                            class="btn btn-sm"
                            style="
                                padding: 4px 8px;
                                font-size: 12px;
                                background: var(--theme-bg-primary, var(--SmartThemeBodyColor, #2a2a2a));
                                color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                                border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.background='var(--theme-bg-hover, var(--SmartThemeQuoteColor, #333))'"
                            onmouseout="this.style.background='var(--theme-bg-primary, var(--SmartThemeBodyColor, #2a2a2a))'"
                        >
                            <span class="select-all-icon">â˜</span> å…¨é€‰
                        </button>
                        <div class="npc-selected-count" style="
                            flex: 1;
                            font-size: 12px;
                            color: var(--theme-text-secondary, var(--SmartThemeTextColor, #999));
                        ">
                            å·²é€‰ä¸­ <span class="npc-count-number">0</span> ä¸ª
                        </div>
                        <button
                            type="button"
                            id="npc-merge-btn"
                            class="btn btn-sm"
                            disabled
                            style="
                                padding: 4px 8px;
                                font-size: 12px;
                                background: var(--theme-primary-color, #4CAF50);
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                opacity: 0.5;
                                margin-right: 8px;
                            "
                        >
                            ğŸ”€ åˆå¹¶è§’è‰²
                        </button>
                        <button
                            type="button"
                            id="npc-batch-delete-btn"
                            class="btn btn-sm"
                            disabled
                            style="
                                padding: 4px 8px;
                                font-size: 12px;
                                background: var(--theme-bg-danger, #dc3545);
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                opacity: 0.5;
                            "
                        >
                            ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                        </button>
                    </div>
                    
                    <div id="npc-cards-container" class="npc-cards-grid">
                        <!-- NPCå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        <div class="npc-loading">æ­£åœ¨åŠ è½½NPCæ•°æ®...</div>
                    </div>
                </div>
            </div>

            <!-- NPCè¯¦æƒ…æ¨¡æ€æ¡† -->
            <div id="npc-detail-modal" class="npc-detail-modal" style="display: none;">
                <div class="npc-detail-content">
                    <div class="npc-detail-header">
                        <h3 id="npc-detail-name">NPCè¯¦æƒ…</h3>
                        <button class="npc-detail-close">&times;</button>
                    </div>
                    <div class="npc-detail-body">
                        <div id="npc-detail-info">
                            <!-- NPCè¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå‰§æƒ…ä¼˜åŒ–é¢æ¿
     */
    createPlotOptimizationPanel() {
        const config = this.getPlotOptimizationConfig();

        return `
            <div class="content-header">
                <h3>å‰§æƒ…ä¼˜åŒ–ç³»ç»Ÿ</h3>
                <p class="content-description">ä½¿ç”¨é€šç”¨APIå¯¹å‰§æƒ…è¿›è¡Œä¼˜åŒ–å»ºè®®ï¼Œä»¥å°è¯´å¹³å°ç¼–è¾‘"Guhan 3å·"çš„èº«ä»½æå‡AIç”Ÿæˆå†…å®¹çš„è´¨é‡</p>
            </div>

            <!-- å¯ç”¨å‰§æƒ…ä¼˜åŒ– -->
            <div class="settings-group">
                <h4>åŸºç¡€è®¾ç½®</h4>
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="plot-optimization-enabled" ${config.enabled ? 'checked' : ''}>
                        <label for="plot-optimization-enabled" class="checkbox-label">å¯ç”¨å‰§æƒ…ä¼˜åŒ–</label>
                    </div>
                    <small>å¯ç”¨åï¼Œæ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶ä¼šå…ˆè°ƒç”¨é€šç”¨APIè·å–å‰§æƒ…ä¼˜åŒ–å»ºè®®ï¼ˆä½¿ç”¨APIé…ç½®é¢æ¿ä¸­çš„é€šç”¨APIï¼‰</small>

                    <!-- ğŸ”§ æ–°å¢ï¼š502è¶…æ—¶é£é™©æç¤º -->
                    <div style="
                        margin-top: 12px;
                        padding: 12px;
                        background: rgba(255, 152, 0, 0.1);
                        border-left: 4px solid #ff9800;
                        border-radius: 4px;
                        color: var(--theme-text-primary, #ddd);
                    ">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">âš ï¸</span>
                            <strong style="color: #ff9800;">é‡è¦æç¤º</strong>
                        </div>
                        <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                            æœ¬åŠŸèƒ½å¯èƒ½ä¼šå¯¼è‡´SillyTavernå‡ºç°502ç­‰å¾…è¶…æ—¶æŠ¥é”™ï¼Œå¦‚æœæŠ¥é”™ï¼Œè¯·é‡æ–°å‘é€æ¶ˆæ¯ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <!-- æ•…äº‹è®¾å®š -->
            <div class="settings-group">
                <h4>æ•…äº‹è®¾å®š</h4>

                <div class="form-group">
                    <label>æ•…äº‹ä¸»é¢˜</label>
                    <input type="text" id="plot-optimization-story-theme" class="setting-input"
                           value="${config.storyTheme || ''}"
                           placeholder="ä¾‹å¦‚ï¼šç§‘å¹»ã€å¥‡å¹»ã€ç°ä»£éƒ½å¸‚ã€å†å²æ¶ç©ºç­‰">
                    <small>å®šä¹‰æ•…äº‹çš„æ ¸å¿ƒä¸»é¢˜å’ŒèƒŒæ™¯</small>
                </div>

                <div class="form-group">
                    <label>æ•…äº‹ç±»å‹</label>
                    <input type="text" id="plot-optimization-story-type" class="setting-input"
                           value="${config.storyType || ''}"
                           placeholder="ä¾‹å¦‚ï¼šå†’é™©ã€çˆ±æƒ…ã€æ‚¬ç–‘ã€æˆ˜äº‰ç­‰">
                    <small>æ•…äº‹çš„ä¸»è¦ç±»å‹å’Œé£æ ¼</small>
                </div>

                <div class="form-group">
                    <label>å‚è€ƒä½œå“</label>
                    <input type="text" id="plot-optimization-reference-works" class="setting-input"
                           value="${config.referenceWorks || ''}"
                           placeholder="ä¾‹å¦‚ï¼šã€Šä¸‰ä½“ã€‹ã€ã€Šå†°ä¸ç«ä¹‹æ­Œã€‹ç­‰">
                    <small>å¯ä»¥å‚è€ƒçš„ä¼˜ç§€ä½œå“ï¼ˆå¯é€‰ï¼‰</small>
                </div>

                <div class="form-group">
                    <label>å­—æ•°è¦æ±‚</label>
                    <input type="text" id="plot-optimization-word-count" class="setting-input"
                           value="${config.wordCountRequirement || ''}"
                           placeholder="ä¾‹å¦‚ï¼šæ¯ç« 3000-5000å­—">
                    <small>æ¯æ¬¡ç”Ÿæˆçš„å­—æ•°è¦æ±‚</small>
                </div>
            </div>

            <!-- å‰§æƒ…å¼ºåº¦å‚æ•° -->
            <div class="settings-group">
                <h4>å‰§æƒ…å¼ºåº¦å‚æ•°</h4>
                <small style="display: block; margin-bottom: 12px; color: var(--theme-text-secondary, #888);">
                    è°ƒæ•´å„é¡¹å‰§æƒ…å…ƒç´ çš„å¼ºåº¦ï¼ˆ1-10ï¼‰ï¼Œæ•°å€¼è¶Šå¤§å¼ºåº¦è¶Šé«˜
                </small>

                <div class="form-group">
                    <label>å‰§æƒ…æ¨è¿›å¼ºåº¦: <span id="plot-progress-value">${config.plotProgressIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-progress-intensity" class="setting-range"
                           value="${config.plotProgressIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-progress-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…å†²çªå¼ºåº¦: <span id="plot-conflict-value">${config.plotConflictIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-conflict-intensity" class="setting-range"
                           value="${config.plotConflictIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-conflict-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…æ‚¬å¿µå¼ºåº¦: <span id="plot-suspense-value">${config.plotSuspenseIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-suspense-intensity" class="setting-range"
                           value="${config.plotSuspenseIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-suspense-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…åè½¬å¼ºåº¦: <span id="plot-twist-value">${config.plotTwistIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-twist-intensity" class="setting-range"
                           value="${config.plotTwistIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-twist-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…é«˜æ½®å¼ºåº¦: <span id="plot-climax-value">${config.plotClimaxIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-climax-intensity" class="setting-range"
                           value="${config.plotClimaxIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-climax-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…ä½è°·å¼ºåº¦: <span id="plot-low-value">${config.plotLowIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-low-intensity" class="setting-range"
                           value="${config.plotLowIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-low-value').textContent = this.value">
                </div>

                <div class="form-group">
                    <label>å‰§æƒ…è½¬æŠ˜å¼ºåº¦: <span id="plot-turn-value">${config.plotTurnIntensity || 5}</span>/10</label>
                    <input type="range" id="plot-optimization-turn-intensity" class="setting-range"
                           value="${config.plotTurnIntensity || 5}" min="1" max="10"
                           oninput="document.getElementById('plot-turn-value').textContent = this.value">
                </div>
            </div>

            <!-- ğŸ†• ä½œå®¶æ–‡é£æ¨¡ä»¿ -->
            <div class="settings-group">
                <h4>ğŸ“š ä½œå®¶æ–‡é£æ¨¡ä»¿</h4>
                <small style="display: block; margin-bottom: 12px; color: var(--theme-text-secondary, #888);">
                    å¯ç”¨åï¼ŒGuhan 3å·ä¼šå‚è€ƒæŒ‡å®šä½œå®¶çš„å†™ä½œé£æ ¼å’ŒæŠ€å·§ï¼Œä¸ºä½ æä¾›æ›´å…·é’ˆå¯¹æ€§çš„å‰§æƒ…ä¼˜åŒ–å»ºè®®
                </small>

                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="plot-optimization-imitate-author-enabled" ${config.imitateAuthorEnabled ? 'checked' : ''}>
                        <label for="plot-optimization-imitate-author-enabled" class="checkbox-label">å¯ç”¨ä½œå®¶æ–‡é£æ¨¡ä»¿</label>
                    </div>
                    <small>å¯ç”¨åï¼Œç³»ç»Ÿä¼šåˆ†æç›®æ ‡ä½œå®¶çš„å†™ä½œæ‰‹æ³•ï¼Œå¹¶åœ¨å‰§æƒ…ä¼˜åŒ–æ—¶æä¾›æ¨¡ä»¿æŒ‡å¯¼</small>
                </div>

                <div class="form-group" id="author-imitate-options" style="display: ${config.imitateAuthorEnabled ? 'block' : 'none'};">
                    <label>ç›®æ ‡ä½œå®¶</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" id="plot-optimization-target-author" class="setting-input" 
                               value="${config.targetAuthor || ''}" 
                               placeholder="è¾“å…¥ä½œå®¶åç§°ï¼Œä¾‹å¦‚ï¼šå¤©èš•åœŸè±†"
                               list="known-authors-list"
                               style="flex: 1;">
                        <button type="button" id="analyze-author-btn" class="btn btn-secondary" style="
                            padding: 8px 16px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            color: var(--theme-text-primary, #ddd);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 4px;
                            cursor: pointer;
                            white-space: nowrap;
                        ">ğŸ” åˆ†æ</button>
                    </div>
                    
                    <!-- çŸ¥åä½œå®¶æ•°æ®åˆ—è¡¨ -->
                    <datalist id="known-authors-list">
                        <option value="å¤©èš•åœŸè±†">
                        <option value="è¾°ä¸œ">
                        <option value="çŒ«è…»">
                        <option value="çƒ½ç«æˆè¯¸ä¾¯">
                        <option value="çˆ±æ½œæ°´çš„ä¹Œè´¼">
                        <option value="è€³æ ¹">
                        <option value="å¿˜è¯­">
                    </datalist>
                    
                    <small>
                        ğŸ’¡ æç¤ºï¼šç³»ç»Ÿå†…ç½®äº†ä»¥ä¸‹çŸ¥åä½œå®¶çš„æ–‡é£æ•°æ®ï¼š<br>
                        <span style="color: var(--theme-primary-color, #4CAF50);">
                            å¤©èš•åœŸè±†ã€è¾°ä¸œã€çŒ«è…»ã€çƒ½ç«æˆè¯¸ä¾¯ã€çˆ±æ½œæ°´çš„ä¹Œè´¼ã€è€³æ ¹ã€å¿˜è¯­
                        </span><br>
                        ä½ ä¹Ÿå¯ä»¥è¾“å…¥å…¶ä»–ä½œå®¶åç§°ï¼Œç³»ç»Ÿä¼šä½¿ç”¨AIåˆ†æå…¶æ–‡é£ç‰¹ç‚¹
                    </small>

                    <!-- ä½œå®¶æ–‡é£é¢„è§ˆåŒºåŸŸ -->
                    <div id="author-style-preview" style="
                        margin-top: 12px;
                        padding: 12px;
                        background: var(--theme-bg-secondary, #2a2a2a);
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 6px;
                        display: none;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ“– æ–‡é£åˆ†æ</strong>
                            <button type="button" id="refresh-author-style-btn" style="
                                padding: 4px 12px;
                                background: transparent;
                                color: var(--theme-text-secondary, #888);
                                border: 1px solid var(--theme-border-color, #333);
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                            ">ğŸ”„ åˆ·æ–°</button>
                        </div>
                        <div id="author-style-content" style="
                            font-size: 13px;
                            line-height: 1.6;
                            color: var(--theme-text-secondary, #888);
                            max-height: 300px;
                            overflow-y: auto;
                        ">
                            åŠ è½½ä¸­...
                        </div>
                    </div>

                    <!-- åˆ†ææ·±åº¦è®¾ç½® -->
                    <div class="form-group" style="margin-top: 12px;">
                        <label>åˆ†ææ·±åº¦</label>
                        <select id="plot-optimization-author-style-depth" class="setting-select">
                            <option value="quick" ${config.authorStyleDepth === 'quick' ? 'selected' : ''}>å¿«é€Ÿï¼ˆä½¿ç”¨å†…ç½®æ•°æ®ï¼‰</option>
                            <option value="standard" ${config.authorStyleDepth === 'standard' ? 'selected' : ''}>æ ‡å‡†ï¼ˆå†…ç½®+ç®€å•AIåˆ†æï¼‰</option>
                            <option value="comprehensive" ${(!config.authorStyleDepth || config.authorStyleDepth === 'comprehensive') ? 'selected' : ''}>æ·±åº¦ï¼ˆAIå…¨é¢åˆ†æï¼‰</option>
                        </select>
                        <small>
                            æ·±åº¦åˆ†æä¼šè°ƒç”¨AIè¿›è¡Œè¯¦ç»†çš„æ–‡é£è§£æï¼Œè€—æ—¶è¾ƒé•¿ä½†ç»“æœæ›´å‡†ç¡®<br>
                            å¿«é€Ÿæ¨¡å¼ä»…é™å†…ç½®ä½œå®¶ä½¿ç”¨
                        </small>
                    </div>
                </div>
            </div>

            <!-- ä¸Šä¸‹æ–‡è®¾ç½® -->
            <div class="settings-group">
                <h4>ä¸Šä¸‹æ–‡è®¾ç½®</h4>

                <div class="form-group">
                    <label>ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•°é‡</label>
                    <input type="number" id="plot-optimization-max-context" class="setting-input"
                           value="${config.maxContextMessages || 10}" min="1" max="50">
                    <small>æå–æœ€è¿‘Næ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡</small>
                </div>

                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="plot-optimization-use-regex" ${config.useRegexFilter ? 'checked' : ''}>
                        <label for="plot-optimization-use-regex" class="checkbox-label">ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤</label>
                    </div>
                    <small>å¯ç”¨åï¼Œåœ¨è·å–å‰§æƒ…ä¸Šä¸‹æ–‡æ—¶åº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ ‡ç­¾å†…å®¹ï¼ˆå¦‚AIè®°å¿†ã€æ€è€ƒè¿‡ç¨‹ç­‰ï¼‰</small>
                </div>
            </div>

            <!-- æç¤ºè¯æ¨¡æ¿ -->
            <div class="settings-group">
                <h4>æç¤ºè¯æ¨¡æ¿</h4>
                <div class="form-group">
                    <button type="button" id="plot-optimization-edit-template-btn" class="btn btn-primary" style="
                        width: 100%;
                        padding: 10px 16px;
                        background: var(--theme-primary-color, #4CAF50);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='var(--theme-primary-color, #4CAF50)'">
                        ğŸ“ ç¼–è¾‘æç¤ºè¯æ¨¡æ¿
                    </button>
                    <small>è‡ªå®šä¹‰å‰§æƒ…ä¼˜åŒ–çš„æç¤ºè¯æ¨¡æ¿</small>
                </div>
            </div>

            <!-- æ³¨å…¥è®¾ç½® -->
            <div class="settings-group">
                <h4>æ³¨å…¥è®¾ç½®</h4>

                <div class="form-group">
                    <label>æ³¨å…¥ä½ç½®</label>
                    <select id="plot-optimization-injection-position" class="setting-select">
                        <option value="system" ${config.injectionPosition === 'system' ? 'selected' : ''}>ç³»ç»Ÿæç¤ºè¯</option>
                        <option value="user" ${config.injectionPosition === 'user' ? 'selected' : ''}>ç”¨æˆ·æ¶ˆæ¯</option>
                        <option value="assistant" ${config.injectionPosition === 'assistant' ? 'selected' : ''}>åŠ©æ‰‹æ¶ˆæ¯</option>
                    </select>
                    <small>ä¼˜åŒ–å»ºè®®æ³¨å…¥åˆ°ä¸»APIæç¤ºè¯çš„ä½ç½®</small>
                </div>

                <div class="form-group">
                    <label>æ³¨å…¥ä¼˜å…ˆçº§</label>
                    <input type="number" id="plot-optimization-injection-priority" class="setting-input"
                           value="${config.injectionPriority || 100}" min="0" max="1000">
                    <small>æ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜</small>
                </div>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="settings-group">
                <h4>ç³»ç»ŸçŠ¶æ€</h4>
                <div class="form-group">
                    <div id="plot-optimization-status" style="
                        padding: 12px;
                        background: var(--theme-bg-secondary, #2a2a2a);
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 6px;
                        font-size: 13px;
                        color: var(--theme-text-secondary, #888);
                    ">
                        <div>çŠ¶æ€: <span id="plot-optimization-status-text">${config.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</span></div>
                        <div>æˆåŠŸæ¬¡æ•°: <span id="plot-optimization-success-count">0</span></div>
                        <div>å¤±è´¥æ¬¡æ•°: <span id="plot-optimization-error-count">0</span></div>
                        <div>æœ€åä¼˜åŒ–: <span id="plot-optimization-last-time">ä»æœª</span></div>
                    </div>
                </div>
            </div>

            <!-- ğŸ”§ æ–°å¢ï¼šå‰§æƒ…ä¼˜åŒ–é¢„è§ˆ -->
            <div class="settings-group">
                <h4>å‰§æƒ…ä¼˜åŒ–é¢„è§ˆ</h4>
                <div class="form-group">
                    <button id="plot-optimization-preview-btn" class="menu_button" style="
                        width: 100%;
                        padding: 10px;
                        background: var(--theme-primary-color, #4CAF50);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: background 0.3s;
                    " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='var(--theme-primary-color, #4CAF50)'">
                        ğŸ“‹ æŸ¥çœ‹å‰§æƒ…ä¼˜åŒ–è®°å½•
                    </button>
                    <small>æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤æˆ–é‡æ–°ç”Ÿæˆæ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯çš„å‰§æƒ…ä¼˜åŒ–å»ºè®®</small>
                </div>
            </div>
        `;
    }

    /**
     * ğŸ†• åˆ›å»ºæ•°æ®è¡¨æ ¼é…ç½®é¢æ¿
     */
    createDataTableConfigPanel() {
        const context = window.SillyTavern?.getContext?.() || SillyTavern.getContext();
        const extensionSettings = context.extensionSettings || {};
        const configs = extensionSettings['Information bar integration tool'] || {};
        const basicSettings = configs.basic || {};
        const apiConfig = configs.apiConfig || {};

        return `
            <div class="content-header">
                <h3>æ•°æ®è¡¨æ ¼é…ç½®</h3>
                <p class="content-description">ç®¡ç†æ•°æ®è¡¨æ ¼åŠŸèƒ½çš„å¯ç”¨çŠ¶æ€å’Œç›¸å…³è®¾ç½®</p>
            </div>

            <!-- åŸºç¡€è®¾ç½® -->
            <div class="settings-group">
                <h4>åŸºç¡€è®¾ç½®</h4>

                <!-- å¯ç”¨æ•°æ®è¡¨æ ¼ -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-enabled" ${basicSettings.tableRecords?.enabled ? 'checked' : ''}>
                        <label for="data-table-enabled" class="checkbox-label">å¯ç”¨æ•°æ®è¡¨æ ¼</label>
                    </div>
                    <small>å¯ç”¨ååœ¨æ‰©å±•å†…å¢åŠ æ•°æ®è¡¨æ ¼æŒ‰é’®ï¼Œç”¨äºæŸ¥çœ‹å’Œç®¡ç†æ•°æ®</small>
                </div>

                <!-- å¯ç”¨çŠ¶æ€æ æ˜¾ç¤º -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-render-in-chat" ${basicSettings.renderInChat?.enabled ? 'checked' : ''}>
                        <label for="data-table-render-in-chat" class="checkbox-label">å¯ç”¨çŠ¶æ€æ æ˜¾ç¤º</label>
                    </div>
                    <small>å¯ç”¨åå°†ä¼šåœ¨èŠå¤©ä¸­æ¸²æŸ“ä¿¡æ¯æ /çŠ¶æ€æ ï¼ï¼</small>
                </div>

                <!-- ä¿¡æ¯æ é»˜è®¤æŠ˜å  -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-default-collapsed" ${basicSettings.defaultCollapsed?.enabled ? 'checked' : ''}>
                        <label for="data-table-default-collapsed" class="checkbox-label">ä¿¡æ¯æ é»˜è®¤æŠ˜å </label>
                    </div>
                    <small>å¯åŠ¨æ—¶ä¿¡æ¯æ é»˜è®¤ä¸ºæŠ˜å çŠ¶æ€</small>
                </div>

                <!-- å¯ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-use-regex" ${apiConfig.useRegexFilter ? 'checked' : ''}>
                        <label for="data-table-use-regex" class="checkbox-label">å¯ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤</label>
                    </div>
                    <small>å¯ç”¨åï¼Œåœ¨ç”Ÿæˆæ•°æ®è¡¨æ ¼æ—¶ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤AIè¾“å‡ºä¸­çš„æ ‡ç­¾å†…å®¹ï¼ˆå¦‚æ€è€ƒè¿‡ç¨‹ã€è®°å¿†æ ‡ç­¾ç­‰ï¼‰</small>
                </div>

                <!-- APIæ¨¡å¼é€‰æ‹© -->
                <div class="api-mode-selection-wrapper" id="data-table-api-mode-selection" style="display: ${basicSettings.tableRecords?.enabled ? 'block' : 'none'}; margin-top: 15px; margin-left: 15px; padding: 15px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 8px; border-left: 3px solid #667eea;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--theme-text-primary, #e0e0e0);">ğŸ“Š æ•°æ®ç”Ÿæˆæ¨¡å¼</h4>
                    <div class="form-group" style="margin-bottom: 0;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="data-table-api-mode-btn ${apiConfig.tableRecordsAPIMode === 'main' ? 'active' : ''}" data-mode="main" style="
                                flex: 1;
                                padding: 12px 16px;
                                background: ${apiConfig.tableRecordsAPIMode === 'main' ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'var(--theme-bg-tertiary, #1a1a1a)'};
                                color: white;
                                border: ${apiConfig.tableRecordsAPIMode === 'main' ? 'none' : '1px solid var(--theme-border-color, #333)'};
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-weight: ${apiConfig.tableRecordsAPIMode === 'main' ? '500' : 'normal'};
                                font-size: 13px;
                            ">
                                ğŸ¯ ä¸»APIæ¨¡å¼
                            </button>
                            <button type="button" class="data-table-api-mode-btn ${(!apiConfig.tableRecordsAPIMode || apiConfig.tableRecordsAPIMode === 'custom') ? 'active' : ''}" data-mode="custom" style="
                                flex: 1;
                                padding: 12px 16px;
                                background: ${(!apiConfig.tableRecordsAPIMode || apiConfig.tableRecordsAPIMode === 'custom') ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'var(--theme-bg-tertiary, #1a1a1a)'};
                                color: white;
                                border: ${(!apiConfig.tableRecordsAPIMode || apiConfig.tableRecordsAPIMode === 'custom') ? 'none' : '1px solid var(--theme-border-color, #333)'};
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-weight: ${(!apiConfig.tableRecordsAPIMode || apiConfig.tableRecordsAPIMode === 'custom') ? '500' : 'normal'};
                                font-size: 13px;
                            ">
                                ğŸ”Œ è‡ªå®šä¹‰APIæ¨¡å¼
                            </button>
                        </div>
                        <div class="mode-description" style="font-size: 12px; color: var(--theme-text-secondary, #999); line-height: 1.5;">
                            <div class="main-mode-desc" style="display: ${apiConfig.tableRecordsAPIMode === 'main' ? 'block' : 'none'};">
                                ğŸ’¡ <strong>ä¸»APIæ¨¡å¼</strong>ï¼šä½¿ç”¨SillyTavernçš„ä¸»APIç”Ÿæˆæ•°æ®ï¼ˆä¾èµ–ä¸»APIçš„JSONè¾“å‡ºèƒ½åŠ›ï¼‰
                            </div>
                            <div class="custom-mode-desc" style="display: ${(!apiConfig.tableRecordsAPIMode || apiConfig.tableRecordsAPIMode === 'custom') ? 'block' : 'none'};">
                                ğŸ’¡ <strong>è‡ªå®šä¹‰APIæ¨¡å¼</strong>ï¼šä½¿ç”¨é€šç”¨APIé…ç½®ä¸­çš„è‡ªå®šä¹‰APIç”Ÿæˆæ•°æ®ï¼ˆæ¨èï¼Œæ›´ç¨³å®šï¼‰
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®è¡¨æ ¼åŠŸèƒ½è®¾ç½® -->
            <div class="settings-group" style="display: ${basicSettings.tableRecords?.enabled ? 'block' : 'none'};" id="data-table-features-section">
                <h4 style="color: #2196F3;">ğŸ“Š æ•°æ®è¡¨æ ¼åŠŸèƒ½</h4>

                <!-- åˆå¹¶æ¶ˆæ¯ -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-merge-messages" ${apiConfig.mergeMessages !== false ? 'checked' : ''}>
                        <label for="data-table-merge-messages" class="checkbox-label">åˆå¹¶æ¶ˆæ¯</label>
                    </div>
                    <small>å¯ç”¨æ—¶å°†APIè¿”å›æ•°æ®åˆå¹¶åˆ°AIæ¶ˆæ¯ä¸­å†è§£æï¼Œç¦ç”¨æ—¶ç›´æ¥è§£æAPIè¿”å›æ•°æ®</small>
                </div>

                <!-- å»¶è¿Ÿç”Ÿæˆ -->
                <div class="form-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="data-table-delayed-generation" ${apiConfig.delayedGeneration ? 'checked' : ''}>
                        <label for="data-table-delayed-generation" class="checkbox-label">å»¶è¿Ÿç”Ÿæˆ</label>
                    </div>
                    <small>å¯ç”¨åï¼ŒAIæ¶ˆæ¯ç”Ÿæˆåä¸ç«‹å³æ‰§è¡Œæ•°æ®ç”Ÿæˆï¼Œç­‰å¾…Nå±‚åå†å¤„ç†</small>
                </div>

                <!-- å»¶è¿Ÿæ¥¼å±‚æ•° -->
                <div class="form-group data-table-delayed-config" style="display: ${apiConfig.delayedGeneration ? 'block' : 'none'}; margin-left: 30px;">
                    <label>å»¶è¿Ÿæ¥¼å±‚æ•°</label>
                    <input type="number" id="data-table-delay-floors" value="${apiConfig.delayFloors || 1}" min="1" max="10" step="1">
                    <small>è®¾ç½®å»¶è¿Ÿçš„æ¥¼å±‚æ•°ã€‚ä¾‹å¦‚è®¾ç½®ä¸º1ï¼Œåˆ™åœ¨ä¸‹ä¸€å±‚AIæ¶ˆæ¯å®Œæˆåï¼Œå†å¯¹ä¸Šä¸€å±‚æ¶ˆæ¯è¿›è¡Œæ•°æ®ç”Ÿæˆ</small>
                </div>

                <!-- æœ€å°æ¶ˆæ¯å­—æ•°é˜ˆå€¼ -->
                <div class="form-group">
                    <label>æœ€å°æ¶ˆæ¯å­—æ•°é˜ˆå€¼</label>
                    <input type="number" id="data-table-min-message-length" value="${apiConfig.minMessageLength || 500}" min="0" max="10000" step="50">
                    <small>AIæ¶ˆæ¯å­—æ•°ä½äºæ­¤é˜ˆå€¼æ—¶ï¼Œè·³è¿‡ä¿¡æ¯æ æ•°æ®ç”Ÿæˆã€‚è®¾ç½®ä¸º0è¡¨ç¤ºä¸æ£€æŸ¥å­—æ•°</small>
                </div>
            </div>

            <!-- å¸®åŠ©ä¿¡æ¯ -->
            <div class="settings-group">
                <h4>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
                <div style="
                    padding: 15px;
                    background: var(--theme-bg-secondary, #2a2a2a);
                    border-radius: 8px;
                    border-left: 4px solid #2196F3;
                    font-size: 13px;
                    line-height: 1.8;
                    color: var(--theme-text-secondary, #aaa);
                ">
                    <p style="margin: 0 0 10px 0;"><strong style="color: var(--theme-text-primary, #ddd);">æ•°æ®è¡¨æ ¼åŠŸèƒ½è¯´æ˜ï¼š</strong></p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>å¯ç”¨åä¼šåœ¨æ‰©å±•èœå•ä¸­æ˜¾ç¤º"æ•°æ®è¡¨æ ¼"æŒ‰é’®</li>
                        <li>ä¸»APIæ¨¡å¼ï¼šä¾èµ–ä¸»APIçš„JSONè¾“å‡ºèƒ½åŠ›</li>
                        <li>è‡ªå®šä¹‰APIæ¨¡å¼ï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨é€šç”¨APIé…ç½®ä¸­çš„è‡ªå®šä¹‰API</li>
                        <li>åˆå¹¶æ¶ˆæ¯ï¼šå°†APIæ•°æ®åˆå¹¶åˆ°AIæ¶ˆæ¯ä¸­ï¼ˆæ¨èå¼€å¯ï¼‰</li>
                        <li>å»¶è¿Ÿç”Ÿæˆï¼šé¿å…è¿‡äºé¢‘ç¹çš„APIè°ƒç”¨</li>
                    </ul>
                </div>
            </div>
        `;
    }

    /**
     * è·å–å‰§æƒ…ä¼˜åŒ–é…ç½®
     */
    getPlotOptimizationConfig() {
        try {
            const context = window.SillyTavern?.getContext?.() || SillyTavern.getContext();
            const extensionSettings = context.extensionSettings || {};
            const configs = extensionSettings['Information bar integration tool'] || {};
            return configs.plotOptimization || {
                enabled: false,
                maxContextMessages: 10,
                promptTemplate: '',
                injectionPosition: 'system',
                injectionPriority: 100,
                storyTheme: '',
                storyType: '',
                referenceWorks: '',
                wordCountRequirement: '',
                plotProgressIntensity: 5,
                plotConflictIntensity: 5,
                plotSuspenseIntensity: 5,
                plotTwistIntensity: 5,
                plotClimaxIntensity: 5,
                plotLowIntensity: 5,
                plotTurnIntensity: 5,
                // ğŸ†• ä½œå®¶æ–‡é£æ¨¡ä»¿
                imitateAuthorEnabled: false,
                targetAuthor: '',
                authorStyleDepth: 'comprehensive',
                // ğŸ†• æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
                useRegexFilter: false
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å‰§æƒ…ä¼˜åŒ–é…ç½®å¤±è´¥:', error);
            return {
                enabled: false,
                customApiUrl: '',
                customApiKey: '',
                customApiModel: '',
                minMessageLength: 10,
                maxContextMessages: 10,
                promptTemplate: '',
                injectionPosition: 'system',
                injectionPriority: 100,
                timeout: 30000,
                imitateAuthorEnabled: false,
                targetAuthor: '',
                authorStyleDepth: 'comprehensive',
                useRegexFilter: false
            };
        }
    }

    /**
     * è·å–NPCè‡ªåŠ¨åŒæ­¥å¯ç”¨çŠ¶æ€
     */
    getNPCAutoSyncEnabled() {
        try {
            const saved = localStorage.getItem('npcPanel_autoSync');
            return saved === 'true';
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–NPCè‡ªåŠ¨åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * è·å–NPCä¸–ç•Œä¹¦åŒæ­¥å¯ç”¨çŠ¶æ€
     */
    getNPCWorldBookSyncEnabled() {
        try {
            const saved = localStorage.getItem('npcPanel_worldBookSync');
            return saved === 'true';
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–NPCä¸–ç•Œä¹¦åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * åˆ›å»ºä»»åŠ¡ç³»ç»Ÿé¢æ¿
     */
    createTasksPanel() {
        return `
            <div class="content-header">
                <h3>ä»»åŠ¡ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä»»åŠ¡ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“‹</div>
                            <div class="card-text">
                                <div class="card-title">ä»»åŠ¡ç³»ç»Ÿ</div>
                                <div class="card-subtitle">ä»»åŠ¡ç®¡ç†å’Œè¿›åº¦è·Ÿè¸ª</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="tasks-toggle" name="tasks.enabled" checked />
                                <label for="tasks-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">15/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ä»»åŠ¡åŸºç¡€ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-creation-checkbox" name="tasks.creation.enabled" checked />
                                <label for="tasks-creation-checkbox" class="checkbox-label">ä»»åŠ¡åˆ›å»º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-editing-checkbox" name="tasks.editing.enabled" checked />
                                <label for="tasks-editing-checkbox" class="checkbox-label">ä»»åŠ¡ç¼–è¾‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-deletion-checkbox" name="tasks.deletion.enabled" checked />
                                <label for="tasks-deletion-checkbox" class="checkbox-label">ä»»åŠ¡åˆ é™¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-completion-checkbox" name="tasks.completion.enabled" checked />
                                <label for="tasks-completion-checkbox" class="checkbox-label">ä»»åŠ¡å®Œæˆ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-priority-checkbox" name="tasks.priority.enabled" />
                                <label for="tasks-priority-checkbox" class="checkbox-label">ä¼˜å…ˆçº§è®¾ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-deadline-checkbox" name="tasks.deadline.enabled" />
                                <label for="tasks-deadline-checkbox" class="checkbox-label">æˆªæ­¢æ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-progress-checkbox" name="tasks.progress.enabled" />
                                <label for="tasks-progress-checkbox" class="checkbox-label">è¿›åº¦è·Ÿè¸ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-status-checkbox" name="tasks.status.enabled" />
                                <label for="tasks-status-checkbox" class="checkbox-label">çŠ¶æ€ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡åˆ†ç±» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-categories-checkbox" name="tasks.categories.enabled" />
                                <label for="tasks-categories-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†ç±»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-tags-checkbox" name="tasks.tags.enabled" />
                                <label for="tasks-tags-checkbox" class="checkbox-label">æ ‡ç­¾ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-projects-checkbox" name="tasks.projects.enabled" />
                                <label for="tasks-projects-checkbox" class="checkbox-label">é¡¹ç›®åˆ†ç»„</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-milestones-checkbox" name="tasks.milestones.enabled" />
                                <label for="tasks-milestones-checkbox" class="checkbox-label">é‡Œç¨‹ç¢‘</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-subtasks-checkbox" name="tasks.subtasks.enabled" />
                                <label for="tasks-subtasks-checkbox" class="checkbox-label">å­ä»»åŠ¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-dependencies-checkbox" name="tasks.dependencies.enabled" />
                                <label for="tasks-dependencies-checkbox" class="checkbox-label">ä»»åŠ¡ä¾èµ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-templates-checkbox" name="tasks.templates.enabled" />
                                <label for="tasks-templates-checkbox" class="checkbox-label">ä»»åŠ¡æ¨¡æ¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-recurring-checkbox" name="tasks.recurring.enabled" />
                                <label for="tasks-recurring-checkbox" class="checkbox-label">é‡å¤ä»»åŠ¡</label>
                            </div>
                        </div>
                    </div>

                    <!-- é€šçŸ¥æé†’ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-notifications-checkbox" name="tasks.notifications.enabled" checked />
                                <label for="tasks-notifications-checkbox" class="checkbox-label">ä»»åŠ¡é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-reminders-checkbox" name="tasks.reminders.enabled" />
                                <label for="tasks-reminders-checkbox" class="checkbox-label">æé†’è®¾ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-alerts-checkbox" name="tasks.alerts.enabled" />
                                <label for="tasks-alerts-checkbox" class="checkbox-label">é€¾æœŸè­¦å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-daily-summary-checkbox" name="tasks.dailySummary.enabled" />
                                <label for="tasks-daily-summary-checkbox" class="checkbox-label">æ¯æ—¥æ€»ç»“</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-weekly-review-checkbox" name="tasks.weeklyReview.enabled" />
                                <label for="tasks-weekly-review-checkbox" class="checkbox-label">å‘¨åº¦å›é¡¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-achievement-badges-checkbox" name="tasks.achievementBadges.enabled" />
                                <label for="tasks-achievement-badges-checkbox" class="checkbox-label">æˆå°±å¾½ç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-productivity-stats-checkbox" name="tasks.productivityStats.enabled" />
                                <label for="tasks-productivity-stats-checkbox" class="checkbox-label">æ•ˆç‡ç»Ÿè®¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-time-tracking-checkbox" name="tasks.timeTracking.enabled" />
                                <label for="tasks-time-tracking-checkbox" class="checkbox-label">æ—¶é—´è·Ÿè¸ª</label>
                            </div>
                        </div>
                    </div>

                    <!-- åä½œåŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-assignment-checkbox" name="tasks.assignment.enabled" />
                                <label for="tasks-assignment-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†é…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-collaboration-checkbox" name="tasks.collaboration.enabled" />
                                <label for="tasks-collaboration-checkbox" class="checkbox-label">åä½œåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-comments-checkbox" name="tasks.comments.enabled" />
                                <label for="tasks-comments-checkbox" class="checkbox-label">ä»»åŠ¡è¯„è®º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-attachments-checkbox" name="tasks.attachments.enabled" />
                                <label for="tasks-attachments-checkbox" class="checkbox-label">æ–‡ä»¶é™„ä»¶</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sharing-checkbox" name="tasks.sharing.enabled" />
                                <label for="tasks-sharing-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†äº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-permissions-checkbox" name="tasks.permissions.enabled" />
                                <label for="tasks-permissions-checkbox" class="checkbox-label">æƒé™ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-approval-checkbox" name="tasks.approval.enabled" />
                                <label for="tasks-approval-checkbox" class="checkbox-label">å®¡æ‰¹æµç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-delegation-checkbox" name="tasks.delegation.enabled" />
                                <label for="tasks-delegation-checkbox" class="checkbox-label">ä»»åŠ¡å§”æ´¾</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§†å›¾å’Œæ’åº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-list-view-checkbox" name="tasks.listView.enabled" checked />
                                <label for="tasks-list-view-checkbox" class="checkbox-label">åˆ—è¡¨è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-kanban-view-checkbox" name="tasks.kanbanView.enabled" />
                                <label for="tasks-kanban-view-checkbox" class="checkbox-label">çœ‹æ¿è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-calendar-view-checkbox" name="tasks.calendarView.enabled" />
                                <label for="tasks-calendar-view-checkbox" class="checkbox-label">æ—¥å†è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-gantt-view-checkbox" name="tasks.ganttView.enabled" />
                                <label for="tasks-gantt-view-checkbox" class="checkbox-label">ç”˜ç‰¹å›¾</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sorting-checkbox" name="tasks.sorting.enabled" checked />
                                <label for="tasks-sorting-checkbox" class="checkbox-label">æ’åºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-filtering-checkbox" name="tasks.filtering.enabled" />
                                <label for="tasks-filtering-checkbox" class="checkbox-label">ç­›é€‰åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-search-checkbox" name="tasks.search.enabled" />
                                <label for="tasks-search-checkbox" class="checkbox-label">æœç´¢åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-grouping-checkbox" name="tasks.grouping.enabled" />
                                <label for="tasks-grouping-checkbox" class="checkbox-label">åˆ†ç»„æ˜¾ç¤º</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-backup-checkbox" name="tasks.backup.enabled" />
                                <label for="tasks-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-export-checkbox" name="tasks.export.enabled" />
                                <label for="tasks-export-checkbox" class="checkbox-label">æ•°æ®å¯¼å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-import-checkbox" name="tasks.import.enabled" />
                                <label for="tasks-import-checkbox" class="checkbox-label">æ•°æ®å¯¼å…¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sync-checkbox" name="tasks.sync.enabled" />
                                <label for="tasks-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-archive-checkbox" name="tasks.archive.enabled" />
                                <label for="tasks-archive-checkbox" class="checkbox-label">ä»»åŠ¡å½’æ¡£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-history-checkbox" name="tasks.history.enabled" />
                                <label for="tasks-history-checkbox" class="checkbox-label">å†å²è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-versioning-checkbox" name="tasks.versioning.enabled" />
                                <label for="tasks-versioning-checkbox" class="checkbox-label">ç‰ˆæœ¬æ§åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-recovery-checkbox" name="tasks.recovery.enabled" />
                                <label for="tasks-recovery-checkbox" class="checkbox-label">æ•°æ®æ¢å¤</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºä¸–ç•Œä¿¡æ¯é¢æ¿
     */
    createWorldPanel() {
        return `
            <div class="content-header">
                <h3>ä¸–ç•Œä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¸–ç•Œä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸŒ</div>
                            <div class="card-text">
                                <div class="card-title">ä¸–ç•Œä¿¡æ¯</div>
                                <div class="card-subtitle">ä¸–ç•Œè®¾å®šå’Œç¯å¢ƒç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="world-toggle" name="world.enabled" checked />
                                <label for="world-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">18/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€è®¾å®š -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-name-checkbox" name="world.name.enabled" checked />
                                <label for="world-name-checkbox" class="checkbox-label">ä¸–ç•Œåç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-type-checkbox" name="world.type.enabled" checked />
                                <label for="world-type-checkbox" class="checkbox-label">ä¸–ç•Œç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-genre-checkbox" name="world.genre.enabled" checked />
                                <label for="world-genre-checkbox" class="checkbox-label">ä¸–ç•Œé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-theme-checkbox" name="world.theme.enabled" />
                                <label for="world-theme-checkbox" class="checkbox-label">ä¸»é¢˜è®¾å®š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-description-checkbox" name="world.description.enabled" checked />
                                <label for="world-description-checkbox" class="checkbox-label">ä¸–ç•Œæè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-history-checkbox" name="world.history.enabled" />
                                <label for="world-history-checkbox" class="checkbox-label">å†å²èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-mythology-checkbox" name="world.mythology.enabled" />
                                <label for="world-mythology-checkbox" class="checkbox-label">ç¥è¯ä¼ è¯´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-lore-checkbox" name="world.lore.enabled" />
                                <label for="world-lore-checkbox" class="checkbox-label">ä¸–ç•Œè§‚è®¾å®š</label>
                            </div>
                        </div>
                    </div>

                    <!-- åœ°ç†ç¯å¢ƒ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-geography-checkbox" name="world.geography.enabled" checked />
                                <label for="world-geography-checkbox" class="checkbox-label">åœ°ç†ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-climate-checkbox" name="world.climate.enabled" />
                                <label for="world-climate-checkbox" class="checkbox-label">æ°”å€™æ¡ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-terrain-checkbox" name="world.terrain.enabled" />
                                <label for="world-terrain-checkbox" class="checkbox-label">åœ°å½¢åœ°è²Œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-biomes-checkbox" name="world.biomes.enabled" />
                                <label for="world-biomes-checkbox" class="checkbox-label">ç”Ÿæ€ç¾¤è½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-locations-checkbox" name="world.locations.enabled" checked />
                                <label for="world-locations-checkbox" class="checkbox-label">é‡è¦åœ°ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-landmarks-checkbox" name="world.landmarks.enabled" />
                                <label for="world-landmarks-checkbox" class="checkbox-label">åœ°æ ‡å»ºç­‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-cities-checkbox" name="world.cities.enabled" />
                                <label for="world-cities-checkbox" class="checkbox-label">åŸå¸‚èšè½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-dungeons-checkbox" name="world.dungeons.enabled" />
                                <label for="world-dungeons-checkbox" class="checkbox-label">åœ°ä¸‹åŸ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¶é—´ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-time-checkbox" name="world.time.enabled" checked />
                                <label for="world-time-checkbox" class="checkbox-label">æ—¶é—´ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-calendar-checkbox" name="world.calendar.enabled" />
                                <label for="world-calendar-checkbox" class="checkbox-label">å†æ³•ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-seasons-checkbox" name="world.seasons.enabled" />
                                <label for="world-seasons-checkbox" class="checkbox-label">å­£èŠ‚å˜åŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-day-night-checkbox" name="world.dayNight.enabled" />
                                <label for="world-day-night-checkbox" class="checkbox-label">æ˜¼å¤œå¾ªç¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-weather-checkbox" name="world.weather.enabled" />
                                <label for="world-weather-checkbox" class="checkbox-label">å¤©æ°”ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-events-checkbox" name="world.events.enabled" />
                                <label for="world-events-checkbox" class="checkbox-label">ä¸–ç•Œäº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-festivals-checkbox" name="world.festivals.enabled" />
                                <label for="world-festivals-checkbox" class="checkbox-label">èŠ‚æ—¥åº†å…¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-disasters-checkbox" name="world.disasters.enabled" />
                                <label for="world-disasters-checkbox" class="checkbox-label">è‡ªç„¶ç¾å®³</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾ä¼šæ–‡åŒ– -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-cultures-checkbox" name="world.cultures.enabled" />
                                <label for="world-cultures-checkbox" class="checkbox-label">æ–‡åŒ–ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-languages-checkbox" name="world.languages.enabled" />
                                <label for="world-languages-checkbox" class="checkbox-label">è¯­è¨€ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-religions-checkbox" name="world.religions.enabled" />
                                <label for="world-religions-checkbox" class="checkbox-label">å®—æ•™ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-customs-checkbox" name="world.customs.enabled" />
                                <label for="world-customs-checkbox" class="checkbox-label">é£ä¿—ä¹ æƒ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-politics-checkbox" name="world.politics.enabled" />
                                <label for="world-politics-checkbox" class="checkbox-label">æ”¿æ²»åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-economy-checkbox" name="world.economy.enabled" />
                                <label for="world-economy-checkbox" class="checkbox-label">ç»æµä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-technology-checkbox" name="world.technology.enabled" />
                                <label for="world-technology-checkbox" class="checkbox-label">ç§‘æŠ€æ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-magic-checkbox" name="world.magic.enabled" />
                                <label for="world-magic-checkbox" class="checkbox-label">é­”æ³•ä½“ç³»</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿç‰©ç§æ— -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-races-checkbox" name="world.races.enabled" />
                                <label for="world-races-checkbox" class="checkbox-label">ç§æ—è®¾å®š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-creatures-checkbox" name="world.creatures.enabled" />
                                <label for="world-creatures-checkbox" class="checkbox-label">ç”Ÿç‰©ç¾¤ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-monsters-checkbox" name="world.monsters.enabled" />
                                <label for="world-monsters-checkbox" class="checkbox-label">æ€ªç‰©è®¾å®š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-npcs-checkbox" name="world.npcs.enabled" />
                                <label for="world-npcs-checkbox" class="checkbox-label">NPCç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-factions-checkbox" name="world.factions.enabled" />
                                <label for="world-factions-checkbox" class="checkbox-label">åŠ¿åŠ›é˜µè¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-conflicts-checkbox" name="world.conflicts.enabled" />
                                <label for="world-conflicts-checkbox" class="checkbox-label">å†²çªçŸ›ç›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-alliances-checkbox" name="world.alliances.enabled" />
                                <label for="world-alliances-checkbox" class="checkbox-label">è”ç›Ÿå…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-wars-checkbox" name="world.wars.enabled" />
                                <label for="world-wars-checkbox" class="checkbox-label">æˆ˜äº‰å†å²</label>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„æºç‰©å“ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-resources-checkbox" name="world.resources.enabled" />
                                <label for="world-resources-checkbox" class="checkbox-label">è‡ªç„¶èµ„æº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-materials-checkbox" name="world.materials.enabled" />
                                <label for="world-materials-checkbox" class="checkbox-label">ææ–™ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-artifacts-checkbox" name="world.artifacts.enabled" />
                                <label for="world-artifacts-checkbox" class="checkbox-label">ç¥å™¨å®ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-currency-checkbox" name="world.currency.enabled" />
                                <label for="world-currency-checkbox" class="checkbox-label">è´§å¸ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-trade-checkbox" name="world.trade.enabled" />
                                <label for="world-trade-checkbox" class="checkbox-label">è´¸æ˜“ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-markets-checkbox" name="world.markets.enabled" />
                                <label for="world-markets-checkbox" class="checkbox-label">å¸‚åœºå•†åº—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-guilds-checkbox" name="world.guilds.enabled" />
                                <label for="world-guilds-checkbox" class="checkbox-label">å…¬ä¼šç»„ç»‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-transportation-checkbox" name="world.transportation.enabled" />
                                <label for="world-transportation-checkbox" class="checkbox-label">äº¤é€šè¿è¾“</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºç»„ç»‡ä¿¡æ¯é¢æ¿
     */
    createOrganizationPanel() {
        return `
            <div class="content-header">
                <h3>ç»„ç»‡ä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ç»„ç»‡ä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ›ï¸</div>
                            <div class="card-text">
                                <div class="card-title">ç»„ç»‡ä¿¡æ¯</div>
                                <div class="card-subtitle">ç»„ç»‡ç®¡ç†å’Œæˆå‘˜å…³ç³»</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="organization-toggle" name="organization.enabled" checked />
                                <label for="organization-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">16/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-name-checkbox" name="organization.name.enabled" checked />
                                <label for="org-name-checkbox" class="checkbox-label">ç»„ç»‡åç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-type-checkbox" name="organization.type.enabled" checked />
                                <label for="org-type-checkbox" class="checkbox-label">ç»„ç»‡ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-description-checkbox" name="organization.description.enabled" checked />
                                <label for="org-description-checkbox" class="checkbox-label">ç»„ç»‡æè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-purpose-checkbox" name="organization.purpose.enabled" />
                                <label for="org-purpose-checkbox" class="checkbox-label">ç»„ç»‡ç›®æ ‡</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-history-checkbox" name="organization.history.enabled" />
                                <label for="org-history-checkbox" class="checkbox-label">ç»„ç»‡å†å²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-founding-checkbox" name="organization.founding.enabled" />
                                <label for="org-founding-checkbox" class="checkbox-label">æˆç«‹èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-motto-checkbox" name="organization.motto.enabled" />
                                <label for="org-motto-checkbox" class="checkbox-label">ç»„ç»‡æ ¼è¨€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-values-checkbox" name="organization.values.enabled" />
                                <label for="org-values-checkbox" class="checkbox-label">æ ¸å¿ƒä»·å€¼</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç»„ç»‡ç»“æ„ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-hierarchy-checkbox" name="organization.hierarchy.enabled" checked />
                                <label for="org-hierarchy-checkbox" class="checkbox-label">ç­‰çº§åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-departments-checkbox" name="organization.departments.enabled" />
                                <label for="org-departments-checkbox" class="checkbox-label">éƒ¨é—¨åˆ†å·¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-leadership-checkbox" name="organization.leadership.enabled" />
                                <label for="org-leadership-checkbox" class="checkbox-label">é¢†å¯¼å±‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-council-checkbox" name="organization.council.enabled" />
                                <label for="org-council-checkbox" class="checkbox-label">è®®äº‹ä¼š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-positions-checkbox" name="organization.positions.enabled" checked />
                                <label for="org-positions-checkbox" class="checkbox-label">èŒä½ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-ranks-checkbox" name="organization.ranks.enabled" />
                                <label for="org-ranks-checkbox" class="checkbox-label">ç­‰çº§åˆ’åˆ†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-promotion-checkbox" name="organization.promotion.enabled" />
                                <label for="org-promotion-checkbox" class="checkbox-label">æ™‹å‡åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-authority-checkbox" name="organization.authority.enabled" />
                                <label for="org-authority-checkbox" class="checkbox-label">æƒé™ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <!-- æˆå‘˜ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-members-checkbox" name="organization.members.enabled" checked />
                                <label for="org-members-checkbox" class="checkbox-label">æˆå‘˜åå•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-recruitment-checkbox" name="organization.recruitment.enabled" />
                                <label for="org-recruitment-checkbox" class="checkbox-label">æ‹›å‹Ÿåˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-training-checkbox" name="organization.training.enabled" />
                                <label for="org-training-checkbox" class="checkbox-label">åŸ¹è®­ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-evaluation-checkbox" name="organization.evaluation.enabled" />
                                <label for="org-evaluation-checkbox" class="checkbox-label">è€ƒæ ¸è¯„ä¼°</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-rewards-checkbox" name="organization.rewards.enabled" />
                                <label for="org-rewards-checkbox" class="checkbox-label">å¥–åŠ±æœºåˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-punishment-checkbox" name="organization.punishment.enabled" />
                                <label for="org-punishment-checkbox" class="checkbox-label">æƒ©ç½šåˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-benefits-checkbox" name="organization.benefits.enabled" />
                                <label for="org-benefits-checkbox" class="checkbox-label">ç¦åˆ©å¾…é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-retirement-checkbox" name="organization.retirement.enabled" />
                                <label for="org-retirement-checkbox" class="checkbox-label">é€€ä¼‘åˆ¶åº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§„ç« åˆ¶åº¦ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-rules-checkbox" name="organization.rules.enabled" />
                                <label for="org-rules-checkbox" class="checkbox-label">ç»„ç»‡è§„ç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-code-checkbox" name="organization.code.enabled" />
                                <label for="org-code-checkbox" class="checkbox-label">è¡Œä¸ºå‡†åˆ™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-ethics-checkbox" name="organization.ethics.enabled" />
                                <label for="org-ethics-checkbox" class="checkbox-label">é“å¾·æ ‡å‡†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-discipline-checkbox" name="organization.discipline.enabled" />
                                <label for="org-discipline-checkbox" class="checkbox-label">çºªå¾‹è¦æ±‚</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-procedures-checkbox" name="organization.procedures.enabled" />
                                <label for="org-procedures-checkbox" class="checkbox-label">å·¥ä½œæµç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-protocols-checkbox" name="organization.protocols.enabled" />
                                <label for="org-protocols-checkbox" class="checkbox-label">æ“ä½œè§„ç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-standards-checkbox" name="organization.standards.enabled" />
                                <label for="org-standards-checkbox" class="checkbox-label">è´¨é‡æ ‡å‡†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-compliance-checkbox" name="organization.compliance.enabled" />
                                <label for="org-compliance-checkbox" class="checkbox-label">åˆè§„è¦æ±‚</label>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¹å¤–å…³ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-allies-checkbox" name="organization.allies.enabled" />
                                <label for="org-allies-checkbox" class="checkbox-label">ç›Ÿå‹ç»„ç»‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-enemies-checkbox" name="organization.enemies.enabled" />
                                <label for="org-enemies-checkbox" class="checkbox-label">æ•Œå¯¹åŠ¿åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-neutral-checkbox" name="organization.neutral.enabled" />
                                <label for="org-neutral-checkbox" class="checkbox-label">ä¸­ç«‹å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-partnerships-checkbox" name="organization.partnerships.enabled" />
                                <label for="org-partnerships-checkbox" class="checkbox-label">åˆä½œä¼™ä¼´</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-reputation-checkbox" name="organization.reputation.enabled" />
                                <label for="org-reputation-checkbox" class="checkbox-label">å£°èª‰å½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-influence-checkbox" name="organization.influence.enabled" />
                                <label for="org-influence-checkbox" class="checkbox-label">åŠ¿åŠ›èŒƒå›´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-diplomacy-checkbox" name="organization.diplomacy.enabled" />
                                <label for="org-diplomacy-checkbox" class="checkbox-label">å¤–äº¤æ”¿ç­–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-treaties-checkbox" name="organization.treaties.enabled" />
                                <label for="org-treaties-checkbox" class="checkbox-label">æ¡çº¦åè®®</label>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„æºç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-finances-checkbox" name="organization.finances.enabled" />
                                <label for="org-finances-checkbox" class="checkbox-label">è´¢åŠ¡ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-assets-checkbox" name="organization.assets.enabled" />
                                <label for="org-assets-checkbox" class="checkbox-label">èµ„äº§æ¸…å•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-facilities-checkbox" name="organization.facilities.enabled" />
                                <label for="org-facilities-checkbox" class="checkbox-label">è®¾æ–½åœºæ‰€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-equipment-checkbox" name="organization.equipment.enabled" />
                                <label for="org-equipment-checkbox" class="checkbox-label">è£…å¤‡å™¨æ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-technology-checkbox" name="organization.technology.enabled" />
                                <label for="org-technology-checkbox" class="checkbox-label">æŠ€æœ¯èµ„æº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-knowledge-checkbox" name="organization.knowledge.enabled" />
                                <label for="org-knowledge-checkbox" class="checkbox-label">çŸ¥è¯†åº“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-archives-checkbox" name="organization.archives.enabled" />
                                <label for="org-archives-checkbox" class="checkbox-label">æ¡£æ¡ˆè®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-secrets-checkbox" name="organization.secrets.enabled" />
                                <label for="org-secrets-checkbox" class="checkbox-label">æœºå¯†ä¿¡æ¯</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèµ„è®¯å†…å®¹é¢æ¿
     */
    createNewsPanel() {
        return `
            <div class="content-header">
                <h3>èµ„è®¯å†…å®¹é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èµ„è®¯å†…å®¹å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“°</div>
                            <div class="card-text">
                                <div class="card-title">èµ„è®¯å†…å®¹</div>
                                <div class="card-subtitle">ä¿¡æ¯ç®¡ç†å’Œå†…å®¹åˆ†å‘</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="news-toggle" name="news.enabled" checked />
                                <label for="news-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">20/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- å†…å®¹ç±»å‹ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-breaking-checkbox" name="news.breaking.enabled" checked />
                                <label for="news-breaking-checkbox" class="checkbox-label">çªå‘æ–°é—»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-politics-checkbox" name="news.politics.enabled" checked />
                                <label for="news-politics-checkbox" class="checkbox-label">æ”¿æ²»æ–°é—»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-economy-checkbox" name="news.economy.enabled" checked />
                                <label for="news-economy-checkbox" class="checkbox-label">ç»æµèµ„è®¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-social-checkbox" name="news.social.enabled" />
                                <label for="news-social-checkbox" class="checkbox-label">ç¤¾ä¼šæ–°é—»</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-military-checkbox" name="news.military.enabled" />
                                <label for="news-military-checkbox" class="checkbox-label">å†›äº‹åŠ¨æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-technology-checkbox" name="news.technology.enabled" />
                                <label for="news-technology-checkbox" class="checkbox-label">ç§‘æŠ€èµ„è®¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-culture-checkbox" name="news.culture.enabled" />
                                <label for="news-culture-checkbox" class="checkbox-label">æ–‡åŒ–è‰ºæœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-sports-checkbox" name="news.sports.enabled" />
                                <label for="news-sports-checkbox" class="checkbox-label">ä½“è‚²èµ›äº‹</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯æ¥æº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-official-checkbox" name="news.official.enabled" checked />
                                <label for="news-official-checkbox" class="checkbox-label">å®˜æ–¹æ¶ˆæ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-media-checkbox" name="news.media.enabled" />
                                <label for="news-media-checkbox" class="checkbox-label">åª’ä½“æŠ¥é“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-rumors-checkbox" name="news.rumors.enabled" />
                                <label for="news-rumors-checkbox" class="checkbox-label">ä¼ è¨€æ¶ˆæ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-insider-checkbox" name="news.insider.enabled" />
                                <label for="news-insider-checkbox" class="checkbox-label">å†…éƒ¨æ¶ˆæ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-witness-checkbox" name="news.witness.enabled" />
                                <label for="news-witness-checkbox" class="checkbox-label">ç›®å‡»æŠ¥å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-intelligence-checkbox" name="news.intelligence.enabled" />
                                <label for="news-intelligence-checkbox" class="checkbox-label">æƒ…æŠ¥ä¿¡æ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-leaked-checkbox" name="news.leaked.enabled" />
                                <label for="news-leaked-checkbox" class="checkbox-label">æ³„éœ²æ–‡ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-anonymous-checkbox" name="news.anonymous.enabled" />
                                <label for="news-anonymous-checkbox" class="checkbox-label">åŒ¿åçˆ†æ–™</label>
                            </div>
                        </div>
                    </div>

                    <!-- å†…å®¹ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-creation-checkbox" name="news.creation.enabled" checked />
                                <label for="news-creation-checkbox" class="checkbox-label">å†…å®¹åˆ›å»º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-editing-checkbox" name="news.editing.enabled" />
                                <label for="news-editing-checkbox" class="checkbox-label">å†…å®¹ç¼–è¾‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-review-checkbox" name="news.review.enabled" />
                                <label for="news-review-checkbox" class="checkbox-label">å†…å®¹å®¡æ ¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-publishing-checkbox" name="news.publishing.enabled" />
                                <label for="news-publishing-checkbox" class="checkbox-label">å†…å®¹å‘å¸ƒ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-archiving-checkbox" name="news.archiving.enabled" />
                                <label for="news-archiving-checkbox" class="checkbox-label">å†…å®¹å½’æ¡£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-deletion-checkbox" name="news.deletion.enabled" />
                                <label for="news-deletion-checkbox" class="checkbox-label">å†…å®¹åˆ é™¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-backup-checkbox" name="news.backup.enabled" />
                                <label for="news-backup-checkbox" class="checkbox-label">å†…å®¹å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-versioning-checkbox" name="news.versioning.enabled" />
                                <label for="news-versioning-checkbox" class="checkbox-label">ç‰ˆæœ¬æ§åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†å‘æ¸ é“ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-broadcast-checkbox" name="news.broadcast.enabled" />
                                <label for="news-broadcast-checkbox" class="checkbox-label">å¹¿æ’­å‘å¸ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-newsletter-checkbox" name="news.newsletter.enabled" />
                                <label for="news-newsletter-checkbox" class="checkbox-label">æ–°é—»ç®€æŠ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-alerts-checkbox" name="news.alerts.enabled" />
                                <label for="news-alerts-checkbox" class="checkbox-label">ç´§æ€¥é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-digest-checkbox" name="news.digest.enabled" />
                                <label for="news-digest-checkbox" class="checkbox-label">æ–°é—»æ‘˜è¦</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-social-media-checkbox" name="news.socialMedia.enabled" />
                                <label for="news-social-media-checkbox" class="checkbox-label">ç¤¾äº¤åª’ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-forums-checkbox" name="news.forums.enabled" />
                                <label for="news-forums-checkbox" class="checkbox-label">è®ºå›å‘å¸ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-messaging-checkbox" name="news.messaging.enabled" />
                                <label for="news-messaging-checkbox" class="checkbox-label">æ¶ˆæ¯æ¨é€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-email-checkbox" name="news.email.enabled" />
                                <label for="news-email-checkbox" class="checkbox-label">é‚®ä»¶é€šçŸ¥</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº’åŠ¨åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-comments-checkbox" name="news.comments.enabled" />
                                <label for="news-comments-checkbox" class="checkbox-label">è¯„è®ºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-likes-checkbox" name="news.likes.enabled" />
                                <label for="news-likes-checkbox" class="checkbox-label">ç‚¹èµåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-sharing-checkbox" name="news.sharing.enabled" />
                                <label for="news-sharing-checkbox" class="checkbox-label">åˆ†äº«åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-bookmarks-checkbox" name="news.bookmarks.enabled" />
                                <label for="news-bookmarks-checkbox" class="checkbox-label">æ”¶è—åŠŸèƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-ratings-checkbox" name="news.ratings.enabled" />
                                <label for="news-ratings-checkbox" class="checkbox-label">è¯„åˆ†ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-polls-checkbox" name="news.polls.enabled" />
                                <label for="news-polls-checkbox" class="checkbox-label">æŠ•ç¥¨è°ƒæŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-discussions-checkbox" name="news.discussions.enabled" />
                                <label for="news-discussions-checkbox" class="checkbox-label">è®¨è®ºåŒº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-feedback-checkbox" name="news.feedback.enabled" />
                                <label for="news-feedback-checkbox" class="checkbox-label">åé¦ˆç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®åˆ†æ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-analytics-checkbox" name="news.analytics.enabled" />
                                <label for="news-analytics-checkbox" class="checkbox-label">æ•°æ®åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-metrics-checkbox" name="news.metrics.enabled" />
                                <label for="news-metrics-checkbox" class="checkbox-label">æŒ‡æ ‡ç»Ÿè®¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-trends-checkbox" name="news.trends.enabled" />
                                <label for="news-trends-checkbox" class="checkbox-label">è¶‹åŠ¿åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-reports-checkbox" name="news.reports.enabled" />
                                <label for="news-reports-checkbox" class="checkbox-label">æŠ¥å‘Šç”Ÿæˆ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-monitoring-checkbox" name="news.monitoring.enabled" />
                                <label for="news-monitoring-checkbox" class="checkbox-label">ç›‘æ§ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-alerts-system-checkbox" name="news.alertsSystem.enabled" />
                                <label for="news-alerts-system-checkbox" class="checkbox-label">é¢„è­¦ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-automation-checkbox" name="news.automation.enabled" />
                                <label for="news-automation-checkbox" class="checkbox-label">è‡ªåŠ¨åŒ–å¤„ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-ai-analysis-checkbox" name="news.aiAnalysis.enabled" />
                                <label for="news-ai-analysis-checkbox" class="checkbox-label">AIåˆ†æ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèƒŒåŒ…ä»“åº“é¢æ¿
     */
    createInventoryPanel() {
        return `
            <div class="content-header">
                <h3>èƒŒåŒ…ä»“åº“é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èƒŒåŒ…ä»“åº“å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ’</div>
                            <div class="card-text">
                                <div class="card-title">èƒŒåŒ…ä»“åº“</div>
                                <div class="card-subtitle">ç‰©å“ç®¡ç†å’Œå­˜å‚¨ç³»ç»Ÿ</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="inventory-toggle" name="inventory.enabled" checked />
                                <label for="inventory-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">22/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-storage-checkbox" name="inventory.storage.enabled" checked />
                                <label for="inventory-storage-checkbox" class="checkbox-label">ç‰©å“å­˜å‚¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-retrieval-checkbox" name="inventory.retrieval.enabled" checked />
                                <label for="inventory-retrieval-checkbox" class="checkbox-label">ç‰©å“å–å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-organization-checkbox" name="inventory.organization.enabled" checked />
                                <label for="inventory-organization-checkbox" class="checkbox-label">ç‰©å“æ•´ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-search-checkbox" name="inventory.search.enabled" />
                                <label for="inventory-search-checkbox" class="checkbox-label">ç‰©å“æœç´¢</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sorting-checkbox" name="inventory.sorting.enabled" />
                                <label for="inventory-sorting-checkbox" class="checkbox-label">è‡ªåŠ¨æ’åº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-filtering-checkbox" name="inventory.filtering.enabled" />
                                <label for="inventory-filtering-checkbox" class="checkbox-label">ç‰©å“ç­›é€‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-categories-checkbox" name="inventory.categories.enabled" />
                                <label for="inventory-categories-checkbox" class="checkbox-label">åˆ†ç±»ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-tags-checkbox" name="inventory.tags.enabled" />
                                <label for="inventory-tags-checkbox" class="checkbox-label">æ ‡ç­¾ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰©å“ç±»å‹ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-weapons-checkbox" name="inventory.weapons.enabled" checked />
                                <label for="inventory-weapons-checkbox" class="checkbox-label">æ­¦å™¨è£…å¤‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-armor-checkbox" name="inventory.armor.enabled" checked />
                                <label for="inventory-armor-checkbox" class="checkbox-label">é˜²å…·æŠ¤ç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-accessories-checkbox" name="inventory.accessories.enabled" />
                                <label for="inventory-accessories-checkbox" class="checkbox-label">é¥°å“é…ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-consumables-checkbox" name="inventory.consumables.enabled" />
                                <label for="inventory-consumables-checkbox" class="checkbox-label">æ¶ˆè€—å“</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-materials-checkbox" name="inventory.materials.enabled" />
                                <label for="inventory-materials-checkbox" class="checkbox-label">ææ–™ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-tools-checkbox" name="inventory.tools.enabled" />
                                <label for="inventory-tools-checkbox" class="checkbox-label">å·¥å…·å™¨æ¢°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-books-checkbox" name="inventory.books.enabled" />
                                <label for="inventory-books-checkbox" class="checkbox-label">ä¹¦ç±æ–‡çŒ®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-treasures-checkbox" name="inventory.treasures.enabled" />
                                <label for="inventory-treasures-checkbox" class="checkbox-label">çå®æ”¶è—</label>
                            </div>
                        </div>
                    </div>

                    <!-- å­˜å‚¨ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-capacity-checkbox" name="inventory.capacity.enabled" checked />
                                <label for="inventory-capacity-checkbox" class="checkbox-label">å®¹é‡ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-weight-checkbox" name="inventory.weight.enabled" />
                                <label for="inventory-weight-checkbox" class="checkbox-label">é‡é‡é™åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-stacking-checkbox" name="inventory.stacking.enabled" />
                                <label for="inventory-stacking-checkbox" class="checkbox-label">ç‰©å“å †å </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-expansion-checkbox" name="inventory.expansion.enabled" />
                                <label for="inventory-expansion-checkbox" class="checkbox-label">å®¹é‡æ‰©å±•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-compartments-checkbox" name="inventory.compartments.enabled" />
                                <label for="inventory-compartments-checkbox" class="checkbox-label">åˆ†éš”åŒºåŸŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-protection-checkbox" name="inventory.protection.enabled" />
                                <label for="inventory-protection-checkbox" class="checkbox-label">ç‰©å“ä¿æŠ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-durability-checkbox" name="inventory.durability.enabled" />
                                <label for="inventory-durability-checkbox" class="checkbox-label">è€ä¹…åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-repair-checkbox" name="inventory.repair.enabled" />
                                <label for="inventory-repair-checkbox" class="checkbox-label">ä¿®ç†ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤æ˜“åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-trading-checkbox" name="inventory.trading.enabled" />
                                <label for="inventory-trading-checkbox" class="checkbox-label">ç‰©å“äº¤æ˜“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-selling-checkbox" name="inventory.selling.enabled" />
                                <label for="inventory-selling-checkbox" class="checkbox-label">ç‰©å“å‡ºå”®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-buying-checkbox" name="inventory.buying.enabled" />
                                <label for="inventory-buying-checkbox" class="checkbox-label">ç‰©å“è´­ä¹°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-auction-checkbox" name="inventory.auction.enabled" />
                                <label for="inventory-auction-checkbox" class="checkbox-label">æ‹å–ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-gifting-checkbox" name="inventory.gifting.enabled" />
                                <label for="inventory-gifting-checkbox" class="checkbox-label">ç‰©å“èµ é€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-lending-checkbox" name="inventory.lending.enabled" />
                                <label for="inventory-lending-checkbox" class="checkbox-label">ç‰©å“å€Ÿè´·</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sharing-checkbox" name="inventory.sharing.enabled" />
                                <label for="inventory-sharing-checkbox" class="checkbox-label">ç‰©å“å…±äº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-banking-checkbox" name="inventory.banking.enabled" />
                                <label for="inventory-banking-checkbox" class="checkbox-label">é“¶è¡Œå­˜å‚¨</label>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ¶ä½œç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-crafting-checkbox" name="inventory.crafting.enabled" />
                                <label for="inventory-crafting-checkbox" class="checkbox-label">ç‰©å“åˆ¶ä½œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recipes-checkbox" name="inventory.recipes.enabled" />
                                <label for="inventory-recipes-checkbox" class="checkbox-label">é…æ–¹ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-enhancement-checkbox" name="inventory.enhancement.enabled" />
                                <label for="inventory-enhancement-checkbox" class="checkbox-label">ç‰©å“å¼ºåŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-enchanting-checkbox" name="inventory.enchanting.enabled" />
                                <label for="inventory-enchanting-checkbox" class="checkbox-label">é™„é­”ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-upgrading-checkbox" name="inventory.upgrading.enabled" />
                                <label for="inventory-upgrading-checkbox" class="checkbox-label">ç‰©å“å‡çº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-combining-checkbox" name="inventory.combining.enabled" />
                                <label for="inventory-combining-checkbox" class="checkbox-label">ç‰©å“åˆæˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-dismantling-checkbox" name="inventory.dismantling.enabled" />
                                <label for="inventory-dismantling-checkbox" class="checkbox-label">ç‰©å“åˆ†è§£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recycling-checkbox" name="inventory.recycling.enabled" />
                                <label for="inventory-recycling-checkbox" class="checkbox-label">å›æ”¶åˆ©ç”¨</label>
                            </div>
                        </div>
                    </div>

                    <!-- é«˜çº§åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-automation-checkbox" name="inventory.automation.enabled" />
                                <label for="inventory-automation-checkbox" class="checkbox-label">è‡ªåŠ¨åŒ–ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-ai-sorting-checkbox" name="inventory.aiSorting.enabled" />
                                <label for="inventory-ai-sorting-checkbox" class="checkbox-label">æ™ºèƒ½æ’åº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recommendations-checkbox" name="inventory.recommendations.enabled" />
                                <label for="inventory-recommendations-checkbox" class="checkbox-label">æ¨èç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-analytics-checkbox" name="inventory.analytics.enabled" />
                                <label for="inventory-analytics-checkbox" class="checkbox-label">ä½¿ç”¨åˆ†æ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-backup-checkbox" name="inventory.backup.enabled" />
                                <label for="inventory-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sync-checkbox" name="inventory.sync.enabled" />
                                <label for="inventory-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-security-checkbox" name="inventory.security.enabled" />
                                <label for="inventory-security-checkbox" class="checkbox-label">å®‰å…¨ä¿æŠ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-history-checkbox" name="inventory.history.enabled" />
                                <label for="inventory-history-checkbox" class="checkbox-label">æ“ä½œå†å²</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèƒ½åŠ›ç³»ç»Ÿé¢æ¿
     */
    createAbilitiesPanel() {
        return `
            <div class="content-header">
                <h3>èƒ½åŠ›ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èƒ½åŠ›ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">âš¡</div>
                            <div class="card-text">
                                <div class="card-title">èƒ½åŠ›ç³»ç»Ÿ</div>
                                <div class="card-subtitle">æŠ€èƒ½å’Œå±æ€§ç®¡ç†ç³»ç»Ÿ</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="abilities-toggle" name="abilities.enabled" checked />
                                <label for="abilities-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">25/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€å±æ€§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-strength-checkbox" name="abilities.strength.enabled" checked />
                                <label for="abilities-strength-checkbox" class="checkbox-label">åŠ›é‡å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-agility-checkbox" name="abilities.agility.enabled" checked />
                                <label for="abilities-agility-checkbox" class="checkbox-label">æ•æ·å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-intelligence-checkbox" name="abilities.intelligence.enabled" checked />
                                <label for="abilities-intelligence-checkbox" class="checkbox-label">æ™ºåŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-constitution-checkbox" name="abilities.constitution.enabled" />
                                <label for="abilities-constitution-checkbox" class="checkbox-label">ä½“è´¨å±æ€§</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-wisdom-checkbox" name="abilities.wisdom.enabled" />
                                <label for="abilities-wisdom-checkbox" class="checkbox-label">æ™ºæ…§å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-charisma-checkbox" name="abilities.charisma.enabled" />
                                <label for="abilities-charisma-checkbox" class="checkbox-label">é­…åŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-luck-checkbox" name="abilities.luck.enabled" />
                                <label for="abilities-luck-checkbox" class="checkbox-label">å¹¸è¿å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-perception-checkbox" name="abilities.perception.enabled" />
                                <label for="abilities-perception-checkbox" class="checkbox-label">æ„ŸçŸ¥å±æ€§</label>
                            </div>
                        </div>
                    </div>

                    <!-- æˆ˜æ–—æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-swordsmanship-checkbox" name="abilities.swordsmanship.enabled" checked />
                                <label for="abilities-swordsmanship-checkbox" class="checkbox-label">å‰‘æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-archery-checkbox" name="abilities.archery.enabled" />
                                <label for="abilities-archery-checkbox" class="checkbox-label">å¼“ç®­æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-magic-checkbox" name="abilities.magic.enabled" checked />
                                <label for="abilities-magic-checkbox" class="checkbox-label">é­”æ³•æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-defense-checkbox" name="abilities.defense.enabled" />
                                <label for="abilities-defense-checkbox" class="checkbox-label">é˜²å¾¡æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-martial-arts-checkbox" name="abilities.martialArts.enabled" />
                                <label for="abilities-martial-arts-checkbox" class="checkbox-label">æ­¦æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-stealth-checkbox" name="abilities.stealth.enabled" />
                                <label for="abilities-stealth-checkbox" class="checkbox-label">æ½œè¡ŒæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-tactics-checkbox" name="abilities.tactics.enabled" />
                                <label for="abilities-tactics-checkbox" class="checkbox-label">æˆ˜æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-healing-checkbox" name="abilities.healing.enabled" />
                                <label for="abilities-healing-checkbox" class="checkbox-label">æ²»ç–—æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿæ´»æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-crafting-checkbox" name="abilities.crafting.enabled" />
                                <label for="abilities-crafting-checkbox" class="checkbox-label">åˆ¶ä½œæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-cooking-checkbox" name="abilities.cooking.enabled" />
                                <label for="abilities-cooking-checkbox" class="checkbox-label">çƒ¹é¥ªæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-farming-checkbox" name="abilities.farming.enabled" />
                                <label for="abilities-farming-checkbox" class="checkbox-label">å†œä¸šæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-mining-checkbox" name="abilities.mining.enabled" />
                                <label for="abilities-mining-checkbox" class="checkbox-label">é‡‡çŸ¿æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-fishing-checkbox" name="abilities.fishing.enabled" />
                                <label for="abilities-fishing-checkbox" class="checkbox-label">é’“é±¼æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-hunting-checkbox" name="abilities.hunting.enabled" />
                                <label for="abilities-hunting-checkbox" class="checkbox-label">ç‹©çŒæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-trading-checkbox" name="abilities.trading.enabled" />
                                <label for="abilities-trading-checkbox" class="checkbox-label">äº¤æ˜“æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-negotiation-checkbox" name="abilities.negotiation.enabled" />
                                <label for="abilities-negotiation-checkbox" class="checkbox-label">è°ˆåˆ¤æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- çŸ¥è¯†æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-research-checkbox" name="abilities.research.enabled" />
                                <label for="abilities-research-checkbox" class="checkbox-label">ç ”ç©¶æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-investigation-checkbox" name="abilities.investigation.enabled" />
                                <label for="abilities-investigation-checkbox" class="checkbox-label">è°ƒæŸ¥æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-languages-checkbox" name="abilities.languages.enabled" />
                                <label for="abilities-languages-checkbox" class="checkbox-label">è¯­è¨€æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-history-checkbox" name="abilities.history.enabled" />
                                <label for="abilities-history-checkbox" class="checkbox-label">å†å²çŸ¥è¯†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-medicine-checkbox" name="abilities.medicine.enabled" />
                                <label for="abilities-medicine-checkbox" class="checkbox-label">åŒ»å­¦çŸ¥è¯†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-alchemy-checkbox" name="abilities.alchemy.enabled" />
                                <label for="abilities-alchemy-checkbox" class="checkbox-label">ç‚¼é‡‘æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-engineering-checkbox" name="abilities.engineering.enabled" />
                                <label for="abilities-engineering-checkbox" class="checkbox-label">å·¥ç¨‹å­¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-astronomy-checkbox" name="abilities.astronomy.enabled" />
                                <label for="abilities-astronomy-checkbox" class="checkbox-label">å¤©æ–‡å­¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾äº¤æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-persuasion-checkbox" name="abilities.persuasion.enabled" />
                                <label for="abilities-persuasion-checkbox" class="checkbox-label">è¯´æœæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-deception-checkbox" name="abilities.deception.enabled" />
                                <label for="abilities-deception-checkbox" class="checkbox-label">æ¬ºéª—æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-intimidation-checkbox" name="abilities.intimidation.enabled" />
                                <label for="abilities-intimidation-checkbox" class="checkbox-label">å¨å“æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-performance-checkbox" name="abilities.performance.enabled" />
                                <label for="abilities-performance-checkbox" class="checkbox-label">è¡¨æ¼”æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-leadership-checkbox" name="abilities.leadership.enabled" />
                                <label for="abilities-leadership-checkbox" class="checkbox-label">é¢†å¯¼æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-empathy-checkbox" name="abilities.empathy.enabled" />
                                <label for="abilities-empathy-checkbox" class="checkbox-label">å…±æƒ…æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-insight-checkbox" name="abilities.insight.enabled" />
                                <label for="abilities-insight-checkbox" class="checkbox-label">æ´å¯ŸæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-networking-checkbox" name="abilities.networking.enabled" />
                                <label for="abilities-networking-checkbox" class="checkbox-label">äººè„‰æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰¹æ®Šèƒ½åŠ› -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-telepathy-checkbox" name="abilities.telepathy.enabled" />
                                <label for="abilities-telepathy-checkbox" class="checkbox-label">å¿ƒçµæ„Ÿåº”</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-telekinesis-checkbox" name="abilities.telekinesis.enabled" />
                                <label for="abilities-telekinesis-checkbox" class="checkbox-label">å¿µåŠ›ç§»ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-precognition-checkbox" name="abilities.precognition.enabled" />
                                <label for="abilities-precognition-checkbox" class="checkbox-label">é¢„çŸ¥èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-shapeshifting-checkbox" name="abilities.shapeshifting.enabled" />
                                <label for="abilities-shapeshifting-checkbox" class="checkbox-label">å˜å½¢èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-invisibility-checkbox" name="abilities.invisibility.enabled" />
                                <label for="abilities-invisibility-checkbox" class="checkbox-label">éšèº«èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-flight-checkbox" name="abilities.flight.enabled" />
                                <label for="abilities-flight-checkbox" class="checkbox-label">é£è¡Œèƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-regeneration-checkbox" name="abilities.regeneration.enabled" />
                                <label for="abilities-regeneration-checkbox" class="checkbox-label">å†ç”Ÿèƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-immortality-checkbox" name="abilities.immortality.enabled" />
                                <label for="abilities-immortality-checkbox" class="checkbox-label">ä¸æœ½èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºå‰§æƒ…é¢æ¿
     */
    createPlotPanel() {
        return `
            <div class="content-header">
                <h3>å‰§æƒ…é¢æ¿é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- å‰§æƒ…é¢æ¿å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“–</div>
                            <div class="card-text">
                                <div class="card-title">å‰§æƒ…é¢æ¿</div>
                                <div class="card-subtitle">æ•…äº‹æƒ…èŠ‚å’Œå™äº‹ç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="plot-toggle" name="plot.enabled" checked />
                                <label for="plot-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">18/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- å‰§æƒ…ç»“æ„ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-main-story-checkbox" name="plot.mainStory.enabled" checked />
                                <label for="plot-main-story-checkbox" class="checkbox-label">ä¸»çº¿å‰§æƒ…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-side-quests-checkbox" name="plot.sideQuests.enabled" checked />
                                <label for="plot-side-quests-checkbox" class="checkbox-label">æ”¯çº¿ä»»åŠ¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-subplots-checkbox" name="plot.subplots.enabled" checked />
                                <label for="plot-subplots-checkbox" class="checkbox-label">å­æƒ…èŠ‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-backstory-checkbox" name="plot.backstory.enabled" />
                                <label for="plot-backstory-checkbox" class="checkbox-label">èƒŒæ™¯æ•…äº‹</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-prologue-checkbox" name="plot.prologue.enabled" />
                                <label for="plot-prologue-checkbox" class="checkbox-label">åºç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-epilogue-checkbox" name="plot.epilogue.enabled" />
                                <label for="plot-epilogue-checkbox" class="checkbox-label">å°¾å£°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-flashbacks-checkbox" name="plot.flashbacks.enabled" />
                                <label for="plot-flashbacks-checkbox" class="checkbox-label">å›å¿†ç‰‡æ®µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-foreshadowing-checkbox" name="plot.foreshadowing.enabled" />
                                <label for="plot-foreshadowing-checkbox" class="checkbox-label">ä¼ç¬”é“ºå«</label>
                            </div>
                        </div>
                    </div>

                    <!-- å‰§æƒ…é˜¶æ®µ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-exposition-checkbox" name="plot.exposition.enabled" checked />
                                <label for="plot-exposition-checkbox" class="checkbox-label">å¼€ç«¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-rising-action-checkbox" name="plot.risingAction.enabled" />
                                <label for="plot-rising-action-checkbox" class="checkbox-label">å‘å±•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-climax-checkbox" name="plot.climax.enabled" />
                                <label for="plot-climax-checkbox" class="checkbox-label">é«˜æ½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-falling-action-checkbox" name="plot.fallingAction.enabled" />
                                <label for="plot-falling-action-checkbox" class="checkbox-label">ä¸‹é™</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-resolution-checkbox" name="plot.resolution.enabled" />
                                <label for="plot-resolution-checkbox" class="checkbox-label">ç»“å±€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-denouement-checkbox" name="plot.denouement.enabled" />
                                <label for="plot-denouement-checkbox" class="checkbox-label">æ”¶å°¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-cliffhanger-checkbox" name="plot.cliffhanger.enabled" />
                                <label for="plot-cliffhanger-checkbox" class="checkbox-label">æ‚¬å¿µç»“å°¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-twist-checkbox" name="plot.twist.enabled" />
                                <label for="plot-twist-checkbox" class="checkbox-label">å‰§æƒ…è½¬æŠ˜</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§’è‰²å‘å±• -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-character-arc-checkbox" name="plot.characterArc.enabled" />
                                <label for="plot-character-arc-checkbox" class="checkbox-label">è§’è‰²æˆé•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-relationships-checkbox" name="plot.relationships.enabled" />
                                <label for="plot-relationships-checkbox" class="checkbox-label">å…³ç³»å‘å±•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-motivations-checkbox" name="plot.motivations.enabled" />
                                <label for="plot-motivations-checkbox" class="checkbox-label">åŠ¨æœºé©±åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-conflicts-checkbox" name="plot.conflicts.enabled" />
                                <label for="plot-conflicts-checkbox" class="checkbox-label">å†²çªçŸ›ç›¾</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-internal-conflicts-checkbox" name="plot.internalConflicts.enabled" />
                                <label for="plot-internal-conflicts-checkbox" class="checkbox-label">å†…å¿ƒå†²çª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-external-conflicts-checkbox" name="plot.externalConflicts.enabled" />
                                <label for="plot-external-conflicts-checkbox" class="checkbox-label">å¤–éƒ¨å†²çª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-moral-dilemmas-checkbox" name="plot.moralDilemmas.enabled" />
                                <label for="plot-moral-dilemmas-checkbox" class="checkbox-label">é“å¾·å›°å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-sacrifices-checkbox" name="plot.sacrifices.enabled" />
                                <label for="plot-sacrifices-checkbox" class="checkbox-label">ç‰ºç‰²é€‰æ‹©</label>
                            </div>
                        </div>
                    </div>

                    <!-- å™äº‹æŠ€å·§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-dialogue-checkbox" name="plot.dialogue.enabled" />
                                <label for="plot-dialogue-checkbox" class="checkbox-label">å¯¹è¯ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-narration-checkbox" name="plot.narration.enabled" />
                                <label for="plot-narration-checkbox" class="checkbox-label">å™è¿°æå†™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-monologue-checkbox" name="plot.monologue.enabled" />
                                <label for="plot-monologue-checkbox" class="checkbox-label">å†…å¿ƒç‹¬ç™½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-symbolism-checkbox" name="plot.symbolism.enabled" />
                                <label for="plot-symbolism-checkbox" class="checkbox-label">è±¡å¾éšå–»</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-themes-checkbox" name="plot.themes.enabled" />
                                <label for="plot-themes-checkbox" class="checkbox-label">ä¸»é¢˜è¡¨è¾¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-mood-checkbox" name="plot.mood.enabled" />
                                <label for="plot-mood-checkbox" class="checkbox-label">æ°›å›´è¥é€ </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-tone-checkbox" name="plot.tone.enabled" />
                                <label for="plot-tone-checkbox" class="checkbox-label">è¯­è°ƒé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-pacing-checkbox" name="plot.pacing.enabled" />
                                <label for="plot-pacing-checkbox" class="checkbox-label">èŠ‚å¥æ§åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº’åŠ¨å…ƒç´  -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-choices-checkbox" name="plot.choices.enabled" />
                                <label for="plot-choices-checkbox" class="checkbox-label">é€‰æ‹©åˆ†æ”¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-consequences-checkbox" name="plot.consequences.enabled" />
                                <label for="plot-consequences-checkbox" class="checkbox-label">åæœå½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-branching-checkbox" name="plot.branching.enabled" />
                                <label for="plot-branching-checkbox" class="checkbox-label">åˆ†æ”¯å‰§æƒ…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-multiple-endings-checkbox" name="plot.multipleEndings.enabled" />
                                <label for="plot-multiple-endings-checkbox" class="checkbox-label">å¤šé‡ç»“å±€</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-player-agency-checkbox" name="plot.playerAgency.enabled" />
                                <label for="plot-player-agency-checkbox" class="checkbox-label">ç©å®¶ä¸»å¯¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-emergent-narrative-checkbox" name="plot.emergentNarrative.enabled" />
                                <label for="plot-emergent-narrative-checkbox" class="checkbox-label">æ¶Œç°å™äº‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-procedural-generation-checkbox" name="plot.proceduralGeneration.enabled" />
                                <label for="plot-procedural-generation-checkbox" class="checkbox-label">ç¨‹åºç”Ÿæˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-adaptive-storytelling-checkbox" name="plot.adaptiveStorytelling.enabled" />
                                <label for="plot-adaptive-storytelling-checkbox" class="checkbox-label">è‡ªé€‚åº”å™äº‹</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç®¡ç†åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-timeline-checkbox" name="plot.timeline.enabled" />
                                <label for="plot-timeline-checkbox" class="checkbox-label">æ—¶é—´çº¿ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-notes-checkbox" name="plot.notes.enabled" />
                                <label for="plot-notes-checkbox" class="checkbox-label">å‰§æƒ…ç¬”è®°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-bookmarks-checkbox" name="plot.bookmarks.enabled" />
                                <label for="plot-bookmarks-checkbox" class="checkbox-label">é‡è¦èŠ‚ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-save-states-checkbox" name="plot.saveStates.enabled" />
                                <label for="plot-save-states-checkbox" class="checkbox-label">å­˜æ¡£ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-auto-save-checkbox" name="plot.autoSave.enabled" />
                                <label for="plot-auto-save-checkbox" class="checkbox-label">è‡ªåŠ¨ä¿å­˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-export-checkbox" name="plot.export.enabled" />
                                <label for="plot-export-checkbox" class="checkbox-label">å¯¼å‡ºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-import-checkbox" name="plot.import.enabled" />
                                <label for="plot-import-checkbox" class="checkbox-label">å¯¼å…¥åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-analytics-checkbox" name="plot.analytics.enabled" />
                                <label for="plot-analytics-checkbox" class="checkbox-label">å‰§æƒ…åˆ†æ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºä¿®ä»™ä¸–ç•Œé¢æ¿
     */
    createCultivationPanel() {
        return `
            <div class="content-header">
                <h3>ä¿®ä»™ä¸–ç•Œé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¿®ä»™ä¸–ç•Œå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">âš¡</div>
                            <div class="card-text">
                                <div class="card-title">ä¿®ä»™ä¸–ç•Œ</div>
                                <div class="card-subtitle">ä»™ä¾ ä¿®ç‚¼ä½“ç³»è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="cultivation-toggle" name="cultivation.enabled" checked />
                                <label for="cultivation-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">22/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ä¿®ç‚¼å¢ƒç•Œ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-qi-refining-checkbox" name="cultivation.qiRefining.enabled" checked />
                                <label for="cultivation-qi-refining-checkbox" class="checkbox-label">ç‚¼æ°”æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-foundation-checkbox" name="cultivation.foundation.enabled" checked />
                                <label for="cultivation-foundation-checkbox" class="checkbox-label">ç­‘åŸºæœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-golden-core-checkbox" name="cultivation.goldenCore.enabled" checked />
                                <label for="cultivation-golden-core-checkbox" class="checkbox-label">é‡‘ä¸¹æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-nascent-soul-checkbox" name="cultivation.nascentSoul.enabled" />
                                <label for="cultivation-nascent-soul-checkbox" class="checkbox-label">å…ƒå©´æœŸ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-soul-transformation-checkbox" name="cultivation.soulTransformation.enabled" />
                                <label for="cultivation-soul-transformation-checkbox" class="checkbox-label">åŒ–ç¥æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-void-refinement-checkbox" name="cultivation.voidRefinement.enabled" />
                                <label for="cultivation-void-refinement-checkbox" class="checkbox-label">ç‚¼è™šæœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-body-integration-checkbox" name="cultivation.bodyIntegration.enabled" />
                                <label for="cultivation-body-integration-checkbox" class="checkbox-label">åˆä½“æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-mahayana-checkbox" name="cultivation.mahayana.enabled" />
                                <label for="cultivation-mahayana-checkbox" class="checkbox-label">å¤§ä¹˜æœŸ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-tribulation-checkbox" name="cultivation.tribulation.enabled" />
                                <label for="cultivation-tribulation-checkbox" class="checkbox-label">æ¸¡åŠ«æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-immortal-checkbox" name="cultivation.immortal.enabled" />
                                <label for="cultivation-immortal-checkbox" class="checkbox-label">ä»™äººå¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-true-immortal-checkbox" name="cultivation.trueImmortal.enabled" />
                                <label for="cultivation-true-immortal-checkbox" class="checkbox-label">çœŸä»™å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-golden-immortal-checkbox" name="cultivation.goldenImmortal.enabled" />
                                <label for="cultivation-golden-immortal-checkbox" class="checkbox-label">é‡‘ä»™å¢ƒ</label>
                            </div>
                        </div>
                    </div>

                    <!-- åŠŸæ³•ä½“ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-breathing-technique-checkbox" name="cultivation.breathingTechnique.enabled" checked />
                                <label for="cultivation-breathing-technique-checkbox" class="checkbox-label">åçº³åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-body-refining-checkbox" name="cultivation.bodyRefining.enabled" />
                                <label for="cultivation-body-refining-checkbox" class="checkbox-label">ç‚¼ä½“åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-soul-cultivation-checkbox" name="cultivation.soulCultivation.enabled" />
                                <label for="cultivation-soul-cultivation-checkbox" class="checkbox-label">ç¥é­‚åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dual-cultivation-checkbox" name="cultivation.dualCultivation.enabled" />
                                <label for="cultivation-dual-cultivation-checkbox" class="checkbox-label">åŒä¿®åŠŸæ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-sword-cultivation-checkbox" name="cultivation.swordCultivation.enabled" />
                                <label for="cultivation-sword-cultivation-checkbox" class="checkbox-label">å‰‘ä¿®åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-alchemy-checkbox" name="cultivation.alchemy.enabled" />
                                <label for="cultivation-alchemy-checkbox" class="checkbox-label">ç‚¼ä¸¹æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-formation-checkbox" name="cultivation.formation.enabled" />
                                <label for="cultivation-formation-checkbox" class="checkbox-label">é˜µæ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-talisman-checkbox" name="cultivation.talisman.enabled" />
                                <label for="cultivation-talisman-checkbox" class="checkbox-label">ç¬¦ç®“æœ¯</label>
                            </div>
                        </div>
                    </div>

                    <!-- çµåŠ›ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-power-checkbox" name="cultivation.spiritualPower.enabled" checked />
                                <label for="cultivation-spiritual-power-checkbox" class="checkbox-label">çµåŠ›å€¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-root-checkbox" name="cultivation.spiritualRoot.enabled" />
                                <label for="cultivation-spiritual-root-checkbox" class="checkbox-label">çµæ ¹èµ„è´¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-meridians-checkbox" name="cultivation.meridians.enabled" />
                                <label for="cultivation-meridians-checkbox" class="checkbox-label">ç»è„‰ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dantian-checkbox" name="cultivation.dantian.enabled" />
                                <label for="cultivation-dantian-checkbox" class="checkbox-label">ä¸¹ç”°æ°”æµ·</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-divine-sense-checkbox" name="cultivation.divineSense.enabled" />
                                <label for="cultivation-divine-sense-checkbox" class="checkbox-label">ç¥è¯†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-life-span-checkbox" name="cultivation.lifeSpan.enabled" />
                                <label for="cultivation-life-span-checkbox" class="checkbox-label">å¯¿å…ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-karma-checkbox" name="cultivation.karma.enabled" />
                                <label for="cultivation-karma-checkbox" class="checkbox-label">å› æœä¸šåŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-heavenly-dao-checkbox" name="cultivation.heavenlyDao.enabled" />
                                <label for="cultivation-heavenly-dao-checkbox" class="checkbox-label">å¤©é“æ„Ÿæ‚Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ³•å®è£…å¤‡ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-flying-sword-checkbox" name="cultivation.flyingSword.enabled" />
                                <label for="cultivation-flying-sword-checkbox" class="checkbox-label">é£å‰‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-magic-treasure-checkbox" name="cultivation.magicTreasure.enabled" />
                                <label for="cultivation-magic-treasure-checkbox" class="checkbox-label">æ³•å®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-armor-checkbox" name="cultivation.spiritualArmor.enabled" />
                                <label for="cultivation-spiritual-armor-checkbox" class="checkbox-label">çµç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-storage-ring-checkbox" name="cultivation.storageRing.enabled" />
                                <label for="cultivation-storage-ring-checkbox" class="checkbox-label">å‚¨ç‰©æˆ’</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-beast-checkbox" name="cultivation.spiritBeast.enabled" />
                                <label for="cultivation-spirit-beast-checkbox" class="checkbox-label">çµå…½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-puppet-checkbox" name="cultivation.puppet.enabled" />
                                <label for="cultivation-puppet-checkbox" class="checkbox-label">å‚€å„¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-avatar-checkbox" name="cultivation.avatar.enabled" />
                                <label for="cultivation-avatar-checkbox" class="checkbox-label">åŒ–èº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-clone-checkbox" name="cultivation.clone.enabled" />
                                <label for="cultivation-clone-checkbox" class="checkbox-label">åˆ†èº«</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®ç‚¼èµ„æº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-stone-checkbox" name="cultivation.spiritStone.enabled" />
                                <label for="cultivation-spirit-stone-checkbox" class="checkbox-label">çµçŸ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-herb-checkbox" name="cultivation.spiritHerb.enabled" />
                                <label for="cultivation-spirit-herb-checkbox" class="checkbox-label">çµè‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-pill-checkbox" name="cultivation.pill.enabled" />
                                <label for="cultivation-pill-checkbox" class="checkbox-label">ä¸¹è¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-vein-checkbox" name="cultivation.spiritVein.enabled" />
                                <label for="cultivation-spirit-vein-checkbox" class="checkbox-label">çµè„‰</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-cave-mansion-checkbox" name="cultivation.caveMansion.enabled" />
                                <label for="cultivation-cave-mansion-checkbox" class="checkbox-label">æ´åºœ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-secret-realm-checkbox" name="cultivation.secretRealm.enabled" />
                                <label for="cultivation-secret-realm-checkbox" class="checkbox-label">ç§˜å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-inheritance-checkbox" name="cultivation.inheritance.enabled" />
                                <label for="cultivation-inheritance-checkbox" class="checkbox-label">ä¼ æ‰¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-opportunity-checkbox" name="cultivation.opportunity.enabled" />
                                <label for="cultivation-opportunity-checkbox" class="checkbox-label">æœºç¼˜</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®ç‚¼æ´»åŠ¨ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-meditation-checkbox" name="cultivation.meditation.enabled" />
                                <label for="cultivation-meditation-checkbox" class="checkbox-label">æ‰“åä¿®ç‚¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-tribulation-crossing-checkbox" name="cultivation.tribulationCrossing.enabled" />
                                <label for="cultivation-tribulation-crossing-checkbox" class="checkbox-label">æ¸¡åŠ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-enlightenment-checkbox" name="cultivation.enlightenment.enabled" />
                                <label for="cultivation-enlightenment-checkbox" class="checkbox-label">é¡¿æ‚Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-breakthrough-checkbox" name="cultivation.breakthrough.enabled" />
                                <label for="cultivation-breakthrough-checkbox" class="checkbox-label">çªç ´</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-sect-checkbox" name="cultivation.sect.enabled" />
                                <label for="cultivation-sect-checkbox" class="checkbox-label">å®—é—¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-master-disciple-checkbox" name="cultivation.masterDisciple.enabled" />
                                <label for="cultivation-master-disciple-checkbox" class="checkbox-label">å¸ˆå¾’å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dao-companion-checkbox" name="cultivation.daoCompanion.enabled" />
                                <label for="cultivation-dao-companion-checkbox" class="checkbox-label">é“ä¾£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-immortal-ascension-checkbox" name="cultivation.immortalAscension.enabled" />
                                <label for="cultivation-immortal-ascension-checkbox" class="checkbox-label">é£å‡</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºç„å¹»ä¸–ç•Œé¢æ¿
     */
    createFantasyPanel() {
        return `
            <div class="content-header">
                <h3>ç„å¹»ä¸–ç•Œé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ç„å¹»ä¸–ç•Œå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‰</div>
                            <div class="card-text">
                                <div class="card-title">ç„å¹»ä¸–ç•Œ</div>
                                <div class="card-subtitle">å¥‡å¹»é­”æ³•ä¸–ç•Œè®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="fantasy-toggle" name="fantasy.enabled" checked />
                                <label for="fantasy-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">19/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ç§æ—ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-human-checkbox" name="fantasy.human.enabled" checked />
                                <label for="fantasy-human-checkbox" class="checkbox-label">äººç±»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-elf-checkbox" name="fantasy.elf.enabled" checked />
                                <label for="fantasy-elf-checkbox" class="checkbox-label">ç²¾çµ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dwarf-checkbox" name="fantasy.dwarf.enabled" checked />
                                <label for="fantasy-dwarf-checkbox" class="checkbox-label">çŸ®äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-orc-checkbox" name="fantasy.orc.enabled" />
                                <label for="fantasy-orc-checkbox" class="checkbox-label">å…½äºº</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dragon-checkbox" name="fantasy.dragon.enabled" />
                                <label for="fantasy-dragon-checkbox" class="checkbox-label">é¾™æ—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-demon-checkbox" name="fantasy.demon.enabled" />
                                <label for="fantasy-demon-checkbox" class="checkbox-label">é­”æ—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-angel-checkbox" name="fantasy.angel.enabled" />
                                <label for="fantasy-angel-checkbox" class="checkbox-label">å¤©ä½¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-undead-checkbox" name="fantasy.undead.enabled" />
                                <label for="fantasy-undead-checkbox" class="checkbox-label">ä¸æ­»æ—</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-halfling-checkbox" name="fantasy.halfling.enabled" />
                                <label for="fantasy-halfling-checkbox" class="checkbox-label">åŠèº«äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-giant-checkbox" name="fantasy.giant.enabled" />
                                <label for="fantasy-giant-checkbox" class="checkbox-label">å·¨äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-fairy-checkbox" name="fantasy.fairy.enabled" />
                                <label for="fantasy-fairy-checkbox" class="checkbox-label">å¦–ç²¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-vampire-checkbox" name="fantasy.vampire.enabled" />
                                <label for="fantasy-vampire-checkbox" class="checkbox-label">å¸è¡€é¬¼</label>
                            </div>
                        </div>
                    </div>

                    <!-- é­”æ³•ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-fire-magic-checkbox" name="fantasy.fireMagic.enabled" checked />
                                <label for="fantasy-fire-magic-checkbox" class="checkbox-label">ç«ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-water-magic-checkbox" name="fantasy.waterMagic.enabled" />
                                <label for="fantasy-water-magic-checkbox" class="checkbox-label">æ°´ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-earth-magic-checkbox" name="fantasy.earthMagic.enabled" />
                                <label for="fantasy-earth-magic-checkbox" class="checkbox-label">åœŸç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-air-magic-checkbox" name="fantasy.airMagic.enabled" />
                                <label for="fantasy-air-magic-checkbox" class="checkbox-label">é£ç³»é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-light-magic-checkbox" name="fantasy.lightMagic.enabled" />
                                <label for="fantasy-light-magic-checkbox" class="checkbox-label">å…‰ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dark-magic-checkbox" name="fantasy.darkMagic.enabled" />
                                <label for="fantasy-dark-magic-checkbox" class="checkbox-label">æš—ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-nature-magic-checkbox" name="fantasy.natureMagic.enabled" />
                                <label for="fantasy-nature-magic-checkbox" class="checkbox-label">è‡ªç„¶é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-space-magic-checkbox" name="fantasy.spaceMagic.enabled" />
                                <label for="fantasy-space-magic-checkbox" class="checkbox-label">ç©ºé—´é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-time-magic-checkbox" name="fantasy.timeMagic.enabled" />
                                <label for="fantasy-time-magic-checkbox" class="checkbox-label">æ—¶é—´é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-necromancy-checkbox" name="fantasy.necromancy.enabled" />
                                <label for="fantasy-necromancy-checkbox" class="checkbox-label">æ­»çµé­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-illusion-magic-checkbox" name="fantasy.illusionMagic.enabled" />
                                <label for="fantasy-illusion-magic-checkbox" class="checkbox-label">å¹»æœ¯é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-enchantment-checkbox" name="fantasy.enchantment.enabled" />
                                <label for="fantasy-enchantment-checkbox" class="checkbox-label">é™„é­”é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <!-- èŒä¸šç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-warrior-checkbox" name="fantasy.warrior.enabled" />
                                <label for="fantasy-warrior-checkbox" class="checkbox-label">æˆ˜å£«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-mage-checkbox" name="fantasy.mage.enabled" />
                                <label for="fantasy-mage-checkbox" class="checkbox-label">æ³•å¸ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-archer-checkbox" name="fantasy.archer.enabled" />
                                <label for="fantasy-archer-checkbox" class="checkbox-label">å¼“ç®­æ‰‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-rogue-checkbox" name="fantasy.rogue.enabled" />
                                <label for="fantasy-rogue-checkbox" class="checkbox-label">ç›—è´¼</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-priest-checkbox" name="fantasy.priest.enabled" />
                                <label for="fantasy-priest-checkbox" class="checkbox-label">ç‰§å¸ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-paladin-checkbox" name="fantasy.paladin.enabled" />
                                <label for="fantasy-paladin-checkbox" class="checkbox-label">åœ£éª‘å£«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-druid-checkbox" name="fantasy.druid.enabled" />
                                <label for="fantasy-druid-checkbox" class="checkbox-label">å¾·é²ä¼Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-warlock-checkbox" name="fantasy.warlock.enabled" />
                                <label for="fantasy-warlock-checkbox" class="checkbox-label">æœ¯å£«</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-bard-checkbox" name="fantasy.bard.enabled" />
                                <label for="fantasy-bard-checkbox" class="checkbox-label">åŸæ¸¸è¯—äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-monk-checkbox" name="fantasy.monk.enabled" />
                                <label for="fantasy-monk-checkbox" class="checkbox-label">æ­¦åƒ§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-ranger-checkbox" name="fantasy.ranger.enabled" />
                                <label for="fantasy-ranger-checkbox" class="checkbox-label">æ¸¸ä¾ </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-assassin-checkbox" name="fantasy.assassin.enabled" />
                                <label for="fantasy-assassin-checkbox" class="checkbox-label">åˆºå®¢</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¥è¯ç”Ÿç‰© -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-phoenix-checkbox" name="fantasy.phoenix.enabled" />
                                <label for="fantasy-phoenix-checkbox" class="checkbox-label">å‡¤å‡°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-unicorn-checkbox" name="fantasy.unicorn.enabled" />
                                <label for="fantasy-unicorn-checkbox" class="checkbox-label">ç‹¬è§’å…½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-griffin-checkbox" name="fantasy.griffin.enabled" />
                                <label for="fantasy-griffin-checkbox" class="checkbox-label">ç‹®é¹«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-pegasus-checkbox" name="fantasy.pegasus.enabled" />
                                <label for="fantasy-pegasus-checkbox" class="checkbox-label">é£é©¬</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-kraken-checkbox" name="fantasy.kraken.enabled" />
                                <label for="fantasy-kraken-checkbox" class="checkbox-label">æµ·å¦–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-chimera-checkbox" name="fantasy.chimera.enabled" />
                                <label for="fantasy-chimera-checkbox" class="checkbox-label">å¥‡ç¾æ‹‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-basilisk-checkbox" name="fantasy.basilisk.enabled" />
                                <label for="fantasy-basilisk-checkbox" class="checkbox-label">è›‡æ€ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-hydra-checkbox" name="fantasy.hydra.enabled" />
                                <label for="fantasy-hydra-checkbox" class="checkbox-label">ä¹å¤´è›‡</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¥å™¨è£…å¤‡ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-legendary-weapon-checkbox" name="fantasy.legendaryWeapon.enabled" />
                                <label for="fantasy-legendary-weapon-checkbox" class="checkbox-label">ä¼ è¯´æ­¦å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-magic-armor-checkbox" name="fantasy.magicArmor.enabled" />
                                <label for="fantasy-magic-armor-checkbox" class="checkbox-label">é­”æ³•æŠ¤ç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-artifact-checkbox" name="fantasy.artifact.enabled" />
                                <label for="fantasy-artifact-checkbox" class="checkbox-label">ç¥å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-relic-checkbox" name="fantasy.relic.enabled" />
                                <label for="fantasy-relic-checkbox" class="checkbox-label">åœ£é—ç‰©</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-magic-crystal-checkbox" name="fantasy.magicCrystal.enabled" />
                                <label for="fantasy-magic-crystal-checkbox" class="checkbox-label">é­”æ³•æ°´æ™¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-enchanted-item-checkbox" name="fantasy.enchantedItem.enabled" />
                                <label for="fantasy-enchanted-item-checkbox" class="checkbox-label">é™„é­”ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-potion-checkbox" name="fantasy.potion.enabled" />
                                <label for="fantasy-potion-checkbox" class="checkbox-label">é­”æ³•è¯å‰‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-scroll-checkbox" name="fantasy.scroll.enabled" />
                                <label for="fantasy-scroll-checkbox" class="checkbox-label">é­”æ³•å·è½´</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºéƒ½å¸‚ç°ä»£é¢æ¿
     */
    createModernPanel() {
        return `
            <div class="content-header">
                <h3>éƒ½å¸‚ç°ä»£é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- éƒ½å¸‚ç°ä»£å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ™ï¸</div>
                            <div class="card-text">
                                <div class="card-title">éƒ½å¸‚ç°ä»£</div>
                                <div class="card-subtitle">ç°ä»£éƒ½å¸‚ç”Ÿæ´»è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="modern-toggle" name="modern.enabled" checked />
                                <label for="modern-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">8/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ™ï¸ åŸå¸‚ç”Ÿæ´»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-city-checkbox" name="modern.city.enabled" checked />
                                <label for="modern-city-checkbox" class="checkbox-label">å±…ä½åŸå¸‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-district-checkbox" name="modern.district.enabled" checked />
                                <label for="modern-district-checkbox" class="checkbox-label">æ‰€åœ¨åŒºåŸŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-housing-checkbox" name="modern.housing.enabled" />
                                <label for="modern-housing-checkbox" class="checkbox-label">ä½æˆ¿ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-transport-checkbox" name="modern.transport.enabled" checked />
                                <label for="modern-transport-checkbox" class="checkbox-label">äº¤é€šæ–¹å¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-neighborhood-checkbox" name="modern.neighborhood.enabled" />
                                <label for="modern-neighborhood-checkbox" class="checkbox-label">ç¤¾åŒºç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-facilities-checkbox" name="modern.facilities.enabled" />
                                <label for="modern-facilities-checkbox" class="checkbox-label">å‘¨è¾¹è®¾æ–½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-cost-checkbox" name="modern.cost.enabled" />
                                <label for="modern-cost-checkbox" class="checkbox-label">ç”Ÿæ´»æˆæœ¬</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-safety-checkbox" name="modern.safety.enabled" />
                                <label for="modern-safety-checkbox" class="checkbox-label">å®‰å…¨æŒ‡æ•°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-pollution-checkbox" name="modern.pollution.enabled" />
                                <label for="modern-pollution-checkbox" class="checkbox-label">ç¯å¢ƒè´¨é‡</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’¼ èŒä¸šå‘å±•</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-job-checkbox" name="modern.job.enabled" checked />
                                <label for="modern-job-checkbox" class="checkbox-label">å½“å‰èŒä¸š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-company-checkbox" name="modern.company.enabled" />
                                <label for="modern-company-checkbox" class="checkbox-label">å·¥ä½œå•ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-position-checkbox" name="modern.position.enabled" />
                                <label for="modern-position-checkbox" class="checkbox-label">èŒä½çº§åˆ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-income-checkbox" name="modern.income.enabled" checked />
                                <label for="modern-income-checkbox" class="checkbox-label">æ”¶å…¥æ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-worktime-checkbox" name="modern.worktime.enabled" />
                                <label for="modern-worktime-checkbox" class="checkbox-label">å·¥ä½œæ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-benefits-checkbox" name="modern.benefits.enabled" />
                                <label for="modern-benefits-checkbox" class="checkbox-label">ç¦åˆ©å¾…é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-career-checkbox" name="modern.career.enabled" />
                                <label for="modern-career-checkbox" class="checkbox-label">èŒä¸šè§„åˆ’</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-skills-checkbox" name="modern.skills.enabled" />
                                <label for="modern-skills-checkbox" class="checkbox-label">ä¸“ä¸šæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-education-checkbox" name="modern.education.enabled" />
                                <label for="modern-education-checkbox" class="checkbox-label">æ•™è‚²èƒŒæ™¯</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“± ç§‘æŠ€ç”Ÿæ´»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-smartphone-checkbox" name="modern.smartphone.enabled" checked />
                                <label for="modern-smartphone-checkbox" class="checkbox-label">æ™ºèƒ½æ‰‹æœº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-computer-checkbox" name="modern.computer.enabled" />
                                <label for="modern-computer-checkbox" class="checkbox-label">ç”µè„‘è®¾å¤‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-internet-checkbox" name="modern.internet.enabled" />
                                <label for="modern-internet-checkbox" class="checkbox-label">ç½‘ç»œä½¿ç”¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-social-checkbox" name="modern.social.enabled" checked />
                                <label for="modern-social-checkbox" class="checkbox-label">ç¤¾äº¤åª’ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-gaming-checkbox" name="modern.gaming.enabled" />
                                <label for="modern-gaming-checkbox" class="checkbox-label">æ¸¸æˆå¨±ä¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-streaming-checkbox" name="modern.streaming.enabled" />
                                <label for="modern-streaming-checkbox" class="checkbox-label">è§†é¢‘å¹³å°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-shopping-checkbox" name="modern.shopping.enabled" />
                                <label for="modern-shopping-checkbox" class="checkbox-label">åœ¨çº¿è´­ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-payment-checkbox" name="modern.payment.enabled" />
                                <label for="modern-payment-checkbox" class="checkbox-label">ç§»åŠ¨æ”¯ä»˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-ai-checkbox" name="modern.ai.enabled" />
                                <label for="modern-ai-checkbox" class="checkbox-label">AIåŠ©æ‰‹</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ¥ å¥åº·ç®¡ç†</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-health-checkbox" name="modern.health.enabled" />
                                <label for="modern-health-checkbox" class="checkbox-label">å¥åº·çŠ¶å†µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-fitness-checkbox" name="modern.fitness.enabled" />
                                <label for="modern-fitness-checkbox" class="checkbox-label">å¥èº«ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-diet-checkbox" name="modern.diet.enabled" />
                                <label for="modern-diet-checkbox" class="checkbox-label">é¥®é£Ÿä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-sleep-checkbox" name="modern.sleep.enabled" />
                                <label for="modern-sleep-checkbox" class="checkbox-label">ç¡çœ è´¨é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-medical-checkbox" name="modern.medical.enabled" />
                                <label for="modern-medical-checkbox" class="checkbox-label">åŒ»ç–—ä¿é™©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-stress-checkbox" name="modern.stress.enabled" />
                                <label for="modern-stress-checkbox" class="checkbox-label">å‹åŠ›ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-mental-checkbox" name="modern.mental.enabled" />
                                <label for="modern-mental-checkbox" class="checkbox-label">å¿ƒç†å¥åº·</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-checkup-checkbox" name="modern.checkup.enabled" />
                                <label for="modern-checkup-checkbox" class="checkbox-label">å®šæœŸä½“æ£€</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ›ï¸ æ¶ˆè´¹ä¹ æƒ¯</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-budget-checkbox" name="modern.budget.enabled" />
                                <label for="modern-budget-checkbox" class="checkbox-label">æ¶ˆè´¹é¢„ç®—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-brands-checkbox" name="modern.brands.enabled" />
                                <label for="modern-brands-checkbox" class="checkbox-label">å“ç‰Œåå¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-fashion-checkbox" name="modern.fashion.enabled" />
                                <label for="modern-fashion-checkbox" class="checkbox-label">æ—¶å°šé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-luxury-checkbox" name="modern.luxury.enabled" />
                                <label for="modern-luxury-checkbox" class="checkbox-label">å¥¢ä¾ˆå“æ¶ˆè´¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-investment-checkbox" name="modern.investment.enabled" />
                                <label for="modern-investment-checkbox" class="checkbox-label">æŠ•èµ„ç†è´¢</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-saving-checkbox" name="modern.saving.enabled" />
                                <label for="modern-saving-checkbox" class="checkbox-label">å‚¨è“„ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-credit-checkbox" name="modern.credit.enabled" />
                                <label for="modern-credit-checkbox" class="checkbox-label">ä¿¡ç”¨è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-insurance-checkbox" name="modern.insurance.enabled" />
                                <label for="modern-insurance-checkbox" class="checkbox-label">ä¿é™©é…ç½®</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ­ å¨±ä¹ä¼‘é—²</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-movies-checkbox" name="modern.movies.enabled" />
                                <label for="modern-movies-checkbox" class="checkbox-label">ç”µå½±åå¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-music-checkbox" name="modern.music.enabled" />
                                <label for="modern-music-checkbox" class="checkbox-label">éŸ³ä¹å“å‘³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-books-checkbox" name="modern.books.enabled" />
                                <label for="modern-books-checkbox" class="checkbox-label">é˜…è¯»ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-travel-checkbox" name="modern.travel.enabled" />
                                <label for="modern-travel-checkbox" class="checkbox-label">æ—…è¡Œç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-sports-checkbox" name="modern.sports.enabled" />
                                <label for="modern-sports-checkbox" class="checkbox-label">è¿åŠ¨çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-hobbies-checkbox" name="modern.hobbies.enabled" />
                                <label for="modern-hobbies-checkbox" class="checkbox-label">å…´è¶£çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-clubs-checkbox" name="modern.clubs.enabled" />
                                <label for="modern-clubs-checkbox" class="checkbox-label">ç¤¾å›¢æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-events-checkbox" name="modern.events.enabled" />
                                <label for="modern-events-checkbox" class="checkbox-label">æ´»åŠ¨å‚ä¸</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºå†å²å¤ä»£é¢æ¿
     */
    createHistoricalPanel() {
        return `
            <div class="content-header">
                <h3>å†å²å¤ä»£é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- å†å²å¤ä»£å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ›ï¸</div>
                            <div class="card-text">
                                <div class="card-title">å†å²å¤ä»£</div>
                                <div class="card-subtitle">å¤ä»£å†å²èƒŒæ™¯è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="historical-toggle" name="historical.enabled" checked />
                                <label for="historical-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">7/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ›ï¸ æœä»£èƒŒæ™¯</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-dynasty-checkbox" name="historical.dynasty.enabled" checked />
                                <label for="historical-dynasty-checkbox" class="checkbox-label">å†å²æœä»£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-period-checkbox" name="historical.period.enabled" checked />
                                <label for="historical-period-checkbox" class="checkbox-label">å†å²æ—¶æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-emperor-checkbox" name="historical.emperor.enabled" />
                                <label for="historical-emperor-checkbox" class="checkbox-label">åœ¨ä½çš‡å¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-capital-checkbox" name="historical.capital.enabled" />
                                <label for="historical-capital-checkbox" class="checkbox-label">éƒ½åŸä½ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-region-checkbox" name="historical.region.enabled" />
                                <label for="historical-region-checkbox" class="checkbox-label">æ‰€åœ¨å·åºœ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-events-checkbox" name="historical.events.enabled" />
                                <label for="historical-events-checkbox" class="checkbox-label">é‡å¤§äº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-wars-checkbox" name="historical.wars.enabled" />
                                <label for="historical-wars-checkbox" class="checkbox-label">æˆ˜äº‰èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-politics-checkbox" name="historical.politics.enabled" />
                                <label for="historical-politics-checkbox" class="checkbox-label">æ”¿æ²»ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-economy-checkbox" name="historical.economy.enabled" />
                                <label for="historical-economy-checkbox" class="checkbox-label">ç»æµçŠ¶å†µ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ‘‘ ç¤¾ä¼šåœ°ä½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-class-checkbox" name="historical.class.enabled" checked />
                                <label for="historical-class-checkbox" class="checkbox-label">ç¤¾ä¼šé˜¶å±‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-title-checkbox" name="historical.title.enabled" />
                                <label for="historical-title-checkbox" class="checkbox-label">å®˜èŒçˆµä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-family-checkbox" name="historical.family.enabled" checked />
                                <label for="historical-family-checkbox" class="checkbox-label">å®¶æ—èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-wealth-checkbox" name="historical.wealth.enabled" />
                                <label for="historical-wealth-checkbox" class="checkbox-label">è´¢å¯ŒçŠ¶å†µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-land-checkbox" name="historical.land.enabled" />
                                <label for="historical-land-checkbox" class="checkbox-label">åœŸåœ°è´¢äº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-servants-checkbox" name="historical.servants.enabled" />
                                <label for="historical-servants-checkbox" class="checkbox-label">ä»†ä»éšä»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-influence-checkbox" name="historical.influence.enabled" />
                                <label for="historical-influence-checkbox" class="checkbox-label">æ”¿æ²»å½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-reputation-checkbox" name="historical.reputation.enabled" />
                                <label for="historical-reputation-checkbox" class="checkbox-label">ç¤¾ä¼šå£°æœ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-connections-checkbox" name="historical.connections.enabled" />
                                <label for="historical-connections-checkbox" class="checkbox-label">äººè„‰å…³ç³»</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“š æ–‡åŒ–ä¿®å…»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-education-checkbox" name="historical.education.enabled" checked />
                                <label for="historical-education-checkbox" class="checkbox-label">æ•™è‚²ç¨‹åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-poetry-checkbox" name="historical.poetry.enabled" />
                                <label for="historical-poetry-checkbox" class="checkbox-label">è¯—è¯æ­Œèµ‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-calligraphy-checkbox" name="historical.calligraphy.enabled" />
                                <label for="historical-calligraphy-checkbox" class="checkbox-label">ä¹¦æ³•ç»˜ç”»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-music-checkbox" name="historical.music.enabled" />
                                <label for="historical-music-checkbox" class="checkbox-label">éŸ³å¾‹ä¹å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-chess-checkbox" name="historical.chess.enabled" />
                                <label for="historical-chess-checkbox" class="checkbox-label">æ£‹è‰ºåšå¼ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-classics-checkbox" name="historical.classics.enabled" />
                                <label for="historical-classics-checkbox" class="checkbox-label">ç»å²å­é›†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-philosophy-checkbox" name="historical.philosophy.enabled" />
                                <label for="historical-philosophy-checkbox" class="checkbox-label">å“²å­¦æ€æƒ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-etiquette-checkbox" name="historical.etiquette.enabled" />
                                <label for="historical-etiquette-checkbox" class="checkbox-label">ç¤¼ä»ªè§„èŒƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-language-checkbox" name="historical.language.enabled" />
                                <label for="historical-language-checkbox" class="checkbox-label">è¯­è¨€æ–‡å­—</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš”ï¸ æ­¦è‰ºæŠ€èƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-martial-checkbox" name="historical.martial.enabled" checked />
                                <label for="historical-martial-checkbox" class="checkbox-label">æ­¦è‰ºæ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-weapons-checkbox" name="historical.weapons.enabled" />
                                <label for="historical-weapons-checkbox" class="checkbox-label">å…µå™¨ä½¿ç”¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-archery-checkbox" name="historical.archery.enabled" />
                                <label for="historical-archery-checkbox" class="checkbox-label">å¼“ç®­å°„æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-horsemanship-checkbox" name="historical.horsemanship.enabled" />
                                <label for="historical-horsemanship-checkbox" class="checkbox-label">éª‘æœ¯é©¬æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-strategy-checkbox" name="historical.strategy.enabled" />
                                <label for="historical-strategy-checkbox" class="checkbox-label">å…µæ³•æˆ˜ç•¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-bodyguard-checkbox" name="historical.bodyguard.enabled" />
                                <label for="historical-bodyguard-checkbox" class="checkbox-label">æŠ¤å«æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-hunting-checkbox" name="historical.hunting.enabled" />
                                <label for="historical-hunting-checkbox" class="checkbox-label">ç‹©çŒæŠ€å·§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-survival-checkbox" name="historical.survival.enabled" />
                                <label for="historical-survival-checkbox" class="checkbox-label">é‡å¤–ç”Ÿå­˜</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ  ç”Ÿæ´»æ–¹å¼</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-residence-checkbox" name="historical.residence.enabled" />
                                <label for="historical-residence-checkbox" class="checkbox-label">å±…ä½ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-clothing-checkbox" name="historical.clothing.enabled" checked />
                                <label for="historical-clothing-checkbox" class="checkbox-label">æœé¥°ç©¿ç€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-food-checkbox" name="historical.food.enabled" />
                                <label for="historical-food-checkbox" class="checkbox-label">é¥®é£Ÿä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-transport-checkbox" name="historical.transport.enabled" />
                                <label for="historical-transport-checkbox" class="checkbox-label">å‡ºè¡Œæ–¹å¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-entertainment-checkbox" name="historical.entertainment.enabled" />
                                <label for="historical-entertainment-checkbox" class="checkbox-label">å¨±ä¹æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-festivals-checkbox" name="historical.festivals.enabled" />
                                <label for="historical-festivals-checkbox" class="checkbox-label">èŠ‚åº†ä¹ ä¿—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-religion-checkbox" name="historical.religion.enabled" />
                                <label for="historical-religion-checkbox" class="checkbox-label">å®—æ•™ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-medicine-checkbox" name="historical.medicine.enabled" />
                                <label for="historical-medicine-checkbox" class="checkbox-label">åŒ»è¯çŸ¥è¯†</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’¼ èŒä¸šæŠ€èƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-profession-checkbox" name="historical.profession.enabled" checked />
                                <label for="historical-profession-checkbox" class="checkbox-label">èŒä¸šèº«ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-crafts-checkbox" name="historical.crafts.enabled" />
                                <label for="historical-crafts-checkbox" class="checkbox-label">æ‰‹å·¥æŠ€è‰º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-trade-checkbox" name="historical.trade.enabled" />
                                <label for="historical-trade-checkbox" class="checkbox-label">å•†è´¸ç»è¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-farming-checkbox" name="historical.farming.enabled" />
                                <label for="historical-farming-checkbox" class="checkbox-label">å†œä¸šç§æ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-administration-checkbox" name="historical.administration.enabled" />
                                <label for="historical-administration-checkbox" class="checkbox-label">è¡Œæ”¿ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-teaching-checkbox" name="historical.teaching.enabled" />
                                <label for="historical-teaching-checkbox" class="checkbox-label">æ•™å­¦ä¼ æˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-healing-checkbox" name="historical.healing.enabled" />
                                <label for="historical-healing-checkbox" class="checkbox-label">åŒ»æœ¯æ²»ç–—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-construction-checkbox" name="historical.construction.enabled" />
                                <label for="historical-construction-checkbox" class="checkbox-label">å»ºç­‘è¥é€ </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºé­”æ³•èƒ½åŠ›é¢æ¿
     */
    createMagicPanel() {
        return `
            <div class="content-header">
                <h3>é­”æ³•èƒ½åŠ›é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- é­”æ³•èƒ½åŠ›å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ”®</div>
                            <div class="card-text">
                                <div class="card-title">é­”æ³•èƒ½åŠ›</div>
                                <div class="card-subtitle">é­”æ³•ç³»ç»Ÿèƒ½åŠ›è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="magic-toggle" name="magic.enabled" checked />
                                <label for="magic-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">9/53 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ”® é­”æ³•å­¦æ´¾</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-evocation-checkbox" name="magic.evocation.enabled" checked />
                                <label for="magic-evocation-checkbox" class="checkbox-label">å¡‘èƒ½ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-illusion-checkbox" name="magic.illusion.enabled" checked />
                                <label for="magic-illusion-checkbox" class="checkbox-label">å¹»æœ¯ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-enchantment-checkbox" name="magic.enchantment.enabled" />
                                <label for="magic-enchantment-checkbox" class="checkbox-label">æƒ‘æ§ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-necromancy-checkbox" name="magic.necromancy.enabled" />
                                <label for="magic-necromancy-checkbox" class="checkbox-label">æ­»çµç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-divination-checkbox" name="magic.divination.enabled" />
                                <label for="magic-divination-checkbox" class="checkbox-label">é¢„è¨€ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-transmutation-checkbox" name="magic.transmutation.enabled" />
                                <label for="magic-transmutation-checkbox" class="checkbox-label">å˜åŒ–ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-conjuration-checkbox" name="magic.conjuration.enabled" />
                                <label for="magic-conjuration-checkbox" class="checkbox-label">å’’æ³•ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-abjuration-checkbox" name="magic.abjuration.enabled" />
                                <label for="magic-abjuration-checkbox" class="checkbox-label">é˜²æŠ¤ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-elemental-checkbox" name="magic.elemental.enabled" />
                                <label for="magic-elemental-checkbox" class="checkbox-label">å…ƒç´ ç³»</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš¡ æ³•æœ¯ç­‰çº§</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-cantrip-checkbox" name="magic.cantrip.enabled" checked />
                                <label for="magic-cantrip-checkbox" class="checkbox-label">æˆæ³•(0ç¯)</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level1-checkbox" name="magic.level1.enabled" checked />
                                <label for="magic-level1-checkbox" class="checkbox-label">1ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level2-checkbox" name="magic.level2.enabled" />
                                <label for="magic-level2-checkbox" class="checkbox-label">2ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level3-checkbox" name="magic.level3.enabled" />
                                <label for="magic-level3-checkbox" class="checkbox-label">3ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level4-checkbox" name="magic.level4.enabled" />
                                <label for="magic-level4-checkbox" class="checkbox-label">4ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level5-checkbox" name="magic.level5.enabled" />
                                <label for="magic-level5-checkbox" class="checkbox-label">5ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level6-checkbox" name="magic.level6.enabled" />
                                <label for="magic-level6-checkbox" class="checkbox-label">6ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level7-checkbox" name="magic.level7.enabled" />
                                <label for="magic-level7-checkbox" class="checkbox-label">7ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level8-checkbox" name="magic.level8.enabled" />
                                <label for="magic-level8-checkbox" class="checkbox-label">8ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level9-checkbox" name="magic.level9.enabled" />
                                <label for="magic-level9-checkbox" class="checkbox-label">9ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ§™ æ³•å¸ˆå±æ€§</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level-checkbox" name="magic.level.enabled" checked />
                                <label for="magic-level-checkbox" class="checkbox-label">æ³•å¸ˆç­‰çº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-mana-checkbox" name="magic.mana.enabled" checked />
                                <label for="magic-mana-checkbox" class="checkbox-label">æ³•åŠ›å€¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-intelligence-checkbox" name="magic.intelligence.enabled" />
                                <label for="magic-intelligence-checkbox" class="checkbox-label">æ™ºåŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-wisdom-checkbox" name="magic.wisdom.enabled" />
                                <label for="magic-wisdom-checkbox" class="checkbox-label">æ„ŸçŸ¥å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-charisma-checkbox" name="magic.charisma.enabled" />
                                <label for="magic-charisma-checkbox" class="checkbox-label">é­…åŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-concentration-checkbox" name="magic.concentration.enabled" />
                                <label for="magic-concentration-checkbox" class="checkbox-label">ä¸“æ³¨èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-spellpower-checkbox" name="magic.spellpower.enabled" />
                                <label for="magic-spellpower-checkbox" class="checkbox-label">æ³•æœ¯å¼ºåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-resistance-checkbox" name="magic.resistance.enabled" />
                                <label for="magic-resistance-checkbox" class="checkbox-label">é­”æ³•æŠ—æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-regeneration-checkbox" name="magic.regeneration.enabled" />
                                <label for="magic-regeneration-checkbox" class="checkbox-label">æ³•åŠ›å›å¤</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“š æ³•æœ¯ä¹¦åº“</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-spellbook-checkbox" name="magic.spellbook.enabled" checked />
                                <label for="magic-spellbook-checkbox" class="checkbox-label">æ³•æœ¯ä¹¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-known-checkbox" name="magic.known.enabled" />
                                <label for="magic-known-checkbox" class="checkbox-label">å·²çŸ¥æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-prepared-checkbox" name="magic.prepared.enabled" />
                                <label for="magic-prepared-checkbox" class="checkbox-label">å‡†å¤‡æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-slots-checkbox" name="magic.slots.enabled" />
                                <label for="magic-slots-checkbox" class="checkbox-label">æ³•æœ¯ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-components-checkbox" name="magic.components.enabled" />
                                <label for="magic-components-checkbox" class="checkbox-label">æ³•æœ¯ææ–™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-rituals-checkbox" name="magic.rituals.enabled" />
                                <label for="magic-rituals-checkbox" class="checkbox-label">ä»ªå¼æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-metamagic-checkbox" name="magic.metamagic.enabled" />
                                <label for="magic-metamagic-checkbox" class="checkbox-label">è¶…é­”ä¸“é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-scrolls-checkbox" name="magic.scrolls.enabled" />
                                <label for="magic-scrolls-checkbox" class="checkbox-label">æ³•æœ¯å·è½´</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ”¥ å…ƒç´ é­”æ³•</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-fire-checkbox" name="magic.fire.enabled" checked />
                                <label for="magic-fire-checkbox" class="checkbox-label">ç«ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-water-checkbox" name="magic.water.enabled" />
                                <label for="magic-water-checkbox" class="checkbox-label">æ°´ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-earth-checkbox" name="magic.earth.enabled" />
                                <label for="magic-earth-checkbox" class="checkbox-label">åœŸç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-air-checkbox" name="magic.air.enabled" />
                                <label for="magic-air-checkbox" class="checkbox-label">é£ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-lightning-checkbox" name="magic.lightning.enabled" />
                                <label for="magic-lightning-checkbox" class="checkbox-label">é›·ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-ice-checkbox" name="magic.ice.enabled" />
                                <label for="magic-ice-checkbox" class="checkbox-label">å†°ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-light-checkbox" name="magic.light.enabled" />
                                <label for="magic-light-checkbox" class="checkbox-label">å…‰ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-dark-checkbox" name="magic.dark.enabled" />
                                <label for="magic-dark-checkbox" class="checkbox-label">æš—ç³»é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ›¡ï¸ é­”æ³•è£…å¤‡</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-staff-checkbox" name="magic.staff.enabled" />
                                <label for="magic-staff-checkbox" class="checkbox-label">æ³•æ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-wand-checkbox" name="magic.wand.enabled" />
                                <label for="magic-wand-checkbox" class="checkbox-label">é­”æ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-orb-checkbox" name="magic.orb.enabled" />
                                <label for="magic-orb-checkbox" class="checkbox-label">æ³•çƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-robe-checkbox" name="magic.robe.enabled" />
                                <label for="magic-robe-checkbox" class="checkbox-label">æ³•è¢</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-amulet-checkbox" name="magic.amulet.enabled" />
                                <label for="magic-amulet-checkbox" class="checkbox-label">æŠ¤èº«ç¬¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-ring-checkbox" name="magic.ring.enabled" />
                                <label for="magic-ring-checkbox" class="checkbox-label">é­”æ³•æˆ’æŒ‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-crystal-checkbox" name="magic.crystal.enabled" />
                                <label for="magic-crystal-checkbox" class="checkbox-label">é­”æ³•æ°´æ™¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-tome-checkbox" name="magic.tome.enabled" />
                                <label for="magic-tome-checkbox" class="checkbox-label">é­”æ³•å…¸ç±</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºè°ƒæ•™ç³»ç»Ÿé¢æ¿
     */
    createTrainingPanel() {
        return `
            <div class="content-header">
                <h3>è°ƒæ•™ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- è°ƒæ•™ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ¯</div>
                            <div class="card-text">
                                <div class="card-title">è°ƒæ•™ç³»ç»Ÿ</div>
                                <div class="card-subtitle">è®­ç»ƒç³»ç»ŸåŠŸèƒ½è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="training-toggle" name="training.enabled" checked />
                                <label for="training-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">6/51 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ“š åŸºç¡€è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-obedience-checkbox" name="training.obedience.enabled" checked />
                                <label for="training-obedience-checkbox" class="checkbox-label">æœä»è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-discipline-checkbox" name="training.discipline.enabled" checked />
                                <label for="training-discipline-checkbox" class="checkbox-label">çºªå¾‹è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-etiquette-checkbox" name="training.etiquette.enabled" />
                                <label for="training-etiquette-checkbox" class="checkbox-label">ç¤¼ä»ªè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-posture-checkbox" name="training.posture.enabled" />
                                <label for="training-posture-checkbox" class="checkbox-label">å§¿æ€è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-speech-checkbox" name="training.speech.enabled" />
                                <label for="training-speech-checkbox" class="checkbox-label">è¨€è¯­è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-behavior-checkbox" name="training.behavior.enabled" />
                                <label for="training-behavior-checkbox" class="checkbox-label">è¡Œä¸ºè§„èŒƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-attention-checkbox" name="training.attention.enabled" />
                                <label for="training-attention-checkbox" class="checkbox-label">æ³¨æ„åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-patience-checkbox" name="training.patience.enabled" />
                                <label for="training-patience-checkbox" class="checkbox-label">è€å¿ƒè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-focus-checkbox" name="training.focus.enabled" />
                                <label for="training-focus-checkbox" class="checkbox-label">ä¸“æ³¨è®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ¯ æŠ€èƒ½è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-service-checkbox" name="training.service.enabled" checked />
                                <label for="training-service-checkbox" class="checkbox-label">æœåŠ¡æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-cooking-checkbox" name="training.cooking.enabled" />
                                <label for="training-cooking-checkbox" class="checkbox-label">çƒ¹é¥ªæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-cleaning-checkbox" name="training.cleaning.enabled" />
                                <label for="training-cleaning-checkbox" class="checkbox-label">æ¸…æ´æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-massage-checkbox" name="training.massage.enabled" />
                                <label for="training-massage-checkbox" class="checkbox-label">æŒ‰æ‘©æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-entertainment-checkbox" name="training.entertainment.enabled" />
                                <label for="training-entertainment-checkbox" class="checkbox-label">å¨±ä¹æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-music-checkbox" name="training.music.enabled" />
                                <label for="training-music-checkbox" class="checkbox-label">éŸ³ä¹æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-dance-checkbox" name="training.dance.enabled" />
                                <label for="training-dance-checkbox" class="checkbox-label">èˆè¹ˆæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-art-checkbox" name="training.art.enabled" />
                                <label for="training-art-checkbox" class="checkbox-label">è‰ºæœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-language-checkbox" name="training.language.enabled" />
                                <label for="training-language-checkbox" class="checkbox-label">è¯­è¨€æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’ª ä½“èƒ½è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-strength-checkbox" name="training.strength.enabled" />
                                <label for="training-strength-checkbox" class="checkbox-label">åŠ›é‡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-endurance-checkbox" name="training.endurance.enabled" />
                                <label for="training-endurance-checkbox" class="checkbox-label">è€åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-flexibility-checkbox" name="training.flexibility.enabled" />
                                <label for="training-flexibility-checkbox" class="checkbox-label">æŸ”éŸ§è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-balance-checkbox" name="training.balance.enabled" />
                                <label for="training-balance-checkbox" class="checkbox-label">å¹³è¡¡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-coordination-checkbox" name="training.coordination.enabled" />
                                <label for="training-coordination-checkbox" class="checkbox-label">åè°ƒè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-agility-checkbox" name="training.agility.enabled" />
                                <label for="training-agility-checkbox" class="checkbox-label">æ•æ·è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-stamina-checkbox" name="training.stamina.enabled" />
                                <label for="training-stamina-checkbox" class="checkbox-label">ä½“åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-recovery-checkbox" name="training.recovery.enabled" />
                                <label for="training-recovery-checkbox" class="checkbox-label">æ¢å¤è®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ§  å¿ƒç†è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-confidence-checkbox" name="training.confidence.enabled" checked />
                                <label for="training-confidence-checkbox" class="checkbox-label">è‡ªä¿¡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-stress-checkbox" name="training.stress.enabled" />
                                <label for="training-stress-checkbox" class="checkbox-label">æŠ—å‹è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-emotion-checkbox" name="training.emotion.enabled" />
                                <label for="training-emotion-checkbox" class="checkbox-label">æƒ…ç»ªæ§åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-memory-checkbox" name="training.memory.enabled" />
                                <label for="training-memory-checkbox" class="checkbox-label">è®°å¿†è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-logic-checkbox" name="training.logic.enabled" />
                                <label for="training-logic-checkbox" class="checkbox-label">é€»è¾‘è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-creativity-checkbox" name="training.creativity.enabled" />
                                <label for="training-creativity-checkbox" class="checkbox-label">åˆ›é€ åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-meditation-checkbox" name="training.meditation.enabled" />
                                <label for="training-meditation-checkbox" class="checkbox-label">å†¥æƒ³è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-mindfulness-checkbox" name="training.mindfulness.enabled" />
                                <label for="training-mindfulness-checkbox" class="checkbox-label">æ­£å¿µè®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš™ï¸ è®­ç»ƒè®¾ç½®</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-intensity-checkbox" name="training.intensity.enabled" checked />
                                <label for="training-intensity-checkbox" class="checkbox-label">è®­ç»ƒå¼ºåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-duration-checkbox" name="training.duration.enabled" />
                                <label for="training-duration-checkbox" class="checkbox-label">è®­ç»ƒæ—¶é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-frequency-checkbox" name="training.frequency.enabled" />
                                <label for="training-frequency-checkbox" class="checkbox-label">è®­ç»ƒé¢‘ç‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-progress-checkbox" name="training.progress.enabled" />
                                <label for="training-progress-checkbox" class="checkbox-label">è¿›åº¦è·Ÿè¸ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-rewards-checkbox" name="training.rewards.enabled" />
                                <label for="training-rewards-checkbox" class="checkbox-label">å¥–åŠ±ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-punishment-checkbox" name="training.punishment.enabled" />
                                <label for="training-punishment-checkbox" class="checkbox-label">æƒ©ç½šæœºåˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-schedule-checkbox" name="training.schedule.enabled" />
                                <label for="training-schedule-checkbox" class="checkbox-label">è®­ç»ƒè®¡åˆ’</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-evaluation-checkbox" name="training.evaluation.enabled" />
                                <label for="training-evaluation-checkbox" class="checkbox-label">æ•ˆæœè¯„ä¼°</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“Š é«˜çº§åŠŸèƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-auto-checkbox" name="training.auto.enabled" checked />
                                <label for="training-auto-checkbox" class="checkbox-label">è‡ªåŠ¨è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-adaptive-checkbox" name="training.adaptive.enabled" />
                                <label for="training-adaptive-checkbox" class="checkbox-label">è‡ªé€‚åº”è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-ai-checkbox" name="training.ai.enabled" />
                                <label for="training-ai-checkbox" class="checkbox-label">AIè¾…åŠ©è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-analytics-checkbox" name="training.analytics.enabled" />
                                <label for="training-analytics-checkbox" class="checkbox-label">æ•°æ®åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-reports-checkbox" name="training.reports.enabled" />
                                <label for="training-reports-checkbox" class="checkbox-label">è®­ç»ƒæŠ¥å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-export-checkbox" name="training.export.enabled" />
                                <label for="training-export-checkbox" class="checkbox-label">æ•°æ®å¯¼å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-backup-checkbox" name="training.backup.enabled" />
                                <label for="training-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-sync-checkbox" name="training.sync.enabled" />
                                <label for="training-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * é”™è¯¯å¤„ç†
     */
    handleError(error) {
        this.errorCount++;
        console.error(`[InfoBarSettings] âŒ é”™è¯¯ #${this.errorCount}:`, error);
    }

    /**
     * åˆ›å»ºä¸»é¢˜é¢„è§ˆç½‘æ ¼
     */
    createThemePreviewGrid() {
        const themes = [
            {
                id: 'default-dark',
                name: 'é»˜è®¤æ·±è‰²',
                description: 'ç»å…¸æ·±è‰²ä¸»é¢˜ï¼ŒæŠ¤çœ¼èˆ’é€‚',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            },
            {
                id: 'default-light',
                name: 'é»˜è®¤æµ…è‰²',
                description: 'æ¸…æ–°æµ…è‰²ä¸»é¢˜ï¼Œç®€æ´æ˜äº®',
                colors: { bg: '#ffffff', text: '#333333', primary: '#007bff', border: '#dee2e6' }
            },
            {
                id: 'ocean-blue',
                name: 'æµ·æ´‹è“',
                description: 'æ·±é‚ƒæµ·æ´‹é£æ ¼ï¼Œå®é™ä¸“æ³¨',
                colors: { bg: '#0f1419', text: '#e6fffa', primary: '#00d4aa', border: '#1e3a8a' }
            },
            {
                id: 'forest-green',
                name: 'æ£®æ—ç»¿',
                description: 'è‡ªç„¶æ£®æ—é£æ ¼ï¼Œæ¸…æ–°æŠ¤çœ¼',
                colors: { bg: '#0d1b0d', text: '#e8f5e8', primary: '#22c55e', border: '#166534' }
            },
            {
                id: 'sunset-orange',
                name: 'å¤•é˜³æ©™',
                description: 'æ¸©æš–å¤•é˜³é£æ ¼ï¼Œæ´»åŠ›å››å°„',
                colors: { bg: '#1a0f0a', text: '#fff7ed', primary: '#f97316', border: '#c2410c' }
            },
            {
                id: 'purple-night',
                name: 'ç´«å¤œ',
                description: 'ç¥ç§˜ç´«è‰²é£æ ¼ï¼Œä¼˜é›…é«˜è´µ',
                colors: { bg: '#1a0f1a', text: '#f3e8ff', primary: '#a855f7', border: '#7c3aed' }
            },
            {
                id: 'cherry-blossom',
                name: 'æ¨±èŠ±ç²‰',
                description: 'æµªæ¼«æ¨±èŠ±é£æ ¼ï¼Œæ¸©æŸ”ç”œç¾',
                colors: { bg: '#1a1014', text: '#ffe6f0', primary: '#ff69b4', border: '#d1477a' }
            },
            {
                id: 'golden-sand',
                name: 'é‡‘æ²™',
                description: 'å¥¢åé‡‘è‰²é£æ ¼ï¼Œå…¸é›…å¤§æ°”',
                colors: { bg: '#1a1611', text: '#fef3c7', primary: '#f59e0b', border: '#d97706' }
            },
            {
                id: 'ice-blue',
                name: 'å†°è“',
                description: 'æ¸…å†·å†°è“é£æ ¼ï¼Œå†·é™ç†æ€§',
                colors: { bg: '#0f1419', text: '#e0f2fe', primary: '#0ea5e9', border: '#0284c7' }
            },
            {
                id: 'rose-red',
                name: 'ç«ç‘°çº¢',
                description: 'çƒ­æƒ…ç«ç‘°é£æ ¼ï¼Œæµªæ¼«æ¿€æƒ…',
                colors: { bg: '#1a0a0a', text: '#ffe4e6', primary: '#e11d48', border: '#be123c' }
            },
            {
                id: 'mint-green',
                name: 'è–„è·ç»¿',
                description: 'æ¸…æ–°è–„è·é£æ ¼ï¼Œèˆ’ç¼“æ”¾æ¾',
                colors: { bg: '#f0fdf4', text: '#14532d', primary: '#10b981', border: '#a7f3d0' }
            },
            {
                id: 'lavender',
                name: 'è–°è¡£è‰',
                description: 'æ·¡é›…è–°è¡£è‰é£æ ¼ï¼Œå®é™å®‰è¯¦',
                colors: { bg: '#faf5ff', text: '#581c87', primary: '#8b5cf6', border: '#c4b5fd' }
            },
            {
                id: 'coffee-brown',
                name: 'å’–å•¡æ£•',
                description: 'æ¸©æš–å’–å•¡é£æ ¼ï¼Œæ²‰ç¨³å†…æ•›',
                colors: { bg: '#1c1917', text: '#fef7ed', primary: '#a16207', border: '#78716c' }
            },
            {
                id: 'slate-gray',
                name: 'çŸ³æ¿ç°',
                description: 'ç°ä»£çŸ³æ¿é£æ ¼ï¼Œç®€çº¦ä¸“ä¸š',
                colors: { bg: '#0f172a', text: '#f1f5f9', primary: '#64748b', border: '#475569' }
            },
            {
                id: 'coral-white',
                name: 'çŠç‘šæ©™Â·é›…éŸµ',
                description: 'æ¸©æš–çŠç‘šæ©™+ç™½åº•ï¼Œä¼˜é›…æ¸©é¦¨',
                colors: { bg: '#fffaf7', text: '#2d1810', primary: '#ff7f50', border: '#ffcab0' }
            },
            {
                id: 'sky-white',
                name: 'å¤©ç©ºè“Â·æ¸…éŸµ',
                description: 'æ¸…çˆ½å¤©ç©ºè“+ç™½åº•ï¼Œæ¸…æ–°ä¸“æ³¨',
                colors: { bg: '#f8fbff', text: '#0c2340', primary: '#4a90e2', border: '#b8d9f7' }
            },
            {
                id: 'jade-white',
                name: 'ç¿¡ç¿ ç»¿Â·é›…è‡´',
                description: 'è‡ªç„¶ç¿¡ç¿ ç»¿+ç™½åº•ï¼Œæ¸…æ–°é›…è‡´',
                colors: { bg: '#f6fcfa', text: '#0f3a2e', primary: '#00a67e', border: '#99e6d4' }
            },
            {
                id: 'violet-white',
                name: 'ç´«ç½—å…°Â·ä¼˜é›…',
                description: 'é«˜è´µç´«ç½—å…°+ç™½åº•ï¼Œä¼˜é›…å¤§æ°”',
                colors: { bg: '#fcf8ff', text: '#3d1a5f', primary: '#8b5cf6', border: '#d8b4fe' }
            },
            {
                id: 'rose-white',
                name: 'æ¨±ç²‰Â·æŸ”ç¾',
                description: 'æµªæ¼«æ¨±èŠ±ç²‰+ç™½åº•ï¼ŒæŸ”ç¾æ¸©é¦¨',
                colors: { bg: '#fff9fb', text: '#5c1a33', primary: '#e91e63', border: '#f8bbd0' }
            },
            {
                id: 'custom',
                name: 'è‡ªå®šä¹‰',
                description: 'åˆ›å»ºæ‚¨çš„ä¸“å±ä¸»é¢˜',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            }
        ];

        return themes.map(theme => {
            const isActive = theme.id === 'default-dark' ? 'active' : '';
            const isCustom = theme.id === 'custom';
            const currentBadge = theme.id === 'default-dark' ? '<div class="current-badge">å½“å‰</div>' : '';

            return `
                <div class="theme-preview-card ${isActive}"
                     data-theme="${theme.id}"
                     data-custom="${isCustom}">
                    <div class="theme-preview-mini" style="background: ${theme.colors.bg}; border: 1px solid ${theme.colors.border};">
                        <div class="preview-header-mini" style="background: ${theme.colors.primary}; color: ${theme.colors.bg};">æ ‡é¢˜</div>
                        <div class="preview-content-mini" style="color: ${theme.colors.text};">å†…å®¹</div>
                        <div class="preview-button-mini" style="background: ${theme.colors.primary}; color: ${theme.colors.bg};">æŒ‰é’®</div>
                    </div>
                    <div class="theme-info">
                        <h4>${theme.name}</h4>
                        <p>${theme.description}</p>
                    </div>
                    ${currentBadge}
                </div>
            `;
        }).join('');
    }

    /**
     * åˆ›å»ºä¿¡æ¯æ é£æ ¼é¢„è§ˆç½‘æ ¼
     */
    createStylePreviewGrid() {
        const styles = [
            {
                id: 'end-generated',
                name: 'ç»“å°¾ç”Ÿæˆå¼',
                description: 'åœ¨å¯¹è¯ç»“å°¾æ˜¾ç¤ºä¿¡æ¯æ ï¼Œä¸å¹²æ‰°å¯¹è¯æµç¨‹',
                icon: 'ğŸ“',
                preview: {
                    layout: 'end',
                    position: 'bottom',
                    integration: 'separate'
                }
            },
            {
                id: 'flat',
                name: 'æ‰å¹³å¼',
                description: 'ç®€æ´æ‰å¹³çš„é¡¶éƒ¨æ ï¼Œæ”¯æŒä¸€é”®å±•å¼€/æ”¶èµ·',
                icon: 'ğŸ“‹',
                preview: {
                    layout: 'flat',
                    position: 'bottom',
                    integration: 'separate'
                }
            },
            {
                id: 'floating',
                name: 'æµ®åŠ¨å¼',
                description: 'æ‚¬æµ®æ˜¾ç¤ºçš„å¯æ‹–æ‹½ä¿¡æ¯æ ',
                icon: 'ğŸˆ',
                preview: {
                    layout: 'floating',
                    position: 'overlay',
                    integration: 'independent'
                }
            },
            {
                id: 'custom-html',
                name: 'HTMLå¼',
                description: 'ä½¿ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿æ¸²æŸ“ä¿¡æ¯æ ï¼Œæ”¯æŒå®Œå…¨è‡ªå®šä¹‰çš„æ ·å¼å’Œå¸ƒå±€',
                icon: 'ğŸ¨',
                preview: {
                    layout: 'custom',
                    position: 'template',
                    integration: 'html'
                }
            }
        ];

        return styles.map(style => {
            const isActive = style.id === 'end-generated' ? 'active' : '';
            const currentBadge = style.id === 'end-generated' ? '<div class="current-badge">å½“å‰</div>' : '';

            return `
                <div class="style-preview-card ${isActive}"
                     data-style="${style.id}">
                    <div class="style-preview-mini">
                        <div class="style-icon">${style.icon}</div>
                        <div class="style-layout-demo">
                            ${this.createStyleLayoutDemo(style.preview)}
                        </div>
                    </div>
                    <div class="style-info">
                        <h4>${style.name}</h4>
                        <p>${style.description}</p>
                    </div>
                    ${currentBadge}
                </div>
            `;
        }).join('');
    }

    /**
     * åˆ›å»ºé£æ ¼å¸ƒå±€æ¼”ç¤º
     * @param {Object} preview - é¢„è§ˆé…ç½®
     */
    createStyleLayoutDemo(preview) {
        switch (preview.layout) {
            case 'end':
                return `
                    <div class="demo-chat">ğŸ’¬</div>
                    <div class="demo-infobar">ğŸ“Š</div>
                `;
            case 'flat':
                return `
                    <div class="demo-chat">ğŸ’¬</div>
                    <div class="demo-infobar">â€”ğŸ“Šâ€”</div>
                `;
            case 'floating':
                return `
                    <div class="demo-base">ğŸ’¬</div>
                    <div class="demo-float">ğŸ“Š</div>
                `;
            case 'custom':
                return `
                    <div class="demo-custom">
                        <div class="demo-chat">ğŸ’¬</div>
                        <div class="demo-html">ğŸ¨</div>
                    </div>
                `;
            default:
                return `<div class="demo-default">ğŸ“Š</div>`;
        }
    }
    /**
     * é€‰æ‹©ä¸»é¢˜
     * @param {string} themeId - ä¸»é¢˜ID
     */
    async selectTheme(themeId) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ é€‰æ‹©ä¸»é¢˜:', themeId);

            // è·å–ä¸»é¢˜é…ç½®
            const theme = this.getThemeById(themeId);
            if (!theme) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°ä¸»é¢˜:', themeId);
                return;
            }

            // åº”ç”¨ä¸»é¢˜
            this.applyTheme(theme);

            // æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
            this.updateThemeCardStates(themeId);

            // æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯
            this.updateCurrentThemeInfo(theme);

            // ä¿å­˜ä¸»é¢˜é…ç½®
            await this.saveThemeConfig(themeId);

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜åˆ‡æ¢å®Œæˆ:', theme.name);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * é€‰æ‹©ä¿¡æ¯æ é£æ ¼
     * @param {string} styleId - é£æ ¼ID
     */
    async selectStyle(styleId) {
        try {
            console.log('[InfoBarSettings] ğŸ­ é€‰æ‹©ä¿¡æ¯æ é£æ ¼:', styleId);

            // è·å–é£æ ¼é…ç½®
            const style = this.getStyleById(styleId);
            if (!style) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°é£æ ¼:', styleId);
                return;
            }

            // åº”ç”¨é£æ ¼
            this.applyStyle(style);

            // æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
            this.updateStyleCardStates(styleId);

            // æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯
            this.updateCurrentStyleInfo(style);

            // ä¿å­˜é£æ ¼é…ç½®
            await this.saveStyleConfig(styleId);

            // åˆ·æ–°æ‰€æœ‰å·²æ¸²æŸ“çš„ä¿¡æ¯æ 
            await this.refreshAllInfoBars();

            console.log('[InfoBarSettings] âœ… é£æ ¼åˆ‡æ¢å®Œæˆ:', style.name);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©é£æ ¼å¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°æ‰€æœ‰å·²æ¸²æŸ“çš„ä¿¡æ¯æ 
     */
    async refreshAllInfoBars() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰ä¿¡æ¯æ ');

            // è·å–MessageInfoBarRendererå®ä¾‹
            const renderer = window.SillyTavernInfobar?.modules?.messageInfoBarRenderer;
            if (renderer && typeof renderer.refreshAllInfoBars === 'function') {
                await renderer.refreshAllInfoBars();
                console.log('[InfoBarSettings] âœ… ä¿¡æ¯æ åˆ·æ–°å®Œæˆ');
            } else {
                console.log('[InfoBarSettings] âš ï¸ MessageInfoBarRendereræœªæ‰¾åˆ°æˆ–ä¸æ”¯æŒåˆ·æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°ä¿¡æ¯æ å¤±è´¥:', error);
        }
    }

    /**
     * æ ¹æ®IDè·å–é£æ ¼é…ç½®
     * @param {string} styleId - é£æ ¼ID
     * @returns {Object|null} é£æ ¼é…ç½®å¯¹è±¡
     */
    getStyleById(styleId) {
        const styles = [
            {
                id: 'end-generated',
                name: 'ç»“å°¾ç”Ÿæˆå¼',
                description: 'åœ¨å¯¹è¯ç»“å°¾æ˜¾ç¤ºä¿¡æ¯æ ï¼Œä¸å¹²æ‰°å¯¹è¯æµç¨‹',
                config: {
                    position: 'end',
                    layout: 'bottom',
                    integration: 'separate',
                    animation: 'slideUp',
                    autoHide: false,
                    collapsible: true
                }
            },
            {
                id: 'flat',
                name: 'æ‰å¹³å¼',
                description: 'ç®€æ´æ‰å¹³çš„é¡¶éƒ¨æ ï¼Œæ”¯æŒä¸€é”®å±•å¼€/æ”¶èµ·',
                config: {
                    position: 'end',
                    layout: 'flat',
                    integration: 'separate',
                    animation: 'none',
                    autoHide: false,
                    collapsible: true
                }
            },
            {
                id: 'floating',
                name: 'æµ®åŠ¨å¼',
                description: 'æ‚¬æµ®æ˜¾ç¤ºçš„å¯æ‹–æ‹½ä¿¡æ¯æ ',
                config: {
                    position: 'overlay',
                    layout: 'floating',
                    integration: 'independent',
                    animation: 'bounce',
                    autoHide: true,
                    collapsible: true,
                    draggable: true
                }
            },
            {
                id: 'custom-html',
                name: 'HTMLå¼',
                description: 'ä½¿ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿æ¸²æŸ“ä¿¡æ¯æ ï¼Œæ”¯æŒå®Œå…¨è‡ªå®šä¹‰çš„æ ·å¼å’Œå¸ƒå±€',
                config: {
                    position: 'end',
                    layout: 'custom',
                    integration: 'template',
                    animation: 'fadeIn',
                    autoHide: false,
                    collapsible: true,
                    customTemplate: true,
                    htmlSupport: true,
                    dataBinding: true
                }
            }
        ];

        return styles.find(style => style.id === styleId) || null;
    }

    /**
     * åº”ç”¨ä¿¡æ¯æ é£æ ¼
     * @param {Object} style - é£æ ¼é…ç½®å¯¹è±¡
     */
    applyStyle(style) {
        try {
            console.log('[InfoBarSettings] ğŸ­ åº”ç”¨ä¿¡æ¯æ é£æ ¼:', style.name);

            // æ›´æ–°å…¨å±€é£æ ¼é…ç½®
            window.InfoBarStyleConfig = {
                currentStyle: style.id,
                config: style.config,
                timestamp: Date.now()
            };

            // é€šè¿‡äº‹ä»¶ç³»ç»Ÿé€šçŸ¥å…¶ä»–æ¨¡å—é£æ ¼å˜æ›´
            if (this.eventSystem) {
                this.eventSystem.emit('style:changed', {
                    styleId: style.id,
                    config: style.config,
                    name: style.name
                });
            }

            console.log('[InfoBarSettings] âœ… ä¿¡æ¯æ é£æ ¼åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¿¡æ¯æ é£æ ¼å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
     * @param {string} activeStyleId - æ¿€æ´»çš„é£æ ¼ID
     */
    updateStyleCardStates(activeStyleId) {
        try {
            const styleCards = this.modal.querySelectorAll('.style-preview-card');
            styleCards.forEach(card => {
                const styleId = card.dataset.style;
                const isActive = styleId === activeStyleId;

                // æ›´æ–°æ¿€æ´»çŠ¶æ€
                card.classList.toggle('active', isActive);

                // æ›´æ–°å½“å‰æ ‡ç­¾
                const currentBadge = card.querySelector('.current-badge');
                if (isActive && !currentBadge) {
                    card.insertAdjacentHTML('beforeend', '<div class="current-badge">å½“å‰</div>');
                } else if (!isActive && currentBadge) {
                    currentBadge.remove();
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯
     * @param {Object} style - é£æ ¼é…ç½®å¯¹è±¡
     */
    updateCurrentStyleInfo(style) {
        try {
            const currentStyleInput = this.modal.querySelector('input[name="style.current"]');
            const styleDescTextarea = this.modal.querySelector('textarea[name="style.description"]');

            if (currentStyleInput) {
                currentStyleInput.value = style.name;
            }

            if (styleDescTextarea) {
                styleDescTextarea.value = style.description;
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜é£æ ¼é…ç½®
     * @param {string} styleId - é£æ ¼ID
     */
    async saveStyleConfig(styleId) {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜é£æ ¼é…ç½®
            extensionSettings['Information bar integration tool'].style = {
                current: styleId,
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨ SillyTavern çš„æŒä¹…åŒ–æ–¹æ³•
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] ğŸ’¾ é£æ ¼é…ç½®å·²ä¿å­˜åˆ° extensionSettings:', styleId);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é£æ ¼é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ ¹æ®IDè·å–ä¸»é¢˜é…ç½®
     * @param {string} themeId - ä¸»é¢˜ID
     * @returns {Object|null} ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    getThemeById(themeId) {
        const themes = [
            {
                id: 'default-dark',
                name: 'é»˜è®¤æ·±è‰²',
                description: 'ç»å…¸æ·±è‰²ä¸»é¢˜ï¼ŒæŠ¤çœ¼èˆ’é€‚',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            },
            {
                id: 'default-light',
                name: 'é»˜è®¤æµ…è‰²',
                description: 'æ¸…æ–°æµ…è‰²ä¸»é¢˜ï¼Œç®€æ´æ˜äº®',
                colors: { bg: '#ffffff', text: '#333333', primary: '#007bff', border: '#dee2e6' }
            },
            {
                id: 'ocean-blue',
                name: 'æµ·æ´‹è“',
                description: 'æ·±é‚ƒæµ·æ´‹é£æ ¼ï¼Œå®é™ä¸“æ³¨',
                colors: { bg: '#0f1419', text: '#e6fffa', primary: '#00d4aa', border: '#1e3a8a' }
            },
            {
                id: 'forest-green',
                name: 'æ£®æ—ç»¿',
                description: 'è‡ªç„¶æ£®æ—é£æ ¼ï¼Œæ¸…æ–°æŠ¤çœ¼',
                colors: { bg: '#0d1b0d', text: '#e8f5e8', primary: '#22c55e', border: '#166534' }
            },
            {
                id: 'sunset-orange',
                name: 'å¤•é˜³æ©™',
                description: 'æ¸©æš–å¤•é˜³é£æ ¼ï¼Œæ´»åŠ›å››å°„',
                colors: { bg: '#1a0f0a', text: '#fff4e6', primary: '#ff8c00', border: '#cc4400' }
            },
            {
                id: 'purple-night',
                name: 'ç´«å¤œ',
                description: 'ç¥ç§˜ç´«è‰²é£æ ¼ï¼Œä¼˜é›…é«˜è´µ',
                colors: { bg: '#1a0d1a', text: '#f0e6ff', primary: '#9d4edd', border: '#6a1b9a' }
            },
            {
                id: 'cherry-blossom',
                name: 'æ¨±èŠ±ç²‰',
                description: 'æµªæ¼«æ¨±èŠ±é£æ ¼ï¼Œæ¸©æŸ”ç”œç¾',
                colors: { bg: '#1a1014', text: '#ffe6f0', primary: '#ff69b4', border: '#d1477a' }
            },
            {
                id: 'golden-sand',
                name: 'é‡‘æ²™',
                description: 'å¥¢åé‡‘è‰²é£æ ¼ï¼Œå°Šè´µå…¸é›…',
                colors: { bg: '#1a1610', text: '#fff8dc', primary: '#ffd700', border: '#b8860b' }
            },
            {
                id: 'ice-blue',
                name: 'å†°è“',
                description: 'æ¸…å†·å†°è“é£æ ¼ï¼Œçº¯å‡€æ¸…æ–°',
                colors: { bg: '#0a1419', text: '#e6f7ff', primary: '#00bfff', border: '#0080cc' }
            },
            {
                id: 'rose-red',
                name: 'ç«ç‘°çº¢',
                description: 'çƒ­æƒ…ç«ç‘°é£æ ¼ï¼Œæµªæ¼«æ¿€æƒ…',
                colors: { bg: '#1a0a0f', text: '#ffe6eb', primary: '#dc143c', border: '#a0102a' }
            },
            {
                id: 'mint-green',
                name: 'è–„è·ç»¿',
                description: 'æ¸…æ–°è–„è·é£æ ¼ï¼Œè‡ªç„¶èˆ’ç¼“',
                colors: { bg: '#0a1a14', text: '#e6fff2', primary: '#00fa9a', border: '#00cc7a' }
            },
            {
                id: 'lavender',
                name: 'è–°è¡£è‰',
                description: 'æ·¡é›…è–°è¡£è‰é£æ ¼ï¼Œå®é™å®‰è¯¦',
                colors: { bg: '#14141a', text: '#f0f0ff', primary: '#9370db', border: '#7b68ee' }
            },
            {
                id: 'coffee-brown',
                name: 'å’–å•¡æ£•',
                description: 'æ¸©æš–å’–å•¡é£æ ¼ï¼Œæ²‰ç¨³å†…æ•›',
                colors: { bg: '#1a1410', text: '#f5f0e6', primary: '#8b4513', border: '#654321' }
            },
            {
                id: 'slate-gray',
                name: 'çŸ³æ¿ç°',
                description: 'ç°ä»£çŸ³æ¿é£æ ¼ï¼Œç®€çº¦ä¸“ä¸š',
                colors: { bg: '#1a1a1a', text: '#e6e6e6', primary: '#708090', border: '#556b7d' }
            },
            {
                id: 'coral-white',
                name: 'çŠç‘šæ©™Â·é›…éŸµ',
                description: 'æ¸©æš–çŠç‘šæ©™+ç™½åº•ï¼Œä¼˜é›…æ¸©é¦¨',
                colors: { bg: '#fffaf7', text: '#2d1810', primary: '#ff7f50', border: '#ffcab0' }
            },
            {
                id: 'sky-white',
                name: 'å¤©ç©ºè“Â·æ¸…éŸµ',
                description: 'æ¸…çˆ½å¤©ç©ºè“+ç™½åº•ï¼Œæ¸…æ–°ä¸“æ³¨',
                colors: { bg: '#f8fbff', text: '#0c2340', primary: '#4a90e2', border: '#b8d9f7' }
            },
            {
                id: 'jade-white',
                name: 'ç¿¡ç¿ ç»¿Â·é›…è‡´',
                description: 'è‡ªç„¶ç¿¡ç¿ ç»¿+ç™½åº•ï¼Œæ¸…æ–°é›…è‡´',
                colors: { bg: '#f6fcfa', text: '#0f3a2e', primary: '#00a67e', border: '#99e6d4' }
            },
            {
                id: 'violet-white',
                name: 'ç´«ç½—å…°Â·ä¼˜é›…',
                description: 'é«˜è´µç´«ç½—å…°+ç™½åº•ï¼Œä¼˜é›…å¤§æ°”',
                colors: { bg: '#fcf8ff', text: '#3d1a5f', primary: '#8b5cf6', border: '#d8b4fe' }
            },
            {
                id: 'rose-white',
                name: 'æ¨±ç²‰Â·æŸ”ç¾',
                description: 'æµªæ¼«æ¨±èŠ±ç²‰+ç™½åº•ï¼ŒæŸ”ç¾æ¸©é¦¨',
                colors: { bg: '#fff9fb', text: '#5c1a33', primary: '#e91e63', border: '#f8bbd0' }
            },
            {
                id: 'custom',
                name: 'è‡ªå®šä¹‰',
                description: 'åˆ›å»ºæ‚¨çš„ä¸“å±ä¸»é¢˜',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            }
        ];

        return themes.find(theme => theme.id === themeId) || null;
    }

    /**
     * åº”ç”¨ä¸»é¢˜
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyTheme(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜:', theme.name);

            // è®¡ç®—è¡ç”Ÿé¢œè‰²
            const bgSecondary = this.adjustColor(theme.colors.bg, 10);
            const textSecondary = this.adjustColor(theme.colors.text, -20);
            const primaryHover = this.adjustColor(theme.colors.primary, -10);

            // æ›´æ–°CSSå˜é‡
            const root = document.documentElement;
            root.style.setProperty('--theme-bg-primary', theme.colors.bg);
            root.style.setProperty('--theme-bg-secondary', bgSecondary);
            root.style.setProperty('--theme-text-primary', theme.colors.text);
            root.style.setProperty('--theme-text-secondary', textSecondary);
            root.style.setProperty('--theme-primary-color', theme.colors.primary);
            root.style.setProperty('--theme-primary-hover', primaryHover);
            root.style.setProperty('--theme-border-color', theme.colors.border);

            // åº”ç”¨åˆ°ä¿¡æ¯æ è®¾ç½®ç•Œé¢
            this.applyThemeToInfoBarSettings(theme);

            // åº”ç”¨åˆ°æ•°æ®è¡¨æ ¼ç•Œé¢
            this.applyThemeToDataTable(theme);

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
     * @param {string} activeThemeId - æ¿€æ´»çš„ä¸»é¢˜ID
     */
    updateThemeCardStates(activeThemeId) {
        try {
            const themeCards = this.modal.querySelectorAll('.theme-preview-card');
            themeCards.forEach(card => {
                const themeId = card.dataset.theme;
                const currentBadge = card.querySelector('.current-badge');

                if (themeId === activeThemeId) {
                    card.classList.add('active');
                    if (!currentBadge) {
                        const badge = document.createElement('div');
                        badge.className = 'current-badge';
                        badge.textContent = 'å½“å‰';
                        card.appendChild(badge);
                    }
                } else {
                    card.classList.remove('active');
                    if (currentBadge) {
                        currentBadge.remove();
                    }
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    updateCurrentThemeInfo(theme) {
        try {
            const currentThemeInput = this.modal.querySelector('[name="theme.current"]');
            const themeDescriptionTextarea = this.modal.querySelector('[name="theme.description"]');

            if (currentThemeInput) {
                currentThemeInput.value = theme.name;
            }

            if (themeDescriptionTextarea) {
                themeDescriptionTextarea.value = theme.description;
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜ä¸»é¢˜é…ç½®
     * @param {string} themeId - ä¸»é¢˜ID
     */
    async saveThemeConfig(themeId) {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜ä¸»é¢˜é…ç½®
            extensionSettings['Information bar integration tool'].theme = {
                current: themeId,
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨ SillyTavern çš„æŒä¹…åŒ–æ–¹æ³•
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜é…ç½®å·²ä¿å­˜åˆ° extensionSettings:', themeId);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜ä¸»é¢˜é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°ä¿¡æ¯æ è®¾ç½®ç•Œé¢
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyThemeToInfoBarSettings(theme) {
        try {
            if (!this.modal) return;

            // åº”ç”¨åˆ°æ¨¡æ€æ¡†
            this.modal.style.backgroundColor = theme.colors.bg;
            this.modal.style.color = theme.colors.text;
            this.modal.style.borderColor = theme.colors.border;

            // åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³å…ƒç´ ï¼Œä½†æ’é™¤å¯¼èˆªé¡¹
            const elements = this.modal.querySelectorAll('.modal-header, .modal-body, .modal-footer, .content-panel');
            elements.forEach(element => {
                element.style.backgroundColor = theme.colors.bg;
                element.style.color = theme.colors.text;
                element.style.borderColor = theme.colors.border;
            });

            // ğŸ”§ ä¿®å¤ï¼šå•ç‹¬å¤„ç†å¯¼èˆªé¡¹ï¼Œä¿æŒæ¿€æ´»çŠ¶æ€çš„æ­£ç¡®æ ·å¼
            const navItems = this.modal.querySelectorAll('.nav-item');
            navItems.forEach(navItem => {
                if (navItem.classList.contains('active')) {
                    // æ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨ä¸»é¢˜è‰²
                    navItem.style.backgroundColor = theme.colors.primary;
                    navItem.style.color = theme.colors.text;
                    navItem.style.borderLeftColor = theme.colors.primary;
                } else {
                    // éæ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨èƒŒæ™¯è‰²
                    navItem.style.backgroundColor = theme.colors.bg;
                    navItem.style.color = theme.colors.text;
                    navItem.style.borderColor = theme.colors.border;
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°æ€»ç»“é¢æ¿ç‰¹å®šå…ƒç´ 
            this.applySummaryPanelTheme(theme);

            // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°å˜é‡ç®¡ç†å™¨ç‰¹å®šå…ƒç´ 
            this.applyVariableManagerTheme(theme);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°ä¿¡æ¯æ è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå•ç‹¬åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
     */
    applyNavItemTheme() {
        try {
            if (!this.modal) return;

            // è·å–å½“å‰æ¿€æ´»çš„ä¸»é¢˜
            const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
            if (!activeThemeCard) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ¿€æ´»çš„ä¸»é¢˜å¡ç‰‡');
                return;
            }

            const themeId = activeThemeCard.getAttribute('data-theme');
            const currentTheme = this.getThemeById(themeId);
            if (!currentTheme || !currentTheme.colors) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°ä¸»é¢˜é…ç½®:', themeId);
                return;
            }

            // åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
            const navItems = this.modal.querySelectorAll('.nav-item');
            navItems.forEach(navItem => {
                if (navItem.classList.contains('active')) {
                    // æ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨ä¸»é¢˜è‰²
                    navItem.style.backgroundColor = currentTheme.colors.primary;
                    navItem.style.color = currentTheme.colors.text;
                    navItem.style.borderLeftColor = currentTheme.colors.primary;
                } else {
                    // éæ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨èƒŒæ™¯è‰²
                    navItem.style.backgroundColor = currentTheme.colors.bg;
                    navItem.style.color = currentTheme.colors.text;
                    navItem.style.borderColor = currentTheme.colors.border;
                }
            });

            console.log('[InfoBarSettings] âœ… å¯¼èˆªé¡¹ä¸»é¢˜åº”ç”¨å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼èˆªé¡¹ä¸»é¢˜åº”ç”¨å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°æ€»ç»“é¢æ¿å…ƒç´ 
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applySummaryPanelTheme(theme) {
        try {
            if (!this.modal) return;

            // æ€»ç»“é¢æ¿å®¹å™¨
            const summaryContainers = this.modal.querySelectorAll('.summary-settings-container, .summary-history-container, .summary-content-container');
            summaryContainers.forEach(container => {
                container.style.backgroundColor = theme.colors.bg;
                container.style.color = theme.colors.text;
                container.style.borderColor = theme.colors.border;
            });

            // è®¾ç½®åŒºåŸŸ
            const settingSections = this.modal.querySelectorAll('.settings-section, .history-section, .content-section');
            settingSections.forEach(section => {
                section.style.backgroundColor = this.adjustColor(theme.colors.bg, 5);
                section.style.color = theme.colors.text;
                section.style.borderColor = theme.colors.border;
            });

            // è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†
            const inputs = this.modal.querySelectorAll('#content-auto-summary-enabled, #content-summary-floor-count, #content-summary-type, #content-summary-word-count, #content-summary-history-select');
            inputs.forEach(input => {
                input.style.backgroundColor = theme.colors.bg;
                input.style.color = theme.colors.text;
                input.style.borderColor = theme.colors.border;
            });

            // åˆ é™¤æŒ‰é’®
            const deleteBtn = this.modal.querySelector('#content-delete-summary-btn');
            if (deleteBtn) {
                deleteBtn.style.backgroundColor = theme.colors.primary;
                deleteBtn.style.color = theme.colors.bg;
                deleteBtn.style.borderColor = theme.colors.primary;
            }

            // æŒ‰é’®
            const buttons = this.modal.querySelectorAll('#header-manual-summary-btn, #header-refresh-summary-btn, #content-delete-summary-btn, [data-action="open-error-log"], [data-action="open-project-link"], [data-action="save-profile"], [data-action="load-profile"], [data-action="delete-profile"], [data-action="export"], [data-action="import"]');
            buttons.forEach(button => {
                button.style.backgroundColor = theme.colors.primary;
                button.style.color = theme.colors.bg;
                button.style.borderColor = theme.colors.primary;
            });

            // æ ‡ç­¾å’Œæç¤ºæ–‡æœ¬
            const labels = this.modal.querySelectorAll('.setting-label, .setting-hint, .content-meta');
            labels.forEach(label => {
                label.style.color = this.adjustColor(theme.colors.text, -20);
            });

            // å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
            const contentBody = this.modal.querySelector('#content-summary-content-body');
            if (contentBody) {
                contentBody.style.backgroundColor = this.adjustColor(theme.colors.bg, 3);
                contentBody.style.color = theme.colors.text;
                contentBody.style.borderColor = theme.colors.border;
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨æ€»ç»“é¢æ¿ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°å˜é‡ç®¡ç†å™¨
     */
    applyVariableManagerTheme(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜...');

            // å˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
            const variableModal = document.querySelector('#variable-manager-modal');
            if (!variableModal) {
                console.log('[InfoBarSettings] â„¹ï¸ å˜é‡ç®¡ç†å™¨æœªæ‰“å¼€ï¼Œè·³è¿‡ä¸»é¢˜åº”ç”¨');
                return;
            }

            // åº”ç”¨ä¸»é¢˜åˆ°æ¨¡æ€æ¡†å®¹å™¨
            const modalContainer = variableModal.querySelector('.modal-container');
            if (modalContainer) {
                modalContainer.style.backgroundColor = theme.colors.bg;
                modalContainer.style.color = theme.colors.text;
                modalContainer.style.borderColor = theme.colors.border;
            }

            // åº”ç”¨ä¸»é¢˜åˆ°å˜é‡é¡¹
            const variableItems = variableModal.querySelectorAll('.variable-item');
            variableItems.forEach(item => {
                item.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 3), 'important');
                item.style.setProperty('color', theme.colors.text, 'important');
                item.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // ğŸ”§ ä¿®å¤ï¼šå¼ºåˆ¶åº”ç”¨ä¸»é¢˜åˆ°object-propertyå’Œnested-arrayå…ƒç´ 
            const objectProperties = variableModal.querySelectorAll('.object-property, .nested-array, .nested-object');
            objectProperties.forEach(element => {
                element.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 5), 'important');
                element.style.setProperty('color', theme.colors.text, 'important');
                element.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°åµŒå¥—é¡¹å®¹å™¨
            const nestedItems = variableModal.querySelectorAll('.nested-items');
            nestedItems.forEach(container => {
                container.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 2), 'important');
                container.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†
            const inputs = variableModal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.style.setProperty('background-color', theme.colors.bg, 'important');
                input.style.setProperty('color', theme.colors.text, 'important');
                input.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°æŒ‰é’®
            const buttons = variableModal.querySelectorAll('.btn, .btn-icon, .btn-icon-small');
            buttons.forEach(button => {
                if (button.classList.contains('btn-primary') || button.classList.contains('btn-success')) {
                    button.style.setProperty('background-color', theme.colors.primary, 'important');
                    button.style.setProperty('color', theme.colors.bg, 'important');
                } else if (button.classList.contains('btn-danger')) {
                    button.style.setProperty('background-color', '#dc3545', 'important');
                    button.style.setProperty('color', 'white', 'important');
                } else {
                    button.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 10), 'important');
                    button.style.setProperty('color', theme.colors.text, 'important');
                }
                button.style.setProperty('border-color', theme.colors.border, 'important');
            });

            console.log('[InfoBarSettings] âœ… å˜é‡ç®¡ç†å™¨ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼ç•Œé¢
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyThemeToDataTable(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼:', theme.name || theme.id);

            // é€šè¿‡äº‹ä»¶ç³»ç»Ÿé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°ä¸»é¢˜
            if (this.eventSystem) {
                this.eventSystem.emit('theme:changed', {
                    themeId: theme.id,
                    colors: theme.colors
                });
            }

            // ğŸ”§ æ–°å¢ï¼šç›´æ¥æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜çš„ä¸»é¢˜æ ·å¼
            this.updateDataTableHeaderTheme(theme);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼å¤±è´¥:', error);
        }
    }
    /**
     * æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜çš„ä¸»é¢˜æ ·å¼
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    updateDataTableHeaderTheme(theme) {
        try {
            // æŸ¥æ‰¾æ•°æ®è¡¨æ ¼æ¨¡æ€æ¡†
            const dataTableModal = document.querySelector('.data-table-modal, .datatable-modal-new');
            if (!dataTableModal) {
                console.log('[InfoBarSettings] â„¹ï¸ æ•°æ®è¡¨æ ¼ç•Œé¢æœªæ‰“å¼€ï¼Œè·³è¿‡æ ‡é¢˜ä¸»é¢˜æ›´æ–°');
                return;
            }

            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const modalHeader = dataTableModal.querySelector('.modal-header');
            const modalTitle = dataTableModal.querySelector('.modal-title, h2');

            if (modalHeader && theme.colors) {
                // åº”ç”¨ä¸»é¢˜èƒŒæ™¯è‰²
                if (theme.colors.headerBg) {
                    modalHeader.style.background = theme.colors.headerBg;
                }
                if (theme.colors.headerBorder) {
                    modalHeader.style.borderBottomColor = theme.colors.headerBorder;
                }
            }

            if (modalTitle && theme.colors) {
                // åº”ç”¨ä¸»é¢˜æ–‡å­—è‰²
                if (theme.colors.headerText) {
                    modalTitle.style.color = theme.colors.headerText;
                }
            }

            // æ›´æ–°è¡¨æ ¼æ ‡é¢˜è¡Œ
            const tableHeader = dataTableModal.querySelector('.table-header');
            if (tableHeader && theme.colors) {
                if (theme.colors.tableBg) {
                    tableHeader.style.backgroundColor = theme.colors.tableBg;
                }
                if (theme.colors.tableText) {
                    tableHeader.style.color = theme.colors.tableText;
                }
                if (theme.colors.tableBorder) {
                    tableHeader.style.borderBottomColor = theme.colors.tableBorder;
                }
            }

            console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼æ ‡é¢˜ä¸»é¢˜å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * è°ƒæ•´é¢œè‰²äº®åº¦
     * @param {string} color - åå…­è¿›åˆ¶é¢œè‰²å€¼
     * @param {number} amount - è°ƒæ•´é‡ï¼ˆ-100åˆ°100ï¼‰
     * @returns {string} è°ƒæ•´åçš„é¢œè‰²å€¼
     */
    adjustColor(color, amount) {
        try {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è°ƒæ•´é¢œè‰²å¤±è´¥:', error);
            return color;
        }
    }

    /**
     * è·å–çŠ¶æ€ä¿¡æ¯
     */
    getStatus() {
        return {
            initialized: this.initialized,
            visible: this.visible,
            currentTab: this.currentTab,
            errorCount: this.errorCount
        };
    }

    /**
     * é”€æ¯ç»„ä»¶
     */
    destroy() {
        if (this.modal) {
            this.modal.remove();
            this.modal = null;
        }

        this.initialized = false;
        console.log('[InfoBarSettings] ğŸ’¥ è®¾ç½®ç•Œé¢å·²é”€æ¯');
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä»ç¼“å­˜åŠ è½½æ¨¡å‹åˆ—è¡¨
     */
    async loadCachedModelList(apiConfig) {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ å°è¯•ä»ç¼“å­˜åŠ è½½æ¨¡å‹åˆ—è¡¨...');

            // ç”Ÿæˆç¼“å­˜é”®ï¼ŒåŸºäºæä¾›å•†å’ŒAPIé…ç½®
            const cacheKey = this.generateModelCacheKey(apiConfig);
            console.log('[InfoBarSettings] ğŸ”‘ ç¼“å­˜é”®:', cacheKey);

            // ä»ConfigManagerè·å–ç¼“å­˜çš„æ¨¡å‹æ•°æ®
            const configManager = window.SillyTavernInfobar?.modules?.configManager;
            if (!configManager) {
                console.warn('[InfoBarSettings] âš ï¸ ConfigManageræœªæ‰¾åˆ°ï¼Œæ— æ³•è¯»å–ç¼“å­˜');
                return null;
            }

            const cachedData = await configManager.getConfig(`apiConfig.modelCache.${cacheKey}`);
            if (!cachedData) {
                console.log('[InfoBarSettings] â„¹ï¸ ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°æ¨¡å‹æ•°æ®');
                return null;
            }

            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆé»˜è®¤24å°æ—¶ï¼‰
            const cacheMaxAge = 24 * 60 * 60 * 1000; // 24å°æ—¶
            const now = Date.now();
            if (now - cachedData.timestamp > cacheMaxAge) {
                console.log('[InfoBarSettings] â° ç¼“å­˜å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°åŠ è½½');
                return null;
            }

            console.log(`[InfoBarSettings] âœ… ä»ç¼“å­˜åŠ è½½äº† ${cachedData.models.length} ä¸ªæ¨¡å‹`);
            return cachedData.models;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä»ç¼“å­˜åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç”Ÿæˆæ¨¡å‹ç¼“å­˜é”®
     */
    generateModelCacheKey(apiConfig) {
        // åŸºäºæä¾›å•†ã€æ¥å£ç±»å‹å’ŒåŸºç¡€URLç”Ÿæˆå”¯ä¸€é”®
        const provider = apiConfig.provider || 'unknown';
        const interfaceType = apiConfig.format || 'unknown';
        const baseUrl = apiConfig.baseUrl || apiConfig.endpoint || 'default';

        // åˆ›å»ºç®€çŸ­ä½†å”¯ä¸€çš„å“ˆå¸Œ
        const keyString = `${provider}_${interfaceType}_${baseUrl}`;
        return keyString.replace(/[^a-zA-Z0-9_]/g, '_').substring(0, 50);
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°ç¼“å­˜
     */
    async saveCachedModelList(apiConfig, models) {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°ç¼“å­˜...');

            const cacheKey = this.generateModelCacheKey(apiConfig);
            const cachedData = {
                models: models,
                timestamp: Date.now(),
                provider: apiConfig.provider,
                config: {
                    provider: apiConfig.provider,
                    format: apiConfig.format,
                    baseUrl: apiConfig.baseUrl || apiConfig.endpoint
                }
            };

            // ä¿å­˜åˆ°ConfigManager
            const configManager = window.SillyTavernInfobar?.modules?.configManager;
            if (configManager) {
                await configManager.setConfig(`apiConfig.modelCache.${cacheKey}`, cachedData);
                console.log(`[InfoBarSettings] âœ… å·²ç¼“å­˜ ${models.length} ä¸ªæ¨¡å‹`);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ ConfigManageræœªæ‰¾åˆ°ï¼Œæ— æ³•ä¿å­˜ç¼“å­˜');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ¨¡å‹åˆ—è¡¨ç¼“å­˜å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¡«å……æ¨¡å‹é€‰æ‹©æ¡†
     */
    populateModelSelect(models) {
        try {
            const modelSelect = this.modal.querySelector('#infobar-api-model');
            if (!modelSelect) {
                console.warn('[InfoBarSettings] âš ï¸ æ¨¡å‹é€‰æ‹©æ¡†æœªæ‰¾åˆ°');
                return;
            }

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';

            // æ·»åŠ æ¨¡å‹é€‰é¡¹
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                option.title = model.description || model.name;
                modelSelect.appendChild(option);
            });

            console.log(`[InfoBarSettings] âœ… å·²å¡«å…… ${models.length} ä¸ªæ¨¡å‹åˆ°é€‰æ‹©æ¡†`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¡«å……æ¨¡å‹é€‰æ‹©æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºæ¨¡å‹åŠ è½½æç¤º
     */
    showModelLoadingHint() {
        try {
            const connectionStatus = this.modal.querySelector('#infobar-connection-status');
            if (connectionStatus) {
                connectionStatus.innerHTML = `
                    <div style="color: #f59e0b;">
                        âš ï¸ æ¨¡å‹åˆ—è¡¨éœ€è¦æ‰‹åŠ¨åŠ è½½<br>
                        <small>ç‚¹å‡»"ğŸ“‹ åŠ è½½æ¨¡å‹åˆ—è¡¨"æŒ‰é’®è·å–æœ€æ–°æ¨¡å‹</small>
                    </div>
                `;
            }

            // åŒæ—¶æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†çš„æç¤º
            const modelSelect = this.modal.querySelector('#infobar-api-model');
            if (modelSelect) {
                modelSelect.innerHTML = '<option value="">è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨</option>';
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¨¡å‹åŠ è½½æç¤ºå¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½æ¨¡å‹åˆ—è¡¨
     */
    async loadModelList() {
        console.log('[InfoBarSettings] å¼€å§‹åŠ è½½æ¨¡å‹åˆ—è¡¨');

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const loadModelsBtn = this.modal.querySelector('#infobar-load-models-btn');
        const modelSelect = this.modal.querySelector('#infobar-api-model');
        const connectionStatus = this.modal.querySelector('#infobar-connection-status');

        if (loadModelsBtn) {
            loadModelsBtn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
            loadModelsBtn.disabled = true;
        }

        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„IDå‰ç¼€
            const provider = this.modal.querySelector('#infobar-api-provider')?.value;
            const interfaceType = this.modal.querySelector('#infobar-interface-type')?.value;
            const baseUrl = this.modal.querySelector('#infobar-api-base-url')?.value;
            const apiKey = this.modal.querySelector('#infobar-api-key')?.value;

            if (!provider || !interfaceType || !baseUrl || !apiKey) {
                throw new Error('è¯·å…ˆå®ŒæˆAPIé…ç½®ï¼ˆæä¾›å•†ã€æ¥å£ç±»å‹ã€åŸºç¡€URLã€APIå¯†é’¥ï¼‰');
            }

            let models = [];

            if (provider === 'gemini' && interfaceType === 'native') {
                // GeminiåŸç”Ÿæ¥å£
                models = await this.loadGeminiNativeModels(baseUrl, apiKey);
            } else if ((provider === 'gemini' && interfaceType === 'openai-compatible') ||
                       (provider === 'localproxy' && interfaceType === 'openai-compatible') ||
                       (provider === 'custom' && interfaceType === 'openai-compatible')) {
                // OpenAIå…¼å®¹æ¥å£
                models = await this.loadOpenAICompatibleModels(baseUrl, apiKey, provider);
            }

            // ğŸ”§ æ–°å¢ï¼šä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°ç¼“å­˜
            const apiConfig = {
                provider: provider,
                format: interfaceType,
                baseUrl: baseUrl,
                endpoint: baseUrl
            };
            await this.saveCachedModelList(apiConfig, models);

            // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
            this.populateModelSelect(models);

            if (connectionStatus) {
                connectionStatus.innerHTML = `
                    <div style="color: #10b981;">
                        âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹<br>
                        <small>æ¨¡å‹åˆ—è¡¨å·²ç¼“å­˜ï¼Œä¸‹æ¬¡æ‰“å¼€æ—¶å°†è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜</small>
                    </div>
                `;
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹å¹¶å·²ç¼“å­˜:`, models);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                connectionStatus.style.color = '#ef4444';
            }

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            this.showNotification('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
        } finally {
            if (loadModelsBtn) {
                loadModelsBtn.textContent = 'ğŸ”„ é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨';
                loadModelsBtn.disabled = false;
            }
        }
    }

    /**
     * åŠ è½½GeminiåŸç”Ÿæ¥å£æ¨¡å‹
     */
    async loadGeminiNativeModels(baseUrl, apiKey) {
        console.log('[InfoBarSettings] ğŸ”„ åŠ è½½GeminiåŸç”Ÿæ¨¡å‹...');

        // ä½¿ç”¨æ­£ç¡®çš„Gemini APIç«¯ç‚¹
        const modelsUrl = `${baseUrl}/v1beta/models?key=${apiKey}`;

        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', modelsUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    }
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    }
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ Geminiè¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®Geminiæ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Gemini APIé”™è¯¯ (${response.status}): ${errorText}`);
        }

        const data = await response.json();

        // è§£æGemini APIå“åº”æ ¼å¼
        const models = data.models?.map(model => ({
            id: model.name.replace('models/', ''), // ç§»é™¤ "models/" å‰ç¼€
            name: model.displayName || model.name.replace('models/', ''),
            description: model.description || `Geminiæ¨¡å‹: ${model.name}`
        })) || [];

        // è¿‡æ»¤å‡ºæ”¯æŒgenerateContentçš„æ¨¡å‹
        const supportedModels = models.filter(model =>
            model.id.includes('gemini') &&
            !model.id.includes('embedding')
        );

        console.log(`[InfoBarSettings] GeminiåŸç”Ÿæ¥å£åŠ è½½äº† ${supportedModels.length} ä¸ªæ¨¡å‹`);
        return supportedModels;
    }

    /**
     * åŠ è½½æœ¬åœ°åä»£æ¨¡å‹ (é€šè¿‡SillyTavernåç«¯)
     */
    async loadLocalProxyModels(baseUrl, apiKey) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ é€šè¿‡SillyTavernåç«¯åŠ è½½æœ¬åœ°åä»£æ¨¡å‹...');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // ğŸ”§ ä¿®å¤ï¼šæ„å»ºçŠ¶æ€æ£€æŸ¥è¯·æ±‚ - ä½¿ç”¨openaiä½œä¸ºchat_completion_source
            const statusUrl = `${window.location.origin}/api/backends/chat-completions/status`;
            const requestBody = {
                reverse_proxy: baseUrl,
                proxy_password: apiKey,
                chat_completion_source: "openai",  // ğŸ”§ ä¿®å¤ï¼šæ”¹ä¸ºopenaiä»¥æ­£ç¡®è·å–æ¨¡å‹åˆ—è¡¨
                custom_url: baseUrl,
                custom_include_headers: ""
            };

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£çŠ¶æ€æ£€æŸ¥:', {
                statusUrl,
                reverseProxy: baseUrl,
                hasPassword: !!apiKey,
                source: 'openai'  // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºä½¿ç”¨çš„source
            });

            const response = await fetch(statusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`æœ¬åœ°åä»£çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£çŠ¶æ€å“åº”:', data);

            // è§£ææ¨¡å‹åˆ—è¡¨
            let models = [];
            if (data.data && Array.isArray(data.data)) {
                models = data.data.map(model => ({
                    id: model.id || model.model || 'unknown',
                    name: model.id || model.model || model.name || 'Unknown Model',
                    description: model.description || `æœ¬åœ°åä»£æ¨¡å‹: ${model.id || model.model}`
                }));
            } else if (data.models && Array.isArray(data.models)) {
                models = data.models.map(model => ({
                    id: model.id || model.model || model.name || 'unknown',
                    name: model.name || model.id || model.model || 'Unknown Model',
                    description: model.description || `æœ¬åœ°åä»£æ¨¡å‹: ${model.id}`
                }));
            } else {
                // æä¾›é»˜è®¤æ¨¡å‹åˆ—è¡¨
                console.log('[InfoBarSettings] âš ï¸ æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹');
                models = [
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'æœ¬åœ°åä»£é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4', name: 'GPT-4', description: 'æœ¬åœ°åä»£é«˜çº§æ¨¡å‹' },
                    { id: 'claude-3-sonnet', name: 'Claude 3 Sonnet', description: 'æœ¬åœ°åä»£Claudeæ¨¡å‹' }
                ];
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæœ¬åœ°åä»£æ¨¡å‹`);
            return models;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æœ¬åœ°åä»£æ¨¡å‹å¤±è´¥:', error);

            // æä¾›é™çº§æ¨¡å‹åˆ—è¡¨
            const fallbackModels = [
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' },
                { id: 'gpt-4', name: 'GPT-4 (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' },
                { id: 'claude-3-sonnet', name: 'Claude 3 Sonnet (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' }
            ];

            const enhancedError = new Error(`${error.message} - å·²æä¾›é™çº§æ¨¡å‹åˆ—è¡¨`);
            enhancedError.fallbackModels = fallbackModels;
            enhancedError.originalError = error;
            throw enhancedError;
        }
    }

    /**
     * åŠ è½½OpenAIå…¼å®¹æ¥å£æ¨¡å‹
     */
    async loadOpenAICompatibleModels(baseUrl, apiKey, provider) {
        console.log('[InfoBarSettings] ğŸ”„ åŠ è½½OpenAIå…¼å®¹æ¨¡å‹...');

        let modelsUrl;
        let headers;

        if (provider === 'gemini') {
            // Gemini OpenAIå…¼å®¹æ¥å£
            modelsUrl = `https://generativelanguage.googleapis.com/v1beta/openai/models`;
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'User-Agent': 'SillyTavern-InfoBar/1.0'
            };
        } else if (provider === 'localproxy') {
            // æœ¬åœ°åä»£æ¥å£ - ä½¿ç”¨SillyTavernåç«¯ä»£ç†
            console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨æœ¬åœ°åä»£æ¨¡å¼åŠ è½½æ¨¡å‹...');
            return await this.loadLocalProxyModels(baseUrl, apiKey);
        } else {
            // è‡ªå®šä¹‰OpenAIå…¼å®¹æ¥å£
            modelsUrl = `${baseUrl}/models`;
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'User-Agent': 'SillyTavern-InfoBar/1.0'
            };
        }

        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', modelsUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(modelsUrl, {
                    method: 'GET',
                    headers: headers
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: headers
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ è¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥åä»£æœåŠ¡å™¨çš„CORSé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            let errorText = '';
            try {
                errorText = await response.text();
            } catch (e) {
                errorText = 'æ— æ³•è¯»å–é”™è¯¯å“åº”';
            }

            console.error('[InfoBarSettings] ğŸ”¥ APIå“åº”é”™è¯¯:', {
                status: response.status,
                statusText: response.statusText,
                url: modelsUrl,
                errorText: errorText.substring(0, 200)
            });

            throw new Error(`APIé”™è¯¯ (${response.status}): ${errorText}`);
        }

        let data;
        try {
            data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š APIå“åº”æ•°æ®ç»“æ„:', Object.keys(data));
        } catch (parseError) {
            console.error('[InfoBarSettings] âŒ å“åº”è§£æå¤±è´¥:', parseError);
            throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šæ— æ³•è§£æJSONæ•°æ®');
        }

        // ğŸ”§ å¢å¼ºçš„å“åº”æ ¼å¼å…¼å®¹æ€§å¤„ç†
        let models = [];

        if (data.data && Array.isArray(data.data)) {
            // æ ‡å‡†OpenAIæ ¼å¼: { "data": [...] }
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°æ ‡å‡†OpenAIæ ¼å¼');
            models = data.data.map(model => ({
                id: model.id || model.model || 'unknown',
                name: model.id || model.model || model.name || 'Unknown Model',
                description: model.description || `æ¨¡å‹: ${model.id || model.model || 'unknown'}`
            }));
        } else if (data.models && Array.isArray(data.models)) {
            // æŸäº›åä»£ä½¿ç”¨çš„æ ¼å¼: { "models": [...] }
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°è‡ªå®šä¹‰modelsæ ¼å¼');
            models = data.models.map(model => ({
                id: model.id || model.model || model.name || 'unknown',
                name: model.name || model.id || model.model || 'Unknown Model',
                description: model.description || `æ¨¡å‹: ${model.id || model.name || 'unknown'}`
            }));
        } else if (Array.isArray(data)) {
            // ç›´æ¥æ•°ç»„æ ¼å¼: [...]
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°ç›´æ¥æ•°ç»„æ ¼å¼');
            models = data.map(model => {
                if (typeof model === 'string') {
                    return { id: model, name: model, description: `æ¨¡å‹: ${model}` };
                } else {
                    return {
                        id: model.id || model.model || model.name || 'unknown',
                        name: model.name || model.id || model.model || 'Unknown Model',
                        description: model.description || `æ¨¡å‹: ${model.id || model.name || 'unknown'}`
                    };
                }
            });
        } else {
            console.warn('[InfoBarSettings] âš ï¸ æœªè¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œæä¾›é™çº§æ¨¡å‹åˆ—è¡¨');
            console.log('[InfoBarSettings] ğŸ” åŸå§‹å“åº”:', JSON.stringify(data, null, 2));

            // æä¾›é™çº§æ¨¡å‹åˆ—è¡¨
            if (provider === 'gemini') {
                models = [
                    { id: 'gemini-pro', name: 'Gemini Pro (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤Geminiæ¨¡å‹' },
                    { id: 'gemini-pro-vision', name: 'Gemini Pro Vision (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤Geminiè§†è§‰æ¨¡å‹' }
                ];
            } else {
                models = [
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4', name: 'GPT-4 (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' }
                ];
            }
        }

        // è¿‡æ»¤å’ŒéªŒè¯æ¨¡å‹åˆ—è¡¨
        models = models.filter(model =>
            model &&
            typeof model === 'object' &&
            model.id &&
            typeof model.id === 'string' &&
            model.id.trim() !== ''
        );

        console.log(`[InfoBarSettings] âœ… OpenAIå…¼å®¹æ¥å£æˆåŠŸåŠ è½½äº† ${models.length} ä¸ªæ¨¡å‹`);
        models.forEach((model, index) => {
            console.log(`[InfoBarSettings] ğŸ“‹ æ¨¡å‹ ${index + 1}: ${model.id} (${model.name})`);
        });

        return models;
    }

    /**
     * å¤„ç†APIå¯ç”¨çŠ¶æ€å˜æ›´
     */
    async handleAPIEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ APIå¯ç”¨çŠ¶æ€å˜æ›´:', enabled);

            if (enabled) {
                // å¯ç”¨è‡ªå®šä¹‰API
                console.log('[InfoBarSettings] âœ… å¯ç”¨è‡ªå®šä¹‰APIæ¨¡å¼');

                // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºå†²çªæ ‡ç­¾
                await this.setupMainAPIRestrictions();

                // åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†
                await this.initCustomAPIHandling();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('âœ… è‡ªå®šä¹‰APIå·²å¯ç”¨ï¼Œä¸»API Hookå·²æ¸…ç†', 'success');

            } else {
                // ç¦ç”¨è‡ªå®šä¹‰API
                console.log('[InfoBarSettings] â¸ï¸ ç¦ç”¨è‡ªå®šä¹‰APIæ¨¡å¼');

                // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™
                await this.removeMainAPIRestrictions();

                // æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†
                await this.clearCustomAPIHandling();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('â¸ï¸ è‡ªå®šä¹‰APIå·²ç¦ç”¨ï¼Œä¸»API Hookå·²æ¢å¤', 'info');
            }

            // æ›´æ–°é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            if (!extensionSettings['Information bar integration tool'].apiConfig) {
                extensionSettings['Information bar integration tool'].apiConfig = {};
            }

            extensionSettings['Information bar integration tool'].apiConfig.enabled = enabled;
            context.saveSettingsDebounced();

            // ğŸ”§ æ–°å¢ï¼šé€šçŸ¥å˜é‡ç³»ç»Ÿæç¤ºè¯æ¨¡å—APIçŠ¶æ€å˜æ›´
            const variableSystemPrompt = window.SillyTavernInfobar?.modules?.variableSystemPrompt;
            if (variableSystemPrompt) {
                try {
                    if (enabled) {
                        // å¯ç”¨è‡ªå®šä¹‰APIæ—¶ï¼Œæ¸…é™¤å˜é‡æç¤ºè¯é¿å…å†²çª
                        if (variableSystemPrompt.context?.setExtensionPrompt) {
                            variableSystemPrompt.context.setExtensionPrompt('information_bar_variable_reader', '', 1, 0);
                            console.log('[InfoBarSettings] ğŸ§¹ å·²æ¸…é™¤ä¸»APIå˜é‡æç¤ºè¯ï¼Œé¿å…ä¸è‡ªå®šä¹‰APIå†²çª');
                        }
                    } else {
                        // ç¦ç”¨è‡ªå®šä¹‰APIæ—¶ï¼Œé‡æ–°å¯ç”¨å˜é‡æç¤ºè¯
                        console.log('[InfoBarSettings] ğŸ”„ é‡æ–°å¯ç”¨ä¸»APIå˜é‡æç¤ºè¯...');
                        // è®¾ç½®æ ‡è®°ä»¥ä¾¿ä¸‹æ¬¡ç”Ÿæˆæ—¶é‡æ–°æ³¨å…¥
                        variableSystemPrompt.injectionActive = false;
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ æ›´æ–°å˜é‡ç³»ç»Ÿæç¤ºè¯çŠ¶æ€å¤±è´¥:', error);
                }
            }

            console.log('[InfoBarSettings] âœ… APIå¯ç”¨çŠ¶æ€å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†APIå¯ç”¨çŠ¶æ€å˜æ›´å¤±è´¥:', error);
            this.showNotification('âŒ APIçŠ¶æ€å˜æ›´å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†APIæä¾›å•†å˜æ›´
     */
    handleProviderChange(provider) {
        console.log('[InfoBarSettings] APIæä¾›å•†å˜æ›´:', provider);

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const interfaceTypeSelect = this.modal.querySelector('#infobar-interface-type');
        const interfaceTypeGroup = this.modal.querySelector('#infobar-interface-type-group');
        const baseUrlInput = this.modal.querySelector('#infobar-api-base-url');
        const baseUrlGroup = this.modal.querySelector('#infobar-base-url-group');

        if (!interfaceTypeSelect || !baseUrlInput) return;

        // ç¡®ä¿nameå±æ€§æ­£ç¡®
        interfaceTypeSelect.name = 'apiConfig.format';

        // æ¸…ç©ºæ¥å£ç±»å‹é€‰é¡¹
        interfaceTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¥å£ç±»å‹</option>';
        baseUrlInput.value = '';

        if (provider === 'gemini') {
            // ğŸ”§ ä¿®å¤ï¼šGeminiæä¾›å•† - é»˜è®¤é€‰æ‹©åŸç”Ÿæ¥å£ï¼Œéšè—åŸºç¡€URL
            if (interfaceTypeGroup) {
                interfaceTypeGroup.style.display = '';
            }
            if (baseUrlGroup) {
                baseUrlGroup.style.display = 'none'; // éšè—åŸºç¡€URLé…ç½®
            }
            interfaceTypeSelect.innerHTML = `
                <option value="native" selected>GeminiåŸç”Ÿæ¥å£</option>
                <option value="openai-compatible">OpenAIå…¼å®¹æ¥å£</option>
            `;
            interfaceTypeSelect.value = 'native'; // é»˜è®¤é€‰æ‹©åŸç”Ÿæ¥å£
            baseUrlInput.value = 'https://generativelanguage.googleapis.com'; // è®¾ç½®é»˜è®¤URL

            console.log('[InfoBarSettings] Geminiæ¨¡å¼ï¼šå·²è‡ªåŠ¨é€‰æ‹©åŸç”Ÿæ¥å£ï¼Œéšè—åŸºç¡€URLé…ç½®');
        } else if (provider === 'localproxy') {
            // é€šç”¨å…¨å…¼å®¹æä¾›å•† - éšè—æ¥å£ç±»å‹é€‰æ‹©ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºOpenAIå…¼å®¹
            if (interfaceTypeGroup) {
                interfaceTypeGroup.style.display = 'none';
            }
            if (baseUrlGroup) {
                baseUrlGroup.style.display = ''; // æ˜¾ç¤ºåŸºç¡€URLé…ç½®
            }
            interfaceTypeSelect.innerHTML = `
                <option value="openai-compatible" selected>OpenAIå…¼å®¹æ¥å£</option>
            `;
            interfaceTypeSelect.value = 'openai-compatible';
            // è®¾ç½®é»˜è®¤ç«¯ç‚¹
            baseUrlInput.value = 'http://127.0.0.1:7861/v1';
            baseUrlInput.placeholder = 'http://127.0.0.1:7861/v1';

            console.log('[InfoBarSettings] é€šç”¨å…¨å…¼å®¹æ¨¡å¼ï¼šå·²è‡ªåŠ¨é€‰æ‹©OpenAIå…¼å®¹æ¥å£');
        } else if (provider === 'custom') {
            // è‡ªå®šä¹‰APIæä¾›å•† - éšè—æ¥å£ç±»å‹é€‰æ‹©ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºOpenAIå…¼å®¹
            if (interfaceTypeGroup) {
                interfaceTypeGroup.style.display = 'none';
            }
            if (baseUrlGroup) {
                baseUrlGroup.style.display = ''; // æ˜¾ç¤ºåŸºç¡€URLé…ç½®
            }
            interfaceTypeSelect.innerHTML = `
                <option value="openai-compatible" selected>OpenAIå…¼å®¹æ¥å£</option>
            `;
            interfaceTypeSelect.value = 'openai-compatible';

            console.log('[InfoBarSettings] è‡ªå®šä¹‰APIæ¨¡å¼ï¼šå·²è‡ªåŠ¨é€‰æ‹©OpenAIå…¼å®¹æ¥å£');
        } else {
            // å…¶ä»–æƒ…å†µï¼Œæ˜¾ç¤ºæ¥å£ç±»å‹é€‰æ‹©å’ŒåŸºç¡€URL
            if (interfaceTypeGroup) {
                interfaceTypeGroup.style.display = '';
            }
            if (baseUrlGroup) {
                baseUrlGroup.style.display = '';
            }
        }
    }

    /**
     * å¤„ç†æ¥å£ç±»å‹å˜æ›´
     */
    handleInterfaceTypeChange(interfaceType) {
        console.log('[InfoBarSettings] æ¥å£ç±»å‹å˜æ›´:', interfaceType);

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const provider = this.modal.querySelector('#infobar-api-provider')?.value;
        const baseUrlInput = this.modal.querySelector('#infobar-api-base-url');
        const baseUrlGroup = this.modal.querySelector('#infobar-base-url-group');

        if (!baseUrlInput) return;

        // æ ¹æ®æä¾›å•†å’Œæ¥å£ç±»å‹è®¾ç½®é»˜è®¤URL
        if (provider === 'gemini') {
            if (interfaceType === 'native') {
                // ğŸ”§ ä¿®å¤ï¼šGeminiåŸç”Ÿæ¥å£ - éšè—åŸºç¡€URL
                if (baseUrlGroup) {
                    baseUrlGroup.style.display = 'none';
                }
                baseUrlInput.value = 'https://generativelanguage.googleapis.com';
                console.log('[InfoBarSettings] GeminiåŸç”Ÿæ¥å£ï¼šå·²éšè—åŸºç¡€URLé…ç½®');
            } else if (interfaceType === 'openai-compatible') {
                // ğŸ”§ ä¿®å¤ï¼šGemini OpenAIå…¼å®¹æ¥å£ - æ˜¾ç¤ºåŸºç¡€URL
                if (baseUrlGroup) {
                    baseUrlGroup.style.display = '';
                }
                baseUrlInput.value = 'https://generativelanguage.googleapis.com/v1beta/openai';
                console.log('[InfoBarSettings] Gemini OpenAIå…¼å®¹æ¥å£ï¼šå·²æ˜¾ç¤ºåŸºç¡€URLé…ç½®');
            }
        } else if (provider === 'localproxy') {
            if (interfaceType === 'openai-compatible') {
                baseUrlInput.value = 'http://127.0.0.1:7861/v1';
                baseUrlInput.placeholder = 'http://127.0.0.1:7861/v1';
            }
        } else if (provider === 'custom') {
            if (interfaceType === 'openai-compatible') {
                baseUrlInput.value = '';
                baseUrlInput.placeholder = 'https://your-api.com/v1';
            }
        }
    }

    /**
     * ğŸ†• å¤„ç†å‘é‡åŒ–APIæä¾›å•†å˜æ›´
     */
    handleVectorProviderChange(provider) {
        console.log('[InfoBarSettings] å‘é‡åŒ–APIæä¾›å•†å˜æ›´:', provider);

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const baseUrlInput = this.modal.querySelector('#infobar-vector-api-base-url');
        const baseUrlGroup = this.modal.querySelector('#vector-base-url-group');
        if (!baseUrlInput) return;

        // æ ¹æ®è¿æ¥æ¨¡å¼è®¾ç½®é»˜è®¤URLï¼ˆç”¨æˆ·å¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼‰
        if (provider === 'localproxy') {
            // é€šç”¨å…¨å…¼å®¹æ¨¡å¼ - ä½¿ç”¨SillyTavernåç«¯ä»£ç†ï¼ˆé»˜è®¤å€¼ï¼Œç”¨æˆ·å¯ä¿®æ”¹ï¼‰
            baseUrlInput.value = 'http://127.0.0.1:7861';
            baseUrlInput.placeholder = 'http://127.0.0.1:7861';
            baseUrlInput.readOnly = false;
            if (baseUrlGroup) baseUrlGroup.style.display = 'block';
            console.log('[InfoBarSettings] å‘é‡åŒ–APIï¼šé€šç”¨å…¨å…¼å®¹æ¨¡å¼ï¼Œå·²è®¾ç½®é»˜è®¤ç«¯ç‚¹ï¼ˆå¯ä¿®æ”¹ï¼‰');
        } else if (provider === 'siliconflow') {
            // ğŸ†• æµåŠ¨ç¡…åŸºæ¨¡å¼ - è‡ªåŠ¨è®¾ç½®å®˜æ–¹APIåœ°å€ï¼Œéšè—URLè¾“å…¥æ¡†
            baseUrlInput.value = 'https://api.siliconflow.cn/v1';
            baseUrlInput.placeholder = 'https://api.siliconflow.cn/v1';
            baseUrlInput.readOnly = true;
            if (baseUrlGroup) baseUrlGroup.style.display = 'none';
            console.log('[InfoBarSettings] å‘é‡åŒ–APIï¼šæµåŠ¨ç¡…åŸºæ¨¡å¼ï¼Œå·²è‡ªåŠ¨è®¾ç½®å®˜æ–¹APIåœ°å€');
        } else if (provider === 'custom') {
            // è‡ªå®šä¹‰APIæ¨¡å¼ - ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
            baseUrlInput.value = '';
            baseUrlInput.placeholder = 'https://your-api.com';
            baseUrlInput.readOnly = false;
            if (baseUrlGroup) baseUrlGroup.style.display = 'block';
            console.log('[InfoBarSettings] å‘é‡åŒ–APIï¼šè‡ªå®šä¹‰APIæ¨¡å¼ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ç«¯ç‚¹');
        } else {
            // æœªé€‰æ‹©æ¨¡å¼
            baseUrlInput.value = '';
            baseUrlInput.placeholder = 'è¯·å…ˆé€‰æ‹©è¿æ¥æ¨¡å¼';
            baseUrlInput.readOnly = true;
            if (baseUrlGroup) baseUrlGroup.style.display = 'block';
        }
    }

    /**
     * æµ‹è¯•æœ¬åœ°åä»£è¿æ¥ (é€šè¿‡SillyTavernåç«¯)
     */
    async testLocalProxyConnection(baseUrl, apiKey, connectionStatus) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æµ‹è¯•æœ¬åœ°åä»£è¿æ¥...');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // æ„å»ºçŠ¶æ€æ£€æŸ¥è¯·æ±‚
            const statusUrl = `${window.location.origin}/api/backends/chat-completions/status`;
            const requestBody = {
                reverse_proxy: baseUrl,
                proxy_password: apiKey,
                chat_completion_source: "custom",
                custom_url: baseUrl,
                custom_include_headers: ""
            };

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£è¿æ¥æµ‹è¯•:', {
                statusUrl,
                reverseProxy: baseUrl,
                hasPassword: !!apiKey
            });

            const response = await fetch(statusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å“åº”:', data);

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (data.error) {
                throw new Error(`æœ¬åœ°åä»£é”™è¯¯: ${data.error.message || data.error}`);
            }

            // è¿æ¥æˆåŠŸ
            if (connectionStatus) {
                connectionStatus.textContent = 'âœ… æœ¬åœ°åä»£è¿æ¥æˆåŠŸ';
                connectionStatus.style.color = '#10b981';
            }

            let modelCount = 0;
            if (data.data && Array.isArray(data.data)) {
                modelCount = data.data.length;
            } else if (data.models && Array.isArray(data.models)) {
                modelCount = data.models.length;
            }

            this.showNotification(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•æˆåŠŸï¼æ£€æµ‹åˆ° ${modelCount} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = 'âŒ æœ¬åœ°åä»£è¿æ¥å¤±è´¥';
                connectionStatus.style.color = '#ef4444';
            }

            throw new Error(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * æµ‹è¯•APIè¿æ¥
     */
    async testConnection() {
        console.log('[InfoBarSettings] å¼€å§‹æµ‹è¯•APIè¿æ¥');

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const testBtn = this.modal.querySelector('#infobar-test-connection-btn');
        const connectionStatus = this.modal.querySelector('#infobar-connection-status');

        if (testBtn) {
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
        }

        try {
            // è·å–é…ç½®
            const provider = this.modal.querySelector('#infobar-api-provider')?.value;
            const interfaceType = this.modal.querySelector('#infobar-interface-type')?.value;
            const baseUrl = this.modal.querySelector('#infobar-api-base-url')?.value;
            const apiKey = this.modal.querySelector('#infobar-api-key')?.value;

            if (!provider || !interfaceType || !baseUrl || !apiKey) {
                throw new Error('è¯·å®Œæˆæ‰€æœ‰å¿…å¡«é…ç½®é¡¹');
            }

            // æ‰§è¡Œè¿æ¥æµ‹è¯•
            if (provider === 'localproxy') {
                // æœ¬åœ°åä»£ä½¿ç”¨ä¸“ç”¨çš„æµ‹è¯•é€»è¾‘
                console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨æœ¬åœ°åä»£ä¸“ç”¨æµ‹è¯•é€»è¾‘...');
                await this.testLocalProxyConnection(baseUrl, apiKey, connectionStatus);
                return;
            }

            let testUrl;
            let headers;

            if (provider === 'gemini' && interfaceType === 'native') {
                testUrl = `${baseUrl}/v1beta/models?key=${apiKey}`;
                headers = {
                    'Content-Type': 'application/json',
                    'User-Agent': 'SillyTavern-InfoBar/1.0'
                };
            } else {
                testUrl = `${baseUrl}/models`;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'User-Agent': 'SillyTavern-InfoBar/1.0'
                };
            }

            console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¿æ¥æµ‹è¯•:', testUrl);

            let response;
            try {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
                if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                    response = await this.apiIntegration.proxyCompatibleFetch(testUrl, {
                        method: 'GET',
                        headers: headers,
                        timeout: 10000
                    });
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                    response = await fetch(testUrl, {
                        method: 'GET',
                        headers: headers,
                        timeout: 10000
                    });
                }
            } catch (fetchError) {
                console.error('[InfoBarSettings] âŒ è¿æ¥æµ‹è¯•è¯·æ±‚å¤±è´¥:', fetchError);

                // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
                if (fetchError.message.includes('CORS_BLOCKED') ||
                    fetchError.message.includes('CORS') ||
                    (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                    throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®APIæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åä»£é…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
                }

                throw fetchError;
            }

            if (response.ok) {
                if (connectionStatus) {
                    connectionStatus.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    connectionStatus.style.color = '#10b981';
                }
                this.showNotification('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                throw new Error(`è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
                connectionStatus.style.color = '#ef4444';
            }

            this.showNotification('APIè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        } finally {
            if (testBtn) {
                testBtn.textContent = 'ğŸ” æµ‹è¯•è¿æ¥';
                testBtn.disabled = false;
            }
        }
    }

    /**
     * è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºç‰¹å®šæ ‡ç­¾
     */
    async setupMainAPIRestrictions() {
        try {
            console.log('[InfoBarSettings] ğŸš« è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºå†²çªæ ‡ç­¾...');

            // ğŸ”§ ä¿®å¤ï¼šå‘é€é™åˆ¶è§„åˆ™æç¤ºè¯ç»™ä¸»APIï¼Œè€Œä¸æ˜¯æ‹¦æˆª
            await this.injectRestrictionPromptToMainAPI();

            // ğŸ”§ ä¿ç•™ï¼šæ‹¦æˆªä¸»APIå¯¹æ¶ˆæ¯å†…å®¹çš„è®¿é—®ï¼Œéšè—infobar_data
            await this.setupMessageContentFilter();

            console.log('[InfoBarSettings] âœ… ä¸»APIé™åˆ¶è§„åˆ™è®¾ç½®å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å‘ä¸»APIæ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯
     */
    async injectRestrictionPromptToMainAPI() {
        try {
            console.log('[InfoBarSettings] ğŸ“ å‘ä¸»APIæ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯...');

            // åˆ›å»ºé™åˆ¶è§„åˆ™æç¤ºè¯
            const restrictionPrompt = this.createRestrictionPrompt();

            // ä½¿ç”¨SillyTavernçš„æ‰©å±•æç¤ºè¯æœºåˆ¶
            const context = SillyTavern.getContext();
            if (context && context.setExtensionPrompt) {
                context.setExtensionPrompt(
                    'Information bar integration tool - Restrictions',
                    restrictionPrompt,
                    1, // é«˜ä¼˜å…ˆçº§
                    false // ä¸ç¦ç”¨
                );
                console.log('[InfoBarSettings] âœ… é™åˆ¶è§„åˆ™æç¤ºè¯å·²æ³¨å…¥åˆ°ä¸»API');
                console.log('[InfoBarSettings] ğŸ“ æç¤ºè¯é•¿åº¦:', restrictionPrompt.length);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä½¿ç”¨SillyTavernæ‰©å±•æç¤ºè¯æœºåˆ¶');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºé™åˆ¶è§„åˆ™æç¤ºè¯
     */
    createRestrictionPrompt() {
        return `ã€é‡è¦æŠ€æœ¯æ€§é™åˆ¶ - ç¦æ­¢è¾“å‡ºç‰¹å®šæ ‡ç­¾ã€‘
âš ï¸ ä¸¥æ ¼ç¦æ­¢åœ¨å›å¤ä¸­åŒ…å«ä»¥ä¸‹æŠ€æœ¯æ€§æ ‡ç­¾ï¼š

ğŸš« ç¦æ­¢è¾“å‡ºçš„XMLæ ‡ç­¾ï¼š
- <aiThinkProcess>...</aiThinkProcess>
- <infobar_data>...</infobar_data>



ğŸ“‹ è¯´æ˜ï¼š
è¿™äº›æ˜¯çº¯æŠ€æœ¯æ€§é™åˆ¶ï¼Œç”¨äºé¿å…ä¸ä¸“ç”¨ä¿¡æ¯æ ç³»ç»Ÿäº§ç”Ÿå†²çªã€‚
è¿™äº›é™åˆ¶ä¸å½±å“ä½ çš„æ­£å¸¸åˆ›ä½œå’Œè¡¨è¾¾èƒ½åŠ›ã€‚

---`;
    }

    /**
     * ğŸ†• åŠ è½½å‘é‡åŒ–APIæ¨¡å‹åˆ—è¡¨
     */
    async loadVectorModelList() {
        console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åŠ è½½å‘é‡åŒ–APIæ¨¡å‹åˆ—è¡¨');

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const loadBtn = this.modal.querySelector('#infobar-load-vector-models-btn');
        const modelSelect = this.modal.querySelector('#infobar-vector-api-model');
        const rerankModelSelect = this.modal.querySelector('#infobar-vector-api-rerank-model'); // ğŸ†• é‡æ’åºæ¨¡å‹ä¸‹æ‹‰æ¡†
        const statusDiv = this.modal.querySelector('#infobar-vector-model-status');

        if (loadBtn) {
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
            loadBtn.disabled = true;
        }

        try {
            // è·å–é…ç½®
            const provider = this.modal.querySelector('#infobar-vector-api-provider')?.value;
            const baseUrl = this.modal.querySelector('#infobar-vector-api-base-url')?.value;
            const apiKey = this.modal.querySelector('#infobar-vector-api-key')?.value;

            if (!baseUrl || !apiKey) {
                throw new Error('è¯·å…ˆå®Œæˆå‘é‡åŒ–APIé…ç½®ï¼ˆåŸºç¡€URLã€APIå¯†é’¥ï¼‰');
            }

            // ä½¿ç”¨CustomVectorAPIAdapterè·å–æ¨¡å‹åˆ—è¡¨
            const { CustomVectorAPIAdapter } = await import('../core/CustomVectorAPIAdapter.js');
            const adapter = new CustomVectorAPIAdapter({
                url: baseUrl,
                apiKey: apiKey
            });

            // ğŸ”„ è·å–embeddingæ¨¡å‹åˆ—è¡¨
            const embeddingModels = await adapter.getEmbeddingModels();

            if (!embeddingModels || embeddingModels.length === 0) {
                throw new Error('æœªæ‰¾åˆ°å¯ç”¨çš„embeddingæ¨¡å‹');
            }

            // ğŸ”„ è·å–rerankeræ¨¡å‹åˆ—è¡¨
            const rerankModels = await adapter.getRerankModels();

            // æ›´æ–°embeddingæ¨¡å‹ä¸‹æ‹‰æ¡†
            if (modelSelect) {
                modelSelect.innerHTML = '';
                embeddingModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                });

                console.log('[InfoBarSettings] âœ… æˆåŠŸåŠ è½½', embeddingModels.length, 'ä¸ªembeddingæ¨¡å‹');
            }

            // ğŸ†• æ›´æ–°rerankeræ¨¡å‹ä¸‹æ‹‰æ¡†
            if (rerankModelSelect) {
                // ä¿ç•™"ä¸ä½¿ç”¨é‡æ’åº"é€‰é¡¹
                const currentValue = rerankModelSelect.value;
                rerankModelSelect.innerHTML = '<option value="">-- ä¸ä½¿ç”¨é‡æ’åº --</option>';

                rerankModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    rerankModelSelect.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                if (currentValue && rerankModels.some(m => m.id === currentValue)) {
                    rerankModelSelect.value = currentValue;
                }

                console.log('[InfoBarSettings] âœ… æˆåŠŸåŠ è½½', rerankModels.length, 'ä¸ªrerankeræ¨¡å‹');
            }

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #4CAF50;">âœ… æˆåŠŸåŠ è½½ ${embeddingModels.length} ä¸ªembeddingæ¨¡å‹ï¼Œ${rerankModels.length} ä¸ªrerankeræ¨¡å‹</span>`;
            }

            this.showNotification(`âœ… æˆåŠŸåŠ è½½ ${embeddingModels.length} ä¸ªembeddingæ¨¡å‹ï¼Œ${rerankModels.length} ä¸ªrerankeræ¨¡å‹`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å‘é‡åŒ–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);

            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #f44336;">âŒ ${error.message}</span>`;
            }

            this.showNotification(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');

        } finally {
            if (loadBtn) {
                loadBtn.innerHTML = 'ğŸ”„ åŠ è½½æ¨¡å‹';
                loadBtn.disabled = false;
            }
        }
    }

    /**
     * ğŸ†• æµ‹è¯•å‘é‡åŒ–APIè¿æ¥
     */
    async testVectorConnection() {
        console.log('[InfoBarSettings] ğŸ” å¼€å§‹æµ‹è¯•å‘é‡åŒ–APIè¿æ¥');

        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨this.modalé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œé¿å…è¢«å…¶ä»–æ’ä»¶å½±å“
        if (!this.modal) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            return;
        }

        const testBtn = this.modal.querySelector('#infobar-test-vector-connection-btn');
        const statusDiv = this.modal.querySelector('#infobar-vector-model-status');

        if (testBtn) {
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
        }

        try {
            // è·å–é…ç½®
            const provider = this.modal.querySelector('#infobar-vector-api-provider')?.value;
            const baseUrl = this.modal.querySelector('#infobar-vector-api-base-url')?.value;
            const apiKey = this.modal.querySelector('#infobar-vector-api-key')?.value;
            const model = this.modal.querySelector('#infobar-vector-api-model')?.value;

            if (!baseUrl || !apiKey) {
                throw new Error('è¯·å…ˆå®Œæˆå‘é‡åŒ–APIé…ç½®ï¼ˆåŸºç¡€URLã€APIå¯†é’¥ï¼‰');
            }

            if (!model) {
                throw new Error('è¯·å…ˆé€‰æ‹©å‘é‡åŒ–æ¨¡å‹');
            }

            // ä½¿ç”¨CustomVectorAPIAdapteræµ‹è¯•è¿æ¥
            const { CustomVectorAPIAdapter } = await import('../core/CustomVectorAPIAdapter.js');
            const adapter = new CustomVectorAPIAdapter({
                url: baseUrl,
                apiKey: apiKey,
                model: model
            });

            // æµ‹è¯•å‘é‡åŒ–
            const testText = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬';
            const vector = await adapter.vectorizeText(testText);

            if (!vector || !Array.isArray(vector) || vector.length === 0) {
                throw new Error('å‘é‡åŒ–è¿”å›æ•°æ®æ— æ•ˆ');
            }

            console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æµ‹è¯•æˆåŠŸï¼Œç»´åº¦:', vector.length);

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #4CAF50;">âœ… è¿æ¥æˆåŠŸï¼å‘é‡ç»´åº¦: ${vector.length}</span>`;
            }

            this.showNotification(`âœ… å‘é‡åŒ–APIè¿æ¥æˆåŠŸï¼ç»´åº¦: ${vector.length}`, 'success');

            // è‡ªåŠ¨æ›´æ–°ç»´åº¦é…ç½®
            const dimensionsInput = this.modal.querySelector('#infobar-vector-api-dimensions');
            if (dimensionsInput) {
                dimensionsInput.value = vector.length;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•å‘é‡åŒ–APIè¿æ¥å¤±è´¥:', error);

            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #f44336;">âŒ ${error.message}</span>`;
            }

            this.showNotification(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');

        } finally {
            if (testBtn) {
                testBtn.innerHTML = 'ğŸ” æµ‹è¯•è¿æ¥';
                testBtn.disabled = false;
            }
        }
    }

    /**
     * åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†
     */
    async initCustomAPIHandling() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†...');

            // æ³¨å†Œæ¶ˆæ¯æ¥æ”¶äº‹ä»¶ç›‘å¬å™¨
            const context = SillyTavern.getContext();
            if (context && context.eventSource) {
                // ä½¿ç”¨ç¨³å®šçš„ç»‘å®šå¼•ç”¨ï¼Œç¡®ä¿removeListenerç”Ÿæ•ˆ
                if (!this._boundHandlers.handleGenerationEnded) {
                    this._boundHandlers.handleGenerationEnded = this.handleGenerationEnded.bind(this);
                }
                if (!this._boundHandlers.handleMessageReceived) {
                    this._boundHandlers.handleMessageReceived = this.handleMessageReceived.bind(this);
                }

                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨ï¼ˆä½¿ç”¨ç›¸åŒå¼•ç”¨ï¼‰
                context.eventSource.removeListener('message_received', this._boundHandlers.handleMessageReceived);
                context.eventSource.removeListener('generation_ended', this._boundHandlers.handleGenerationEnded);

                // æ·»åŠ ç›‘å¬å™¨ï¼ˆä»…æ·»åŠ ä¸€æ¬¡ï¼‰
                context.eventSource.on('generation_ended', this._boundHandlers.handleGenerationEnded);
                // æŒ‰éœ€ï¼šå¦‚æœä¹Ÿéœ€è¦åœ¨message_receivedæ—¶è§¦å‘ï¼Œåˆ™æ‰“å¼€ä¸‹ä¸€è¡Œ
                // context.eventSource.on('message_received', this._boundHandlers.handleMessageReceived);

                console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIäº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ');
            }

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIå¤„ç†åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†ç”Ÿæˆç»“æŸäº‹ä»¶ï¼ˆç¡®ä¿ä¸»APIå®Œæˆåæ‰å¤„ç†ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ AIæ¶ˆæ¯éªŒè¯ï¼Œé¿å…å¤„ç†æ—§æ¶ˆæ¯
     */
    async handleGenerationEnded() {
        try {
            console.log('[InfoBarSettings] ğŸ æ”¶åˆ°ç”Ÿæˆç»“æŸäº‹ä»¶...');

            // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ–°çš„ç”Ÿæˆå¼€å§‹æ—¶ï¼Œé‡ç½®ä¸­æ­¢æ ‡å¿—
            // è¿™æ ·ç”¨æˆ·åœ¨ä¸Šä¸€æ¬¡ä¸­æ­¢åï¼Œæ–°æ¶ˆæ¯å¯ä»¥æ­£å¸¸è°ƒç”¨è‡ªå®šä¹‰API
            if (this._customAPIAborted) {
                console.log('[InfoBarSettings] ğŸ”„ æ£€æµ‹åˆ°ä¸­æ­¢æ ‡å¿—ï¼Œæ–°æ¶ˆæ¯ç”Ÿæˆæ—¶è‡ªåŠ¨é‡ç½®');
                this._customAPIAborted = false;
            }

            // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            if (!configs.apiConfig || !configs.apiConfig.enabled) {
                console.log('[InfoBarSettings] â„¹ï¸ è‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const latestAIMessage = this.getLatestAIMessage();
            if (!latestAIMessage) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
            const isValidMessage = this.validateAIMessageIsNew(latestAIMessage);
            if (!isValidMessage) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°çš„AIæ¶ˆæ¯ä¸æ˜¯æ–°ç”Ÿæˆçš„æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯AIç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡å¤„ç†');
                console.log('[InfoBarSettings] ğŸ“ è¿™é¿å…äº†ä½¿ç”¨ä¸Šä¸€æ¡AIæ¶ˆæ¯çš„å‰§æƒ…å†…å®¹è°ƒç”¨è‡ªå®šä¹‰APIçš„é”™è¯¯');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure('AIæ¶ˆæ¯éªŒè¯å¤±è´¥ï¼šè·å–åˆ°çš„æ˜¯æ—§æ¶ˆæ¯ï¼Œå¯èƒ½AIç”ŸæˆæœªæˆåŠŸ');
                return;
            }

            console.log('[InfoBarSettings] âœ… éªŒè¯é€šè¿‡ï¼šè¿™æ˜¯ä¸€æ¡æ–°ç”Ÿæˆçš„AIæ¶ˆæ¯');

            // ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
            const lengthValidation = this.validateAIMessageLength(latestAIMessage, 100);
            if (!lengthValidation.isValid) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼Œè·³è¿‡ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                console.log('[InfoBarSettings] ğŸ“ è¿™é€šå¸¸è¡¨ç¤ºAIè¾“å‡ºè¢«æˆªæ–­æˆ–å†…å®¹è¿‡äºç®€çŸ­');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure(`AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼š${lengthValidation.reason}`);
                return;
            }

            console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯é•¿åº¦éªŒè¯é€šè¿‡ï¼Œå†…å®¹é•¿åº¦å……è¶³');

            // ğŸ†• å…³é”®ä¿®å¤ï¼šåœ¨å‘é€ç»™è‡ªå®šä¹‰APIä¹‹å‰ï¼Œåº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ä¸»APIè¿”å›çš„æ ‡ç­¾
            let cleanedMessage = latestAIMessage.mes;
            
            try {
                const regexScriptManager = window.SillyTavernInfobar?.modules?.regexScriptManager;
                if (regexScriptManager) {
                    const originalLength = cleanedMessage.length;
                    // åº”ç”¨OUTPUT placementçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆè¿‡æ»¤ä¸»APIè¿”å›çš„æ ‡ç­¾ï¼‰
                    cleanedMessage = regexScriptManager.applyAllScripts(cleanedMessage, 'OUTPUT', 'AI_OUTPUT');
                    if (cleanedMessage.length !== originalLength) {
                        console.log('[InfoBarSettings] ğŸ“ OUTPUTæ­£åˆ™è¡¨è¾¾å¼å·²åº”ç”¨ï¼ˆè¿‡æ»¤ä¸»APIæ ‡ç­¾ï¼‰ï¼Œå†…å®¹é•¿åº¦:', originalLength, '->', cleanedMessage.length);
                    }
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ åº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼å¤±è´¥:', error);
            }

            // åœ¨åŒAPIåä½œæ¨¡å¼ä¸‹ï¼Œä¸»APIä¸åº”è¯¥åŒ…å«infobar_data
            // å¦‚æœåŒ…å«äº†ï¼Œè¯´æ˜ä¸»API Hookæ²¡æœ‰ç”Ÿæ•ˆï¼Œéœ€è¦æ¸…ç†
            if (cleanedMessage && cleanedMessage.includes('<infobar_data>')) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°ä¸»APIè¿”å›äº†infobar_dataï¼Œæ¸…ç†å¹¶é‡æ–°å¤„ç†...');

                // æ¸…ç†ä¸»APIè¿”å›çš„infobar_data
                cleanedMessage = cleanedMessage.replace(/<infobar_data>[\s\S]*?<\/infobar_data>/g, '').trim();

                console.log('[InfoBarSettings] ğŸ§¹ å·²æ¸…ç†ä¸»APIè¿”å›çš„infobar_data');
            }

            console.log('[InfoBarSettings] ğŸ¤– ä¸»APIç”Ÿæˆå®Œæˆï¼Œå¼€å§‹å¤„ç†ä¿¡æ¯æ æ•°æ®...');

            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ï¼Œé¿å…é¢‘ç¹å¹¶å‘è°ƒç”¨
            // ğŸ†• ä¿®å¤ï¼šé€šè¿‡handleMainAPIResponseå¤„ç†ï¼Œä»¥æ”¯æŒå»¶è¿Ÿç”ŸæˆåŠŸèƒ½
            if (this.customAPITaskQueue && typeof this.customAPITaskQueue.handleMainAPIResponse === 'function') {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ä¿¡æ¯æ æ•°æ®ç”Ÿæˆï¼ˆæ”¯æŒå»¶è¿Ÿç”Ÿæˆï¼‰');
                // æ„é€ æ¶ˆæ¯å¯¹è±¡ï¼Œæ¨¡æ‹Ÿmessage_receivedäº‹ä»¶çš„æ•°æ®æ ¼å¼
                await this.customAPITaskQueue.handleMainAPIResponse({
                    mes: cleanedMessage,
                    is_user: false
                });
            } else if (this.customAPITaskQueue) {
                // å›é€€åˆ°ç›´æ¥æ·»åŠ ä»»åŠ¡ï¼ˆä¸æ”¯æŒå»¶è¿Ÿç”Ÿæˆï¼‰
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ä¿¡æ¯æ æ•°æ®ç”Ÿæˆï¼ˆç›´æ¥æ·»åŠ ï¼‰');
                this.customAPITaskQueue.addTask({
                    type: 'INFOBAR_DATA',
                    data: { content: cleanedMessage },
                    source: 'generation_ended'
                });
            } else {
                // å›é€€åˆ°åŸæœ‰é€»è¾‘
                console.log('[InfoBarSettings] âš ï¸ ä»»åŠ¡é˜Ÿåˆ—ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘');
                await this.processWithCustomAPI(cleanedMessage);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç”Ÿæˆç»“æŸäº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨ï¼Œåœ¨è‡ªå®šä¹‰APIæ¨¡å¼ä¸‹éšè—infobar_data
     */
    async setupMessageContentFilter() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨...');

            const context = SillyTavern.getContext();
            if (!context || !context.chat) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–èŠå¤©ä¸Šä¸‹æ–‡');
                return;
            }

            // ä¿å­˜åŸå§‹çš„chatæ•°ç»„ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ä¿å­˜ï¼‰
            if (!context._originalChat) {
                // åˆ›å»ºåŸå§‹æ•°ç»„çš„å‰¯æœ¬ï¼Œé¿å…å¾ªç¯å¼•ç”¨
                context._originalChat = [...context.chat];
                console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜åŸå§‹èŠå¤©æ•°ç»„å¼•ç”¨ï¼Œé•¿åº¦:', context._originalChat.length);
            }

            // åˆ›å»ºä¸€ä¸ªä»£ç†æ•°ç»„ï¼ŒåŠ¨æ€è¿‡æ»¤infobar_dataå†…å®¹
            const filteredChat = new Proxy(context._originalChat, {
                get: (target, prop) => {
                    // å¦‚æœè®¿é—®çš„æ˜¯æ•°ç»„ç´¢å¼•
                    if (typeof prop === 'string' && /^\d+$/.test(prop)) {
                        const index = parseInt(prop);
                        const message = target[index];

                        if (message && message.mes && typeof message.mes === 'string') {
                            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªå®šä¹‰APIæ¨¡å¼
                            const currentContext = SillyTavern.getContext();
                            const extensionSettings = currentContext.extensionSettings['Information bar integration tool'] || {};
                            const apiConfig = extensionSettings.apiConfig || {};

                            if (apiConfig.enabled && apiConfig.apiKey && apiConfig.model) {
                                // åœ¨è‡ªå®šä¹‰APIæ¨¡å¼ä¸‹ï¼Œè¿‡æ»¤æ‰infobar_dataå†…å®¹
                                const filteredMessage = { ...message };
                                const originalMes = message.mes;
                                filteredMessage.mes = originalMes.replace(/<infobar_data>[\s\S]*?<\/infobar_data>/gi, '').trim();

                                // å¦‚æœè¿‡æ»¤åå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œè®°å½•æ—¥å¿—
                                if (filteredMessage.mes !== originalMes) {
                                    console.log('[InfoBarSettings] ğŸ” å·²è¿‡æ»¤æ¶ˆæ¯ä¸­çš„infobar_dataå†…å®¹ï¼Œæ¶ˆæ¯ç´¢å¼•:', index);
                                    console.log('[InfoBarSettings] ğŸ“ åŸå§‹é•¿åº¦:', originalMes.length, 'è¿‡æ»¤åé•¿åº¦:', filteredMessage.mes.length);
                                }

                                return filteredMessage;
                            }
                        }

                        return message;
                    }

                    // å¯¹äºå…¶ä»–å±æ€§ï¼ˆå¦‚length, push, popç­‰ï¼‰ï¼Œç›´æ¥è¿”å›åŸå§‹å€¼
                    const value = target[prop];
                    if (typeof value === 'function') {
                        return value.bind(target);
                    }
                    return value;
                }
            });

            // æ›¿æ¢context.chatä¸ºè¿‡æ»¤åçš„ä»£ç†æ•°ç»„
            context.chat = filteredChat;
            console.log('[InfoBarSettings] âœ… æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨å·²è®¾ç½®');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™
     */
    async removeMainAPIRestrictions() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™...');

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯
            await this.removeRestrictionPromptFromMainAPI();

            // ğŸ”§ ä¿ç•™ï¼šæ¢å¤åŸå§‹çš„èŠå¤©æ•°ç»„
            const context = SillyTavern.getContext();
            if (context && context._originalChat) {
                context.chat = context._originalChat;
                delete context._originalChat;
                console.log('[InfoBarSettings] âœ… åŸå§‹èŠå¤©æ•°ç»„å·²æ¢å¤');
            }

            console.log('[InfoBarSettings] âœ… ä¸»APIé™åˆ¶è§„åˆ™ç§»é™¤å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä»ä¸»APIç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯
     */
    async removeRestrictionPromptFromMainAPI() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ ä»ä¸»APIç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯...');

            // ä½¿ç”¨SillyTavernçš„æ‰©å±•æç¤ºè¯æœºåˆ¶ç§»é™¤é™åˆ¶è§„åˆ™
            const context = SillyTavern.getContext();
            if (context && context.setExtensionPrompt) {
                context.setExtensionPrompt(
                    'Information bar integration tool - Restrictions',
                    '', // ç©ºæç¤ºè¯è¡¨ç¤ºç§»é™¤
                    1,
                    true // ç¦ç”¨
                );
                console.log('[InfoBarSettings] âœ… é™åˆ¶è§„åˆ™æç¤ºè¯å·²ä»ä¸»APIç§»é™¤');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä½¿ç”¨SillyTavernæ‰©å±•æç¤ºè¯æœºåˆ¶ç§»é™¤é™åˆ¶è§„åˆ™');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†
     */
    async clearCustomAPIHandling() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†...');

            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            const context = SillyTavern.getContext();
            if (context && context.eventSource) {
                context.eventSource.removeListener('message_received', this.handleMessageReceived);
                context.eventSource.removeListener('generation_ended', this.handleGenerationEnded);
                console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIäº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤');
            }

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIå¤„ç†æ¸…ç†å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼ˆè‡ªå®šä¹‰APIæ¨¡å¼ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ AIæ¶ˆæ¯éªŒè¯ï¼Œé¿å…å¤„ç†æ—§æ¶ˆæ¯
     */
    async handleMessageReceived() {
        try {
            console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯æ¥æ”¶äº‹ä»¶...');

            // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            if (!configs.apiConfig || !configs.apiConfig.enabled) {
                console.log('[InfoBarSettings] â„¹ï¸ è‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const latestAIMessage = this.getLatestAIMessage();
            if (!latestAIMessage) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
            const isValidMessage = this.validateAIMessageIsNew(latestAIMessage);
            if (!isValidMessage) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°çš„AIæ¶ˆæ¯ä¸æ˜¯æ–°ç”Ÿæˆçš„æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
            const lengthValidation = this.validateAIMessageLength(latestAIMessage, 100);
            if (!lengthValidation.isValid) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼Œè·³è¿‡ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                console.log('[InfoBarSettings] ğŸ“ è¿™é€šå¸¸è¡¨ç¤ºAIè¾“å‡ºè¢«æˆªæ–­æˆ–å†…å®¹è¿‡äºç®€çŸ­');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure(`AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼š${lengthValidation.reason}`);
                return;
            }

            console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯é•¿åº¦éªŒè¯é€šè¿‡ï¼Œå†…å®¹é•¿åº¦å……è¶³');

            // ğŸ†• å…³é”®ä¿®å¤ï¼šåœ¨å‘é€ç»™è‡ªå®šä¹‰APIä¹‹å‰ï¼Œåº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ä¸»APIè¿”å›çš„æ ‡ç­¾
            let cleanedMessage = latestAIMessage.mes;
            
            try {
                const regexScriptManager = window.SillyTavernInfobar?.modules?.regexScriptManager;
                if (regexScriptManager) {
                    const originalLength = cleanedMessage.length;
                    // åº”ç”¨OUTPUT placementçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆè¿‡æ»¤ä¸»APIè¿”å›çš„æ ‡ç­¾ï¼‰
                    cleanedMessage = regexScriptManager.applyAllScripts(cleanedMessage, 'OUTPUT', 'AI_OUTPUT');
                    if (cleanedMessage.length !== originalLength) {
                        console.log('[InfoBarSettings] ğŸ“ OUTPUTæ­£åˆ™è¡¨è¾¾å¼å·²åº”ç”¨ï¼ˆè¿‡æ»¤ä¸»APIæ ‡ç­¾ï¼‰ï¼Œå†…å®¹é•¿åº¦:', originalLength, '->', cleanedMessage.length);
                    }
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ åº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼å¤±è´¥:', error);
            }

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ç»åŒ…å«infobar_data
            if (cleanedMessage && cleanedMessage.includes('<infobar_data>')) {
                console.log('[InfoBarSettings] â„¹ï¸ æ¶ˆæ¯å·²åŒ…å«infobar_dataï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            console.log('[InfoBarSettings] ğŸ¤– æ£€æµ‹åˆ°æ–°çš„AIæ¶ˆæ¯ï¼Œå‡†å¤‡å¤„ç†...');

            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ï¼Œé¿å…é¢‘ç¹å¹¶å‘è°ƒç”¨
            if (this.customAPITaskQueue) {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                this.customAPITaskQueue.addTask({
                    type: 'INFOBAR_DATA',
                    data: { content: cleanedMessage },
                    source: 'message_received'
                });
            } else {
                // å›é€€åˆ°åŸæœ‰é€»è¾‘
                console.log('[InfoBarSettings] âš ï¸ ä»»åŠ¡é˜Ÿåˆ—ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘');
                await this.processWithCustomAPI(cleanedMessage);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * è·å–æœ€æ–°çš„AIæ¶ˆæ¯
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ æ¶ˆæ¯éªŒè¯ï¼Œç¡®ä¿è·å–çš„æ˜¯çœŸæ­£æ–°ç”Ÿæˆçš„AIæ¶ˆæ¯
     */
    getLatestAIMessage() {
        try {
            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                return null;
            }

            // ä»åå¾€å‰æŸ¥æ‰¾æœ€æ–°çš„AIæ¶ˆæ¯
            for (let i = context.chat.length - 1; i >= 0; i--) {
                const message = context.chat[i];
                if (message && !message.is_user) {
                    console.log('[InfoBarSettings] ğŸ” æ‰¾åˆ°AIæ¶ˆæ¯:', {
                        index: i,
                        messageId: message.mes_id || 'unknown',
                        sendDate: message.send_date || 'unknown',
                        contentLength: message.mes ? message.mes.length : 0,
                        hasInfobarData: message.mes ? message.mes.includes('<infobar_data>') : false
                    });
                    return message;
                }
            }

            return null;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æœ€æ–°AIæ¶ˆæ¯å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
     */
    validateAIMessageIsNew(aiMessage) {
        try {
            if (!aiMessage) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯ä¸ºç©ºï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                console.log('[InfoBarSettings] âš ï¸ èŠå¤©ä¸Šä¸‹æ–‡æ— æ•ˆï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ç´¢å¼•
            let lastUserMessageIndex = -1;
            for (let i = context.chat.length - 1; i >= 0; i--) {
                const message = context.chat[i];
                if (message && message.is_user) {
                    lastUserMessageIndex = i;
                    break;
                }
            }

            if (lastUserMessageIndex === -1) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼Œè·³è¿‡éªŒè¯');
                return true; // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œå…è®¸å¤„ç†
            }

            // è·å–AIæ¶ˆæ¯åœ¨èŠå¤©è®°å½•ä¸­çš„ç´¢å¼•
            let aiMessageIndex = -1;
            for (let i = 0; i < context.chat.length; i++) {
                const message = context.chat[i];
                if (message === aiMessage) {
                    aiMessageIndex = i;
                    break;
                }
            }

            if (aiMessageIndex === -1) {
                console.log('[InfoBarSettings] âš ï¸ æ— æ³•åœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°AIæ¶ˆæ¯ï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            // AIæ¶ˆæ¯åº”è¯¥åœ¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹å
            const isAfterLastUser = aiMessageIndex > lastUserMessageIndex;

            console.log('[InfoBarSettings] ğŸ” AIæ¶ˆæ¯éªŒè¯ç»“æœ:', {
                aiMessageIndex: aiMessageIndex,
                lastUserMessageIndex: lastUserMessageIndex,
                isAfterLastUser: isAfterLastUser,
                aiMessageTime: aiMessage.send_date || 'unknown'
            });

            return isAfterLastUser;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯AIæ¶ˆæ¯å¤±è´¥:', error);
            return false; // éªŒè¯å¤±è´¥æ—¶é»˜è®¤ä¸å¤„ç†ï¼Œé¿å…é”™è¯¯
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†AIç”Ÿæˆå¤±è´¥çš„æƒ…å†µ
     */
    handleAIGenerationFailure(reason = 'unknown') {
        try {
            console.log('[InfoBarSettings] âš ï¸ å¤„ç†AIç”Ÿæˆå¤±è´¥:', reason);

            // è®°å½•å¤±è´¥ç»Ÿè®¡
            if (!window.InfoBarGenerationStats) {
                window.InfoBarGenerationStats = {
                    failures: 0,
                    lastFailureTime: null,
                    lastFailureReason: null
                };
            }

            window.InfoBarGenerationStats.failures++;
            window.InfoBarGenerationStats.lastFailureTime = new Date().toISOString();
            window.InfoBarGenerationStats.lastFailureReason = reason;

            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå¤±è´¥ç»Ÿè®¡å·²æ›´æ–°:', {
                totalFailures: window.InfoBarGenerationStats.failures,
                lastFailure: window.InfoBarGenerationStats.lastFailureTime,
                reason: reason
            });

            // é€šçŸ¥äº‹ä»¶ç³»ç»ŸAIç”Ÿæˆå¤±è´¥
            if (this.eventSystem) {
                this.eventSystem.emit('ai:generation:failed', {
                    reason: reason,
                    timestamp: Date.now(),
                    context: 'custom_api_processing'
                });
            }

            // å¦‚æœè®¾ç½®ç•Œé¢å¯è§ï¼Œæ˜¾ç¤ºçŠ¶æ€æç¤º
            if (this.visible && this.modal) {
                this.showMessage(`AIç”Ÿæˆå¤±è´¥: ${reason}`, 'warning');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIç”Ÿæˆå¤±è´¥é€»è¾‘å‡ºé”™:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
     */
    validateAIMessageLength(aiMessage, minLength = 100) {
        try {
            if (!aiMessage || !aiMessage.mes) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œé•¿åº¦éªŒè¯å¤±è´¥');
                return { isValid: false, actualLength: 0, reason: 'æ¶ˆæ¯å†…å®¹ä¸ºç©º' };
            }

            // è·å–æ¶ˆæ¯å†…å®¹å¹¶æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ ‡ç­¾
            let messageContent = aiMessage.mes;

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„XMLæ ‡ç­¾å’Œå¤šä½™ç©ºç™½
            messageContent = messageContent
                .replace(/<[^>]+>/g, '') // ç§»é™¤æ‰€æœ‰XML/HTMLæ ‡ç­¾
                .replace(/\s+/g, ' ')    // å°†å¤šä¸ªç©ºç™½å­—ç¬¦æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
                .trim();

            const actualLength = messageContent.length;
            const isValid = actualLength >= minLength;

            console.log('[InfoBarSettings] ğŸ“ AIæ¶ˆæ¯é•¿åº¦éªŒè¯:', {
                minRequired: minLength,
                actualLength: actualLength,
                isValid: isValid,
                contentPreview: messageContent.substring(0, 50) + (messageContent.length > 50 ? '...' : '')
            });

            return {
                isValid: isValid,
                actualLength: actualLength,
                reason: isValid ? 'é•¿åº¦å……è¶³' : `å†…å®¹è¿‡çŸ­ï¼Œå®é™…é•¿åº¦${actualLength}å­—ï¼Œè¦æ±‚è‡³å°‘${minLength}å­—`
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯AIæ¶ˆæ¯é•¿åº¦å¤±è´¥:', error);
            return { isValid: false, actualLength: 0, reason: 'é•¿åº¦éªŒè¯å‡ºé”™: ' + error.message };
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç›´æ¥å¤„ç†è‡ªå®šä¹‰APIè°ƒç”¨ï¼ˆä¾›ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨ï¼‰
     * é¿å…ä»»åŠ¡é˜Ÿåˆ—çš„å¾ªç¯è°ƒç”¨
     */
    async processWithCustomAPIDirectly(plotContent) {
        return await this.processWithCustomAPIInternal(plotContent);
    }

    /**
     * ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å‰§æƒ…å†…å®¹
     */
    async processWithCustomAPI(plotContent) {
        // ğŸ”§ ä¿®å¤ï¼šç”¨æˆ·ä¸»åŠ¨è§¦å‘æ–°ç”Ÿæˆæ—¶ï¼Œé‡ç½®ä¸­æ­¢æ ‡å¿—
        console.log('[InfoBarSettings] ğŸ”„ ç”¨æˆ·è§¦å‘æ–°çš„è‡ªå®šä¹‰APIç”Ÿæˆï¼Œé‡ç½®ä¸­æ­¢æ ‡å¿—');
        this._customAPIAborted = false;

        // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†
        if (this.customAPITaskQueue) {
            console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†è‡ªå®šä¹‰APIè°ƒç”¨ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰');
            this.customAPITaskQueue.addTask({
                type: 'INFOBAR_DATA',
                data: { content: plotContent },
                source: 'manual_refill'  // ğŸ”§ ä¿®å¤ï¼šæ ‡è®°ä¸ºæ‰‹åŠ¨é‡æ–°å¡«è¡¨
            });
            return;
        }

        // å¦åˆ™ç›´æ¥å¤„ç†
        return await this.processWithCustomAPIInternal(plotContent);
    }

    /**
     * ğŸ”§ å†…éƒ¨æ–¹æ³•ï¼šå®é™…çš„è‡ªå®šä¹‰APIå¤„ç†é€»è¾‘
     */
    async processWithCustomAPIInternal(plotContent) {
        try {
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤é‡å¤çš„è¯·æ±‚ç¡®è®¤é€»è¾‘
            // è¯·æ±‚ç¡®è®¤å·²ç”± CustomAPITaskQueue.executeInfobarDataTask() ç»Ÿä¸€å¤„ç†
            // é¿å…å‡ºç°ä¸¤ä¸ªç¡®è®¤å¼¹çª—

            // ğŸ”§ ä¿®å¤ï¼šåœ¨å¼€å§‹å¤„ç†å‰æ£€æŸ¥ä¸­æ­¢æ ‡å¿—
            if (this._customAPIAborted) {
                console.log('[InfoBarSettings] ğŸ›‘ æ£€æµ‹åˆ°ä¸­æ­¢æ ‡å¿—ï¼Œæ‹’ç»æ–°çš„APIè¯·æ±‚');
                // æŠ›å‡ºç‰¹æ®Šé”™è¯¯ï¼Œè®©ä»»åŠ¡é˜Ÿåˆ—çŸ¥é“è¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ­¢
                const abortError = new Error('ç”¨æˆ·å·²ä¸­æ­¢APIç”Ÿæˆ');
                abortError.name = 'AbortError';
                abortError.isUserAbort = true;
                throw abortError;
            }

            // å¹¶å‘ä¿æŠ¤ï¼šé˜²æ­¢é‡å¤è§¦å‘
            if (this._customAPIProcessing) {
                console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰APIå¤„ç†å·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                this.showNotification('â³ è‡ªå®šä¹‰APIå¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤è§¦å‘', 'warning');
                return;
            }
            this._customAPIProcessing = true;

            // ğŸ”§ ä¿®å¤ï¼šä¸è¦åœ¨è¿™é‡Œé‡ç½®ä¸­æ­¢æ ‡å¿—ï¼Œä¿æŒç”¨æˆ·çš„ä¸­æ­¢æ„å›¾
            // åªåœ¨çœŸæ­£å¼€å§‹æ–°çš„ç”Ÿæˆæ—¶æ‰é‡ç½®ï¼ˆç”±å¤–éƒ¨è°ƒç”¨è€…æ§åˆ¶ï¼‰
            // this._customAPIAborted = false; // âŒ åˆ é™¤

            // ğŸ”§ æ–°å¢ï¼šåˆ›å»ºAbortControllerç”¨äºä¸­æ­¢è¯·æ±‚
            this.currentAPIController = new AbortController();

            console.log('[InfoBarSettings] ğŸš€ å¼€å§‹ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å‰§æƒ…å†…å®¹...');

            // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIç”Ÿæˆä¸­æç¤º
            this.showCustomAPIStatus('generating');

            // éªŒè¯å‰§æƒ…å†…å®¹
            if (!plotContent || typeof plotContent !== 'string') {
                console.warn('[InfoBarSettings] âš ï¸ å‰§æƒ…å†…å®¹æ— æ•ˆ:', typeof plotContent);
                this.showCustomAPIStatus('error', 'å‰§æƒ…å†…å®¹æ— æ•ˆ');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“ å‰§æƒ…å†…å®¹é•¿åº¦:', plotContent.length);

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤é‡å¤çš„æ™ºèƒ½æç¤ºè¯å¤„ç†
            // æ™ºèƒ½æç¤ºè¯ä¼šåœ¨enhanceMessagesWithSystemPrompt()ä¸­ç»Ÿä¸€å¤„ç†
            console.log('[InfoBarSettings] âœ… æ™ºèƒ½æç¤ºè¯å°†åœ¨æ¶ˆæ¯å¢å¼ºé˜¶æ®µç»Ÿä¸€å¤„ç†');

            // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è°ƒç”¨å˜é‡ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆæ–¹æ³•
            let variablePrompt = '';
            try {
                const variableSystemPrompt = window.SillyTavernInfobar?.modules?.variableSystemPrompt;
                if (variableSystemPrompt && typeof variableSystemPrompt.generatePromptTemplate === 'function') {
                    variablePrompt = await variableSystemPrompt.generatePromptTemplate();
                    console.log('[InfoBarSettings] âœ… è·å–åˆ°å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯ï¼Œé•¿åº¦:', variablePrompt.length);
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ å˜é‡ç³»ç»Ÿæç¤ºè¯æ¨¡å—ä¸å¯ç”¨æˆ–ç¼ºå°‘generatePromptTemplateæ–¹æ³•');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ è·å–å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯å¤±è´¥:', error);
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–ä¸–ç•Œä¹¦å†…å®¹
            let worldBookContent = '';
            const context = SillyTavern.getContext();
            const apiConfig = context.extensionSettings['Information bar integration tool']?.apiConfig || {};
            if (apiConfig.includeWorldBook) {
                try {
                    worldBookContent = await this.getWorldBookContent();
                    if (worldBookContent) {
                        console.log('[InfoBarSettings] ğŸ“š è·å–åˆ°ä¸–ç•Œä¹¦å†…å®¹ï¼Œé•¿åº¦:', worldBookContent.length);
                    } else {
                        console.log('[InfoBarSettings] ğŸ“š ä¸–ç•Œä¹¦å†…å®¹ä¸ºç©ºæˆ–æœªæ¿€æ´»');
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½æç¤ºè¯ç°åœ¨åœ¨æ¶ˆæ¯å¢å¼ºé˜¶æ®µå¤„ç†ï¼Œè¿™é‡Œä¸å†éœ€è¦
            let fullSystemPrompt = '';

            // ğŸ”§ ä¿®å¤ï¼šæ‰‹åŠ¨å¤„ç†å˜é‡æ›¿æ¢ï¼Œç„¶åæ·»åŠ å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯
            if (variablePrompt) {
                try {
                    // æ‰‹åŠ¨è°ƒç”¨SillyTavernçš„å˜é‡æ›¿æ¢åŠŸèƒ½
                    const stContext = SillyTavern.getContext();
                    if (typeof stContext.substituteParams === 'function') {
                        variablePrompt = stContext.substituteParams(variablePrompt);
                        console.log('[InfoBarSettings] âœ… å˜é‡æ›¿æ¢å®Œæˆï¼Œå¤„ç†åé•¿åº¦:', variablePrompt.length);
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ SillyTavernå˜é‡æ›¿æ¢åŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡å˜é‡å¤„ç†');
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å˜é‡æ›¿æ¢å¤±è´¥:', error);
                }
                fullSystemPrompt = variablePrompt + '\n\n' + fullSystemPrompt;
            }

            // æ·»åŠ ä¸–ç•Œä¹¦å†…å®¹
            if (worldBookContent) {
                fullSystemPrompt = fullSystemPrompt + '\n\n## ğŸ“š ä¸–ç•Œä¹¦ä¿¡æ¯\n\n' + worldBookContent;
            }

            // ğŸ”§ ä¿®å¤ï¼šä¸è¦åœ¨è¿™é‡Œåº”ç”¨INPUTæ­£åˆ™ï¼
            // INPUTæ­£åˆ™æ˜¯ç”¨äºè¿‡æ»¤å‘é€ç»™ä¸»APIçš„ç”¨æˆ·è¾“å…¥
            // è¿™é‡Œæ˜¯å‘é€ç»™è‡ªå®šä¹‰APIï¼Œä¸åº”è¯¥åº”ç”¨INPUTæ­£åˆ™
            // plotContentå·²ç»é€šè¿‡OUTPUTæ­£åˆ™åœ¨è·å–ä¸»APIæ¶ˆæ¯æ—¶è¿‡æ»¤è¿‡äº†

            // å‡†å¤‡APIè¯·æ±‚
            console.log('[InfoBarSettings] ğŸ“¡ å‡†å¤‡å‘é€è‡ªå®šä¹‰APIè¯·æ±‚...');
            const messages = [
                {
                    role: 'system',
                    content: fullSystemPrompt
                },
                {
                    role: 'user',
                    content: `è¯·æ ¹æ®ä»¥ä¸‹å‰§æƒ…å†…å®¹ç”Ÿæˆä¿¡æ¯æ æ•°æ®ï¼š\n\n${plotContent}`
                }
            ];

            console.log('[InfoBarSettings] ğŸ“Š è¯·æ±‚è¯¦æƒ…:', {
                messagesCount: messages.length,
                systemPromptLength: fullSystemPrompt.length,

                variablePromptLength: variablePrompt.length,
                worldBookLength: worldBookContent.length,
                userPromptLength: plotContent.length,
                apiProvider: this.getAPIProvider(),
                apiModel: this.getAPIModel(),
                includeWorldBook: apiConfig.includeWorldBook
            });

            // å‘é€è‡ªå®šä¹‰APIè¯·æ±‚ï¼ˆå¢å¼ºé‡è¯•é€»è¾‘ï¼‰
            const cfg = context.extensionSettings['Information bar integration tool']?.apiConfig || {};
            const maxRetry = Number(cfg.retryCount ?? 5); // å¢åŠ é»˜è®¤é‡è¯•æ¬¡æ•°
            const baseRetryDelayMs = 2000; // å¢åŠ åŸºç¡€å»¶è¿Ÿæ—¶é—´

            let attempt = 0;
            let lastError = null;
            while (attempt <= maxRetry) {
                // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
                if (this._customAPIAborted) {
                    console.log('[InfoBarSettings] ğŸ›‘ æ£€æµ‹åˆ°ä¸­æ­¢æ ‡å¿—ï¼Œåœæ­¢å¤„ç†');
                    return;
                }

                attempt++;
                const result = await this.sendCustomAPIRequest(messages, {
                    skipSystemPrompt: false,
                    signal: this.currentAPIController?.signal // ä¼ é€’AbortSignal
                });

                // ğŸ”§ æ–°å¢ï¼šå†æ¬¡æ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
                if (this._customAPIAborted) {
                    console.log('[InfoBarSettings] ğŸ›‘ æ£€æµ‹åˆ°ä¸­æ­¢æ ‡å¿—ï¼Œåœæ­¢å¤„ç†');
                    return;
                }

                if (result && result.success && typeof result.text === 'string' && result.text.trim().length > 0) {
                    console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIè¿”å›ç»“æœï¼Œé•¿åº¦:', result.text.length, ' å°è¯•æ¬¡æ•°:', attempt);
                    await this.processAPIResult(result.text);
                    // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIç”Ÿæˆå®Œæˆæç¤º
                    this.showCustomAPIStatus('success');
                    console.log('[InfoBarSettings] ğŸ‰ è‡ªå®šä¹‰APIå¤„ç†æµç¨‹å®Œæˆï¼Œå‡†å¤‡è¿”å›');
                    return; // ğŸ†• å…³é”®ä¿®å¤ï¼šæ˜ç¡®è¿”å›ï¼Œè®©Promiseæ­£ç¡®resolve
                } else {
                    lastError = result?.error || 'ç©ºå“åº”æˆ–æ ¼å¼æ— æ•ˆ';
                    console.warn(`[InfoBarSettings] âš ï¸ APIç»“æœä¸ºç©ºæˆ–æ— æ•ˆï¼Œå‡†å¤‡é‡è¯• (${attempt}/${maxRetry}) ...`);
                    if (attempt > maxRetry) {
                        console.error('[InfoBarSettings] âŒ é‡è¯•è¾¾ä¸Šé™ï¼Œæ”¾å¼ƒã€‚æœ¬æ¬¡é”™è¯¯:', lastError);
                        this.showCustomAPIStatus('error', 'é‡è¯•å¤±è´¥: ' + lastError);
                        // ğŸ†• å…³é”®ä¿®å¤ï¼šé‡è¯•å¤±è´¥åä¹Ÿè¦æŠ›å‡ºé”™è¯¯ï¼Œè®©ä»»åŠ¡é˜Ÿåˆ—çŸ¥é“å¤±è´¥
                        throw new Error('è‡ªå®šä¹‰APIé‡è¯•å¤±è´¥: ' + lastError);
                    }
                    // ğŸ”§ æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ï¼šæ¯æ¬¡é‡è¯•å»¶è¿Ÿæ—¶é—´é€’å¢
                    const retryDelayMs = baseRetryDelayMs * Math.pow(1.5, attempt - 1);
                    console.log(`[InfoBarSettings] â³ ç­‰å¾… ${retryDelayMs}ms åé‡è¯•...`);
                    await new Promise(r=>setTimeout(r, retryDelayMs));
                }
            }

            // ğŸ†• å…³é”®ä¿®å¤ï¼šå¦‚æœwhileå¾ªç¯æ­£å¸¸ç»“æŸä½†æ²¡æœ‰æˆåŠŸï¼ˆæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼‰ï¼ŒæŠ›å‡ºé”™è¯¯
            if (lastError) {
                throw new Error('è‡ªå®šä¹‰APIæ‰€æœ‰é‡è¯•å‡å¤±è´¥: ' + lastError);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ­¢é”™è¯¯
            if (error.name === 'AbortError' || this._customAPIAborted || error.isUserAbort) {
                console.log('[InfoBarSettings] ğŸ›‘ APIè¯·æ±‚å·²è¢«ä¸­æ­¢');
                // ä¸­æ­¢æ—¶ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºå·²ç»æ˜¾ç¤ºäº†ä¸­æ­¢æç¤º
                // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä»»åŠ¡é˜Ÿåˆ—çŸ¥é“ä»»åŠ¡è¢«ä¸­æ­¢
                throw error;
            } else {
                // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIé”™è¯¯æç¤º
                this.showCustomAPIStatus('error', error.message);
                // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä»»åŠ¡é˜Ÿåˆ—çŸ¥é“ä»»åŠ¡å¤±è´¥
                throw error;
            }
        } finally {
            // å¤ä½å¹¶å‘æ ‡è®°
            this._customAPIProcessing = false;

            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†AbortController
            if (this.currentAPIController) {
                this.currentAPIController = null;
            }
            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†ç»Ÿä¸€çš„è¶…æ—¶å¥æŸ„
            if (this.currentAPITimeoutId) {
                clearTimeout(this.currentAPITimeoutId);
                this.currentAPITimeoutId = null;
            }
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰APIçŠ¶æ€æç¤º
     */
    showCustomAPIStatus(status, message = '') {
        try {
            // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æç¤º
            const existingToast = document.querySelector('.custom-api-status-toast');
            if (existingToast) {
                existingToast.remove();
            }

            let toastContent = '';
            let toastClass = 'custom-api-status-toast';
            let autoHide = false;

            switch (status) {
                case 'generating':
                    toastContent = 'ğŸ¤– è‡ªå®šä¹‰APIç”Ÿæˆä¸­...';
                    toastClass += ' generating';
                    break;
                case 'success':
                    toastContent = 'âœ… è‡ªå®šä¹‰APIå·²ç”Ÿæˆ';
                    toastClass += ' success';
                    autoHide = true;
                    break;
                case 'error':
                    toastContent = `âŒ è‡ªå®šä¹‰APIç”Ÿæˆå¤±è´¥${message ? ': ' + message : ''}`;
                    toastClass += ' error';
                    autoHide = true;
                    break;
                case 'aborted':
                    toastContent = 'âš ï¸ è‡ªå®šä¹‰APIç”Ÿæˆå·²ä¸­æ­¢';
                    toastClass += ' aborted';
                    autoHide = true;
                    break;
            }

            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = toastClass;

            // ğŸ”§ æ–°å¢ï¼šä¸ºgeneratingçŠ¶æ€æ·»åŠ ä¸­æ­¢æŒ‰é’®
            if (status === 'generating') {
                toast.innerHTML = `
                    <div class="toast-content">
                        <span class="toast-text">${toastContent}</span>
                        <div class="toast-actions">
                            <button class="toast-abort-btn" data-action="abort-api">ä¸­æ­¢</button>
                            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                        </div>
                    </div>
                `;
            } else {
                toast.innerHTML = `
                    <div class="toast-content">
                        <span class="toast-text">${toastContent}</span>
                        <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                `;
            }

            // æ·»åŠ æ ·å¼
            if (!document.getElementById('custom-api-status-styles')) {
                const style = document.createElement('style');
                style.id = 'custom-api-status-styles';
                style.textContent = `
                    .custom-api-status-toast {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        padding: 0;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        animation: slideInRight 0.3s ease-out;
                    }
                    .custom-api-status-toast.generating {
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        color: white;
                    }
                    .custom-api-status-toast.success {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                    }
                    .custom-api-status-toast.error {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                    }
                    .custom-api-status-toast.aborted {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                    }
                    .toast-content {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 12px 16px;
                    }
                    .toast-text {
                        flex: 1;
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .toast-actions {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-left: 12px;
                    }
                    .toast-abort-btn {
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        font-size: 12px;
                        font-weight: 500;
                        cursor: pointer;
                        padding: 4px 12px;
                        border-radius: 4px;
                        transition: all 0.2s;
                    }
                    .toast-abort-btn:hover {
                        background: rgba(255, 255, 255, 0.3);
                        border-color: rgba(255, 255, 255, 0.5);
                    }
                    .toast-close {
                        background: none;
                        border: none;
                        color: inherit;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        padding: 0;
                        opacity: 0.8;
                        transition: opacity 0.2s;
                    }
                    .toast-close:hover {
                        opacity: 1;
                    }
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // ğŸ”§ æ–°å¢ï¼šç»‘å®šä¸­æ­¢æŒ‰é’®äº‹ä»¶
            if (status === 'generating') {
                const abortBtn = toast.querySelector('.toast-abort-btn');
                if (abortBtn) {
                    abortBtn.addEventListener('click', () => {
                        console.log('[InfoBarSettings] ğŸ›‘ ç”¨æˆ·ç‚¹å‡»ä¸­æ­¢æŒ‰é’®');
                        this.abortCustomAPIGeneration();
                        toast.remove();
                    });
                }
            }

            // è‡ªåŠ¨éšè—
            if (autoHide) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 300);
                    }
                }, 3000);
            }

            console.log('[InfoBarSettings] ğŸ“¢ è‡ªå®šä¹‰APIçŠ¶æ€æç¤ºå·²æ˜¾ç¤º:', status, message);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºè‡ªå®šä¹‰APIçŠ¶æ€æç¤ºå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• ä¸­æ­¢è‡ªå®šä¹‰APIç”Ÿæˆ
     */
    async abortCustomAPIGeneration() {
        try {
            console.log('[InfoBarSettings] ğŸ›‘ ä¸­æ­¢è‡ªå®šä¹‰APIç”Ÿæˆ...');

            // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®ä¸­æ­¢æ ‡å¿—ï¼ˆè¿™ä¸ªæ ‡å¿—ä¼šé˜»æ­¢æ–°çš„APIè¯·æ±‚ï¼‰
            this._customAPIAborted = true;

            // ğŸ”§ ä¿®å¤ï¼šå¤ä½å¤„ç†æ ‡å¿—
            this._customAPIProcessing = false;

            // ğŸ”§ ä¿®å¤ï¼šå…ˆé€šçŸ¥åç«¯å–æ¶ˆï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œå†æœ¬åœ°ä¸­æ­¢
            await this.sendBackendCancelIfPossible();
            if (this.currentAPIController) {
                console.log('[InfoBarSettings] ğŸ›‘ ä¸­æ­¢æ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚');
                this.currentAPIController.abort();
                this.currentAPIController = null;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾…å¤„ç†ä»»åŠ¡
            const taskQueue = window.SillyTavernInfobar?.modules?.customAPITaskQueue;
            if (taskQueue && taskQueue.taskQueue) {
                const beforeCount = taskQueue.taskQueue.length;
                // ç§»é™¤æ‰€æœ‰INFOBAR_DATAç±»å‹çš„å¾…å¤„ç†ä»»åŠ¡
                taskQueue.taskQueue = taskQueue.taskQueue.filter(task => task.type !== 'INFOBAR_DATA');
                const afterCount = taskQueue.taskQueue.length;
                const removedCount = beforeCount - afterCount;
                if (removedCount > 0) {
                    console.log(`[InfoBarSettings] ğŸ—‘ï¸ å·²æ¸…é™¤ ${removedCount} ä¸ªå¾…å¤„ç†çš„ä¿¡æ¯æ æ•°æ®ç”Ÿæˆä»»åŠ¡`);
                }
            }

            // æ˜¾ç¤ºä¸­æ­¢æç¤º
            this.showCustomAPIStatus('aborted');

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIç”Ÿæˆå·²ä¸­æ­¢');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸­æ­¢è‡ªå®šä¹‰APIç”Ÿæˆå¤±è´¥:', error);
        }
    }

    /**
     * å‘é€åç«¯å–æ¶ˆè¯·æ±‚ï¼ˆè‹¥ä½¿ç”¨äº†SillyTavernæœ¬åœ°åä»£ï¼‰
     */
    async sendBackendCancelIfPossible() {
        try {
            if (!this.lastRequestUrl || !this.currentAPIRequestId) return;
            const isBackendGenerate = this.lastRequestUrl.includes('/api/backends/chat-completions/generate');
            if (!isBackendGenerate) return;

            const cancelUrl = `${window.location.origin}/api/backends/chat-completions/cancel`;
            // è·å–CSRFä»¤ç‰Œ
            const csrfResp = await fetch('/csrf-token');
            const csrfData = await csrfResp.json();
            const csrfToken = csrfData.token;

            const payload = { request_id: this.currentAPIRequestId };
            await fetch(cancelUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken,
                    'X-Request-ID': this.currentAPIRequestId
                },
                body: JSON.stringify(payload)
            });
            console.log('[InfoBarSettings] ğŸ›‘ å·²å‘åç«¯å‘é€å–æ¶ˆè¯·æ±‚:', payload);
        } catch (err) {
            console.warn('[InfoBarSettings] âš ï¸ å‘é€å–æ¶ˆè¯·æ±‚å¤±è´¥ï¼ˆå°†å¿½ç•¥å¹¶ç»§ç»­æœ¬åœ°ä¸­æ­¢ï¼‰ï¼š', err);
        } finally {
            // æ¸…ç†è¯·æ±‚ID
            this.currentAPIRequestId = null;
            this.lastRequestUrl = null;
        }
    }


    /**
     * å¯¼å‡ºæ•°æ®åŠŸèƒ½
     */
    async exportData() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¯¼å‡ºæ•°æ®...');

            // è·å–ç”¨æˆ·é€‰æ‹©çš„èŒƒå›´å’Œæ ¼å¼
            const scopeSelect = this.modal.querySelector('#data-scope-select');
            const formatSelect = this.modal.querySelector('#data-format-select');

            if (!scopeSelect || !formatSelect) {
                this.showMessage('âŒ æ— æ³•è·å–å¯¼å‡ºè®¾ç½®', 'error');
                return;
            }

            const scope = scopeSelect.value; // 'current' æˆ– 'all'
            const format = formatSelect.value; // 'json', 'csv', æˆ– 'xml'

            console.log('[InfoBarSettings] ğŸ“Š å¯¼å‡ºè®¾ç½®:', { scope, format });

            // æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦æç¤º
            this.showMessage('ğŸ”„ æ­£åœ¨æ”¶é›†æ•°æ®...', 'info');

            // æ”¶é›†æ•°æ®
            const exportData = await this.collectExportData(scope);

            if (!exportData || Object.keys(exportData).length === 0) {
                this.showMessage('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„æ•°æ®:', {
                chats: exportData.chats?.length || 0,
                totalMessages: exportData.chats?.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0) || 0,
                infobarDataEntries: Object.keys(exportData.infobarData || {}).length
            });

            // è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼
            let exportContent;
            let fileName;
            let mimeType;

            switch (format) {
                case 'json':
                    exportContent = JSON.stringify(exportData, null, 2);
                    fileName = `infobar_data_${this.getTimestamp()}.json`;
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    exportContent = this.convertToCSV(exportData);
                    fileName = `infobar_data_${this.getTimestamp()}.csv`;
                    mimeType = 'text/csv';
                    break;
                case 'xml':
                    exportContent = this.convertToXML(exportData);
                    fileName = `infobar_data_${this.getTimestamp()}.xml`;
                    mimeType = 'application/xml';
                    break;
                default:
                    throw new Error('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼: ' + format);
            }

            // è§¦å‘ä¸‹è½½
            this.downloadFile(exportContent, fileName, mimeType);

            this.showMessage(`âœ… æ•°æ®å·²å¯¼å‡ºä¸º ${fileName}`, 'success');
            console.log('[InfoBarSettings] âœ… æ•°æ®å¯¼å‡ºå®Œæˆ:', fileName);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
            this.showMessage('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ”¶é›†å¯¼å‡ºæ•°æ®
     */
    async collectExportData(scope) {
        try {
            const exportData = {
                metadata: {
                    exportTime: new Date().toISOString(),
                    scope: scope,
                    version: '1.0.0',
                    source: 'Information bar integration tool'
                },
                chats: [],
                infobarData: {},
                settings: {}
            };

            // è·å–SillyTavernä¸Šä¸‹æ–‡
            const context = SillyTavern.getContext();
            if (!context) {
                throw new Error('æ— æ³•è·å–SillyTavernä¸Šä¸‹æ–‡');
            }

            // æ”¶é›†èŠå¤©æ•°æ®
            if (scope === 'current') {
                // å½“å‰èŠå¤©
                const currentChatId = context.chatId;
                if (currentChatId && context.chat) {
                    const chatData = {
                        chatId: currentChatId,
                        chatName: context.name2 || 'Unknown',
                        character: context.name2 || 'Unknown',
                        messages: context.chat || [],
                        timestamp: new Date().toISOString()
                    };
                    exportData.chats.push(chatData);

                    // æ”¶é›†å½“å‰èŠå¤©çš„ä¿¡æ¯æ æ•°æ®
                    if (this.unifiedDataCore?.getChatData) {
                        const chatInfobarData = await this.unifiedDataCore.getChatData(currentChatId);
                        if (chatInfobarData && Object.keys(chatInfobarData).length > 0) {
                            exportData.infobarData[currentChatId] = chatInfobarData;
                        }
                    }
                }
            } else {
                // æ‰€æœ‰èŠå¤©
                const allChats = context.characters || [];
                for (const character of allChats) {
                    if (character) {
                        const chatData = {
                            chatId: character.filename || character.name,
                            chatName: character.name,
                            character: character.name,
                            // æ³¨æ„ï¼šéå½“å‰èŠå¤©çš„æ¶ˆæ¯æ­£æ–‡é€šå¸¸æœªé¢„åŠ è½½ï¼Œé¿å…å¯¼å‡ºé”™è¯¯ç»“æ„
                            messages: Array.isArray(character.chat) ? character.chat : [],
                            timestamp: new Date().toISOString()
                        };
                        exportData.chats.push(chatData);

                        // æ”¶é›†è¯¥èŠå¤©çš„ä¿¡æ¯æ æ•°æ®
                        if (this.unifiedDataCore?.getChatData) {
                            const cid = character.filename || character.name;
                            const chatInfobarData = await this.unifiedDataCore.getChatData(cid);
                            if (chatInfobarData && Object.keys(chatInfobarData).length > 0) {
                                exportData.infobarData[cid] = chatInfobarData;
                            }
                        }
                    }
                }
            }

            // æ”¶é›†æ‰©å±•è®¾ç½®ï¼ˆè„±æ•apiKeyï¼‰
            const extensionSettings = context.extensionSettings;
            if (extensionSettings && extensionSettings['Information bar integration tool']) {
                const safeSettings = JSON.parse(JSON.stringify(extensionSettings['Information bar integration tool']));
                if (safeSettings?.apiConfig?.apiKey) {
                    safeSettings.apiConfig.apiKey = '***REMOVED***';
                }
                exportData.settings = safeSettings;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ•°æ®æ”¶é›†å®Œæˆ:', {
                chats: exportData.chats.length,
                infobarDataKeys: Object.keys(exportData.infobarData).length,
                hasSettings: !!exportData.settings
            });

            return exportData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è½¬æ¢æ•°æ®ä¸ºCSVæ ¼å¼
     */
    convertToCSV(data) {
        try {
            let csvContent = '';

            // CSVå¤´éƒ¨ä¿¡æ¯
            csvContent += '# Information Bar Integration Tool Data Export\n';
            csvContent += `# Export Time: ${data.metadata.exportTime}\n`;
            csvContent += `# Scope: ${data.metadata.scope}\n`;
            csvContent += '\n';

            // èŠå¤©æ•°æ®è¡¨
            if (data.chats && data.chats.length > 0) {
                csvContent += 'Chat Data\n';
                csvContent += 'Chat ID,Chat Name,Character,Message Count,Last Message Time\n';

                data.chats.forEach(chat => {
                    const messageCount = chat.messages ? chat.messages.length : 0;
                    const lastMessageTime = chat.messages && chat.messages.length > 0
                        ? (chat.messages[chat.messages.length - 1].send_date || 'Unknown')
                        : 'No messages';

                    csvContent += `"${chat.chatId}","${chat.chatName}","${chat.character}",${messageCount},"${lastMessageTime}"\n`;
                });
                csvContent += '\n';
            }

            // ä¿¡æ¯æ æ•°æ®è¡¨
            if (data.infobarData && Object.keys(data.infobarData).length > 0) {
                csvContent += 'InfoBar Data\n';
                csvContent += 'Chat ID,Message ID,Panel Type,Data Key,Data Value\n';

                Object.entries(data.infobarData).forEach(([chatId, chatData]) => {
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        Object.entries(messageData).forEach(([panelType, panelData]) => {
                            if (typeof panelData === 'object') {
                                Object.entries(panelData).forEach(([key, value]) => {
                                    const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
                                    csvContent += `"${chatId}","${messageId}","${panelType}","${key}","${valueStr}"\n`;
                                });
                            }
                        });
                    });
                });
            }

            return csvContent;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è½¬æ¢CSVæ ¼å¼å¤±è´¥:', error);
            throw new Error('CSVæ ¼å¼è½¬æ¢å¤±è´¥: ' + error.message);
        }
    }

    /**
     * è½¬æ¢æ•°æ®ä¸ºXMLæ ¼å¼
     */
    convertToXML(data) {
        try {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlContent += '<InfoBarExport>\n';

            // å…ƒæ•°æ®
            xmlContent += '  <Metadata>\n';
            xmlContent += `    <ExportTime>${this.escapeXML(data.metadata.exportTime)}</ExportTime>\n`;
            xmlContent += `    <Scope>${this.escapeXML(data.metadata.scope)}</Scope>\n`;
            xmlContent += `    <Version>${this.escapeXML(data.metadata.version)}</Version>\n`;
            xmlContent += `    <Source>${this.escapeXML(data.metadata.source)}</Source>\n`;
            xmlContent += '  </Metadata>\n';

            // èŠå¤©æ•°æ®
            if (data.chats && data.chats.length > 0) {
                xmlContent += '  <Chats>\n';
                data.chats.forEach(chat => {
                    xmlContent += '    <Chat>\n';
                    xmlContent += `      <ChatId>${this.escapeXML(chat.chatId)}</ChatId>\n`;
                    xmlContent += `      <ChatName>${this.escapeXML(chat.chatName)}</ChatName>\n`;
                    xmlContent += `      <Character>${this.escapeXML(chat.character)}</Character>\n`;
                    xmlContent += `      <MessageCount>${chat.messages ? chat.messages.length : 0}</MessageCount>\n`;
                    xmlContent += `      <Timestamp>${this.escapeXML(chat.timestamp)}</Timestamp>\n`;
                    xmlContent += '    </Chat>\n';
                });
                xmlContent += '  </Chats>\n';
            }

            // ä¿¡æ¯æ æ•°æ®
            if (data.infobarData && Object.keys(data.infobarData).length > 0) {
                xmlContent += '  <InfoBarData>\n';
                Object.entries(data.infobarData).forEach(([chatId, chatData]) => {
                    xmlContent += `    <ChatData chatId="${this.escapeXML(chatId)}">\n`;
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        xmlContent += `      <MessageData messageId="${this.escapeXML(messageId)}">\n`;
                        Object.entries(messageData).forEach(([panelType, panelData]) => {
                            xmlContent += `        <Panel type="${this.escapeXML(panelType)}">\n`;
                            if (typeof panelData === 'object') {
                                Object.entries(panelData).forEach(([key, value]) => {
                                    const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
                                    xmlContent += `          <Data key="${this.escapeXML(key)}">${this.escapeXML(valueStr)}</Data>\n`;
                                });
                            }
                            xmlContent += '        </Panel>\n';
                        });
                        xmlContent += '      </MessageData>\n';
                    });
                    xmlContent += '    </ChatData>\n';
                });
                xmlContent += '  </InfoBarData>\n';
            }

            xmlContent += '</InfoBarExport>';
            return xmlContent;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è½¬æ¢XMLæ ¼å¼å¤±è´¥:', error);
            throw new Error('XMLæ ¼å¼è½¬æ¢å¤±è´¥: ' + error.message);
        }
    }

    /**
     * XMLè½¬ä¹‰å‡½æ•°
     */
    escapeXML(str) {
        if (typeof str !== 'string') {
            str = String(str);
        }
        return str.replace(/[<>&'"]/g, (char) => {
            switch (char) {
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '&': return '&amp;';
                case "'": return '&apos;';
                case '"': return '&quot;';
                default: return char;
            }
        });
    }

    /**
     * è·å–æ—¶é—´æˆ³å­—ç¬¦ä¸²
     */
    getTimestamp() {
        const now = new Date();
        return now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
    }

    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    downloadFile(content, fileName, mimeType) {
        try {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ¸…ç†URLå¯¹è±¡
            setTimeout(() => URL.revokeObjectURL(url), 1000);

            console.log('[InfoBarSettings] ğŸ“ æ–‡ä»¶ä¸‹è½½è§¦å‘:', fileName);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
            throw new Error('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
        }
    }

    /**
     * å¯¼å…¥æ•°æ®åŠŸèƒ½
     */
    async importData() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ å¼€å§‹å¯¼å…¥æ•°æ®...');

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,.csv,.xml';
            fileInput.style.display = 'none';

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                try {
                    this.showMessage('ğŸ”„ æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');

                    // è¯»å–æ–‡ä»¶å†…å®¹
                    const content = await this.readFileContent(file);

                    // è§£ææ•°æ®
                    const importData = await this.parseImportData(content, file.name);

                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    const confirmed = await this.showImportConfirmDialog(importData);

                    if (confirmed) {
                        // æ‰§è¡Œå¯¼å…¥
                        await this.executeImport(importData);
                        this.showMessage('âœ… æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                    } else {
                        this.showMessage('â„¹ï¸ å¯¼å…¥å·²å–æ¶ˆ', 'info');
                    }

                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    this.showMessage('âŒ å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                } finally {
                    // æ¸…ç†æ–‡ä»¶è¾“å…¥
                    if (fileInput.parentNode) {
                        fileInput.parentNode.removeChild(fileInput);
                    }
                }
            });

            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            document.body.appendChild(fileInput);
            fileInput.click();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
            this.showMessage('âŒ å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * è¯»å–æ–‡ä»¶å†…å®¹
     */
    readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
            reader.readAsText(file, 'UTF-8');
        });
    }

    /**
     * è§£æå¯¼å…¥æ•°æ®
     */
    async parseImportData(content, fileName) {
        try {
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let parsedData;

            switch (fileExtension) {
                case 'json':
                    parsedData = JSON.parse(content);
                    break;
                case 'csv':
                    parsedData = this.parseCSVData(content);
                    break;
                case 'xml':
                    parsedData = this.parseXMLData(content);
                    break;
                default:
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ' + fileExtension);
            }

            // éªŒè¯æ•°æ®ç»“æ„
            this.validateImportData(parsedData);

            return parsedData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è§£æå¯¼å…¥æ•°æ®å¤±è´¥:', error);
            throw new Error('æ•°æ®è§£æå¤±è´¥: ' + error.message);
        }
    }

    /**
     * è§£æCSVæ•°æ®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    parseCSVData(content) {
        // è¿™é‡Œå®ç°ä¸€ä¸ªç®€åŒ–çš„CSVè§£æ
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„CSVè§£æé€»è¾‘
        throw new Error('CSVå¯¼å…¥åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨JSONæ ¼å¼');
    }

    /**
     * è§£æXMLæ•°æ®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    parseXMLData(content) {
        // è¿™é‡Œå®ç°ä¸€ä¸ªç®€åŒ–çš„XMLè§£æ
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„XMLè§£æé€»è¾‘
        throw new Error('XMLå¯¼å…¥åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨JSONæ ¼å¼');
    }

    /**
     * éªŒè¯å¯¼å…¥æ•°æ®ç»“æ„
     */
    validateImportData(data) {
        if (!data || typeof data !== 'object') {
            throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
        }

        if (!data.metadata) {
            throw new Error('ç¼ºå°‘å…ƒæ•°æ®ä¿¡æ¯');
        }

        if (!data.metadata.source || data.metadata.source !== 'Information bar integration tool') {
            throw new Error('æ•°æ®æ¥æºä¸åŒ¹é…ï¼Œè¯·ç¡®ä¿æ˜¯æœ¬å·¥å…·å¯¼å‡ºçš„æ•°æ®');
        }

        console.log('[InfoBarSettings] âœ… æ•°æ®éªŒè¯é€šè¿‡');
    }

    /**
     * æ˜¾ç¤ºå¯¼å…¥ç¡®è®¤å¯¹è¯æ¡†
     */
    showImportConfirmDialog(importData) {
        return new Promise((resolve) => {
            try {
                // ç»Ÿè®¡å¯¼å…¥æ•°æ®
                const stats = {
                    chats: importData.chats ? importData.chats.length : 0,
                    totalMessages: importData.chats ? importData.chats.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0) : 0,
                    infobarDataEntries: importData.infobarData ? Object.keys(importData.infobarData).length : 0,
                    hasSettings: !!importData.settings
                };

                // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
                const dialog = document.createElement('div');
                dialog.className = 'import-confirm-dialog';
                dialog.innerHTML = `
                    <div class="dialog-overlay">
                        <div class="dialog-content">
                            <h3>ç¡®è®¤å¯¼å…¥æ•°æ®</h3>
                            <div class="import-stats">
                                <p><strong>å¯¼å…¥æ•°æ®ç»Ÿè®¡ï¼š</strong></p>
                                <ul>
                                    <li>èŠå¤©æ•°é‡: ${stats.chats}</li>
                                    <li>æ¶ˆæ¯æ€»æ•°: ${stats.totalMessages}</li>
                                    <li>ä¿¡æ¯æ æ•°æ®æ¡ç›®: ${stats.infobarDataEntries}</li>
                                    <li>åŒ…å«è®¾ç½®: ${stats.hasSettings ? 'æ˜¯' : 'å¦'}</li>
                                </ul>
                                <p><strong>å¯¼å‡ºæ—¶é—´:</strong> ${importData.metadata.exportTime}</p>
                                <p><strong>æ•°æ®èŒƒå›´:</strong> ${importData.metadata.scope === 'current' ? 'å½“å‰èŠå¤©' : 'æ‰€æœ‰èŠå¤©'}</p>
                            </div>
                            <div class="import-warning">
                                <p>âš ï¸ <strong>æ³¨æ„ï¼š</strong></p>
                                <ul>
                                    <li>å¯¼å…¥æ“ä½œå°†è¦†ç›–ç°æœ‰çš„ä¿¡æ¯æ æ•°æ®</li>
                                    <li>å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</li>
                                    <li>æ­¤æ“ä½œæ— æ³•æ’¤é”€</li>
                                </ul>
                            </div>
                            <div class="dialog-actions">
                                <button class="btn btn-danger" data-action="confirm">ç¡®è®¤å¯¼å…¥</button>
                                <button class="btn btn-secondary" data-action="cancel">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ æ ·å¼
                if (!document.getElementById('import-dialog-styles')) {
                    const style = document.createElement('style');
                    style.id = 'import-dialog-styles';
                    style.textContent = `
                        .import-confirm-dialog {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10001;
                        }
                        .dialog-overlay {
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .dialog-content {
                            background: white;
                            border-radius: 8px;
                            padding: 24px;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                        }
                        .dialog-content h3 {
                            margin: 0 0 16px 0;
                            color: #333;
                        }
                        .import-stats {
                            background: #f8f9fa;
                            padding: 16px;
                            border-radius: 6px;
                            margin: 16px 0;
                        }
                        .import-stats ul {
                            margin: 8px 0;
                            padding-left: 20px;
                        }
                        .import-warning {
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            padding: 16px;
                            border-radius: 6px;
                            margin: 16px 0;
                        }
                        .import-warning ul {
                            margin: 8px 0;
                            padding-left: 20px;
                        }
                        .dialog-actions {
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                            margin-top: 24px;
                        }
                        .dialog-actions .btn {
                            padding: 8px 16px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        }
                        .dialog-actions .btn-danger {
                            background: #dc3545;
                            color: white;
                        }
                        .dialog-actions .btn-secondary {
                            background: #6c757d;
                            color: white;
                        }
                    `;
                    document.head.appendChild(style);
                }

                // äº‹ä»¶å¤„ç†
                dialog.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'confirm') {
                        dialog.remove();
                        resolve(true);
                    } else if (action === 'cancel' || e.target === dialog.querySelector('.dialog-overlay')) {
                        dialog.remove();
                        resolve(false);
                    }
                });

                // æ˜¾ç¤ºå¯¹è¯æ¡†
                document.body.appendChild(dialog);

            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå¯¼å…¥ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
                resolve(false);
            }
        });
    }

    /**
     * æ‰§è¡Œå¯¼å…¥æ“ä½œ
     */
    async executeImport(importData) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ“ä½œ...');

            let importedCount = 0;

            // å¯¼å…¥ä¿¡æ¯æ æ•°æ®åˆ°ç»Ÿä¸€æ•°æ®æ ¸å¿ƒ
            if (importData.infobarData && this.unifiedDataCore) {
                Object.entries(importData.infobarData).forEach(([chatId, chatData]) => {
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        // å°†æ•°æ®å†™å…¥ç»Ÿä¸€æ•°æ®æ ¸å¿ƒ
                        this.unifiedDataCore.setMessageData(chatId, messageId, messageData);
                        importedCount++;
                    });
                });
                console.log('[InfoBarSettings] ğŸ“Š å·²å¯¼å…¥ä¿¡æ¯æ æ•°æ®æ¡ç›®:', importedCount);
            }

            // å¯¼å…¥è®¾ç½®ï¼ˆå¯é€‰ï¼‰
            if (importData.settings) {
                const context = SillyTavern.getContext();
                if (context && context.extensionSettings) {
                    // å¤‡ä»½å½“å‰è®¾ç½®
                    const currentSettings = context.extensionSettings['Information bar integration tool'] || {};

                    // åˆå¹¶è®¾ç½®ï¼ˆä¿ç•™å½“å‰çš„APIé…ç½®ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰
                    const mergedSettings = {
                        ...importData.settings,
                        // ä¿ç•™å½“å‰çš„APIé…ç½®
                        apiConfig: currentSettings.apiConfig || importData.settings.apiConfig
                    };

                    context.extensionSettings['Information bar integration tool'] = mergedSettings;

                    // ä¿å­˜è®¾ç½®
                    await this.saveExtensionSettings();
                    console.log('[InfoBarSettings] âš™ï¸ å·²å¯¼å…¥æ‰©å±•è®¾ç½®');
                }
            }

            // è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶
            if (this.eventSource) {
                this.eventSource.emit('dataImported', {
                    importedCount,
                    source: importData.metadata.source,
                    timestamp: new Date().toISOString()
                });
            }

            console.log('[InfoBarSettings] âœ… å¯¼å…¥æ“ä½œå®Œæˆï¼Œå…±å¯¼å…¥', importedCount, 'æ¡æ•°æ®');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œå¯¼å…¥æ“ä½œå¤±è´¥:', error);
            throw new Error('å¯¼å…¥æ‰§è¡Œå¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜æ‰©å±•è®¾ç½®åˆ°SillyTavern
     */
    async saveExtensionSettings() {
        try {
            const context = SillyTavern.getContext();
            if (context && context.saveSettingsDebounced) {
                await context.saveSettingsDebounced();
                console.log('[InfoBarSettings] ğŸ’¾ æ‰©å±•è®¾ç½®å·²ä¿å­˜');
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ‰©å±•è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ç¡®ä¿æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½
     */
    ensureDataManagementStyles() {
        try {
            if (document.getElementById('data-management-styles')) {
                return; // æ ·å¼å·²å­˜åœ¨
            }

            const style = document.createElement('style');
            style.id = 'data-management-styles';
            style.textContent = `
                /* æ•°æ®ç®¡ç†åŠŸèƒ½åŒºåŸŸæ ·å¼ */
                .data-management-actions {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 12px !important;
                    margin-top: 8px !important;
                    width: 100% !important;
                }
                .data-export-btn, .data-import-btn {
                    flex: 1 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 6px !important;
                    padding: 10px 16px !important;
                    border: none !important;
                    border-radius: 6px !important;
                    font-size: 14px !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    min-height: 40px !important;
                    white-space: nowrap !important;
                }
                .data-export-btn {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    color: white !important;
                }
                .data-export-btn:hover {
                    background: var(--theme-primary-hover, #e55a2b) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3) !important;
                }
                .data-import-btn {
                    background: var(--theme-bg-secondary, #4a5568) !important;
                    color: white !important;
                    border: 1px solid var(--theme-border-color, #666) !important;
                }
                .data-import-btn:hover {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2) !important;
                }
                .data-management-hint {
                    color: var(--theme-text-secondary, #a0a0a0) !important;
                    font-size: 13px !important;
                    line-height: 1.4 !important;
                    margin-top: 8px !important;
                    padding: 8px 12px !important;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.1)) !important;
                    border-radius: 4px !important;
                    border-left: 3px solid var(--theme-primary-color, #ff6b35) !important;
                }
            `;
            document.head.appendChild(style);
            console.log('[InfoBarSettings] âœ… æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®ç®¡ç†æ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * è·å–ä¸–ç•Œä¹¦å†…å®¹
     */
    async getWorldBookContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“š å¼€å§‹è·å–ä¸–ç•Œä¹¦å†…å®¹...');

            const context = SillyTavern.getContext();
            if (!context) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–SillyTavernä¸Šä¸‹æ–‡');
                return '';
            }

            // æ–¹æ³•1ï¼šå°è¯•ä» context.worldInfoData è·å–
            if (context.worldInfoData && Array.isArray(context.worldInfoData) && context.worldInfoData.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»worldInfoDataè·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = context.worldInfoData.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            // æ–¹æ³•2ï¼šå°è¯•ä» context.world_info è·å–
            if (context.world_info && Array.isArray(context.world_info) && context.world_info.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»world_infoè·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = context.world_info.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            // æ–¹æ³•3ï¼šå°è¯•é€šè¿‡ SillyTavern API è·å–
            if (typeof context.getWorldInfoSettings === 'function') {
                console.log('[InfoBarSettings] ğŸ“– é€šè¿‡APIè·å–ä¸–ç•Œä¹¦è®¾ç½®');
                const worldInfo = context.getWorldInfoSettings();
                if (worldInfo && worldInfo.length > 0) {
                    const activeEntries = worldInfo.filter(entry =>
                        entry && !entry.disable && entry.content && entry.content.trim()
                    );

                    if (activeEntries.length > 0) {
                        const worldBookText = activeEntries.map(entry => {
                            const title = entry.key || entry.keys || 'Unknown';
                            const content = entry.content || '';
                            return `**${title}**: ${content}`;
                        }).join('\n\n');

                        console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                        return worldBookText;
                    }
                }
            }

            // æ–¹æ³•4ï¼šå°è¯•ç›´æ¥ä»å…¨å±€å˜é‡è·å–
            if (window.world_info && Array.isArray(window.world_info) && window.world_info.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»å…¨å±€å˜é‡è·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = window.world_info.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            console.log('[InfoBarSettings] ğŸ“š æ²¡æœ‰æ‰¾åˆ°æ¿€æ´»çš„ä¸–ç•Œä¹¦å†…å®¹');
            return '';

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * è·å–å¤‡ç”¨ç³»ç»Ÿæç¤ºè¯
     */
    getBackupSystemPrompt() {
        return `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ **CRITICAL: ç»å¯¹ç¦æ­¢è¡¨æ ¼æ ¼å¼ï¼** ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

âŒâŒâŒ **SYSTEM WILL CRASH IF YOU USE TABLE FORMAT** âŒâŒâŒ
âŒ **ç»å¯¹ç¦æ­¢**: | ç±»åˆ« | å†…å®¹ | â† TABLE = CRASH!
âŒ **ç»å¯¹ç¦æ­¢**: ### **åœºæ™¯ä¿¡æ¯æ ** â† MARKDOWN = CRASH!
âŒ **ç»å¯¹ç¦æ­¢**: | :--- | :--- | â† ANY TABLE SYMBOL = CRASH!

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡æ¯æ æ•°æ®ç”ŸæˆåŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„å‰§æƒ…å†…å®¹ï¼Œç”Ÿæˆç»“æ„åŒ–çš„ä¿¡æ¯æ æ•°æ®ã€‚

ğŸš¨ğŸš¨ğŸš¨ **MANDATORY OUTPUT FORMAT - å¼ºåˆ¶è¾“å‡ºæ ¼å¼** ğŸš¨ğŸš¨ğŸš¨

**å¿…é¡»æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¾“å‡ºä¸¤ä¸ªæ ‡ç­¾ï¼š**

1. **FIRST**: <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. **SECOND**: <infobar_data><!--æ“ä½œæŒ‡ä»¤æ ¼å¼æ•°æ®--></infobar_data>

âœ… **æ“ä½œæŒ‡ä»¤æ ¼å¼ç¤ºä¾‹ï¼ˆå”¯ä¸€æ­£ç¡®æ ¼å¼ï¼‰**ï¼š
<infobar_data>
<!--
add personal(1 {"1","å¼ å‡¡","2","25","3","ç”·","4","å·¥ç¨‹å¸ˆ","5","ä¸“æ³¨å·¥ä½œ"})
add world(1 {"1","ç°ä»£éƒ½å¸‚","2","ç°å®ä¸–ç•Œ","3","2024å¹´ä¸‹åˆ","4","åŠå…¬å®¤","5","ç¹å¿™"})
add interaction(1 {"1","å°é›¨","2","åŒäº‹","3","å‹å¥½","4","è®¨è®ºé¡¹ç›®","5","åˆä½œ"})
-->
</infobar_data>

ğŸš¨ **ä¸¥æ ¼è¦æ±‚**ï¼š
1. å¿…é¡»å…ˆè¾“å‡ºaiThinkProcessï¼Œå†è¾“å‡ºinfobar_data
2. å†…å®¹å¿…é¡»åœ¨ <!-- --> æ³¨é‡Šä¸­
3. å¿…é¡»ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼šadd/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
4. ç»å¯¹ç¦æ­¢ä½¿ç”¨è¡¨æ ¼æ ¼å¼ | ç¬¦å·
5. ç»å¯¹ç¦æ­¢ä½¿ç”¨### æ ‡é¢˜æ ¼å¼
6. interactioné¢æ¿å¿…é¡»ä½¿ç”¨npc0.å‰ç¼€æ ¼å¼`;
    }

    /**
     * å‘é€è‡ªå®šä¹‰APIè¯·æ±‚
     * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
     * @param {Object} options - é€‰é¡¹é…ç½®
     * @param {boolean} options.skipSystemPrompt - æ˜¯å¦è·³è¿‡ç³»ç»Ÿæç¤ºè¯æ·»åŠ ï¼ˆç”¨äºæ€»ç»“ç­‰åœºæ™¯ï¼‰
     */
    async sendCustomAPIRequest(messages, options = {}) {
        try {
            console.log('[InfoBarSettings] ğŸ“¡ å‘é€è‡ªå®šä¹‰APIè¯·æ±‚...');

            // ğŸ”§ è·å–APIé…ç½®ï¼šä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„é…ç½®ï¼Œå¦åˆ™ä»æ‰©å±•è®¾ç½®è·å–
            let apiConfig;
            if (options.apiConfig) {
                console.log('[InfoBarSettings] ğŸ”§ ä½¿ç”¨ä¼ é€’çš„APIé…ç½®ï¼ˆæ€»ç»“æ¨¡å¼ï¼‰');
                apiConfig = options.apiConfig;
                console.log('[InfoBarSettings] ğŸ“Š ä¼ é€’çš„APIé…ç½®è¯¦æƒ…:', {
                    provider: apiConfig.provider,
                    model: apiConfig.model,
                    baseUrl: apiConfig.baseUrl,
                    endpoint: apiConfig.endpoint,
                    format: apiConfig.format,
                    maxTokens: apiConfig.maxTokens,
                    temperature: apiConfig.temperature,
                    hasApiKey: !!apiConfig.apiKey
                });
            } else {
                console.log('[InfoBarSettings] ğŸ“Š ä½¿ç”¨æ‰©å±•è®¾ç½®çš„APIé…ç½®');
                const context = SillyTavern.getContext();
                const extensionSettings = context.extensionSettings;
                apiConfig = extensionSettings['Information bar integration tool']?.apiConfig || {};
            }

            if (!apiConfig.provider || !apiConfig.model || !apiConfig.apiKey) {
                throw new Error('APIé…ç½®ä¸å®Œæ•´');
            }

            let enhancedMessages;
            if (options.skipSystemPrompt) {
                console.log('[InfoBarSettings] â­ï¸ è·³è¿‡ç³»ç»Ÿæç¤ºè¯æ·»åŠ ï¼ˆæ€»ç»“æ¨¡å¼ï¼‰');
                enhancedMessages = messages;
            } else {
                // ğŸ”§ ä¿®å¤ï¼šä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯ï¼Œç¡®ä¿è¾“å‡ºæ­£ç¡®çš„ä¸­æ–‡æ ¼å¼å’Œäº”æ­¥åˆ†æ
                console.log('[InfoBarSettings] ğŸ”§ ä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯...');
                enhancedMessages = await this.enhanceMessagesWithSystemPrompt(messages);
            }

            // æ ¹æ®æä¾›å•†å’Œæ¥å£ç±»å‹å‘é€è¯·æ±‚
            if (apiConfig.provider === 'gemini' && apiConfig.format === 'native') {
                return await this.sendGeminiNativeRequest(enhancedMessages, apiConfig, options);
            } else if (apiConfig.provider === 'localproxy') {
                return await this.sendLocalProxyRequest(enhancedMessages, apiConfig);
            } else {
                return await this.sendOpenAICompatibleRequest(enhancedMessages, apiConfig);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å‘é€è‡ªå®šä¹‰APIè¯·æ±‚å¤±è´¥:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä¸ºè‡ªå®šä¹‰APIæ¶ˆæ¯æ·»åŠ ç³»ç»Ÿæç¤ºè¯
     * ç¡®ä¿è‡ªå®šä¹‰APIèƒ½å¤Ÿè¾“å‡ºæ­£ç¡®çš„ä¸­æ–‡æ ¼å¼å’Œäº”æ­¥åˆ†æ
     */
    async enhanceMessagesWithSystemPrompt(messages) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ ä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯...');

            // ç”Ÿæˆè‡ªå®šä¹‰APIä¸“ç”¨çš„ç³»ç»Ÿæç¤ºè¯
            const systemPrompt = await this.generateCustomAPISystemPrompt();

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç³»ç»Ÿæ¶ˆæ¯
            const hasSystemMessage = messages.some(msg => msg.role === 'system');

            if (hasSystemMessage) {
                // å¦‚æœå·²æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œå°†æ–°çš„ç³»ç»Ÿæç¤ºè¯åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯ä¸­
                const systemMessageIndex = messages.findIndex(msg => msg.role === 'system');
                const existingSystemContent = messages[systemMessageIndex].content;
                messages[systemMessageIndex].content = systemPrompt + '\n\n' + existingSystemContent;
                console.log('[InfoBarSettings] ğŸ”§ å·²åˆå¹¶ç³»ç»Ÿæç¤ºè¯åˆ°ç°æœ‰ç³»ç»Ÿæ¶ˆæ¯');
            } else {
                // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œåœ¨å¼€å¤´æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                messages.unshift({
                    role: 'system',
                    content: systemPrompt
                });
                console.log('[InfoBarSettings] ğŸ”§ å·²æ·»åŠ æ–°çš„ç³»ç»Ÿæ¶ˆæ¯');
            }

            // ğŸ”§ æ–°å¢ï¼šåœ¨ç”¨æˆ·æ¶ˆæ¯æœ«å°¾æ·»åŠ æ ¼å¼æé†’ï¼Œç¡®ä¿è¾“å‡ºæ­£ç¡®æ ¼å¼
            const lastUserMessageIndex = messages.map(msg => msg.role).lastIndexOf('user');
            if (lastUserMessageIndex !== -1) {
                const formatReminder = `

ğŸš¨ğŸš¨ğŸš¨ **CRITICAL REMINDER: å¿…é¡»è¾“å‡ºä»¥ä¸‹ä¸¤ä¸ªæ ‡ç­¾** ğŸš¨ğŸš¨ğŸš¨
1. <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. <infobar_data><!--é¢æ¿æ•°æ®--></infobar_data>
âš ï¸ **ä¸¥ç¦é¢ å€’é¡ºåºï¼ä¸¥ç¦å†…å®¹ä¸è¢«æ³¨é‡Šç¬¦å·åŒ…è£¹ï¼**`;

                messages[lastUserMessageIndex].content += formatReminder;
                console.log('[InfoBarSettings] ğŸ”¥ å·²åœ¨ç”¨æˆ·æ¶ˆæ¯æœ«å°¾æ·»åŠ æ ¼å¼æé†’');
            }

            console.log('[InfoBarSettings] âœ… ç³»ç»Ÿæç¤ºè¯å¢å¼ºå®Œæˆï¼Œæ¶ˆæ¯æ•°é‡:', messages.length);
            return messages;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¢å¼ºæ¶ˆæ¯å¤±è´¥:', error);
            // å¦‚æœå¢å¼ºå¤±è´¥ï¼Œè¿”å›åŸå§‹æ¶ˆæ¯
            return messages;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç”Ÿæˆè‡ªå®šä¹‰APIä¸“ç”¨çš„ç³»ç»Ÿæç¤ºè¯
     * åŒ…å«äº”æ­¥åˆ†æã€ä¸­æ–‡æ ¼å¼ã€å¢é‡æ›´æ–°ç­‰å®Œæ•´è¦æ±‚
     */
    async generateCustomAPISystemPrompt() {
        try {
            console.log('[InfoBarSettings] ğŸ“ ç”Ÿæˆè‡ªå®šä¹‰APIç³»ç»Ÿæç¤ºè¯...');

            // è·å–å½“å‰å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanelsInfo = await this.getEnabledPanelsInfo();

            // è·å–å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç”¨äºå¢é‡æ›´æ–°åˆ¤æ–­ï¼‰
            const currentDataInfo = await this.getCurrentDataInfo();

            // ğŸ”§ é‡è¦ä¿®å¤ï¼šç¡®ä¿æ™ºèƒ½æç¤ºè¯è¢«å¼ºåŒ–ç½®äºç³»ç»Ÿæ¶ˆæ¯æœ€å‰é¢
            console.log('[InfoBarSettings] ğŸ”¥ å·²å°†å¼ºåŒ–æ ¼å¼çº¦æŸç½®äºç³»ç»Ÿæ¶ˆæ¯æœ€å‰é¢');
            console.log('[InfoBarSettings] ğŸ§  æ™ºèƒ½æç¤ºè¯å³å°†æ³¨å…¥ï¼Œé•¿åº¦:', enabledPanelsInfo.length);

            // æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ï¼Œæ™ºèƒ½æç¤ºè¯æ”¾åœ¨æœ€å‰é¢
            const systemPrompt = `${enabledPanelsInfo}

ğŸš¨ã€ä¿¡æ¯æ æ•°æ®æ ¼å¼è§„èŒƒ - è‡ªå®šä¹‰APIä¸“ç”¨ã€‘ğŸš¨

ğŸŒŸ **é‡è¦è¯´æ˜ï¼šæ‚¨æ­£åœ¨ä½¿ç”¨è‡ªå®šä¹‰APIæ¨¡å¼å¤„ç†ä¿¡æ¯æ æ•°æ®** ğŸŒŸ

ğŸš¨ **ä¸¥ç¦ç”Ÿæˆå‰§æƒ…å†…å®¹ï¼åªèƒ½è¾“å‡ºæ•°æ®åˆ†æå’Œé¢æ¿æ•°æ®ï¼** ğŸš¨

ğŸ“‹ **æ ¸å¿ƒè¾“å‡ºè¦æ±‚**ï¼š
**ğŸš¨ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¾“å‡ºï¼Œä¸¥ç¦é¢ å€’ ğŸš¨**

**ç¬¬ä¸€æ­¥ï¼šå¿…é¡»å…ˆè¾“å‡ºäº”æ­¥åˆ†ææ€è€ƒ**
<aiThinkProcess>
<!--
[è¾“å‡ºæ¨¡å¼: è‡ªå®šä¹‰API]

äº”æ­¥åˆ†æè¿‡ç¨‹ï¼š
0. æ›´æ–°ç­–ç•¥: æ ¹æ®ç°æœ‰æ•°æ®åˆ¤æ–­æ˜¯å…¨é‡æ›´æ–°è¿˜æ˜¯å¢é‡æ›´æ–°
1. å‰§æƒ…åˆ†æï¼šå½“å‰å‘ç”Ÿä»€ä¹ˆäº‹ä»¶ï¼Ÿè§’è‰²åœ¨å“ªé‡Œï¼Ÿåœ¨åšä»€ä¹ˆï¼Ÿ
2. æ•°æ®å˜åŒ–è¯†åˆ«ï¼šå“ªäº›ä¿¡æ¯å‘ç”Ÿäº†å˜åŒ–ï¼Ÿå“ªäº›æ˜¯æ–°ä¿¡æ¯ï¼Ÿ
3. æ›´æ–°ç­–ç•¥åˆ¤æ–­ï¼šéœ€è¦æ–°å¢å“ªäº›å­—æ®µï¼Ÿéœ€è¦æ›´æ–°å“ªäº›å­—æ®µï¼Ÿå“ªäº›ä¿æŒä¸å˜ï¼Ÿ
4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰å¯ç”¨é¢æ¿éƒ½æœ‰å®Œæ•´æ•°æ®
5. è´¨é‡éªŒè¯ï¼šç¡®è®¤æ•°æ®é€»è¾‘ä¸€è‡´æ€§å’Œåˆç†æ€§
-->
</aiThinkProcess>

**ç¬¬äºŒæ­¥ï¼šå¿…é¡»åè¾“å‡ºé¢æ¿æ•°æ®**
<infobar_data>
<!--
[æ ¹æ®ä¸Šè¿°äº”æ­¥åˆ†æï¼Œè¾“å‡ºå…·ä½“çš„é¢æ¿æ•°æ®ï¼Œä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼]
[é¢æ¿æ•°æ®åŸºäºä¸Šæ–¹çš„æ™ºèƒ½æç¤ºè¯æ¨¡æ¿ç”Ÿæˆ]
-->
</infobar_data>

ğŸš¨ **å¼ºåˆ¶æ ¼å¼è¦æ±‚** ğŸš¨ï¼š
1. **è¾“å‡ºé¡ºåº**ï¼šå¿…é¡»å…ˆè¾“å‡º <aiThinkProcess>ï¼Œå†è¾“å‡º <infobar_data>
2. **æ³¨é‡ŠåŒ…è£¹**ï¼šæ‰€æœ‰å†…å®¹å¿…é¡»è¢« <!--  --> åŒ…è£¹
3. **ä¸­æ–‡è¾“å‡º**ï¼šæ‰€æœ‰å†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼ŒåŒ…æ‹¬åˆ†æè¿‡ç¨‹å’Œæ•°æ®å€¼
4. **æ“ä½œæŒ‡ä»¤æ ¼å¼**ï¼šé¢æ¿æ•°æ®ä½¿ç”¨æ ¼å¼ add/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
5. **å…·ä½“æ•°æ®**ï¼šé¿å…ä½¿ç”¨"æœªçŸ¥"ã€"N/A"ç­‰å ä½ç¬¦ï¼Œç”Ÿæˆå…·ä½“å†…å®¹

${currentDataInfo}

ğŸ“‹ **æ•°æ®æ ¼å¼ç¤ºä¾‹**ï¼š
<aiThinkProcess>
<!--
[è¾“å‡ºæ¨¡å¼: è‡ªå®šä¹‰API]

äº”æ­¥åˆ†æè¿‡ç¨‹ï¼š
0. æ›´æ–°ç­–ç•¥: å¢é‡æ›´æ–°
1. å‰§æƒ…åˆ†æï¼šå¼ ä¸‰æ­£åœ¨ç°ä»£éƒ½å¸‚çš„åŠå…¬å®¤é‡Œå·¥ä½œï¼Œå¤„ç†ç¼–ç¨‹ä»»åŠ¡
2. æ•°æ®å˜åŒ–è¯†åˆ«ï¼šä½ç½®ä»å®¶é‡Œå˜ä¸ºåŠå…¬å®¤ï¼ŒçŠ¶æ€ä»ä¼‘æ¯å˜ä¸ºå·¥ä½œï¼Œæ–°å¢äº†ä»»åŠ¡ä¿¡æ¯
3. æ›´æ–°ç­–ç•¥åˆ¤æ–­ï¼šéœ€è¦æ›´æ–°locationä¸º"åŠå…¬å®¤"ï¼Œoccupationä¿æŒ"ç¨‹åºå‘˜"ï¼Œæ–°å¢tasksç›¸å…³å­—æ®µ
4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼špersonalã€worldã€tasksé¢æ¿éƒ½æœ‰å®Œæ•´æ•°æ®
5. è´¨é‡éªŒè¯ï¼šæ•°æ®ä¸å½“å‰å‰§æƒ…ä¸€è‡´ï¼Œå¼ ä¸‰ä½œä¸ºç¨‹åºå‘˜åœ¨åŠå…¬å®¤å·¥ä½œç¬¦åˆé€»è¾‘
-->
</aiThinkProcess>

<infobar_data>
<!--
add personal(1 {"1","å¼ ä¸‰","2","25","3","ç¨‹åºå‘˜","4","åŠå…¬å®¤","5","å·¥ä½œä¸­"})
add world(1 {"1","ç°ä»£éƒ½å¸‚","2","éƒ½å¸‚","3","2024å¹´","4","åŠå…¬å¤§æ¥¼"})
add interaction(1 {"1","ææ–‡é™","2","åŒäº‹","3","å‹å¥½","4","åˆä½œä¼™ä¼´","5","è®¨è®ºé¡¹ç›®"})
add tasks(1 {"1","æ–°ä»»åŠ¡åˆ›å»º","2","ä»»åŠ¡ç¼–è¾‘ä¸­","3","è¿›è¡Œä¸­"})
-->
</infobar_data>

ğŸš¨ğŸš¨ğŸš¨ **CRITICAL: æ“ä½œæŒ‡ä»¤æ ¼å¼å¼ºåˆ¶è¦æ±‚** ğŸš¨ğŸš¨ğŸš¨
ğŸ”´ **æ‰€æœ‰é¢æ¿å¿…é¡»ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼**
ğŸ”´ **é”™è¯¯æ ¼å¼å°†å¯¼è‡´ç³»ç»Ÿå®Œå…¨æ‹’ç»ï¼Œä¸ä¼šæœ‰ä»»ä½•å…¼å®¹æ€§å¤„ç†ï¼**
ğŸ”´ **æ­£ç¡®: add interaction(1 {"1","æ±Ÿç³","2","æœ‹å‹","3","å‹å¥½"})**
ğŸ”´ **é”™è¯¯: interaction: npc0.name="æ±Ÿç³", npc0.type="æœ‹å‹" â† æ—§æ ¼å¼ï¼Œç³»ç»Ÿæ‹’ç»ï¼**

âš ï¸ **ä¸¥ç¦æ ¼å¼é”™è¯¯**ï¼š
âŒ é”™è¯¯ï¼š<aiThinkProcess>å†…å®¹ä¸è¢«æ³¨é‡ŠåŒ…è£¹</aiThinkProcess>
âŒ é”™è¯¯ï¼šå…ˆè¾“å‡ºinfobar_dataå†è¾“å‡ºaiThinkProcess
âŒ é”™è¯¯ï¼šä½¿ç”¨è‹±æ–‡å†…å®¹æˆ–å ä½ç¬¦
âŒ é”™è¯¯ï¼šinteractioné¢æ¿ä¸ä½¿ç”¨npcå‰ç¼€ â† ç³»ç»Ÿå´©æºƒï¼

ğŸš¨ğŸš¨ğŸš¨ **ä¸¥ç¦ç”Ÿæˆä»»ä½•å‰§æƒ…å†…å®¹ï¼** ğŸš¨ğŸš¨ğŸš¨
âŒ **ä¸¥ç¦è¾“å‡ºä»»ä½•æ•…äº‹æƒ…èŠ‚ã€å¯¹è¯ã€åœºæ™¯æè¿°**
âŒ **ä¸¥ç¦è¾“å‡ºä»»ä½•å™è¿°æ€§æ–‡å­—**
âŒ **åªèƒ½è¾“å‡ºæ•°æ®åˆ†æå’ŒXMLæ ¼å¼çš„é¢æ¿æ•°æ®**
âŒ **ä¸è¦å†™"å¼ å‡¡ç”¨æ‰‹æŠ¹å»èº«ä¸Šçš„æ°´ç "è¿™ç±»å‰§æƒ…å†…å®¹**

âœ… **å¿…é¡»ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ€è€ƒå’Œæ•°æ®ç”Ÿæˆ**
âœ… **å¿…é¡»åŸºäºå…·ä½“å‰§æƒ…ç”ŸæˆçœŸå®æ•°æ®**
âœ… **å¿…é¡»éµå¾ªä¸Šè¿°è¾“å‡ºé¡ºåºå’Œæ ¼å¼è¦æ±‚**
âœ… **interactioné¢æ¿å¿…é¡»ä½¿ç”¨npc0.å‰ç¼€æ ¼å¼**
âœ… **åªè¾“å‡ºæ•°æ®åˆ†æå’Œé¢æ¿æ•°æ®ï¼Œç»ä¸è¾“å‡ºå‰§æƒ…å†…å®¹**`;

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIç³»ç»Ÿæç¤ºè¯ç”Ÿæˆå®Œæˆ');
            return systemPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆç³»ç»Ÿæç¤ºè¯å¤±è´¥:', error);
            // è¿”å›åŸºç¡€ç³»ç»Ÿæç¤ºè¯
            return this.getBasicCustomAPISystemPrompt();
        }
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šè·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯ï¼ˆç”¨äºç³»ç»Ÿæç¤ºè¯ï¼‰
     */
    async getEnabledPanelsInfo() {
        try {
            console.log('[InfoBarSettings] ğŸ§  è·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯...');

            // ğŸš¨ å…³é”®ä¿®å¤ï¼šç›´æ¥è°ƒç”¨SmartPromptSystemçš„generateSmartPromptæ–¹æ³•
            // è¿™æ ·å¯ä»¥è·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯ï¼Œè€Œä¸æ˜¯ç®€çŸ­çš„é¢æ¿æ¦‚è¿°
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemä¸å¯ç”¨');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            // æ£€æŸ¥SmartPromptSystemæ˜¯å¦å·²åˆå§‹åŒ–
            if (!smartPromptSystem.initialized) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªåˆå§‹åŒ–');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            // ğŸš€ å…³é”®ï¼šè°ƒç”¨generateSmartPromptè·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯
            let fullSmartPrompt = await smartPromptSystem.generateSmartPrompt();
            if (!fullSmartPrompt || fullSmartPrompt.length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemè¿”å›ç©ºçš„æ™ºèƒ½æç¤ºè¯');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸè·å–å®Œæ•´æ™ºèƒ½æç¤ºè¯ï¼Œé•¿åº¦: ${fullSmartPrompt.length} å­—ç¬¦`);

            // ğŸ”§ ä¿®å¤ï¼šä¸è¦å¯¹æ™ºèƒ½æç¤ºè¯åº”ç”¨æ­£åˆ™è¿‡æ»¤ï¼
            // æ™ºèƒ½æç¤ºè¯æ˜¯æ ¼å¼è¯´æ˜å’Œè¦æ±‚ï¼Œé‡Œé¢çš„<aiThinkProcess>ç­‰æ˜¯ç¤ºä¾‹ï¼Œä¸åº”è¯¥è¢«è¿‡æ»¤
            // æ­£åˆ™è¡¨è¾¾å¼åªåº”è¯¥åº”ç”¨äºä¸»APIè¿”å›çš„å®é™…æ¶ˆæ¯å†…å®¹

            // ğŸ”§ æ–°å¢ï¼šå¼ºåŒ–æ™ºèƒ½æç¤ºè¯æ—¥å¿—ï¼Œç¡®ä¿å¯ä»¥çœ‹åˆ°æ™ºèƒ½æç¤ºè¯æ˜¯å¦æ­£ç¡®è·å–
            console.log('[InfoBarSettings] ğŸ§  è·å–åˆ°æ™ºèƒ½æç¤ºè¯ï¼ˆä¿æŒåŸæ ·ï¼Œä¸è¿‡æ»¤ï¼‰ï¼Œé•¿åº¦:', fullSmartPrompt.length);
            console.log('[InfoBarSettings] ğŸ§  æ™ºèƒ½æç¤ºè¯å‰200å­—ç¬¦é¢„è§ˆ:', fullSmartPrompt.substring(0, 200));

            return fullSmartPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å®Œæ•´æ™ºèƒ½æç¤ºè¯å¤±è´¥:', error);
            return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–å½“å‰æ•°æ®ä¿¡æ¯ï¼ˆç”¨äºå¢é‡æ›´æ–°åˆ¤æ–­ï¼‰
     */
    async getCurrentDataInfo() {
        try {
            // è·å–SmartPromptSystemæ¥è·å–å½“å‰æ•°æ®çŠ¶æ€
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                return '';
            }

            const enabledPanels = await smartPromptSystem.getEnabledPanels();
            if (!enabledPanels || enabledPanels.length === 0) {
                return '';
            }

            const currentPanelData = await smartPromptSystem.getCurrentPanelData(enabledPanels);
            const updateStrategy = await smartPromptSystem.analyzeUpdateStrategy(enabledPanels, currentPanelData);

            let dataInfo = `\nğŸ“Š **å½“å‰æ•°æ®çŠ¶æ€**ï¼š\n`;
            dataInfo += `- æ•°æ®è¦†ç›–ç‡: ${updateStrategy.dataPercentage}%\n`;
            dataInfo += `- å»ºè®®ç­–ç•¥: ${updateStrategy.type === 'full' ? 'å…¨é‡æ›´æ–°' : 'å¢é‡æ›´æ–°'}\n`;
            dataInfo += `- å¯ç”¨é¢æ¿: ${enabledPanels.length}ä¸ª\n\n`;

            if (Object.keys(currentPanelData).length > 0) {
                dataInfo += `**ç°æœ‰æ•°æ®æ¦‚è§ˆ**ï¼š\n`;
                for (const [panelKey, panelData] of Object.entries(currentPanelData)) {
                    const fieldCount = Object.keys(panelData).length;
                    dataInfo += `- ${panelKey}: ${fieldCount}ä¸ªå­—æ®µå·²æœ‰æ•°æ®\n`;
                }
                dataInfo += '\n**å¢é‡æ›´æ–°æŒ‡å¯¼**ï¼šåªè¾“å‡ºå‘ç”Ÿå˜åŒ–æˆ–æ–°å¢çš„å­—æ®µæ•°æ®\n';
            } else {
                dataInfo += `**å…¨é‡æ›´æ–°æŒ‡å¯¼**ï¼šç”Ÿæˆæ‰€æœ‰å¯ç”¨é¢æ¿çš„å®Œæ•´æ•°æ®\n`;
            }

            return dataInfo;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–åŸºç¡€ç³»ç»Ÿæç¤ºè¯ï¼ˆå¤‡ç”¨ï¼‰
     */
    getBasicCustomAPISystemPrompt() {
        return `ğŸš¨ã€ä¿¡æ¯æ æ•°æ®æ ¼å¼è§„èŒƒ - è‡ªå®šä¹‰APIã€‘ğŸš¨

**å¿…é¡»è¾“å‡ºæ ¼å¼**ï¼š
1. å…ˆè¾“å‡º: <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. å†è¾“å‡º: <infobar_data><!--é¢æ¿æ•°æ®--></infobar_data>

**æ ¼å¼è¦æ±‚**ï¼š
- ä½¿ç”¨ä¸­æ–‡è¿›è¡Œåˆ†æå’Œæ•°æ®ç”Ÿæˆ
- å†…å®¹å¿…é¡»è¢« <!--  --> åŒ…è£¹
- æ•°æ®æ ¼å¼: add/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
- é¿å…ä½¿ç”¨å ä½ç¬¦ï¼Œç”Ÿæˆå…·ä½“å†…å®¹

**ä¸¥ç¦é¢ å€’è¾“å‡ºé¡ºåºæˆ–çœç•¥ä»»ä½•æ ‡ç­¾**`;
    }

    /**
     * è·å–SmartPromptSystemçš„æ™ºèƒ½æç¤ºè¯
     */
    async getSmartPromptSystemPrompt() {
        try {
            console.log('[InfoBarSettings] ğŸ§  è·å–SmartPromptSystemæ™ºèƒ½æç¤ºè¯...');

            // è·å–SmartPromptSystemå®ä¾‹
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªæ‰¾åˆ°');
                return '';
            }

            // æ£€æŸ¥SmartPromptSystemæ˜¯å¦å·²åˆå§‹åŒ–
            if (!smartPromptSystem.initialized) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªåˆå§‹åŒ–');
                return '';
            }

            // ç”Ÿæˆæ™ºèƒ½æç¤ºè¯
            const smartPrompt = await smartPromptSystem.generateSmartPrompt();
            if (!smartPrompt || smartPrompt.length === 0) {
                console.log('[InfoBarSettings] ğŸ“ SmartPromptSystemè¿”å›ç©ºæç¤ºè¯');
                return '';
            }

            console.log('[InfoBarSettings] âœ… æˆåŠŸè·å–æ™ºèƒ½æç¤ºè¯ï¼Œé•¿åº¦:', smartPrompt.length);
            return smartPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æ™ºèƒ½æç¤ºè¯å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * å‘é€æœ¬åœ°åä»£è¯·æ±‚ (é€šè¿‡SillyTavernåç«¯)
     */
    async sendLocalProxyRequest(messages, apiConfig) {
        try {
            console.log('[InfoBarSettings] ğŸš€ å‘é€æœ¬åœ°åä»£è¯·æ±‚...');

            // ğŸš¨ é‡è¦ä¿®å¤ï¼šæœ¬åœ°åä»£ä¸éœ€è¦é‡å¤æ·»åŠ æ™ºèƒ½æç¤ºè¯ï¼
            // å› ä¸ºæ¶ˆæ¯å·²ç»é€šè¿‡enhanceMessagesWithSystemPromptæ–¹æ³•æ·»åŠ äº†æ­£ç¡®çš„ç³»ç»Ÿæç¤ºè¯
            console.log('[InfoBarSettings] â„¹ï¸ æœ¬åœ°åä»£ä½¿ç”¨å·²å¢å¼ºçš„æ¶ˆæ¯ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºè¯ï¼‰');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // æ„å»ºç”Ÿæˆè¯·æ±‚
            const generateUrl = `${window.location.origin}/api/backends/chat-completions/generate`;

            // æ ‡è®°æœ¬æ¬¡è¯·æ±‚IDä¸URLï¼ˆç”¨äºåç»­å–æ¶ˆï¼‰
            this.currentAPIRequestId = this.currentAPIRequestId || `ib_${Date.now()}_${Math.random().toString(36).slice(2)}`;
            this.lastRequestUrl = generateUrl;

            // ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„chat_completion_source
            // SillyTavernåç«¯æœŸæœ›ä½¿ç”¨å®é™…çš„APIæºï¼ˆå¦‚"openai"ï¼‰ï¼Œè€Œä¸æ˜¯"custom"
            const requestBody = {
                messages: messages,
                model: apiConfig.model,
                temperature: apiConfig.temperature || 0.7,
                frequency_penalty: 0,
                presence_penalty: 0,
                top_p: 1.0,
                max_tokens: apiConfig.maxTokens || 20000,
                stream: false,
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨"openai"ä½œä¸ºchat_completion_source
                chat_completion_source: "openai",
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨reverse_proxyå­—æ®µæŒ‡å®šåä»£åœ°å€
                reverse_proxy: apiConfig.endpoint || apiConfig.baseUrl,
                proxy_password: apiConfig.apiKey || ""
            };

            console.log('[InfoBarSettings] ğŸ“ æœ¬åœ°åä»£è¯·æ±‚å‚æ•°:', {
                endpoint: generateUrl,
                model: requestBody.model,
                temperature: requestBody.temperature,
                max_tokens: requestBody.max_tokens,
                reverse_proxy: requestBody.reverse_proxy,
                hasPassword: !!requestBody.proxy_password,
                messagesCount: messages.length
            });

            // ä¸ºè¯·æ±‚é™„åŠ å¯è·Ÿè¸ªçš„Request-IDï¼Œä¾¿äºåç«¯å–æ¶ˆ
            const genHeaders = {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken,
                'X-Request-ID': this.currentAPIRequestId
            };
            const response = await fetch(generateUrl, {
                method: 'POST',
                headers: genHeaders,
                body: JSON.stringify({ ...requestBody, request_id: this.currentAPIRequestId })
            });

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£å“åº”çŠ¶æ€:', response.status);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥å“åº”å¤´ä¿¡æ¯ï¼Œå¸®åŠ©è¯Šæ–­é•¿åº¦é—®é¢˜
            const contentLength = response.headers.get('content-length');
            const contentType = response.headers.get('content-type');
            console.log('[InfoBarSettings] ğŸ“Š å“åº”å¤´ä¿¡æ¯:', {
                contentLength: contentLength,
                contentType: contentType,
                status: response.status,
                statusText: response.statusText
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¯·æ±‚å¤±è´¥:', response.status, errorText);
                throw new Error(`æœ¬åœ°åä»£APIé”™è¯¯: ${response.status} ${response.statusText} - ${errorText}`);
            }

            // ğŸ”§ å¢å¼ºå“åº”å¤„ç†ï¼šå…ˆè·å–åŸå§‹æ–‡æœ¬ï¼Œç„¶åè§£æJSON
            const rawResponseText = await response.text();
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”æ–‡æœ¬é•¿åº¦:', rawResponseText.length);
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”å‰500å­—ç¬¦:', rawResponseText.substring(0, 500));
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”å500å­—ç¬¦:', rawResponseText.substring(Math.max(0, rawResponseText.length - 500)));

            let data;
            try {
                data = JSON.parse(rawResponseText);
                console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£å“åº”æ•°æ®è§£ææˆåŠŸ');
            } catch (parseError) {
                console.error('[InfoBarSettings] âŒ JSONè§£æå¤±è´¥:', parseError);
                console.error('[InfoBarSettings] âŒ åŸå§‹å“åº”å†…å®¹:', rawResponseText);
                throw new Error(`æœ¬åœ°åä»£å“åº”JSONè§£æå¤±è´¥: ${parseError.message}`);
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (data.error) {
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£APIé”™è¯¯:', data.error);
                const errorMessage = data.error.message || data.error.toString() || 'æœªçŸ¥é”™è¯¯';
                throw new Error(`æœ¬åœ°åä»£APIé”™è¯¯: ${errorMessage}`);
            }

            // ğŸ”§ å¢å¼ºå“åº”è§£æï¼šæ›´è¯¦ç»†çš„å†…å®¹æå–å’ŒéªŒè¯
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹è§£æç”Ÿæˆå†…å®¹...');
            console.log('[InfoBarSettings] ğŸ“Š å“åº”æ•°æ®ç»“æ„:', {
                hasChoices: !!data.choices,
                choicesLength: data.choices?.length || 0,
                firstChoice: data.choices?.[0] ? Object.keys(data.choices[0]) : 'none',
                hasMessage: !!(data.choices?.[0]?.message),
                messageKeys: data.choices?.[0]?.message ? Object.keys(data.choices[0].message) : 'none'
            });

            // è§£æå“åº” - å¤šç§æ ¼å¼å…¼å®¹
            let generatedText = '';

            if (data.choices && Array.isArray(data.choices) && data.choices.length > 0) {
                const choice = data.choices[0];

                if (choice.message && choice.message.content) {
                    generatedText = choice.message.content;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨message.contentæ ¼å¼æå–å†…å®¹');
                } else if (choice.text) {
                    generatedText = choice.text;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨textæ ¼å¼æå–å†…å®¹');
                } else if (choice.content) {
                    generatedText = choice.content;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨contentæ ¼å¼æå–å†…å®¹');
                }
            } else if (data.content) {
                generatedText = data.content;
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨ç›´æ¥contentæ ¼å¼æå–å†…å®¹');
            } else if (data.text) {
                generatedText = data.text;
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨ç›´æ¥textæ ¼å¼æå–å†…å®¹');
            }

            if (!generatedText || generatedText.trim().length === 0) {
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¿”å›ç©ºå†…å®¹');
                console.error('[InfoBarSettings] âŒ å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
                throw new Error('æœ¬åœ°åä»£APIè¿”å›ç©ºå†…å®¹ï¼Œå¯èƒ½æ˜¯æ¨¡å‹ä¸å¯ç”¨æˆ–é…ç½®é”™è¯¯');
            }

            console.log(`[InfoBarSettings] âœ… æœ¬åœ°åä»£è¯·æ±‚æˆåŠŸï¼Œç”Ÿæˆå†…å®¹é•¿åº¦: ${generatedText.length} å­—ç¬¦`);
            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå†…å®¹å‰200å­—ç¬¦é¢„è§ˆ:', generatedText.substring(0, 200));
            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå†…å®¹å200å­—ç¬¦é¢„è§ˆ:', generatedText.substring(Math.max(0, generatedText.length - 200)));

            return {
                success: true,
                text: generatedText,
                usage: data.usage
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¯·æ±‚å¼‚å¸¸:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * å‘é€GeminiåŸç”ŸAPIè¯·æ±‚
     */
    async sendGeminiNativeRequest(messages, apiConfig, options = {}) {
        console.log('[InfoBarSettings] ğŸ”„ å‘é€GeminiåŸç”Ÿè¯·æ±‚...');

        const systemMessage = messages.find(m => m.role === 'system');
        const userMessage = messages.find(m => m.role === 'user');

        const prompt = systemMessage ? `${systemMessage.content}\n\n${userMessage.content}` : userMessage.content;

        // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®ä½¿ç”¨åœºæ™¯åŠ¨æ€è®¾ç½®maxOutputTokens
        // æ€»ç»“åŠŸèƒ½éœ€è¦æ›´å¤§çš„è¾“å‡ºä»¤ç‰Œæ•°ï¼Œæ™®é€šä¿¡æ¯æ è¯·æ±‚ä½¿ç”¨è¾ƒå°å€¼
        const isSummaryRequest = options?.skipSystemPrompt === true;
        const defaultMaxTokens = isSummaryRequest ? 8000 : 2000;  // æ€»ç»“è¯·æ±‚ä½¿ç”¨8000ï¼Œæ™®é€šè¯·æ±‚ä½¿ç”¨2000

        const requestBody = {
            contents: [{
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                temperature: apiConfig.temperature || 0.7,
                maxOutputTokens: apiConfig.maxTokens || defaultMaxTokens
            }
        };

        console.log('[InfoBarSettings] ğŸ”§ APIè¯·æ±‚é…ç½®:', {
            isSummaryRequest,
            maxOutputTokens: requestBody.generationConfig.maxOutputTokens,
            temperature: requestBody.generationConfig.temperature,
            promptLength: prompt.length
        });

        const requestUrl = `${apiConfig.baseUrl}/v1beta/models/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`;
        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', requestUrl);

        let response;
        try {
            // ğŸ”§ æ–°å¢ï¼šæ„å»ºfetché€‰é¡¹ï¼ŒåŒ…å«AbortSignal
            const fetchOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'SillyTavern-InfoBar/1.0'
                },
                body: JSON.stringify(requestBody)
            };

            // ğŸ”§ æ–°å¢ï¼šå¦‚æœæä¾›äº†signalï¼Œæ·»åŠ åˆ°fetché€‰é¡¹ä¸­
            if (options.signal) {
                fetchOptions.signal = options.signal;
                console.log('[InfoBarSettings] ğŸ›‘ å·²æ·»åŠ AbortSignalåˆ°è¯·æ±‚');
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(requestUrl, fetchOptions);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(requestUrl, fetchOptions);
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ GeminiåŸç”Ÿè¯·æ±‚å¤±è´¥:', fetchError);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ­¢é”™è¯¯
            if (fetchError.name === 'AbortError') {
                console.log('[InfoBarSettings] ğŸ›‘ è¯·æ±‚å·²è¢«ä¸­æ­¢');
                throw fetchError;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®Gemini APIï¼Œè¯·æ£€æŸ¥åä»£é…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            // ğŸ”§ ç‰¹æ®Šå¤„ç†429å’Œ500é”™è¯¯
            if (response.status === 429) {
                // è·å–é‡è¯•å»ºè®®æ—¶é—´
                const retryAfter = response.headers.get('Retry-After') || 60;
                console.warn(`[InfoBarSettings] âš ï¸ 429é¢‘ç‡é™åˆ¶ï¼Œå»ºè®®${retryAfter}ç§’åé‡è¯•`);

                throw new Error(`APIè¯·æ±‚é¢‘ç‡è¿‡é«˜(429)ï¼Œè¯·ç­‰å¾…${retryAfter}ç§’åé‡è¯•ã€‚å»ºè®®è°ƒæ•´è¯·æ±‚é—´éš”æˆ–ç¨åå†è¯•ã€‚`);
            } else if (response.status === 500) {
                console.error('[InfoBarSettings] âŒ 500æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');

                // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                let errorDetail = '';
                try {
                    const errorData = await response.text();
                    errorDetail = errorData.substring(0, 200);
                    console.error('[InfoBarSettings] ğŸ“Š 500é”™è¯¯è¯¦æƒ…:', errorDetail);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–500é”™è¯¯è¯¦æƒ…');
                }

                throw new Error(`GeminiæœåŠ¡å™¨å†…éƒ¨é”™è¯¯(500)ï¼Œè¿™å¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ã€‚å»ºè®®ç¨åé‡è¯•ã€‚${errorDetail ? 'é”™è¯¯è¯¦æƒ…: ' + errorDetail : ''}`);
            } else {
                throw new Error(`Gemini APIé”™è¯¯: ${response.status} ${response.statusText}`);
            }
        }

        const data = await response.json();

        console.log('[InfoBarSettings] ğŸ” Gemini APIå“åº”æ•°æ®ç»“æ„:', JSON.stringify(data, null, 2));

        // ğŸ”§ æ”¹è¿›çš„å“åº”è§£æé€»è¾‘ï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„æ ¼å¼
        let extractedText = '';

        // å°è¯•æ ‡å‡†çš„Geminiå“åº”æ ¼å¼
        if (data.candidates && data.candidates[0]) {
            const candidate = data.candidates[0];
            console.log('[InfoBarSettings] ğŸ“Š å€™é€‰å“åº”ç»“æ„:', {
                hasContent: !!candidate.content,
                hasParts: !!(candidate.content?.parts),
                partsLength: candidate.content?.parts?.length || 0,
                hasText: !!candidate.text,
                hasOutput: !!candidate.output
            });

            if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                extractedText = candidate.content.parts[0].text || '';
                console.log('[InfoBarSettings] âœ… ä»æ ‡å‡†è·¯å¾„æå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            } else if (candidate.text) {
                extractedText = candidate.text;
                console.log('[InfoBarSettings] âœ… ä»candidate.textæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            } else if (candidate.output) {
                extractedText = candidate.output;
                console.log('[InfoBarSettings] âœ… ä»candidate.outputæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            }
        }

        // å¦‚æœæ ‡å‡†è·¯å¾„å¤±è´¥ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„æ ¼å¼
        if (!extractedText && data.text) {
            extractedText = data.text;
            console.log('[InfoBarSettings] âœ… ä»data.textæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
        }

        // æœ€åå°è¯•ä»æ•´ä¸ªå“åº”ä¸­æŸ¥æ‰¾æ–‡æœ¬å†…å®¹
        if (!extractedText) {
            console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä»æ ‡å‡†è·¯å¾„æå–æ–‡æœ¬ï¼Œå°è¯•æ·±åº¦æœç´¢...');

            // é€’å½’æœç´¢æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬å†…å®¹çš„å­—æ®µ
            const searchForText = (obj, path = '') => {
                if (typeof obj === 'string' && obj.trim() && obj.length > 20) {
                    console.log(`[InfoBarSettings] ğŸ” æ‰¾åˆ°å¯èƒ½çš„æ–‡æœ¬å†…å®¹: ${path} (é•¿åº¦: ${obj.length})`);
                    return obj;
                }
                if (typeof obj === 'object' && obj !== null) {
                    for (const [key, value] of Object.entries(obj)) {
                        if (key !== 'usage' && key !== 'usageMetadata') { // è·³è¿‡ä½¿ç”¨ç»Ÿè®¡
                            const result = searchForText(value, `${path}.${key}`);
                            if (result) return result;
                        }
                    }
                }
                return null;
            };

            extractedText = searchForText(data, 'data') || '';
        }

        if (!extractedText) {
            console.error('[InfoBarSettings] âŒ æ— æ³•ä»Geminiå“åº”ä¸­æå–ä»»ä½•æ–‡æœ¬å†…å®¹');
            console.error('[InfoBarSettings] ğŸ“Š å®Œæ•´å“åº”ç»“æ„keys:', Object.keys(data));
            console.error('[InfoBarSettings] ğŸ“Š å€™é€‰è€…è¯¦æƒ…:', data.candidates);

            // å¦‚æœå®Œå…¨æ²¡æœ‰æ–‡æœ¬å†…å®¹ï¼Œè¿”å›é”™è¯¯è€Œä¸æ˜¯ç©ºæ–‡æœ¬
            throw new Error('Gemini APIè¿”å›äº†ç©ºçš„æ–‡æœ¬å†…å®¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–æ¨¡å‹å“åº”');
        }

        return {
            success: true,
            text: extractedText.trim(),
            usage: data.usageMetadata || data.usage
        };
    }

    /**
     * å‘é€OpenAIå…¼å®¹APIè¯·æ±‚
     */
    async sendOpenAICompatibleRequest(messages, apiConfig) {
        console.log('[InfoBarSettings] ğŸ”„ å‘é€OpenAIå…¼å®¹è¯·æ±‚...');

        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿baseUrlå­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨fallback
        let baseUrl = apiConfig.baseUrl || apiConfig.endpoint;
        if (!baseUrl) {
            console.error('[InfoBarSettings] âŒ baseUrlå’Œendpointéƒ½æœªé…ç½®');
            throw new Error('APIåŸºç¡€URLæœªé…ç½®ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®');
        }

        // ğŸ”§ ç§»é™¤æœ«å°¾å¯èƒ½çš„è·¯å¾„éƒ¨åˆ†ï¼Œç¡®ä¿åªæœ‰åŸºç¡€URL
        if (baseUrl.endsWith('/chat/completions')) {
            baseUrl = baseUrl.replace('/chat/completions', '');
        }
        if (baseUrl.endsWith('/v1')) {
            baseUrl = baseUrl.replace('/v1', '');
        }

        const requestBody = {
            model: apiConfig.model,
            messages: messages,
            temperature: apiConfig.temperature || 0.7,
            max_tokens: apiConfig.maxTokens || 20000 // ğŸ”§ ä¿®å¤ï¼šé»˜è®¤20000ï¼Œä¸UIè¡¨å•ä¸€è‡´
        };

        console.log('[InfoBarSettings] ğŸ”§ APIè¯·æ±‚å‚æ•°:', {
            model: requestBody.model,
            temperature: requestBody.temperature,
            max_tokens: requestBody.max_tokens, // ğŸ”§ æ˜¾ç¤ºå®é™…ä½¿ç”¨çš„æœ€å¤§ä»¤ç‰Œæ•°
            messagesCount: messages.length,
            userConfiguredMaxTokens: apiConfig.maxTokens // ğŸ”§ æ˜¾ç¤ºç”¨æˆ·é…ç½®çš„ä»¤ç‰Œæ•°
        });

        const requestUrl = `${baseUrl}/v1/chat/completions`;
        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', requestUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ OpenAIå…¼å®¹è¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®åä»£APIï¼Œè¯·æ£€æŸ¥åä»£æœåŠ¡å™¨çš„CORSé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            // ğŸ”§ ä¸“é—¨å¤„ç†500æœåŠ¡å™¨é”™è¯¯
            if (response.status === 500) {
                let errorDetail = '';
                try {
                    const errorText = await response.text();
                    errorDetail = errorText.substring(0, 300);
                    console.error('[InfoBarSettings] âŒ 500æœåŠ¡å™¨é”™è¯¯è¯¦æƒ…:', errorDetail);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–500é”™è¯¯è¯¦æƒ…');
                }

                throw new Error(`åä»£æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500): å¯èƒ½æ˜¯ä»¥ä¸‹é—®é¢˜ä¹‹ä¸€ï¼š
1. åä»£é…ç½®é—®é¢˜ï¼š/v1/chat/completionsç«¯ç‚¹é…ç½®é”™è¯¯
2. åç«¯APIé—®é¢˜ï¼šä¸Šæ¸¸APIæœåŠ¡å¼‚å¸¸æˆ–é…é¢ä¸è¶³
3. è¯·æ±‚æ ¼å¼é—®é¢˜ï¼šåä»£æœåŠ¡å™¨ä¸æ”¯æŒå½“å‰è¯·æ±‚æ ¼å¼
4. è®¤è¯é—®é¢˜ï¼šåç«¯API Keyæ— æ•ˆæˆ–è¿‡æœŸ

æŠ€æœ¯è¯¦æƒ…: ${response.status} ${response.statusText}${errorDetail ? ' - ' + errorDetail : ''}

å»ºè®®æ£€æŸ¥åä»£æœåŠ¡å™¨æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚`);
            }

            throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        return {
            success: true,
            text: data.choices?.[0]?.message?.content || '',
            usage: data.usage
        };
    }

    /**
     * å¤„ç†APIç»“æœ
     */
    async processAPIResult(resultText) {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹å¤„ç†APIç»“æœ...');
            console.log('[InfoBarSettings] ğŸ“ ç»“æœå‰500å­—ç¬¦:', resultText.substring(0, 500));

            // ğŸ”§ æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåº”ç”¨OUTPUTæ­£åˆ™è¡¨è¾¾å¼
            // OUTPUTæ­£åˆ™å·²åœ¨è·å–ä¸»APIæ¶ˆæ¯æ—¶åº”ç”¨ï¼ˆè¿‡æ»¤ä¸»APIçš„æ ‡ç­¾ï¼‰
            // è¿™é‡Œçš„resultTextæ˜¯è‡ªå®šä¹‰APIè¿”å›çš„æ–°å†…å®¹ï¼Œä¸åº”è¯¥è¢«è¿‡æ»¤

            // è·å–APIé…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦å¯ç”¨åˆå¹¶æ¶ˆæ¯
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const apiConfig = extensionSettings['Information bar integration tool']?.apiConfig || {};
            const mergeMessages = apiConfig.mergeMessages !== undefined ? apiConfig.mergeMessages : true; // é»˜è®¤ä¸ºtrue

            if (mergeMessages) {
                console.log('[InfoBarSettings] ğŸ”„ åˆå¹¶æ¶ˆæ¯æ¨¡å¼ï¼šå°†APIæ•°æ®åˆå¹¶åˆ°AIæ¶ˆæ¯ä¸­');

                // ç¬¬ä¸€æ­¥ï¼šå°†infobar_dataåˆå¹¶åˆ°æœ€æ–°çš„AIæ¶ˆæ¯ä¸­
                const success = await this.appendInfobarDataToLatestMessage(resultText);
                if (!success) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•å°†infobar_dataåˆå¹¶åˆ°æ¶ˆæ¯ä¸­');
                    return;
                }

                // ç¬¬äºŒæ­¥ï¼šè§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼Œè®©EventSystemå¤„ç†
                if (context && context.eventSource && context.chat && context.chat.length > 0) {
                    const lastMessage = context.chat[context.chat.length - 1];
                    if (lastMessage && !lastMessage.is_user) {
                        console.log('[InfoBarSettings] ğŸ“¡ è§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶è¿›è¡Œæ•°æ®è§£æ...');

                        // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿æ¶ˆæ¯å†…å®¹å·²ç»è¢«æ­£ç¡®æ›´æ–°
                        setTimeout(() => {
                            // é‡æ–°è·å–æœ€æ–°æ¶ˆæ¯ï¼Œç¡®ä¿è·å–åˆ°æ›´æ–°åçš„å†…å®¹
                            const updatedMessage = context.chat[context.chat.length - 1];
                            if (updatedMessage && !updatedMessage.is_user) {
                                console.log('[InfoBarSettings] ğŸ”„ å»¶è¿Ÿè§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼Œç¡®ä¿æ•°æ®å·²æ›´æ–°');
                                console.log('[InfoBarSettings] ğŸ“Š æ¶ˆæ¯å†…å®¹é•¿åº¦:', updatedMessage.mes?.length || 0);
                                console.log('[InfoBarSettings] ğŸ” åŒ…å«infobar_data:', updatedMessage.mes?.includes('<infobar_data>') || false);
                                context.eventSource.emit('message_received', updatedMessage);
                            }
                        }, 100); // 100mså»¶è¿Ÿ
                    }
                }
            } else {
                console.log('[InfoBarSettings] ğŸš€ ç›´æ¥è§£ææ¨¡å¼ï¼šç›´æ¥å¤„ç†APIè¿”å›æ•°æ®');

                // ç›´æ¥è§£æAPIè¿”å›çš„æ•°æ®ï¼Œä¸åˆå¹¶åˆ°AIæ¶ˆæ¯
                await this.directParseAPIResult(resultText);
            }

            console.log('[InfoBarSettings] âœ… APIç»“æœå¤„ç†å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†APIç»“æœå¤±è´¥:', error);
        }
    }

    /**
     * ç›´æ¥è§£æAPIç»“æœï¼ˆä¸åˆå¹¶åˆ°AIæ¶ˆæ¯ï¼‰
     */
    async directParseAPIResult(resultText) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç›´æ¥è§£æAPIç»“æœ...');

            // è·å–æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (!smartPromptSystem || !smartPromptSystem.dataParser) {
                console.error('[InfoBarSettings] âŒ æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿæˆ–æ•°æ®è§£æå™¨æœªæ‰¾åˆ°');
                return;
            }

            // ç›´æ¥ä½¿ç”¨æ•°æ®è§£æå™¨è§£æAPIè¿”å›çš„æ•°æ®
            const parsedData = await smartPromptSystem.dataParser.parseAIResponse(resultText);

            if (parsedData) {
                // ğŸ†• ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—æ•°æ®é¡¹æ•°é‡
                const dataCount = parsedData.__operations?.length || 
                                 parsedData.operations?.length || 
                                 Object.keys(parsedData.panels || {}).length || 
                                 0;
                console.log('[InfoBarSettings] âœ… ç›´æ¥è§£ææˆåŠŸï¼Œæ•°æ®é¡¹æ•°é‡:', dataCount);
                console.log('[InfoBarSettings] ğŸ“Š è§£ææ•°æ®æ ¼å¼:', parsedData.__format || parsedData.format || 'unknown');

                // æ›´æ–°æ•°æ®åˆ°æ•°æ®æ ¸å¿ƒ
                await smartPromptSystem.updateDataCore(parsedData);

                // è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶
                if (smartPromptSystem.eventSystem) {
                    console.log('[InfoBarSettings] ğŸ“¡ è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶...');

                    // è§¦å‘æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿçš„æ•°æ®æ›´æ–°äº‹ä»¶
                    smartPromptSystem.eventSystem.emit('smart-prompt:data-updated', {
                        data: parsedData,
                        timestamp: Date.now(),
                        source: 'direct-api-parse' // æ ‡è®°æ•°æ®æ¥æº
                    });

                    // è§¦å‘ä¿¡æ¯æ æ¸²æŸ“å™¨çš„æ•°æ®æ›´æ–°äº‹ä»¶
                    smartPromptSystem.eventSystem.emit('data:updated', {
                        data: parsedData,
                        timestamp: Date.now(),
                        source: 'direct-api-parse' // æ ‡è®°æ•°æ®æ¥æº
                    });

                    console.log('[InfoBarSettings] âœ… æ•°æ®æ›´æ–°äº‹ä»¶å·²è§¦å‘');
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ äº‹ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œæ— æ³•è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶');
                }

                console.log('[InfoBarSettings] âœ… ç›´æ¥è§£æå’Œæ•°æ®æ›´æ–°å®Œæˆ');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ ç›´æ¥è§£ææœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç›´æ¥è§£æAPIç»“æœå¤±è´¥:', error);
        }
    }

    /**
     * å°†infobar_dataè¿½åŠ åˆ°æœ€æ–°çš„AIæ¶ˆæ¯ä¸­
     */
    async appendInfobarDataToLatestMessage(infobarData) {
        try {
            console.log('[InfoBarSettings] ğŸ“ å°†infobar_dataè¿½åŠ åˆ°æœ€æ–°æ¶ˆæ¯...');

            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ¶ˆæ¯');
                return false;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const lastMessage = context.chat[context.chat.length - 1];
            if (!lastMessage || lastMessage.is_user) {
                console.warn('[InfoBarSettings] âš ï¸ æœ€æ–°æ¶ˆæ¯ä¸æ˜¯AIæ¶ˆæ¯');
                return false;
            }

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ç»åŒ…å«è‡ªå®šä¹‰APIæ•°æ®æ ‡ç­¾ï¼Œå¦‚æœæœ‰åˆ™æ›¿æ¢
            if (lastMessage.mes && (lastMessage.mes.includes('<infobar_data>') || lastMessage.mes.includes('<aiThinkProcess>'))) {
                console.log('[InfoBarSettings] â„¹ï¸ æ¶ˆæ¯å·²åŒ…å«APIæ•°æ®æ ‡ç­¾ï¼Œæ›¿æ¢ç°æœ‰å†…å®¹');
                // ç§»é™¤ç°æœ‰çš„APIæ•°æ®æ ‡ç­¾å†…å®¹
                lastMessage.mes = lastMessage.mes
                    .replace(/<infobar_data>[\s\S]*?<\/infobar_data>/gi, '')
                    .replace(/<aiThinkProcess>[\s\S]*?<\/aiThinkProcess>/gi, '')
                    .trim();
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥å°†å®Œæ•´çš„APIè¿”å›æ•°æ®è¿½åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œä¸è¿›è¡Œæ‹†åˆ†
            // è‡ªå®šä¹‰APIè¿”å›çš„æ˜¯ä¸€æ¡å®Œæ•´çš„å“åº”ï¼ŒåŒ…å« <aiThinkProcess> å’Œ <infobar_data>
            // åº”è¯¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œè¯­ä¹‰è¿è´¯æ€§
            if (infobarData && infobarData.trim()) {
                console.log('[InfoBarSettings] ğŸ“ è¿½åŠ å®Œæ•´çš„APIè¿”å›æ•°æ®åˆ°æ¶ˆæ¯');
                lastMessage.mes = lastMessage.mes.trim() + '\n\n' + infobarData.trim();
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIè¿”å›æ•°æ®ä¸ºç©º');
                return false;
            }

            // ä¿å­˜èŠå¤©æ•°æ®
            if (context.saveChat) {
                await context.saveChat();
                console.log('[InfoBarSettings] ğŸ’¾ èŠå¤©æ•°æ®å·²ä¿å­˜');
            }

            console.log('[InfoBarSettings] âœ… infobar_dataå·²æˆåŠŸè¿½åŠ åˆ°æ¶ˆæ¯');
            return true;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿½åŠ infobar_dataåˆ°æ¶ˆæ¯å¤±è´¥:', error);
            return false;
        }
    }

    // æ³¨é‡Šï¼šextractAndMergeAPIResult å‡½æ•°å·²ç§»é™¤
    // åŸå› ï¼šè‡ªå®šä¹‰APIè¿”å›çš„æ˜¯å®Œæ•´å“åº”æ•°æ®ï¼Œä¸åº”è¯¥äººä¸ºæ‹†åˆ† <aiThinkProcess> å’Œ <infobar_data>
    // æ–°çš„å¤„ç†é€»è¾‘ç›´æ¥å°†å®Œæ•´æ•°æ®è¿½åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œè¯­ä¹‰è¿è´¯æ€§

    /**
     * è·å–APIæä¾›å•†
     */
    getAPIProvider() {
        const context = SillyTavern.getContext();
        const extensionSettings = context.extensionSettings;
        return extensionSettings['Information bar integration tool']?.apiConfig?.provider || 'unknown';
    }

    /**
     * è·å–APIæ¨¡å‹
     */
    getAPIModel() {
        const context = SillyTavern.getContext();
        const extensionSettings = context.extensionSettings;
        return extensionSettings['Information bar integration tool']?.apiConfig?.model || 'unknown';
    }

    /**
     * æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
     */
    showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span class="notification-icon">${type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸'}</span>
            <span class="notification-text">${message}</span>
        `;

        // æ·»åŠ æ ·å¼
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#fee2e2' : type === 'success' ? '#dcfce7' : '#dbeafe'};
            color: ${type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#2563eb'};
            border: 1px solid ${type === 'error' ? '#fecaca' : type === 'success' ? '#bbf7d0' : '#bfdbfe'};
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            max-width: 400px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    /**
     * åŠ è½½æ€»ç»“è®¾ç½®
     */
    async loadSummarySettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½æ€»ç»“è®¾ç½®...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä»extensionSettings.summarySettingsè¯»å–ä¿å­˜çš„è®¾ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};
            const savedSummarySettings = extensionSettings.summarySettings || {};

            // åˆå¹¶summaryManagerçš„é»˜è®¤è®¾ç½®å’Œä¿å­˜çš„è®¾ç½®
            const settings = {
                ...summaryManager.settings,  // é»˜è®¤å€¼
                ...savedSummarySettings      // ä¿å­˜çš„å€¼ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
            };

            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½çš„æ€»ç»“è®¾ç½®:', settings);

            // åº”ç”¨è®¾ç½®åˆ°UI
            const autoSummaryEnabled = this.modal.querySelector('#content-auto-summary-enabled');
            if (autoSummaryEnabled) {
                autoSummaryEnabled.checked = settings.autoSummaryEnabled || false;
            }

            // ğŸ”§ æ–°å¢ï¼šæ³¨å…¥æ€»ç»“è®¾ç½®
            const injectSummaryEnabled = this.modal.querySelector('#content-inject-summary-enabled');
            if (injectSummaryEnabled) {
                injectSummaryEnabled.checked = settings.injectSummaryEnabled || false;
            }

            // ğŸ†• æ–°å¢ï¼šæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤è®¾ç½®
            const useRegexFilter = this.modal.querySelector('#content-summary-use-regex');
            if (useRegexFilter) {
                useRegexFilter.checked = settings.useRegexFilter !== false; // é»˜è®¤å¯ç”¨
            }

            // ğŸ”§ ä¿®å¤ï¼šNPCè®¾ç½®çš„æ¢å¤ç§»åˆ°äº† initNPCManagementPanelContent() ä¸­
            // å› ä¸ºNPCç®¡ç†é¢æ¿çš„DOMåªæœ‰åœ¨åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾æ—¶æ‰ä¼šè¢«åˆ›å»º

            const summaryFloorCount = this.modal.querySelector('#content-summary-floor-count');
            if (summaryFloorCount) {
                summaryFloorCount.value = settings.summaryFloorCount || 20;
            }

            const summaryType = this.modal.querySelector('#content-summary-type');
            if (summaryType) {
                summaryType.value = settings.summaryType || 'small';
                this.handleSummaryTypeChange(summaryType.value);
            }

            const summaryWordCount = this.modal.querySelector('#content-summary-word-count');
            if (summaryWordCount) {
                summaryWordCount.value = settings.summaryWordCount || 300;
            }

            // ğŸš€ æ–°å¢ï¼šAIè®°å¿†æ€»ç»“è®¾ç½®
            const aiMemoryEnabled = this.modal.querySelector('#content-ai-memory-enabled');
            if (aiMemoryEnabled && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiMemoryEnabled.checked = aiSettings.enabled || false;
                this.handleAIMemoryEnabledChange(aiMemoryEnabled.checked);
            }

            const aiMessageLevelSummary = this.modal.querySelector('#content-ai-message-level-summary');
            if (aiMessageLevelSummary && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiMessageLevelSummary.checked = aiSettings.messageLevelSummary || false;
            }

            const aiImportanceThreshold = this.modal.querySelector('#content-ai-importance-threshold');
            const aiImportanceValue = this.modal.querySelector('#content-ai-importance-value');
            if (aiImportanceThreshold && aiImportanceValue && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiImportanceThreshold.value = aiSettings.importanceThreshold || 0.6;
                aiImportanceValue.textContent = `${Math.round((aiSettings.importanceThreshold || 0.6) * 100)}%`;
            }

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–è®°å¿†æ£€ç´¢è®¾ç½®
            const vectorizedMemoryEnabled = this.modal.querySelector('#content-vectorized-memory-enabled');
            if (vectorizedMemoryEnabled && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                vectorizedMemoryEnabled.checked = vectorSettings.enabled || false;
                this.handleVectorizedMemoryEnabledChange(vectorizedMemoryEnabled.checked);
            }

            const vectorEngineSelect = this.modal.querySelector('#content-vector-engine');
            if (vectorEngineSelect && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                vectorEngineSelect.value = vectorSettings.vectorEngine || 'transformers';
            }

            const similarityThreshold = this.modal.querySelector('#content-similarity-threshold');
            const similarityValue = this.modal.querySelector('#content-similarity-value');
            if (similarityThreshold && similarityValue && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                similarityThreshold.value = vectorSettings.similarityThreshold || 0.7;
                similarityValue.textContent = `${Math.round((vectorSettings.similarityThreshold || 0.7) * 100)}%`;
            }

            const maxSearchResults = this.modal.querySelector('#content-max-search-results');
            if (maxSearchResults && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                maxSearchResults.value = vectorSettings.maxResults || 10;
            }

            // ğŸ§  æ–°å¢ï¼šæ·±åº¦è®°å¿†ç®¡ç†è®¾ç½®
            const deepMemoryEnabled = this.modal.querySelector('#content-deep-memory-enabled');
            if (deepMemoryEnabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    deepMemoryEnabled.checked = deepMemorySettings.enabled || false;
                    this.handleDeepMemoryEnabledChange(deepMemoryEnabled.checked);
                }
            }

            const autoMemoryMigration = this.modal.querySelector('#content-auto-memory-migration');
            if (autoMemoryMigration) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    autoMemoryMigration.checked = deepMemorySettings.autoMemoryMigration || false;
                }
            }

            const memoryImportanceThreshold = this.modal.querySelector('#content-memory-importance-threshold');
            const memoryImportanceValue = this.modal.querySelector('#content-memory-importance-value');
            if (memoryImportanceThreshold && memoryImportanceValue) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    memoryImportanceThreshold.value = deepMemorySettings.shortTermToLongTermThreshold || 0.6;
                    memoryImportanceValue.textContent = `${Math.round((deepMemorySettings.shortTermToLongTermThreshold || 0.6) * 100)}%`;
                }
            }

            const memoryConflictResolution = this.modal.querySelector('#content-memory-conflict-resolution');
            if (memoryConflictResolution) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    memoryConflictResolution.checked = deepMemorySettings.memoryConflictResolution || false;
                }
            }

            // è®°å¿†å®¹é‡è®¾ç½®
            const capacityInputs = {
                'content-sensory-capacity': 'sensoryMemoryCapacity',
                'content-short-term-capacity': 'shortTermMemoryCapacity',
                'content-long-term-capacity': 'longTermMemoryCapacity',
                'content-deep-archive-capacity': 'deepArchiveCapacity'
            };

            Object.entries(capacityInputs).forEach(([inputId, settingKey]) => {
                const input = this.modal.querySelector(`#${inputId}`);
                if (input) {
                    const infoBarTool = window.SillyTavernInfobar;
                    const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                    if (deepMemoryManager) {
                        const deepMemorySettings = deepMemoryManager.settings;
                        input.value = deepMemorySettings[settingKey] || input.defaultValue;
                    }
                }
            });

            // ğŸ¤– æ–°å¢ï¼šæ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const intelligentClassifierEnabled = this.modal.querySelector('#content-intelligent-classifier-enabled');
            if (intelligentClassifierEnabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    intelligentClassifierEnabled.checked = classifierSettings.enabled || false;
                    this.handleIntelligentClassifierEnabledChange(intelligentClassifierEnabled.checked);
                }
            }

            const semanticClustering = this.modal.querySelector('#content-semantic-clustering');
            if (semanticClustering) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    semanticClustering.checked = classifierSettings.semanticClustering || false;
                }
            }

            const temporalPatternRecognition = this.modal.querySelector('#content-temporal-pattern-recognition');
            if (temporalPatternRecognition) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    temporalPatternRecognition.checked = classifierSettings.temporalPatternRecognition || false;
                }
            }

            const importancePrediction = this.modal.querySelector('#content-importance-prediction');
            if (importancePrediction) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    importancePrediction.checked = classifierSettings.importancePrediction || false;
                }
            }

            const classificationConfidenceThreshold = this.modal.querySelector('#content-classification-confidence-threshold');
            const classificationConfidenceValue = this.modal.querySelector('#content-classification-confidence-value');
            if (classificationConfidenceThreshold && classificationConfidenceValue) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    classificationConfidenceThreshold.value = classifierSettings.classificationConfidenceThreshold || 0.7;
                    classificationConfidenceValue.textContent = `${Math.round((classifierSettings.classificationConfidenceThreshold || 0.7) * 100)}%`;
                }
            }

            const adaptiveLearning = this.modal.querySelector('#content-adaptive-learning');
            if (adaptiveLearning) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    adaptiveLearning.checked = classifierSettings.adaptationEnabled || false;
                }
            }

            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            const autoHideEnabled = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabled) {
                autoHideEnabled.checked = settings.autoHideEnabled || false;
                this.handleAutoHideEnabledChange(autoHideEnabled.checked);
            }

            const autoHideThreshold = this.modal.querySelector('#content-auto-hide-threshold');
            if (autoHideThreshold) {
                autoHideThreshold.value = settings.autoHideThreshold || 30;
            }

            // ğŸ“š æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ æŒä¹…åŒ–è®¾ç½®å›å¡«
            const wbAutoEl = this.modal.querySelector('#worldbook-auto-upload');
            if (wbAutoEl) {
                wbAutoEl.checked = settings.autoUploadNewSummary === true; // ğŸ”§ ä¿®å¤ï¼šæ˜ç¡®æ£€æŸ¥trueå€¼
                console.log('[InfoBarSettings] ğŸ“š è‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“è®¾ç½®å·²åŠ è½½:', wbAutoEl.checked);
            }

            const entryFormatEl = this.modal.querySelector('#worldbook-entry-format');
            const customRow = this.modal.querySelector('#worldbook-custom-name-row');
            if (entryFormatEl) {
                entryFormatEl.value = settings.worldBookEntryFormat || 'auto';
                if (customRow) customRow.style.display = (entryFormatEl.value === 'custom') ? 'block' : 'none';
            }

            const customNameEl = this.modal.querySelector('#worldbook-custom-name');
            if (customNameEl) {
                customNameEl.value = settings.worldBookCustomEntryName || '';
            }

            const addTsEl = this.modal.querySelector('#worldbook-add-timestamp');
            if (addTsEl) {
                addTsEl.checked = settings.worldBookAddTimestamp !== false;
            }

            const useTagsEl = this.modal.querySelector('#worldbook-use-tags');
            if (useTagsEl) {
                useTagsEl.checked = settings.worldBookUseContentTags !== false;
            }

            // ğŸ†• åŠ è½½ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–è®¾ç½®
            const vectorizeSummaryEnabled = this.modal.querySelector('#content-vectorize-summary-enabled');
            if (vectorizeSummaryEnabled) {
                vectorizeSummaryEnabled.checked = settings.vectorizeSummaryEnabled || false;
            }

            // ğŸ†• æ–°å¢ï¼šåŠ è½½è‡ªå®šä¹‰æç¤ºè¯è®¾ç½®
            const useCustomPrompt = this.modal.querySelector('#content-use-custom-prompt');
            if (useCustomPrompt) {
                useCustomPrompt.checked = settings.useCustomPrompt || false;
                this.handleUseCustomPromptChange(useCustomPrompt.checked);
            }

            const customPrompt = this.modal.querySelector('#content-custom-prompt');
            if (customPrompt) {
                customPrompt.value = settings.customPrompt || '';
                this.updateSummaryCustomPromptStats();
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“è®¾ç½®åŠ è½½å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ€»ç»“è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½æ€»ç»“å†å²
     */
    async loadSummaryHistory() {
        try {
            console.log('[InfoBarSettings] ğŸ“š åŠ è½½æ€»ç»“å†å²...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            const summaryHistory = await summaryManager.getSummaryHistory();
            this.renderSummaryHistory(summaryHistory);

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²åŠ è½½å®Œæˆï¼Œå…±', summaryHistory.length, 'æ¡è®°å½•');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ¸²æŸ“æ€»ç»“å†å²
     */
    renderSummaryHistory(summaryHistory) {
        try {
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            if (!historySelect) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
            historySelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ€»ç»“è®°å½•</option>';

            if (!summaryHistory || summaryHistory.length === 0) {
                // æ·»åŠ ç©ºçŠ¶æ€é€‰é¡¹
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'æš‚æ— æ€»ç»“è®°å½•ï¼Œè¯·å…ˆç”Ÿæˆæ€»ç»“';
                emptyOption.disabled = true;
                historySelect.appendChild(emptyOption);
                return;
            }

            // æ·»åŠ æ€»ç»“è®°å½•é€‰é¡¹
            summaryHistory.forEach(summary => {
                const option = document.createElement('option');
                option.value = summary.id;
                option.textContent = this.formatSummarySelectOption(summary);
                historySelect.appendChild(option);
            });

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²é€‰æ‹©æ¡†æ¸²æŸ“å®Œæˆï¼Œå…±', summaryHistory.length, 'æ¡è®°å½•');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸²æŸ“æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“æ ‡é¢˜
     */
    formatSummaryTitle(summary) {
        const typeMap = {
            'small': 'å°æ€»ç»“',
            'large': 'å¤§æ€»ç»“',
            'manual': 'æ‰‹åŠ¨æ€»ç»“',
            'auto': 'è‡ªåŠ¨æ€»ç»“'
        };

        const typeText = typeMap[summary.type] || 'æ€»ç»“';
        const messageRange = summary.messageRange ?
            ` (${summary.messageRange.start}-${summary.messageRange.end})` : '';

        return `${typeText}${messageRange}`;
    }

    /**
     * ğŸš€ æ ¼å¼åŒ–å¢å¼ºçš„æ€»ç»“æ ‡é¢˜ï¼ˆæ”¯æŒAIè®°å¿†æ€»ç»“ï¼‰
     */
    formatEnhancedSummaryTitle(summary) {
        // å¦‚æœæ˜¯AIè®°å¿†æ€»ç»“
        if (summary.source === 'ai_memory_summarizer' || summary.type === 'ai_memory') {
            return summary.title || `AIè®°å¿†æ€»ç»“ (${summary.messageCount || 0}æ¡æ¶ˆæ¯)`;
        }

        // ä¼ ç»Ÿæ€»ç»“
        const typeMap = {
            'small': 'å°æ€»ç»“',
            'large': 'å¤§æ€»ç»“',
            'manual': 'æ‰‹åŠ¨æ€»ç»“',
            'auto': 'è‡ªåŠ¨æ€»ç»“'
        };

        const typeText = typeMap[summary.type] || 'æ€»ç»“';
        const messageRange = summary.messageRange ?
            ` (${summary.messageRange.start}-${summary.messageRange.end})` : '';

        return `${typeText}${messageRange}`;
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“é€‰æ‹©æ¡†é€‰é¡¹
     * æ ¼å¼ï¼š[æ€»ç»“ç±»å‹] æ€»ç»“æ ‡é¢˜ (æ¥¼å±‚X-Y) - æ—¶é—´
     */
    formatSummarySelectOption(summary) {
        try {
            // æ€»ç»“ç±»å‹
            const typeMap = {
                'small': 'å°æ€»ç»“',
                'large': 'å¤§æ€»ç»“',
                'manual': 'æ‰‹åŠ¨æ€»ç»“',
                'auto': 'è‡ªåŠ¨æ€»ç»“'
            };
            const typeText = typeMap[summary.type] || 'æ€»ç»“';

            // æ€»ç»“æ ‡é¢˜ï¼ˆä½¿ç”¨å†…å®¹çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼‰
            let title = 'æ— æ ‡é¢˜';
            if (summary.content && summary.content.trim()) {
                title = summary.content.trim().substring(0, 20);
                if (summary.content.length > 20) {
                    title += '...';
                }
            }

            // æ¥¼å±‚ä¿¡æ¯
            let floorInfo = '';
            if (summary.messageRange) {
                const start = summary.messageRange.start + 1; // è½¬æ¢ä¸º1åŸºç´¢å¼•
                const end = summary.messageRange.end + 1;
                floorInfo = ` (æ¥¼å±‚${start}-${end})`;
            }

            // æ—¶é—´ä¿¡æ¯
            const timeText = this.formatShortDate(summary.timestamp);

            // ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ çŠ¶æ€
            let uploadStatus = '';
            if (summary.worldBookUpload) {
                uploadStatus = ' ğŸ“š';
            }

            // ç»„åˆæ ¼å¼ï¼š[æ€»ç»“ç±»å‹] æ€»ç»“æ ‡é¢˜ (æ¥¼å±‚X-Y) - æ—¶é—´ [ä¸Šä¼ çŠ¶æ€]
            return `[${typeText}] ${title}${floorInfo} - ${timeText}${uploadStatus}`;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ ¼å¼åŒ–æ€»ç»“é€‰æ‹©æ¡†é€‰é¡¹å¤±è´¥:', error);
            return 'æ€»ç»“è®°å½•';
        }
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“é¢„è§ˆ
     */
    formatSummaryPreview(content) {
        if (!content) return 'æš‚æ— å†…å®¹';
        return content.length > 100 ? content.substring(0, 100) + '...' : content;
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    /**
     * æ ¼å¼åŒ–çŸ­æ—¥æœŸï¼ˆç”¨äºé€‰æ‹©æ¡†ï¼‰
     */
    formatShortDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        if (targetDate.getTime() === today.getTime()) {
            // ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            return date.toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        } else {
            // å…¶ä»–æ—¥æœŸï¼Œæ˜¾ç¤ºæœˆæ—¥å’Œæ—¶é—´
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }

    /**
     * æ˜¾ç¤ºæ€»ç»“å†…å®¹
     */
    async showSummaryContent(summaryId) {
        try {
            console.log('[InfoBarSettings] ğŸ“„ æ˜¾ç¤ºæ€»ç»“å†…å®¹:', summaryId);

            if (!summaryId) {
                // éšè—å†…å®¹åŒºåŸŸ
                this.hideSummaryContent();
                return;
            }

            // è·å–æ€»ç»“å†å²
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¢å¼ºçš„æ€»ç»“å†å²è·å–æ–¹æ³•ï¼Œæ”¯æŒAIè®°å¿†æ€»ç»“
            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            const summary = allSummaries.find(s => s.id === summaryId);

            if (!summary) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ€»ç»“è®°å½•:', summaryId, 'æ€»ç»“æ•°é‡:', allSummaries.length);
                // éšè—å†…å®¹åŒºåŸŸï¼Œå› ä¸ºè¯¥æ€»ç»“ä¸å­˜åœ¨
                this.hideSummaryContent();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“‹ æ‰¾åˆ°æ€»ç»“è®°å½•:', {
                id: summary.id,
                type: summary.type,
                source: summary.source,
                hasContent: !!summary.content
            });

            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            const contentSection = this.modal.querySelector('#content-summary-content-section');
            const titleElement = this.modal.querySelector('#content-summary-title');
            const dateElement = this.modal.querySelector('#content-summary-date');
            const bodyElement = this.modal.querySelector('#content-summary-content-body');

            if (contentSection && titleElement && dateElement && bodyElement) {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¢å¼ºçš„æ ‡é¢˜æ ¼å¼åŒ–æ–¹æ³•
                titleElement.textContent = this.formatEnhancedSummaryTitle(summary);
                dateElement.textContent = this.formatDate(summary.timestamp);
                bodyElement.textContent = summary.content || 'æš‚æ— å†…å®¹';

                contentSection.style.display = 'block';

                console.log('[InfoBarSettings] âœ… æ€»ç»“å†…å®¹å·²æ˜¾ç¤º');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å†…å®¹æ˜¾ç¤ºå…ƒç´ ');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ€»ç»“å†…å®¹å¤±è´¥:', error);
        }
    }
    /**
     * ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶
     */
    bindSummaryPanelEvents() {
        try {
            console.log('[InfoBarSettings] ğŸ”— ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶...');

            // ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (this._summaryEventsbound) {
                console.log('[InfoBarSettings] âš ï¸ æ€»ç»“é¢æ¿äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }

            // ğŸ†• æ€»ç»“æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            const summaryModeTabs = this.modal.querySelectorAll('.summary-mode-tab');
            summaryModeTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    this.handleSummaryModeChange(mode);
                });
            });

            // æ€»ç»“ç±»å‹å˜åŒ–äº‹ä»¶
            const summaryTypeSelect = this.modal.querySelector('#content-summary-type');
            if (summaryTypeSelect) {
                summaryTypeSelect.addEventListener('change', (e) => {
                    this.handleSummaryTypeChange(e.target.value);
                });
            }

            // ğŸ†• æ–°å¢ï¼šæ€»ç»“èŒƒå›´æ¨¡å¼å˜åŒ–äº‹ä»¶
            const summaryRangeModeSelect = this.modal.querySelector('#content-summary-range-mode');
            if (summaryRangeModeSelect) {
                summaryRangeModeSelect.addEventListener('change', (e) => {
                    this.handleSummaryRangeModeChange(e.target.value);
                });
            }

            // æ‰‹åŠ¨æ€»ç»“æŒ‰é’®äº‹ä»¶
            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.addEventListener('click', () => {
                    this.triggerManualSummary();
                });
            }

            // ğŸ”§ åˆ é™¤ï¼šä¿å­˜è®¾ç½®æŒ‰é’®å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸»ä¿å­˜æŒ‰é’®

            // ğŸ†• æ–°å¢ï¼šå‘é‡åŒ–è‡ªåŠ¨éšè—å¤é€‰æ¡†äº‹ä»¶
            const vectorizedAutoHideCheckbox = this.modal.querySelector('#vectorized-auto-hide-enabled');
            if (vectorizedAutoHideCheckbox) {
                vectorizedAutoHideCheckbox.addEventListener('change', (e) => {
                    const keepRecentRow = this.modal.querySelector('#vectorized-keep-recent-row');
                    if (keepRecentRow) {
                        keepRecentRow.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            }

            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshBtn = this.modal.querySelector('#header-refresh-summary-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadSummaryHistory();
                });
            }

            // æ€»ç»“å†å²é€‰æ‹©æ¡†äº‹ä»¶
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            if (historySelect) {
                historySelect.addEventListener('change', (e) => {
                    const summaryId = e.target.value;
                    this.showSummaryContent(summaryId);
                });
            }

            // ğŸš€ æ–°å¢ï¼šä¸Šä¼ åˆ°ä¸–ç•Œä¹¦æŒ‰é’®äº‹ä»¶
            const uploadToWorldBookBtn = this.modal.querySelector('#content-upload-to-worldbook-btn');
            if (uploadToWorldBookBtn && historySelect) {
                uploadToWorldBookBtn.addEventListener('click', async () => {
                    await this.handleUploadSummaryToWorldBook();
                });
            }

            // åˆ é™¤å½“å‰é€‰æ‹©çš„æ€»ç»“
            const deleteBtn = this.modal.querySelector('#content-delete-summary-btn');
            if (deleteBtn && historySelect) {
                deleteBtn.addEventListener('click', async () => {
                    try {
                        const summaryId = historySelect.value;
                        if (!summaryId) {
                            this.showNotification('è¯·å…ˆåœ¨é€‰æ‹©æ¡†ä¸­é€‰æ‹©ä¸€æ¡æ€»ç»“è®°å½•', 'info');
                            return;
                        }
                        const infoBarTool = window.SillyTavernInfobar;
                        const summaryManager = infoBarTool?.modules?.summaryManager;
                        if (!summaryManager) return;
                        const ok = await summaryManager.deleteSummaryRecord(summaryId);
                        if (ok) {
                            this.showNotification('âœ… å·²åˆ é™¤è¯¥æ€»ç»“', 'success');
                            // åˆ·æ–°å†å²
                            await this.loadSummaryHistory();
                            // æ¸…ç©ºé€‰æ‹©ä¸å†…å®¹
                            historySelect.value = '';
                            this.hideSummaryContent();
                        } else {
                            this.showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
                        }
                    } catch (err) {
                        console.error('[InfoBarSettings] âŒ åˆ é™¤æ€»ç»“å¤±è´¥:', err);
                        this.showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
                    }
                });
            }

            // ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶
            this.bindWorldBookUploadEvents();

            // ğŸ§  è®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶å¤„ç†å™¨
            this.bindMemoryEnhancementEvents();

            // ğŸš€ æ–°å¢ï¼šAIè®°å¿†æ€»ç»“å¤é€‰æ¡†äº‹ä»¶ï¼ˆæ€»ç»“é¢æ¿ä¸­çš„æ—§ç‰ˆæœ¬ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
            const aiMemoryEnabledCheckbox = this.modal.querySelector('#content-ai-memory-enabled');
            if (aiMemoryEnabledCheckbox) {
                aiMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleAIMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸš€ æ–°å¢ï¼šæ¶ˆæ¯çº§åˆ«æ€»ç»“å¤é€‰æ¡†äº‹ä»¶
            const aiMessageLevelCheckbox = this.modal.querySelector('#content-ai-message-level-summary');
            if (aiMessageLevelCheckbox) {
                aiMessageLevelCheckbox.addEventListener('change', (e) => {
                    this.handleAIMessageLevelChange(e.target.checked);
                });
            }

            // ğŸš€ æ–°å¢ï¼šé‡è¦æ€§é˜ˆå€¼æ»‘å—äº‹ä»¶
            const aiImportanceThreshold = this.modal.querySelector('#content-ai-importance-threshold');
            if (aiImportanceThreshold) {
                aiImportanceThreshold.addEventListener('input', (e) => {
                    this.handleAIImportanceThresholdChange(e.target.value);
                });
            }

            // ğŸš€ æ–°å¢ï¼šæ€»ç»“ç­›é€‰æ ‡ç­¾äº‹ä»¶
            const filterTabs = this.modal.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.handleFilterTabClick(e.target.dataset.filter);
                });
            });

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–è®°å¿†æ£€ç´¢å¤é€‰æ¡†äº‹ä»¶
            const vectorizedMemoryEnabledCheckbox = this.modal.querySelector('#content-vectorized-memory-enabled');
            if (vectorizedMemoryEnabledCheckbox) {
                vectorizedMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleVectorizedMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–å¼•æ“é€‰æ‹©äº‹ä»¶
            const vectorEngineSelect = this.modal.querySelector('#content-vector-engine');
            if (vectorEngineSelect) {
                vectorEngineSelect.addEventListener('change', (e) => {
                    this.handleVectorEngineChange(e.target.value);
                });
            }

            // ğŸ” æ–°å¢ï¼šç›¸ä¼¼åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
            const similarityThreshold = this.modal.querySelector('#content-similarity-threshold');
            if (similarityThreshold) {
                similarityThreshold.addEventListener('input', (e) => {
                    this.handleSimilarityThresholdChange(e.target.value);
                });
            }

            // ğŸ” æ–°å¢ï¼šæœ€å¤§æœç´¢ç»“æœæ•°é‡äº‹ä»¶
            const maxSearchResults = this.modal.querySelector('#content-max-search-results');
            if (maxSearchResults) {
                maxSearchResults.addEventListener('input', (e) => {
                    this.handleMaxSearchResultsChange(e.target.value);
                });
            }

            // ğŸ§  æ–°å¢ï¼šæ·±åº¦è®°å¿†ç®¡ç†å¤é€‰æ¡†äº‹ä»¶
            const deepMemoryEnabledCheckbox = this.modal.querySelector('#content-deep-memory-enabled');
            if (deepMemoryEnabledCheckbox) {
                deepMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleDeepMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè‡ªåŠ¨è®°å¿†è¿ç§»å¤é€‰æ¡†äº‹ä»¶
            const autoMemoryMigrationCheckbox = this.modal.querySelector('#content-auto-memory-migration');
            if (autoMemoryMigrationCheckbox) {
                autoMemoryMigrationCheckbox.addEventListener('change', (e) => {
                    this.handleAutoMemoryMigrationChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†é‡è¦æ€§é˜ˆå€¼æ»‘å—äº‹ä»¶
            const memoryImportanceThreshold = this.modal.querySelector('#content-memory-importance-threshold');
            if (memoryImportanceThreshold) {
                memoryImportanceThreshold.addEventListener('input', (e) => {
                    this.handleMemoryImportanceThresholdChange(e.target.value);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å†²çªè§£å†³å¤é€‰æ¡†äº‹ä»¶
            const memoryConflictResolutionCheckbox = this.modal.querySelector('#content-memory-conflict-resolution');
            if (memoryConflictResolutionCheckbox) {
                memoryConflictResolutionCheckbox.addEventListener('change', (e) => {
                    this.handleMemoryConflictResolutionChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å®¹é‡è®¾ç½®äº‹ä»¶
            const capacityInputs = [
                'content-sensory-capacity',
                'content-short-term-capacity',
                'content-long-term-capacity',
                'content-deep-archive-capacity'
            ];

            capacityInputs.forEach(inputId => {
                const input = this.modal.querySelector(`#${inputId}`);
                if (input) {
                    input.addEventListener('input', (e) => {
                        this.handleMemoryCapacityChange(inputId, e.target.value);
                    });
                }
            });

            // ğŸ¤– æ–°å¢ï¼šæ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¤é€‰æ¡†äº‹ä»¶
            const intelligentClassifierEnabledCheckbox = this.modal.querySelector('#content-intelligent-classifier-enabled');
            if (intelligentClassifierEnabledCheckbox) {
                intelligentClassifierEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleIntelligentClassifierEnabledChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šè¯­ä¹‰èšç±»åˆ†æå¤é€‰æ¡†äº‹ä»¶
            const semanticClusteringCheckbox = this.modal.querySelector('#content-semantic-clustering');
            if (semanticClusteringCheckbox) {
                semanticClusteringCheckbox.addEventListener('change', (e) => {
                    this.handleSemanticClusteringChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šæ—¶åºæ¨¡å¼è¯†åˆ«å¤é€‰æ¡†äº‹ä»¶
            const temporalPatternRecognitionCheckbox = this.modal.querySelector('#content-temporal-pattern-recognition');
            if (temporalPatternRecognitionCheckbox) {
                temporalPatternRecognitionCheckbox.addEventListener('change', (e) => {
                    this.handleTemporalPatternRecognitionChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šé‡è¦æ€§é¢„æµ‹å¤é€‰æ¡†äº‹ä»¶
            const importancePredictionCheckbox = this.modal.querySelector('#content-importance-prediction');
            if (importancePredictionCheckbox) {
                importancePredictionCheckbox.addEventListener('change', (e) => {
                    this.handleImportancePredictionChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šåˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
            const classificationConfidenceThreshold = this.modal.querySelector('#content-classification-confidence-threshold');
            if (classificationConfidenceThreshold) {
                classificationConfidenceThreshold.addEventListener('input', (e) => {
                    this.handleClassificationConfidenceThresholdChange(e.target.value);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šè‡ªé€‚åº”å­¦ä¹ å¤é€‰æ¡†äº‹ä»¶
            const adaptiveLearningCheckbox = this.modal.querySelector('#content-adaptive-learning');
            if (adaptiveLearningCheckbox) {
                adaptiveLearningCheckbox.addEventListener('change', (e) => {
                    this.handleAdaptiveLearningChange(e.target.checked);
                });
            }

            // ğŸ†• æ–°å¢ï¼šè‡ªå®šä¹‰æç¤ºè¯å¤é€‰æ¡†äº‹ä»¶
            const useCustomPromptCheckbox = this.modal.querySelector('#content-use-custom-prompt');
            if (useCustomPromptCheckbox) {
                useCustomPromptCheckbox.addEventListener('change', (e) => {
                    this.handleUseCustomPromptChange(e.target.checked);
                });
            }

            // ğŸ†• æ–°å¢ï¼šè‡ªå®šä¹‰æç¤ºè¯è¾“å…¥äº‹ä»¶ï¼ˆç»Ÿè®¡å­—æ•°ï¼‰
            const customPromptTextarea = this.modal.querySelector('#content-custom-prompt');
            if (customPromptTextarea) {
                customPromptTextarea.addEventListener('input', () => {
                    this.updateSummaryCustomPromptStats();
                });
                customPromptTextarea.addEventListener('keyup', () => {
                    this.updateSummaryCustomPromptStats();
                });
            }

            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚å¤é€‰æ¡†äº‹ä»¶
            const autoHideEnabledCheckbox = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabledCheckbox) {
                autoHideEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleAutoHideEnabledChange(e.target.checked);
                });
            }

            // ğŸ†• ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–å¤é€‰æ¡†äº‹ä»¶ï¼ˆå·²ç§»é™¤æ¥¼å±‚é—´éš”UIï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†ï¼‰

            // ğŸ†• æ‰‹åŠ¨å‘é‡åŒ–æŒ‰é’®äº‹ä»¶
            const manualVectorizeBtn = this.modal.querySelector('#manual-vectorize-btn');
            if (manualVectorizeBtn) {
                manualVectorizeBtn.addEventListener('click', async () => {
                    await this.handleManualVectorize();
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®äº‹ä»¶ç»‘å®šæ ‡å¿—ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            this._summaryEventsbound = true;

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†æ€»ç»“æ¨¡å¼åˆ‡æ¢
     */
    handleSummaryModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ€»ç»“æ¨¡å¼åˆ‡æ¢:', mode);

            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            const tabs = this.modal.querySelectorAll('.summary-mode-tab');
            tabs.forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                    tab.style.background = 'var(--theme-primary-color, #4CAF50)';
                    tab.style.color = 'white';
                    tab.style.borderColor = 'var(--theme-primary-color, #4CAF50)';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'var(--theme-bg-secondary, #2a2a2a)';
                    tab.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    tab.style.borderColor = 'var(--theme-border-color, #333)';
                }
            });

            // æ›´æ–°æè¿°æ–‡æœ¬
            const description = this.modal.querySelector('.summary-mode-description');
            if (description) {
                if (mode === 'traditional') {
                    description.textContent = 'ä¼ ç»Ÿæ€»ç»“ï¼šä½¿ç”¨è‡ªå®šä¹‰APIç”Ÿæˆå‰§æƒ…æ€»ç»“ | å‘é‡åŒ–æ€»ç»“ï¼šå°†AIè®°å¿†æ€»ç»“å‘é‡åŒ–å­˜å‚¨ï¼Œæ™ºèƒ½æ£€ç´¢';
                } else {
                    description.textContent = 'å‘é‡åŒ–æ€»ç»“ï¼šå°†AIè®°å¿†æ€»ç»“å‘é‡åŒ–å­˜å‚¨ï¼Œæ™ºèƒ½æ£€ç´¢ | ä¼ ç»Ÿæ€»ç»“ï¼šä½¿ç”¨è‡ªå®šä¹‰APIç”Ÿæˆå‰§æƒ…æ€»ç»“';
                }
            }

            // åˆ‡æ¢è®¾ç½®åŒºåŸŸæ˜¾ç¤º
            const traditionalSettings = this.modal.querySelector('.traditional-summary-settings');
            const vectorizedSettings = this.modal.querySelector('.vectorized-summary-settings');

            if (mode === 'traditional') {
                if (traditionalSettings) traditionalSettings.style.display = 'block';
                if (vectorizedSettings) vectorizedSettings.style.display = 'none';
            } else {
                if (traditionalSettings) traditionalSettings.style.display = 'none';
                if (vectorizedSettings) vectorizedSettings.style.display = 'block';

                // ğŸ”§ æ£€æŸ¥AIè®°å¿†æ€»ç»“çŠ¶æ€
                this.checkAIMemorySummaryStatus();

                // ğŸ”§ åŠ è½½å‘é‡åŒ–æ€»ç»“æ•°æ®
                this.loadVectorizedSummaryData();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ€»ç»“æ¨¡å¼åˆ‡æ¢å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†æ€»ç»“ç±»å‹å˜åŒ–
     */
    handleSummaryTypeChange(summaryType) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ€»ç»“ç±»å‹å˜åŒ–:', summaryType);

            const customWordCountRow = this.modal.querySelector('#content-custom-word-count-row');
            if (customWordCountRow) {
                if (summaryType === 'custom') {
                    customWordCountRow.style.display = 'block';
                } else {
                    customWordCountRow.style.display = 'none';
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ€»ç»“ç±»å‹å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ–°å¢ï¼šå¤„ç†æ€»ç»“èŒƒå›´æ¨¡å¼å˜åŒ–
     */
    handleSummaryRangeModeChange(rangeMode) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ€»ç»“èŒƒå›´æ¨¡å¼å˜åŒ–:', rangeMode);

            const customRangeRow = this.modal.querySelector('#content-custom-range-row');
            if (customRangeRow) {
                if (rangeMode === 'custom') {
                    customRangeRow.style.display = 'block';
                } else {
                    customRangeRow.style.display = 'none';
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ€»ç»“èŒƒå›´æ¨¡å¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯å˜åŒ–
     */
    handleUseCustomPromptChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰æç¤ºè¯é…ç½®åŒºåŸŸ
            const customPromptRow = this.modal.querySelector('#content-custom-prompt-row');
            if (customPromptRow) {
                customPromptRow.style.display = enabled ? 'block' : 'none';
                console.log(`[InfoBarSettings] ğŸ“ è‡ªå®šä¹‰æç¤ºè¯é…ç½®åŒºåŸŸ${enabled ? 'æ˜¾ç¤º' : 'éšè—'}`);
            }

            // å¦‚æœå¯ç”¨ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (enabled) {
                this.updateSummaryCustomPromptStats();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ›´æ–°æ€»ç»“è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡ä¿¡æ¯
     */
    updateSummaryCustomPromptStats() {
        try {
            const textarea = this.modal.querySelector('#content-custom-prompt');
            const charCountSpan = this.modal.querySelector('#content-custom-prompt-char-count');
            const lineCountSpan = this.modal.querySelector('#content-custom-prompt-line-count');

            if (!textarea || !charCountSpan || !lineCountSpan) return;

            const text = textarea.value || '';
            const charCount = text.length;
            const lineCount = text.split('\n').length;

            charCountSpan.textContent = charCount;
            lineCountSpan.textContent = lineCount;

            // æ ¹æ®å­—ç¬¦æ•°é‡è®¾ç½®é¢œè‰²æç¤º
            if (charCount > 2000) {
                charCountSpan.style.color = '#ff6b6b'; // çº¢è‰²è­¦å‘Š
            } else if (charCount > 1000) {
                charCountSpan.style.color = '#ffa726'; // æ©™è‰²æé†’
            } else {
                charCountSpan.style.color = ''; // é»˜è®¤é¢œè‰²
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†è‡ªåŠ¨éšè—å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleAutoHideEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨éšè—æ¥¼å±‚å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—é˜ˆå€¼è®¾ç½®
            const thresholdRow = this.modal.querySelector('#content-auto-hide-threshold-row');
            if (thresholdRow) {
                thresholdRow.style.display = enabled ? 'block' : 'none';
            }

            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨éšè—ï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦éšè—æ¥¼å±‚
            if (enabled) {
                this.checkAndExecuteAutoHide();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªåŠ¨éšè—çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }



    /**
     * ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥å¹¶æ‰§è¡Œè‡ªåŠ¨éšè—æ¥¼å±‚
     * å‚è€ƒST-Amily2é¡¹ç›®çš„å®ç°ï¼Œç›´æ¥ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡çš„is_hiddenå±æ€§
     */
    async checkAndExecuteAutoHide() {
        try {
            // è·å–è®¾ç½®
            const summaryManager = window.SillyTavernInfobar?.modules?.summaryManager;
            if (!summaryManager || !summaryManager.settings) {
                console.warn('[InfoBarSettings] âš ï¸ SummaryManageræœªåˆå§‹åŒ–');
                return;
            }

            const autoHideEnabled = summaryManager.settings.autoHideEnabled || false;
            const autoHideThreshold = summaryManager.settings.autoHideThreshold || 30;

            if (!autoHideEnabled) {
                console.log('[InfoBarSettings] â¸ï¸ è‡ªåŠ¨éšè—æœªå¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥');
                return;
            }

            // è·å–å½“å‰èŠå¤©æ¶ˆæ¯æ•°é‡
            const chatLength = this.getChatLength();
            if (chatLength <= autoHideThreshold) {
                console.log('[InfoBarSettings] â„¹ï¸ èŠå¤©é•¿åº¦ä¸è¶³ï¼Œæ— éœ€éšè—æ¥¼å±‚');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šè®¡ç®—éœ€è¦ä¿ç•™çš„æœ€æ–°æ¥¼å±‚æ•°
            // ä¾‹å¦‚ï¼šæ€»é•¿åº¦129ï¼Œé˜ˆå€¼30ï¼Œåˆ™ä¿ç•™æœ€æ–°30æ¡ï¼ˆç´¢å¼•99-128ï¼‰ï¼Œéšè—å‰99æ¡ï¼ˆç´¢å¼•0-98ï¼‰
            const keepRecentCount = autoHideThreshold;
            const hideUntilIndex = chatLength - keepRecentCount - 1;

            if (hideUntilIndex >= 0) {
                console.log(`[InfoBarSettings] ğŸ”„ æ‰§è¡Œè‡ªåŠ¨éšè—ï¼šä¿ç•™æœ€æ–°${keepRecentCount}æ¡ï¼Œéšè—æ¥¼å±‚ 0-${hideUntilIndex}`);
                await this.hideMessagesDirectly(0, hideUntilIndex);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è‡ªåŠ¨éšè—æ¥¼å±‚å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šè·å–å½“å‰èŠå¤©çš„æ¶ˆæ¯æ•°é‡
     */
    getChatLength() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨window.SillyTavern.getContextè·å–èŠå¤©æ•°æ®
            const context = window.SillyTavern?.getContext?.();
            if (context && context.chat && Array.isArray(context.chat)) {
                return context.chat.length;
            }

            // å¤‡ç”¨æ–¹æ³•ï¼šé€šè¿‡DOMæŸ¥è¯¢æ¶ˆæ¯æ•°é‡ï¼ˆä¸å¯é ï¼Œå› ä¸ºéšè—çš„æ¶ˆæ¯ä¸ä¼šæ˜¾ç¤ºåœ¨DOMä¸­ï¼‰
            const messages = document.querySelectorAll('#chat .mes');
            console.warn('[InfoBarSettings] âš ï¸ ä½¿ç”¨DOMæŸ¥è¯¢æ¶ˆæ¯æ•°é‡ï¼ˆä¸å¯é ï¼‰:', messages.length);
            return messages.length;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–èŠå¤©é•¿åº¦å¤±è´¥:', error);
            return 0;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç›´æ¥éšè—æ¶ˆæ¯ï¼ˆå‚è€ƒST-Amily2é¡¹ç›®çš„å®ç°ï¼‰
     * é€šè¿‡ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡çš„is_hiddenå±æ€§æ¥éšè—æ¥¼å±‚ï¼Œè®©AIä¸å¯è§
     * @param {number} startIndex - èµ·å§‹ç´¢å¼•ï¼ˆåŒ…å«ï¼‰
     * @param {number} endIndex - ç»“æŸç´¢å¼•ï¼ˆåŒ…å«ï¼‰
     */
    async hideMessagesDirectly(startIndex, endIndex) {
        try {
            console.log(`[InfoBarSettings] ğŸ™ˆ ç›´æ¥éšè—æ¶ˆæ¯ï¼šç´¢å¼• ${startIndex}-${endIndex}`);

            const context = window.SillyTavern?.getContext?.();
            if (!context || !context.chat || !Array.isArray(context.chat)) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–èŠå¤©æ•°æ®');
                return;
            }

            const chat = context.chat;
            let hiddenCount = 0;

            // ğŸ”§ ä¿®å¤ï¼šéå†æŒ‡å®šèŒƒå›´çš„æ¶ˆæ¯ï¼Œè®¾ç½®is_hiddenå±æ€§
            for (let i = startIndex; i <= endIndex && i < chat.length; i++) {
                const message = chat[i];
                if (message && !message.is_hidden) {
                    // è®¾ç½®éšè—æ ‡è®°
                    message.is_hidden = true;
                    hiddenCount++;

                    // ğŸ”§ å…³é”®ï¼šéšè—å¯¹åº”çš„DOMå…ƒç´ 
                    const messageElement = document.querySelector(`#chat .mes[mesid="${i}"]`);
                    if (messageElement) {
                        messageElement.style.display = 'none';
                        messageElement.classList.add('mes_hidden');
                    }
                }
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸéšè— ${hiddenCount} æ¡æ¶ˆæ¯`);

            // ğŸ”§ ä¿å­˜èŠå¤©æ•°æ®
            if (typeof context.saveChat === 'function') {
                await context.saveChat();
                console.log('[InfoBarSettings] ğŸ’¾ èŠå¤©æ•°æ®å·²ä¿å­˜');
            }

            // ğŸ”§ è§¦å‘UIæ›´æ–°
            if (typeof context.reloadCurrentChat === 'function') {
                // ä¸é‡æ–°åŠ è½½æ•´ä¸ªèŠå¤©ï¼Œåªæ›´æ–°UI
                console.log('[InfoBarSettings] ğŸ”„ UIå·²æ›´æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç›´æ¥éšè—æ¶ˆæ¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºéšè—çš„æ¶ˆæ¯
     * @param {number} startIndex - èµ·å§‹ç´¢å¼•ï¼ˆåŒ…å«ï¼‰
     * @param {number} endIndex - ç»“æŸç´¢å¼•ï¼ˆåŒ…å«ï¼‰
     */
    async showMessagesDirectly(startIndex, endIndex) {
        try {
            console.log(`[InfoBarSettings] ğŸ‘ï¸ æ˜¾ç¤ºéšè—çš„æ¶ˆæ¯ï¼šç´¢å¼• ${startIndex}-${endIndex}`);

            const context = window.SillyTavern?.getContext?.();
            if (!context || !context.chat || !Array.isArray(context.chat)) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–èŠå¤©æ•°æ®');
                return;
            }

            const chat = context.chat;
            let shownCount = 0;

            // éå†æŒ‡å®šèŒƒå›´çš„æ¶ˆæ¯ï¼Œç§»é™¤is_hiddenå±æ€§
            for (let i = startIndex; i <= endIndex && i < chat.length; i++) {
                const message = chat[i];
                if (message && message.is_hidden) {
                    // ç§»é™¤éšè—æ ‡è®°
                    delete message.is_hidden;
                    shownCount++;

                    // æ˜¾ç¤ºå¯¹åº”çš„DOMå…ƒç´ 
                    const messageElement = document.querySelector(`#chat .mes[mesid="${i}"]`);
                    if (messageElement) {
                        messageElement.style.display = '';
                        messageElement.classList.remove('mes_hidden');
                    }
                }
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸæ˜¾ç¤º ${shownCount} æ¡æ¶ˆæ¯`);

            // ä¿å­˜èŠå¤©æ•°æ®
            if (typeof context.saveChat === 'function') {
                await context.saveChat();
                console.log('[InfoBarSettings] ğŸ’¾ èŠå¤©æ•°æ®å·²ä¿å­˜');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºéšè—çš„æ¶ˆæ¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ–°å¢ï¼šæ˜¾ç¤ºæ€»ç»“é¢„è§ˆå¯¹è¯æ¡†ï¼ˆå‚è€ƒæ·»åŠ é¢æ¿å¯¹è¯æ¡†çš„æˆåŠŸå®ç°ï¼‰
     */
    async showSummaryPreview(summaryRange, messages, existingSummaries) {
        return new Promise((resolve) => {
            try {
                console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºæ€»ç»“é¢„è§ˆå¯¹è¯æ¡†...');

                // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰æ€»ç»“é‡å¤
                const hasOverlap = this.checkSummaryOverlap(summaryRange, existingSummaries);

                // è®¡ç®—æ€»ç»“ä¿¡æ¯
                const messageCount = summaryRange.end - summaryRange.start + 1;
                const startFloor = summaryRange.start + 1; // è½¬æ¢ä¸º1åŸºç´¢å¼•
                const endFloor = summaryRange.end + 1;

                // è·å–é¢„è§ˆæ¶ˆæ¯
                const previewMessages = messages.slice(summaryRange.start, Math.min(summaryRange.start + 3, summaryRange.end + 1));
                const lastMessages = messages.slice(Math.max(summaryRange.end - 2, summaryRange.start), summaryRange.end + 1);

                // ğŸ†• æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
                const isMobile = window.innerWidth <= 768;

                // æ„å»ºé‡å¤è­¦å‘ŠHTML
                const overlapWarningHTML = hasOverlap ? `
                    <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #ffa500; padding: 10px; margin-bottom: 12px; border-radius: 4px;">
                        <div style="color: #ffa500; font-weight: bold; margin-bottom: 6px; font-size: 13px;">âš ï¸ æ£€æµ‹åˆ°ä¸å·²æœ‰æ€»ç»“é‡å¤</div>
                        <div style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">
                            è¯¥èŒƒå›´ä¸å·²æœ‰æ€»ç»“å­˜åœ¨é‡å ã€‚ç»§ç»­æ€»ç»“å°†åˆ›å»ºæ–°çš„æ€»ç»“è®°å½•ã€‚
                        </div>
                    </div>
                ` : '';

                // æ„å»ºé¢„è§ˆæ¶ˆæ¯HTML
                const previewMessagesHTML = previewMessages.map((msg, idx) => `
                    <div style="margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--SmartThemeBorderColor, #333); font-size: 12px;">
                        <div style="color: var(--SmartThemeQuoteColor, #888); font-size: 11px;">æ¥¼å±‚ ${summaryRange.start + idx + 1}</div>
                        <div style="margin-top: 4px; word-break: break-word;">${this.truncateText(msg.mes || '', 80)}</div>
                    </div>
                `).join('');

                const lastMessagesHTML = lastMessages.map((msg, idx) => `
                    <div style="margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--SmartThemeBorderColor, #333); font-size: 12px;">
                        <div style="color: var(--SmartThemeQuoteColor, #888); font-size: 11px;">æ¥¼å±‚ ${Math.max(summaryRange.end - 2, summaryRange.start) + idx + 1}</div>
                        <div style="margin-top: 4px; word-break: break-word;">${this.truncateText(msg.mes || '', 80)}</div>
                    </div>
                `).join('');

                // åˆ›å»ºå¯¹è¯æ¡†HTMLï¼ˆå‚è€ƒæ·»åŠ é¢æ¿å¯¹è¯æ¡†ï¼‰
                const dialogHTML = `
                    <div class="summary-preview-dialog-overlay ${isMobile ? 'mobile-mode' : ''}" id="summary-preview-dialog">
                        <div class="summary-preview-dialog ${isMobile ? 'mobile-mode' : ''}">
                            <div class="dialog-header">
                                <h3 style="margin: 0; font-size: 16px; color: var(--SmartThemeAccentColor, #4a9eff);">ğŸ“‹ æ€»ç»“é¢„è§ˆ</h3>
                            </div>

                            <div class="dialog-body">
                                ${overlapWarningHTML}

                                <div style="margin-bottom: 12px;">
                                    <div style="font-weight: bold; margin-bottom: 6px; font-size: 13px;">ğŸ“Š æ€»ç»“èŒƒå›´</div>
                                    <div style="background: var(--SmartThemeSurfaceColor, #252525); padding: 10px; border-radius: 4px; font-size: 12px;">
                                        <div style="margin-bottom: 4px;">æ¥¼å±‚èŒƒå›´ï¼š<span style="color: var(--SmartThemeAccentColor, #4a9eff);">${startFloor} - ${endFloor}</span></div>
                                        <div>æ¶ˆæ¯æ•°é‡ï¼š<span style="color: var(--SmartThemeAccentColor, #4a9eff);">${messageCount} æ¡</span></div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <div style="font-weight: bold; margin-bottom: 6px; font-size: 13px;">ğŸ“ å¼€å§‹éƒ¨åˆ†é¢„è§ˆ</div>
                                    <div style="background: var(--SmartThemeSurfaceColor, #252525); padding: 10px; border-radius: 4px; max-height: 120px; overflow-y: auto;">
                                        ${previewMessagesHTML}
                                    </div>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <div style="font-weight: bold; margin-bottom: 6px; font-size: 13px;">ğŸ“ ç»“æŸéƒ¨åˆ†é¢„è§ˆ</div>
                                    <div style="background: var(--SmartThemeSurfaceColor, #252525); padding: 10px; border-radius: 4px; max-height: 120px; overflow-y: auto;">
                                        ${lastMessagesHTML}
                                    </div>
                                </div>
                            </div>

                            <div class="dialog-footer">
                                <button class="btn-cancel" id="summary-preview-cancel">å–æ¶ˆ</button>
                                <button class="btn-confirm" id="summary-preview-confirm">ç¡®è®¤æ€»ç»“</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ å¯¹è¯æ¡†åˆ°é¡µé¢
                document.body.insertAdjacentHTML('beforeend', dialogHTML);

                // ç»‘å®šäº‹ä»¶
                const dialog = document.querySelector('#summary-preview-dialog');
                const cancelBtn = dialog.querySelector('#summary-preview-cancel');
                const confirmBtn = dialog.querySelector('#summary-preview-confirm');

                const closeDialog = () => {
                    if (dialog && dialog.parentNode) {
                        dialog.remove();
                    }
                };

                cancelBtn?.addEventListener('click', () => {
                    closeDialog();
                    resolve(false);
                });

                confirmBtn?.addEventListener('click', () => {
                    closeDialog();
                    resolve(true);
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                dialog?.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        closeDialog();
                        resolve(false);
                    }
                });

            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ€»ç»“é¢„è§ˆå¤±è´¥:', error);
                resolve(true); // å‡ºé”™æ—¶é»˜è®¤ç»§ç»­
            }
        });
    }

    /**
     * ğŸ†• æ–°å¢ï¼šæ£€æŸ¥æ€»ç»“èŒƒå›´æ˜¯å¦ä¸å·²æœ‰æ€»ç»“é‡å 
     */
    checkSummaryOverlap(proposedRange, existingSummaries) {
        try {
            if (!existingSummaries || existingSummaries.length === 0) {
                return false;
            }

            for (const summary of existingSummaries) {
                if (!summary.messageRange) continue;

                const existingStart = summary.messageRange.start;
                const existingEnd = summary.messageRange.end;
                const proposedStart = proposedRange.start;
                const proposedEnd = proposedRange.end;

                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
                if (!(proposedEnd < existingStart || proposedStart > existingEnd)) {
                    return true;
                }
            }

            return false;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ£€æŸ¥æ€»ç»“é‡å å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * ğŸ†• æ–°å¢ï¼šæˆªæ–­æ–‡æœ¬
     */
    truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    /**
     * è§¦å‘æ‰‹åŠ¨æ€»ç»“
     */
    async triggerManualSummary() {
        // ğŸ”§ é˜²æ­¢é‡å¤ç‚¹å‡» - æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿›è¡Œä¸­
        if (this._summaryInProgress) {
            console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“å·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
            this.showMessage('â³ æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...', 'warning');
            return;
        }

        try {
            console.log('[InfoBarSettings] ğŸ–Šï¸ è§¦å‘æ‰‹åŠ¨æ€»ç»“...');

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // ğŸ†• è·å–å½“å‰èŠå¤©çš„æ¶ˆæ¯
            const context = SillyTavern.getContext();
            const chat = context?.chat;
            if (!chat || chat.length === 0) {
                throw new Error('å½“å‰èŠå¤©æ²¡æœ‰æ¶ˆæ¯');
            }

            // ğŸ†• è·å–æ€»ç»“èŒƒå›´æ¨¡å¼
            const rangeModeSelect = this.modal.querySelector('#content-summary-range-mode');
            const rangeMode = rangeModeSelect?.value || 'recent';

            // ğŸ†• è®¡ç®—æ€»ç»“èŒƒå›´
            let summaryRange;
            if (rangeMode === 'custom') {
                // è‡ªå®šä¹‰èŒƒå›´æ¨¡å¼
                const startInput = this.modal.querySelector('#content-custom-range-start');
                const endInput = this.modal.querySelector('#content-custom-range-end');

                const startFloor = parseInt(startInput?.value || '1');
                const endFloor = parseInt(endInput?.value || chat.length);

                // è½¬æ¢ä¸º0åŸºç´¢å¼•
                const start = Math.max(0, startFloor - 1);
                const end = Math.min(chat.length - 1, endFloor - 1);

                if (start > end) {
                    throw new Error('èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚');
                }

                summaryRange = { start, end };
            } else {
                // æœ€è¿‘Nå±‚æ¨¡å¼
                const floorCountInput = this.modal.querySelector('#content-summary-floor-count');
                const floorCount = parseInt(floorCountInput?.value || '20');

                const end = chat.length - 1;
                const start = Math.max(0, end - floorCount + 1);

                summaryRange = { start, end };
            }

            console.log('[InfoBarSettings] ğŸ“Š æ€»ç»“èŒƒå›´:', summaryRange);

            // ğŸ†• è·å–å·²æœ‰æ€»ç»“å†å²
            const existingSummaries = await summaryManager.getSummaryHistory();

            // ğŸ†• æ˜¾ç¤ºé¢„è§ˆå¯¹è¯æ¡†
            const confirmed = await this.showSummaryPreview(summaryRange, chat, existingSummaries);

            if (!confirmed) {
                console.log('[InfoBarSettings] â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†æ€»ç»“');
                this.showMessage('å·²å–æ¶ˆæ€»ç»“', 'info');
                return;
            }

            // è®¾ç½®è¿›è¡Œä¸­æ ‡å¿—
            this._summaryInProgress = true;

            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.disabled = true;
                manualSummaryBtn.innerHTML = `
                    <span class="btn-icon">â³</span>
                    <span class="btn-text">æ€»ç»“ä¸­...</span>
                `;
            }

            // è·å–å½“å‰è®¾ç½®
            const settings = this.getCurrentSummarySettings();

            // ğŸ†• è°ƒç”¨æ€»ç»“ç®¡ç†å™¨è¿›è¡Œæ€»ç»“ï¼Œä¼ å…¥è‡ªå®šä¹‰èŒƒå›´
            const result = await summaryManager.generateSummary({
                type: 'manual',
                customRange: summaryRange, // ä¼ å…¥è‡ªå®šä¹‰èŒƒå›´
                ...settings
            });

            if (result.success) {
                console.log('[InfoBarSettings] âœ… æ‰‹åŠ¨æ€»ç»“å®Œæˆ');
                this.showMessage('âœ… æ€»ç»“ç”ŸæˆæˆåŠŸ', 'success');

                // åˆ·æ–°æ€»ç»“å†å²
                this.loadSummaryHistory();
            } else {
                console.error('[InfoBarSettings] âŒ æ‰‹åŠ¨æ€»ç»“å¤±è´¥:', result.error);
                this.showMessage('âŒ æ€»ç»“ç”Ÿæˆå¤±è´¥: ' + result.error, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è§¦å‘æ‰‹åŠ¨æ€»ç»“å¤±è´¥:', error);

            // ğŸ”§ æ”¹è¿›çš„é”™è¯¯æ¶ˆæ¯å¤„ç†
            let errorMessage = 'âŒ æ€»ç»“ç”Ÿæˆå¤±è´¥';

            if (error.message?.includes('429')) {
                errorMessage = 'âŒ APIè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯• (429é”™è¯¯)';
            } else if (error.message?.includes('500')) {
                errorMessage = 'âŒ GeminiæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯• (500é”™è¯¯)';
            } else if (error.message?.includes('ç©ºçš„æ–‡æœ¬å†…å®¹')) {
                errorMessage = 'âŒ æ¨¡å‹æ²¡æœ‰è¿”å›å†…å®¹ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–é‡è¯•';
            } else if (error.message?.includes('æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­')) {
                errorMessage = 'â³ æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…';
            } else if (error.message) {
                errorMessage += ': ' + error.message;
            }

            this.showMessage(errorMessage, 'error');
        } finally {
            // ğŸ”§ æ¸…é™¤è¿›è¡Œä¸­æ ‡å¿—
            this._summaryInProgress = false;

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.disabled = false;
                manualSummaryBtn.innerHTML = `
                    <span class="btn-icon">ğŸ–Šï¸</span>
                    <span class="btn-text">æ‰‹åŠ¨æ€»ç»“</span>
                `;
            }
        }
    }

    /**
     * ä¿å­˜æ€»ç»“è®¾ç½®
     */
    async saveSummarySettings() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜æ€»ç»“è®¾ç½®...');

            const settings = this.getCurrentSummarySettings();

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°è®¾ç½®
            summaryManager.updateSettings(settings);

            // ä¿å­˜åˆ°æ•°æ®æ ¸å¿ƒ
            const unifiedDataCore = infoBarTool?.modules?.dataCore;
            if (unifiedDataCore) {
                await unifiedDataCore.setData('summary_settings', settings);
            }

            // ğŸ”§ æ–°å¢ï¼šä¿å­˜åˆ°SillyTavernæ‰©å±•è®¾ç½®
            const context = SillyTavern.getContext();
            if (context && context.extensionSettings) {
                const extensionSettings = context.extensionSettings;
                if (!extensionSettings['Information bar integration tool']) {
                    extensionSettings['Information bar integration tool'] = {};
                }

                // ğŸ”§ ä¿®å¤ï¼šä¿å­˜æ€»ç»“è®¾ç½®åˆ°summarySettingså­å¯¹è±¡
                extensionSettings['Information bar integration tool'].summarySettings = settings;

                // è§¦å‘SillyTavernä¿å­˜
                if (context.saveSettingsDebounced) {
                    context.saveSettingsDebounced();
                }

                console.log('[InfoBarSettings] ğŸ’¾ æ€»ç»“è®¾ç½®å·²ä¿å­˜åˆ°æ‰©å±•è®¾ç½®');
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“è®¾ç½®å·²ä¿å­˜');
            this.showMessage('âœ… è®¾ç½®å·²ä¿å­˜', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ€»ç»“è®¾ç½®å¤±è´¥:', error);
            this.showMessage('âŒ ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
        }
    }

    /**
     * è·å–å½“å‰æ€»ç»“è®¾ç½®
     */
    getCurrentSummarySettings() {
        const settings = {
            autoSummaryEnabled: false,
            summaryFloorCount: 20,
            summaryType: 'small',
            summaryWordCount: 300,
            injectSummaryEnabled: false,  // ğŸ”§ æ–°å¢ï¼šæ³¨å…¥æ€»ç»“è®¾ç½®
            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            autoHideEnabled: false,
            autoHideThreshold: 30,
            // ğŸ“š ä¸–ç•Œä¹¦ä¸Šä¼ ç›¸å…³ï¼ˆç”¨äºæŒä¹…åŒ–ä¿å­˜ï¼‰
            autoUploadNewSummary: false,
            worldBookEntryFormat: 'auto',
            worldBookCustomEntryName: '',
            worldBookAddTimestamp: true,
            worldBookUseContentTags: true,
            // ğŸ†• ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–è®¾ç½®
            vectorizeSummaryEnabled: false,
            vectorizeSummaryFloorCount: 100,
            // ğŸ†• å»¶è¿Ÿæ€»ç»“è®¾ç½®
            delayedSummaryEnabled: false,
            delayedSummaryFloors: 5
        };

        try {
            const autoSummaryEnabled = this.modal.querySelector('#content-auto-summary-enabled');
            if (autoSummaryEnabled) {
                settings.autoSummaryEnabled = autoSummaryEnabled.checked;
            }

            const summaryFloorCount = this.modal.querySelector('#content-summary-floor-count');
            if (summaryFloorCount) {
                settings.summaryFloorCount = parseInt(summaryFloorCount.value) || 20;
            }

            const summaryType = this.modal.querySelector('#content-summary-type');
            if (summaryType) {
                settings.summaryType = summaryType.value;
            }

            const summaryWordCount = this.modal.querySelector('#content-summary-word-count');
            if (summaryWordCount) {
                settings.summaryWordCount = parseInt(summaryWordCount.value) || 300;
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–æ³¨å…¥æ€»ç»“è®¾ç½®
            const injectSummaryEnabled = this.modal.querySelector('#content-inject-summary-enabled');
            if (injectSummaryEnabled) {
                settings.injectSummaryEnabled = injectSummaryEnabled.checked;
            }

            // ğŸ†• æ–°å¢ï¼šè·å–æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤è®¾ç½®
            const useRegexFilter = this.modal.querySelector('#content-summary-use-regex');
            if (useRegexFilter) {
                settings.useRegexFilter = useRegexFilter.checked;
            }

            // ğŸ†• NPC AIæ¨¡å¼è®¾ç½®
            const npcModeTab = this.modal.querySelector('.npc-mode-tab.active');
            if (npcModeTab) {
                settings.npcMode = npcModeTab.dataset.mode || 'panel';
            }
            
            const npcAiUpdateFloor = this.modal.querySelector('#npc-ai-update-floor');
            if (npcAiUpdateFloor) {
                settings.npcAiUpdateFloor = parseInt(npcAiUpdateFloor.value) || 20;
            }
            
            const npcAiUseRegex = this.modal.querySelector('#npc-ai-use-regex');
            if (npcAiUseRegex) {
                settings.npcAiUseRegex = npcAiUseRegex.checked;
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–è‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            const autoHideEnabled = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabled) {
                settings.autoHideEnabled = autoHideEnabled.checked;
            }

            // ğŸ†• æ–°å¢ï¼šè·å–è‡ªå®šä¹‰æç¤ºè¯è®¾ç½®
            const useCustomPrompt = this.modal.querySelector('#content-use-custom-prompt');
            if (useCustomPrompt) {
                settings.useCustomPrompt = useCustomPrompt.checked;
            }

            const customPrompt = this.modal.querySelector('#content-custom-prompt');
            if (customPrompt) {
                settings.customPrompt = customPrompt.value || '';
            }

            const autoHideThreshold = this.modal.querySelector('#content-auto-hide-threshold');
            if (autoHideThreshold) {
                settings.autoHideThreshold = parseInt(autoHideThreshold.value) || 30;
            }

            // ğŸ“š æ–°å¢ï¼šè·å–"è‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“"ä¸"æ¡ç›®å‘½åæ ¼å¼"ç­‰ä¸–ç•Œä¹¦ä¸Šä¼ è®¾ç½®
            const wbAuto = this.modal.querySelector('#worldbook-auto-upload');
            if (wbAuto) {
                settings.autoUploadNewSummary = wbAuto.checked;
                console.log('[InfoBarSettings] ğŸ“š ä¿å­˜è‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“è®¾ç½®:', wbAuto.checked);
            }

            const entryFormatEl = this.modal.querySelector('#worldbook-entry-format');
            if (entryFormatEl) {
                settings.worldBookEntryFormat = entryFormatEl.value || 'auto';
            }

            const customNameEl = this.modal.querySelector('#worldbook-custom-name');
            if (customNameEl) {
                settings.worldBookCustomEntryName = customNameEl.value || '';
            }

            const addTsEl = this.modal.querySelector('#worldbook-add-timestamp');
            if (addTsEl) {
                settings.worldBookAddTimestamp = addTsEl.checked !== false;
            }

            const useTagsEl = this.modal.querySelector('#worldbook-use-tags');
            if (useTagsEl) {
                settings.worldBookUseContentTags = useTagsEl.checked !== false;
            }

            // ğŸ†• è·å–ä¼ ç»Ÿæ€»ç»“å‘é‡åŒ–è®¾ç½®
            const vectorizeSummaryEnabled = this.modal.querySelector('#content-vectorize-summary-enabled');
            if (vectorizeSummaryEnabled) {
                settings.vectorizeSummaryEnabled = vectorizeSummaryEnabled.checked;
            }

            // ğŸ†• è·å–å»¶è¿Ÿæ€»ç»“è®¾ç½®
            const delayedSummaryEnabled = this.modal.querySelector('#content-delayed-summary-enabled');
            if (delayedSummaryEnabled) {
                settings.delayedSummaryEnabled = delayedSummaryEnabled.checked;
            }

            const delayedSummaryFloors = this.modal.querySelector('#content-delayed-summary-floors');
            if (delayedSummaryFloors) {
                settings.delayedSummaryFloors = parseInt(delayedSummaryFloors.value) || 5;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ€»ç»“è®¾ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * éšè—æ€»ç»“å†…å®¹
     */
    hideSummaryContent() {
        // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥modalæ˜¯å¦å­˜åœ¨ï¼Œé¿å…åœ¨æœªåˆå§‹åŒ–æ—¶è°ƒç”¨
        if (!this.modal) {
            console.log('[InfoBarSettings] âš ï¸ è®¾ç½®ç•Œé¢æœªåˆå§‹åŒ–ï¼Œè·³è¿‡éšè—æ€»ç»“å†…å®¹');
            return;
        }

        const contentSection = this.modal.querySelector('#content-summary-content-section');
        if (contentSection) {
            contentSection.style.display = 'none';
        }
    }

    /**
     * ğŸ“Š æ”¶é›†æ•°æ®è¡¨æ ¼é…ç½®
     */
    collectDataTableSettings() {
        const settings = {};

        try {
            // 1. æ”¶é›†å¯ç”¨æ•°æ®è¡¨æ ¼
            const enabledEl = this.modal?.querySelector('#data-table-enabled');
            if (enabledEl) {
                settings.enabled = enabledEl.checked;
            }

            // 2. æ”¶é›†å¯ç”¨çŠ¶æ€æ æ˜¾ç¤º
            const renderInChatEl = this.modal?.querySelector('#data-table-render-in-chat');
            if (renderInChatEl) {
                settings.renderInChatEnabled = renderInChatEl.checked;
            }

            // 3. æ”¶é›†ä¿¡æ¯æ é»˜è®¤æŠ˜å 
            const defaultCollapsedEl = this.modal?.querySelector('#data-table-default-collapsed');
            if (defaultCollapsedEl) {
                settings.defaultCollapsedEnabled = defaultCollapsedEl.checked;
            }

            // 4. æ”¶é›†å¯ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
            const useRegexEl = this.modal?.querySelector('#data-table-use-regex');
            if (useRegexEl) {
                settings.useRegexFilter = useRegexEl.checked;
            }

            // 5. æ”¶é›†APIæ¨¡å¼
            const apiModeBtn = this.modal?.querySelector('.data-table-api-mode-btn.active');
            if (apiModeBtn) {
                settings.apiMode = apiModeBtn.getAttribute('data-mode') || 'custom';
            } else {
                settings.apiMode = 'custom'; // é»˜è®¤è‡ªå®šä¹‰APIæ¨¡å¼
            }

            // 6. æ”¶é›†æ•°æ®è¡¨æ ¼åŠŸèƒ½è®¾ç½®
            const mergeMessagesEl = this.modal?.querySelector('#data-table-merge-messages');
            if (mergeMessagesEl) {
                settings.mergeMessages = mergeMessagesEl.checked;
            }

            const delayedGenerationEl = this.modal?.querySelector('#data-table-delayed-generation');
            if (delayedGenerationEl) {
                settings.delayedGeneration = delayedGenerationEl.checked;
            }

            const delayFloorsEl = this.modal?.querySelector('#data-table-delay-floors');
            if (delayFloorsEl) {
                settings.delayFloors = parseInt(delayFloorsEl.value) || 1;
            }

            const minMessageLengthEl = this.modal?.querySelector('#data-table-min-message-length');
            if (minMessageLengthEl) {
                settings.minMessageLength = parseInt(minMessageLengthEl.value) || 500;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°æ•°æ®è¡¨æ ¼é…ç½®:', settings);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†æ•°æ®è¡¨æ ¼é…ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šæ”¶é›†NPCç®¡ç†é¢æ¿çš„è®¾ç½®
     * è¿™äº›æ§ä»¶æ²¡æœ‰ name å±æ€§ï¼Œéœ€è¦å•ç‹¬æ”¶é›†
     */
    collectNPCManagementSettings() {
        const settings = {};

        try {
            // 1. æ”¶é›†NPCæ¨¡å¼è®¾ç½®ï¼ˆé¢æ¿æ¨¡å¼/AIæ¨¡å¼ï¼‰
            const npcModeTab = this.modal?.querySelector('.npc-mode-tab.active');
            if (npcModeTab) {
                settings.npcMode = npcModeTab.dataset.mode || 'panel';
            }

            // 2. æ”¶é›†AIæ¨¡å¼çš„æ›´æ–°é˜ˆå€¼
            const npcAiUpdateFloor = this.modal?.querySelector('#npc-ai-update-floor');
            if (npcAiUpdateFloor) {
                settings.npcAiUpdateFloor = parseInt(npcAiUpdateFloor.value) || 20;
            }

            // 3. æ”¶é›†AIæ¨¡å¼çš„æ­£åˆ™è¿‡æ»¤å¼€å…³
            const npcAiUseRegex = this.modal?.querySelector('#npc-ai-use-regex');
            if (npcAiUseRegex) {
                settings.npcAiUseRegex = npcAiUseRegex.checked;
            }

            console.log('[InfoBarSettings] ğŸ­ æ”¶é›†åˆ°NPCç®¡ç†è®¾ç½®:', settings);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†NPCç®¡ç†è®¾ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * ğŸ“– æ”¶é›†å‰§æƒ…ä¼˜åŒ–é…ç½®
     */
    collectPlotOptimizationSettings() {
        const settings = {};

        try {
            // 1. æ”¶é›†å¯ç”¨çŠ¶æ€
            const enabledEl = this.modal?.querySelector('#plot-optimization-enabled');
            if (enabledEl) {
                settings.enabled = enabledEl.checked;
            }

            // 2. æ”¶é›†æ•…äº‹è®¾å®š
            const storyThemeEl = this.modal?.querySelector('#plot-optimization-story-theme');
            if (storyThemeEl) {
                settings.storyTheme = storyThemeEl.value;
            }

            const storyTypeEl = this.modal?.querySelector('#plot-optimization-story-type');
            if (storyTypeEl) {
                settings.storyType = storyTypeEl.value;
            }

            const referenceWorksEl = this.modal?.querySelector('#plot-optimization-reference-works');
            if (referenceWorksEl) {
                settings.referenceWorks = referenceWorksEl.value;
            }

            const wordCountEl = this.modal?.querySelector('#plot-optimization-word-count');
            if (wordCountEl) {
                settings.wordCountRequirement = wordCountEl.value;
            }

            // 3. æ”¶é›†å‰§æƒ…å¼ºåº¦å‚æ•°
            const progressIntensityEl = this.modal?.querySelector('#plot-optimization-progress-intensity');
            if (progressIntensityEl) {
                settings.plotProgressIntensity = parseInt(progressIntensityEl.value) || 5;
            }

            const conflictIntensityEl = this.modal?.querySelector('#plot-optimization-conflict-intensity');
            if (conflictIntensityEl) {
                settings.plotConflictIntensity = parseInt(conflictIntensityEl.value) || 5;
            }

            const suspenseIntensityEl = this.modal?.querySelector('#plot-optimization-suspense-intensity');
            if (suspenseIntensityEl) {
                settings.plotSuspenseIntensity = parseInt(suspenseIntensityEl.value) || 5;
            }

            const twistIntensityEl = this.modal?.querySelector('#plot-optimization-twist-intensity');
            if (twistIntensityEl) {
                settings.plotTwistIntensity = parseInt(twistIntensityEl.value) || 5;
            }

            const climaxIntensityEl = this.modal?.querySelector('#plot-optimization-climax-intensity');
            if (climaxIntensityEl) {
                settings.plotClimaxIntensity = parseInt(climaxIntensityEl.value) || 5;
            }

            const lowIntensityEl = this.modal?.querySelector('#plot-optimization-low-intensity');
            if (lowIntensityEl) {
                settings.plotLowIntensity = parseInt(lowIntensityEl.value) || 5;
            }

            const turnIntensityEl = this.modal?.querySelector('#plot-optimization-turn-intensity');
            if (turnIntensityEl) {
                settings.plotTurnIntensity = parseInt(turnIntensityEl.value) || 5;
            }

            // 4. æ”¶é›†ä¸Šä¸‹æ–‡è®¾ç½®
            const maxContextEl = this.modal?.querySelector('#plot-optimization-max-context');
            if (maxContextEl) {
                settings.maxContextMessages = parseInt(maxContextEl.value) || 10;
            }

            // 5. æ”¶é›†æ³¨å…¥è®¾ç½®
            const injectionPositionEl = this.modal?.querySelector('#plot-optimization-injection-position');
            if (injectionPositionEl) {
                settings.injectionPosition = injectionPositionEl.value;
            }

            const injectionPriorityEl = this.modal?.querySelector('#plot-optimization-injection-priority');
            if (injectionPriorityEl) {
                settings.injectionPriority = parseInt(injectionPriorityEl.value) || 100;
            }

            // ğŸ†• 6. æ”¶é›†ä½œå®¶æ–‡é£æ¨¡ä»¿é…ç½®
            const imitateAuthorEnabledEl = this.modal?.querySelector('#plot-optimization-imitate-author-enabled');
            if (imitateAuthorEnabledEl) {
                settings.imitateAuthorEnabled = imitateAuthorEnabledEl.checked;
            }

            const targetAuthorEl = this.modal?.querySelector('#plot-optimization-target-author');
            if (targetAuthorEl) {
                settings.targetAuthor = targetAuthorEl.value;
            }

            const authorStyleDepthEl = this.modal?.querySelector('#plot-optimization-author-style-depth');
            if (authorStyleDepthEl) {
                settings.authorStyleDepth = authorStyleDepthEl.value;
            }

            // ğŸ†• 7. æ”¶é›†æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤é…ç½®
            const useRegexFilterEl = this.modal?.querySelector('#plot-optimization-use-regex');
            if (useRegexFilterEl) {
                settings.useRegexFilter = useRegexFilterEl.checked;
            }

            // 8. ä¿ç•™ç°æœ‰çš„æç¤ºè¯æ¨¡æ¿ï¼ˆä¸ä»DOMæ”¶é›†ï¼Œå› ä¸ºæ˜¯é€šè¿‡ç¼–è¾‘å™¨å•ç‹¬ä¿å­˜çš„ï¼‰
            const context = SillyTavern.getContext();
            const existingConfig = context.extensionSettings?.['Information bar integration tool']?.plotOptimization;
            if (existingConfig?.promptTemplate) {
                settings.promptTemplate = existingConfig.promptTemplate;
            }

            console.log('[InfoBarSettings] ğŸ“– æ”¶é›†åˆ°å‰§æƒ…ä¼˜åŒ–é…ç½®:', settings);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‰§æƒ…ä¼˜åŒ–é…ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * ğŸ†• æ”¶é›†å‘é‡åŒ–APIé…ç½®
     */
    collectVectorAPIConfig() {
        const config = {};

        try {
            // 1. æ”¶é›†è¿æ¥æ¨¡å¼
            const providerEl = this.modal?.querySelector('#infobar-vector-api-provider');
            if (providerEl) {
                config.provider = providerEl.value;
            }

            // 2. æ”¶é›†åŸºç¡€URL
            const baseUrlEl = this.modal?.querySelector('#infobar-vector-api-base-url');
            if (baseUrlEl) {
                config.baseUrl = baseUrlEl.value;
            }

            // 3. æ”¶é›†APIå¯†é’¥
            const apiKeyEl = this.modal?.querySelector('#infobar-vector-api-key');
            if (apiKeyEl) {
                config.apiKey = apiKeyEl.value;
            }

            // 4. æ”¶é›†å‘é‡åŒ–æ¨¡å‹
            const modelEl = this.modal?.querySelector('#infobar-vector-api-model');
            if (modelEl) {
                config.model = modelEl.value;
            }

            // 5. æ”¶é›†å‘é‡ç»´åº¦
            const dimensionsEl = this.modal?.querySelector('#infobar-vector-api-dimensions');
            if (dimensionsEl) {
                config.dimensions = parseInt(dimensionsEl.value) || 384;
            }

            // 6. æ”¶é›†æ‰¹å¤„ç†å¤§å°
            const batchSizeEl = this.modal?.querySelector('#infobar-vector-api-batch-size');
            if (batchSizeEl) {
                config.batchSize = parseInt(batchSizeEl.value) || 50;
            }

            // 7. ğŸ†• æ”¶é›†é‡æ’åºæ¨¡å‹
            const rerankModelEl = this.modal?.querySelector('#infobar-vector-api-rerank-model');
            if (rerankModelEl) {
                config.rerankModel = rerankModelEl.value;
            }

            // 8. ğŸ†• æ”¶é›†é‡æ’åºæ¨¡å‹å‚æ•°
            const rerankParamsEl = this.modal?.querySelector('#infobar-vector-api-rerank-params');
            if (rerankParamsEl && rerankParamsEl.value.trim()) {
                try {
                    config.rerankParams = JSON.parse(rerankParamsEl.value);
                } catch (error) {
                    console.warn('[InfoBarSettings] âš ï¸ é‡æ’åºå‚æ•°JSONè§£æå¤±è´¥ï¼Œä¿å­˜ä¸ºå­—ç¬¦ä¸²:', error);
                    config.rerankParams = rerankParamsEl.value;
                }
            }

            console.log('[InfoBarSettings] ğŸ§  æ”¶é›†åˆ°å‘é‡åŒ–APIé…ç½®:', config);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‘é‡åŒ–APIé…ç½®å¤±è´¥:', error);
        }

        return config;
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šæ¢å¤NPCç®¡ç†é¢æ¿çš„è®¾ç½®
     * åœ¨NPCç®¡ç†é¢æ¿åˆå§‹åŒ–å®Œæˆåè°ƒç”¨
     */
    restoreNPCSettings() {
        try {
            // è·å–ä¿å­˜çš„è®¾ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'];

            if (!extensionSettings) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ‰©å±•è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š å‡†å¤‡æ¢å¤NPCè®¾ç½®:', {
                npcMode: extensionSettings.npcMode,
                npcAiUpdateFloor: extensionSettings.npcAiUpdateFloor,
                npcAiUseRegex: extensionSettings.npcAiUseRegex
            });

            // 1. æ¢å¤NPCæ¨¡å¼ï¼ˆé¢æ¿æ¨¡å¼/AIæ¨¡å¼ï¼‰
            const npcMode = extensionSettings.npcMode || 'panel';
            this.switchNPCMode(npcMode);
            console.log('[InfoBarSettings] âœ… NPCæ¨¡å¼å·²æ¢å¤:', npcMode);

            // 2. æ¢å¤AIæ¨¡å¼çš„æ›´æ–°é˜ˆå€¼
            const npcAiUpdateFloor = this.modal?.querySelector('#npc-ai-update-floor');
            if (npcAiUpdateFloor) {
                npcAiUpdateFloor.value = extensionSettings.npcAiUpdateFloor || 20;
                console.log('[InfoBarSettings] âœ… NPCæ›´æ–°æ¥¼å±‚å·²æ¢å¤:', npcAiUpdateFloor.value);
            }

            // 3. æ¢å¤AIæ¨¡å¼çš„æ­£åˆ™è¿‡æ»¤å¼€å…³
            const npcAiUseRegex = this.modal?.querySelector('#npc-ai-use-regex');
            if (npcAiUseRegex) {
                npcAiUseRegex.checked = extensionSettings.npcAiUseRegex !== false; // é»˜è®¤å¯ç”¨
                console.log('[InfoBarSettings] âœ… NPCæ­£åˆ™å¼€å…³å·²æ¢å¤:', npcAiUseRegex.checked);
            }

            console.log('[InfoBarSettings] âœ… NPCè®¾ç½®æ¢å¤å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤NPCè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†ä¿¡æ¯æ é«˜åº¦å˜æ›´
     */
    handleInfobarHeightChange(height) {
        // åº”ç”¨CSSå˜é‡åˆ°ä¿¡æ¯æ 
        const heightMap = {
            'auto': 'auto',
            'compact': '24px',
            'normal': '32px',
            'comfortable': '40px',
            'spacious': '48px'
        };

        const heightValue = heightMap[height] || '32px';

        // åº”ç”¨åˆ°CSSå˜é‡ï¼ˆå¦‚æœå­˜åœ¨ä¿¡æ¯æ å…ƒç´ ï¼‰
        const infobarElements = document.querySelectorAll('.info-bar, .infobar-container');
        infobarElements.forEach(element => {
            element.style.setProperty('--infobar-height', heightValue);
            if (heightValue !== 'auto') {
                element.style.minHeight = heightValue;
            }
        });

        console.log(`[InfoBarSettings] ğŸ“ ä¿¡æ¯æ é«˜åº¦è®¾ç½®ä¸º ${heightValue}`);

        // ä¿å­˜è®¾ç½®
        this.saveThemeSettings();
    }

    /**
     * ä¿å­˜ä¸»é¢˜è®¾ç½®
     */
    saveThemeSettings() {
        try {
            const settings = {
                infobarHeight: this.modal.querySelector('select[name="infobar.height"]')?.value || 'normal'
            };

            // ä¿å­˜åˆ°æ‰©å±•è®¾ç½®
            const extensionSettings = window.SillyTavernInfobar?.config || {};
            extensionSettings.theme = extensionSettings.theme || {};
            Object.assign(extensionSettings.theme, settings);

            console.log('[InfoBarSettings] ğŸ’¾ ä¸»é¢˜è®¾ç½®å·²ä¿å­˜:', settings);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•
     */
    showAddPanelMenu(position, slotElement) {
        try {
            console.log('[InfoBarSettings] ğŸ­ æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•');

            // ç§»é™¤ç°æœ‰èœå•
            const existingMenu = document.querySelector('.demo-add-panel-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // è·å–åŒºåŸŸä¿¡æ¯
            const area = slotElement.dataset.area || 'top';
            console.log(`[InfoBarSettings] ğŸ“ æ·»åŠ åˆ°åŒºåŸŸ: ${area}, ä½ç½®: ${position}`);

            // åŠ¨æ€è·å–ç”¨æˆ·å¯ç”¨çš„é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            console.log('[InfoBarSettings] ğŸ“Š è·å–åˆ°ç”¨æˆ·å¯ç”¨çš„é¢æ¿:', Object.keys(enabledPanels));

            if (Object.keys(enabledPanels).length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯ç”¨çš„é¢æ¿ï¼Œæ— æ³•æ˜¾ç¤ºæ·»åŠ èœå•');
                return;
            }

            // åˆ›å»ºæ¼”ç¤ºèœå•
            const menu = document.createElement('div');
            menu.className = 'demo-add-panel-menu';
            // ç”Ÿæˆé¢æ¿åˆ—è¡¨HTML
            const panelListHtml = this.generatePanelListHtml(enabledPanels);

            // è·å–ç¬¬ä¸€ä¸ªé¢æ¿ç”¨äºåˆå§‹åŒ–å³ä¾§å­é¡¹åˆ—è¡¨
            const firstPanelId = Object.keys(enabledPanels)[0];
            const firstPanelConfig = enabledPanels[firstPanelId];
            const subitemListHtml = this.generateSubitemListHtml(firstPanelId, firstPanelConfig);

            menu.innerHTML = `
                <div class="demo-menu-content">
                    <div class="menu-header">
                        <h3>æ·»åŠ åˆ°${area === 'top' ? 'é¡¶éƒ¨' : 'åº•éƒ¨'}åŒºåŸŸ</h3>
                        <button class="menu-close-btn">&times;</button>
                    </div>
                    <div class="menu-body">
                        <div class="menu-layout">
                            <!-- å·¦ä¾§é¢æ¿å¯¼èˆª -->
                            <div class="panel-navigation">
                                <h4>ğŸ“‹ å¯ç”¨çš„é¢æ¿ (${Object.keys(enabledPanels).length})</h4>
                                <div class="panel-list">
                                    ${panelListHtml}
                                </div>
                            </div>

                            <!-- å³ä¾§å­é¡¹åˆ—è¡¨ -->
                            <div class="subitem-list">
                                ${subitemListHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // å®šä½èœå•ï¼ˆç§»åŠ¨ç«¯å…¨å±é®ç½©ï¼Œæ¡Œé¢ç«¯å±…ä¸­ï¼‰
            const isMobile = window.innerWidth <= 768;
            menu.style.position = 'fixed';
            menu.style.zIndex = '10000';
            if (isMobile) {
                // å…¨å±é®ç½©
                menu.style.left = '0';
                menu.style.top = '0';
                menu.style.width = '100vw';
                menu.style.height = '100vh';
                menu.style.background = 'rgba(0, 0, 0, 0.5)';
                menu.style.backdropFilter = 'blur(4px)';
                menu.style.display = 'flex';
                menu.style.alignItems = 'center';
                menu.style.justifyContent = 'center';

                // å†…å®¹å®¹å™¨é™åˆ¶å°ºå¯¸å¹¶å±…ä¸­
                const menuContent = menu.querySelector('.demo-menu-content');
                if (menuContent) {
                    menuContent.style.width = '90vw';
                    menuContent.style.maxWidth = '360px';
                    menuContent.style.maxHeight = '80vh';
                    menuContent.style.overflow = 'auto';
                    menuContent.style.borderRadius = '12px';
                }
            } else {
                // æ¡Œé¢å±…ä¸­
                menu.style.left = '50%';
                menu.style.top = '50%';
                menu.style.transform = 'translate(-50%, -50%)';
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);

            // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆä»…ç§»åŠ¨ç«¯å…¨å±æ—¶ï¼‰
            if (isMobile) {
                menu.addEventListener('click', (evt) => {
                    const content = menu.querySelector('.demo-menu-content');
                    if (content && !content.contains(evt.target)) {
                        menu.remove();
                    }
                });
            }

            // ç»‘å®šå…³é—­æŒ‰é’®
            const closeBtn = menu.querySelector('.menu-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    menu.remove();
                });
            }

            // ç»‘å®šé¢æ¿å¯¼èˆªäº‹ä»¶
            const panelNavItems = menu.querySelectorAll('.panel-nav-item');
            panelNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-panel-btn')) return; // å¿½ç•¥æ·»åŠ æŒ‰é’®ç‚¹å‡»

                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    panelNavItems.forEach(navItem => navItem.classList.remove('active'));
                    item.classList.add('active');

                    // æ›´æ–°å³ä¾§å­é¡¹åˆ—è¡¨
                    const panelType = item.dataset.panel;
                    this.updateSubitemList(menu, panelType);
                });
            });

            // ç»‘å®šæ·»åŠ é¢æ¿æŒ‰é’®äº‹ä»¶
            const addPanelBtns = menu.querySelectorAll('.add-panel-btn');
            addPanelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const panelType = btn.closest('.panel-nav-item').dataset.panel;
                    console.log(`[InfoBarSettings] ğŸ­ æ·»åŠ é¢æ¿: ${panelType} åˆ° ${area}`);
                    this.addPanelToPreview(panelType, area, position);
                    menu.remove();
                });
            });

            // ç»‘å®šæ·»åŠ å­é¡¹æŒ‰é’®äº‹ä»¶
            const addSubitemBtns = menu.querySelectorAll('.add-subitem-btn');
            addSubitemBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fieldType = btn.closest('.subitem-item').dataset.field;
                    console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹: ${fieldType} åˆ° ${area}`);
                    this.addSubitemToPreview(fieldType, area, position);
                    menu.remove();
                });
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const clickOutside = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', clickOutside);
                    }
                };
                document.addEventListener('click', clickOutside);
            }, 100);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—
     */
    showDemoPanelPopup(panelType, panelData = {}) {
        try {
            console.log('[InfoBarSettings] ğŸ­ æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—:', panelType);

            // ç§»é™¤ç°æœ‰å¼¹çª—
            const existingPopup = document.querySelector('.demo-panel-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // æ¼”ç¤ºæ•°æ®
            const demoData = {
                personal: {
                    'å§“å': 'å¼ ä¸‰',
                    'å¹´é¾„': '25å²',
                    'æ€§åˆ«': 'ç”·',
                    'èŒä¸š': 'å†’é™©è€…',
                    'ç­‰çº§': 'Lv.15',
                    'ç»éªŒå€¼': '2847/3000'
                },
                inventory: {
                    'é‡‘å¸': '1,247æš',
                    'é“¶å‰‘': '1æŠŠ (è£…å¤‡ä¸­)',
                    'ç”Ÿå‘½è¯æ°´': '3ç“¶',
                    'é­”æ³•çŸ³': '5é¢—',
                    'é¢åŒ…': '7ä¸ª',
                    'é’¥åŒ™': 'ç¥ç§˜é’¥åŒ™ x1'
                }
            };

            const data = demoData[panelType] || panelData;

            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'demo-panel-popup';
            popup.style.setProperty('position', 'fixed', 'important');
            popup.style.setProperty('top', '0', 'important');
            popup.style.setProperty('left', '0', 'important');
            popup.style.setProperty('right', '0', 'important');
            popup.style.setProperty('bottom', '0', 'important');
            popup.style.setProperty('width', '100vw', 'important');
            popup.style.setProperty('height', '100vh', 'important');
            popup.style.setProperty('display', 'flex', 'important');
            popup.style.setProperty('align-items', 'center', 'important');
            popup.style.setProperty('justify-content', 'center', 'important');
            popup.style.setProperty('z-index', '10000', 'important');
            popup.style.setProperty('background', 'rgba(0,0,0,0.5)', 'important');

            const dataHtml = Object.entries(data)
                .map(([key, value]) => `
                    <div class="data-field">
                        <span class="field-name">${key}:</span>
                        <span class="field-value">${value}</span>
                    </div>
                `).join('');

            popup.innerHTML = `
                <div class="demo-popup-content" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    min-width: 300px;
                    max-width: 90vw;
                    min-height: 200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    position: relative;
                    margin: 0;
                ">
                    <div class="popup-header">
                        <h3>${panelType === 'personal' ? 'ğŸ‘¤ ä¸ªäººä¿¡æ¯' :
                             panelType === 'inventory' ? 'ğŸ’ èƒŒåŒ…ä¿¡æ¯' : 'ğŸ“Š é¢æ¿ä¿¡æ¯'}</h3>
                        <button class="popup-close-btn">&times;</button>
                    </div>
                    <div class="popup-body">
                        ${dataHtml}
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const closeBtn = popup.querySelector('.popup-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    popup.remove();
                });
            }

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢„è§ˆä½ç½®
     */
    updatePreviewPosition(position) {
        try {
            console.log(`[InfoBarSettings] ğŸ“ æ›´æ–°é¢„è§ˆä½ç½®: ${position}`);

            const previewContainer = this.modal?.querySelector('.frontend-preview-container');
            if (previewContainer) {
                previewContainer.setAttribute('data-position', position);
                console.log(`[InfoBarSettings] âœ… é¢„è§ˆä½ç½®å·²æ›´æ–°ä¸º: ${position}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢„è§ˆä½ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢„è§ˆæ ·å¼
     */
    updatePreviewStyle(style) {
        try {
            console.log(`[InfoBarSettings] ğŸ¨ æ›´æ–°é¢„è§ˆæ ·å¼: ${style}`);

            const messageWrapper = this.modal?.querySelector('.ai-message-wrapper');
            if (messageWrapper) {
                // ç§»é™¤ç°æœ‰æ ·å¼ç±»
                messageWrapper.classList.remove('compact', 'comfortable', 'spacious');
                // æ·»åŠ æ–°æ ·å¼ç±»
                messageWrapper.classList.add(style);
                console.log(`[InfoBarSettings] âœ… é¢„è§ˆæ ·å¼å·²æ›´æ–°ä¸º: ${style}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢„è§ˆæ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢æ·»åŠ æŒ‰é’®æ˜¾ç¤º
     */
    toggleAddButtons(show) {
        try {
            console.log(`[InfoBarSettings] â• åˆ‡æ¢æ·»åŠ æŒ‰é’®: ${show ? 'æ˜¾ç¤º' : 'éšè—'}`);

            const addSlots = this.modal?.querySelectorAll('.add-panel-slots');
            if (addSlots) {
                addSlots.forEach(slot => {
                    slot.style.display = show ? 'flex' : 'none';
                });
                console.log(`[InfoBarSettings] âœ… æ·»åŠ æŒ‰é’®å·²${show ? 'æ˜¾ç¤º' : 'éšè—'}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ·»åŠ æŒ‰é’®å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
     */
    toggleAnimations(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ¬ åˆ‡æ¢åŠ¨ç”»æ•ˆæœ: ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

            const previewContainer = this.modal?.querySelector('.frontend-preview-container');
            if (previewContainer) {
                previewContainer.setAttribute('data-animations', enabled);
                console.log(`[InfoBarSettings] âœ… åŠ¨ç”»æ•ˆæœå·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢åŠ¨ç”»æ•ˆæœå¤±è´¥:', error);
        }
    }
    /**
     * è·å–å¯ç”¨çš„é¢æ¿é…ç½®
     */
    getEnabledPanels() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            const enabledPanels = {};

            // åŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            basicPanelIds.forEach(panelId => {
                if (configs[panelId]) {
                    const panel = configs[panelId];
                    // é»˜è®¤ä¸ºtrueï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse
                    const isEnabled = panel.enabled !== false;

                    if (isEnabled) {
                        enabledPanels[panelId] = panel;
                    }
                }
            });

            // è‡ªå®šä¹‰é¢æ¿
            if (configs.customPanels) {
                Object.entries(configs.customPanels).forEach(([panelId, panelConfig]) => {
                    if (panelConfig && panelConfig.enabled) {
                        enabledPanels[panelId] = panelConfig;
                    }
                });
            }

            return enabledPanels;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨é¢æ¿å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * ç”Ÿæˆé¢æ¿åˆ—è¡¨HTML
     */
    generatePanelListHtml(enabledPanels) {
        try {
            const panelItems = [];
            let isFirst = true;

            for (const [panelId, panelConfig] of Object.entries(enabledPanels)) {
                // è·å–é¢æ¿æ˜¾ç¤ºä¿¡æ¯
                const panelInfo = this.getPanelDisplayInfo(panelId, panelConfig);

                panelItems.push(`
                    <div class="panel-nav-item ${isFirst ? 'active' : ''}" data-panel="${panelId}">
                        <span class="panel-name">${panelInfo.name}</span>
                        <button class="add-panel-btn" title="æ·»åŠ é¢æ¿">â•</button>
                    </div>
                `);

                isFirst = false;
            }

            return panelItems.join('');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆé¢æ¿åˆ—è¡¨HTMLå¤±è´¥:', error);
            return '';
        }
    }

    /**
     * ç”Ÿæˆå­é¡¹åˆ—è¡¨HTML
     */
    generateSubitemListHtml(panelId, panelConfig) {
        try {
            const panelInfo = this.getPanelDisplayInfo(panelId, panelConfig);
            const subItems = this.getEnabledSubItems(panelId, panelConfig);

            const subItemsHtml = subItems.map(subItem => `
                <div class="subitem-item" data-field="${subItem.key}">
                    <span class="subitem-label">${subItem.displayName}</span>
                    <button class="add-subitem-btn" title="æ·»åŠ å­é¡¹">â•</button>
                </div>
            `).join('');

            return `
                <h4>ğŸ”§ ${panelInfo.name} - å¯ç”¨çš„å­é¡¹ (${subItems.length})</h4>
                <div class="subitem-content">
                    ${subItemsHtml || '<div class="no-subitems">è¯¥é¢æ¿æ²¡æœ‰å¯ç”¨çš„å­é¡¹</div>'}
                </div>
            `;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆå­é¡¹åˆ—è¡¨HTMLå¤±è´¥:', error);
            return '<h4>é”™è¯¯ï¼šæ— æ³•åŠ è½½å­é¡¹</h4><div class="subitem-content"></div>';
        }
    }

    /**
     * è·å–é¢æ¿æ˜¾ç¤ºä¿¡æ¯ï¼ˆå›¾æ ‡å’Œåç§°ï¼‰
     */
    getPanelDisplayInfo(panelId, panelConfig) {
        // åŸºç¡€é¢æ¿çš„é»˜è®¤é…ç½®
        const basicPanelInfo = {
            personal: { icon: 'ğŸ‘¤', name: 'ä¸ªäººä¿¡æ¯' },
            world: { icon: 'ğŸŒ', name: 'ä¸–ç•Œä¿¡æ¯' },
            interaction: { icon: 'ğŸ¤', name: 'äº¤äº’å¯¹è±¡' },
            tasks: { icon: 'ğŸ“‹', name: 'ä»»åŠ¡ä¿¡æ¯' },
            organization: { icon: 'ğŸ¢', name: 'ç»„ç»‡ä¿¡æ¯' },
            news: { icon: 'ğŸ“°', name: 'æ–°é—»äº‹ä»¶' },
            inventory: { icon: 'ğŸ’', name: 'èƒŒåŒ…ç‰©å“' },
            abilities: { icon: 'âš¡', name: 'èƒ½åŠ›æŠ€èƒ½' },
            plot: { icon: 'ğŸ“–', name: 'å‰§æƒ…ä¿¡æ¯' },
            cultivation: { icon: 'ğŸ§˜', name: 'ä¿®ç‚¼ä¿¡æ¯' },
            fantasy: { icon: 'ğŸ‰', name: 'å¥‡å¹»è®¾å®š' },
            modern: { icon: 'ğŸ™ï¸', name: 'ç°ä»£è®¾å®š' },
            historical: { icon: 'ğŸ›ï¸', name: 'å†å²è®¾å®š' },
            magic: { icon: 'ğŸ”®', name: 'é­”æ³•ç³»ç»Ÿ' },
            training: { icon: 'ğŸ¯', name: 'è®­ç»ƒä¿¡æ¯' }
        };

        // å¦‚æœæ˜¯åŸºç¡€é¢æ¿ï¼Œä½¿ç”¨é¢„è®¾ä¿¡æ¯
        if (basicPanelInfo[panelId]) {
            return basicPanelInfo[panelId];
        }

        // è‡ªå®šä¹‰é¢æ¿ä½¿ç”¨é…ç½®ä¸­çš„ä¿¡æ¯
        return {
            icon: panelConfig.icon || 'ğŸ“„',
            name: panelConfig.name || panelId
        };
    }

    /**
     * è·å–é¢æ¿çš„å¯ç”¨å­é¡¹
     */
    getEnabledSubItems(panelId, panelConfig) {
        try {
            const subItems = [];

            // åˆ¤æ–­æ˜¯å¦ä¸ºåŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            if (basicPanelIds.includes(panelId)) {
                // åŸºç¡€é¢æ¿ï¼šå¤„ç†åŸºç¡€è®¾ç½®ä¸­çš„å¤é€‰æ¡†é…ç½®ï¼ˆpanel[key].enabledæ ¼å¼ï¼‰
                const subItemKeys = Object.keys(panelConfig).filter(key =>
                    key !== 'enabled' &&
                    key !== 'subItems' &&     // æ’é™¤è‡ªå®šä¹‰å­é¡¹æ•°ç»„
                    key !== 'description' &&  // æ’é™¤é¢æ¿å±æ€§
                    key !== 'icon' &&
                    key !== 'required' &&
                    key !== 'memoryInject' &&
                    key !== 'prompts' &&
                    typeof panelConfig[key] === 'object' &&
                    panelConfig[key].enabled !== undefined
                );

                const enabledSubItems = subItemKeys.filter(key => panelConfig[key].enabled === true);

                // æ·»åŠ åŸºç¡€è®¾ç½®çš„å­é¡¹
                enabledSubItems.forEach(key => {
                    subItems.push({
                        key: key,
                        displayName: panelConfig[key].name || this.getBasicSubItemDisplayName(panelId, key),
                        source: 'basicSettings'
                    });
                });

                // å¤„ç†åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼ˆä»é¢æ¿ç®¡ç†æ·»åŠ çš„ï¼‰
                if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.enabled !== false) {
                            subItems.push({
                                key: subItem.key,
                                displayName: subItem.displayName || subItem.name,
                                source: 'panelManagement'
                            });
                        }
                    });
                }
            } else {
                // è‡ªå®šä¹‰é¢æ¿ï¼šå¤„ç†è‡ªå®šä¹‰é¢æ¿çš„å­é¡¹
                if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.enabled !== false) {
                            subItems.push({
                                key: subItem.key,
                                displayName: subItem.displayName || subItem.name || subItem.key,
                                source: 'customPanel'
                            });
                        }
                    });
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š é¢æ¿ ${panelId}: ${subItems.length} ä¸ªå¯ç”¨çš„å­é¡¹`, subItems.map(s => `${s.displayName}(${s.source})`));
            return subItems;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨å­é¡¹å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * è·å–åŸºç¡€å­é¡¹æ˜¾ç¤ºåç§° - ä¸æ•°æ®è¡¨æ ¼å®Œå…¨ä¸€è‡´çš„å®Œæ•´æ˜ å°„
     */
    getBasicSubItemDisplayName(panelId, key) {
        // ä¸DataTable.jså®Œå…¨ä¸€è‡´çš„å®Œæ•´ä¸­æ–‡æ˜ å°„è¡¨
        return this.getDataTableDisplayName(panelId, key);
    }

    /**
     * è·å–æ•°æ®è¡¨æ ¼æ˜¾ç¤ºåç§° - å®Œæ•´çš„ä¸­æ–‡æ˜ å°„å®ç°
     */
    getDataTableDisplayName(panelType, key) {
        const displayNames = this.getCompleteDisplayNameMapping();
        return displayNames[panelType]?.[key] || key;
    }

    /**
     * é¢„åŠ è½½å®Œæ•´çš„æ˜¾ç¤ºåç§°æ˜ å°„è¡¨ - ğŸ”§ æ–°å¢ï¼šé¿å…è¿è¡Œæ—¶é‡å¤ç”Ÿæˆ
     */
    preloadCompleteDisplayNameMapping() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ é¢„åŠ è½½å­—æ®µæ˜ å°„ç¼“å­˜...');
            this.getCompleteDisplayNameMapping();
            console.log('[InfoBarSettings] âœ… å­—æ®µæ˜ å°„ç¼“å­˜é¢„åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ é¢„åŠ è½½å­—æ®µæ˜ å°„ç¼“å­˜å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å®Œæ•´çš„æ˜¾ç¤ºåç§°æ˜ å°„è¡¨ - ğŸ”§ ä¿®å¤ï¼šåŒæ—¶æ”¯æŒè‹±æ–‡å’Œä¸­æ–‡å­—æ®µåæ˜ å°„
     */
    getCompleteDisplayNameMapping() {
        // ğŸ”§ æ–°å¢ï¼šç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤ç”Ÿæˆæ˜ å°„
        if (this._cachedCompleteMapping) {
            return this._cachedCompleteMapping;
        }

        // åŸºç¡€é¢æ¿æ˜ å°„
        const baseMapping = {
            personal: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å§“å', 'age': 'å¹´é¾„', 'gender': 'æ€§åˆ«', 'occupation': 'èŒä¸š',
                'height': 'èº«é«˜', 'weight': 'ä½“é‡', 'bloodType': 'è¡€å‹', 'zodiac': 'æ˜Ÿåº§',
                'birthday': 'ç”Ÿæ—¥', 'birthplace': 'å‡ºç”Ÿåœ°', 'nationality': 'å›½ç±', 'ethnicity': 'æ°‘æ—',
                'hairColor': 'å‘è‰²', 'hairStyle': 'å‘å‹', 'eyeColor': 'çœ¼è‰²', 'skinColor': 'è‚¤è‰²',
                'bodyType': 'ä½“å‹', 'facialFeatures': 'é¢éƒ¨ç‰¹å¾', 'scars': 'ç–¤ç—•', 'tattoos': 'çº¹èº«',
                'accessories': 'é…é¥°', 'clothingStyle': 'ç©¿ç€é£æ ¼', 'appearance': 'å¤–è²Œ', 'voice': 'å£°éŸ³',
                'personality': 'æ€§æ ¼', 'temperament': 'æ€§æƒ…', 'attitude': 'æ€åº¦', 'values': 'ä»·å€¼è§‚',
                'beliefs': 'ä¿¡å¿µ', 'fears': 'ææƒ§', 'dreams': 'æ¢¦æƒ³', 'goals': 'äººç”Ÿç›®æ ‡',
                'intelligence': 'æ™ºåŠ›', 'strength': 'åŠ›é‡', 'charisma': 'é­…åŠ›', 'luck': 'è¿æ°”',
                'perception': 'æ„ŸçŸ¥', 'willpower': 'æ„å¿—åŠ›', 'reactionSpeed': 'ååº”é€Ÿåº¦', 'learningAbility': 'å­¦ä¹ èƒ½åŠ›',
                'familyBackground': 'å®¶åº­èƒŒæ™¯', 'education': 'æ•™è‚²ç»å†', 'workExperience': 'å·¥ä½œç»å†', 'income': 'æ”¶å…¥',
                'socialStatus': 'ç¤¾ä¼šåœ°ä½', 'relationships': 'äººé™…å…³ç³»', 'loveStatus': 'æ‹çˆ±çŠ¶æ€', 'maritalStatus': 'å©šå§»çŠ¶æ€',
                'hobbies': 'çˆ±å¥½', 'sports': 'è¿åŠ¨', 'music': 'éŸ³ä¹', 'art': 'è‰ºæœ¯',
                'reading': 'é˜…è¯»', 'gaming': 'æ¸¸æˆ', 'travel': 'æ—…è¡Œ', 'cooking': 'çƒ¹é¥ª',
                'skills': 'æŠ€èƒ½ç‰¹é•¿', 'languages': 'è¯­è¨€èƒ½åŠ›', 'habits': 'ç”Ÿæ´»ä¹ æƒ¯', 'healthStatus': 'å¥åº·çŠ¶æ€',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å§“å': 'å§“å', 'å¹´é¾„': 'å¹´é¾„', 'æ€§åˆ«': 'æ€§åˆ«', 'èŒä¸š': 'èŒä¸š',
                'èº«é«˜': 'èº«é«˜', 'ä½“é‡': 'ä½“é‡', 'è¡€å‹': 'è¡€å‹', 'æ˜Ÿåº§': 'æ˜Ÿåº§',
                'ç”Ÿæ—¥': 'ç”Ÿæ—¥', 'å‡ºç”Ÿåœ°': 'å‡ºç”Ÿåœ°', 'å›½ç±': 'å›½ç±', 'æ°‘æ—': 'æ°‘æ—',
                'å‘è‰²': 'å‘è‰²', 'å‘å‹': 'å‘å‹', 'çœ¼è‰²': 'çœ¼è‰²', 'è‚¤è‰²': 'è‚¤è‰²',
                'ä½“å‹': 'ä½“å‹', 'é¢éƒ¨ç‰¹å¾': 'é¢éƒ¨ç‰¹å¾', 'ç–¤ç—•': 'ç–¤ç—•', 'çº¹èº«': 'çº¹èº«',
                'é…é¥°': 'é…é¥°', 'ç©¿ç€é£æ ¼': 'ç©¿ç€é£æ ¼', 'å¤–è²Œ': 'å¤–è²Œ', 'å£°éŸ³': 'å£°éŸ³',
                'æ€§æ ¼': 'æ€§æ ¼', 'æ€§æƒ…': 'æ€§æƒ…', 'æ€åº¦': 'æ€åº¦', 'ä»·å€¼è§‚': 'ä»·å€¼è§‚',
                'ä¿¡å¿µ': 'ä¿¡å¿µ', 'ææƒ§': 'ææƒ§', 'æ¢¦æƒ³': 'æ¢¦æƒ³', 'äººç”Ÿç›®æ ‡': 'äººç”Ÿç›®æ ‡',
                'æ™ºåŠ›': 'æ™ºåŠ›', 'åŠ›é‡': 'åŠ›é‡', 'é­…åŠ›': 'é­…åŠ›', 'è¿æ°”': 'è¿æ°”',
                'æ„ŸçŸ¥': 'æ„ŸçŸ¥', 'æ„å¿—åŠ›': 'æ„å¿—åŠ›', 'ååº”é€Ÿåº¦': 'ååº”é€Ÿåº¦', 'å­¦ä¹ èƒ½åŠ›': 'å­¦ä¹ èƒ½åŠ›',
                'å®¶åº­èƒŒæ™¯': 'å®¶åº­èƒŒæ™¯', 'æ•™è‚²ç»å†': 'æ•™è‚²ç»å†', 'å·¥ä½œç»å†': 'å·¥ä½œç»å†', 'æ”¶å…¥': 'æ”¶å…¥',
                'ç¤¾ä¼šåœ°ä½': 'ç¤¾ä¼šåœ°ä½', 'äººé™…å…³ç³»': 'äººé™…å…³ç³»', 'æ‹çˆ±çŠ¶æ€': 'æ‹çˆ±çŠ¶æ€', 'å©šå§»çŠ¶æ€': 'å©šå§»çŠ¶æ€',
                'çˆ±å¥½': 'çˆ±å¥½', 'è¿åŠ¨': 'è¿åŠ¨', 'éŸ³ä¹': 'éŸ³ä¹', 'è‰ºæœ¯': 'è‰ºæœ¯',
                'é˜…è¯»': 'é˜…è¯»', 'æ¸¸æˆ': 'æ¸¸æˆ', 'æ—…è¡Œ': 'æ—…è¡Œ', 'çƒ¹é¥ª': 'çƒ¹é¥ª',
                'æŠ€èƒ½ç‰¹é•¿': 'æŠ€èƒ½ç‰¹é•¿', 'è¯­è¨€èƒ½åŠ›': 'è¯­è¨€èƒ½åŠ›', 'ç”Ÿæ´»ä¹ æƒ¯': 'ç”Ÿæ´»ä¹ æƒ¯', 'å¥åº·çŠ¶æ€': 'å¥åº·çŠ¶æ€',
                'ç§æ—': 'ç§æ—', 'èŒä¸šç±»åˆ«': 'èŒä¸šç±»åˆ«'
            },
            world: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ä¸–ç•Œåç§°', 'type': 'ä¸–ç•Œç±»å‹', 'genre': 'ä¸–ç•Œé£æ ¼', 'theme': 'ä¸–ç•Œä¸»é¢˜',
                'history': 'ä¸–ç•Œå†å²', 'mythology': 'ç¥è¯ä¼ è¯´', 'lore': 'ä¸–ç•Œè®¾å®š',
                'geography': 'åœ°ç†ç¯å¢ƒ', 'climate': 'æ°”å€™æ¡ä»¶', 'terrain': 'åœ°å½¢åœ°è²Œ', 'biomes': 'ç”Ÿç‰©ç¾¤è½',
                'locations': 'é‡è¦åœ°ç‚¹', 'landmarks': 'åœ°æ ‡å»ºç­‘', 'cities': 'åŸå¸‚è®¾å®š', 'dungeons': 'åœ°ä¸‹åŸ',
                'time': 'æ—¶é—´è®¾å®š', 'calendar': 'å†æ³•ç³»ç»Ÿ', 'seasons': 'å­£èŠ‚å˜åŒ–', 'dayNight': 'æ˜¼å¤œå¾ªç¯',
                'weather': 'å¤©æ°”ç³»ç»Ÿ', 'events': 'ä¸–ç•Œäº‹ä»¶', 'festivals': 'èŠ‚æ—¥åº†å…¸', 'disasters': 'è‡ªç„¶ç¾å®³',
                'cultures': 'æ–‡åŒ–è®¾å®š', 'languages': 'è¯­è¨€ç³»ç»Ÿ', 'religions': 'å®—æ•™ä¿¡ä»°', 'customs': 'é£ä¿—ä¹ æƒ¯',
                'politics': 'æ”¿æ²»ä½“ç³»', 'economy': 'ç»æµç³»ç»Ÿ', 'technology': 'ç§‘æŠ€æ°´å¹³', 'magic': 'é­”æ³•ç³»ç»Ÿ',
                'races': 'ç§æ—è®¾å®š', 'creatures': 'ç”Ÿç‰©è®¾å®š', 'monsters': 'æ€ªç‰©è®¾å®š', 'npcs': 'NPCè®¾å®š',
                'factions': 'åŠ¿åŠ›ç»„ç»‡', 'conflicts': 'å†²çªçŸ›ç›¾', 'alliances': 'è”ç›Ÿå…³ç³»', 'wars': 'æˆ˜äº‰å†å²',
                'resources': 'èµ„æºåˆ†å¸ƒ', 'materials': 'ææ–™è®¾å®š', 'artifacts': 'ç¥å™¨æ–‡ç‰©', 'currency': 'è´§å¸ç³»ç»Ÿ',
                'trade': 'è´¸æ˜“ä½“ç³»', 'markets': 'å¸‚åœºè®¾å®š', 'guilds': 'å…¬ä¼šç»„ç»‡', 'transportation': 'äº¤é€šè¿è¾“',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸–ç•Œåç§°': 'ä¸–ç•Œåç§°', 'ä¸–ç•Œç±»å‹': 'ä¸–ç•Œç±»å‹', 'ä¸–ç•Œé£æ ¼': 'ä¸–ç•Œé£æ ¼', 'ä¸–ç•Œä¸»é¢˜': 'ä¸–ç•Œä¸»é¢˜',
                'ä¸–ç•Œæè¿°': 'ä¸–ç•Œæè¿°', 'ä¸–ç•Œå†å²': 'ä¸–ç•Œå†å²', 'ç¥è¯ä¼ è¯´': 'ç¥è¯ä¼ è¯´', 'ä¸–ç•Œè®¾å®š': 'ä¸–ç•Œè®¾å®š',
                'åœ°ç†ç¯å¢ƒ': 'åœ°ç†ç¯å¢ƒ', 'æ°”å€™æ¡ä»¶': 'æ°”å€™æ¡ä»¶', 'åœ°å½¢åœ°è²Œ': 'åœ°å½¢åœ°è²Œ', 'ç”Ÿç‰©ç¾¤è½': 'ç”Ÿç‰©ç¾¤è½',
                'é‡è¦åœ°ç‚¹': 'é‡è¦åœ°ç‚¹', 'åœ°æ ‡å»ºç­‘': 'åœ°æ ‡å»ºç­‘', 'åŸå¸‚è®¾å®š': 'åŸå¸‚è®¾å®š', 'åœ°ä¸‹åŸ': 'åœ°ä¸‹åŸ',
                'æ—¶é—´è®¾å®š': 'æ—¶é—´è®¾å®š', 'å†æ³•ç³»ç»Ÿ': 'å†æ³•ç³»ç»Ÿ', 'å­£èŠ‚å˜åŒ–': 'å­£èŠ‚å˜åŒ–', 'æ˜¼å¤œå¾ªç¯': 'æ˜¼å¤œå¾ªç¯',
                'å¤©æ°”ç³»ç»Ÿ': 'å¤©æ°”ç³»ç»Ÿ', 'ä¸–ç•Œäº‹ä»¶': 'ä¸–ç•Œäº‹ä»¶', 'èŠ‚æ—¥åº†å…¸': 'èŠ‚æ—¥åº†å…¸', 'è‡ªç„¶ç¾å®³': 'è‡ªç„¶ç¾å®³',
                'æ–‡åŒ–è®¾å®š': 'æ–‡åŒ–è®¾å®š', 'è¯­è¨€ç³»ç»Ÿ': 'è¯­è¨€ç³»ç»Ÿ', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'é£ä¿—ä¹ æƒ¯': 'é£ä¿—ä¹ æƒ¯',
                'æ”¿æ²»ä½“ç³»': 'æ”¿æ²»ä½“ç³»', 'ç»æµç³»ç»Ÿ': 'ç»æµç³»ç»Ÿ', 'ç§‘æŠ€æ°´å¹³': 'ç§‘æŠ€æ°´å¹³', 'é­”æ³•ç³»ç»Ÿ': 'é­”æ³•ç³»ç»Ÿ',
                'ç§æ—è®¾å®š': 'ç§æ—è®¾å®š', 'ç”Ÿç‰©è®¾å®š': 'ç”Ÿç‰©è®¾å®š', 'æ€ªç‰©è®¾å®š': 'æ€ªç‰©è®¾å®š', 'NPCè®¾å®š': 'NPCè®¾å®š',
                'åŠ¿åŠ›ç»„ç»‡': 'åŠ¿åŠ›ç»„ç»‡', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾', 'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'æˆ˜äº‰å†å²': 'æˆ˜äº‰å†å²',
                'èµ„æºåˆ†å¸ƒ': 'èµ„æºåˆ†å¸ƒ', 'ææ–™è®¾å®š': 'ææ–™è®¾å®š', 'ç¥å™¨æ–‡ç‰©': 'ç¥å™¨æ–‡ç‰©', 'è´§å¸ç³»ç»Ÿ': 'è´§å¸ç³»ç»Ÿ',
                'è´¸æ˜“ä½“ç³»': 'è´¸æ˜“ä½“ç³»', 'å¸‚åœºè®¾å®š': 'å¸‚åœºè®¾å®š', 'å…¬ä¼šç»„ç»‡': 'å…¬ä¼šç»„ç»‡', 'äº¤é€šè¿è¾“': 'äº¤é€šè¿è¾“',
                'ä½ç½®': 'ä½ç½®', 'ç¯å¢ƒ': 'ç¯å¢ƒ', 'æ°›å›´': 'æ°›å›´', 'å­£èŠ‚': 'å­£èŠ‚',
                'æ–‡åŒ–': 'æ–‡åŒ–'
            },
            interaction: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å¯¹è±¡åç§°', 'type': 'å¯¹è±¡ç±»å‹', 'status': 'å½“å‰çŠ¶æ€', 'location': 'æ‰€åœ¨ä½ç½®',
                'mood': 'æƒ…ç»ªçŠ¶æ€', 'activity': 'å½“å‰æ´»åŠ¨', 'availability': 'å¯ç”¨æ€§', 'priority': 'ä¼˜å…ˆçº§',
                'relationship': 'å…³ç³»ç±»å‹', 'intimacy': 'äº²å¯†åº¦', 'trust': 'ä¿¡ä»»åº¦', 'friendship': 'å‹è°Šåº¦',
                'romance': 'æµªæ¼«åº¦', 'respect': 'å°Šé‡åº¦', 'dependency': 'ä¾èµ–åº¦', 'conflict': 'å†²çªåº¦',
                'history': 'å†å²è®°å½•', 'frequency': 'äº’åŠ¨é¢‘ç‡', 'duration': 'äº’åŠ¨æ—¶é•¿', 'quality': 'äº’åŠ¨è´¨é‡',
                'topics': 'è¯é¢˜åå¥½', 'emotions': 'æƒ…æ„ŸçŠ¶æ€', 'milestones': 'é‡è¦èŠ‚ç‚¹', 'memories': 'å…±åŒå›å¿†',
                'autoRecord': 'è‡ªåŠ¨è®°å½•', 'notifications': 'é€šçŸ¥è®¾ç½®', 'analysis': 'å…³ç³»åˆ†æ', 'suggestions': 'å»ºè®®æç¤º',
                'network': 'ç¤¾äº¤ç½‘ç»œ', 'groups': 'ç¾¤ä½“å…³ç³»', 'influence': 'å½±å“åŠ›', 'reputation': 'å£°èª‰åº¦',
                'alliances': 'è”ç›Ÿå…³ç³»', 'rivalries': 'ç«äº‰å…³ç³»', 'mentorship': 'å¸ˆå¾’å…³ç³»', 'hierarchy': 'ç­‰çº§å…³ç³»',
                'communicationStyle': 'æ²Ÿé€šé£æ ¼', 'preferredTopics': 'åå¥½è¯é¢˜', 'avoidedTopics': 'å›é¿è¯é¢˜', 'boundaries': 'è¾¹ç•Œè®¾å®š',
                'comfortLevel': 'èˆ’é€‚åº¦', 'energyLevel': 'æ´»è·ƒåº¦', 'responseTime': 'å“åº”æ—¶é—´', 'engagement': 'å‚ä¸åº¦',
                'specialEvents': 'ç‰¹æ®Šäº‹ä»¶', 'achievements': 'æˆå°±è®°å½•', 'challenges': 'æŒ‘æˆ˜ä»»åŠ¡', 'growth': 'æˆé•¿è½¨è¿¹',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¯¹è±¡åç§°': 'å¯¹è±¡åç§°', 'å¯¹è±¡ç±»å‹': 'å¯¹è±¡ç±»å‹', 'å½“å‰çŠ¶æ€': 'å½“å‰çŠ¶æ€', 'æ‰€åœ¨ä½ç½®': 'æ‰€åœ¨ä½ç½®',
                'æƒ…ç»ªçŠ¶æ€': 'æƒ…ç»ªçŠ¶æ€', 'å½“å‰æ´»åŠ¨': 'å½“å‰æ´»åŠ¨', 'å¯ç”¨æ€§': 'å¯ç”¨æ€§', 'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§',
                'å…³ç³»ç±»å‹': 'å…³ç³»ç±»å‹', 'äº²å¯†åº¦': 'äº²å¯†åº¦', 'ä¿¡ä»»åº¦': 'ä¿¡ä»»åº¦', 'å‹è°Šåº¦': 'å‹è°Šåº¦',
                'æµªæ¼«åº¦': 'æµªæ¼«åº¦', 'å°Šé‡åº¦': 'å°Šé‡åº¦', 'ä¾èµ–åº¦': 'ä¾èµ–åº¦', 'å†²çªåº¦': 'å†²çªåº¦',
                'å†å²è®°å½•': 'å†å²è®°å½•', 'äº’åŠ¨é¢‘ç‡': 'äº’åŠ¨é¢‘ç‡', 'äº’åŠ¨æ—¶é•¿': 'äº’åŠ¨æ—¶é•¿', 'äº’åŠ¨è´¨é‡': 'äº’åŠ¨è´¨é‡',
                'è¯é¢˜åå¥½': 'è¯é¢˜åå¥½', 'æƒ…æ„ŸçŠ¶æ€': 'æƒ…æ„ŸçŠ¶æ€', 'é‡è¦èŠ‚ç‚¹': 'é‡è¦èŠ‚ç‚¹', 'å…±åŒå›å¿†': 'å…±åŒå›å¿†',
                'è‡ªåŠ¨è®°å½•': 'è‡ªåŠ¨è®°å½•', 'é€šçŸ¥è®¾ç½®': 'é€šçŸ¥è®¾ç½®', 'å…³ç³»åˆ†æ': 'å…³ç³»åˆ†æ', 'å»ºè®®æç¤º': 'å»ºè®®æç¤º',
                'ç¤¾äº¤ç½‘ç»œ': 'ç¤¾äº¤ç½‘ç»œ', 'ç¾¤ä½“å…³ç³»': 'ç¾¤ä½“å…³ç³»', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å£°èª‰åº¦': 'å£°èª‰åº¦',
                'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'ç«äº‰å…³ç³»': 'ç«äº‰å…³ç³»', 'å¸ˆå¾’å…³ç³»': 'å¸ˆå¾’å…³ç³»', 'ç­‰çº§å…³ç³»': 'ç­‰çº§å…³ç³»',
                'æ²Ÿé€šé£æ ¼': 'æ²Ÿé€šé£æ ¼', 'åå¥½è¯é¢˜': 'åå¥½è¯é¢˜', 'å›é¿è¯é¢˜': 'å›é¿è¯é¢˜', 'è¾¹ç•Œè®¾å®š': 'è¾¹ç•Œè®¾å®š',
                'èˆ’é€‚åº¦': 'èˆ’é€‚åº¦', 'æ´»è·ƒåº¦': 'æ´»è·ƒåº¦', 'å“åº”æ—¶é—´': 'å“åº”æ—¶é—´', 'å‚ä¸åº¦': 'å‚ä¸åº¦',
                'ç‰¹æ®Šäº‹ä»¶': 'ç‰¹æ®Šäº‹ä»¶', 'æˆå°±è®°å½•': 'æˆå°±è®°å½•', 'æŒ‘æˆ˜ä»»åŠ¡': 'æŒ‘æˆ˜ä»»åŠ¡', 'æˆé•¿è½¨è¿¹': 'æˆé•¿è½¨è¿¹',
                'NPCå§“å': 'NPCå§“å', 'NPCæ€§æ ¼': 'NPCæ€§æ ¼', 'NPCçŠ¶æ€': 'NPCçŠ¶æ€',
                'æ€åº¦': 'æ€åº¦', 'å¯¹è¯ä¸»é¢˜': 'å¯¹è¯ä¸»é¢˜', 'äº¤äº’å†å²': 'äº¤äº’å†å²',
                'å¥½æ„Ÿåº¦': 'å¥½æ„Ÿåº¦', 'ç¤¾äº¤èƒŒæ™¯': 'ç¤¾äº¤èƒŒæ™¯'
            },
            tasks: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'creation': 'ä»»åŠ¡åˆ›å»º', 'editing': 'ä»»åŠ¡ç¼–è¾‘', 'deletion': 'ä»»åŠ¡åˆ é™¤', 'completion': 'ä»»åŠ¡å®Œæˆ',
                'priority': 'ä¼˜å…ˆçº§', 'deadline': 'æˆªæ­¢æ—¥æœŸ', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'status': 'çŠ¶æ€ç®¡ç†',
                'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ', 'projects': 'é¡¹ç›®ç®¡ç†', 'milestones': 'é‡Œç¨‹ç¢‘',
                'subtasks': 'å­ä»»åŠ¡', 'dependencies': 'ä¾èµ–å…³ç³»', 'templates': 'ä»»åŠ¡æ¨¡æ¿', 'recurring': 'é‡å¤ä»»åŠ¡',
                'notifications': 'é€šçŸ¥æé†’', 'reminders': 'æé†’è®¾ç½®', 'alerts': 'è­¦æŠ¥é€šçŸ¥', 'dailySummary': 'æ¯æ—¥æ€»ç»“',
                'weeklyReview': 'å‘¨æŠ¥å›é¡¾', 'achievementBadges': 'æˆå°±å¾½ç« ', 'productivityStats': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'timeTracking': 'æ—¶é—´è·Ÿè¸ª',
                'assignment': 'ä»»åŠ¡åˆ†é…', 'collaboration': 'åä½œåŠŸèƒ½', 'comments': 'è¯„è®ºç³»ç»Ÿ', 'attachments': 'é™„ä»¶ç®¡ç†',
                'sharing': 'å…±äº«åŠŸèƒ½', 'permissions': 'æƒé™ç®¡ç†', 'approval': 'å®¡æ‰¹æµç¨‹', 'delegation': 'ä»»åŠ¡å§”æ´¾',
                'listView': 'åˆ—è¡¨è§†å›¾', 'kanbanView': 'çœ‹æ¿è§†å›¾', 'calendarView': 'æ—¥å†è§†å›¾', 'ganttView': 'ç”˜ç‰¹å›¾',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'search': 'æœç´¢åŠŸèƒ½', 'grouping': 'åˆ†ç»„åŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',
                'archive': 'å½’æ¡£ç®¡ç†', 'history': 'å†å²è®°å½•', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶', 'recovery': 'æ¢å¤åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä»»åŠ¡åˆ›å»º': 'ä»»åŠ¡åˆ›å»º', 'ä»»åŠ¡ç¼–è¾‘': 'ä»»åŠ¡ç¼–è¾‘', 'ä»»åŠ¡åˆ é™¤': 'ä»»åŠ¡åˆ é™¤', 'ä»»åŠ¡å®Œæˆ': 'ä»»åŠ¡å®Œæˆ',
                'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§', 'æˆªæ­¢æ—¥æœŸ': 'æˆªæ­¢æ—¥æœŸ', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'çŠ¶æ€ç®¡ç†': 'çŠ¶æ€ç®¡ç†',
                'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ', 'é¡¹ç›®ç®¡ç†': 'é¡¹ç›®ç®¡ç†', 'é‡Œç¨‹ç¢‘': 'é‡Œç¨‹ç¢‘',
                'å­ä»»åŠ¡': 'å­ä»»åŠ¡', 'ä¾èµ–å…³ç³»': 'ä¾èµ–å…³ç³»', 'ä»»åŠ¡æ¨¡æ¿': 'ä»»åŠ¡æ¨¡æ¿', 'é‡å¤ä»»åŠ¡': 'é‡å¤ä»»åŠ¡',
                'é€šçŸ¥æé†’': 'é€šçŸ¥æé†’', 'æé†’è®¾ç½®': 'æé†’è®¾ç½®', 'è­¦æŠ¥é€šçŸ¥': 'è­¦æŠ¥é€šçŸ¥', 'æ¯æ—¥æ€»ç»“': 'æ¯æ—¥æ€»ç»“',
                'å‘¨æŠ¥å›é¡¾': 'å‘¨æŠ¥å›é¡¾', 'æˆå°±å¾½ç« ': 'æˆå°±å¾½ç« ', 'ç”Ÿäº§åŠ›ç»Ÿè®¡': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'æ—¶é—´è·Ÿè¸ª': 'æ—¶é—´è·Ÿè¸ª',
                'ä»»åŠ¡åˆ†é…': 'ä»»åŠ¡åˆ†é…', 'åä½œåŠŸèƒ½': 'åä½œåŠŸèƒ½', 'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'é™„ä»¶ç®¡ç†': 'é™„ä»¶ç®¡ç†',
                'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'æƒé™ç®¡ç†': 'æƒé™ç®¡ç†', 'å®¡æ‰¹æµç¨‹': 'å®¡æ‰¹æµç¨‹', 'ä»»åŠ¡å§”æ´¾': 'ä»»åŠ¡å§”æ´¾',
                'åˆ—è¡¨è§†å›¾': 'åˆ—è¡¨è§†å›¾', 'çœ‹æ¿è§†å›¾': 'çœ‹æ¿è§†å›¾', 'æ—¥å†è§†å›¾': 'æ—¥å†è§†å›¾', 'ç”˜ç‰¹å›¾': 'ç”˜ç‰¹å›¾',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'æœç´¢åŠŸèƒ½': 'æœç´¢åŠŸèƒ½', 'åˆ†ç»„åŠŸèƒ½': 'åˆ†ç»„åŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½',
                'å½’æ¡£ç®¡ç†': 'å½’æ¡£ç®¡ç†', 'å†å²è®°å½•': 'å†å²è®°å½•', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶', 'æ¢å¤åŠŸèƒ½': 'æ¢å¤åŠŸèƒ½'
            },
            organization: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ç»„ç»‡åç§°', 'type': 'ç»„ç»‡ç±»å‹', 'purpose': 'ç»„ç»‡æè¿°', 'history': 'ç»„ç»‡å†å²',
                'founding': 'æˆç«‹èƒŒæ™¯', 'motto': 'ç»„ç»‡æ ¼è¨€', 'values': 'æ ¸å¿ƒä»·å€¼',
                'hierarchy': 'å±‚çº§ç»“æ„', 'departments': 'éƒ¨é—¨è®¾ç½®', 'leadership': 'é¢†å¯¼å±‚', 'council': 'ç†äº‹ä¼š',
                'positions': 'èŒä½è®¾ç½®', 'ranks': 'ç­‰çº§åˆ¶åº¦', 'promotion': 'æ™‹å‡æœºåˆ¶', 'authority': 'æƒé™åˆ†é…',
                'members': 'æˆå‘˜ç®¡ç†', 'recruitment': 'æ‹›å‹Ÿåˆ¶åº¦', 'training': 'åŸ¹è®­ä½“ç³»', 'evaluation': 'è€ƒæ ¸è¯„ä¼°',
                'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šåˆ¶åº¦', 'benefits': 'ç¦åˆ©å¾…é‡', 'retirement': 'é€€ä¼‘åˆ¶åº¦',
                'rules': 'ç»„ç»‡è§„åˆ™', 'code': 'è¡Œä¸ºå‡†åˆ™', 'ethics': 'é“å¾·è§„èŒƒ', 'discipline': 'çºªå¾‹åˆ¶åº¦',
                'procedures': 'æ“ä½œæµç¨‹', 'protocols': 'åè®®è§„èŒƒ', 'standards': 'æ ‡å‡†åˆ¶åº¦', 'compliance': 'åˆè§„ç®¡ç†',
                'allies': 'ç›Ÿå‹å…³ç³»', 'enemies': 'æ•Œå¯¹å…³ç³»', 'neutral': 'ä¸­ç«‹å…³ç³»', 'partnerships': 'åˆä½œä¼™ä¼´',
                'reputation': 'ç»„ç»‡å£°èª‰', 'influence': 'å½±å“åŠ›', 'diplomacy': 'å¤–äº¤å…³ç³»', 'treaties': 'æ¡çº¦åè®®',
                'finances': 'è´¢åŠ¡çŠ¶å†µ', 'assets': 'èµ„äº§ç®¡ç†', 'facilities': 'è®¾æ–½è®¾å¤‡', 'equipment': 'è£…å¤‡å™¨æ',
                'technology': 'æŠ€æœ¯èµ„æº', 'knowledge': 'çŸ¥è¯†åº“', 'archives': 'æ¡£æ¡ˆç®¡ç†', 'secrets': 'æœºå¯†ä¿¡æ¯',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç»„ç»‡åç§°': 'ç»„ç»‡åç§°', 'ç»„ç»‡ç±»å‹': 'ç»„ç»‡ç±»å‹', 'ç»„ç»‡æè¿°': 'ç»„ç»‡æè¿°', 'ç»„ç»‡ç›®æ ‡': 'ç»„ç»‡ç›®æ ‡',
                'ç»„ç»‡å†å²': 'ç»„ç»‡å†å²', 'æˆç«‹èƒŒæ™¯': 'æˆç«‹èƒŒæ™¯', 'ç»„ç»‡æ ¼è¨€': 'ç»„ç»‡æ ¼è¨€', 'æ ¸å¿ƒä»·å€¼': 'æ ¸å¿ƒä»·å€¼',
                'å±‚çº§ç»“æ„': 'å±‚çº§ç»“æ„', 'éƒ¨é—¨è®¾ç½®': 'éƒ¨é—¨è®¾ç½®', 'é¢†å¯¼å±‚': 'é¢†å¯¼å±‚', 'ç†äº‹ä¼š': 'ç†äº‹ä¼š',
                'èŒä½è®¾ç½®': 'èŒä½è®¾ç½®', 'ç­‰çº§åˆ¶åº¦': 'ç­‰çº§åˆ¶åº¦', 'æ™‹å‡æœºåˆ¶': 'æ™‹å‡æœºåˆ¶', 'æƒé™åˆ†é…': 'æƒé™åˆ†é…',
                'æˆå‘˜ç®¡ç†': 'æˆå‘˜ç®¡ç†', 'æ‹›å‹Ÿåˆ¶åº¦': 'æ‹›å‹Ÿåˆ¶åº¦', 'åŸ¹è®­ä½“ç³»': 'åŸ¹è®­ä½“ç³»', 'è€ƒæ ¸è¯„ä¼°': 'è€ƒæ ¸è¯„ä¼°',
                'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šåˆ¶åº¦': 'æƒ©ç½šåˆ¶åº¦', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'é€€ä¼‘åˆ¶åº¦': 'é€€ä¼‘åˆ¶åº¦',
                'ç»„ç»‡è§„åˆ™': 'ç»„ç»‡è§„åˆ™', 'è¡Œä¸ºå‡†åˆ™': 'è¡Œä¸ºå‡†åˆ™', 'é“å¾·è§„èŒƒ': 'é“å¾·è§„èŒƒ', 'çºªå¾‹åˆ¶åº¦': 'çºªå¾‹åˆ¶åº¦',
                'æ“ä½œæµç¨‹': 'æ“ä½œæµç¨‹', 'åè®®è§„èŒƒ': 'åè®®è§„èŒƒ', 'æ ‡å‡†åˆ¶åº¦': 'æ ‡å‡†åˆ¶åº¦', 'åˆè§„ç®¡ç†': 'åˆè§„ç®¡ç†',
                'ç›Ÿå‹å…³ç³»': 'ç›Ÿå‹å…³ç³»', 'æ•Œå¯¹å…³ç³»': 'æ•Œå¯¹å…³ç³»', 'ä¸­ç«‹å…³ç³»': 'ä¸­ç«‹å…³ç³»', 'åˆä½œä¼™ä¼´': 'åˆä½œä¼™ä¼´',
                'ç»„ç»‡å£°èª‰': 'ç»„ç»‡å£°èª‰', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å¤–äº¤å…³ç³»': 'å¤–äº¤å…³ç³»', 'æ¡çº¦åè®®': 'æ¡çº¦åè®®',
                'è´¢åŠ¡çŠ¶å†µ': 'è´¢åŠ¡çŠ¶å†µ', 'èµ„äº§ç®¡ç†': 'èµ„äº§ç®¡ç†', 'è®¾æ–½è®¾å¤‡': 'è®¾æ–½è®¾å¤‡', 'è£…å¤‡å™¨æ': 'è£…å¤‡å™¨æ',
                'æŠ€æœ¯èµ„æº': 'æŠ€æœ¯èµ„æº', 'çŸ¥è¯†åº“': 'çŸ¥è¯†åº“', 'æ¡£æ¡ˆç®¡ç†': 'æ¡£æ¡ˆç®¡ç†', 'æœºå¯†ä¿¡æ¯': 'æœºå¯†ä¿¡æ¯'
            },
            news: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'breaking': 'çªå‘æ–°é—»', 'politics': 'æ”¿æ²»æ–°é—»', 'economy': 'ç»æµæ–°é—»', 'social': 'ç¤¾ä¼šæ–°é—»',
                'military': 'å†›äº‹æ–°é—»', 'technology': 'ç§‘æŠ€æ–°é—»', 'culture': 'æ–‡åŒ–æ–°é—»', 'sports': 'ä½“è‚²æ–°é—»',
                'official': 'å®˜æ–¹å…¬å‘Š', 'media': 'åª’ä½“æŠ¥é“', 'rumors': 'ä¼ è¨€æ¶ˆæ¯', 'insider': 'å†…å¹•æ¶ˆæ¯',
                'witness': 'ç›®å‡»æŠ¥å‘Š', 'intelligence': 'æƒ…æŠ¥ä¿¡æ¯', 'leaked': 'æ³„éœ²æ¶ˆæ¯', 'anonymous': 'åŒ¿åçˆ†æ–™',
                'creation': 'æ–°é—»åˆ›å»º', 'editing': 'æ–°é—»ç¼–è¾‘', 'review': 'æ–°é—»å®¡æ ¸', 'publishing': 'æ–°é—»å‘å¸ƒ',
                'archiving': 'æ–°é—»å½’æ¡£', 'deletion': 'æ–°é—»åˆ é™¤', 'backup': 'å¤‡ä»½ç®¡ç†', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶',
                'broadcast': 'å¹¿æ’­å‘å¸ƒ', 'newsletter': 'æ–°é—»ç®€æŠ¥', 'alerts': 'æ–°é—»è­¦æŠ¥', 'digest': 'æ–°é—»æ‘˜è¦',
                'socialMedia': 'ç¤¾äº¤åª’ä½“', 'forums': 'è®ºå›è®¨è®º', 'messaging': 'æ¶ˆæ¯æ¨é€', 'email': 'é‚®ä»¶é€šçŸ¥',
                'comments': 'è¯„è®ºç³»ç»Ÿ', 'likes': 'ç‚¹èµåŠŸèƒ½', 'sharing': 'åˆ†äº«åŠŸèƒ½', 'bookmarks': 'æ”¶è—åŠŸèƒ½',
                'ratings': 'è¯„åˆ†ç³»ç»Ÿ', 'polls': 'æŠ•ç¥¨è°ƒæŸ¥', 'discussions': 'è®¨è®ºåŒº', 'feedback': 'åé¦ˆç³»ç»Ÿ',
                'analytics': 'æ•°æ®åˆ†æ', 'metrics': 'æŒ‡æ ‡ç»Ÿè®¡', 'trends': 'è¶‹åŠ¿åˆ†æ', 'reports': 'æŠ¥å‘Šç”Ÿæˆ',
                'monitoring': 'ç›‘æ§ç³»ç»Ÿ', 'alertsSystem': 'è­¦æŠ¥ç³»ç»Ÿ', 'automation': 'è‡ªåŠ¨åŒ–', 'aiAnalysis': 'AIåˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'çªå‘æ–°é—»': 'çªå‘æ–°é—»', 'æ”¿æ²»æ–°é—»': 'æ”¿æ²»æ–°é—»', 'ç»æµæ–°é—»': 'ç»æµæ–°é—»', 'ç¤¾ä¼šæ–°é—»': 'ç¤¾ä¼šæ–°é—»',
                'å†›äº‹æ–°é—»': 'å†›äº‹æ–°é—»', 'ç§‘æŠ€æ–°é—»': 'ç§‘æŠ€æ–°é—»', 'æ–‡åŒ–æ–°é—»': 'æ–‡åŒ–æ–°é—»', 'ä½“è‚²æ–°é—»': 'ä½“è‚²æ–°é—»',
                'å®˜æ–¹å…¬å‘Š': 'å®˜æ–¹å…¬å‘Š', 'åª’ä½“æŠ¥é“': 'åª’ä½“æŠ¥é“', 'ä¼ è¨€æ¶ˆæ¯': 'ä¼ è¨€æ¶ˆæ¯', 'å†…å¹•æ¶ˆæ¯': 'å†…å¹•æ¶ˆæ¯',
                'ç›®å‡»æŠ¥å‘Š': 'ç›®å‡»æŠ¥å‘Š', 'æƒ…æŠ¥ä¿¡æ¯': 'æƒ…æŠ¥ä¿¡æ¯', 'æ³„éœ²æ¶ˆæ¯': 'æ³„éœ²æ¶ˆæ¯', 'åŒ¿åçˆ†æ–™': 'åŒ¿åçˆ†æ–™',
                'æ–°é—»åˆ›å»º': 'æ–°é—»åˆ›å»º', 'æ–°é—»ç¼–è¾‘': 'æ–°é—»ç¼–è¾‘', 'æ–°é—»å®¡æ ¸': 'æ–°é—»å®¡æ ¸', 'æ–°é—»å‘å¸ƒ': 'æ–°é—»å‘å¸ƒ',
                'æ–°é—»å½’æ¡£': 'æ–°é—»å½’æ¡£', 'æ–°é—»åˆ é™¤': 'æ–°é—»åˆ é™¤', 'å¤‡ä»½ç®¡ç†': 'å¤‡ä»½ç®¡ç†', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶',
                'å¹¿æ’­å‘å¸ƒ': 'å¹¿æ’­å‘å¸ƒ', 'æ–°é—»ç®€æŠ¥': 'æ–°é—»ç®€æŠ¥', 'æ–°é—»è­¦æŠ¥': 'æ–°é—»è­¦æŠ¥', 'æ–°é—»æ‘˜è¦': 'æ–°é—»æ‘˜è¦',
                'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'è®ºå›è®¨è®º': 'è®ºå›è®¨è®º', 'æ¶ˆæ¯æ¨é€': 'æ¶ˆæ¯æ¨é€', 'é‚®ä»¶é€šçŸ¥': 'é‚®ä»¶é€šçŸ¥',
                'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'ç‚¹èµåŠŸèƒ½': 'ç‚¹èµåŠŸèƒ½', 'åˆ†äº«åŠŸèƒ½': 'åˆ†äº«åŠŸèƒ½', 'æ”¶è—åŠŸèƒ½': 'æ”¶è—åŠŸèƒ½',
                'è¯„åˆ†ç³»ç»Ÿ': 'è¯„åˆ†ç³»ç»Ÿ', 'æŠ•ç¥¨è°ƒæŸ¥': 'æŠ•ç¥¨è°ƒæŸ¥', 'è®¨è®ºåŒº': 'è®¨è®ºåŒº', 'åé¦ˆç³»ç»Ÿ': 'åé¦ˆç³»ç»Ÿ',
                'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'æŒ‡æ ‡ç»Ÿè®¡': 'æŒ‡æ ‡ç»Ÿè®¡', 'è¶‹åŠ¿åˆ†æ': 'è¶‹åŠ¿åˆ†æ', 'æŠ¥å‘Šç”Ÿæˆ': 'æŠ¥å‘Šç”Ÿæˆ',
                'ç›‘æ§ç³»ç»Ÿ': 'ç›‘æ§ç³»ç»Ÿ', 'è­¦æŠ¥ç³»ç»Ÿ': 'è­¦æŠ¥ç³»ç»Ÿ', 'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIåˆ†æ': 'AIåˆ†æ',
                'äº‹ä»¶': 'äº‹ä»¶'
            },
            inventory: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'storage': 'ç‰©å“å­˜å‚¨', 'retrieval': 'ç‰©å“å–å‡º', 'organization': 'ç‰©å“æ•´ç†', 'search': 'ç‰©å“æœç´¢',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ',
                'weapons': 'æ­¦å™¨è£…å¤‡', 'armor': 'é˜²å…·è£…å¤‡', 'accessories': 'é¥°å“é…ä»¶', 'consumables': 'æ¶ˆè€—å“',
                'materials': 'ææ–™ç‰©å“', 'tools': 'å·¥å…·å™¨æ¢°', 'books': 'ä¹¦ç±æ–‡çŒ®', 'treasures': 'çå®æ”¶è—',
                'capacity': 'å®¹é‡ç®¡ç†', 'weight': 'é‡é‡é™åˆ¶', 'stacking': 'å †å åŠŸèƒ½', 'expansion': 'æ‰©å®¹å‡çº§',
                'compartments': 'åˆ†éš”ç®¡ç†', 'protection': 'ä¿æŠ¤åŠŸèƒ½', 'durability': 'è€ä¹…åº¦', 'repair': 'ä¿®ç†ç»´æŠ¤',
                'trading': 'äº¤æ˜“åŠŸèƒ½', 'selling': 'å‡ºå”®åŠŸèƒ½', 'buying': 'è´­ä¹°åŠŸèƒ½', 'auction': 'æ‹å–ç³»ç»Ÿ',
                'gifting': 'èµ é€åŠŸèƒ½', 'lending': 'å€Ÿç”¨åŠŸèƒ½', 'sharing': 'å…±äº«åŠŸèƒ½', 'banking': 'é“¶è¡Œå­˜å‚¨',
                'crafting': 'åˆ¶ä½œåŠŸèƒ½', 'recipes': 'é…æ–¹ç®¡ç†', 'enhancement': 'å¼ºåŒ–åŠŸèƒ½', 'enchanting': 'é™„é­”åŠŸèƒ½',
                'upgrading': 'å‡çº§åŠŸèƒ½', 'combining': 'åˆæˆåŠŸèƒ½', 'dismantling': 'æ‹†è§£åŠŸèƒ½', 'recycling': 'å›æ”¶åŠŸèƒ½',
                'automation': 'è‡ªåŠ¨åŒ–', 'aiSorting': 'AIæ•´ç†', 'recommendations': 'æ¨èç³»ç»Ÿ', 'analytics': 'æ•°æ®åˆ†æ',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½', 'security': 'å®‰å…¨ä¿æŠ¤', 'history': 'å†å²è®°å½•',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‰©å“å­˜å‚¨': 'ç‰©å“å­˜å‚¨', 'ç‰©å“å–å‡º': 'ç‰©å“å–å‡º', 'ç‰©å“æ•´ç†': 'ç‰©å“æ•´ç†', 'ç‰©å“æœç´¢': 'ç‰©å“æœç´¢',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ',
                'æ­¦å™¨è£…å¤‡': 'æ­¦å™¨è£…å¤‡', 'é˜²å…·è£…å¤‡': 'é˜²å…·è£…å¤‡', 'é¥°å“é…ä»¶': 'é¥°å“é…ä»¶', 'æ¶ˆè€—å“': 'æ¶ˆè€—å“',
                'ææ–™ç‰©å“': 'ææ–™ç‰©å“', 'å·¥å…·å™¨æ¢°': 'å·¥å…·å™¨æ¢°', 'ä¹¦ç±æ–‡çŒ®': 'ä¹¦ç±æ–‡çŒ®', 'çå®æ”¶è—': 'çå®æ”¶è—',
                'å®¹é‡ç®¡ç†': 'å®¹é‡ç®¡ç†', 'é‡é‡é™åˆ¶': 'é‡é‡é™åˆ¶', 'å †å åŠŸèƒ½': 'å †å åŠŸèƒ½', 'æ‰©å®¹å‡çº§': 'æ‰©å®¹å‡çº§',
                'åˆ†éš”ç®¡ç†': 'åˆ†éš”ç®¡ç†', 'ä¿æŠ¤åŠŸèƒ½': 'ä¿æŠ¤åŠŸèƒ½', 'è€ä¹…åº¦': 'è€ä¹…åº¦', 'ä¿®ç†ç»´æŠ¤': 'ä¿®ç†ç»´æŠ¤',
                'äº¤æ˜“åŠŸèƒ½': 'äº¤æ˜“åŠŸèƒ½', 'å‡ºå”®åŠŸèƒ½': 'å‡ºå”®åŠŸèƒ½', 'è´­ä¹°åŠŸèƒ½': 'è´­ä¹°åŠŸèƒ½', 'æ‹å–ç³»ç»Ÿ': 'æ‹å–ç³»ç»Ÿ',
                'èµ é€åŠŸèƒ½': 'èµ é€åŠŸèƒ½', 'å€Ÿç”¨åŠŸèƒ½': 'å€Ÿç”¨åŠŸèƒ½', 'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'é“¶è¡Œå­˜å‚¨': 'é“¶è¡Œå­˜å‚¨',
                'åˆ¶ä½œåŠŸèƒ½': 'åˆ¶ä½œåŠŸèƒ½', 'é…æ–¹ç®¡ç†': 'é…æ–¹ç®¡ç†', 'å¼ºåŒ–åŠŸèƒ½': 'å¼ºåŒ–åŠŸèƒ½', 'é™„é­”åŠŸèƒ½': 'é™„é­”åŠŸèƒ½',
                'å‡çº§åŠŸèƒ½': 'å‡çº§åŠŸèƒ½', 'åˆæˆåŠŸèƒ½': 'åˆæˆåŠŸèƒ½', 'æ‹†è§£åŠŸèƒ½': 'æ‹†è§£åŠŸèƒ½', 'å›æ”¶åŠŸèƒ½': 'å›æ”¶åŠŸèƒ½',
                'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIæ•´ç†': 'AIæ•´ç†', 'æ¨èç³»ç»Ÿ': 'æ¨èç³»ç»Ÿ', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½', 'å®‰å…¨ä¿æŠ¤': 'å®‰å…¨ä¿æŠ¤', 'å†å²è®°å½•': 'å†å²è®°å½•',
                'é‡‘å¸': 'é‡‘å¸', 'æ­¦å™¨': 'æ­¦å™¨', 'æŠ¤ç”²': 'æŠ¤ç”²', 'é“å…·': 'é“å…·'
            },
            abilities: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'strength': 'åŠ›é‡å±æ€§', 'agility': 'æ•æ·å±æ€§', 'intelligence': 'æ™ºåŠ›å±æ€§', 'constitution': 'ä½“è´¨å±æ€§',
                'wisdom': 'æ™ºæ…§å±æ€§', 'charisma': 'é­…åŠ›å±æ€§', 'luck': 'å¹¸è¿å±æ€§', 'perception': 'æ„ŸçŸ¥å±æ€§',
                'swordsmanship': 'å‰‘æœ¯æŠ€èƒ½', 'archery': 'å°„ç®­æŠ€èƒ½', 'magic': 'é­”æ³•æŠ€èƒ½', 'defense': 'é˜²å¾¡æŠ€èƒ½',
                'martialArts': 'æ­¦æœ¯æŠ€èƒ½', 'stealth': 'æ½œè¡ŒæŠ€èƒ½', 'tactics': 'æˆ˜æœ¯æŠ€èƒ½', 'healing': 'æ²»ç–—æŠ€èƒ½',
                'crafting': 'åˆ¶ä½œæŠ€èƒ½', 'cooking': 'çƒ¹é¥ªæŠ€èƒ½', 'farming': 'å†œä¸šæŠ€èƒ½', 'mining': 'é‡‡çŸ¿æŠ€èƒ½',
                'fishing': 'é’“é±¼æŠ€èƒ½', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'trading': 'è´¸æ˜“æŠ€èƒ½', 'negotiation': 'è°ˆåˆ¤æŠ€èƒ½',
                'research': 'ç ”ç©¶æŠ€èƒ½', 'investigation': 'è°ƒæŸ¥æŠ€èƒ½', 'languages': 'è¯­è¨€æŠ€èƒ½', 'history': 'å†å²çŸ¥è¯†',
                'medicine': 'åŒ»å­¦çŸ¥è¯†', 'alchemy': 'ç‚¼é‡‘æœ¯', 'engineering': 'å·¥ç¨‹å­¦', 'astronomy': 'å¤©æ–‡å­¦',
                'persuasion': 'è¯´æœæŠ€èƒ½', 'deception': 'æ¬ºéª—æŠ€èƒ½', 'intimidation': 'å¨å“æŠ€èƒ½', 'performance': 'è¡¨æ¼”æŠ€èƒ½',
                'leadership': 'é¢†å¯¼èƒ½åŠ›', 'empathy': 'å…±æƒ…èƒ½åŠ›', 'insight': 'æ´å¯Ÿèƒ½åŠ›', 'networking': 'ç¤¾äº¤èƒ½åŠ›',
                'telepathy': 'å¿ƒçµæ„Ÿåº”', 'telekinesis': 'å¿µåŠ¨åŠ›', 'precognition': 'é¢„çŸ¥èƒ½åŠ›', 'shapeshifting': 'å˜å½¢èƒ½åŠ›',
                'invisibility': 'éšèº«èƒ½åŠ›', 'flight': 'é£è¡Œèƒ½åŠ›', 'regeneration': 'å†ç”Ÿèƒ½åŠ›', 'immortality': 'ä¸æœ½èƒ½åŠ›',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŠ›é‡å±æ€§': 'åŠ›é‡å±æ€§', 'æ•æ·å±æ€§': 'æ•æ·å±æ€§', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'ä½“è´¨å±æ€§': 'ä½“è´¨å±æ€§',
                'æ™ºæ…§å±æ€§': 'æ™ºæ…§å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§', 'å¹¸è¿å±æ€§': 'å¹¸è¿å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§',
                'å‰‘æœ¯æŠ€èƒ½': 'å‰‘æœ¯æŠ€èƒ½', 'å°„ç®­æŠ€èƒ½': 'å°„ç®­æŠ€èƒ½', 'é­”æ³•æŠ€èƒ½': 'é­”æ³•æŠ€èƒ½', 'é˜²å¾¡æŠ€èƒ½': 'é˜²å¾¡æŠ€èƒ½',
                'æ­¦æœ¯æŠ€èƒ½': 'æ­¦æœ¯æŠ€èƒ½', 'æ½œè¡ŒæŠ€èƒ½': 'æ½œè¡ŒæŠ€èƒ½', 'æˆ˜æœ¯æŠ€èƒ½': 'æˆ˜æœ¯æŠ€èƒ½', 'æ²»ç–—æŠ€èƒ½': 'æ²»ç–—æŠ€èƒ½',
                'åˆ¶ä½œæŠ€èƒ½': 'åˆ¶ä½œæŠ€èƒ½', 'çƒ¹é¥ªæŠ€èƒ½': 'çƒ¹é¥ªæŠ€èƒ½', 'å†œä¸šæŠ€èƒ½': 'å†œä¸šæŠ€èƒ½', 'é‡‡çŸ¿æŠ€èƒ½': 'é‡‡çŸ¿æŠ€èƒ½',
                'é’“é±¼æŠ€èƒ½': 'é’“é±¼æŠ€èƒ½', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'è´¸æ˜“æŠ€èƒ½': 'è´¸æ˜“æŠ€èƒ½', 'è°ˆåˆ¤æŠ€èƒ½': 'è°ˆåˆ¤æŠ€èƒ½',
                'ç ”ç©¶æŠ€èƒ½': 'ç ”ç©¶æŠ€èƒ½', 'è°ƒæŸ¥æŠ€èƒ½': 'è°ƒæŸ¥æŠ€èƒ½', 'è¯­è¨€æŠ€èƒ½': 'è¯­è¨€æŠ€èƒ½', 'å†å²çŸ¥è¯†': 'å†å²çŸ¥è¯†',
                'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'ç‚¼é‡‘æœ¯': 'ç‚¼é‡‘æœ¯', 'å·¥ç¨‹å­¦': 'å·¥ç¨‹å­¦', 'å¤©æ–‡å­¦': 'å¤©æ–‡å­¦',
                'è¯´æœæŠ€èƒ½': 'è¯´æœæŠ€èƒ½', 'æ¬ºéª—æŠ€èƒ½': 'æ¬ºéª—æŠ€èƒ½', 'å¨å“æŠ€èƒ½': 'å¨å“æŠ€èƒ½', 'è¡¨æ¼”æŠ€èƒ½': 'è¡¨æ¼”æŠ€èƒ½',
                'é¢†å¯¼èƒ½åŠ›': 'é¢†å¯¼èƒ½åŠ›', 'å…±æƒ…èƒ½åŠ›': 'å…±æƒ…èƒ½åŠ›', 'æ´å¯Ÿèƒ½åŠ›': 'æ´å¯Ÿèƒ½åŠ›', 'ç¤¾äº¤èƒ½åŠ›': 'ç¤¾äº¤èƒ½åŠ›',
                'å¿ƒçµæ„Ÿåº”': 'å¿ƒçµæ„Ÿåº”', 'å¿µåŠ¨åŠ›': 'å¿µåŠ¨åŠ›', 'é¢„çŸ¥èƒ½åŠ›': 'é¢„çŸ¥èƒ½åŠ›', 'å˜å½¢èƒ½åŠ›': 'å˜å½¢èƒ½åŠ›',
                'éšèº«èƒ½åŠ›': 'éšèº«èƒ½åŠ›', 'é£è¡Œèƒ½åŠ›': 'é£è¡Œèƒ½åŠ›', 'å†ç”Ÿèƒ½åŠ›': 'å†ç”Ÿèƒ½åŠ›', 'ä¸æœ½èƒ½åŠ›': 'ä¸æœ½èƒ½åŠ›'
            },
            plot: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'mainStory': 'ä¸»çº¿å‰§æƒ…', 'sideQuests': 'æ”¯çº¿ä»»åŠ¡', 'subplots': 'å­å‰§æƒ…', 'backstory': 'èƒŒæ™¯æ•…äº‹',
                'prologue': 'åºç« ', 'epilogue': 'å°¾å£°', 'flashbacks': 'å›å¿†ç‰‡æ®µ', 'foreshadowing': 'ä¼ç¬”é“ºå«',
                'exposition': 'èƒŒæ™¯è¯´æ˜', 'risingAction': 'æƒ…èŠ‚å‘å±•', 'climax': 'é«˜æ½®éƒ¨åˆ†', 'fallingAction': 'æƒ…èŠ‚å›è½',
                'resolution': 'é—®é¢˜è§£å†³', 'denouement': 'ç»“å±€æ”¶å°¾', 'cliffhanger': 'æ‚¬å¿µç»“å°¾', 'twist': 'å‰§æƒ…è½¬æŠ˜',
                'characterArc': 'è§’è‰²æˆé•¿', 'relationships': 'äººç‰©å…³ç³»', 'motivations': 'åŠ¨æœºé©±åŠ¨', 'conflicts': 'å†²çªçŸ›ç›¾',
                'internalConflicts': 'å†…å¿ƒå†²çª', 'externalConflicts': 'å¤–éƒ¨å†²çª', 'moralDilemmas': 'é“å¾·å›°å¢ƒ', 'sacrifices': 'ç‰ºç‰²é€‰æ‹©',
                'dialogue': 'å¯¹è¯ç³»ç»Ÿ', 'narration': 'å™è¿°æå†™', 'monologue': 'ç‹¬ç™½è¡¨è¾¾', 'symbolism': 'è±¡å¾æ„ä¹‰',
                'themes': 'ä¸»é¢˜æ€æƒ³', 'mood': 'æƒ…ç»ªæ°›å›´', 'tone': 'è¯­è°ƒé£æ ¼', 'pacing': 'èŠ‚å¥æ§åˆ¶',
                'choices': 'é€‰æ‹©åˆ†æ”¯', 'consequences': 'åæœå½±å“', 'branching': 'åˆ†æ”¯å‰§æƒ…', 'multipleEndings': 'å¤šé‡ç»“å±€',
                'playerAgency': 'ç©å®¶ä¸»å¯¼', 'emergentNarrative': 'æ¶Œç°å™äº‹', 'proceduralGeneration': 'ç¨‹åºç”Ÿæˆ', 'adaptiveStorytelling': 'è‡ªé€‚åº”å™äº‹',
                'timeline': 'æ—¶é—´çº¿', 'notes': 'å‰§æƒ…ç¬”è®°', 'bookmarks': 'ä¹¦ç­¾æ ‡è®°', 'saveStates': 'å­˜æ¡£çŠ¶æ€',
                'autoSave': 'è‡ªåŠ¨ä¿å­˜', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'analytics': 'æ•°æ®åˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸»çº¿å‰§æƒ…': 'ä¸»çº¿å‰§æƒ…', 'æ”¯çº¿ä»»åŠ¡': 'æ”¯çº¿ä»»åŠ¡', 'å­å‰§æƒ…': 'å­å‰§æƒ…', 'èƒŒæ™¯æ•…äº‹': 'èƒŒæ™¯æ•…äº‹',
                'åºç« ': 'åºç« ', 'å°¾å£°': 'å°¾å£°', 'å›å¿†ç‰‡æ®µ': 'å›å¿†ç‰‡æ®µ', 'ä¼ç¬”é“ºå«': 'ä¼ç¬”é“ºå«',
                'èƒŒæ™¯è¯´æ˜': 'èƒŒæ™¯è¯´æ˜', 'æƒ…èŠ‚å‘å±•': 'æƒ…èŠ‚å‘å±•', 'é«˜æ½®éƒ¨åˆ†': 'é«˜æ½®éƒ¨åˆ†', 'æƒ…èŠ‚å›è½': 'æƒ…èŠ‚å›è½',
                'é—®é¢˜è§£å†³': 'é—®é¢˜è§£å†³', 'ç»“å±€æ”¶å°¾': 'ç»“å±€æ”¶å°¾', 'æ‚¬å¿µç»“å°¾': 'æ‚¬å¿µç»“å°¾', 'å‰§æƒ…è½¬æŠ˜': 'å‰§æƒ…è½¬æŠ˜',
                'è§’è‰²æˆé•¿': 'è§’è‰²æˆé•¿', 'äººç‰©å…³ç³»': 'äººç‰©å…³ç³»', 'åŠ¨æœºé©±åŠ¨': 'åŠ¨æœºé©±åŠ¨', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾',
                'å†…å¿ƒå†²çª': 'å†…å¿ƒå†²çª', 'å¤–éƒ¨å†²çª': 'å¤–éƒ¨å†²çª', 'é“å¾·å›°å¢ƒ': 'é“å¾·å›°å¢ƒ', 'ç‰ºç‰²é€‰æ‹©': 'ç‰ºç‰²é€‰æ‹©',
                'å¯¹è¯ç³»ç»Ÿ': 'å¯¹è¯ç³»ç»Ÿ', 'å™è¿°æå†™': 'å™è¿°æå†™', 'ç‹¬ç™½è¡¨è¾¾': 'ç‹¬ç™½è¡¨è¾¾', 'è±¡å¾æ„ä¹‰': 'è±¡å¾æ„ä¹‰',
                'ä¸»é¢˜æ€æƒ³': 'ä¸»é¢˜æ€æƒ³', 'æƒ…ç»ªæ°›å›´': 'æƒ…ç»ªæ°›å›´', 'è¯­è°ƒé£æ ¼': 'è¯­è°ƒé£æ ¼', 'èŠ‚å¥æ§åˆ¶': 'èŠ‚å¥æ§åˆ¶',
                'é€‰æ‹©åˆ†æ”¯': 'é€‰æ‹©åˆ†æ”¯', 'åæœå½±å“': 'åæœå½±å“', 'åˆ†æ”¯å‰§æƒ…': 'åˆ†æ”¯å‰§æƒ…', 'å¤šé‡ç»“å±€': 'å¤šé‡ç»“å±€',
                'ç©å®¶ä¸»å¯¼': 'ç©å®¶ä¸»å¯¼', 'æ¶Œç°å™äº‹': 'æ¶Œç°å™äº‹', 'ç¨‹åºç”Ÿæˆ': 'ç¨‹åºç”Ÿæˆ', 'è‡ªé€‚åº”å™äº‹': 'è‡ªé€‚åº”å™äº‹',
                'æ—¶é—´çº¿': 'æ—¶é—´çº¿', 'å‰§æƒ…ç¬”è®°': 'å‰§æƒ…ç¬”è®°', 'ä¹¦ç­¾æ ‡è®°': 'ä¹¦ç­¾æ ‡è®°', 'å­˜æ¡£çŠ¶æ€': 'å­˜æ¡£çŠ¶æ€',
                'è‡ªåŠ¨ä¿å­˜': 'è‡ªåŠ¨ä¿å­˜', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ'
            },
            cultivation: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'qiRefining': 'ç‚¼æ°”æœŸ', 'foundation': 'ç­‘åŸºæœŸ', 'goldenCore': 'é‡‘ä¸¹æœŸ', 'nascentSoul': 'å…ƒå©´æœŸ',
                'soulTransformation': 'åŒ–ç¥æœŸ', 'voidRefinement': 'ç‚¼è™šæœŸ', 'bodyIntegration': 'åˆä½“æœŸ', 'mahayana': 'å¤§ä¹˜æœŸ',
                'tribulation': 'æ¸¡åŠ«æœŸ', 'immortal': 'çœŸä»™', 'trueImmortal': 'å¤©ä»™', 'goldenImmortal': 'é‡‘ä»™',
                'breathingTechnique': 'å‘¼å¸æ³•', 'bodyRefining': 'ç‚¼ä½“æœ¯', 'soulCultivation': 'ç¥é­‚ä¿®ç‚¼', 'dualCultivation': 'åŒä¿®åŠŸæ³•',
                'swordCultivation': 'å‰‘ä¿®ä¹‹é“', 'alchemy': 'ç‚¼ä¸¹æœ¯', 'formation': 'é˜µæ³•', 'talisman': 'ç¬¦ç®“',
                'spiritualPower': 'çµåŠ›å€¼', 'spiritualRoot': 'çµæ ¹', 'meridians': 'ç»è„‰', 'dantian': 'ä¸¹ç”°',
                'divineSense': 'ç¥è¯†', 'lifeSpan': 'å¯¿å‘½', 'karma': 'å› æœ', 'heavenlyDao': 'å¤©é“',
                'flyingSword': 'é£å‰‘', 'magicTreasure': 'æ³•å®', 'spiritualArmor': 'çµç”²', 'storageRing': 'å‚¨ç‰©æˆ’',
                'spiritBeast': 'çµå…½', 'puppet': 'å‚€å„¡', 'avatar': 'åŒ–èº«', 'clone': 'åˆ†èº«',
                'spiritStone': 'çµçŸ³', 'spiritHerb': 'çµè‰', 'pill': 'ä¸¹è¯', 'spiritVein': 'çµè„‰',
                'caveMansion': 'æ´åºœ', 'secretRealm': 'ç§˜å¢ƒ', 'inheritance': 'ä¼ æ‰¿', 'opportunity': 'æœºç¼˜',
                'meditation': 'æ‰“å', 'tribulationCrossing': 'æ¸¡åŠ«', 'enlightenment': 'é¡¿æ‚Ÿ', 'breakthrough': 'çªç ´',
                'sect': 'å®—é—¨', 'masterDisciple': 'å¸ˆå¾’', 'daoCompanion': 'é“ä¾£', 'immortalAscension': 'é£å‡',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‚¼æ°”æœŸ': 'ç‚¼æ°”æœŸ', 'ç­‘åŸºæœŸ': 'ç­‘åŸºæœŸ', 'é‡‘ä¸¹æœŸ': 'é‡‘ä¸¹æœŸ', 'å…ƒå©´æœŸ': 'å…ƒå©´æœŸ',
                'åŒ–ç¥æœŸ': 'åŒ–ç¥æœŸ', 'ç‚¼è™šæœŸ': 'ç‚¼è™šæœŸ', 'åˆä½“æœŸ': 'åˆä½“æœŸ', 'å¤§ä¹˜æœŸ': 'å¤§ä¹˜æœŸ',
                'æ¸¡åŠ«æœŸ': 'æ¸¡åŠ«æœŸ', 'çœŸä»™': 'çœŸä»™', 'å¤©ä»™': 'å¤©ä»™', 'é‡‘ä»™': 'é‡‘ä»™',
                'å‘¼å¸æ³•': 'å‘¼å¸æ³•', 'ç‚¼ä½“æœ¯': 'ç‚¼ä½“æœ¯', 'ç¥é­‚ä¿®ç‚¼': 'ç¥é­‚ä¿®ç‚¼', 'åŒä¿®åŠŸæ³•': 'åŒä¿®åŠŸæ³•',
                'å‰‘ä¿®ä¹‹é“': 'å‰‘ä¿®ä¹‹é“', 'ç‚¼ä¸¹æœ¯': 'ç‚¼ä¸¹æœ¯', 'é˜µæ³•': 'é˜µæ³•', 'ç¬¦ç®“': 'ç¬¦ç®“',
                'çµåŠ›å€¼': 'çµåŠ›å€¼', 'çµæ ¹': 'çµæ ¹', 'ç»è„‰': 'ç»è„‰', 'ä¸¹ç”°': 'ä¸¹ç”°',
                'ç¥è¯†': 'ç¥è¯†', 'å¯¿å‘½': 'å¯¿å‘½', 'å› æœ': 'å› æœ', 'å¤©é“': 'å¤©é“',
                'é£å‰‘': 'é£å‰‘', 'æ³•å®': 'æ³•å®', 'çµç”²': 'çµç”²', 'å‚¨ç‰©æˆ’': 'å‚¨ç‰©æˆ’',
                'çµå…½': 'çµå…½', 'å‚€å„¡': 'å‚€å„¡', 'åŒ–èº«': 'åŒ–èº«', 'åˆ†èº«': 'åˆ†èº«',
                'çµçŸ³': 'çµçŸ³', 'çµè‰': 'çµè‰', 'ä¸¹è¯': 'ä¸¹è¯', 'çµè„‰': 'çµè„‰',
                'æ´åºœ': 'æ´åºœ', 'ç§˜å¢ƒ': 'ç§˜å¢ƒ', 'ä¼ æ‰¿': 'ä¼ æ‰¿', 'æœºç¼˜': 'æœºç¼˜',
                'æ‰“å': 'æ‰“å', 'æ¸¡åŠ«': 'æ¸¡åŠ«', 'é¡¿æ‚Ÿ': 'é¡¿æ‚Ÿ', 'çªç ´': 'çªç ´',
                'å®—é—¨': 'å®—é—¨', 'å¸ˆå¾’': 'å¸ˆå¾’', 'é“ä¾£': 'é“ä¾£', 'é£å‡': 'é£å‡'
            },
            fantasy: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'human': 'äººç±»ç§æ—', 'elf': 'ç²¾çµç§æ—', 'dwarf': 'çŸ®äººç§æ—', 'orc': 'å…½äººç§æ—',
                'dragon': 'é¾™æ—', 'demon': 'æ¶é­”', 'angel': 'å¤©ä½¿', 'undead': 'ä¸æ­»æ—',
                'halfling': 'åŠèº«äºº', 'giant': 'å·¨äººæ—', 'fairy': 'ä»™çµ', 'vampire': 'å¸è¡€é¬¼',
                'fireMagic': 'ç«ç³»é­”æ³•', 'waterMagic': 'æ°´ç³»é­”æ³•', 'earthMagic': 'åœŸç³»é­”æ³•', 'airMagic': 'é£ç³»é­”æ³•',
                'lightMagic': 'å…‰ç³»é­”æ³•', 'darkMagic': 'æš—ç³»é­”æ³•', 'natureMagic': 'è‡ªç„¶é­”æ³•', 'spaceMagic': 'ç©ºé—´é­”æ³•',
                'timeMagic': 'æ—¶é—´é­”æ³•', 'necromancy': 'æ­»çµæ³•æœ¯', 'illusionMagic': 'å¹»æœ¯é­”æ³•', 'enchantment': 'é™„é­”æœ¯',
                'warrior': 'æˆ˜å£«èŒä¸š', 'mage': 'æ³•å¸ˆèŒä¸š', 'archer': 'å¼“ç®­æ‰‹', 'rogue': 'ç›—è´¼èŒä¸š',
                'priest': 'ç‰§å¸ˆèŒä¸š', 'paladin': 'åœ£éª‘å£«', 'druid': 'å¾·é²ä¼Š', 'warlock': 'æœ¯å£«èŒä¸š',
                'bard': 'åŸæ¸¸è¯—äºº', 'monk': 'æ­¦åƒ§èŒä¸š', 'ranger': 'æ¸¸ä¾ èŒä¸š', 'assassin': 'åˆºå®¢èŒä¸š',
                'phoenix': 'å‡¤å‡°', 'unicorn': 'ç‹¬è§’å…½', 'griffin': 'ç‹®é¹«', 'pegasus': 'é£é©¬',
                'kraken': 'æµ·æ€ª', 'chimera': 'å¥‡ç¾æ‹‰', 'basilisk': 'è›‡æ€ª', 'hydra': 'ä¹å¤´è›‡',
                'legendaryWeapon': 'ä¼ è¯´æ­¦å™¨', 'magicArmor': 'é­”æ³•æŠ¤ç”²', 'artifact': 'ç¥å™¨', 'relic': 'åœ£ç‰©',
                'magicCrystal': 'é­”æ³•æ°´æ™¶', 'enchantedItem': 'é™„é­”ç‰©å“', 'potion': 'é­”æ³•è¯æ°´', 'scroll': 'é­”æ³•å·è½´',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'äººç±»ç§æ—': 'äººç±»ç§æ—', 'ç²¾çµç§æ—': 'ç²¾çµç§æ—', 'çŸ®äººç§æ—': 'çŸ®äººç§æ—', 'å…½äººç§æ—': 'å…½äººç§æ—',
                'é¾™æ—': 'é¾™æ—', 'æ¶é­”': 'æ¶é­”', 'å¤©ä½¿': 'å¤©ä½¿', 'ä¸æ­»æ—': 'ä¸æ­»æ—',
                'åŠèº«äºº': 'åŠèº«äºº', 'å·¨äººæ—': 'å·¨äººæ—', 'ä»™çµ': 'ä»™çµ', 'å¸è¡€é¬¼': 'å¸è¡€é¬¼',
                'ç«ç³»é­”æ³•': 'ç«ç³»é­”æ³•', 'æ°´ç³»é­”æ³•': 'æ°´ç³»é­”æ³•', 'åœŸç³»é­”æ³•': 'åœŸç³»é­”æ³•', 'é£ç³»é­”æ³•': 'é£ç³»é­”æ³•',
                'å…‰ç³»é­”æ³•': 'å…‰ç³»é­”æ³•', 'æš—ç³»é­”æ³•': 'æš—ç³»é­”æ³•', 'è‡ªç„¶é­”æ³•': 'è‡ªç„¶é­”æ³•', 'ç©ºé—´é­”æ³•': 'ç©ºé—´é­”æ³•',
                'æ—¶é—´é­”æ³•': 'æ—¶é—´é­”æ³•', 'æ­»çµæ³•æœ¯': 'æ­»çµæ³•æœ¯', 'å¹»æœ¯é­”æ³•': 'å¹»æœ¯é­”æ³•', 'é™„é­”æœ¯': 'é™„é­”æœ¯',
                'æˆ˜å£«èŒä¸š': 'æˆ˜å£«èŒä¸š', 'æ³•å¸ˆèŒä¸š': 'æ³•å¸ˆèŒä¸š', 'å¼“ç®­æ‰‹': 'å¼“ç®­æ‰‹', 'ç›—è´¼èŒä¸š': 'ç›—è´¼èŒä¸š',
                'ç‰§å¸ˆèŒä¸š': 'ç‰§å¸ˆèŒä¸š', 'åœ£éª‘å£«': 'åœ£éª‘å£«', 'å¾·é²ä¼Š': 'å¾·é²ä¼Š', 'æœ¯å£«èŒä¸š': 'æœ¯å£«èŒä¸š',
                'åŸæ¸¸è¯—äºº': 'åŸæ¸¸è¯—äºº', 'æ­¦åƒ§èŒä¸š': 'æ­¦åƒ§èŒä¸š', 'æ¸¸ä¾ èŒä¸š': 'æ¸¸ä¾ èŒä¸š', 'åˆºå®¢èŒä¸š': 'åˆºå®¢èŒä¸š',
                'å‡¤å‡°': 'å‡¤å‡°', 'ç‹¬è§’å…½': 'ç‹¬è§’å…½', 'ç‹®é¹«': 'ç‹®é¹«', 'é£é©¬': 'é£é©¬',
                'æµ·æ€ª': 'æµ·æ€ª', 'å¥‡ç¾æ‹‰': 'å¥‡ç¾æ‹‰', 'è›‡æ€ª': 'è›‡æ€ª', 'ä¹å¤´è›‡': 'ä¹å¤´è›‡',
                'ä¼ è¯´æ­¦å™¨': 'ä¼ è¯´æ­¦å™¨', 'é­”æ³•æŠ¤ç”²': 'é­”æ³•æŠ¤ç”²', 'ç¥å™¨': 'ç¥å™¨', 'åœ£ç‰©': 'åœ£ç‰©',
                'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é™„é­”ç‰©å“': 'é™„é­”ç‰©å“', 'é­”æ³•è¯æ°´': 'é­”æ³•è¯æ°´', 'é­”æ³•å·è½´': 'é­”æ³•å·è½´'
            },
            modern: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'city': 'åŸå¸‚ç¯å¢ƒ', 'district': 'åŒºåŸŸè®¾å®š', 'housing': 'ä½æˆ¿æƒ…å†µ', 'transport': 'äº¤é€šå·¥å…·',
                'neighborhood': 'ç¤¾åŒºç¯å¢ƒ', 'facilities': 'è®¾æ–½é…å¥—', 'cost': 'ç”Ÿæ´»æˆæœ¬', 'safety': 'å®‰å…¨çŠ¶å†µ',
                'pollution': 'ç¯å¢ƒæ±¡æŸ“', 'job': 'èŒä¸šå·¥ä½œ', 'company': 'å…¬å¸ä¼ä¸š', 'position': 'èŒä½ç­‰çº§',
                'income': 'æ”¶å…¥æ°´å¹³', 'worktime': 'å·¥ä½œæ—¶é—´', 'benefits': 'ç¦åˆ©å¾…é‡', 'career': 'èŒä¸šå‘å±•',
                'skills': 'æŠ€èƒ½è¦æ±‚', 'education': 'æ•™è‚²èƒŒæ™¯', 'smartphone': 'æ™ºèƒ½æ‰‹æœº', 'computer': 'ç”µè„‘è®¾å¤‡',
                'internet': 'ç½‘ç»œè¿æ¥', 'social': 'ç¤¾äº¤åª’ä½“', 'gaming': 'æ¸¸æˆå¨±ä¹', 'streaming': 'æµåª’ä½“',
                'shopping': 'è´­ç‰©æ¶ˆè´¹', 'payment': 'æ”¯ä»˜æ–¹å¼', 'ai': 'äººå·¥æ™ºèƒ½', 'health': 'å¥åº·ç®¡ç†',
                'fitness': 'å¥èº«è¿åŠ¨', 'diet': 'é¥®é£Ÿä¹ æƒ¯', 'sleep': 'ç¡çœ è´¨é‡', 'medical': 'åŒ»ç–—ä¿å¥',
                'stress': 'å‹åŠ›ç®¡ç†', 'mental': 'å¿ƒç†å¥åº·', 'checkup': 'ä½“æ£€æ£€æŸ¥', 'budget': 'é¢„ç®—ç®¡ç†',
                'brands': 'å“ç‰Œåå¥½', 'fashion': 'æ—¶å°šæ½®æµ', 'luxury': 'å¥¢ä¾ˆæ¶ˆè´¹', 'investment': 'æŠ•èµ„ç†è´¢',
                'saving': 'å‚¨è“„è®¡åˆ’', 'credit': 'ä¿¡ç”¨è®°å½•', 'insurance': 'ä¿é™©ä¿éšœ', 'movies': 'ç”µå½±å¨±ä¹',
                'music': 'éŸ³ä¹æ¬£èµ', 'books': 'é˜…è¯»ä¹ æƒ¯', 'travel': 'æ—…æ¸¸å‡ºè¡Œ', 'sports': 'ä½“è‚²è¿åŠ¨',
                'hobbies': 'å…´è¶£çˆ±å¥½', 'clubs': 'ä¿±ä¹éƒ¨', 'events': 'æ´»åŠ¨å‚ä¸',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŸå¸‚ç¯å¢ƒ': 'åŸå¸‚ç¯å¢ƒ', 'åŒºåŸŸè®¾å®š': 'åŒºåŸŸè®¾å®š', 'ä½æˆ¿æƒ…å†µ': 'ä½æˆ¿æƒ…å†µ', 'äº¤é€šå·¥å…·': 'äº¤é€šå·¥å…·',
                'ç¤¾åŒºç¯å¢ƒ': 'ç¤¾åŒºç¯å¢ƒ', 'è®¾æ–½é…å¥—': 'è®¾æ–½é…å¥—', 'ç”Ÿæ´»æˆæœ¬': 'ç”Ÿæ´»æˆæœ¬', 'å®‰å…¨çŠ¶å†µ': 'å®‰å…¨çŠ¶å†µ',
                'ç¯å¢ƒæ±¡æŸ“': 'ç¯å¢ƒæ±¡æŸ“', 'èŒä¸šå·¥ä½œ': 'èŒä¸šå·¥ä½œ', 'å…¬å¸ä¼ä¸š': 'å…¬å¸ä¼ä¸š', 'èŒä½ç­‰çº§': 'èŒä½ç­‰çº§',
                'æ”¶å…¥æ°´å¹³': 'æ”¶å…¥æ°´å¹³', 'å·¥ä½œæ—¶é—´': 'å·¥ä½œæ—¶é—´', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'èŒä¸šå‘å±•': 'èŒä¸šå‘å±•',
                'æŠ€èƒ½è¦æ±‚': 'æŠ€èƒ½è¦æ±‚', 'æ•™è‚²èƒŒæ™¯': 'æ•™è‚²èƒŒæ™¯', 'æ™ºèƒ½æ‰‹æœº': 'æ™ºèƒ½æ‰‹æœº', 'ç”µè„‘è®¾å¤‡': 'ç”µè„‘è®¾å¤‡',
                'ç½‘ç»œè¿æ¥': 'ç½‘ç»œè¿æ¥', 'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'æ¸¸æˆå¨±ä¹': 'æ¸¸æˆå¨±ä¹', 'æµåª’ä½“': 'æµåª’ä½“',
                'è´­ç‰©æ¶ˆè´¹': 'è´­ç‰©æ¶ˆè´¹', 'æ”¯ä»˜æ–¹å¼': 'æ”¯ä»˜æ–¹å¼', 'äººå·¥æ™ºèƒ½': 'äººå·¥æ™ºèƒ½', 'å¥åº·ç®¡ç†': 'å¥åº·ç®¡ç†',
                'å¥èº«è¿åŠ¨': 'å¥èº«è¿åŠ¨', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'ç¡çœ è´¨é‡': 'ç¡çœ è´¨é‡', 'åŒ»ç–—ä¿å¥': 'åŒ»ç–—ä¿å¥',
                'å‹åŠ›ç®¡ç†': 'å‹åŠ›ç®¡ç†', 'å¿ƒç†å¥åº·': 'å¿ƒç†å¥åº·', 'ä½“æ£€æ£€æŸ¥': 'ä½“æ£€æ£€æŸ¥', 'é¢„ç®—ç®¡ç†': 'é¢„ç®—ç®¡ç†',
                'å“ç‰Œåå¥½': 'å“ç‰Œåå¥½', 'æ—¶å°šæ½®æµ': 'æ—¶å°šæ½®æµ', 'å¥¢ä¾ˆæ¶ˆè´¹': 'å¥¢ä¾ˆæ¶ˆè´¹', 'æŠ•èµ„ç†è´¢': 'æŠ•èµ„ç†è´¢',
                'å‚¨è“„è®¡åˆ’': 'å‚¨è“„è®¡åˆ’', 'ä¿¡ç”¨è®°å½•': 'ä¿¡ç”¨è®°å½•', 'ä¿é™©ä¿éšœ': 'ä¿é™©ä¿éšœ', 'ç”µå½±å¨±ä¹': 'ç”µå½±å¨±ä¹',
                'éŸ³ä¹æ¬£èµ': 'éŸ³ä¹æ¬£èµ', 'é˜…è¯»ä¹ æƒ¯': 'é˜…è¯»ä¹ æƒ¯', 'æ—…æ¸¸å‡ºè¡Œ': 'æ—…æ¸¸å‡ºè¡Œ', 'ä½“è‚²è¿åŠ¨': 'ä½“è‚²è¿åŠ¨',
                'å…´è¶£çˆ±å¥½': 'å…´è¶£çˆ±å¥½', 'ä¿±ä¹éƒ¨': 'ä¿±ä¹éƒ¨', 'æ´»åŠ¨å‚ä¸': 'æ´»åŠ¨å‚ä¸'
            },
            historical: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'dynasty': 'æœä»£èƒŒæ™¯', 'period': 'å†å²æ—¶æœŸ', 'emperor': 'çš‡å¸å›ä¸»', 'capital': 'éƒ½åŸé¦–åºœ',
                'region': 'åœ°åŸŸåˆ†å¸ƒ', 'events': 'å†å²äº‹ä»¶', 'wars': 'æˆ˜äº‰å†²çª', 'politics': 'æ”¿æ²»åˆ¶åº¦',
                'economy': 'ç»æµçŠ¶å†µ', 'class': 'ç¤¾ä¼šé˜¶å±‚', 'title': 'çˆµä½å¤´è¡”', 'family': 'å®¶æ—èƒŒæ™¯',
                'wealth': 'è´¢å¯ŒçŠ¶å†µ', 'land': 'åœŸåœ°è´¢äº§', 'servants': 'ä»†ä»éšä»', 'influence': 'å½±å“åŠ›',
                'reputation': 'åå£°å£°èª‰', 'connections': 'äººè„‰å…³ç³»', 'education': 'æ•™è‚²ç¨‹åº¦', 'poetry': 'è¯—è¯æ–‡å­¦',
                'calligraphy': 'ä¹¦æ³•è‰ºæœ¯', 'music': 'éŸ³ä¹æ‰è‰º', 'chess': 'æ£‹è‰ºæŠ€å·§', 'classics': 'ç»å…¸å­¦é—®',
                'philosophy': 'å“²å­¦æ€æƒ³', 'etiquette': 'ç¤¼ä»ªè§„èŒƒ', 'language': 'è¯­è¨€æ–‡å­—', 'martial': 'æ­¦è‰ºä¿®ä¸º',
                'weapons': 'å…µå™¨ä½¿ç”¨', 'archery': 'å°„ç®­æŠ€è‰º', 'horsemanship': 'éª‘æœ¯æŠ€èƒ½', 'strategy': 'å…µæ³•è°‹ç•¥',
                'bodyguard': 'æŠ¤å«éšä»', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'survival': 'ç”Ÿå­˜æŠ€èƒ½', 'residence': 'å±…ä½ç¯å¢ƒ',
                'clothing': 'æœé¥°é£æ ¼', 'food': 'é¥®é£Ÿä¹ æƒ¯', 'transport': 'å‡ºè¡Œæ–¹å¼', 'entertainment': 'å¨±ä¹æ´»åŠ¨',
                'festivals': 'èŠ‚åº†æ´»åŠ¨', 'religion': 'å®—æ•™ä¿¡ä»°', 'medicine': 'åŒ»å­¦çŸ¥è¯†', 'profession': 'èŒä¸šèº«ä»½',
                'crafts': 'æ‰‹å·¥æŠ€è‰º', 'trade': 'å•†è´¸æ´»åŠ¨', 'farming': 'å†œä¸šç”Ÿäº§', 'administration': 'è¡Œæ”¿ç®¡ç†',
                'teaching': 'æ•™å­¦ä¼ æˆ', 'healing': 'åŒ»ç–—æ•‘æ²»', 'construction': 'å»ºç­‘è¥é€ ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»£èƒŒæ™¯': 'æœä»£èƒŒæ™¯', 'å†å²æ—¶æœŸ': 'å†å²æ—¶æœŸ', 'çš‡å¸å›ä¸»': 'çš‡å¸å›ä¸»', 'éƒ½åŸé¦–åºœ': 'éƒ½åŸé¦–åºœ',
                'åœ°åŸŸåˆ†å¸ƒ': 'åœ°åŸŸåˆ†å¸ƒ', 'å†å²äº‹ä»¶': 'å†å²äº‹ä»¶', 'æˆ˜äº‰å†²çª': 'æˆ˜äº‰å†²çª', 'æ”¿æ²»åˆ¶åº¦': 'æ”¿æ²»åˆ¶åº¦',
                'ç»æµçŠ¶å†µ': 'ç»æµçŠ¶å†µ', 'ç¤¾ä¼šé˜¶å±‚': 'ç¤¾ä¼šé˜¶å±‚', 'çˆµä½å¤´è¡”': 'çˆµä½å¤´è¡”', 'å®¶æ—èƒŒæ™¯': 'å®¶æ—èƒŒæ™¯',
                'è´¢å¯ŒçŠ¶å†µ': 'è´¢å¯ŒçŠ¶å†µ', 'åœŸåœ°è´¢äº§': 'åœŸåœ°è´¢äº§', 'ä»†ä»éšä»': 'ä»†ä»éšä»', 'å½±å“åŠ›': 'å½±å“åŠ›',
                'åå£°å£°èª‰': 'åå£°å£°èª‰', 'äººè„‰å…³ç³»': 'äººè„‰å…³ç³»', 'æ•™è‚²ç¨‹åº¦': 'æ•™è‚²ç¨‹åº¦', 'è¯—è¯æ–‡å­¦': 'è¯—è¯æ–‡å­¦',
                'ä¹¦æ³•è‰ºæœ¯': 'ä¹¦æ³•è‰ºæœ¯', 'éŸ³ä¹æ‰è‰º': 'éŸ³ä¹æ‰è‰º', 'æ£‹è‰ºæŠ€å·§': 'æ£‹è‰ºæŠ€å·§', 'ç»å…¸å­¦é—®': 'ç»å…¸å­¦é—®',
                'å“²å­¦æ€æƒ³': 'å“²å­¦æ€æƒ³', 'ç¤¼ä»ªè§„èŒƒ': 'ç¤¼ä»ªè§„èŒƒ', 'è¯­è¨€æ–‡å­—': 'è¯­è¨€æ–‡å­—', 'æ­¦è‰ºä¿®ä¸º': 'æ­¦è‰ºä¿®ä¸º',
                'å…µå™¨ä½¿ç”¨': 'å…µå™¨ä½¿ç”¨', 'å°„ç®­æŠ€è‰º': 'å°„ç®­æŠ€è‰º', 'éª‘æœ¯æŠ€èƒ½': 'éª‘æœ¯æŠ€èƒ½', 'å…µæ³•è°‹ç•¥': 'å…µæ³•è°‹ç•¥',
                'æŠ¤å«éšä»': 'æŠ¤å«éšä»', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'ç”Ÿå­˜æŠ€èƒ½': 'ç”Ÿå­˜æŠ€èƒ½', 'å±…ä½ç¯å¢ƒ': 'å±…ä½ç¯å¢ƒ',
                'æœé¥°é£æ ¼': 'æœé¥°é£æ ¼', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'å‡ºè¡Œæ–¹å¼': 'å‡ºè¡Œæ–¹å¼', 'å¨±ä¹æ´»åŠ¨': 'å¨±ä¹æ´»åŠ¨',
                'èŠ‚åº†æ´»åŠ¨': 'èŠ‚åº†æ´»åŠ¨', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'èŒä¸šèº«ä»½': 'èŒä¸šèº«ä»½',
                'æ‰‹å·¥æŠ€è‰º': 'æ‰‹å·¥æŠ€è‰º', 'å•†è´¸æ´»åŠ¨': 'å•†è´¸æ´»åŠ¨', 'å†œä¸šç”Ÿäº§': 'å†œä¸šç”Ÿäº§', 'è¡Œæ”¿ç®¡ç†': 'è¡Œæ”¿ç®¡ç†',
                'æ•™å­¦ä¼ æˆ': 'æ•™å­¦ä¼ æˆ', 'åŒ»ç–—æ•‘æ²»': 'åŒ»ç–—æ•‘æ²»', 'å»ºç­‘è¥é€ ': 'å»ºç­‘è¥é€ '
            },
            magic: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'evocation': 'å¡‘èƒ½ç³»', 'illusion': 'å¹»æœ¯ç³»', 'enchantment': 'æƒ‘æ§ç³»', 'necromancy': 'æ­»çµç³»',
                'divination': 'é¢„è¨€ç³»', 'transmutation': 'å˜åŒ–ç³»', 'conjuration': 'å’’æ³•ç³»', 'abjuration': 'é˜²æŠ¤ç³»',
                'elemental': 'å…ƒç´ æ³•æœ¯', 'cantrip': 'æˆæ³•æ³•æœ¯', 'level1': 'ä¸€ç¯æ³•æœ¯', 'level2': 'äºŒç¯æ³•æœ¯',
                'level3': 'ä¸‰ç¯æ³•æœ¯', 'level4': 'å››ç¯æ³•æœ¯', 'level5': 'äº”ç¯æ³•æœ¯', 'level6': 'å…­ç¯æ³•æœ¯',
                'level7': 'ä¸ƒç¯æ³•æœ¯', 'level8': 'å…«ç¯æ³•æœ¯', 'level9': 'ä¹ç¯æ³•æœ¯', 'level': 'æ³•æœ¯ç­‰çº§',
                'mana': 'æ³•åŠ›å€¼', 'intelligence': 'æ™ºåŠ›å±æ€§', 'wisdom': 'æ„ŸçŸ¥å±æ€§', 'charisma': 'é­…åŠ›å±æ€§',
                'concentration': 'ä¸“æ³¨èƒ½åŠ›', 'spellpower': 'æ³•æœ¯å¼ºåº¦', 'resistance': 'é­”æ³•æŠ—æ€§', 'regeneration': 'æ³•åŠ›å›å¤',
                'spellbook': 'æ³•æœ¯ä¹¦', 'known': 'å·²çŸ¥æ³•æœ¯', 'prepared': 'å‡†å¤‡æ³•æœ¯', 'slots': 'æ³•æœ¯ä½',
                'components': 'æ–½æ³•ææ–™', 'rituals': 'ä»ªå¼æ³•æœ¯', 'metamagic': 'è¶…é­”ä¸“é•¿', 'scrolls': 'æ³•æœ¯å·è½´',
                'fire': 'ç«å…ƒç´ ', 'water': 'æ°´å…ƒç´ ', 'earth': 'åœŸå…ƒç´ ', 'air': 'é£å…ƒç´ ',
                'lightning': 'é›·ç”µ', 'ice': 'å†°éœœ', 'light': 'å…‰æ˜', 'dark': 'é»‘æš—',
                'staff': 'æ³•æ–', 'wand': 'é­”æ–', 'orb': 'æ³•çƒ', 'robe': 'æ³•è¢',
                'amulet': 'æŠ¤ç¬¦', 'ring': 'é­”æ³•æˆ’æŒ‡', 'crystal': 'é­”æ³•æ°´æ™¶', 'tome': 'é­”æ³•å…¸ç±',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¡‘èƒ½ç³»': 'å¡‘èƒ½ç³»', 'å¹»æœ¯ç³»': 'å¹»æœ¯ç³»', 'æƒ‘æ§ç³»': 'æƒ‘æ§ç³»', 'æ­»çµç³»': 'æ­»çµç³»',
                'é¢„è¨€ç³»': 'é¢„è¨€ç³»', 'å˜åŒ–ç³»': 'å˜åŒ–ç³»', 'å’’æ³•ç³»': 'å’’æ³•ç³»', 'é˜²æŠ¤ç³»': 'é˜²æŠ¤ç³»',
                'å…ƒç´ æ³•æœ¯': 'å…ƒç´ æ³•æœ¯', 'æˆæ³•æ³•æœ¯': 'æˆæ³•æ³•æœ¯', 'ä¸€ç¯æ³•æœ¯': 'ä¸€ç¯æ³•æœ¯', 'äºŒç¯æ³•æœ¯': 'äºŒç¯æ³•æœ¯',
                'ä¸‰ç¯æ³•æœ¯': 'ä¸‰ç¯æ³•æœ¯', 'å››ç¯æ³•æœ¯': 'å››ç¯æ³•æœ¯', 'äº”ç¯æ³•æœ¯': 'äº”ç¯æ³•æœ¯', 'å…­ç¯æ³•æœ¯': 'å…­ç¯æ³•æœ¯',
                'ä¸ƒç¯æ³•æœ¯': 'ä¸ƒç¯æ³•æœ¯', 'å…«ç¯æ³•æœ¯': 'å…«ç¯æ³•æœ¯', 'ä¹ç¯æ³•æœ¯': 'ä¹ç¯æ³•æœ¯', 'æ³•æœ¯ç­‰çº§': 'æ³•æœ¯ç­‰çº§',
                'æ³•åŠ›å€¼': 'æ³•åŠ›å€¼', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§',
                'ä¸“æ³¨èƒ½åŠ›': 'ä¸“æ³¨èƒ½åŠ›', 'æ³•æœ¯å¼ºåº¦': 'æ³•æœ¯å¼ºåº¦', 'é­”æ³•æŠ—æ€§': 'é­”æ³•æŠ—æ€§', 'æ³•åŠ›å›å¤': 'æ³•åŠ›å›å¤',
                'æ³•æœ¯ä¹¦': 'æ³•æœ¯ä¹¦', 'å·²çŸ¥æ³•æœ¯': 'å·²çŸ¥æ³•æœ¯', 'å‡†å¤‡æ³•æœ¯': 'å‡†å¤‡æ³•æœ¯', 'æ³•æœ¯ä½': 'æ³•æœ¯ä½',
                'æ–½æ³•ææ–™': 'æ–½æ³•ææ–™', 'ä»ªå¼æ³•æœ¯': 'ä»ªå¼æ³•æœ¯', 'è¶…é­”ä¸“é•¿': 'è¶…é­”ä¸“é•¿', 'æ³•æœ¯å·è½´': 'æ³•æœ¯å·è½´',
                'ç«å…ƒç´ ': 'ç«å…ƒç´ ', 'æ°´å…ƒç´ ': 'æ°´å…ƒç´ ', 'åœŸå…ƒç´ ': 'åœŸå…ƒç´ ', 'é£å…ƒç´ ': 'é£å…ƒç´ ',
                'é›·ç”µ': 'é›·ç”µ', 'å†°éœœ': 'å†°éœœ', 'å…‰æ˜': 'å…‰æ˜', 'é»‘æš—': 'é»‘æš—',
                'æ³•æ–': 'æ³•æ–', 'é­”æ–': 'é­”æ–', 'æ³•çƒ': 'æ³•çƒ', 'æ³•è¢': 'æ³•è¢',
                'æŠ¤ç¬¦': 'æŠ¤ç¬¦', 'é­”æ³•æˆ’æŒ‡': 'é­”æ³•æˆ’æŒ‡', 'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é­”æ³•å…¸ç±': 'é­”æ³•å…¸ç±'
            },
            training: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'obedience': 'æœä»è®­ç»ƒ', 'discipline': 'çºªå¾‹è®­ç»ƒ', 'etiquette': 'ç¤¼ä»ªè®­ç»ƒ', 'posture': 'å§¿æ€è®­ç»ƒ',
                'speech': 'è¨€è¯­è®­ç»ƒ', 'behavior': 'è¡Œä¸ºè®­ç»ƒ', 'attention': 'æ³¨æ„åŠ›è®­ç»ƒ', 'patience': 'è€å¿ƒè®­ç»ƒ',
                'focus': 'ä¸“æ³¨è®­ç»ƒ', 'service': 'æœåŠ¡è®­ç»ƒ', 'cooking': 'çƒ¹é¥ªè®­ç»ƒ', 'cleaning': 'æ¸…æ´è®­ç»ƒ',
                'massage': 'æŒ‰æ‘©è®­ç»ƒ', 'entertainment': 'å¨±ä¹è®­ç»ƒ', 'music': 'éŸ³ä¹è®­ç»ƒ', 'dance': 'èˆè¹ˆè®­ç»ƒ',
                'art': 'è‰ºæœ¯è®­ç»ƒ', 'language': 'è¯­è¨€è®­ç»ƒ', 'strength': 'åŠ›é‡è®­ç»ƒ', 'endurance': 'è€åŠ›è®­ç»ƒ',
                'flexibility': 'æŸ”éŸ§è®­ç»ƒ', 'balance': 'å¹³è¡¡è®­ç»ƒ', 'coordination': 'åè°ƒè®­ç»ƒ', 'agility': 'æ•æ·è®­ç»ƒ',
                'stamina': 'ä½“èƒ½è®­ç»ƒ', 'recovery': 'æ¢å¤è®­ç»ƒ', 'confidence': 'è‡ªä¿¡è®­ç»ƒ', 'stress': 'æŠ—å‹è®­ç»ƒ',
                'emotion': 'æƒ…ç»ªè®­ç»ƒ', 'memory': 'è®°å¿†è®­ç»ƒ', 'logic': 'é€»è¾‘è®­ç»ƒ', 'creativity': 'åˆ›é€ è®­ç»ƒ',
                'meditation': 'å†¥æƒ³è®­ç»ƒ', 'mindfulness': 'æ­£å¿µè®­ç»ƒ', 'intensity': 'å¼ºåº¦è®¾ç½®', 'duration': 'æŒç»­æ—¶é—´',
                'frequency': 'è®­ç»ƒé¢‘ç‡', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šæœºåˆ¶',
                'schedule': 'è®­ç»ƒè®¡åˆ’', 'evaluation': 'è¯„ä¼°ç³»ç»Ÿ', 'auto': 'è‡ªåŠ¨è®­ç»ƒ', 'adaptive': 'è‡ªé€‚åº”è®­ç»ƒ',
                'ai': 'AIè¾…åŠ©', 'analytics': 'æ•°æ®åˆ†æ', 'reports': 'è®­ç»ƒæŠ¥å‘Š', 'export': 'å¯¼å‡ºåŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»è®­ç»ƒ': 'æœä»è®­ç»ƒ', 'çºªå¾‹è®­ç»ƒ': 'çºªå¾‹è®­ç»ƒ', 'ç¤¼ä»ªè®­ç»ƒ': 'ç¤¼ä»ªè®­ç»ƒ', 'å§¿æ€è®­ç»ƒ': 'å§¿æ€è®­ç»ƒ',
                'è¨€è¯­è®­ç»ƒ': 'è¨€è¯­è®­ç»ƒ', 'è¡Œä¸ºè®­ç»ƒ': 'è¡Œä¸ºè®­ç»ƒ', 'æ³¨æ„åŠ›è®­ç»ƒ': 'æ³¨æ„åŠ›è®­ç»ƒ', 'è€å¿ƒè®­ç»ƒ': 'è€å¿ƒè®­ç»ƒ',
                'ä¸“æ³¨è®­ç»ƒ': 'ä¸“æ³¨è®­ç»ƒ', 'æœåŠ¡è®­ç»ƒ': 'æœåŠ¡è®­ç»ƒ', 'çƒ¹é¥ªè®­ç»ƒ': 'çƒ¹é¥ªè®­ç»ƒ', 'æ¸…æ´è®­ç»ƒ': 'æ¸…æ´è®­ç»ƒ',
                'æŒ‰æ‘©è®­ç»ƒ': 'æŒ‰æ‘©è®­ç»ƒ', 'å¨±ä¹è®­ç»ƒ': 'å¨±ä¹è®­ç»ƒ', 'éŸ³ä¹è®­ç»ƒ': 'éŸ³ä¹è®­ç»ƒ', 'èˆè¹ˆè®­ç»ƒ': 'èˆè¹ˆè®­ç»ƒ',
                'è‰ºæœ¯è®­ç»ƒ': 'è‰ºæœ¯è®­ç»ƒ', 'è¯­è¨€è®­ç»ƒ': 'è¯­è¨€è®­ç»ƒ', 'åŠ›é‡è®­ç»ƒ': 'åŠ›é‡è®­ç»ƒ', 'è€åŠ›è®­ç»ƒ': 'è€åŠ›è®­ç»ƒ',
                'æŸ”éŸ§è®­ç»ƒ': 'æŸ”éŸ§è®­ç»ƒ', 'å¹³è¡¡è®­ç»ƒ': 'å¹³è¡¡è®­ç»ƒ', 'åè°ƒè®­ç»ƒ': 'åè°ƒè®­ç»ƒ', 'æ•æ·è®­ç»ƒ': 'æ•æ·è®­ç»ƒ',
                'ä½“èƒ½è®­ç»ƒ': 'ä½“èƒ½è®­ç»ƒ', 'æ¢å¤è®­ç»ƒ': 'æ¢å¤è®­ç»ƒ', 'è‡ªä¿¡è®­ç»ƒ': 'è‡ªä¿¡è®­ç»ƒ', 'æŠ—å‹è®­ç»ƒ': 'æŠ—å‹è®­ç»ƒ',
                'æƒ…ç»ªè®­ç»ƒ': 'æƒ…ç»ªè®­ç»ƒ', 'è®°å¿†è®­ç»ƒ': 'è®°å¿†è®­ç»ƒ', 'é€»è¾‘è®­ç»ƒ': 'é€»è¾‘è®­ç»ƒ', 'åˆ›é€ è®­ç»ƒ': 'åˆ›é€ è®­ç»ƒ',
                'å†¥æƒ³è®­ç»ƒ': 'å†¥æƒ³è®­ç»ƒ', 'æ­£å¿µè®­ç»ƒ': 'æ­£å¿µè®­ç»ƒ', 'å¼ºåº¦è®¾ç½®': 'å¼ºåº¦è®¾ç½®', 'æŒç»­æ—¶é—´': 'æŒç»­æ—¶é—´',
                'è®­ç»ƒé¢‘ç‡': 'è®­ç»ƒé¢‘ç‡', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šæœºåˆ¶': 'æƒ©ç½šæœºåˆ¶',
                'è®­ç»ƒè®¡åˆ’': 'è®­ç»ƒè®¡åˆ’', 'è¯„ä¼°ç³»ç»Ÿ': 'è¯„ä¼°ç³»ç»Ÿ', 'è‡ªåŠ¨è®­ç»ƒ': 'è‡ªåŠ¨è®­ç»ƒ', 'è‡ªé€‚åº”è®­ç»ƒ': 'è‡ªé€‚åº”è®­ç»ƒ',
                'AIè¾…åŠ©': 'AIè¾…åŠ©', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'è®­ç»ƒæŠ¥å‘Š': 'è®­ç»ƒæŠ¥å‘Š', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½'
            }
        };

        // ğŸ”§ æ–°å¢ï¼šåŠ¨æ€æ·»åŠ è‡ªå®šä¹‰é¢æ¿çš„å­—æ®µæ˜ å°„
        try {
            const customPanels = this.getCustomPanels();
            for (const [panelId, panelConfig] of Object.entries(customPanels)) {
                if (panelConfig && panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    // ä¸ºæ¯ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå­—æ®µæ˜ å°„
                    const customPanelMapping = {};

                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.key) {
                            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨subItemçš„displayNameæˆ–nameï¼Œé¿å…å¾ªç¯ä¾èµ–
                            const displayName = subItem.displayName || subItem.name || subItem.key;

                            // ä½¿ç”¨å­—æ®µçš„keyä½œä¸ºæ˜ å°„é”®
                            customPanelMapping[subItem.key] = displayName;

                            // ğŸ”§ å…¼å®¹æ€§ï¼šåŒæ—¶æ”¯æŒnameå­—æ®µï¼ˆå¦‚æœä¸keyä¸åŒï¼‰
                            if (subItem.name && subItem.name !== subItem.key) {
                                customPanelMapping[subItem.name] = displayName;
                            }

                            // ğŸ”§ ç§»é™¤é”™è¯¯çš„åå‘æ˜ å°„é€»è¾‘
                            // åå‘æ˜ å°„ä¼šå¯¼è‡´ä¸­æ–‡å­—æ®µåè¢«é”™è¯¯æ˜ å°„åˆ°col_X
                        }
                    });

                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆå¹¶è‡ªå®šä¹‰é¢æ¿æ˜ å°„ï¼Œä¸è¦è¦†ç›–åŸºç¡€æ˜ å°„ï¼
                    if (Object.keys(customPanelMapping).length > 0) {
                        // ä½¿ç”¨åˆå¹¶è€Œä¸æ˜¯è¦†ç›–ï¼Œç¡®ä¿æ ‡å‡†æ˜ å°„ä¸ä¼šä¸¢å¤±
                        baseMapping[panelId] = {
                            ...(baseMapping[panelId] || {}), // ä¿ç•™å·²æœ‰çš„åŸºç¡€æ˜ å°„
                            ...customPanelMapping              // æ·»åŠ è‡ªå®šä¹‰å­—æ®µæ˜ å°„
                        };
                        // ğŸ”§ ä¿®å¤ï¼šåªåœ¨é¦–æ¬¡ç”Ÿæˆæ—¶è¾“å‡ºæ—¥å¿—ï¼Œé¿å…é‡å¤æ—¥å¿—
                        if (!this._cachedCompleteMapping) {
                            console.log(`[InfoBarSettings] ğŸ“Š æ·»åŠ è‡ªå®šä¹‰é¢æ¿å­—æ®µæ˜ å°„: ${panelId}`, customPanelMapping);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ è‡ªå®šä¹‰é¢æ¿å­—æ®µæ˜ å°„å¤±è´¥:', error);
        }

        // ğŸ”§ æ–°å¢ï¼šåŠ¨æ€æ·»åŠ åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­—æ®µæ˜ å°„ï¼ˆå¦‚interactioné¢æ¿çš„è‡ªå®šä¹‰å­—æ®µï¼‰
        try {
            const context = window.SillyTavern?.getContext?.();
            if (context) {
                const extensionSettings = context.extensionSettings;
                const configs = extensionSettings?.['Information bar integration tool'] || {};

                // éå†æ‰€æœ‰åŸºç¡€é¢æ¿é…ç½®
                for (const [panelId, panelConfig] of Object.entries(configs)) {
                    // è·³è¿‡éé¢æ¿é…ç½®
                    if (!panelConfig || typeof panelConfig !== 'object' || !panelConfig.subItems) {
                        continue;
                    }

                    // åªå¤„ç†åŸºç¡€é¢æ¿ï¼ˆå·²ç»åœ¨baseMappingä¸­å­˜åœ¨çš„é¢æ¿ï¼‰
                    if (!baseMapping[panelId]) {
                        continue;
                    }

                    // ä¸ºåŸºç¡€é¢æ¿æ·»åŠ è‡ªå®šä¹‰å­—æ®µæ˜ å°„
                    const customFieldMapping = {};
                    if (Array.isArray(panelConfig.subItems)) {
                        panelConfig.subItems.forEach(subItem => {
                            if (subItem.key) {
                                // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨subItemçš„displayNameæˆ–nameï¼Œé¿å…å¾ªç¯ä¾èµ–
                                const displayName = subItem.displayName || subItem.name || subItem.key;

                                // ä½¿ç”¨å­—æ®µçš„keyä½œä¸ºæ˜ å°„é”®
                                customFieldMapping[subItem.key] = displayName;

                                // ğŸ”§ å…¼å®¹æ€§ï¼šåŒæ—¶æ”¯æŒnameå­—æ®µï¼ˆå¦‚æœä¸keyä¸åŒï¼‰
                                if (subItem.name && subItem.name !== subItem.key) {
                                    customFieldMapping[subItem.name] = displayName;
                                }

                                // ğŸ”§ ç§»é™¤é”™è¯¯çš„åå‘æ˜ å°„é€»è¾‘
                                // åå‘æ˜ å°„ä¼šå¯¼è‡´ä¸­æ–‡å­—æ®µåè¢«é”™è¯¯æ˜ å°„åˆ°col_X
                            }
                        });
                    }

                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆå¹¶è‡ªå®šä¹‰å­—æ®µæ˜ å°„åˆ°åŸºç¡€é¢æ¿æ˜ å°„
                    if (Object.keys(customFieldMapping).length > 0) {
                        baseMapping[panelId] = {
                            ...(baseMapping[panelId] || {}), // ä¿ç•™å·²æœ‰çš„åŸºç¡€æ˜ å°„
                            ...customFieldMapping              // æ·»åŠ è‡ªå®šä¹‰å­—æ®µæ˜ å°„
                        };
                        // ğŸ”§ ä¿®å¤ï¼šåªåœ¨é¦–æ¬¡ç”Ÿæˆæ—¶è¾“å‡ºæ—¥å¿—ï¼Œé¿å…é‡å¤æ—¥å¿—
                        if (!this._cachedCompleteMapping) {
                            console.log(`[InfoBarSettings] ğŸ“Š æ·»åŠ åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­—æ®µæ˜ å°„: ${panelId}`, customFieldMapping);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­—æ®µæ˜ å°„å¤±è´¥:', error);
        }

        // ğŸ”§ æ–°å¢ï¼šç¼“å­˜æ˜ å°„ç»“æœ
        this._cachedCompleteMapping = baseMapping;

        console.log('[InfoBarSettings] âœ… å®Œæ•´æ˜¾ç¤ºåç§°æ˜ å°„ç”Ÿæˆå®Œæˆ:', Object.keys(baseMapping));
        return baseMapping;
    }

    /**
     * æ›´æ–°å­é¡¹åˆ—è¡¨
     */
    updateSubitemList(menu, panelType) {
        try {
            console.log(`[InfoBarSettings] ğŸ”„ æ›´æ–°å­é¡¹åˆ—è¡¨: ${panelType}`);

            const subitemList = menu.querySelector('.subitem-list');
            if (!subitemList) return;

            // åŠ¨æ€è·å–é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            const panelConfig = enabledPanels[panelType];

            if (!panelConfig) {
                console.warn(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é¢æ¿é…ç½®: ${panelType}`);
                return;
            }

            // ç”Ÿæˆæ–°çš„å­é¡¹åˆ—è¡¨HTML
            const newSubitemListHtml = this.generateSubitemListHtml(panelType, panelConfig);
            subitemList.innerHTML = newSubitemListHtml;

            // é‡æ–°ç»‘å®šå­é¡¹æŒ‰é’®äº‹ä»¶
            const newAddSubitemBtns = subitemList.querySelectorAll('.add-subitem-btn');
            newAddSubitemBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fieldType = btn.closest('.subitem-item').dataset.field;
                    const area = menu.querySelector('.menu-header h3').textContent.includes('é¡¶éƒ¨') ? 'top' : 'bottom';
                    console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹: ${fieldType} åˆ° ${area}`);
                    this.addSubitemToPreview(fieldType, area, 'new');
                    menu.remove();
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å­é¡¹åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ é¢æ¿åˆ°é¢„è§ˆ
     */
    addPanelToPreview(panelType, area, position) {
        try {
            console.log(`[InfoBarSettings] ğŸ­ æ·»åŠ é¢æ¿åˆ°é¢„è§ˆ: ${panelType} (åŒºåŸŸ: ${area}, ä½ç½®: ${position})`);

            // æ ¹æ®åŒºåŸŸé€‰æ‹©æ­£ç¡®çš„å®¹å™¨
            const containerClass = area === 'top' ? '.top-embedded-panels' : '.bottom-embedded-panels';
            const embeddedPanels = this.modal?.querySelector(containerClass);
            if (!embeddedPanels) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°${area}åŒºåŸŸçš„åµŒå…¥é¢æ¿å®¹å™¨`);
                return;
            }

            // åŠ¨æ€è·å–é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            const panelConfig = enabledPanels[panelType];

            if (!panelConfig) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°é¢æ¿é…ç½®: ${panelType}`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é¢„è§ˆå…ƒç´ åˆ›å»ºé¢æ¿ï¼Œä¿æŒä¸€è‡´æ€§
            const panelButton = this.createPreviewPanelElement(panelType, 'panel');
            if (!panelButton) {
                console.error(`[InfoBarSettings] âŒ åˆ›å»ºé¢æ¿é¢„è§ˆå…ƒç´ å¤±è´¥: ${panelType}`);
                return;
            }

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            panelButton.addEventListener('click', () => {
                this.showDemoPanelPopup(panelType);
            });

            // æ ¹æ®ä½ç½®æ’å…¥
            if (position === 'top') {
                embeddedPanels.insertBefore(panelButton, embeddedPanels.firstChild);
            } else {
                embeddedPanels.appendChild(panelButton);
            }

            // å°†æ·»åŠ çš„é¢æ¿å†™å…¥é…ç½®å¸ƒå±€
            this.persistFrontendLayout({ type: 'panel', id: panelType }, area);

            // è·å–é¢æ¿åç§°ç”¨äºæ—¥å¿—
            const config = this.getPanelDisplayInfo(panelType, panelConfig);
            console.log(`[InfoBarSettings] âœ… é¢æ¿ ${config.name} å·²æ·»åŠ åˆ°é¢„è§ˆ`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿åˆ°é¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹åˆ°é¢„è§ˆ
     */
    addSubitemToPreview(fieldType, area, position) {
        try {
            console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹åˆ°é¢„è§ˆ: ${fieldType} (åŒºåŸŸ: ${area}, ä½ç½®: ${position})`);

            // æ ¹æ®åŒºåŸŸé€‰æ‹©æ­£ç¡®çš„å®¹å™¨
            const containerClass = area === 'top' ? '.top-embedded-panels' : '.bottom-embedded-panels';
            const embeddedPanels = this.modal?.querySelector(containerClass);
            if (!embeddedPanels) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°${area}åŒºåŸŸçš„åµŒå…¥é¢æ¿å®¹å™¨`);
                return;
            }

            // åŠ¨æ€è·å–å­é¡¹æ˜¾ç¤ºåç§°
            const displayName = this.getSubitemDisplayName(fieldType);
            const config = {
                field: displayName,
                value: this.getSubitemDemoValue(fieldType, displayName)
            };

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é¢„è§ˆå…ƒç´ åˆ›å»ºå­é¡¹ï¼Œä¿æŒä¸€è‡´æ€§
            const subitemDisplay = this.createPreviewPanelElement(fieldType, 'subitem');
            if (!subitemDisplay) {
                console.error(`[InfoBarSettings] âŒ åˆ›å»ºå­é¡¹é¢„è§ˆå…ƒç´ å¤±è´¥: ${fieldType}`);
                return;
            }

            // æ ¹æ®ä½ç½®æ’å…¥
            if (position === 'top') {
                embeddedPanels.insertBefore(subitemDisplay, embeddedPanels.firstChild);
            } else {
                embeddedPanels.appendChild(subitemDisplay);
            }

            // å°†æ·»åŠ çš„å­é¡¹å†™å…¥é…ç½®å¸ƒå±€
            const resolvedId = this.resolveFieldQualifiedId(fieldType);
            this.persistFrontendLayout({ type: 'subitem', id: resolvedId }, area);

            console.log(`[InfoBarSettings] âœ… å­é¡¹ ${config.field} å·²æ·»åŠ åˆ°é¢„è§ˆ`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹åˆ°é¢„è§ˆå¤±è´¥:', error);
        }
    }
    /**
     * è·å–å­é¡¹æ˜¾ç¤ºåç§°
     */
    getSubitemDisplayName(fieldKey) {
        try {
            // ğŸ”§ ä¿®å¤ï¼šå¤„ç†å®Œæ•´IDæ ¼å¼ï¼ˆpanel.fieldï¼‰å’Œç®€å•å­—æ®µå
            let targetPanelId = null;
            let targetFieldKey = fieldKey;

            if (fieldKey.includes('.')) {
                [targetPanelId, targetFieldKey] = fieldKey.split('.');
            }

            const enabledPanels = this.getEnabledPanels();

            // å¦‚æœæŒ‡å®šäº†é¢æ¿IDï¼Œåªåœ¨è¯¥é¢æ¿ä¸­æŸ¥æ‰¾
            if (targetPanelId && enabledPanels[targetPanelId]) {
                const subItems = this.getEnabledSubItems(targetPanelId, enabledPanels[targetPanelId]);
                const foundSubItem = subItems.find(item => item.key === targetFieldKey);

                if (foundSubItem) {
                    return foundSubItem.displayName;
                }

                // å¦‚æœåœ¨æŒ‡å®šé¢æ¿ä¸­æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»å®Œæ•´æ˜ å°„ä¸­è·å–
                const completeMapping = this.getCompleteDisplayNameMapping();
                if (completeMapping[targetPanelId] && completeMapping[targetPanelId][targetFieldKey]) {
                    return completeMapping[targetPanelId][targetFieldKey];
                }
            } else {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šé¢æ¿IDï¼Œåœ¨æ‰€æœ‰é¢æ¿ä¸­æŸ¥æ‰¾
                for (const [panelId, panelConfig] of Object.entries(enabledPanels)) {
                    const subItems = this.getEnabledSubItems(panelId, panelConfig);
                    const foundSubItem = subItems.find(item => item.key === targetFieldKey);

                    if (foundSubItem) {
                        return foundSubItem.displayName;
                    }
                }
            }

            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›å­—æ®µé”®å
            return targetFieldKey;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å­é¡¹æ˜¾ç¤ºåç§°å¤±è´¥:', error);
            return fieldKey;
        }
    }

    /**
     * è·å–å­é¡¹æ¼”ç¤ºå€¼
     */
    getSubitemDemoValue(fieldKey, displayName) {
        // æ ¹æ®å­—æ®µç±»å‹è¿”å›åˆé€‚çš„æ¼”ç¤ºå€¼
        const demoValues = {
            // ä¸ªäººä¿¡æ¯ç›¸å…³
            'name': 'å¼ ä¸‰',
            'age': '25å²',
            'gender': 'ç”·',
            'occupation': 'å†’é™©è€…',
            'level': 'Lv.15',
            'experience': '2847/3000',
            'health': 'è‰¯å¥½',
            'mood': 'æ„‰å¿«',

            // äº¤äº’å¯¹è±¡ç›¸å…³
            'npc_name': 'è‰¾è‰ä¸',
            'relationship': 'æœ‹å‹',
            'attitude': 'å‹å¥½',
            'favorability': '70/100',
            'emotion': 'é«˜å…´',

            // ä¸–ç•Œä¿¡æ¯ç›¸å…³
            'location': 'è‰¾å°”ç™»åŸ',
            'time': 'ä¸Šåˆ10ç‚¹',
            'weather': 'æ™´æœ—',
            'environment': 'åŸå¸‚è¡—é“',
            'atmosphere': 'ç¹å¿™',

            // èƒŒåŒ…ç›¸å…³
            'gold': '1,247æš',
            'weapon': 'é“¶å‰‘',
            'armor': 'çš®ç”²',
            'items': 'ç”Ÿå‘½è¯æ°´ x3',
            'consumables': 'é¢åŒ… x5'
        };

        // å¦‚æœæœ‰é¢„è®¾å€¼ï¼Œä½¿ç”¨é¢„è®¾å€¼
        if (demoValues[fieldKey]) {
            return demoValues[fieldKey];
        }

        // æ ¹æ®æ˜¾ç¤ºåç§°æ¨æµ‹åˆé€‚çš„å€¼
        if (displayName.includes('åç§°') || displayName.includes('å§“å')) {
            return 'ç¤ºä¾‹åç§°';
        } else if (displayName.includes('ç­‰çº§') || displayName.includes('çº§åˆ«')) {
            return 'Lv.1';
        } else if (displayName.includes('æ•°é‡')) {
            return '5';
        } else if (displayName.includes('çŠ¶æ€')) {
            return 'æ­£å¸¸';
        } else {
            return 'ç¤ºä¾‹å€¼';
        }
    }

    /**
     * æ¸…ç©ºé¢„è§ˆå†…å®¹
     */
    clearPreviewContent() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ æ¸…ç©ºé¢„è§ˆå†…å®¹');

            let totalCleared = 0;

            // æ¸…ç©ºé¡¶éƒ¨åŒºåŸŸ
            const topEmbeddedPanels = this.modal?.querySelector('.top-embedded-panels');
            if (topEmbeddedPanels) {
                const topDynamicElements = topEmbeddedPanels.querySelectorAll('.panel-button:not(.demo), .subitem-display:not(.demo)');
                topDynamicElements.forEach(element => element.remove());
                totalCleared += topDynamicElements.length;
                console.log(`[InfoBarSettings] ğŸ” å·²æ¸…ç©ºé¡¶éƒ¨åŒºåŸŸ ${topDynamicElements.length} ä¸ªåŠ¨æ€å…ƒç´ `);
            }

            // æ¸…ç©ºåº•éƒ¨åŒºåŸŸ
            const bottomEmbeddedPanels = this.modal?.querySelector('.bottom-embedded-panels');
            if (bottomEmbeddedPanels) {
                const bottomDynamicElements = bottomEmbeddedPanels.querySelectorAll('.panel-button:not(.demo), .subitem-display:not(.demo)');
                bottomDynamicElements.forEach(element => element.remove());
                totalCleared += bottomDynamicElements.length;
                console.log(`[InfoBarSettings] ğŸ”½ å·²æ¸…ç©ºåº•éƒ¨åŒºåŸŸ ${bottomDynamicElements.length} ä¸ªåŠ¨æ€å…ƒç´ `);
            }

            console.log(`[InfoBarSettings] âœ… æ€»å…±æ¸…ç©º ${totalCleared} ä¸ªåŠ¨æ€å…ƒç´ `);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢„è§ˆå†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * å°†æ·»åŠ çš„é¢æ¿/å­é¡¹æŒä¹…åŒ–åˆ°å‰ç«¯æ˜¾ç¤ºé…ç½®
     */
    async persistFrontendLayout(item, area) {
        try {
            console.log(`[InfoBarSettings] ğŸ’¾ æŒä¹…åŒ–å‰ç«¯å¸ƒå±€: ${item.type} ${item.id} åˆ° ${area}`);

            // ä½¿ç”¨FrontendDisplayManagerçš„æ ‡å‡†è¯»å–å’Œä¿å­˜æ–¹æ³•ï¼Œç¡®ä¿é…ç½®ä¸€è‡´æ€§
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è¯»å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();
            console.log('[InfoBarSettings] ğŸ“‹ å½“å‰é…ç½®:', currentConfig);

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†æ‰€æœ‰æ•°ç»„ä¸­çš„é‡å¤é¡¹ï¼Œç„¶åæ·»åŠ æ–°é¡¹
            const cleanArray = (arr) => [...new Set(arr || [])];

            // æ ¹æ®ç±»å‹æ·»åŠ åˆ°ç›¸åº”æ•°ç»„
            if (item.type === 'panel') {
                const targetKey = area === 'top' ? 'topPanels' : 'bottomPanels';
                let targetArray = cleanArray(currentConfig[targetKey]);
                if (!targetArray.includes(item.id)) {
                    targetArray.push(item.id);
                    console.log(`[InfoBarSettings] â• æ·»åŠ é¢æ¿ ${item.id} åˆ° ${targetKey}`);
                } else {
                    console.log(`[InfoBarSettings] â„¹ï¸ é¢æ¿ ${item.id} å·²å­˜åœ¨äº ${targetKey}ï¼Œè·³è¿‡æ·»åŠ `);
                }
                currentConfig[targetKey] = targetArray;
            } else if (item.type === 'subitem') {
                const targetKey = area === 'top' ? 'topSubitems' : 'bottomSubitems';
                let targetArray = cleanArray(currentConfig[targetKey]);
                if (!targetArray.includes(item.id)) {
                    targetArray.push(item.id);
                    console.log(`[InfoBarSettings] â• æ·»åŠ å­é¡¹ ${item.id} åˆ° ${targetKey}`);
                } else {
                    console.log(`[InfoBarSettings] â„¹ï¸ å­é¡¹ ${item.id} å·²å­˜åœ¨äº ${targetKey}ï¼Œè·³è¿‡æ·»åŠ `);
                }
                currentConfig[targetKey] = targetArray;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†æ‰€æœ‰é…ç½®æ•°ç»„ä¸­çš„é‡å¤é¡¹
            currentConfig.topPanels = cleanArray(currentConfig.topPanels);
            currentConfig.bottomPanels = cleanArray(currentConfig.bottomPanels);
            currentConfig.topSubitems = cleanArray(currentConfig.topSubitems);
            currentConfig.bottomSubitems = cleanArray(currentConfig.bottomSubitems);

            // ç¡®ä¿å¯ç”¨çŠ¶æ€
            currentConfig.enabled = true;

            // ä¿å­˜å®Œæ•´é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜å‰ç«¯æ˜¾ç¤ºé…ç½®:', {
                topPanels: currentConfig.topPanels,
                bottomPanels: currentConfig.bottomPanels,
                topSubitems: currentConfig.topSubitems,
                bottomSubitems: currentConfig.bottomSubitems,
                enabled: currentConfig.enabled
            });

            // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤º
            this.updateFrontendDisplayManagerSettings();
            this.refreshFrontendDisplay();

            // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“é¢„è§ˆ
            this.renderFrontendDisplayPreview(currentConfig);

        } catch (e) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜å‰ç«¯æ˜¾ç¤ºé…ç½®å¤±è´¥:', e);
        }
    }

    /**
     * åˆ·æ–°å‰ç«¯æ˜¾ç¤º
     */
    refreshFrontendDisplay() {
        try {
            // è·å–å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (fdm) {
                // æ£€æŸ¥æ˜¯å¦æœ‰åŒ…è£…çš„æ¶ˆæ¯
                const wrappedMessages = document.querySelectorAll('.frontend-message-wrapper');
                if (wrappedMessages.length > 0) {
                    // åªé‡æ–°æ¸²æŸ“æœ€åä¸€ä¸ªåŒ…è£…çš„æ¶ˆæ¯
                    const lastWrapper = wrappedMessages[wrappedMessages.length - 1];
                    const messageElement = lastWrapper.querySelector('.ai-message-container .mes');
                    if (messageElement) {
                        fdm.renderLayoutForMessage(messageElement);
                        console.log('[InfoBarSettings] ğŸ”„ å·²åˆ·æ–°å‰ç«¯æ˜¾ç¤º (ä»…æ¸²æŸ“å¸ƒå±€)');
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰åŒ…è£…çš„æ¶ˆæ¯ï¼Œä½†å‰ç«¯æ˜¾ç¤ºå·²å¯ç”¨ï¼Œåˆ™åˆå§‹åŒ–å‰ç«¯æ˜¾ç¤º
                    if (fdm.enabled) {
                        console.log('[InfoBarSettings] ğŸ”„ æ²¡æœ‰åŒ…è£…æ¶ˆæ¯ï¼Œé‡æ–°åˆå§‹åŒ–å‰ç«¯æ˜¾ç¤º');
                        fdm.initializeFrontendDisplay();
                    } else {
                        console.log('[InfoBarSettings] âš ï¸ å‰ç«¯æ˜¾ç¤ºæœªå¯ç”¨ï¼Œè·³è¿‡åˆ·æ–°');
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°å‰ç«¯æ˜¾ç¤ºå¤±è´¥:', error);
        }
    }

    /**
     * å°†åŸºç¡€å­—æ®µé”®è¡¥å…¨ä¸º panel.key å½¢å¼
     */
    resolveFieldQualifiedId(fieldKey) {
        try {
            if (fieldKey.includes('.')) return fieldKey;

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½åŒ¹é…å­—æ®µåˆ°æ­£ç¡®çš„é¢æ¿
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (fdm) {
                const availableSubItems = fdm.getAvailableSubItems();

                // æŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„å­—æ®µ
                const exactMatch = availableSubItems.find(item =>
                    item.id.endsWith(`.${fieldKey}`)
                );

                if (exactMatch) {
                    console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} åŒ¹é…åˆ°: ${exactMatch.id}`);
                    return exactMatch.id;
                }

                // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•æ ¹æ®å­—æ®µåæ¨æ–­é¢æ¿
                const fieldToPanelMap = {
                    'time': 'world',
                    'listView': 'tasks',
                    'kanbanView': 'tasks',
                    'calendarView': 'tasks',
                    'name': 'personal',
                    'å§“å': 'personal',
                    'å¯¹è±¡åç§°': 'interaction',
                    'location': 'world',
                    'mood': 'interaction'
                };

                const inferredPanel = fieldToPanelMap[fieldKey];
                if (inferredPanel) {
                    const inferredId = `${inferredPanel}.${fieldKey}`;
                    console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} æ¨æ–­ä¸º: ${inferredId}`);
                    return inferredId;
                }
            }

            // å…œåº•ï¼šå°è¯•ä»æ¨¡æ€æ¡†æ ‡é¢˜è·å–é¢æ¿IDï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            const title = this.modal?.querySelector('.subitem-list h4')?.textContent || '';
            const map = [
                { key: 'ä¸ªäººä¿¡æ¯', id: 'personal' },
                { key: 'ä¸–ç•Œä¿¡æ¯', id: 'world' },
                { key: 'äº¤äº’å¯¹è±¡', id: 'interaction' },
                { key: 'ä»»åŠ¡', id: 'tasks' },
                { key: 'ç»„ç»‡', id: 'organization' },
                { key: 'æ–°é—»', id: 'news' },
                { key: 'èƒŒåŒ…', id: 'inventory' },
                { key: 'èƒ½åŠ›', id: 'abilities' },
                { key: 'å‰§æƒ…', id: 'plot' },
                { key: 'ä¿®ç‚¼', id: 'cultivation' },
                { key: 'å¥‡å¹»', id: 'fantasy' },
                { key: 'ç°ä»£', id: 'modern' },
                { key: 'å†å²', id: 'historical' },
                { key: 'é­”æ³•', id: 'magic' },
                { key: 'è®­ç»ƒ', id: 'training' }
            ];
            const found = map.find(m => title.includes(m.key));
            const result = found ? `${found.id}.${fieldKey}` : fieldKey;

            console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} é€šè¿‡æ ‡é¢˜è§£æä¸º: ${result}`);
            return result;
        } catch (e) {
            console.warn(`[InfoBarSettings] âš ï¸ è§£æå­—æ®µIDå¤±è´¥: ${fieldKey}`, e);
            return fieldKey;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆå†…å®¹
     * æ ¹æ®é…ç½®é‡æ–°æ¸²æŸ“é¢„è§ˆåŒºåŸŸçš„é¢æ¿å’Œå­é¡¹
     */
    renderFrontendDisplayPreview(config) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ æ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆ:', config);

            if (!config) {
                console.warn('[InfoBarSettings] âš ï¸ é…ç½®ä¸ºç©ºï¼Œè·³è¿‡é¢„è§ˆæ¸²æŸ“');
                return;
            }

            // è·å–é¢„è§ˆå®¹å™¨
            const topContainer = this.modal?.querySelector('.top-embedded-panels');
            const bottomContainer = this.modal?.querySelector('.bottom-embedded-panels');

            if (!topContainer || !bottomContainer) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é¢„è§ˆå®¹å™¨');
                return;
            }

            // æ¸…ç©ºç°æœ‰é¢„è§ˆå†…å®¹
            topContainer.innerHTML = '';
            bottomContainer.innerHTML = '';

            // æ¸²æŸ“é¡¶éƒ¨é¢æ¿
            if (config.topPanels && Array.isArray(config.topPanels)) {
                config.topPanels.forEach(panelId => {
                    const panelElement = this.createPreviewPanelElement(panelId, 'panel');
                    if (panelElement) {
                        topContainer.appendChild(panelElement);
                    }
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šé™åˆ¶é¡¶éƒ¨å­é¡¹æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…é¢„è§ˆè¿‡äºæ‹¥æŒ¤
            if (config.topSubitems && Array.isArray(config.topSubitems)) {
                // åªæ˜¾ç¤ºå‰3ä¸ªå­é¡¹ï¼Œå…¶ä½™ç”¨çœç•¥å·è¡¨ç¤º
                const maxSubitems = 3;
                const subitems = config.topSubitems.slice(0, maxSubitems);

                subitems.forEach(subitemId => {
                    const subitemElement = this.createPreviewPanelElement(subitemId, 'subitem');
                    if (subitemElement) {
                        topContainer.appendChild(subitemElement);
                    }
                });

                // å¦‚æœæœ‰æ›´å¤šå­é¡¹ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
                if (config.topSubitems.length > maxSubitems) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'preview-more-indicator';
                    moreElement.innerHTML = `
                        <span class="preview-item-name">â‹¯ è¿˜æœ‰${config.topSubitems.length - maxSubitems}ä¸ªå­é¡¹</span>
                    `;
                    topContainer.appendChild(moreElement);
                }
            }

            // æ¸²æŸ“åº•éƒ¨é¢æ¿
            if (config.bottomPanels && Array.isArray(config.bottomPanels)) {
                config.bottomPanels.forEach(panelId => {
                    const panelElement = this.createPreviewPanelElement(panelId, 'panel');
                    if (panelElement) {
                        bottomContainer.appendChild(panelElement);
                    }
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šé™åˆ¶åº•éƒ¨å­é¡¹æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…é¢„è§ˆè¿‡äºæ‹¥æŒ¤
            if (config.bottomSubitems && Array.isArray(config.bottomSubitems)) {
                // åªæ˜¾ç¤ºå‰3ä¸ªå­é¡¹ï¼Œå…¶ä½™ç”¨çœç•¥å·è¡¨ç¤º
                const maxSubitems = 3;
                const subitems = config.bottomSubitems.slice(0, maxSubitems);

                subitems.forEach(subitemId => {
                    const subitemElement = this.createPreviewPanelElement(subitemId, 'subitem');
                    if (subitemElement) {
                        bottomContainer.appendChild(subitemElement);
                    }
                });

                // å¦‚æœæœ‰æ›´å¤šå­é¡¹ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
                if (config.bottomSubitems.length > maxSubitems) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'preview-more-indicator';
                    moreElement.innerHTML = `
                        <span class="preview-item-name">â‹¯ è¿˜æœ‰${config.bottomSubitems.length - maxSubitems}ä¸ªå­é¡¹</span>
                    `;
                    bottomContainer.appendChild(moreElement);
                }
            }

            console.log('[InfoBarSettings] âœ… å‰ç«¯æ˜¾ç¤ºé¢„è§ˆæ¸²æŸ“å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ›å»ºé¢„è§ˆé¢æ¿å…ƒç´ 
     * ä¸ºé¢„è§ˆåŒºåŸŸåˆ›å»ºé¢æ¿æˆ–å­é¡¹çš„æ˜¾ç¤ºå…ƒç´ 
     */
    createPreviewPanelElement(id, type) {
        try {
            const element = document.createElement('div');
            element.className = type === 'panel' ? 'preview-panel' : 'preview-subitem';
            element.dataset.id = id;
            element.dataset.type = type;

            // è·å–æ˜¾ç¤ºåç§°ï¼ˆä¸ä½¿ç”¨å›¾æ ‡ï¼Œå› ä¸ºå‰ç«¯æ˜¯æŒ‰é’®UIï¼‰
            let displayName = id;

            try {
                if (type === 'panel') {
                    // ğŸ”§ ä¿®å¤ï¼šé¢æ¿ä½¿ç”¨æ­£ç¡®çš„getPanelDisplayInfoå‡½æ•°è·å–åç§°
                    const enabledPanels = this.getEnabledPanels();
                    const panelConfig = enabledPanels[id];
                    const panelInfo = this.getPanelDisplayInfo(id, panelConfig);

                    displayName = panelInfo.name || id;

                    console.log(`[InfoBarSettings] ğŸ¨ é¢æ¿é¢„è§ˆå…ƒç´ : ${id} -> ${displayName}`);
                } else {
                    // ğŸ”§ ä¿®å¤ï¼šå­é¡¹éœ€è¦é€šè¿‡é¢æ¿æ˜ å°„æ¥è·å–æ­£ç¡®çš„ä¸­æ–‡åç§°
                    displayName = this.getSubitemDisplayName(id) || id;

                    console.log(`[InfoBarSettings] ğŸ¨ å­é¡¹é¢„è§ˆå…ƒç´ : ${id} -> ${displayName}`);
                }
            } catch (error) {
                console.warn('[InfoBarSettings] âš ï¸ è·å–æ˜¾ç¤ºåç§°å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ID:', error);
                displayName = id;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æŒ‰é’®æ ·å¼çš„é¢„è§ˆï¼Œæ¨¡æ‹ŸçœŸå®å‰ç«¯æ˜¾ç¤º
            element.innerHTML = `
                <span class="preview-item-name">${displayName}</span>
                <button class="remove-preview-item" data-id="${id}" data-type="${type}" title="ç§»é™¤">Ã—</button>
            `;

            // æ·»åŠ ç§»é™¤äº‹ä»¶
            const removeButton = element.querySelector('.remove-preview-item');
            if (removeButton) {
                removeButton.addEventListener('click', () => {
                    this.removePreviewItem(id, type);
                });
            }

            return element;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºé¢„è§ˆå…ƒç´ å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç§»é™¤é¢„è§ˆé¡¹
     * ä»é…ç½®å’Œé¢„è§ˆä¸­ç§»é™¤æŒ‡å®šçš„é¢æ¿æˆ–å­é¡¹
     */
    async removePreviewItem(id, type) {
        try {
            console.log(`[InfoBarSettings] ğŸ—‘ï¸ ç§»é™¤é¢„è§ˆé¡¹: ${type} ${id}`);

            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è·å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();

            // ä»ç›¸åº”æ•°ç»„ä¸­ç§»é™¤é¡¹ç›®
            if (type === 'panel') {
                if (currentConfig.topPanels) {
                    currentConfig.topPanels = currentConfig.topPanels.filter(item => item !== id);
                }
                if (currentConfig.bottomPanels) {
                    currentConfig.bottomPanels = currentConfig.bottomPanels.filter(item => item !== id);
                }
            } else if (type === 'subitem') {
                if (currentConfig.topSubitems) {
                    currentConfig.topSubitems = currentConfig.topSubitems.filter(item => item !== id);
                }
                if (currentConfig.bottomSubitems) {
                    currentConfig.bottomSubitems = currentConfig.bottomSubitems.filter(item => item !== id);
                }
            }

            // ä¿å­˜é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            this.renderFrontendDisplayPreview(currentConfig);

            // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤º
            this.updateFrontendDisplayManagerSettings();
            this.refreshFrontendDisplay();

            console.log(`[InfoBarSettings] âœ… å·²ç§»é™¤é¢„è§ˆé¡¹: ${type} ${id}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤é¢„è§ˆé¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç¡®ä¿AIæ¶ˆæ¯è¢«åŒ…è£…
     * æ£€æŸ¥å¹¶è§¦å‘AIæ¶ˆæ¯åŒ…è£…ï¼Œç”¨äºè®¾ç½®ä¿å­˜åçš„ä¿®å¤
     */
    ensureAIMessagesWrapped() {
        try {
            console.log('[InfoBarSettings] ğŸ” æ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…çŠ¶æ€...');

            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰AIæ¶ˆæ¯
            const aiMessages = document.querySelectorAll('.mes[is_user="false"]');
            console.log(`[InfoBarSettings] ğŸ“‹ æ‰¾åˆ° ${aiMessages.length} æ¡AIæ¶ˆæ¯`);

            if (aiMessages.length === 0) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰AIæ¶ˆæ¯éœ€è¦åŒ…è£…');
                return;
            }

            // æ£€æŸ¥æœ€åä¸€æ¡AIæ¶ˆæ¯æ˜¯å¦å·²åŒ…è£…
            const lastMessage = aiMessages[aiMessages.length - 1];
            const existingWrapper = lastMessage.previousElementSibling;

            if (existingWrapper && existingWrapper.classList.contains('frontend-message-wrapper')) {
                console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯å·²æ­£ç¡®åŒ…è£…');
                return;
            }

            // æ²¡æœ‰åŒ…è£…ï¼Œè§¦å‘åŒ…è£…
            console.log('[InfoBarSettings] ğŸ”§ AIæ¶ˆæ¯æœªåŒ…è£…ï¼Œè§¦å‘é‡æ–°åŒ…è£…...');

            if (fdm.wrapExistingMessagesWithRetry) {
                fdm.wrapExistingMessagesWithRetry(0);
            } else if (fdm.wrapExistingMessages) {
                fdm.wrapExistingMessages();
            } else {
                console.warn('[InfoBarSettings] âš ï¸ å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨ç¼ºå°‘åŒ…è£…æ–¹æ³•');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å¯¼å‡ºé€‰é¡¹
     */
    getExportOptions() {
        try {
            const panelConfigs = this.modal.querySelector('#export-panel-configs')?.checked || false;
            const panelRules = this.modal.querySelector('#export-panel-rules')?.checked || false;
            const fieldRules = this.modal.querySelector('#export-field-rules')?.checked || false;
            const themeSettings = this.modal.querySelector('#export-theme-settings')?.checked || false;
            const apiSettings = this.modal.querySelector('#export-api-settings')?.checked || false;
            const allSettings = this.modal.querySelector('#export-all-settings')?.checked || false;

            const hasAnySelection = panelConfigs || panelRules || fieldRules || themeSettings || apiSettings || allSettings;

            return {
                panelConfigs,
                panelRules,
                fieldRules,
                themeSettings,
                apiSettings,
                allSettings,
                hasAnySelection
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯¼å‡ºé€‰é¡¹å¤±è´¥:', error);
            return { hasAnySelection: false };
        }
    }

    /**
     * æ·»åŠ é¢æ¿é…ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addPanelConfigsToExport(exportData) {
        try {
            // è·å–é¢æ¿é…ç½®
            const panelConfigs = await this.configManager.getConfig('panels') || {};

            // è·å–è‡ªå®šä¹‰é¢æ¿
            const customPanels = await this.configManager.getConfig('customPanels') || {};

            // è·å–åŸºç¡€é¢æ¿é…ç½®
            const basicPanelIds = ['personal','world','interaction','tasks','organization','news','inventory','abilities','plot','cultivation','fantasy','modern','historical','magic','training'];
            const basicPanelConfigs = {};

            for (const panelId of basicPanelIds) {
                const config = await this.configManager.getConfig(panelId);
                if (config) {
                    basicPanelConfigs[panelId] = config;
                }
            }

            exportData.configs.panelConfigs = {
                panels: panelConfigs,
                customPanels: customPanels,
                basicPanels: basicPanelConfigs
            };

            console.log('[InfoBarSettings] âœ… é¢æ¿é…ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ é¢æ¿è§„åˆ™åˆ°å¯¼å‡ºæ•°æ®
     */
    async addPanelRulesToExport(exportData) {
        try {
            const panelRuleManager = window.SillyTavernInfobar?.modules?.panelRuleManager;
            if (!panelRuleManager) {
                console.warn('[InfoBarSettings] âš ï¸ é¢æ¿è§„åˆ™ç®¡ç†å™¨ä¸å¯ç”¨');
                return;
            }

            // è·å–æ‰€æœ‰é¢æ¿è§„åˆ™
            const panelRulesData = await this.configManager.getData('panel_rules') || {};

            exportData.configs.panelRules = panelRulesData;

            console.log('[InfoBarSettings] âœ… é¢æ¿è§„åˆ™å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿è§„åˆ™å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­—æ®µè§„åˆ™åˆ°å¯¼å‡ºæ•°æ®
     */
    async addFieldRulesToExport(exportData) {
        try {
            const fieldRuleManager = window.SillyTavernInfobar?.modules?.fieldRuleManager;
            if (!fieldRuleManager) {
                console.warn('[InfoBarSettings] âš ï¸ å­—æ®µè§„åˆ™ç®¡ç†å™¨ä¸å¯ç”¨');
                return;
            }

            // è·å–æ‰€æœ‰å­—æ®µè§„åˆ™
            const fieldRulesData = await this.configManager.getData('field_rules') || {};

            exportData.configs.fieldRules = fieldRulesData;

            console.log('[InfoBarSettings] âœ… å­—æ®µè§„åˆ™å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­—æ®µè§„åˆ™å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ ä¸»é¢˜è®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addThemeSettingsToExport(exportData) {
        try {
            const themeConfig = await this.configManager.getConfig('theme') || {};

            exportData.configs.themeSettings = themeConfig;

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜è®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ APIè®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addApiSettingsToExport(exportData) {
        try {
            const apiConfig = await this.configManager.getConfig('apiConfig') || {};

            // ç§»é™¤æ•æ„Ÿä¿¡æ¯
            const safeApiConfig = { ...apiConfig };
            if (safeApiConfig.apiKey) {
                safeApiConfig.apiKey = '***REMOVED***';
            }

            exportData.configs.apiSettings = safeApiConfig;

            console.log('[InfoBarSettings] âœ… APIè®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®ï¼ˆå·²ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ APIè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ æ‰€æœ‰è®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addAllSettingsToExport(exportData) {
        try {
            // ä½¿ç”¨ç°æœ‰çš„å¯¼å‡ºæ–¹æ³•
            const fullExportData = await this.configManager.exportConfigs();

            // åˆå¹¶åˆ°å½“å‰å¯¼å‡ºæ•°æ®
            exportData.configs.allSettings = fullExportData.configs;

            console.log('[InfoBarSettings] âœ… æ‰€æœ‰è®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ æ‰€æœ‰è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ‰“å¼€å˜é‡ç®¡ç†å™¨
     */
    openVariableManager() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ åˆ›å»ºå˜é‡ç®¡ç†å™¨ç•Œé¢...');

            // åˆ›å»ºå˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
            const variableModal = this.createVariableManagerModal();
            document.body.appendChild(variableModal);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            variableModal.style.display = 'flex';

            // ç«‹å³åº”ç”¨ä¸€æ¬¡ä¸»é¢˜ï¼ˆç¡®ä¿åˆå§‹å…ƒç´ æ ·å¼æ­£ç¡®ï¼‰
            try {
                const activeThemeCard = this.modal?.querySelector('.theme-preview-card.active');
                const themeId = activeThemeCard?.getAttribute('data-theme');
                const theme = themeId ? this.getThemeById(themeId) : null;
                if (theme) this.applyVariableManagerTheme(theme);
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ‰“å¼€å˜é‡ç®¡ç†å™¨æ—¶åº”ç”¨ä¸»é¢˜å¤±è´¥:', e);
            }

            // åŠ è½½ç°æœ‰å˜é‡
            this.loadVariables();

            console.log('[InfoBarSettings] âœ… å˜é‡ç®¡ç†å™¨å·²æ‰“å¼€');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€å˜é‡ç®¡ç†å™¨å¤±è´¥:', error);
            this.showMessage('æ‰“å¼€å˜é‡ç®¡ç†å™¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * åˆ›å»ºå˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
     */
    createVariableManagerModal() {
        const modal = document.createElement('div');
        modal.className = 'variable-manager-modal';
        modal.id = 'variable-manager-modal';

        modal.innerHTML = `
            <div class="modal-overlay" onclick="this.closest('.variable-manager-modal').remove()"></div>
            <div class="modal-container">
                <!-- å¤´éƒ¨ -->
                <div class="modal-header">
                    <div class="header-left">
                        <h2><i class="fa fa-code"></i> å˜é‡ç®¡ç†å™¨</h2>
                    </div>
                    <div class="header-right">
                        <button class="modal-close" onclick="this.closest('.variable-manager-modal').remove()">Ã—</button>
                    </div>
                </div>

                <!-- ä¸»ä½“å†…å®¹ -->
                <div class="modal-body">
                    <!-- å˜é‡ç±»å‹å¯¼èˆªæ  -->
                    <div class="variable-nav">
                        <div class="nav-tabs">
                            <button class="nav-tab active" data-scope="global">
                                <i class="fa fa-globe"></i> å…¨å±€å˜é‡
                            </button>
                            <button class="nav-tab" data-scope="chat">
                                <i class="fa fa-comments"></i> èŠå¤©å˜é‡
                            </button>
                        </div>
                    </div>

                    <!-- å·¥å…·æ  -->
                    <div class="variable-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-primary" data-action="add-variable">
                                <i class="fa fa-plus"></i> æ·»åŠ å˜é‡
                            </button>
                            <select class="variable-type-select" id="variable-type-select">
                                <option value="string">å­—ç¬¦ä¸²</option>
                                <option value="number">æ•°å­—</option>
                                <option value="boolean">å¸ƒå°”å€¼</option>
                                <option value="array">æ•°ç»„</option>
                                <option value="object">å¯¹è±¡</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <div class="view-mode-toggle">
                                <button class="btn btn-sm view-mode-btn active" data-view="list" title="åˆ—è¡¨è§†å›¾">
                                    <i class="fa fa-list"></i>
                                </button>
                                <button class="btn btn-sm view-mode-btn" data-view="tree" title="æ ‘çŠ¶è§†å›¾">
                                    <i class="fa fa-sitemap"></i>
                                </button>
                            </div>
                            <input type="text" class="search-input" placeholder="æœç´¢å˜é‡..." id="variable-search">
                            <button class="btn btn-info" data-action="import-variables">
                                <i class="fa fa-upload"></i> å¯¼å…¥
                            </button>
                            <button class="btn btn-info" data-action="export-variables">
                                <i class="fa fa-download"></i> å¯¼å‡º
                            </button>
                            <button class="btn btn-danger" data-action="clear-variables" title="æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡">
                                <i class="fa fa-trash"></i> æ¸…ç©º
                            </button>
                            <button class="btn btn-secondary" data-action="refresh-variables">
                                <i class="fa fa-refresh"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <!-- å˜é‡åˆ—è¡¨ -->
                    <div class="variable-list-container">
                        <div class="variable-list" id="variable-list">
                            <!-- å˜é‡é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæ  -->
                <div class="modal-footer">
                    <div class="footer-left">
                        <span class="variable-count">å˜é‡æ•°é‡: <span id="variable-count">0</span></span>
                        <span class="variable-scope-info" id="variable-scope-info">å…¨å±€å˜é‡</span>
                    </div>
                    <div class="footer-right">
                        <button class="btn-cancel" onclick="this.closest('.variable-manager-modal').remove()">å…³é—­</button>
                        <button class="btn-save" data-action="save-variables">ä¿å­˜å˜é‡</button>
                    </div>
                </div>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        this.bindVariableManagerEvents(modal);

        return modal;
    }

    /**
     * ç»‘å®šå˜é‡ç®¡ç†å™¨äº‹ä»¶
     */
    bindVariableManagerEvents(modal) {
        // åˆå§‹åŒ–å½“å‰ä½œç”¨åŸŸå’Œè§†å›¾æ¨¡å¼
        this.currentVariableScope = 'global';
        this.currentViewMode = 'list';

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
        modal.addEventListener('click', (e) => {
            // é˜²æ­¢é‡å¤å¤„ç†
            if (e.defaultPrevented) return;

            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            // å¤„ç†å¯¼èˆªæ åˆ‡æ¢
            const navTab = e.target.closest('.nav-tab');
            if (navTab) {
                this.switchVariableScope(navTab.dataset.scope);
                return;
            }

            // å¤„ç†è§†å›¾æ¨¡å¼åˆ‡æ¢
            const viewModeBtn = e.target.closest('.view-mode-btn');
            if (viewModeBtn) {
                this.switchViewMode(viewModeBtn.dataset.view);
                return;
            }

            if (action) {
                e.preventDefault();
                e.stopPropagation();
                this.handleVariableAction(action, e, actionElement);
            }
        });

        // æœç´¢åŠŸèƒ½
        const searchInput = modal.querySelector('#variable-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterVariables(e.target.value);
            });
        }


    }

    /**
     * åˆ‡æ¢å˜é‡ä½œç”¨åŸŸ
     */
    switchVariableScope(scope) {
        this.currentVariableScope = scope;

        // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
        const modal = document.querySelector('#variable-manager-modal');
        if (modal) {
            const navTabs = modal.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.scope === scope);
            });

            // æ›´æ–°åº•éƒ¨ä¿¡æ¯
            const scopeInfo = modal.querySelector('#variable-scope-info');
            if (scopeInfo) {
                scopeInfo.textContent = scope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡';
            }
        }

        // é‡æ–°åŠ è½½å˜é‡
        this.loadVariables();

        console.log('[VariableManager] åˆ‡æ¢åˆ°', scope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡');
    }

    /**
     * åˆ‡æ¢è§†å›¾æ¨¡å¼
     */
    switchViewMode(mode) {
        this.currentViewMode = mode;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const modal = document.querySelector('#variable-manager-modal');
        if (modal) {
            const viewModeBtns = modal.querySelectorAll('.view-mode-btn');
            viewModeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });
        }

        // é‡æ–°æ¸²æŸ“å˜é‡åˆ—è¡¨
        this.renderVariableList();

        console.log('[VariableManager] åˆ‡æ¢åˆ°', mode === 'list' ? 'åˆ—è¡¨è§†å›¾' : 'æ ‘çŠ¶è§†å›¾');
    }

    /**
     * å¤„ç†å˜é‡ç®¡ç†å™¨æ“ä½œ
     */
    handleVariableAction(action, event, actionElement) {
        try {
            switch (action) {
                case 'add-variable':
                    this.addNewVariable();
                    break;
                case 'add-macro':
                    this.addNewMacro();
                    break;
                case 'save-variables':
                    this.saveVariables();
                    break;
                case 'export-variables':
                    this.exportVariables();
                    break;
                case 'import-variables':
                    this.importVariables();
                    break;
                case 'clear-variables':
                    this.clearCurrentScopeVariables();
                    break;
                case 'refresh-variables':
                    this.loadVariables();
                    break;
                case 'edit-variable':
                    const variableId = event.target.closest('.variable-item').dataset.variableId;
                    this.editVariable(variableId);
                    break;
                case 'delete-variable':
                    event.preventDefault();
                    event.stopPropagation();
                    const deleteVariableId = event.target.closest('.variable-item').dataset.variableId;
                    this.deleteVariable(deleteVariableId);
                    break;
                case 'save-variable-dialog':
                    const isEdit = actionElement.dataset.isEdit === 'true';
                    const variableKey = actionElement.dataset.variableKey || '';
                    this.saveVariableFromDialog(actionElement, isEdit, variableKey);
                    break;
                case 'toggle-view-mode':
                    this.toggleViewMode();
                    break;
                case 'add-array-item':
                    const arrayVariableId = actionElement.dataset.variableId ||
                                          event.target.closest('.variable-item')?.dataset?.variableId;
                    this.addArrayItem(arrayVariableId);
                    break;
                case 'remove-array-item':
                    const arrayItemIndex = actionElement.dataset.index;
                    const arrayVarId = event.target.closest('.variable-item')?.dataset?.variableId;
                    this.removeArrayItem(arrayVarId, parseInt(arrayItemIndex));
                    break;
                case 'add-object-property':
                    const objectVariableId = actionElement.dataset.variableId ||
                                           event.target.closest('.variable-item')?.dataset?.variableId;
                    this.addObjectProperty(objectVariableId);
                    break;
                case 'remove-object-property':
                    const propertyKey = actionElement.dataset.key;
                    const objectVarId = event.target.closest('.variable-item')?.dataset?.variableId;
                    this.removeObjectProperty(objectVarId, propertyKey);
                    break;
                case 'add-nested-array-item':
                    const addNestedArrayVarId = actionElement.dataset.variableId;
                    const addNestedArrayPath = actionElement.dataset.path;
                    this.addNestedArrayItem(addNestedArrayVarId, addNestedArrayPath);
                    break;
                case 'add-nested-object-property':
                    const addNestedObjectVarId = actionElement.dataset.variableId;
                    const addNestedObjectPath = actionElement.dataset.path;
                    this.addNestedObjectProperty(addNestedObjectVarId, addNestedObjectPath);
                    break;
                case 'remove-nested-array-item':
                    const removeNestedArrayVarId = actionElement.dataset.variableId;
                    const removeNestedArrayIndex = actionElement.dataset.index;
                    const removeNestedArrayLevel = parseInt(actionElement.dataset.level);
                    this.removeNestedArrayItem(removeNestedArrayVarId, removeNestedArrayIndex, removeNestedArrayLevel, event);
                    break;
                case 'remove-nested-object-property':
                    const removeNestedObjVarId = actionElement.dataset.variableId;
                    const removeNestedObjKey = actionElement.dataset.key;
                    const removeNestedObjPath = actionElement.dataset.path;
                    this.removeNestedObjectProperty(removeNestedObjVarId, removeNestedObjKey, removeNestedObjPath);
                    break;
                case 'edit-array-item':
                    const editArrayVarId = actionElement.dataset.variableId;
                    const editArrayIndex = actionElement.dataset.index;
                    const editArrayLevel = parseInt(actionElement.dataset.level || '0');
                    if (editArrayLevel > 0) {
                        // åµŒå¥—æ•°ç»„é¡¹ç¼–è¾‘
                        this.editNestedArrayItem(editArrayVarId, editArrayIndex, editArrayLevel, event);
                    } else {
                        // é¡¶çº§æ•°ç»„é¡¹ç¼–è¾‘
                        this.editArrayItem(editArrayVarId, editArrayIndex);
                    }
                    break;
                case 'edit-object-property':
                    const editObjVarId = actionElement.dataset.variableId;
                    const editObjKey = actionElement.dataset.key;
                    const editObjPath = actionElement.dataset.path;
                    this.editObjectProperty(editObjVarId, editObjKey, editObjPath);
                    break;
                case 'edit-nested-array':
                    const editNestedArrayVarId = actionElement.dataset.variableId;
                    const editNestedArrayIndex = actionElement.dataset.index;
                    const editNestedArrayLevel = parseInt(actionElement.dataset.level);
                    this.editNestedArrayItem(editNestedArrayVarId, editNestedArrayIndex, editNestedArrayLevel, event);
                    break;
                case 'edit-nested-object':
                    const editNestedObjVarId = actionElement.dataset.variableId;
                    const editNestedObjIndex = actionElement.dataset.index;
                    const editNestedObjLevel = parseInt(actionElement.dataset.level);
                    this.editNestedObjectItem(editNestedObjVarId, editNestedObjIndex, editNestedObjLevel, event);
                    break;
                case 'edit-nested-property-array':
                    const editNestedPropArrayVarId = actionElement.dataset.variableId;
                    const editNestedPropArrayKey = actionElement.dataset.key;
                    const editNestedPropArrayPath = actionElement.dataset.path;
                    const editNestedPropArrayLevel = parseInt(actionElement.dataset.level);
                    this.editNestedPropertyArray(editNestedPropArrayVarId, editNestedPropArrayKey, editNestedPropArrayPath, editNestedPropArrayLevel);
                    break;
                case 'edit-nested-property-object':
                    const editNestedPropObjVarId = actionElement.dataset.variableId;
                    const editNestedPropObjKey = actionElement.dataset.key;
                    const editNestedPropObjPath = actionElement.dataset.path;
                    const editNestedPropObjLevel = parseInt(actionElement.dataset.level);
                    this.editNestedPropertyObject(editNestedPropObjVarId, editNestedPropObjKey, editNestedPropObjPath, editNestedPropObjLevel);
                    break;
                case 'save-nested-property-edit':
                    const saveNestedVarId = actionElement.dataset.variableId;
                    const saveNestedKey = actionElement.dataset.key;
                    const saveNestedPath = actionElement.dataset.path;
                    const saveNestedType = actionElement.dataset.type;
                    this.saveNestedPropertyEditFromDialog(actionElement, saveNestedVarId, saveNestedKey, saveNestedPath, saveNestedType);
                    break;
                default:
                    console.log(`[VariableManager] ğŸ”˜ å¤„ç†æ“ä½œ: ${action}`);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ å¤„ç†æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½å˜é‡
     */
    async loadVariables() {
        try {
            let variables = {};

            if (this.currentVariableScope === 'global') {
                // åŠ è½½å…¨å±€å˜é‡
                variables = await this.loadGlobalVariables();
            } else {
                // åŠ è½½èŠå¤©å˜é‡
                variables = await this.loadChatVariables();
            }

            this.variables = variables;

            // æ¸²æŸ“å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… å˜é‡åŠ è½½å®Œæˆï¼Œå…±', Object.keys(variables).length, 'ä¸ª',
                this.currentVariableScope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡');
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½å˜é‡å¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½å…¨å±€å˜é‡
     */
    async loadGlobalVariables() {
        try {
            // å°è¯•ä»SillyTavernè·å–å…¨å±€å˜é‡
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                const extensionSettings = context.extensionSettings || {};

                // ä»æ‰©å±•è®¾ç½®ä¸­è·å–å…¨å±€å˜é‡
                const globalVars = extensionSettings.variables || {};

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                const variables = {};
                Object.entries(globalVars).forEach(([key, value]) => {
                    const detectedType = this.detectVariableType(value);
                    let processedValue = value;

                    // å¦‚æœæ£€æµ‹åˆ°æ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æä¸ºå¯¹è±¡
                    if (detectedType === 'object' || detectedType === 'array') {
                        if (typeof value === 'string' && this.isJsonString(value)) {
                            try {
                                processedValue = JSON.parse(value);
                            } catch (e) {
                                console.warn(`[VariableManager] JSONè§£æå¤±è´¥: ${key}`, e);
                                processedValue = value;
                            }
                        }
                    }

                    variables[key] = {
                        type: detectedType,
                        value: processedValue,
                        scope: 'global',
                        source: 'sillytavern',
                        created: new Date().toISOString()
                    };
                });

                return variables;
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                return await this.configManager.getConfig('globalVariables') || {};
            }
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½å…¨å±€å˜é‡å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * åŠ è½½èŠå¤©å˜é‡
     */
    async loadChatVariables() {
        try {
            // å°è¯•ä»SillyTavernè·å–èŠå¤©å˜é‡
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                const chatMetadata = context.chatMetadata || {};

                // ä»èŠå¤©å…ƒæ•°æ®ä¸­è·å–å˜é‡
                const chatVars = chatMetadata.variables || {};

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                const variables = {};
                Object.entries(chatVars).forEach(([key, value]) => {
                    const detectedType = this.detectVariableType(value);
                    let processedValue = value;

                    // å¦‚æœæ£€æµ‹åˆ°æ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æä¸ºå¯¹è±¡
                    if (detectedType === 'object' || detectedType === 'array') {
                        if (typeof value === 'string' && this.isJsonString(value)) {
                            try {
                                processedValue = JSON.parse(value);
                            } catch (e) {
                                console.warn(`[VariableManager] JSONè§£æå¤±è´¥: ${key}`, e);
                                processedValue = value;
                            }
                        }
                    }

                    variables[key] = {
                        type: detectedType,
                        value: processedValue,
                        scope: 'chat',
                        source: 'sillytavern',
                        created: new Date().toISOString()
                    };
                });

                return variables;
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                return await this.configManager.getConfig('chatVariables') || {};
            }
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½èŠå¤©å˜é‡å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ£€æµ‹å˜é‡ç±»å‹
     */
    detectVariableType(value) {
        if (value === null || value === undefined) {
            return 'null';
        }

        if (typeof value === 'string') {
            // å°è¯•æ£€æµ‹JSONå­—ç¬¦ä¸²
            if (this.isJsonString(value)) {
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed)) {
                        return 'array';
                    } else if (typeof parsed === 'object' && parsed !== null) {
                        return 'object';
                    }
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œä»ç„¶æ˜¯å­—ç¬¦ä¸²
                }
            }
            return 'string';
        }

        if (typeof value === 'number') {
            return 'number';
        }

        if (typeof value === 'boolean') {
            return 'boolean';
        }

        if (Array.isArray(value)) {
            return 'array';
        }

        if (typeof value === 'object') {
            return 'object';
        }

        if (typeof value === 'function') {
            return 'function';
        }

        return 'unknown';
    }

    /**
     * æ£€æµ‹æ˜¯å¦ä¸ºJSONå­—ç¬¦ä¸²
     */
    isJsonString(str) {
        if (typeof str !== 'string') {
            return false;
        }

        // ç®€å•çš„JSONæ ¼å¼æ£€æµ‹
        const trimmed = str.trim();
        return (trimmed.startsWith('{') && trimmed.endsWith('}')) ||
               (trimmed.startsWith('[') && trimmed.endsWith(']'));
    }

    /**
     * æ¸²æŸ“å˜é‡åˆ—è¡¨
     */
    renderVariableList() {
        const listContainer = document.querySelector('#variable-list');
        if (!listContainer) return;

        const variables = this.variables || {};
        const variableCount = Object.keys(variables).length;

        // æ›´æ–°å˜é‡æ•°é‡æ˜¾ç¤º
        const countElement = document.querySelector('#variable-count');
        if (countElement) {
            countElement.textContent = variableCount;
        }

        if (variableCount === 0) {
            listContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-code fa-3x"></i>
                    <h3>æš‚æ— å˜é‡</h3>
                    <p>ç‚¹å‡»"æ·»åŠ å˜é‡"å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå˜é‡</p>
                </div>
            `;
            return;
        }

        // æ ¹æ®è§†å›¾æ¨¡å¼æ¸²æŸ“
        if (this.currentViewMode === 'tree') {
            this.renderTreeView(listContainer, variables);
        } else {
            this.renderListView(listContainer, variables);
        }
    }

    /**
     * æ¸²æŸ“åˆ—è¡¨è§†å›¾
     */
    renderListView(container, variables) {
        const variableItems = Object.entries(variables).map(([key, variable]) => {
            return this.createVariableItem(key, variable);
        }).join('');

        container.innerHTML = variableItems;
        container.className = 'variable-list list-view';

        // æ¸²æŸ“åå†æ¬¡åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜ï¼Œç¡®ä¿åŠ¨æ€èŠ‚ç‚¹ç»§æ‰¿
        try {
            const activeThemeCard = this.modal?.querySelector('.theme-preview-card.active');
            const themeId = activeThemeCard?.getAttribute('data-theme');
            const theme = themeId ? this.getThemeById(themeId) : null;
            if (theme) this.applyVariableManagerTheme(theme);
        } catch (e) {
            console.warn('[InfoBarSettings] âš ï¸ æ¸²æŸ“ååº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜å¤±è´¥:', e);
        }
    }

    /**
     * æ¸²æŸ“æ ‘çŠ¶è§†å›¾
     */
    renderTreeView(container, variables) {
        // æŒ‰ç±»å‹åˆ†ç»„å˜é‡
        const groupedVariables = this.groupVariablesByType(variables);

        let treeHTML = '';
        Object.entries(groupedVariables).forEach(([type, vars]) => {
            if (vars.length === 0) return;

            treeHTML += `
                <div class="tree-group">
                    <div class="tree-group-header" data-type="${type}">
                        <i class="fa fa-chevron-down tree-toggle"></i>
                        <i class="fa ${this.getTypeIcon(type)} type-icon"></i>
                        <span class="group-title">${this.getTypeDisplayName(type)}</span>
                        <span class="group-count">(${vars.length})</span>
                    </div>
                    <div class="tree-group-content">
                        ${vars.map(([key, variable]) => this.createTreeVariableItem(key, variable)).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = treeHTML;
        container.className = 'variable-list tree-view';

        // ç»‘å®šæŠ˜å /å±•å¼€äº‹ä»¶
        this.bindTreeEvents(container);
    }

    /**
     * æŒ‰ç±»å‹åˆ†ç»„å˜é‡
     */
    groupVariablesByType(variables) {
        const groups = {
            string: [],
            number: [],
            boolean: [],
            array: [],
            object: [],
            function: [],
            null: [],
            unknown: []
        };

        Object.entries(variables).forEach(([key, variable]) => {
            const type = variable.type || 'unknown';
            if (groups[type]) {
                groups[type].push([key, variable]);
            } else {
                groups.unknown.push([key, variable]);
            }
        });

        return groups;
    }

    /**
     * è·å–ç±»å‹å›¾æ ‡
     */
    getTypeIcon(type) {
        const icons = {
            string: 'fa-quote-left',
            number: 'fa-calculator',
            boolean: 'fa-toggle-on',
            array: 'fa-list-ol',
            object: 'fa-cube',
            function: 'fa-code',
            null: 'fa-circle-o',
            unknown: 'fa-question'
        };
        return icons[type] || 'fa-question';
    }

    /**
     * è·å–ç±»å‹æ˜¾ç¤ºåç§°
     */
    getTypeDisplayName(type) {
        const names = {
            string: 'å­—ç¬¦ä¸²',
            number: 'æ•°å­—',
            boolean: 'å¸ƒå°”å€¼',
            array: 'æ•°ç»„',
            object: 'å¯¹è±¡',
            function: 'å‡½æ•°',
            null: 'ç©ºå€¼',
            unknown: 'æœªçŸ¥ç±»å‹'
        };
        return names[type] || 'æœªçŸ¥ç±»å‹';
    }

    /**
     * åˆ›å»ºæ ‘çŠ¶å˜é‡é¡¹
     */
    createTreeVariableItem(key, variable) {
        const value = variable.value || '';
        const description = variable.description || '';

        return `
            <div class="tree-variable-item" data-variable-id="${key}">
                <div class="tree-variable-header">
                    <div class="tree-variable-info">
                        <span class="tree-variable-name">${key}</span>
                        ${variable.scope ? `<span class="variable-scope ${variable.scope}">${variable.scope === 'global' ? 'å…¨å±€' : 'å±€éƒ¨'}</span>` : ''}
                    </div>
                    <div class="tree-variable-actions">
                        <button class="btn-icon" data-action="edit-variable" title="ç¼–è¾‘">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" data-action="delete-variable" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="tree-variable-content">
                    <div class="tree-variable-value">${this.formatVariableValue(value, variable.type)}</div>
                    ${description ? `<div class="tree-variable-description">${description}</div>` : ''}
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šæ ‘çŠ¶è§†å›¾äº‹ä»¶
     */
    bindTreeEvents(container) {
        container.addEventListener('click', (e) => {
            const groupHeader = e.target.closest('.tree-group-header');
            if (groupHeader) {
                const groupContent = groupHeader.nextElementSibling;
                const toggle = groupHeader.querySelector('.tree-toggle');

                if (groupContent.style.display === 'none') {
                    groupContent.style.display = 'block';
                    toggle.className = 'fa fa-chevron-down tree-toggle';
                } else {
                    groupContent.style.display = 'none';
                    toggle.className = 'fa fa-chevron-right tree-toggle';
                }
            }
        });
    }

    /**
     * åˆ›å»ºå˜é‡é¡¹HTML
     */
    createVariableItem(key, variable) {
        const type = variable.type || 'string';
        const value = variable.value || '';
        const description = variable.description || '';
        const isGlobal = variable.global || false;

        // ä¸ºæ•°ç»„å’Œå¯¹è±¡ç±»å‹æ·»åŠ ç‰¹æ®Šæ“ä½œæŒ‰é’®
        let specialActions = '';
        if (type === 'array') {
            specialActions = `
                <button class="btn-icon btn-special" data-action="add-array-item" data-variable-id="${key}" title="æ·»åŠ æ•°ç»„é¡¹">
                    <i class="fa fa-plus"></i>
                </button>
            `;
        } else if (type === 'object') {
            specialActions = `
                <button class="btn-icon btn-special" data-action="add-object-property" data-variable-id="${key}" title="æ·»åŠ å±æ€§">
                    <i class="fa fa-plus"></i>
                </button>
            `;
        }

        return `
            <div class="variable-item" data-variable-id="${key}" data-variable-type="${type}">
                <div class="variable-header">
                    <div class="variable-info">
                        <span class="variable-name">${key}</span>
                        <span class="variable-type ${type}">${type}</span>
                        ${isGlobal ? '<span class="variable-scope global">å…¨å±€</span>' : '<span class="variable-scope local">å±€éƒ¨</span>'}
                        ${specialActions}
                    </div>
                    <div class="variable-actions">
                        <button class="btn-icon" data-action="edit-variable" title="ç¼–è¾‘">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" data-action="delete-variable" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="variable-content">
                    <div class="variable-value">${this.formatVariableValue(value, type)}</div>
                    ${description ? `<div class="variable-description">${description}</div>` : ''}
                    ${this.createVariableContentActions(key, type, value)}
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå˜é‡å†…å®¹æ“ä½œåŒºåŸŸ
     */
    createVariableContentActions(key, type, value) {
        if (type === 'array' && Array.isArray(value)) {
            return `
                <div class="variable-content-actions">
                    <div class="array-items">
                        ${value.map((item, index) => this.createArrayItemElement(key, item, index)).join('')}
                    </div>
                    <button class="btn-add-item" data-action="add-array-item" data-variable-id="${key}">
                        <i class="fa fa-plus"></i> æ·»åŠ é¡¹
                    </button>
                </div>
            `;
        } else if (type === 'object' && typeof value === 'object' && value !== null) {
            return `
                <div class="variable-content-actions">
                    <div class="object-properties">
                        ${Object.entries(value).map(([propKey, propValue]) =>
                            this.createObjectPropertyElement(key, propKey, propValue, 0)
                        ).join('')}
                    </div>
                    <button class="btn-add-item" data-action="add-object-property" data-variable-id="${key}">
                        <i class="fa fa-plus"></i> æ·»åŠ å±æ€§
                    </button>
                </div>
            `;
        }
        return '';
    }

    /**
     * åˆ›å»ºæ•°ç»„é¡¹å…ƒç´ 
     */
    createArrayItemElement(variableId, item, index, level = 0) {
        let content = '';

        if (Array.isArray(item)) {
            content = `
                <div class="array-item nested-array" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-type-indicator">[æ•°ç»„:${item.length}é¡¹]</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-array-item" data-variable-id="${variableId}" data-path="${index}" title="æ·»åŠ å­é¡¹">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-array" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘æ•°ç»„">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-array-item" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${item.map((subItem, subIndex) =>
                        this.createArrayItemElement(variableId, subItem, subIndex, level + 1)
                    ).join('')}
                </div>
            `;
        } else if (typeof item === 'object' && item !== null) {
            content = `
                <div class="array-item nested-object" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-type-indicator">{å¯¹è±¡:${Object.keys(item).length}é”®}</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-object-property" data-variable-id="${variableId}" data-path="${index}" title="æ·»åŠ å±æ€§">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-object" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘å¯¹è±¡">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-array-item" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${Object.entries(item).map(([propKey, propValue]) =>
                        this.createObjectPropertyElement(variableId, propKey, propValue, level + 1, `${index}.${propKey}`)
                    ).join('')}
                </div>
            `;
        } else {
            content = `
                <div class="array-item" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-value">${this.formatArrayItemValue(item)}</span>
                    <button class="btn-icon-small btn-primary" data-action="edit-array-item" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘é¡¹">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="${level > 0 ? 'remove-nested-array-item' : 'remove-array-item'}" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
        }

        return content;
    }

    /**
     * åˆ›å»ºå¯¹è±¡å±æ€§å…ƒç´ 
     */
    createObjectPropertyElement(variableId, propKey, propValue, level = 0, path = '') {
        const fullPath = path ? `${path}` : propKey;
        let content = '';

        if (Array.isArray(propValue)) {
            content = `
                <div class="object-property nested-array" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-type-indicator">[æ•°ç»„:${propValue.length}é¡¹]</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-array-item" data-variable-id="${variableId}" data-path="${fullPath}" title="æ·»åŠ å­é¡¹">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-property-array" data-variable-id="${variableId}" data-key="${propKey}" data-path="${fullPath}" data-level="${level}" title="ç¼–è¾‘æ•°ç»„">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-object-property" data-key="${propKey}" data-variable-id="${variableId}" data-path="${fullPath}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${propValue.map((item, index) =>
                        this.createArrayItemElement(variableId, item, index, level + 1)
                    ).join('')}
                </div>
            `;
        } else if (typeof propValue === 'object' && propValue !== null) {
            content = `
                <div class="object-property nested-object" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-type-indicator">{å¯¹è±¡:${Object.keys(propValue).length}é”®}</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-object-property" data-variable-id="${variableId}" data-path="${fullPath}" title="æ·»åŠ å±æ€§">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-property-object" data-variable-id="${variableId}" data-key="${propKey}" data-path="${fullPath}" data-level="${level}" title="ç¼–è¾‘å¯¹è±¡">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-object-property" data-key="${propKey}" data-variable-id="${variableId}" data-path="${fullPath}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${Object.entries(propValue).map(([subKey, subValue]) =>
                        this.createObjectPropertyElement(variableId, subKey, subValue, level + 1, `${fullPath}.${subKey}`)
                    ).join('')}
                </div>
            `;
        } else {
            content = `
                <div class="object-property" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-value">${this.formatArrayItemValue(propValue)}</span>
                    <button class="btn-icon-small btn-primary" data-action="edit-object-property" data-variable-id="${variableId}" data-key="${propKey}" data-path="${path}" data-level="${level}" title="ç¼–è¾‘å±æ€§">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="${level > 0 ? 'remove-nested-object-property' : 'remove-object-property'}" data-key="${propKey}" data-variable-id="${variableId}" data-path="${path}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
        }

        return content;
    }

    /**
     * æ ¼å¼åŒ–æ•°ç»„é¡¹å€¼
     */
    formatArrayItemValue(value) {
        if (value === null || value === undefined) {
            return '<span class="null-value">null</span>';
        }
        if (typeof value === 'string') {
            return `"${value}"`;
        }
        if (typeof value === 'object') {
            return Array.isArray(value) ? `[æ•°ç»„:${value.length}é¡¹]` : `{å¯¹è±¡:${Object.keys(value).length}é”®}`;
        }
        return String(value);
    }

    /**
     * æ ¼å¼åŒ–å˜é‡å€¼æ˜¾ç¤º
     */
    formatVariableValue(value, type) {
        if (value === null || value === undefined) {
            return '<span class="null-value">null</span>';
        }

        switch (type) {
            case 'string':
                return `"${value}"`;
            case 'number':
                return value.toString();
            case 'boolean':
                return value ? 'true' : 'false';
            case 'array':
                return Array.isArray(value) ? `[${value.length} é¡¹]` : '[]';
            case 'object':
                return typeof value === 'object' ? `{${Object.keys(value).length} é”®}` : '{}';
            case 'function':
                return '<span class="function-value">function</span>';
            default:
                return value.toString();
        }
    }

    /**
     * æ·»åŠ æ–°å˜é‡
     */
    addNewVariable() {
        this.showVariableEditDialog();
    }

    /**
     * æ˜¾ç¤ºå˜é‡ç¼–è¾‘å¯¹è¯æ¡†
     */
    showVariableEditDialog(existingVariable = null, variableKey = null) {
        const isEdit = !!existingVariable;
        const typeSelect = document.querySelector('#variable-type-select');
        const selectedType = typeSelect ? typeSelect.value : 'string';

        // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'variable-edit-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.variable-edit-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘å˜é‡' : 'æ·»åŠ å˜é‡'}</h3>
                    <button class="dialog-close" onclick="this.closest('.variable-edit-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å˜é‡å</label>
                        <input type="text" id="variable-name" value="${existingVariable?.name || variableKey || ''}" ${isEdit ? 'readonly' : ''}>
                    </div>
                    <div class="form-group">
                        <label>å˜é‡ç±»å‹</label>
                        <select id="variable-type" ${isEdit ? 'disabled' : ''}>
                            <option value="string" ${(existingVariable?.type || selectedType) === 'string' ? 'selected' : ''}>å­—ç¬¦ä¸²</option>
                            <option value="number" ${(existingVariable?.type || selectedType) === 'number' ? 'selected' : ''}>æ•°å­—</option>
                            <option value="boolean" ${(existingVariable?.type || selectedType) === 'boolean' ? 'selected' : ''}>å¸ƒå°”å€¼</option>
                            <option value="array" ${(existingVariable?.type || selectedType) === 'array' ? 'selected' : ''}>æ•°ç»„</option>
                            <option value="object" ${(existingVariable?.type || selectedType) === 'object' ? 'selected' : ''}>å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å˜é‡å€¼</label>
                        <textarea id="variable-value" rows="4" placeholder="è¯·è¾“å…¥å˜é‡å€¼...">${this.formatValueForEdit(existingVariable?.value, existingVariable?.type)}</textarea>
                        <div class="value-hint" id="value-hint">
                            ${this.getValueHint(existingVariable?.type || selectedType)}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ä½œç”¨åŸŸ</label>
                        <div class="scope-info">
                            <i class="fa ${this.currentVariableScope === 'global' ? 'fa-globe' : 'fa-comments'}"></i>
                            ${this.currentVariableScope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡'}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.variable-edit-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-variable-dialog" data-is-edit="${isEdit}" data-variable-key="${variableKey || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶ - ä½¿ç”¨ç®­å¤´å‡½æ•°ä¿æŒthisä¸Šä¸‹æ–‡
        const self = this;
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-variable-dialog') {
                const isEdit = actionElement.dataset.isEdit === 'true';
                const variableKey = actionElement.dataset.variableKey || '';
                console.log('[VariableManager] ğŸ”˜ å¯¹è¯æ¡†ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»');
                self.saveVariableFromDialog(actionElement, isEdit, variableKey);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#variable-type');
        const valueHint = dialog.querySelector('#value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#variable-name');
            if (nameInput && !isEdit) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * æ ¼å¼åŒ–å€¼ç”¨äºç¼–è¾‘
     */
    formatValueForEdit(value, type) {
        if (value === null || value === undefined) {
            return '';
        }

        if (type === 'array' || type === 'object') {
            try {
                return JSON.stringify(value, null, 2);
            } catch (e) {
                return String(value);
            }
        }

        return String(value);
    }

    /**
     * è·å–å€¼æç¤º
     */
    getValueHint(type) {
        switch (type) {
            case 'string':
                return 'è¾“å…¥æ–‡æœ¬å†…å®¹ï¼Œä¾‹å¦‚ï¼šHello World';
            case 'number':
                return 'è¾“å…¥æ•°å­—ï¼Œä¾‹å¦‚ï¼š42 æˆ– 3.14';
            case 'boolean':
                return 'è¾“å…¥ true æˆ– false';
            case 'array':
                return 'è¾“å…¥JSONæ•°ç»„ï¼Œä¾‹å¦‚ï¼š["item1", "item2", "item3"]';
            case 'object':
                return 'è¾“å…¥JSONå¯¹è±¡ï¼Œä¾‹å¦‚ï¼š{"key1": "value1", "key2": "value2"}';
            default:
                return '';
        }
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜å˜é‡
     */
    async saveVariableFromDialog(button, isEdit, existingKey) {
        try {
            const dialog = button.closest('.variable-edit-dialog');
            const name = dialog.querySelector('#variable-name').value.trim();
            const type = dialog.querySelector('#variable-type').value;
            const valueText = dialog.querySelector('#variable-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å˜é‡å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å˜é‡å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜å˜é‡
            await this.saveVariableToSillyTavern(name, value, type, isEdit, existingKey);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.loadVariables();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'å˜é‡:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            alert('ä¿å­˜å˜é‡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * è§£æå˜é‡å€¼
     */
    parseVariableValue(valueText, type) {
        if (!valueText) {
            switch (type) {
                case 'string': return '';
                case 'number': return 0;
                case 'boolean': return false;
                case 'array': return [];
                case 'object': return {};
                default: return '';
            }
        }

        switch (type) {
            case 'string':
                return valueText;
            case 'number':
                const num = Number(valueText);
                if (isNaN(num)) {
                    throw new Error('æ— æ•ˆçš„æ•°å­—æ ¼å¼');
                }
                return num;
            case 'boolean':
                const lower = valueText.toLowerCase();
                if (lower === 'true') return true;
                if (lower === 'false') return false;
                throw new Error('å¸ƒå°”å€¼å¿…é¡»æ˜¯ true æˆ– false');
            case 'array':
            case 'object':
                try {
                    const parsed = JSON.parse(valueText);
                    if (type === 'array' && !Array.isArray(parsed)) {
                        throw new Error('å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„');
                    }
                    if (type === 'object' && (Array.isArray(parsed) || typeof parsed !== 'object')) {
                        throw new Error('å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡');
                    }
                    return parsed;
                } catch (e) {
                    throw new Error('æ— æ•ˆçš„JSONæ ¼å¼: ' + e.message);
                }
            default:
                return valueText;
        }
    }

    /**
     * ä¿å­˜å˜é‡åˆ°SillyTavern
     */
    async saveVariableToSillyTavern(name, value, type, isEdit, existingKey) {
        try {
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();

                if (this.currentVariableScope === 'global') {
                    // ä¿å­˜å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    if (!extensionSettings.variables) {
                        extensionSettings.variables = {};
                    }

                    // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
                    if (isEdit && existingKey && existingKey !== name) {
                        delete extensionSettings.variables[existingKey];
                    }

                    extensionSettings.variables[name] = value;

                    // ä¿å­˜è®¾ç½®
                    if (context.saveSettingsDebounced) {
                        context.saveSettingsDebounced();
                    }
                } else {
                    // ä¿å­˜èŠå¤©å˜é‡
                    const chatMetadata = context.chatMetadata || {};
                    if (!chatMetadata.variables) {
                        chatMetadata.variables = {};
                    }

                    // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
                    if (isEdit && existingKey && existingKey !== name) {
                        delete chatMetadata.variables[existingKey];
                    }

                    chatMetadata.variables[name] = value;

                    // ä¿å­˜å…ƒæ•°æ®
                    if (context.saveMetadata) {
                        await context.saveMetadata();
                    }
                }

                console.log('[VariableManager] âœ… å˜é‡å·²ä¿å­˜åˆ°SillyTavern:', name);
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                const configKey = this.currentVariableScope === 'global' ? 'globalVariables' : 'chatVariables';
                const variables = await this.configManager.getConfig(configKey) || {};

                if (isEdit && existingKey && existingKey !== name) {
                    delete variables[existingKey];
                }

                variables[name] = {
                    type: type,
                    value: value,
                    scope: this.currentVariableScope,
                    created: new Date().toISOString()
                };

                await this.configManager.setConfig(configKey, variables);
                console.log('[VariableManager] âœ… å˜é‡å·²ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨:', name);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä¿å­˜å˜é‡
     */
    async saveVariables() {
        try {
            await this.configManager.setConfig('variables', this.variables || {});
            this.showMessage('å˜é‡ä¿å­˜æˆåŠŸ', 'success');
            console.log('[VariableManager] âœ… å˜é‡ä¿å­˜æˆåŠŸ');
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            this.showMessage('ä¿å­˜å˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡ï¼ˆå…¨å±€/èŠå¤©ï¼‰
     */
    async clearCurrentScopeVariables() {
        try {
            const scope = this.currentVariableScope || 'global';
            const confirmed = confirm(`ç¡®å®šè¦æ¸…ç©º${scope === 'global' ? 'ã€å…¨å±€å˜é‡ã€‘' : 'ã€èŠå¤©å˜é‡ã€‘'}å†…çš„æ‰€æœ‰å˜é‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (!confirmed) return;

            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                if (scope === 'global') {
                    // æ¸…ç©ºæ‰©å±•è®¾ç½®ä¸­çš„å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    extensionSettings.variables = {};
                    await context.saveSettingsDebounced?.();
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºå…¨å±€å˜é‡');
                } else {
                    // æ¸…ç©ºå½“å‰èŠå¤©çš„å˜é‡ï¼ˆä¿å­˜åœ¨configManagerä¸­ï¼‰
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºèŠå¤©å˜é‡:', configKey);
                }
            } else {
                // å…œåº•ï¼šä»…æ¸…ç©ºå†…å­˜å˜é‡å¹¶ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨
                if (scope === 'global') {
                    await this.configManager.setConfig('variables', {});
                } else {
                    const context = (window.SillyTavern && window.SillyTavern.getContext) ? window.SillyTavern.getContext() : null;
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                }
            }

            // åˆ·æ–°å†…å­˜ä¸UI
            this.variables = {};
            this.renderVariableList();
            this.showMessage('å˜é‡å·²æ¸…ç©º', 'success');
        } catch (error) {
            console.error('[VariableManager] âŒ æ¸…ç©ºå˜é‡å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }
    /**
     * æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡ï¼ˆå…¨å±€/èŠå¤©ï¼‰
     */
    async clearCurrentScopeVariables() {
        try {
            const scope = this.currentVariableScope || 'global';
            const confirmed = confirm(`ç¡®å®šè¦æ¸…ç©º${scope === 'global' ? 'ã€å…¨å±€å˜é‡ã€‘' : 'ã€èŠå¤©å˜é‡ã€‘'}å†…çš„æ‰€æœ‰å˜é‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (!confirmed) return;

            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                if (scope === 'global') {
                    // æ¸…ç©ºæ‰©å±•è®¾ç½®ä¸­çš„å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    extensionSettings.variables = {};
                    await context.saveSettingsDebounced?.();
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºå…¨å±€å˜é‡');
                } else {
                    // æ¸…ç©ºå½“å‰èŠå¤©çš„å˜é‡ï¼ˆä¿å­˜åœ¨configManagerä¸­ï¼‰
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºèŠå¤©å˜é‡:', configKey);
                }
            } else {
                // å…œåº•ï¼šä»…æ¸…ç©ºå†…å­˜å˜é‡å¹¶ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨
                if (scope === 'global') {
                    await this.configManager.setConfig('variables', {});
                } else {
                    const context = (window.SillyTavern && window.SillyTavern.getContext) ? window.SillyTavern.getContext() : null;
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                }
            }

            // åˆ·æ–°å†…å­˜ä¸UI
            this.variables = {};
            this.renderVariableList();
            this.showMessage('å˜é‡å·²æ¸…ç©º', 'success');
        } catch (error) {
            console.error('[VariableManager] âŒ æ¸…ç©ºå˜é‡å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * è¿‡æ»¤å˜é‡
     */
    filterVariables(searchTerm) {
        const variableItems = document.querySelectorAll('.variable-item');
        const term = searchTerm.toLowerCase();

        variableItems.forEach(item => {
            const name = item.querySelector('.variable-name').textContent.toLowerCase();
            const description = item.querySelector('.variable-description')?.textContent?.toLowerCase() || '';

            if (name.includes(term) || description.includes(term)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    /**
     * ç¼–è¾‘å˜é‡
     */
    editVariable(variableId) {
        const variable = this.variables[variableId];
        if (!variable) return;

        // æ˜¾ç¤ºç¼–è¾‘å¯¹è¯æ¡†
        this.showVariableEditDialog(variable, variableId);
    }

    /**
     * åˆ é™¤å˜é‡
     */
    async deleteVariable(variableId) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å˜é‡ "${variableId}" å—ï¼Ÿ`)) return;

        try {
            // ä»SillyTavernåˆ é™¤å˜é‡
            await this.deleteVariableFromSillyTavern(variableId);

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.loadVariables();

            console.log('[VariableManager] âœ… åˆ é™¤å˜é‡:', variableId);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤å˜é‡å¤±è´¥:', error);
            alert('åˆ é™¤å˜é‡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä»SillyTavernåˆ é™¤å˜é‡
     */
    async deleteVariableFromSillyTavern(variableId) {
        try {
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();

                if (this.currentVariableScope === 'global') {
                    // åˆ é™¤å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    if (extensionSettings.variables) {
                        delete extensionSettings.variables[variableId];

                        // ä¿å­˜è®¾ç½®
                        if (context.saveSettingsDebounced) {
                            context.saveSettingsDebounced();
                        }
                    }
                } else {
                    // åˆ é™¤èŠå¤©å˜é‡
                    const chatMetadata = context.chatMetadata || {};
                    if (chatMetadata.variables) {
                        delete chatMetadata.variables[variableId];

                        // ä¿å­˜å…ƒæ•°æ®
                        if (context.saveMetadata) {
                            await context.saveMetadata();
                        }
                    }
                }
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                const configKey = this.currentVariableScope === 'global' ? 'globalVariables' : 'chatVariables';
                const variables = await this.configManager.getConfig(configKey) || {};
                delete variables[variableId];
                await this.configManager.setConfig(configKey, variables);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ ä»SillyTavernåˆ é™¤å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¯¼å‡ºå˜é‡
     */
    exportVariables() {
        try {
            const data = {
                variables: this.variables || {},
                exported: new Date().toISOString(),
                version: '1.0.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `variables_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage('å˜é‡å¯¼å‡ºæˆåŠŸ', 'success');
            console.log('[VariableManager] âœ… å˜é‡å¯¼å‡ºæˆåŠŸ');
        } catch (error) {
            console.error('[VariableManager] âŒ å¯¼å‡ºå˜é‡å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å…¥å˜é‡
     */
    importVariables() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = async (e) => {
            try {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                const data = JSON.parse(text);

                if (data.variables) {
                    // åˆå¹¶å˜é‡ï¼ˆå¯ä»¥é€‰æ‹©è¦†ç›–æˆ–è·³è¿‡é‡å¤ï¼‰
                    const shouldOverwrite = confirm('æ˜¯å¦è¦†ç›–åŒåå˜é‡ï¼Ÿç‚¹å‡»"ç¡®å®š"è¦†ç›–ï¼Œ"å–æ¶ˆ"è·³è¿‡ã€‚');

                    Object.entries(data.variables).forEach(([key, variable]) => {
                        if (!this.variables[key] || shouldOverwrite) {
                            this.variables[key] = variable;
                        }
                    });

                    this.renderVariableList();
                    this.showMessage('å˜é‡å¯¼å…¥æˆåŠŸ', 'success');
                    console.log('[VariableManager] âœ… å˜é‡å¯¼å…¥æˆåŠŸ');
                } else {
                    throw new Error('æ— æ•ˆçš„å˜é‡æ–‡ä»¶æ ¼å¼');
                }
            } catch (error) {
                console.error('[VariableManager] âŒ å¯¼å…¥å˜é‡å¤±è´¥:', error);
                this.showMessage('å¯¼å…¥å˜é‡å¤±è´¥: ' + error.message, 'error');
            }
        };

        input.click();
    }

    /**
     * æ·»åŠ æ•°ç»„é¡¹
     */
    async addArrayItem(variableId) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            // æ˜¾ç¤ºç®€åŒ–çš„æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
            this.showArrayItemDialog(variableId);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('æ·»åŠ æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºæ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showArrayItemDialog(variableId, existingIndex = null, existingValue = null) {
        const isEdit = existingIndex !== null;

        // åˆ›å»ºç®€åŒ–çš„æ•°ç»„é¡¹å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘æ•°ç»„é¡¹' : 'æ·»åŠ æ•°ç»„é¡¹'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>æ•°ç»„é¡¹å€¼</label>
                        <textarea id="array-item-value" rows="3" placeholder="è¯·è¾“å…¥æ•°ç»„é¡¹å€¼...">${existingValue || ''}</textarea>
                        <div class="value-hint">
                            æ”¯æŒæ–‡æœ¬ã€æ•°å­—ã€JSONå¯¹è±¡ç­‰æ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±æ•°ç»„</label>
                        <div class="scope-info">
                            <i class="fa fa-list"></i>
                            ${variableId}${isEdit ? ` [${existingIndex}]` : ''}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-array-item" data-variable-id="${variableId}" data-is-edit="${isEdit}" data-index="${existingIndex || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-array-item') {
                const variableId = actionElement.dataset.variableId;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const index = actionElement.dataset.index || null;
                this.saveArrayItemFromDialog(actionElement, variableId, isEdit, index);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#array-item-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜æ•°ç»„é¡¹
     */
    async saveArrayItemFromDialog(button, variableId, isEdit, index) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const valueText = dialog.querySelector('#array-item-value').value.trim();

            if (!valueText) {
                alert('è¯·è¾“å…¥æ•°ç»„é¡¹å€¼');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥åˆ™ä½œä¸ºå­—ç¬¦ä¸²
                value = JSON.parse(valueText);
            } catch (e) {
                value = valueText;
            }

            // ä¿å­˜æ•°ç»„é¡¹
            await this.saveArrayItemToVariable(variableId, value, isEdit, index);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'æ•°ç»„é¡¹:', value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ä¿å­˜æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜æ•°ç»„é¡¹åˆ°å˜é‡
     */
    async saveArrayItemToVariable(variableId, value, isEdit, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array') {
                throw new Error('å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹');
            }

            // ç¡®ä¿å˜é‡å€¼æ˜¯æ•°ç»„
            if (!Array.isArray(variable.value)) {
                variable.value = [];
            }

            if (isEdit && index !== null) {
                // ç¼–è¾‘ç°æœ‰é¡¹
                variable.value[parseInt(index)] = value;
            } else {
                // æ·»åŠ æ–°é¡¹
                variable.value.push(value);
            }

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… æ•°ç»„é¡¹å·²ä¿å­˜:', variableId, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜æ•°ç»„é¡¹åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ é™¤æ•°ç»„é¡¹
     */
    async removeArrayItem(variableId, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array' || !Array.isArray(variable.value)) {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°ç»„é¡¹ [${index}] å—ï¼Ÿ`)) return;

            // åˆ é™¤æ•°ç»„é¡¹
            variable.value.splice(index, 1);

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤æ•°ç»„é¡¹:', variableId, index);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('åˆ é™¤æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ·»åŠ å¯¹è±¡å±æ€§
     */
    async addObjectProperty(variableId) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹:', variableId);
                return;
            }

            // æ˜¾ç¤ºæ·»åŠ å±æ€§å¯¹è¯æ¡†
            this.showObjectPropertyDialog(variableId);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('æ·»åŠ å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºå¯¹è±¡å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showObjectPropertyDialog(variableId, existingKey = null, existingProperty = null) {
        const isEdit = !!existingProperty;

        // åˆ›å»ºå±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'object-property-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.object-property-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘å±æ€§' : 'æ·»åŠ å±æ€§'}</h3>
                    <button class="dialog-close" onclick="this.closest('.object-property-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="property-name" value="${existingKey || ''}" ${isEdit ? 'readonly' : ''} placeholder="è¯·è¾“å…¥å±æ€§å">
                    </div>
                    <div class="form-group">
                        <label>å±æ€§ç±»å‹</label>
                        <select id="property-type">
                            <option value="string" ${(existingProperty?.type || 'string') === 'string' ? 'selected' : ''}>å­—ç¬¦ä¸²</option>
                            <option value="number" ${(existingProperty?.type || 'string') === 'number' ? 'selected' : ''}>æ•°å­—</option>
                            <option value="boolean" ${(existingProperty?.type || 'string') === 'boolean' ? 'selected' : ''}>å¸ƒå°”å€¼</option>
                            <option value="array" ${(existingProperty?.type || 'string') === 'array' ? 'selected' : ''}>æ•°ç»„</option>
                            <option value="object" ${(existingProperty?.type || 'string') === 'object' ? 'selected' : ''}>å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å±æ€§å€¼</label>
                        <textarea id="property-value" rows="4" placeholder="è¯·è¾“å…¥å±æ€§å€¼...">${this.formatValueForEdit(existingProperty?.value, existingProperty?.type)}</textarea>
                        <div class="value-hint" id="property-value-hint">
                            ${this.getValueHint(existingProperty?.type || 'string')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±å¯¹è±¡</label>
                        <div class="scope-info">
                            <i class="fa fa-cube"></i>
                            ${variableId}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.object-property-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-object-property" data-variable-id="${variableId}" data-is-edit="${isEdit}" data-existing-key="${existingKey || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-object-property') {
                const variableId = actionElement.dataset.variableId;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const existingKey = actionElement.dataset.existingKey || '';
                this.saveObjectPropertyFromDialog(actionElement, variableId, isEdit, existingKey);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#property-type');
        const valueHint = dialog.querySelector('#property-value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#property-name');
            if (nameInput && !isEdit) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜å¯¹è±¡å±æ€§
     */
    async saveObjectPropertyFromDialog(button, variableId, isEdit, existingKey) {
        try {
            const dialog = button.closest('.object-property-dialog');
            const name = dialog.querySelector('#property-name').value.trim();
            const type = dialog.querySelector('#property-type').value;
            const valueText = dialog.querySelector('#property-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å±æ€§å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜å±æ€§
            await this.saveObjectPropertyToVariable(variableId, name, value, isEdit, existingKey);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'å¯¹è±¡å±æ€§:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ä¿å­˜å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜å¯¹è±¡å±æ€§åˆ°å˜é‡
     */
    async saveObjectPropertyToVariable(variableId, propertyName, propertyValue, isEdit, existingKey) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object') {
                throw new Error('å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹');
            }

            // ç¡®ä¿å˜é‡å€¼æ˜¯å¯¹è±¡
            if (typeof variable.value !== 'object' || variable.value === null) {
                variable.value = {};
            }

            // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
            if (isEdit && existingKey && existingKey !== propertyName) {
                delete variable.value[existingKey];
            }

            // è®¾ç½®æ–°å€¼
            variable.value[propertyName] = propertyValue;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… å¯¹è±¡å±æ€§å·²ä¿å­˜:', variableId, propertyName, propertyValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å¯¹è±¡å±æ€§åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ é™¤å¯¹è±¡å±æ€§
     */
    async removeObjectProperty(variableId, propertyKey) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object' || typeof variable.value !== 'object') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹:', variableId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤å±æ€§ "${propertyKey}" å—ï¼Ÿ`)) return;

            // åˆ é™¤å±æ€§
            delete variable.value[propertyKey];

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤å¯¹è±¡å±æ€§:', variableId, propertyKey);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('åˆ é™¤å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ·»åŠ åµŒå¥—æ•°ç»„é¡¹
     */
    async addNestedArrayItem(variableId, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ˜¾ç¤ºåµŒå¥—æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
            this.showNestedArrayItemDialog(variableId, path);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('æ·»åŠ åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showNestedArrayItemDialog(variableId, path, existingIndex = null, existingValue = null) {
        const isEdit = existingIndex !== null;

        // åˆ›å»ºåµŒå¥—æ•°ç»„é¡¹å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹' : 'æ·»åŠ åµŒå¥—æ•°ç»„é¡¹'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>æ•°ç»„é¡¹å€¼</label>
                        <textarea id="array-item-value" rows="3" placeholder="è¯·è¾“å…¥æ•°ç»„é¡¹å€¼...">${existingValue || ''}</textarea>
                        <div class="value-hint">
                            æ”¯æŒæ–‡æœ¬ã€æ•°å­—ã€JSONå¯¹è±¡ç­‰æ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}${isEdit ? ` [${existingIndex}]` : ''}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-array-item" data-variable-id="${variableId}" data-path="${path}" data-is-edit="${isEdit}" data-index="${existingIndex || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-array-item') {
                const variableId = actionElement.dataset.variableId;
                const path = actionElement.dataset.path;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const index = actionElement.dataset.index || null;
                this.saveNestedArrayItemFromDialog(actionElement, variableId, path, isEdit, index);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#array-item-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—æ•°ç»„é¡¹
     */
    async saveNestedArrayItemFromDialog(button, variableId, path, isEdit, index) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const valueText = dialog.querySelector('#array-item-value').value.trim();

            if (!valueText) {
                alert('è¯·è¾“å…¥æ•°ç»„é¡¹å€¼');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                value = valueText;
            }

            // ä¿å­˜åµŒå¥—æ•°ç»„é¡¹
            await this.saveNestedArrayItemToVariable(variableId, path, value, isEdit, index);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'åµŒå¥—æ•°ç»„é¡¹:', value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜åµŒå¥—æ•°ç»„é¡¹åˆ°å˜é‡
     */
    async saveNestedArrayItemToVariable(variableId, path, value, isEdit, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–åµŒå¥—æ•°ç»„çš„å¼•ç”¨
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                throw new Error('ç›®æ ‡ä¸æ˜¯æ•°ç»„');
            }

            if (isEdit && index !== null) {
                // ç¼–è¾‘ç°æœ‰é¡¹
                targetArray[parseInt(index)] = value;
            } else {
                // æ·»åŠ æ–°é¡¹
                targetArray.push(value);
            }

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—æ•°ç»„é¡¹å·²ä¿å­˜:', variableId, path, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—æ•°ç»„é¡¹åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§
     */
    async addNestedObjectProperty(variableId, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ˜¾ç¤ºåµŒå¥—å±æ€§å¯¹è¯æ¡†
            this.showNestedObjectPropertyDialog(variableId, path);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—å¯¹è±¡å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showNestedObjectPropertyDialog(variableId, path) {
        // åˆ›å»ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'object-property-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.object-property-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>æ·»åŠ åµŒå¥—å±æ€§</h3>
                    <button class="dialog-close" onclick="this.closest('.object-property-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="property-name" placeholder="è¯·è¾“å…¥å±æ€§å">
                    </div>
                    <div class="form-group">
                        <label>å±æ€§ç±»å‹</label>
                        <select id="property-type">
                            <option value="string">å­—ç¬¦ä¸²</option>
                            <option value="number">æ•°å­—</option>
                            <option value="boolean">å¸ƒå°”å€¼</option>
                            <option value="array">æ•°ç»„</option>
                            <option value="object">å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å±æ€§å€¼</label>
                        <textarea id="property-value" rows="4" placeholder="è¯·è¾“å…¥å±æ€§å€¼..."></textarea>
                        <div class="value-hint" id="property-value-hint">
                            ${this.getValueHint('string')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.object-property-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-object-property" data-variable-id="${variableId}" data-path="${path}">æ·»åŠ </button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-object-property') {
                const variableId = actionElement.dataset.variableId;
                const path = actionElement.dataset.path;
                this.saveNestedObjectPropertyFromDialog(actionElement, variableId, path);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#property-type');
        const valueHint = dialog.querySelector('#property-value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#property-name');
            if (nameInput) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§
     */
    async saveNestedObjectPropertyFromDialog(button, variableId, path) {
        try {
            const dialog = button.closest('.object-property-dialog');
            const name = dialog.querySelector('#property-name').value.trim();
            const type = dialog.querySelector('#property-type').value;
            const valueText = dialog.querySelector('#property-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å±æ€§å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜åµŒå¥—å±æ€§
            await this.saveNestedObjectPropertyToVariable(variableId, path, name, value);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§åˆ°å˜é‡
     */
    async saveNestedObjectPropertyToVariable(variableId, path, propertyName, propertyValue) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–åµŒå¥—å¯¹è±¡çš„å¼•ç”¨
            const targetObject = this.getNestedValue(variable.value, path);
            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // è®¾ç½®æ–°å€¼
            targetObject[propertyName] = propertyValue;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—å¯¹è±¡å±æ€§å·²ä¿å­˜:', variableId, path, propertyName, propertyValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è·å–åµŒå¥—å€¼çš„å¼•ç”¨
     */
    getNestedValue(obj, path) {
        if (!path) return obj;

        const keys = path.split('.');
        let current = obj;

        for (const key of keys) {
            if (current === null || current === undefined) {
                return null;
            }

            // å¤„ç†æ•°ç»„ç´¢å¼•
            if (Array.isArray(current) && /^\d+$/.test(key)) {
                current = current[parseInt(key)];
            } else if (typeof current === 'object') {
                current = current[key];
            } else {
                return null;
            }
        }

        return current;
    }

    /**
     * åˆ é™¤åµŒå¥—æ•°ç»„é¡¹
     */
    async removeNestedArrayItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ åˆ é™¤åµŒå¥—æ•°ç»„é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            if (!confirm(`ç¡®å®šè¦åˆ é™¤åµŒå¥—æ•°ç»„é¡¹ [${index}] å—ï¼Ÿ\nè·¯å¾„: ${variableId}${path ? ' â†’ ' + path : ''}`)) return;

            // è·å–ç›®æ ‡æ•°ç»„
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯æ•°ç»„:', path);
                return;
            }

            // åˆ é™¤æ•°ç»„é¡¹
            targetArray.splice(parseInt(index), 1);

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤åµŒå¥—æ•°ç»„é¡¹:', variableId, path, index);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('åˆ é™¤åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§
     */
    async removeNestedObjectProperty(variableId, key, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§è·¯å¾„:', path, 'é”®:', key);

            if (!confirm(`ç¡®å®šè¦åˆ é™¤åµŒå¥—å±æ€§ "${key}" å—ï¼Ÿ\nè·¯å¾„: ${variableId}${path ? ' â†’ ' + path : ''}`)) return;

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            // åˆ é™¤å±æ€§
            delete targetObject[key];

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§:', variableId, path, key);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ„å»ºåµŒå¥—è·¯å¾„
     */
    buildNestedPath(element, level) {
        const pathParts = [];

        // å‘ä¸Šéå†æ‰¾åˆ°æ‰€æœ‰åµŒå¥—å±‚çº§
        let currentElement = element.closest('.array-item, .object-property');
        while (currentElement && level > 0) {
            const parent = currentElement.closest('.nested-items');
            if (parent) {
                const parentItem = parent.previousElementSibling;
                if (parentItem) {
                    if (parentItem.classList.contains('array-item')) {
                        const index = parentItem.dataset.index;
                        if (index !== undefined) {
                            pathParts.unshift(index);
                        }
                    } else if (parentItem.classList.contains('object-property')) {
                        const key = parentItem.dataset.key;
                        if (key !== undefined) {
                            pathParts.unshift(key);
                        }
                    }
                }
                currentElement = parentItem;
                level--;
            } else {
                break;
            }
        }

        return pathParts.join('.');
    }

    /**
     * è·å–çˆ¶è·¯å¾„
     */
    getParentPath(path) {
        if (!path) return '';
        const parts = path.split('.');
        parts.pop(); // ç§»é™¤æœ€åä¸€éƒ¨åˆ†
        return parts.join('.');
    }

    /**
     * ç¼–è¾‘æ•°ç»„é¡¹
     */
    editArrayItem(variableId, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array' || !Array.isArray(variable.value)) {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            const currentValue = variable.value[parseInt(index)];
            const formattedValue = typeof currentValue === 'string' ? currentValue : JSON.stringify(currentValue);

            this.showArrayItemDialog(variableId, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘å¯¹è±¡å±æ€§
     */
    editObjectProperty(variableId, key, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // è·å–å½“å‰å±æ€§å€¼
            let currentValue;
            if (path && path !== key) {
                // åµŒå¥—å±æ€§
                const parentPath = this.getParentPath(path);
                const parentObject = this.getNestedValue(variable.value, parentPath);
                currentValue = parentObject[key];
            } else {
                // é¡¶çº§å±æ€§
                currentValue = variable.value[key];
            }

            // ç¡®å®šå±æ€§ç±»å‹
            let propertyType = 'string';
            if (typeof currentValue === 'number') {
                propertyType = 'number';
            } else if (typeof currentValue === 'boolean') {
                propertyType = 'boolean';
            } else if (Array.isArray(currentValue)) {
                propertyType = 'array';
            } else if (typeof currentValue === 'object' && currentValue !== null) {
                propertyType = 'object';
            }

            const existingProperty = {
                type: propertyType,
                value: currentValue
            };

            this.showObjectPropertyDialog(variableId, key, existingProperty);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ç¼–è¾‘å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹
     */
    editNestedArrayItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            // è·å–ç›®æ ‡æ•°ç»„
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯æ•°ç»„:', path);
                return;
            }

            const currentValue = targetArray[parseInt(index)];
            const formattedValue = typeof currentValue === 'string' ? currentValue : JSON.stringify(currentValue);

            this.showNestedArrayItemDialog(variableId, path, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹
     */
    editNestedObjectItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            // è·å–ç›®æ ‡æ•°ç»„ï¼ˆå¯¹è±¡åœ¨æ•°ç»„ä¸­ï¼‰
            const parentPath = this.getParentPath(path);
            const targetArray = this.getNestedValue(variable.value, parentPath);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] çˆ¶çº§ä¸æ˜¯æ•°ç»„:', parentPath);
                return;
            }

            const currentValue = targetArray[parseInt(index)];
            if (typeof currentValue !== 'object' || currentValue === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', currentValue);
                return;
            }

            // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå¯¹è±¡ç¼–è¾‘å¯¹è¯æ¡†ï¼Œæš‚æ—¶ç”¨JSONç¼–è¾‘
            const formattedValue = JSON.stringify(currentValue, null, 2);
            this.showNestedArrayItemDialog(variableId, parentPath, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„
     */
    editNestedPropertyArray(variableId, key, path, level) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„:', path, 'é”®:', key);

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            const currentValue = targetObject[key];
            if (!Array.isArray(currentValue)) {
                console.error('[VariableManager] å±æ€§ä¸æ˜¯æ•°ç»„:', currentValue);
                return;
            }

            // æ˜¾ç¤ºæ•°ç»„ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆJSONæ ¼å¼ï¼‰
            const formattedValue = JSON.stringify(currentValue, null, 2);

            // åˆ›å»ºä¸´æ—¶çš„å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
            this.showNestedPropertyEditDialog(variableId, key, path, 'array', formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡
     */
    editNestedPropertyObject(variableId, key, path, level) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡:', path, 'é”®:', key);

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            const currentValue = targetObject[key];
            if (typeof currentValue !== 'object' || currentValue === null) {
                console.error('[VariableManager] å±æ€§ä¸æ˜¯å¯¹è±¡:', currentValue);
                return;
            }

            // æ˜¾ç¤ºå¯¹è±¡ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆJSONæ ¼å¼ï¼‰
            const formattedValue = JSON.stringify(currentValue, null, 2);

            // åˆ›å»ºä¸´æ—¶çš„å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
            this.showNestedPropertyEditDialog(variableId, key, path, 'object', formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showNestedPropertyEditDialog(variableId, key, path, type, currentValue) {
        // åˆ›å»ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>ç¼–è¾‘åµŒå¥—${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="nested-property-key" value="${key}" placeholder="è¯·è¾“å…¥å±æ€§å...">
                        <div class="value-hint">
                            ä¿®æ”¹å±æ€§åå°†é‡å‘½åè¯¥å±æ€§
                        </div>
                    </div>
                    <div class="form-group">
                        <label>${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}å†…å®¹ (JSONæ ¼å¼)</label>
                        <textarea id="nested-property-value" rows="6" placeholder="è¯·è¾“å…¥JSONæ ¼å¼çš„${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}...">${currentValue}</textarea>
                        <div class="value-hint">
                            è¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-property-edit" data-variable-id="${variableId}" data-key="${key}" data-path="${path}" data-type="${type}">ä¿å­˜</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-property-edit') {
                const variableId = actionElement.dataset.variableId;
                const key = actionElement.dataset.key;
                const path = actionElement.dataset.path;
                const type = actionElement.dataset.type;
                this.saveNestedPropertyEditFromDialog(actionElement, variableId, key, path, type);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#nested-property-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘
     */
    async saveNestedPropertyEditFromDialog(button, variableId, key, path, type) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const newKey = dialog.querySelector('#nested-property-key').value.trim();
            const valueText = dialog.querySelector('#nested-property-value').value.trim();

            if (!newKey) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            if (!valueText) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            // è§£æJSONå€¼
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                alert('JSONæ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // éªŒè¯ç±»å‹
            if (type === 'array' && !Array.isArray(value)) {
                alert('è¾“å…¥çš„å†…å®¹ä¸æ˜¯æ•°ç»„æ ¼å¼');
                return;
            }
            if (type === 'object' && (typeof value !== 'object' || value === null || Array.isArray(value))) {
                alert('è¾“å…¥çš„å†…å®¹ä¸æ˜¯å¯¹è±¡æ ¼å¼');
                return;
            }

            // å¦‚æœå±æ€§åå‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡å‘½åå±æ€§
            if (newKey !== key) {
                await this.renameNestedProperty(variableId, key, newKey, path, value);
            } else {
                // ä¿å­˜åµŒå¥—å±æ€§
                await this.saveNestedPropertyEditToVariable(variableId, key, path, value);
            }

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… ç¼–è¾‘åµŒå¥—å±æ€§:', newKey, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘å¤±è´¥: ' + error.message);
        }
    }

    /**
     * é‡å‘½ååµŒå¥—å±æ€§
     */
    async renameNestedProperty(variableId, oldKey, newKey, path, newValue) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // åˆ é™¤æ—§å±æ€§ï¼Œæ·»åŠ æ–°å±æ€§
            delete targetObject[oldKey];
            targetObject[newKey] = newValue;

            // ä¿å­˜åˆ°å˜é‡
            await this.saveVariableToSillyTavern(variableId, variable.value);

            console.log('[VariableManager] âœ… é‡å‘½ååµŒå¥—å±æ€§:', oldKey, 'â†’', newKey);
        } catch (error) {
            console.error('[VariableManager] âŒ é‡å‘½ååµŒå¥—å±æ€§å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘åˆ°å˜é‡
     */
    async saveNestedPropertyEditToVariable(variableId, key, path, value) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // è®¾ç½®æ–°å€¼
            targetObject[key] = value;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—å±æ€§ç¼–è¾‘å·²ä¿å­˜:', variableId, path, key, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨
     */
    openStatusBarEditor() {
        try {
            console.log('[InfoBarSettings] ğŸ¨ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨...');

            // åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨æ¨¡æ€æ¡†
            this.createStatusBarEditorModal();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    openHTMLTemplateEditor() {
        return this.openStatusBarEditor();
    }

    /**
     * åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨æ¨¡æ€æ¡†
     */
    createStatusBarEditorModal() {
        try {
            // ç§»é™¤ç°æœ‰çš„ç¼–è¾‘å™¨æ¨¡æ€æ¡†
            const existingModal = document.querySelector('.status-bar-editor-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            const modalHTML = this.createStatusBarEditorHTML();

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // ç»‘å®šäº‹ä»¶
            this.bindStatusBarEditorEvents();

            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ ç¼–è¾‘å™¨åˆ›å»ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createHTMLTemplateEditorModal() {
        return this.createStatusBarEditorModal();
    }

    /**
     * è·å–ä¿¡æ¯æ ä¸»é¢˜é¢œè‰²
     */
    getInfoBarThemeColor(type) {
        try {
            // ä»SillyTavernæ‰©å±•è®¾ç½®è·å–å½“å‰ä¸»é¢˜
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            const configs = extensionSettings['Information bar integration tool'] || {};
            const themeConfig = configs.theme || {};
            const currentThemeId = themeConfig.current || 'default';

            console.log('[InfoBarSettings] ğŸ¨ è·å–ä¸»é¢˜é¢œè‰²:', { currentThemeId, type });

            // ä¿¡æ¯æ ä¸»é¢˜é¢œè‰²é…ç½®
            const themeColors = {
                default: {
                    background: '#1a1a1a',
                    surface: '#2a2a2a',
                    border: '#333',
                    text: '#fff',
                    textSecondary: '#888',
                    accent: '#007bff'
                },
                dark: {
                    background: '#0f0f0f',
                    surface: '#1a1a1a',
                    border: '#2a2a2a',
                    text: '#e0e0e0',
                    textSecondary: '#999',
                    accent: '#4CAF50'
                },
                blue: {
                    background: '#1a1a2e',
                    surface: '#16213e',
                    border: '#0f3460',
                    text: '#e6e6e6',
                    textSecondary: '#94a3b8',
                    accent: '#5eead4'
                },
                purple: {
                    background: '#2d1b69',
                    surface: '#3c2a78',
                    border: '#4a3586',
                    text: '#f0f0f0',
                    textSecondary: '#c4b5fd',
                    accent: '#8b5cf6'
                },
                green: {
                    background: '#0f2027',
                    surface: '#203a43',
                    border: '#2c5530',
                    text: '#e8f5e8',
                    textSecondary: '#a8d8a8',
                    accent: '#4ade80'
                },
                red: {
                    background: '#2d1b1b',
                    surface: '#3c2a2a',
                    border: '#4a3535',
                    text: '#f0e8e8',
                    textSecondary: '#d8a8a8',
                    accent: '#f87171'
                },
                'purple-night': {
                    background: '#1a1a1a',
                    surface: '#2a2a2a',
                    border: '#333',
                    text: '#fff',
                    textSecondary: '#888',
                    accent: '#007bff'
                }
            };

            const theme = themeColors[currentThemeId] || themeColors.default;
            const color = theme[type] || theme.background;

            console.log('[InfoBarSettings] ğŸ¨ è¿”å›é¢œè‰²:', { type, color });
            return color;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸»é¢˜é¢œè‰²å¤±è´¥:', error);
            // è¿”å›é»˜è®¤é¢œè‰²
            const defaults = {
                background: '#1a1a1a',
                surface: '#2a2a2a',
                border: '#333',
                text: '#fff',
                textSecondary: '#888',
                accent: '#007bff'
            };
            return defaults[type] || defaults.background;
        }
    }

    /**
     * åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨HTML - å…¨æ–°å“åº”å¼è®¾è®¡
     */
    createStatusBarEditorHTML() {
        // é¢„å…ˆè·å–æ‰€æœ‰ä¸»é¢˜é¢œè‰²ï¼Œé¿å…åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­é‡å¤è°ƒç”¨
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="status-bar-editor-modal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            ">
                <div class="status-bar-editor-container" style="
                    width: 100%;
                    height: 100%;
                    max-width: 1600px;
                    max-height: 900px;
                    min-width: 800px;
                    min-height: 600px;
                    background: ${themeColors.background};
                    border-radius: 12px;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
                    border: 1px solid ${themeColors.border};
                    position: relative;
                ">
                    <!-- ç¼–è¾‘å™¨å¤´éƒ¨ - å“åº”å¼è®¾è®¡ -->
                    <div class="editor-header" style="
                        padding: 16px 24px;
                        background: ${themeColors.surface};
                        border-bottom: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                        min-height: 70px;
                    ">
                        <div class="editor-title" style="flex-grow: 1; min-width: 0;">
                            <h3 style="margin: 0; color: ${themeColors.text}; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-edit" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                çŠ¶æ€æ ç¼–è¾‘
                            </h3>
                            <p style="margin: 4px 0 0 0; color: ${themeColors.textSecondary}; font-size: 13px;">
                                æ™ºèƒ½åˆ›å»ºå’Œç¼–è¾‘è‡ªå®šä¹‰çŠ¶æ€æ æ ·å¼ï¼Œæ”¯æŒAIåˆ›ä½œå’Œå®æ—¶é¢„è§ˆ
                            </p>
                        </div>
                        <div class="editor-controls" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                            <button class="btn btn-secondary" data-action="close-status-bar-editor" style="
                                padding: 8px 12px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘å™¨ä¸»ä½“ - å¯è°ƒæ•´çš„å“åº”å¼å¸ƒå±€ -->
                    <div class="editor-body" style="
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        position: relative;
                        min-height: 0;
                    ">
                        <!-- å·¦ä¾§ç¼–è¾‘åŒº - è‡ªé€‚åº”å®½åº¦ -->
                        <div class="editor-left" style="
                            flex: 1;
                            min-width: 400px;
                            display: flex;
                            flex-direction: column;
                            border-right: 1px solid ${themeColors.border};
                            background: ${themeColors.background};
                        ">
                            <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
                            <div class="editor-toolbar" style="
                                display: flex;
                                align-items: center;
                                padding: 8px 16px;
                                background: ${themeColors.surface};
                                border-bottom: 1px solid ${themeColors.border};
                                gap: 12px;
                                flex-shrink: 0;
                            ">
                                <div class="editor-tabs" style="display: flex; gap: 4px;">
                                <button class="editor-tab active" data-tab="html" style="
                                        padding: 6px 12px;
                                        background: ${themeColors.accent};
                                    border: none;
                                        color: ${themeColors.background};
                                    cursor: pointer;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">ç¼–è¾‘å™¨</button>
                                <button class="editor-tab" data-tab="preview" style="
                                        padding: 6px 12px;
                                        background: transparent;
                                        border: 1px solid ${themeColors.border};
                                    color: ${themeColors.textSecondary};
                                    cursor: pointer;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        transition: all 0.2s ease;
                                    ">é¢„è§ˆ</button>
                            </div>
                                <div class="editor-tools" style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                                    <span class="editor-info" style="font-size: 11px; color: ${themeColors.textSecondary};">
                                        <i class="fas fa-info-circle"></i> è¡Œ: <span class="line-count">1</span>, åˆ—: <span class="col-count">1</span>
                                    </span>
                                    <button class="editor-tool-btn" data-action="toggle-wrap" style="
                                        padding: 4px 8px;
                                        background: transparent;
                                        border: 1px solid ${themeColors.border};
                                        color: ${themeColors.textSecondary};
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 11px;
                                    ">
                                        <i class="fas fa-text-width"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="editor-content" style="flex: 1; position: relative; overflow: hidden;">
                                <!-- ä»£ç ç¼–è¾‘å™¨ -->
                                <div class="code-editor-container" style="
                                    width: 100%;
                                    height: 100%;
                                    position: relative;
                                    background: ${themeColors.background};
                                ">
                                <textarea class="html-template-textarea" style="
                                    width: 100%;
                                    height: 100%;
                                    background: ${themeColors.background};
                                    color: ${themeColors.text};
                                    border: none;
                                    padding: 20px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        font-size: 13px;
                                        line-height: 1.6;
                                    resize: none;
                                    outline: none;
                                        box-sizing: border-box;
                                        tab-size: 2;
                                        white-space: pre;
                                        overflow-wrap: normal;
                                        word-break: normal;
                                " placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„HTMLæ¨¡æ¿ä»£ç ...

ğŸš€ å¿«é€Ÿå¼€å§‹ï¼š
<div class='status-card'>
    <div class='status-header'>
    <h3>{{data.name}}</h3>
        <span class='status-badge'>{{data.status}}</span>
    </div>
    <div class='status-content'>
        <div class='progress-bar'>
            <div class='progress-fill' style='width: {{computed.healthPercentage}}%'></div>
    </div>
    <p>ç”Ÿå‘½å€¼: {{data.health}}/{{data.maxHealth}}</p>
    </div>
</div>

ğŸ’¡ æç¤ºï¼šä½¿ç”¨å³ä¾§é¢æ¿æŸ¥çœ‹å¯ç”¨æ•°æ®å­—æ®µå’Œè¯­æ³•å¸®åŠ©"></textarea>

                                    <!-- è¯­æ³•é«˜äº®å±‚ -->
                                    <div class="syntax-highlight-layer" style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        pointer-events: none;
                                        z-index: 1;
                                        background: transparent;
                                        padding: 20px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        font-size: 13px;
                                        line-height: 1.6;
                                        box-sizing: border-box;
                                        overflow: hidden;
                                        white-space: pre;
                                        color: transparent;
                                    "></div>
                                </div>

                                <!-- é¢„è§ˆå®¹å™¨ -->
                                <div class="preview-container" style="
                                    width: 100%;
                                    height: 100%;
                                    background: ${themeColors.background};
                                    padding: 20px;
                                    overflow: auto;
                                    display: none;
                                    box-sizing: border-box;
                                    border: 1px solid ${themeColors.border};
                                    border-radius: 8px;
                                    margin: 10px;
                                    width: calc(100% - 20px);
                                    height: calc(100% - 20px);
                                ">
                                    <div class="preview-content"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å¯è°ƒæ•´åˆ†éš”æ¡ -->
                        <div class="editor-resizer" style="
                            width: 4px;
                            background: ${themeColors.border};
                            cursor: col-resize;
                            position: relative;
                            transition: background 0.2s ease;
                            flex-shrink: 0;
                        "
                        onmouseover="this.style.background='${themeColors.accent}'"
                        onmouseout="this.style.background='${themeColors.border}'">
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                width: 2px;
                                height: 30px;
                                background: ${themeColors.textSecondary};
                                border-radius: 1px;
                            "></div>
                        </div>

                        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ - è‡ªé€‚åº”å®½åº¦ -->
                        <div class="editor-right" style="
                            width: 420px;
                            min-width: 300px;
                            max-width: 600px;
                            background: ${themeColors.surface};
                            display: flex;
                            flex-direction: column;
                            border-left: 1px solid ${themeColors.border};
                        ">
                            <!-- çŠ¶æ€æ åˆ›ä½œä¸­å¿ƒ -->
                            <div class="status-bar-creation-center" style="
                                display: flex;
                                background: ${themeColors.background};
                                border-bottom: 1px solid ${themeColors.border};
                                padding: 12px 16px;
                                align-items: center;
                                gap: 12px;
                                flex-shrink: 0;
                            ">
                                <div class="creation-center-title" style="
                                    color: ${themeColors.text};
                                    font-size: 14px;
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-magic" style="color: ${themeColors.accent};"></i>
                                    çŠ¶æ€æ åˆ›ä½œä¸­å¿ƒ
                                </div>
                                <div class="creation-actions" style="
                                    display: flex;
                                    gap: 8px;
                                    margin-left: auto;
                                ">

                                    <button class="btn btn-sm btn-outline-secondary data-info-btn" data-action="show-data-info" style="
                                        padding: 6px 12px;
                                        font-size: 12px;
                                        border: 1px solid ${themeColors.border};
                                        background: transparent;
                                        color: ${themeColors.textSecondary};
                                        border-radius: 6px;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='${themeColors.border}'; this.style.color='${themeColors.text}'"
                                       onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                        <i class="fas fa-info-circle"></i> æ•°æ®ä¿¡æ¯
                                    </button>
                                </div>
                            </div>
                            <div class="info-content" style="
                                flex: 1;
                                padding: 16px;
                                overflow-y: auto;
                                color: ${themeColors.text};
                                font-size: 12px;
                                line-height: 1.5;
                                min-height: 0;
                            ">
                                ${this.createStatusBarPromptEditor()}
                            </div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘å™¨åº•éƒ¨çŠ¶æ€æ  - å“åº”å¼è®¾è®¡ -->
                    <div class="editor-footer" style="
                        padding: 12px 24px;
                        background: ${themeColors.surface};
                        border-top: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                        min-height: 50px;
                        gap: 16px;
                    ">
                        <div class="editor-status" style="display: flex; align-items: center; gap: 16px; flex-grow: 1;">
                            <span class="status-indicator" style="
                                display: flex;
                                align-items: center;
                                gap: 6px;
                                color: ${themeColors.textSecondary};
                                font-size: 11px;
                            ">
                                <i class="fas fa-circle" style="color: #4CAF50; font-size: 8px;"></i>
                                å°±ç»ª
                            </span>
                            <span class="template-size" style="color: ${themeColors.textSecondary}; font-size: 11px;">
                                å¤§å°: <span class="size-value">0</span> å­—ç¬¦
                            </span>
                            <span class="validation-status" style="color: ${themeColors.textSecondary}; font-size: 11px;">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i> è¯­æ³•æ­£ç¡®
                            </span>
                        </div>
                        <div class="editor-actions" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-outline-secondary" data-action="load-template" style="
                                padding: 6px 12px;
                                font-size: 11px;
                                border: 1px solid ${themeColors.border};
                                background: transparent;
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-folder-open"></i> åŠ è½½
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-action="save-template" style="
                                padding: 6px 12px;
                                font-size: 11px;
                                border: 1px solid ${themeColors.border};
                                background: transparent;
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-save"></i> ä¿å­˜
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="apply-template" style="
                                padding: 6px 16px;
                                font-size: 11px;
                                background: ${themeColors.accent};
                                color: ${themeColors.background};
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: 500;
                                box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-check"></i> åº”ç”¨æ¨¡æ¿
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ åˆ›å»ºçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨
     */
    createStatusBarPromptEditor() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="status-bar-prompt-editor">
                <!-- AIæç¤ºè¯ç¼–è¾‘åŒºåŸŸ -->
                <div class="prompt-editor-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                ">
                    <h4 style="margin: 0 0 12px 0; color: ${themeColors.accent}; font-size: 14px; font-weight: 600;">
                        <i class="fas fa-robot"></i> AIåˆ›ä½œæç¤ºè¯
                    </h4>
                    <textarea class="prompt-textarea" placeholder="æè¿°æ‚¨æƒ³è¦çš„çŠ¶æ€æ æ ·å¼ï¼Œä¾‹å¦‚ï¼š
â€¢ ç²‰è‰²ä¸»é¢˜è§’è‰²å¡ç‰‡ï¼Œæ˜¾ç¤ºå¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
â€¢ ç®€çº¦ç‰©å“æ ï¼Œç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºé“å…·
â€¢ æŠ€èƒ½é¢æ¿å¸¦è¿›åº¦æ¡å’Œç­‰çº§æ˜¾ç¤º
â€¢ ç°ä»£åŒ–è®¾è®¡ï¼Œæ¸å˜èƒŒæ™¯åœ†è§’å¡ç‰‡
â€¢ å…¶ä»–åˆ›æ„éœ€æ±‚..." style="
                        width: 100%;
                        height: 120px;
                        background: ${themeColors.surface};
                        color: ${themeColors.text};
                        border: 1px solid ${themeColors.border};
                        border-radius: 6px;
                        padding: 12px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        font-size: 13px;
                        line-height: 1.5;
                        resize: vertical;
                        box-sizing: border-box;
                    "></textarea>
                    <div class="prompt-actions" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 12px;
                    ">
                        <div class="prompt-templates" style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="prompt-template-btn" data-template="character" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                è§’è‰²å¡ç‰‡
                            </button>
                            <button class="prompt-template-btn" data-template="inventory" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç‰©å“æ 
                            </button>
                            <button class="prompt-template-btn" data-template="stats" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                å±æ€§é¢æ¿
                            </button>
                            <button class="prompt-template-btn" data-template="modern" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç°ä»£é£æ ¼
                            </button>
                            <button class="prompt-template-btn" data-template="minimal" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç®€çº¦é£æ ¼
                            </button>
                        </div>
                        <button class="use-prompt-btn" data-action="use-custom-prompt" style="
                            padding: 6px 12px;
                            background: ${themeColors.accent};
                            color: ${themeColors.background};
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 500;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <i class="fas fa-robot"></i> AIç”Ÿæˆ
                        </button>
                    </div>
                </div>

                <!-- æ•°æ®å­—æ®µå‚è€ƒ -->
                <div class="data-reference-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 8px;
                    padding: 16px;
                ">
                    <h4 style="margin: 0 0 12px 0; color: ${themeColors.accent}; font-size: 14px; font-weight: 600;">
                        <i class="fas fa-database"></i> å¯ç”¨æ•°æ®å­—æ®µ
                    </h4>
                    <div class="data-fields-list" style="
                        max-height: 200px;
                        overflow-y: auto;
                        border: 1px solid ${themeColors.border};
                        border-radius: 6px;
                        padding: 2px;
                        background: ${themeColors.surface};
                    ">
                        <div class="loading-fields" style="
                            text-align: center;
                            padding: 20px;
                            color: ${themeColors.textSecondary};
                        ">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½æ•°æ®å­—æ®µ...
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createAdvancedDataSourceInfo() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="advanced-data-source-info">
                <!-- å¿«é€Ÿæ’å…¥åŒºåŸŸ -->
                <div class="quick-insert-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 16px;
                ">
                    <h4 style="margin: 0 0 8px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-bolt"></i> å¿«é€Ÿæ’å…¥
                </h4>
                    <div class="quick-insert-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button class="quick-insert-btn" data-insert="{{data.name}}" style="
                            padding: 4px 8px; background: transparent; border: 1px solid ${themeColors.border};
                            color: ${themeColors.text}; border-radius: 3px; cursor: pointer; font-size: 10px;
                        ">å§“å</button>
                        <button class="quick-insert-btn" data-insert="{{data.health}}" style="
                            padding: 4px 8px; background: transparent; border: 1px solid ${themeColors.border};
                            color: ${themeColors.text}; border-radius: 3px; cursor: pointer; font-size: 10px;
                        ">ç”Ÿå‘½å€¼</button>
                    </div>
                </div>

                <!-- å½“å‰å¯ç”¨é¢æ¿ -->
                <div class="enabled-panels-section">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-database"></i> å½“å‰å¯ç”¨çš„æ•°æ®é¢æ¿
                </h4>
                    <div class="enabled-panels-list" id="enabled-panels-list" style="
                        background: ${themeColors.background}; border: 1px solid ${themeColors.border};
                        border-radius: 4px; padding: 10px; margin-bottom: 16px; min-height: 80px;
                        max-height: 120px; overflow-y: auto;
                    ">
                        <div style="color: ${themeColors.textSecondary}; font-size: 11px;">æ­£åœ¨åŠ è½½æ•°æ®é¢æ¿...</div>
                    </div>
                </div>

                <!-- å¯ç”¨æ•°æ®å­—æ®µ -->
                <div class="available-fields-section">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-tags"></i> å¯ç”¨æ•°æ®å­—æ®µ
                </h4>
                    <div class="available-fields-list" id="available-fields-list" style="
                        background: ${themeColors.background}; border: 1px solid ${themeColors.border};
                        border-radius: 4px; padding: 8px; min-height: 120px; max-height: 200px;
                        overflow-y: auto; font-size: 11px;
                    ">
                        <div style="color: ${themeColors.textSecondary}; font-size: 11px;">æ­£åœ¨åŠ è½½å­—æ®µåˆ—è¡¨...</div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šçŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶ - å…¨æ–°å“åº”å¼ç‰ˆæœ¬
     */
    bindStatusBarEditorEvents() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            // å…³é—­ç¼–è¾‘å™¨
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('[data-action="close-status-bar-editor"]')) {
                    console.log('[InfoBarSettings] ğŸ”’ å…³é—­çŠ¶æ€æ ç¼–è¾‘å™¨');
                    modal.remove();
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
            const closeBtn = modal.querySelector('[data-action="close-status-bar-editor"]');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[InfoBarSettings] ğŸ”’ å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
                    modal.remove();
                });
            }

            // é˜»æ­¢ç‚¹å‡»ç¼–è¾‘å™¨å®¹å™¨æ—¶å…³é—­æ¨¡æ€æ¡†
            modal.querySelector('.status-bar-editor-container')?.addEventListener('click', (e) => {
                e.stopPropagation();
            });



            // æ ‡ç­¾é¡µåˆ‡æ¢ - ç¼–è¾‘å™¨æ ‡ç­¾
            modal.querySelectorAll('.editor-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    this.switchEditorTab(tab.dataset.tab);
                });
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢ - ä¿¡æ¯é¢æ¿æ ‡ç­¾
            modal.querySelectorAll('.info-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    this.switchInfoTab(tab.dataset.infoTab);
                });
            });

            // ğŸš€ æ–°å¢ï¼šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶
            this.bindPromptEditorEvents(modal);





            // ğŸš€ æ–°å¢ï¼šæ˜¾ç¤ºæ•°æ®ä¿¡æ¯
            modal.querySelector('[data-action="show-data-info"]')?.addEventListener('click', () => {
                this.showDataInfoPanel();
            });

            // å…¶ä»–æŒ‰é’®äº‹ä»¶
            modal.querySelector('[data-action="load-template"]')?.addEventListener('click', () => {
                this.loadHTMLTemplate();
            });

            modal.querySelector('[data-action="save-template"]')?.addEventListener('click', () => {
                this.saveHTMLTemplate();
            });

            modal.querySelector('[data-action="apply-template"]')?.addEventListener('click', () => {
                this.applyHTMLTemplate();
            });

            // ğŸš€ æ–°å¢ï¼šç¼–è¾‘å™¨å·¥å…·æŒ‰é’®
            modal.querySelector('[data-action="toggle-wrap"]')?.addEventListener('click', () => {
                this.toggleWordWrap();
            });

            // å®æ—¶é¢„è§ˆå’Œè¯­æ³•æ£€æŸ¥
            const textarea = modal.querySelector('.html-template-textarea');
            if (textarea) {
                // è¾“å…¥äº‹ä»¶ - å®æ—¶é¢„è§ˆ
                textarea.addEventListener('input', () => {
                    this.updateTemplatePreview();
                    this.updateEditorStatus();
                    this.validateTemplateSyntax();
                });

                // ğŸš€ æ–°å¢ï¼šå…‰æ ‡ä½ç½®è·Ÿè¸ª
                textarea.addEventListener('selectionchange', () => {
                    this.updateCursorPosition();
                });

                textarea.addEventListener('keyup', () => {
                    this.updateCursorPosition();
                });

                textarea.addEventListener('click', () => {
                    this.updateCursorPosition();
                });

                // ğŸš€ æ–°å¢ï¼šé”®ç›˜å¿«æ·é”®
                textarea.addEventListener('keydown', (e) => {
                    this.handleEditorKeydown(e);
                });
            }

            // ğŸš€ æ–°å¢ï¼šå¯è°ƒæ•´åˆ†éš”æ¡æ‹–æ‹½åŠŸèƒ½
            this.initEditorResizer(modal);

            // ğŸš€ æ–°å¢ï¼šçª—å£å¤§å°å˜åŒ–æ—¶çš„å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                this.adjustEditorLayout();
            });

            // åŠ è½½æ•°æ®ä¿¡æ¯
            this.loadAdvancedDataInfo();

            // è‡ªåŠ¨åŠ è½½HTMLæ¨¡æ¿
            this.loadHTMLTemplate();

            // ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–è¯­æ³•é«˜äº®
            this.initSyntaxHighlight();

            // ğŸš€ æ–°å¢ï¼šåŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨
            this.loadDataFieldsToPromptEditor();

            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®šå®Œæˆ (å“åº”å¼ç‰ˆæœ¬)');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šçŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    bindHTMLTemplateEditorEvents() {
        return this.bindStatusBarEditorEvents();
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–å¯è°ƒæ•´åˆ†éš”æ¡
     */
    initEditorResizer(modal) {
        try {
            const resizer = modal.querySelector('.editor-resizer');
            const leftPanel = modal.querySelector('.editor-left');
            const rightPanel = modal.querySelector('.editor-right');

            if (!resizer || !leftPanel || !rightPanel) return;

            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startLeftWidth = leftPanel.offsetWidth;
                startRightWidth = rightPanel.offsetWidth;

                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const containerWidth = leftPanel.parentElement.offsetWidth;
                const newLeftWidth = startLeftWidth + deltaX;
                const newRightWidth = startRightWidth - deltaX;

                // é™åˆ¶æœ€å°å®½åº¦
                if (newLeftWidth >= 300 && newRightWidth >= 250) {
                    leftPanel.style.flex = 'none';
                    leftPanel.style.width = `${newLeftWidth}px`;
                    rightPanel.style.width = `${newRightWidth}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–åˆ†éš”æ¡å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ’å…¥æ¨¡æ¿æ–‡æœ¬
     */
    insertTemplateText(text) {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentValue = textarea.value;

            const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
            textarea.value = newValue;

            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥æ–‡æœ¬ä¹‹å
            const newCursorPos = start + text.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();

            // è§¦å‘æ›´æ–°äº‹ä»¶
            this.updateTemplatePreview();
            this.updateEditorStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ’å…¥æ¨¡æ¿æ–‡æœ¬å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ ¼å¼åŒ–æ¨¡æ¿
     */
    formatTemplate() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const code = textarea.value;
            if (!code.trim()) return;

            // ç®€å•çš„HTMLæ ¼å¼åŒ–
            const formatted = this.formatHTML(code);
            textarea.value = formatted;

            // è§¦å‘æ›´æ–°
            this.updateTemplatePreview();
            this.updateEditorStatus();

            console.log('[InfoBarSettings] âœ… æ¨¡æ¿æ ¼å¼åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ ¼å¼åŒ–æ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šHTMLæ ¼å¼åŒ–
     */
    formatHTML(html) {
        try {
            let formatted = html;
            let indent = 0;
            const indentSize = 2;

            // ç§»é™¤å¤šä½™çš„ç©ºç™½
            formatted = formatted.replace(/\s+/g, ' ').trim();

            // æ·»åŠ æ¢è¡Œå’Œç¼©è¿›
            formatted = formatted.replace(/</g, '\n<');
            formatted = formatted.replace(/>/g, '>\n');

            const lines = formatted.split('\n').filter(line => line.trim());
            const result = [];

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // å‡å°‘ç¼©è¿›ï¼ˆé—­åˆæ ‡ç­¾ï¼‰
                if (trimmed.startsWith('</')) {
                    indent = Math.max(0, indent - indentSize);
                }

                // æ·»åŠ ç¼©è¿›
                result.push(' '.repeat(indent) + trimmed);

                // å¢åŠ ç¼©è¿›ï¼ˆå¼€æ”¾æ ‡ç­¾ï¼‰
                if (trimmed.startsWith('<') && !trimmed.startsWith('</') && !trimmed.endsWith('/>')) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªé—­åˆæ ‡ç­¾
                    const tagName = trimmed.match(/<([^>\s]+)/)?.[1];
                    const selfClosingTags = ['input', 'img', 'br', 'hr', 'meta', 'link'];
                    if (!selfClosingTags.includes(tagName)) {
                        indent += indentSize;
                    }
                }
            }

            return result.join('\n');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ HTMLæ ¼å¼åŒ–å¤±è´¥:', error);
            return html;
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ›´æ–°å…‰æ ‡ä½ç½®æ˜¾ç¤º
     */
    updateCursorPosition() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const lineCount = document.querySelector('.line-count');
            const colCount = document.querySelector('.col-count');

            if (!textarea || !lineCount || !colCount) return;

            const text = textarea.value.substring(0, textarea.selectionStart);
            const lines = text.split('\n');
            const currentLine = lines.length;
            const currentCol = lines[lines.length - 1].length + 1;

            lineCount.textContent = currentLine;
            colCount.textContent = currentCol;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å…‰æ ‡ä½ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€
     */
    updateEditorStatus() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const sizeValue = document.querySelector('.size-value');

            if (!textarea || !sizeValue) return;

            const charCount = textarea.value.length;
            sizeValue.textContent = charCount.toLocaleString();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šéªŒè¯æ¨¡æ¿è¯­æ³•
     */
    validateTemplateSyntax() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const validationStatus = document.querySelector('.validation-status');

            if (!textarea || !validationStatus) return;

            const template = textarea.value;
            const errors = this.checkTemplateSyntax(template);

            if (errors.length === 0) {
                validationStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i> è¯­æ³•æ­£ç¡®';
            } else {
                validationStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #FF5722;"></i> ${errors.length} ä¸ªé”™è¯¯`;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯æ¨¡æ¿è¯­æ³•å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥æ¨¡æ¿è¯­æ³•
     */
    checkTemplateSyntax(template) {
        const errors = [];

        try {
            // æ£€æŸ¥HTMLæ ‡ç­¾åŒ¹é…
            const htmlErrors = this.checkHTMLSyntax(template);
            errors.push(...htmlErrors);

            // æ£€æŸ¥æ¨¡æ¿è¯­æ³•
            const templateErrors = this.checkTemplateBindingSyntax(template);
            errors.push(...templateErrors);

        } catch (error) {
            errors.push('è¯­æ³•æ£€æŸ¥å™¨å†…éƒ¨é”™è¯¯');
        }

        return errors;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥HTMLè¯­æ³•
     */
    checkHTMLSyntax(html) {
        const errors = [];

        try {
            // ç®€å•çš„æ ‡ç­¾åŒ¹é…æ£€æŸ¥
            const openTags = [];
            const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/g;
            let match;

            while ((match = tagRegex.exec(html)) !== null) {
                const tag = match[1].toLowerCase();
                const isClosing = match[0].startsWith('</');
                const isSelfClosing = match[0].endsWith('/>');

                if (isSelfClosing) continue;

                if (isClosing) {
                    const lastOpen = openTags.pop();
                    if (!lastOpen || lastOpen !== tag) {
                        errors.push(`æ ‡ç­¾ä¸åŒ¹é…: </${tag}>`);
                    }
                } else {
                    // è‡ªé—­åˆæ ‡ç­¾ä¸éœ€è¦åŒ¹é…
                    const selfClosingTags = ['input', 'img', 'br', 'hr', 'meta', 'link'];
                    if (!selfClosingTags.includes(tag)) {
                        openTags.push(tag);
                    }
                }
            }

            // æ£€æŸ¥æœªé—­åˆçš„æ ‡ç­¾
            openTags.forEach(tag => {
                errors.push(`æœªé—­åˆçš„æ ‡ç­¾: <${tag}>`);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ HTMLè¯­æ³•æ£€æŸ¥å¤±è´¥:', error);
        }

        return errors;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥æ¨¡æ¿ç»‘å®šè¯­æ³•
     */
    checkTemplateBindingSyntax(template) {
        const errors = [];

        try {
            // æ£€æŸ¥æœªé—­åˆçš„æ¨¡æ¿æ ‡ç­¾
            const openPatterns = [
                { regex: /\{\{#if\s+[^}]+\}\}/g, close: '{{/if}}', name: 'if' },
                { regex: /\{\{#each\s+[^}]+\}\}/g, close: '{{/each}}', name: 'each' }
            ];

            for (const pattern of openPatterns) {
                const opens = [...template.matchAll(pattern.regex)];
                const closes = [...template.matchAll(new RegExp(pattern.close.replace(/[{}]/g, '\\$&'), 'g'))];

                if (opens.length !== closes.length) {
                    errors.push(`${pattern.name} æ ‡ç­¾æ•°é‡ä¸åŒ¹é…`);
                }
            }

            // æ£€æŸ¥æ— æ•ˆçš„ç»‘å®šè¯­æ³•
            const invalidBindings = template.match(/\{\{[^}]*\{\{|\}\}[^{]*\}\}/g);
            if (invalidBindings) {
                errors.push('æ£€æµ‹åˆ°æ— æ•ˆçš„ç»‘å®šè¯­æ³•');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ¿ç»‘å®šè¯­æ³•æ£€æŸ¥å¤±è´¥:', error);
        }

        return errors;
    }

    /**
     * åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾é¡µ - æ›´æ–°ç‰ˆæœ¬
     */
    switchEditorTab(tabName) {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const themeColors = {
                background: this.getInfoBarThemeColor('background'),
                accent: this.getInfoBarThemeColor('accent'),
                textSecondary: this.getInfoBarThemeColor('textSecondary')
            };

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            modal.querySelectorAll('.editor-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.background = themeColors.accent;
                    tab.style.color = themeColors.background;
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'transparent';
                    tab.style.color = themeColors.textSecondary;
                    tab.style.border = '1px solid ' + this.getInfoBarThemeColor('border');
                }
            });

            // åˆ‡æ¢å†…å®¹
            const codeEditor = modal.querySelector('.code-editor-container');
            const preview = modal.querySelector('.preview-container');

            if (tabName === 'html') {
                if (codeEditor) codeEditor.style.display = 'block';
                if (preview) preview.style.display = 'none';
            } else if (tabName === 'preview') {
                if (codeEditor) codeEditor.style.display = 'none';
                if (preview) preview.style.display = 'block';
                this.updateTemplatePreview();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾é¡µå¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢ä¿¡æ¯æ ‡ç­¾é¡µ
     */
    switchInfoTab(tabName) {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            modal.querySelectorAll('.info-tab').forEach(tab => {
                if (tab.dataset.infoTab === tabName) {
                    tab.classList.add('active');
                    tab.style.color = 'var(--SmartThemeBodyColor, #fff)';
                    tab.style.borderBottomColor = 'var(--SmartThemeQuoteColor, #007bff)';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = 'var(--SmartThemeQuoteColor, #888)';
                    tab.style.borderBottomColor = 'transparent';
                }
            });

            // æ›´æ–°å†…å®¹
            const infoContent = modal.querySelector('.info-content');
            if (infoContent) {
                switch (tabName) {
                    case 'data-source':
                        infoContent.innerHTML = this.createAdvancedDataSourceInfo();
                        this.loadAdvancedDataInfo();
                        break;
                    case 'syntax-help':
                        infoContent.innerHTML = this.createSyntaxHelpInfo();
                        this.bindSyntaxHelpEvents();
                        break;
                    case 'templates':
                        infoContent.innerHTML = this.createTemplateLibraryInfo();
                        this.loadTemplateLibrary();
                        break;
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢ä¿¡æ¯æ ‡ç­¾é¡µå¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºè¯­æ³•å¸®åŠ©ä¿¡æ¯
     */
    createSyntaxHelpInfo() {
        return `
            <div class="syntax-help-info">
                <h4 style="margin: 0 0 10px 0; color: var(--SmartThemeQuoteColor, #007bff);">
                    <i class="fas fa-book"></i> æ¨¡æ¿è¯­æ³•è¯´æ˜
                </h4>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">æ•°æ®ç»‘å®š</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px;">{{data.fieldName}}</code>
                    <p style="margin: 5px 0; font-size: 12px;">ç»‘å®šæ•°æ®å­—æ®µï¼Œå¦‚ {{data.name}}ã€{{data.health}}</p>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">è®¡ç®—å­—æ®µ</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px;">{{computed.fieldName}}</code>
                    <p style="margin: 5px 0; font-size: 12px;">ä½¿ç”¨è®¡ç®—å­—æ®µï¼Œå¦‚ {{computed.healthPercentage}}</p>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">æ¡ä»¶æ¸²æŸ“</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px; display: block; margin: 5px 0;">
                        {{#if data.health > 50}}<br>
                        &nbsp;&nbsp;å¥åº·çŠ¶æ€è‰¯å¥½<br>
                        {{/if}}
                    </code>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">å¾ªç¯æ¸²æŸ“</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px; display: block; margin: 5px 0;">
                        {{#each data.items}}<br>
                        &nbsp;&nbsp;&lt;div&gt;{{this.name}}&lt;/div&gt;<br>
                        {{/each}}
                    </code>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">å¸¸ç”¨è®¡ç®—å­—æ®µ</h5>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                        <li>{{computed.healthPercentage}} - ç”Ÿå‘½å€¼ç™¾åˆ†æ¯”</li>
                        <li>{{computed.timestamp}} - å½“å‰æ—¶é—´æˆ³</li>
                    </ul>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæ¨¡æ¿åº“ä¿¡æ¯
     */
    createTemplateLibraryInfo() {
        return `
            <div class="template-library-info">
                <h4 style="margin: 0 0 10px 0; color: var(--SmartThemeQuoteColor, #007bff);">
                    <i class="fas fa-layer-group"></i> æ¨¡æ¿åº“
                </h4>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="character-card">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">è§’è‰²å¡ç‰‡</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">æ˜¾ç¤ºè§’è‰²åŸºæœ¬ä¿¡æ¯å’ŒçŠ¶æ€</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="status-bar">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">çŠ¶æ€æ </h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">ç®€æ´çš„ç”Ÿå‘½å€¼å’ŒçŠ¶æ€æ˜¾ç¤º</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="inventory-grid">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">ç‰©å“ç½‘æ ¼</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">ç½‘æ ¼å¼ç‰©å“å±•ç¤ºç•Œé¢</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="rpg-dashboard">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">RPGä»ªè¡¨æ¿</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">å®Œæ•´çš„RPGæ¸¸æˆç•Œé¢</p>
                </div>

                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" data-action="import-template">
                    <i class="fas fa-upload"></i> å¯¼å…¥è‡ªå®šä¹‰æ¨¡æ¿
                </button>
            </div>
        `;
    }

    /**
     * æ›´æ–°æ¨¡æ¿é¢„è§ˆ
     */
    updateTemplatePreview() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const textarea = modal.querySelector('.html-template-textarea');
            const preview = modal.querySelector('.preview-container');

            if (!textarea || !preview) return;

            const template = textarea.value;

            // è·å–ç¤ºä¾‹æ•°æ®
            const sampleData = this.getSampleData();

            // ä½¿ç”¨HTMLæ¨¡æ¿è§£æå™¨æ¸²æŸ“é¢„è§ˆ
            const infoBarTool = window.SillyTavernInfobar?.modules?.infoBarTool;
            if (infoBarTool && infoBarTool.htmlTemplateParser) {
                const renderedHTML = infoBarTool.htmlTemplateParser.parseTemplate(template, sampleData);
                preview.innerHTML = renderedHTML;
            } else {
                // ç®€å•çš„é¢„è§ˆæ¸²æŸ“
                preview.innerHTML = this.simpleTemplateRender(template, sampleData);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ¨¡æ¿é¢„è§ˆå¤±è´¥:', error);
            const preview = document.querySelector('.status-bar-editor-modal .preview-container');
            if (preview) {
                preview.innerHTML = `<div style="color: red; padding: 10px;">é¢„è§ˆé”™è¯¯: ${error.message}</div>`;
            }
        }
    }

    /**
     * è·å–ç¤ºä¾‹æ•°æ®
     */
    getSampleData() {
        return {
            data: {
                name: 'å½±ä¹‹åˆƒ',
                health: 1240,
                maxHealth: 1580,
                energy: 320,
                maxEnergy: 450,
                level: 42,
                class: 'æš—å½±åˆºå®¢',
                location: 'æš—å½±æ£®æ—',
                mood: 'è­¦è§‰',
                items: [
                    { name: 'æš—å½±ä¹‹ç‰™', type: 'æ­¦å™¨', quantity: 1 },
                    { name: 'æ²»ç–—è¯æ°´', type: 'æ¶ˆè€—å“', quantity: 8 },
                    { name: 'å›åŸå·è½´', type: 'é“å…·', quantity: 3 }
                ]
            },
            computed: {
                healthPercentage: 78,
                energyPercentage: 71,
                timestamp: new Date().toLocaleString()
            }
        };
    }

    /**
     * ğŸš€ å¢å¼ºçš„æ¨¡æ¿æ¸²æŸ“ - æ”¯æŒå¤æ‚æ•°æ®è·¯å¾„å’ŒCSSæ ·å¼
     */
    simpleTemplateRender(template, data) {
        try {
            let result = template;

            // ğŸ”§ ä¿®å¤ï¼šæ”¯æŒå¤æ‚çš„æ•°æ®è·¯å¾„ï¼Œå¦‚ {{data.personal.name}}
            result = result.replace(/\{\{data\.([^}]+)\}\}/g, (match, path) => {
                try {
                    const keys = path.split('.');
                    let value = data.data;

                    for (const key of keys) {
                        if (value && typeof value === 'object' && key in value) {
                            value = value[key];
                        } else {
                            return ''; // å¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
                        }
                    }

                    return String(value || '');
                } catch (e) {
                    console.warn('[InfoBarSettings] æ•°æ®è·¯å¾„è§£æå¤±è´¥:', path, e);
                    return '';
                }
            });

            // å¤„ç†è®¡ç®—å­—æ®µ
            result = result.replace(/\{\{computed\.([^}]+)\}\}/g, (match, field) => {
                try {
                    const keys = field.split('.');
                    let value = data.computed;

                    for (const key of keys) {
                        if (value && typeof value === 'object' && key in value) {
                            value = value[key];
                        } else {
                            return '';
                        }
                    }

                    return String(value || '');
                } catch (e) {
                    console.warn('[InfoBarSettings] è®¡ç®—å­—æ®µè§£æå¤±è´¥:', field, e);
                    return '';
                }
            });

            // ğŸš€ æ–°å¢ï¼šå¤„ç†æ¡ä»¶æ¸²æŸ“ {{#if condition}}...{{/if}}
            result = result.replace(/\{\{#if\s+([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
                try {
                    // ç®€å•çš„æ¡ä»¶åˆ¤æ–­
                    let conditionValue = false;

                    if (condition.startsWith('data.')) {
                        const path = condition.substring(5).split('.');
                        let value = data.data;
                        for (const key of path) {
                            if (value && typeof value === 'object' && key in value) {
                                value = value[key];
                            } else {
                                value = null;
                                break;
                            }
                        }
                        conditionValue = Boolean(value);
                    }

                    return conditionValue ? content : '';
                } catch (e) {
                    console.warn('[InfoBarSettings] æ¡ä»¶æ¸²æŸ“è§£æå¤±è´¥:', condition, e);
                    return '';
                }
            });

            // ğŸš€ æ–°å¢ï¼šå¤„ç†å¾ªç¯æ¸²æŸ“ {{#each array}}...{{/each}}
            result = result.replace(/\{\{#each\s+([^}]+)\}\}([\s\S]*?)\{\{\/each\}\}/g, (match, arrayPath, itemTemplate) => {
                try {
                    let arrayValue = [];

                    if (arrayPath.startsWith('data.')) {
                        const path = arrayPath.substring(5).split('.');
                        let value = data.data;
                        for (const key of path) {
                            if (value && typeof value === 'object' && key in value) {
                                value = value[key];
                            } else {
                                value = null;
                                break;
                            }
                        }
                        if (Array.isArray(value)) {
                            arrayValue = value;
                        }
                    }

                    return arrayValue.map((item, index) => {
                        let itemHtml = itemTemplate;
                        // æ›¿æ¢ {{this}} ä¸ºå½“å‰é¡¹
                        itemHtml = itemHtml.replace(/\{\{this\}\}/g, String(item || ''));
                        // æ›¿æ¢ {{@index}} ä¸ºç´¢å¼•
                        itemHtml = itemHtml.replace(/\{\{@index\}\}/g, String(index));
                        return itemHtml;
                    }).join('');
                } catch (e) {
                    console.warn('[InfoBarSettings] å¾ªç¯æ¸²æŸ“è§£æå¤±è´¥:', arrayPath, e);
                    return '';
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿CSSæ ·å¼æ­£ç¡®ä¿ç•™
            // ç§»é™¤å¯èƒ½ç ´åCSSçš„è½¬ä¹‰
            result = result.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');

            console.log('[InfoBarSettings] âœ… æ¨¡æ¿æ¸²æŸ“å®Œæˆï¼Œç»“æœé•¿åº¦:', result.length);
            return result;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ¿æ¸²æŸ“å¤±è´¥:', error);
            return `<div style="color: red; padding: 10px; border: 1px solid red; border-radius: 4px; background: #ffe6e6;">
                <strong>æ¸²æŸ“é”™è¯¯:</strong> ${error.message}
                <br><small>è¯·æ£€æŸ¥æ¨¡æ¿è¯­æ³•æ˜¯å¦æ­£ç¡®</small>
            </div>`;
        }
    }

    /**
     * åŠ è½½å½“å‰æ•°æ®ä¿¡æ¯
     */
    async loadCurrentDataInfo() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanelsList = modal.querySelector('#enabled-panels-list');
            const availableFieldsList = modal.querySelector('#available-fields-list');

            if (enabledPanelsList) {
                const enabledPanels = this.getEnabledPanels();
                if (Object.keys(enabledPanels).length > 0) {
                    enabledPanelsList.innerHTML = Object.entries(enabledPanels)
                        .map(([panelId, config]) => `
                            <div style="margin: 5px 0; padding: 5px; background: var(--SmartThemeBodyColor, #333); border-radius: 3px;">
                                <strong>${config.name || panelId}</strong>
                                <div style="font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">
                                    å­—æ®µ: ${(config.fields || []).join(', ') || 'æ— '}
                                </div>
                            </div>
                        `).join('');
                } else {
                    enabledPanelsList.innerHTML = '<p style="color: var(--SmartThemeQuoteColor, #888);">æš‚æ— å¯ç”¨çš„é¢æ¿</p>';
                }
            }

            if (availableFieldsList) {
                try {
                    // è·å–å½“å‰æ•°æ®å­—æ®µ
                    const fields = await this.getCurrentDataFields();

                    if (Object.keys(fields).length > 0) {
                        availableFieldsList.innerHTML = Object.entries(fields)
                            .map(([panelId, fieldList]) => `
                                <div style="margin: 5px 0;">
                                    <strong>${panelId}:</strong>
                                    <div style="font-size: 11px; margin-left: 10px;">
                                        ${fieldList.map(field => `<code style="background: ${this.getInfoBarThemeColor('surface')}; padding: 1px 3px; margin: 1px; border-radius: 2px; color: ${this.getInfoBarThemeColor('accent')};">{{data.${field}}}</code>`).join(' ')}
                                    </div>
                                </div>
                            `).join('');
                    } else {
                        availableFieldsList.innerHTML = `<p style="color: ${this.getInfoBarThemeColor('textSecondary')};">æš‚æ— å¯ç”¨æ•°æ®å­—æ®µ</p>`;
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®å­—æ®µå¤±è´¥:', error);
                    availableFieldsList.innerHTML = `<p style="color: ${this.getInfoBarThemeColor('textSecondary')};">åŠ è½½æ•°æ®å­—æ®µå¤±è´¥</p>`;
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å½“å‰æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†AIä¿®æ”¹æ¨¡æ¿
     */
    async handleAIModifyTemplate() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const textarea = modal.querySelector('.html-template-textarea');
            const aiButton = modal.querySelector('[data-action="ai-modify-template"]');

            if (!textarea) return;

            const userTemplate = textarea.value.trim();
            if (!userTemplate) {
                alert('è¯·å…ˆè¾“å…¥HTMLæ¨¡æ¿ä»£ç ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIå¤„ç†ä¸­...';
            aiButton.disabled = true;

            // è°ƒç”¨AIåŠ©æ‰‹ - ä½¿ç”¨è‡ªå®šä¹‰API
            try {
                // è·å–å½“å‰å¯ç”¨çš„é¢æ¿ä¿¡æ¯
                const enabledPanels = this.getEnabledPanels();
                const availableFields = await this.getCurrentDataFields();

                // æ„å»ºAIæç¤ºè¯
                const prompt = this.buildAIModifyPrompt(userTemplate, enabledPanels, availableFields);

                // è°ƒç”¨è‡ªå®šä¹‰API
                const modifiedTemplate = await this.callCustomAI(prompt);

                textarea.value = modifiedTemplate;
                this.updateTemplatePreview();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('AIä¿®æ”¹å®Œæˆï¼', 'success');
            } catch (error) {
                console.error('[InfoBarSettings] âŒ AIä¿®æ”¹å¤±è´¥:', error);
                throw new Error(`AIä¿®æ”¹å¤±è´¥: ${error.message}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ AIä¿®æ”¹æ¨¡æ¿å¤±è´¥:', error);
            this.showNotification(`AIä¿®æ”¹å¤±è´¥: ${error.message}`, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const aiButton = document.querySelector('.html-template-editor-modal [data-action="ai-modify-template"]');
            if (aiButton) {
                aiButton.innerHTML = '<i class="fas fa-magic"></i> AIä¸€é”®ä¿®æ”¹';
                aiButton.disabled = false;
            }
        }
    }

    /**
     * æ˜¾ç¤ºé€šçŸ¥
     */
    showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white;
            border-radius: 5px;
            z-index: 10001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 300px;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    /**
     * åŠ è½½HTMLæ¨¡æ¿
     */
    loadHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] ğŸ“‚ åŠ è½½HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            // è·å–ä¿å­˜çš„è‡ªå®šä¹‰HTMLæ¨¡æ¿
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            const configs = extensionSettings['Information bar integration tool'] || {};
            const customTemplate = configs.customHTMLTemplate;

            if (customTemplate) {
                console.log('[InfoBarSettings] âœ… åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰æ¨¡æ¿');
                textarea.value = customTemplate;
            } else {
                console.log('[InfoBarSettings] ğŸ“ åŠ è½½é»˜è®¤çŠ¶æ€æ æ¨¡æ¿');
                // åŠ è½½ä½ æä¾›çš„çŠ¶æ€æ æ¨¡æ¿
                textarea.value = this.getDefaultStatusBarTemplate();
            }

            // æ›´æ–°é¢„è§ˆ
            this.updateTemplatePreview();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * è·å–é»˜è®¤çŠ¶æ€æ æ¨¡æ¿
     */
    getDefaultStatusBarTemplate() {
        return `<div class="container" style="
    display: flex;
    max-width: 1200px;
    width: 100%;
    background: rgba(15, 23, 42, 0.85);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(94, 234, 212, 0.2);
    backdrop-filter: blur(10px);
    margin: 10px auto;
">
    <!-- è§’è‰²ä¿¡æ¯é¢æ¿ -->
    <div class="character-panel" style="
        flex: 1;
        padding: 20px;
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
        border-right: 1px solid rgba(94, 234, 212, 0.2);
        position: relative;
    ">
        <div class="character-header" style="
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        ">
            <div class="character-avatar" style="
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: linear-gradient(45deg, #5eead4, #06b6d4);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 15px;
                box-shadow: 0 4px 15px rgba(94, 234, 212, 0.3);
            ">
                <i class="fas fa-user" style="color: #0f172a; font-size: 20px;"></i>
            </div>
            <div class="character-info">
                <h3 class="character-name" style="
                    margin: 0;
                    color: #5eead4;
                    font-size: 18px;
                    font-weight: 600;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                ">{{data.character.name || 'æµ‹è¯•è§’è‰²'}}</h3>
                <p class="character-class" style="
                    margin: 2px 0 0 0;
                    color: #94a3b8;
                    font-size: 14px;
                ">{{data.character.class || 'æ³•å¸ˆ'}} - Lv.{{data.character.level || 30}}</p>
            </div>
        </div>

        <!-- ç”Ÿå‘½å€¼æ¡ -->
        <div class="stat-bar health-bar" style="margin-bottom: 12px;">
            <div class="stat-label" style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 12px;
                color: #cbd5e1;
            ">
                <span><i class="fas fa-heart" style="color: #ef4444; margin-right: 5px;"></i>ç”Ÿå‘½å€¼</span>
                <span>{{data.character.health || 850}}/{{data.character.maxHealth || 1000}}</span>
            </div>
            <div class="progress-bar" style="
                width: 100%;
                height: 8px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 4px;
                overflow: hidden;
                border: 1px solid rgba(239, 68, 68, 0.3);
            ">
                <div class="progress-fill" style="
                    width: {{computed.healthPercentage || 85}}%;
                    height: 100%;
                    background: linear-gradient(90deg, #ef4444, #f87171);
                    transition: width 0.3s ease;
                    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
                "></div>
            </div>
        </div>

        <!-- é­”æ³•å€¼æ¡ -->
        <div class="stat-bar mana-bar" style="margin-bottom: 12px;">
            <div class="stat-label" style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 12px;
                color: #cbd5e1;
            ">
                <span><i class="fas fa-magic" style="color: #3b82f6; margin-right: 5px;"></i>é­”æ³•å€¼</span>
                <span>{{data.character.energy || 320}}/{{data.character.maxEnergy || 450}}</span>
            </div>
            <div class="progress-bar" style="
                width: 100%;
                height: 8px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 4px;
                overflow: hidden;
                border: 1px solid rgba(59, 130, 246, 0.3);
            ">
                <div class="progress-fill" style="
                    width: {{computed.energyPercentage || 71}}%;
                    height: 100%;
                    background: linear-gradient(90deg, #3b82f6, #60a5fa);
                    transition: width 0.3s ease;
                    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                "></div>
            </div>
        </div>

        <!-- é‡‘å¸ -->
        <div class="gold-info" style="
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        ">
            <i class="fas fa-coins" style="color: #fbbf24; margin-right: 8px;"></i>
            <span style="color: #fbbf24; font-weight: 500;">{{data.character.gold || 2847}} é‡‘å¸</span>
        </div>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯é¢æ¿ -->
    <div class="status-panel" style="
        flex: 1;
        padding: 20px;
        background: linear-gradient(135deg, rgba(20, 30, 48, 0.9), rgba(15, 23, 42, 0.9));
        position: relative;
    ">
        <h4 style="
            margin: 0 0 15px 0;
            color: #5eead4;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
        ">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            çŠ¶æ€ä¿¡æ¯
        </h4>

        <div class="status-grid" style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        ">
            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">ä½ç½®</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.location || 'ç¥ç§˜æ£®æ—'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">å¿ƒæƒ…</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.mood || 'ä¸“æ³¨'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">æ—¶é—´</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.time || 'é»„æ˜'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">å¤©æ°”</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.weather || 'æ™´æœ—'}}</div>
            </div>
        </div>

        <!-- è£…é¥°æ€§å…ƒç´  -->
        <div style="
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(94, 234, 212, 0.2), transparent);
            animation: pulse 2s infinite;
        "></div>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

.container:hover {
    transform: translateY(-2px);
    transition: transform 0.3s ease;
}

.stat-bar:hover .progress-fill {
    filter: brightness(1.2);
}

.status-item:hover {
    background: rgba(30, 41, 59, 0.7) !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}
</style>`;
    }

    /**
     * ä¿å­˜HTMLæ¨¡æ¿
     */
    saveHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            const templateContent = textarea.value.trim();
            if (!templateContent) {
                console.warn('[InfoBarSettings] âš ï¸ æ¨¡æ¿å†…å®¹ä¸ºç©º');
                return;
            }

            // ä¿å­˜åˆ°SillyTavernæ‰©å±•è®¾ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            extensionSettings['Information bar integration tool'].customHTMLTemplate = templateContent;

            // ä½¿ç”¨æ­£ç¡®çš„ä¿å­˜æ–¹æ³•
            context.saveSettingsDebounced();

            // ğŸ”§ éªŒè¯ä¿å­˜çš„å®Œæ•´æ€§
            setTimeout(() => {
                const savedTemplate = extensionSettings['Information bar integration tool'].customHTMLTemplate;
                if (savedTemplate && savedTemplate.length === templateContent.length) {
                    console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿ä¿å­˜æˆåŠŸï¼Œé•¿åº¦éªŒè¯é€šè¿‡:', templateContent.length);
                } else {
                    console.error('[InfoBarSettings] âŒ HTMLæ¨¡æ¿ä¿å­˜å¯èƒ½ä¸å®Œæ•´:', {
                        åŸå§‹é•¿åº¦: templateContent.length,
                        ä¿å­˜åé•¿åº¦: savedTemplate?.length || 0
                    });
                }
            }, 100);

            console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿ä¿å­˜æˆåŠŸ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨HTMLæ¨¡æ¿
     */
    applyHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] âœ… åº”ç”¨HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            const templateContent = textarea.value.trim();
            if (!templateContent) {
                console.warn('[InfoBarSettings] âš ï¸ æ¨¡æ¿å†…å®¹ä¸ºç©º');
                return;
            }

            // å…ˆä¿å­˜æ¨¡æ¿
            this.saveHTMLTemplate();

            // æ›´æ–°ä¿¡æ¯æ è®¾ç½®ï¼Œå¯ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // æ­£ç¡®è®¾ç½®ä¸ºè‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼
            extensionSettings['Information bar integration tool'].style = {
                current: 'custom-html',
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨æ­£ç¡®çš„ä¿å­˜æ–¹æ³•
            context.saveSettingsDebounced();

            // å…³é—­ç¼–è¾‘å™¨
            modal.remove();

            // åˆ·æ–°ä¿¡æ¯æ æ˜¾ç¤º
            if (this.infoBarTool && this.infoBarTool.messageInfoBarRenderer) {
                this.infoBarTool.messageInfoBarRenderer.refreshAllInfoBars();
            }

            console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿åº”ç”¨æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°è‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * æ„å»ºAIä¿®æ”¹æç¤ºè¯
     */
    buildAIModifyPrompt(userTemplate, enabledPanels, availableFields) {
        // ğŸš€ æ„å»ºç®€åŒ–çš„æ ¸å¿ƒä¿¡æ¯ï¼Œé¿å…tokenè¶…é™
        const coreFieldsInfo = this.buildCoreFieldsInfo(enabledPanels, availableFields);

        // ğŸ”§ æ£€æµ‹æ¨¡æ¿å¤§å°ï¼Œå†³å®šå¤„ç†ç­–ç•¥
        const templateLength = userTemplate.length;
        console.log('[InfoBarSettings] ğŸ“ æ¨¡æ¿é•¿åº¦æ£€æµ‹:', templateLength, 'å­—ç¬¦');

        if (templateLength > 20000) {
            // è¶…å¤§æ¨¡æ¿ï¼šåªæä¾›ç»“æ„ä¼˜åŒ–å»ºè®®
            return `æ‚¨çš„HTMLæ¨¡æ¿è¿‡å¤§(${templateLength}å­—ç¬¦)ï¼Œæ— æ³•å®Œæ•´å¤„ç†ã€‚è¯·é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

## ğŸ¯ ç®€åŒ–å»ºè®®
1. ç§»é™¤å¤§é‡CSSæ ·å¼ï¼Œæ”¹ç”¨å¤–éƒ¨æ ·å¼è¡¨
2. åˆ é™¤å¤æ‚çš„JavaScriptä»£ç 
3. ç®€åŒ–HTMLç»“æ„ï¼Œä¸“æ³¨æ ¸å¿ƒå†…å®¹

## ğŸ“Š å¯ç”¨æ•°æ®å­—æ®µ
${coreFieldsInfo}

## ğŸ”§ æ•°æ®ç»‘å®šè¯­æ³•
- åŸºæœ¬ç»‘å®š: {{data.personal.name}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯åˆ—è¡¨: {{#each data.array}}{{this}}{{/each}}

è¯·æ‰‹åŠ¨ä¸ºå…³é”®å…ƒç´ æ·»åŠ æ•°æ®ç»‘å®šï¼Œç„¶åé‡æ–°ä½¿ç”¨AIä¼˜åŒ–ã€‚

## ğŸ“ æ¨¡æ¿ç‰‡æ®µç¤ºä¾‹
\`\`\`html
<div class="player-info">
    <h2><i class="fas fa-user"></i> {{data.personal.name}}</h2>
    {{#if data.personal.level}}
    <p>ç­‰çº§: {{data.personal.level}}</p>
    {{/if}}
</div>
\`\`\``;
        } else if (templateLength > 10000) {
            // å¤§æ¨¡æ¿ï¼šç²¾ç®€å¤„ç†
            const templatePreview = userTemplate.substring(0, 5000) + '\n\n[æ¨¡æ¿è¿‡é•¿ï¼Œå·²æˆªæ–­...]';
            return `ä¼˜åŒ–HTMLæ¨¡æ¿(ç®€åŒ–ç‰ˆï¼ŒåŸé•¿åº¦${templateLength}å­—ç¬¦)ï¼š

## ğŸ“Š æ•°æ®å­—æ®µ
${coreFieldsInfo}

## ğŸ”§ è¯­æ³•
- {{data.panel.field}} - æ•°æ®ç»‘å®š
- {{#if data.field}}{{/if}} - æ¡ä»¶æ˜¾ç¤º

## ğŸ“ ç”¨æˆ·æ¨¡æ¿(å‰5000å­—ç¬¦)
${templatePreview}

## è¦æ±‚
ä»…ä¸ºå…³é”®å…ƒç´ æ·»åŠ æ•°æ®ç»‘å®šï¼Œä¿æŒåŸç»“æ„ï¼Œæ·»åŠ å¿…è¦çš„Font Awesomeå›¾æ ‡ã€‚è¿”å›å®Œæ•´HTMLï¼š`;
        } else {
            // æ­£å¸¸å¤§å°æ¨¡æ¿ï¼šå®Œæ•´å¤„ç†
            return `ä¼˜åŒ–ä»¥ä¸‹HTMLæ¨¡æ¿ï¼Œæ·»åŠ æ•°æ®ç»‘å®šå’Œç°ä»£åŒ–æ ·å¼ï¼š

## å¯ç”¨æ•°æ®å­—æ®µ
${coreFieldsInfo}

## è¯­æ³•è§„åˆ™
- æ•°æ®ç»‘å®š: {{data.panelName.fieldName}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯æ•°ç»„: {{#each data.array}}{{this}}{{/each}}

## ç”¨æˆ·æ¨¡æ¿
${userTemplate}

## è¦æ±‚
1. ä¿æŒåŸæœ‰å¸ƒå±€ç»“æ„
2. æ·»åŠ æ‰€æœ‰å¯ç”¨æ•°æ®å­—æ®µçš„ç»‘å®š
3. ä½¿ç”¨ç°ä»£CSSæ ·å¼ï¼Œæ”¯æŒæ·±è‰²ä¸»é¢˜
4. æ·»åŠ é€‚å½“çš„Font Awesomeå›¾æ ‡
5. ç¡®ä¿å“åº”å¼è®¾è®¡
6. ä¸ºå¯é€‰æ•°æ®æ·»åŠ æ¡ä»¶åˆ¤æ–­

ç›´æ¥è¿”å›å®Œæ•´çš„HTMLä»£ç ï¼ŒåŒ…å«å†…è”CSSï¼š`;
        }
    }

    /**
     * ğŸ”§ æ„å»ºæ ¸å¿ƒæ•°æ®å­—æ®µä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œé¿å…tokenè¶…é™ï¼‰
     */
    buildCoreFieldsInfo(enabledPanels, availableFields) {
        let info = '';

        if (enabledPanels && typeof enabledPanels === 'object') {
            const panelCount = Object.keys(enabledPanels).length;
            info += `å¯ç”¨é¢æ¿(${panelCount}ä¸ª): `;

            const panelNames = Object.entries(enabledPanels)
                .slice(0, 8) // åªæ˜¾ç¤ºå‰8ä¸ªé¢æ¿ï¼Œé¿å…è¿‡é•¿
                .map(([panelId, config]) => `${panelId}`)
                .join(', ');

            info += panelNames;
            if (panelCount > 8) info += `, ...ç­‰${panelCount}ä¸ª`;
            info += '\n\n';
        }

        // ç®€åŒ–çš„å­—æ®µç¤ºä¾‹
        info += `æ•°æ®è®¿é—®ç¤ºä¾‹:\n`;
        info += `- è§’è‰²ä¿¡æ¯: {{data.personal.name}}, {{data.personal.age}}\n`;
        info += `- ç»Ÿè®¡æ•°æ®: {{data.stats.health}}, {{data.stats.level}}\n`;
        info += `- ç‰©å“é“å…·: {{data.inventory.items}}\n`;
        info += `- ä»»åŠ¡ä¿¡æ¯: {{data.tasks.current}}\n`;
        info += `- ä½ç½®ä¿¡æ¯: {{data.world.location}}\n`;

        return info;
    }

    /**
     * ğŸš€ æ„å»ºè¯¦ç»†çš„æ•°æ®å­—æ®µä¿¡æ¯
     */
    buildDetailedFieldsInfo(enabledPanels, availableFields) {
        let info = '';

        if (enabledPanels && typeof enabledPanels === 'object') {
            const panelCount = Object.keys(enabledPanels).length;
            info += `### å¯ç”¨çš„æ•°æ®é¢æ¿ (${panelCount}ä¸ª)ï¼š\n\n`;

            Object.entries(enabledPanels).forEach(([panelId, panelConfig]) => {
                const panelName = this.getPanelDisplayName(panelId);
                const fieldsCount = this.countEnabledFields(panelConfig);

                info += `#### ğŸ“Š ${panelName} (${panelId})\n`;
                info += `- çŠ¶æ€: ${panelConfig.enabled !== false ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}\n`;
                info += `- å­—æ®µæ•°é‡: ${fieldsCount}ä¸ª\n`;
                info += `- è®¿é—®è¯­æ³•: \`{{data.${panelId}.fieldName}}\`\n\n`;
            });
        }

        if (availableFields && typeof availableFields === 'object') {
            const totalFields = Object.keys(availableFields).length;
            info += `### å¯ç”¨æ•°æ®å­—æ®µ (${totalFields}ä¸ª)ï¼š\n\n`;

            Object.entries(availableFields).forEach(([panelId, fields]) => {
                if (fields && typeof fields === 'object') {
                    const fieldList = Object.keys(fields);
                    if (fieldList.length > 0) {
                        info += `#### ğŸ·ï¸ ${this.getPanelDisplayName(panelId)}é¢æ¿å­—æ®µ:\n`;
                        fieldList.forEach(field => {
                            const fieldValue = fields[field];
                            const fieldType = typeof fieldValue;
                            info += `- \`{{data.${panelId}.${field}}}\` (${fieldType}) - ç¤ºä¾‹: "${fieldValue}"\n`;
                        });
                        info += '\n';
                    }
                }
            });
        }

        return info || 'æš‚æ— å¯ç”¨çš„æ•°æ®å­—æ®µä¿¡æ¯';
    }

    /**
     * ğŸ¯ è·å–æ¨¡æ¿è¯­æ³•æŒ‡å—
     */
    getTemplateSyntaxGuide() {
        return `### åŸºç¡€è¯­æ³•ï¼š
- \`{{data.fieldName}}\` - è¾“å‡ºå­—æ®µå€¼
- \`{{#if data.field}}\`å†…å®¹\`{{/if}}\` - æ¡ä»¶æ¸²æŸ“
- \`{{#each data.array}}\`é¡¹ç›®å†…å®¹\`{{/each}}\` - å¾ªç¯æ¸²æŸ“
- \`{{#unless data.field}}\`å¤‡ç”¨å†…å®¹\`{{/unless}}\` - åå‘æ¡ä»¶

### é¢æ¿è®¿é—®ï¼š
- \`{{data.character.name}}\` - è§’è‰²é¢æ¿çš„nameå­—æ®µ
- \`{{data.stats.health}}\` - ç»Ÿè®¡é¢æ¿çš„healthå­—æ®µ
- \`{{data.inventory.items}}\` - ç‰©å“é¢æ¿çš„itemsæ•°ç»„

### é«˜çº§ç”¨æ³•ï¼š
- \`{{data.stats.health}}/{{data.stats.maxHealth}}\` - ç»„åˆæ˜¾ç¤º
- æ”¯æŒåµŒå¥—å¯¹è±¡å’Œæ•°ç»„è®¿é—®
- è‡ªåŠ¨å¤„ç†undefinedå’Œnullå€¼`;
    }

    /**
     * ğŸ’¡ è·å–æ•°æ®ç»‘å®šç¤ºä¾‹
     */
    getDataBindingExamples() {
        return `### åŸºç¡€æ•°æ®æ˜¾ç¤ºï¼š
\`\`\`html
<div class="character-info">
    <h3>{{data.character.name}}</h3>
    <p>ç­‰çº§: {{data.character.level}}</p>
</div>
\`\`\`

### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹ï¼š
\`\`\`html
{{#if data.stats.health}}
<div class="health-bar">
    <span>ç”Ÿå‘½å€¼: {{data.stats.health}}/{{data.stats.maxHealth}}</span>
    <div class="progress-bar">
        <div style="width: {{data.stats.healthPercent}}%"></div>
    </div>
</div>
{{/if}}
\`\`\`

### æ•°ç»„å¾ªç¯ç¤ºä¾‹ï¼š
\`\`\`html
{{#if data.inventory.items}}
<ul class="inventory-list">
    {{#each data.inventory.items}}
    <li class="item">
        <i class="fas fa-box"></i>
        <span>{{this.name}} (x{{this.quantity}})</span>
    </li>
    {{/each}}
</ul>
{{/if}}
\`\`\``;
    }

    /**
     * è°ƒç”¨è‡ªå®šä¹‰AI API
     */
    async callCustomAI(prompt) {
        try {
            // è·å–APIé…ç½®
            const apiConfig = this.getAPIConfig();

            if (!apiConfig.enabled) {
                throw new Error('AI APIæœªå¯ç”¨ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®API');
            }

            if (!apiConfig.apiKey) {
                throw new Error('APIå¯†é’¥æœªé…ç½®ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­æ·»åŠ APIå¯†é’¥');
            }

            if (!apiConfig.endpoint) {
                throw new Error('APIç«¯ç‚¹æœªé…ç½®ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®APIç«¯ç‚¹');
            }

            console.log('[InfoBarSettings] ğŸ¤– è°ƒç”¨è‡ªå®šä¹‰AI API...', {
                provider: apiConfig.provider,
                model: apiConfig.model,
                endpoint: apiConfig.endpoint,
                maxTokens: apiConfig.maxTokens,
                temperature: apiConfig.temperature,
                hasApiKey: !!apiConfig.apiKey
            });

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ç«¯ç‚¹æ­£ç¡®
            if (!apiConfig.endpoint) {
                console.error('[InfoBarSettings] âŒ APIç«¯ç‚¹ä¸ºç©º:', apiConfig);
                throw new Error('APIç«¯ç‚¹æœªé…ç½®ï¼Œè¯·æ£€æŸ¥æ‰©å±•è®¾ç½®');
            }

            let requestBody, headers;

            // æ ¹æ®ä¸åŒçš„APIæä¾›å•†æ„å»ºè¯·æ±‚
            if (apiConfig.provider === 'gemini') {
                headers = {
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiConfig.apiKey,
                    ...apiConfig.headers
                };
                requestBody = {
                    contents: [{
                        parts: [{
                            text: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HTMLæ¨¡æ¿å¼€å‘åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·è¦æ±‚ä¼˜åŒ–HTMLæ¨¡æ¿ï¼Œæ·»åŠ æ•°æ®ç»‘å®šã€‚\n\n${prompt}`
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: apiConfig.maxTokens || 20000, // ğŸ”§ é»˜è®¤20000ï¼Œä¸UIè¡¨å•ä¸€è‡´
                        temperature: apiConfig.temperature || 0.7, // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æ¸©åº¦
                        topP: 0.8,
                        topK: 20
                    }
                };
            } else {
                // ğŸ”§ ä¿®å¤ï¼šOpenAIæ ¼å¼ï¼Œä½¿ç”¨ç”¨æˆ·é…ç½®çš„å‚æ•°
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`,
                    ...apiConfig.headers
                };
                requestBody = {
                    model: apiConfig.model, // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„æ¨¡å‹
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HTMLæ¨¡æ¿å¼€å‘åŠ©æ‰‹ï¼Œä¸“æ³¨äºç”Ÿæˆé«˜è´¨é‡ã€è¯­ä¹‰åŒ–çš„HTMLä»£ç ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: apiConfig.maxTokens || 20000, // ğŸ”§ é»˜è®¤20000ï¼Œä¸UIè¡¨å•ä¸€è‡´
                    temperature: apiConfig.temperature || 0.7 // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æ¸©åº¦
                };

                // ğŸ”§ æ·»åŠ å…¶ä»–å¯é€‰å‚æ•°ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†ï¼‰
                if (apiConfig.topP !== undefined) {
                    requestBody.top_p = apiConfig.topP;
                }
                if (apiConfig.frequencyPenalty !== undefined) {
                    requestBody.frequency_penalty = apiConfig.frequencyPenalty;
                }
                if (apiConfig.presencePenalty !== undefined) {
                    requestBody.presence_penalty = apiConfig.presencePenalty;
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„AbortControllerä¸ä¸­æ­¢æŒ‰é’®æ‰“é€š
            const controller = this.currentAPIController || (this.currentAPIController = new AbortController());
            // ç»Ÿä¸€è¶…æ—¶å¥æŸ„ï¼Œä¾¿äºåœ¨finallyä¸­æ¸…ç†
            this.currentAPITimeoutId = setTimeout(() => {
                try { controller.abort(); } catch (e) { /* noop */ }
            }, 60000); // 60ç§’è¶…æ—¶

            // ç”Ÿæˆå¹¶é™„åŠ å¯è¿½è¸ªçš„è¯·æ±‚ID
            this.currentAPIRequestId = this.currentAPIRequestId || `ib_${Date.now()}_${Math.random().toString(36).slice(2)}`;
            this.lastRequestUrl = apiConfig.endpoint;

            let response;
            let retryCount = 0;
            const maxRetries = apiConfig.retryCount || 2;

            while (retryCount <= maxRetries) {
                // æ¯æ¬¡å°è¯•å‰å…ˆæ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
                if (this._customAPIAborted || controller.signal.aborted) {
                    const abortErr = new Error('ç”¨æˆ·å·²ä¸­æ­¢APIç”Ÿæˆ');
                    abortErr.name = 'AbortError';
                    abortErr.isUserAbort = true;
                    throw abortErr;
                }

                try {
                    console.log(`[InfoBarSettings] ğŸŒ å‘é€APIè¯·æ±‚ (å°è¯• ${retryCount + 1}/${maxRetries + 1})`);

                    // ä¸ºè¯·æ±‚å¤´é™„åŠ å¯è¿½è¸ªçš„Request-IDï¼Œä¾›æœåŠ¡ç«¯å–æ¶ˆ
                    try { if (headers && typeof headers === 'object') { headers['X-Request-ID'] = this.currentAPIRequestId; } } catch {}

                    response = await fetch(apiConfig.endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(this.currentAPITimeoutId);

                    if (response.ok) {
                        break; // æˆåŠŸï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                    } else if (response.status >= 500 && retryCount < maxRetries) {
                        // æœåŠ¡å™¨é”™è¯¯ï¼Œå¯ä»¥é‡è¯•
                        console.warn(`[InfoBarSettings] âš ï¸ æœåŠ¡å™¨é”™è¯¯ ${response.status}ï¼Œ${2 ** retryCount}ç§’åé‡è¯•...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** retryCount)));
                        retryCount++;
                        continue;
                    } else {
                        // å®¢æˆ·ç«¯é”™è¯¯æˆ–é‡è¯•æ¬¡æ•°ç”¨å®Œ
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    clearTimeout(this.currentAPITimeoutId);

                    if (error.name === 'AbortError') {
                        // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ­¢ï¼Œä¿ç•™AbortErrorå¹¶ä¸ŠæŠ›ç»™ä»»åŠ¡é˜Ÿåˆ—
                        if (this._customAPIAborted || controller.signal.aborted) {
                            error.isUserAbort = true;
                            throw error;
                        }
                        // å¦åˆ™æ˜¯è¶…æ—¶ç­‰ä¸­æ­¢
                        throw error;
                    } else if (retryCount < maxRetries && (error.message.includes('fetch') || error.message.includes('network'))) {
                        console.warn(`[InfoBarSettings] âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œ${2 ** retryCount}ç§’åé‡è¯•:`, error.message);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** retryCount)));
                        retryCount++;
                        continue;
                    } else {
                        throw error;
                    }
                }
            }

            const data = await response.json();

            // ğŸ”§ å¢åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­APIè¿”å›æ ¼å¼
            console.log('[InfoBarSettings] ğŸ“‹ APIè¿”å›æ•°æ®ç»“æ„:', JSON.stringify(data, null, 2));

            let result;
            if (apiConfig.provider === 'gemini') {
                // ğŸš€ å¢å¼ºGemini APIæ ¼å¼å¤„ç†
                try {
                    if (!data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
                        console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— candidates:', data);
                        throw new Error(`Gemini APIè¿”å›æ ¼å¼é”™è¯¯: æ— candidateså­—æ®µæˆ–ä¸ºç©ºæ•°ç»„`);
                    }

                    const candidate = data.candidates[0];
                    if (!candidate) {
                        console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— candidate:', candidate);
                        throw new Error('Gemini APIè¿”å›æ ¼å¼é”™è¯¯: candidateä¸ºç©º');
                    }

                    // ğŸš€ æ£€æŸ¥æ˜¯å¦å› ä¸ºMAX_TOKENSå¯¼è‡´å“åº”è¢«æˆªæ–­
                    if (candidate.finishReason === 'MAX_TOKENS') {
                        console.warn('[InfoBarSettings] âš ï¸ Geminiå“åº”è¢«æˆªæ–­ - MAX_TOKENSï¼Œå°è¯•æå–éƒ¨åˆ†å†…å®¹:', candidate);

                        // ğŸ”§ å°è¯•è·å–æˆªæ–­å‰çš„éƒ¨åˆ†å†…å®¹
                        let partialContent = '';
                        if (candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                            const part = candidate.content.parts[0];
                            if (part && typeof part.text === 'string') {
                                partialContent = part.text.trim();
                            }
                        }

                        if (partialContent) {
                            console.log('[InfoBarSettings] ğŸ”„ è·å–åˆ°éƒ¨åˆ†å†…å®¹ï¼Œé•¿åº¦:', partialContent.length);

                            // ğŸ¯ æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„HTMLå†…å®¹
                            if (partialContent.includes('<html') || partialContent.includes('<!DOCTYPE') || partialContent.includes('<div')) {
                                console.log('[InfoBarSettings] âœ… æ£€æµ‹åˆ°æœ‰æ•ˆHTMLå†…å®¹ï¼Œä½¿ç”¨éƒ¨åˆ†ç»“æœ');
                                result = partialContent + '\n\n<!-- âš ï¸ å†…å®¹è¢«æˆªæ–­ï¼Œå»ºè®®ç®€åŒ–æ¨¡æ¿åé‡æ–°ç”Ÿæˆ -->';
                            } else {
                                // å¦‚æœä¸æ˜¯HTMLå†…å®¹ï¼Œè¿”å›å»ºè®®
                                result = partialContent + '\n\nâš ï¸ AIå»ºè®®ï¼šæ‚¨çš„æ¨¡æ¿è¿‡å¤§ï¼Œè¯·æŒ‰ç…§ä¸Šè¿°å»ºè®®ç®€åŒ–åé‡æ–°å°è¯•ã€‚';
                            }
                        } else {
                            throw new Error('AIå“åº”è¢«æˆªæ–­ä¸”æ— å¯ç”¨å†…å®¹ï¼Œè¯·å¤§å¹…ç®€åŒ–HTMLæ¨¡æ¿æˆ–å‡å°‘æç¤ºè¯é•¿åº¦ã€‚');
                        }
                    }

                    // ğŸ”§ å¦‚æœä¸æ˜¯MAX_TOKENSæˆªæ–­ï¼Œè¿›è¡Œæ­£å¸¸å†…å®¹å¤„ç†
                    if (candidate.finishReason !== 'MAX_TOKENS') {
                        if (!candidate.content) {
                            console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— content:', candidate);
                            throw new Error('Gemini APIè¿”å›æ ¼å¼é”™è¯¯: candidateæ— contentå­—æ®µ');
                        }

                        // ğŸ”§ å¤„ç†ä¸åŒçš„contentæ ¼å¼
                        let textContent = '';

                        if (candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                            // æ ‡å‡†æ ¼å¼ï¼šæœ‰partsæ•°ç»„
                            const part = candidate.content.parts[0];
                            if (part && typeof part.text === 'string') {
                                textContent = part.text.trim();
                            }
                        } else if (candidate.content.text && typeof candidate.content.text === 'string') {
                            // å¤‡ç”¨æ ¼å¼ï¼šç›´æ¥åŒ…å«textå­—æ®µ
                            textContent = candidate.content.text.trim();
                        } else if (typeof candidate.content === 'string') {
                            // å¤‡ç”¨æ ¼å¼ï¼šcontentç›´æ¥æ˜¯å­—ç¬¦ä¸²
                            textContent = candidate.content.trim();
                        }

                        if (!textContent) {
                            console.error('[InfoBarSettings] âŒ Geminiè¿”å›å†…å®¹ä¸ºç©º:', candidate.content);
                            throw new Error('Gemini APIè¿”å›çš„å†…å®¹ä¸ºç©ºï¼Œå¯èƒ½æ˜¯å› ä¸ºæç¤ºè¯å¤ªé•¿æˆ–å…¶ä»–APIé™åˆ¶');
                        }

                        result = textContent;
                        console.log('[InfoBarSettings] âœ… æˆåŠŸè§£æGeminiè¿”å›å†…å®¹ï¼Œé•¿åº¦:', result.length);
                    }

                } catch (parseError) {
                    console.error('[InfoBarSettings] âŒ è§£æGeminiè¿”å›å†…å®¹å¤±è´¥:', parseError);
                    console.error('[InfoBarSettings] ğŸ“‹ åŸå§‹è¿”å›æ•°æ®:', data);

                    // ğŸ”§ å°è¯•å…¶ä»–å¯èƒ½çš„æ ¼å¼
                    if (data.text) {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ç›´æ¥ä½¿ç”¨data.text');
                        result = data.text.trim();
                    } else if (data.content && typeof data.content === 'string') {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ä½¿ç”¨data.content');
                        result = data.content.trim();
                    } else if (typeof data === 'string') {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ç›´æ¥ä½¿ç”¨dataå­—ç¬¦ä¸²');
                        result = data.trim();
                    } else {
                        throw parseError;
                    }
                }
            } else {
                // OpenAIæ ¼å¼
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('AI APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                result = data.choices[0].message.content.trim();
            }

            // æ¸…ç†è¿”å›çš„ä»£ç 
            return this.cleanAIResponse(result);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è‡ªå®šä¹‰AI APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è·å–APIé…ç½®
     */
    getAPIConfig() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è·å–æ‰©å±•è®¾ç½®
            let apiConfig = {};

            // æ–¹æ³•1ï¼šä»å…¨å±€æ‰©å±•è®¾ç½®è·å–
            if (window.extension_settings && window.extension_settings['Information bar integration tool']) {
                apiConfig = window.extension_settings['Information bar integration tool'].apiConfig || {};
            }
            // æ–¹æ³•2ï¼šä»SillyTavernä¸Šä¸‹æ–‡è·å–ï¼ˆå¤‡ç”¨ï¼‰
            else if (typeof SillyTavern !== 'undefined' && SillyTavern.getContext) {
                const context = SillyTavern.getContext();
                const extensionSettings = context?.extensionSettings || {};
                const configs = extensionSettings['Information bar integration tool'] || {};
                apiConfig = configs.apiConfig || {};
            }
            // æ–¹æ³•3ï¼šä»æœ¬åœ°å­˜å‚¨è·å–ï¼ˆæœ€åå¤‡ç”¨ï¼‰
            else {
                try {
                    const stored = localStorage.getItem('InfoBarSettings_apiConfig');
                    if (stored) {
                        apiConfig = JSON.parse(stored);
                    }
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ ä»æœ¬åœ°å­˜å‚¨è·å–APIé…ç½®å¤±è´¥:', e);
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š è·å–APIé…ç½®:', {
                enabled: apiConfig.enabled,
                provider: apiConfig.provider,
                model: apiConfig.model,
                maxTokens: apiConfig.maxTokens,
                temperature: apiConfig.temperature,
                hasApiKey: !!apiConfig.apiKey,
                endpoint: apiConfig.endpoint,
                baseUrl: apiConfig.baseUrl, // ğŸ”§ æ·»åŠ baseUrlè°ƒè¯•
                rawEndpoint: apiConfig.endpoint
            });

            // ğŸ”§ ä¿®å¤ï¼šæ„å»ºæ­£ç¡®çš„ç«¯ç‚¹URLï¼Œæ”¯æŒbaseUrlå’Œendpoint
            let endpoint = apiConfig.endpoint || apiConfig.baseUrl;

            // ğŸ”§ ä¿®å¤ï¼šå¯¹äºè‡ªå®šä¹‰providerï¼Œå¤„ç†baseUrlå’Œendpoint
            if (apiConfig.provider === 'custom') {
                if (!endpoint) {
                    console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰APIæä¾›å•†æœªé…ç½®ç«¯ç‚¹ï¼Œå°†åœ¨è°ƒç”¨æ—¶æ£€æŸ¥');
                    // ä¸åœ¨è¿™é‡ŒæŠ›é”™ï¼Œè€Œæ˜¯åœ¨å®é™…è°ƒç”¨æ—¶æ£€æŸ¥
                } else {
                    // ğŸ”§ ä¿®å¤ï¼šæ„å»ºå®Œæ•´çš„chat completionsç«¯ç‚¹
                    if (!endpoint.includes('/chat/completions')) {
                        // å¦‚æœæ˜¯baseUrlæ ¼å¼ï¼Œæ·»åŠ chat/completionsè·¯å¾„
                        if (endpoint.endsWith('/v1') || endpoint.endsWith('/v1/')) {
                            endpoint = endpoint.replace(/\/v1\/?$/, '/v1/chat/completions');
                        } else if (endpoint.includes('/models')) {
                            endpoint = endpoint.replace('/models', '/chat/completions');
                        } else if (!endpoint.includes('/chat/completions')) {
                            // å¦‚æœæ²¡æœ‰å…·ä½“è·¯å¾„ï¼Œæ·»åŠ é»˜è®¤è·¯å¾„
                            endpoint = endpoint.replace(/\/$/, '') + '/chat/completions';
                        }
                        console.log('[InfoBarSettings] ğŸ”§ æ„å»ºå®Œæ•´ç«¯ç‚¹:', endpoint);
                    }
                }
            } else if (apiConfig.provider === 'gemini') {
                // ğŸ”§ ä¿®å¤ï¼šGeminiéœ€è¦ç‰¹æ®Šçš„ç«¯ç‚¹æ ¼å¼
                const model = apiConfig.model || 'gemini-pro';
                if (!endpoint || endpoint === 'https://generativelanguage.googleapis.com' || !endpoint.includes(':generateContent')) {
                    endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                    console.log('[InfoBarSettings] ğŸ”§ æ„å»ºGeminiç«¯ç‚¹:', endpoint);
                }
            } else if (!endpoint) {
                try {
                    endpoint = this.getDefaultEndpoint(apiConfig.provider);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ è·å–é»˜è®¤ç«¯ç‚¹å¤±è´¥:', e.message);
                    endpoint = ''; // è®¾ä¸ºç©ºï¼Œåœ¨è°ƒç”¨æ—¶å†æ£€æŸ¥
                }
            }

            return {
                enabled: apiConfig.enabled || false,
                endpoint: endpoint,
                apiKey: apiConfig.apiKey || '',
                model: apiConfig.model || 'gpt-3.5-turbo',
                provider: apiConfig.provider || 'openai',
                headers: apiConfig.headers || {},
                // ğŸ”§ æ·»åŠ ç¼ºå¤±çš„é…ç½®å­—æ®µ
                maxTokens: apiConfig.maxTokens || 20000, // é»˜è®¤20000ï¼Œä¸UIè¡¨å•ä¸€è‡´
                temperature: apiConfig.temperature || 0.7,
                retryCount: apiConfig.retryCount || 3,
                format: apiConfig.format || 'native'
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–APIé…ç½®å¤±è´¥:', error);
            console.error('[InfoBarSettings] é”™è¯¯å †æ ˆ:', error.stack);
            console.error('[InfoBarSettings] é”™è¯¯å‘ç”Ÿä½ç½®ï¼ŒåŸå§‹é…ç½®:', {
                hasExtensionSettings: !!window.extension_settings,
                hasInfoBarConfig: !!(window.extension_settings && window.extension_settings['Information bar integration tool']),
                hasSillyTavern: typeof SillyTavern !== 'undefined'
            });
            return { enabled: false };
        }
    }

    /**
     * è·å–é»˜è®¤APIç«¯ç‚¹
     */
    getDefaultEndpoint(provider) {
        const endpoints = {
            openai: 'https://api.openai.com/v1/chat/completions',
            anthropic: 'https://api.anthropic.com/v1/messages',
            gemini: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤customçš„é»˜è®¤ç«¯ç‚¹ï¼Œcustomå¿…é¡»ç”±ç”¨æˆ·é…ç½®
        };

        // ğŸ”§ ä¿®å¤ï¼šcustom providerè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸æŠ›é”™
        if (provider === 'custom') {
            console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰provideréœ€è¦ç”¨æˆ·é…ç½®ç«¯ç‚¹');
            return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯æŠ›é”™
        }

        return endpoints[provider] || endpoints.openai;
    }

    /**
     * ğŸš€ å¢å¼ºçš„AIå“åº”æ¸…ç†
     */
    cleanAIResponse(response) {
        if (!response || typeof response !== 'string') {
            console.warn('[InfoBarSettings] âš ï¸ AIå“åº”ä¸ºç©ºæˆ–éå­—ç¬¦ä¸²:', typeof response);
            return '';
        }

        console.log('[InfoBarSettings] ğŸ§¹ å¼€å§‹æ¸…ç†AIå“åº”ï¼ŒåŸé•¿åº¦:', response.length);

        let cleaned = response;

        // ğŸ”§ ç§»é™¤å„ç§ä»£ç å—æ ‡è®°
        cleaned = cleaned.replace(/```html\s*\n?/gi, '');
        cleaned = cleaned.replace(/```css\s*\n?/gi, '');
        cleaned = cleaned.replace(/```javascript\s*\n?/gi, '');
        cleaned = cleaned.replace(/```js\s*\n?/gi, '');
        cleaned = cleaned.replace(/```\s*\n?/g, '');

        // ğŸ”§ ç§»é™¤å¯èƒ½çš„markdownæ ¼å¼
        cleaned = cleaned.replace(/^#+\s+.*$/gm, ''); // ç§»é™¤æ ‡é¢˜
        cleaned = cleaned.replace(/^\*\*.*\*\*$/gm, ''); // ç§»é™¤ç²—ä½“è¡Œ
        cleaned = cleaned.replace(/^[-*]\s+.*$/gm, ''); // ç§»é™¤åˆ—è¡¨é¡¹

        // ğŸ”§ ç§»é™¤AIå¯èƒ½æ·»åŠ çš„è¯´æ˜æ–‡å­—
        const removePatterns = [
            /^(è¿™é‡Œæ˜¯|ä»¥ä¸‹æ˜¯|è¿™æ˜¯ä¸€ä¸ª|ä¿®æ”¹åçš„|ä¼˜åŒ–åçš„).*HTML.*$/gim,
            /^.*å®Œæ•´.*HTML.*ä»£ç .*$/gim,
            /^.*ä¿®æ”¹.*æ¨¡æ¿.*$/gim,
            /^.*ä¼˜åŒ–.*å»ºè®®.*$/gim,
            /^.*æ³¨æ„äº‹é¡¹.*$/gim,
            /^.*è¯´æ˜.*$/gim,
            /^.*è§£é‡Š.*$/gim
        ];

        removePatterns.forEach(pattern => {
            cleaned = cleaned.replace(pattern, '');
        });

        // ğŸ”§ æŸ¥æ‰¾å¹¶æå–HTMLå†…å®¹
        const htmlMatch = cleaned.match(/<[^>]+>/);
        if (htmlMatch) {
            // æ‰¾åˆ°HTMLæ ‡ç­¾çš„èµ·å§‹ä½ç½®
            const htmlStart = cleaned.indexOf(htmlMatch[0]);
            if (htmlStart > 0) {
                // ç§»é™¤HTMLä¹‹å‰çš„æ‰€æœ‰è¯´æ˜æ–‡å­—
                cleaned = cleaned.substring(htmlStart);
                console.log('[InfoBarSettings] âœ‚ï¸ ç§»é™¤äº†HTMLä¹‹å‰çš„è¯´æ˜æ–‡å­—');
            }
        }

        // ğŸ”§ ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
        cleaned = cleaned.replace(/\n\s*\n\s*\n+/g, '\n\n');
        cleaned = cleaned.replace(/^\s*\n+/g, ''); // ç§»é™¤å¼€å¤´ç©ºè¡Œ
        cleaned = cleaned.replace(/\n+\s*$/g, ''); // ç§»é™¤ç»“å°¾ç©ºè¡Œ

        // ğŸ”§ åŸºæœ¬HTMLéªŒè¯
        const result = cleaned.trim();

        if (!result) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†åAIå“åº”ä¸ºç©º');
            throw new Error('AIè¿”å›çš„å†…å®¹æ¸…ç†åä¸ºç©º');
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«åŸºæœ¬HTMLç»“æ„
        const hasHTMLTags = /<[^>]+>/.test(result);
        if (!hasHTMLTags) {
            console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†åçš„å†…å®¹å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„HTML');
        }

        console.log('[InfoBarSettings] âœ… AIå“åº”æ¸…ç†å®Œæˆï¼Œæœ€ç»ˆé•¿åº¦:', result.length);
        console.log('[InfoBarSettings] ğŸ“‹ æ¸…ç†åå†…å®¹é¢„è§ˆ:', result.substring(0, 200) + '...');

        return result;
    }

    /**
     * ğŸ”§ åˆ é™¤ï¼šé‡å¤çš„getEnabledPanelsæ–¹æ³•å·²åˆ é™¤
     * åŸå› ï¼šè¯¥æ–¹æ³•ä¸ç¬¬ä¸€ä¸ªgetEnabledPanelsæ–¹æ³•é‡å¤ï¼Œä¸”è¿”å›é”™è¯¯çš„é¢æ¿ID
     * ä¿®å¤ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªæ­£ç¡®çš„getEnabledPanelsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨æ ‡å‡†é¢æ¿ID
     */

    /**
     * è·å–å½“å‰æ•°æ®å­—æ®µ
     */
    async getCurrentDataFields() {
        try {
            // ä»ç»Ÿä¸€æ•°æ®æ ¸å¿ƒè·å–å½“å‰æ•°æ®ç»“æ„
            const infoBarTool = window.SillyTavernInfobar?.modules?.infoBarTool;
            if (infoBarTool && infoBarTool.dataCore) {
                // ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•è·å–æ‰€æœ‰é¢æ¿æ•°æ®
                const allPanelData = await infoBarTool.dataCore.getAllPanelData();
                if (allPanelData && Object.keys(allPanelData).length > 0) {
                    const fields = {};
                    Object.entries(allPanelData).forEach(([panelId, panelData]) => {
                        fields[panelId] = Object.keys(panelData || {});
                    });
                    return fields;
                }

                // å°è¯•è·å–èŠå¤©æ•°æ®
                const chatData = await infoBarTool.dataCore.getAllData('chat');
                if (chatData) {
                    const fields = {};
                    // æŸ¥æ‰¾é¢æ¿æ•°æ®
                    Object.entries(chatData).forEach(([key, value]) => {
                        if (key.startsWith('panels.') && value) {
                            const panelId = key.split('.').pop();
                            fields[panelId] = Object.keys(value);
                        }
                    });
                    if (Object.keys(fields).length > 0) {
                        return fields;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰å®é™…æ•°æ®ï¼Œè¿”å›ç¤ºä¾‹å­—æ®µ
            return {
                character: ['name', 'class', 'level', 'health', 'maxHealth', 'energy', 'maxEnergy'],
                status: ['location', 'mood', 'time', 'weather'],
                inventory: ['items', 'gold', 'gems'],
                skills: ['skills', 'experience']
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ•°æ®å­—æ®µå¤±è´¥:', error);
            // è¿”å›ç¤ºä¾‹å­—æ®µä½œä¸ºå›é€€
            return {
                character: ['name', 'class', 'level', 'health', 'maxHealth', 'energy', 'maxEnergy'],
                status: ['location', 'mood', 'time', 'weather'],
                inventory: ['items', 'gold', 'gems'],
                skills: ['skills', 'experience']
            };
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½é«˜çº§æ•°æ®ä¿¡æ¯
     */
    loadAdvancedDataInfo() {
        try {
            // åŠ è½½å½“å‰å¯ç”¨çš„é¢æ¿
            this.loadEnabledPanelsList();

            // åŠ è½½å¯ç”¨å­—æ®µ
            this.loadAvailableFieldsList();

            // ç»‘å®šå¿«é€Ÿæ’å…¥æŒ‰é’®äº‹ä»¶
            this.bindQuickInsertEvents();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é«˜çº§æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½å½“å‰å¯ç”¨çš„é¢æ¿åˆ—è¡¨
     */
    async loadEnabledPanelsList() {
        try {
            const panelsList = document.querySelector('#enabled-panels-list');
            if (!panelsList) return;

            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½å¯ç”¨çš„é¢æ¿åˆ—è¡¨...');

            // è·å–å½“å‰å¯ç”¨çš„é¢æ¿
            const enabledPanels = this.getEnabledPanels(); // ç§»é™¤awaitï¼Œå› ä¸ºè¿™æ˜¯åŒæ­¥æ–¹æ³•

            if (enabledPanels && Object.keys(enabledPanels).length > 0) {
                const themeColors = {
                    text: this.getInfoBarThemeColor('text'),
                    textSecondary: this.getInfoBarThemeColor('textSecondary'),
                    accent: this.getInfoBarThemeColor('accent'),
                    background: this.getInfoBarThemeColor('background'),
                    border: this.getInfoBarThemeColor('border')
                };

                // ğŸ”§ ä¿®å¤ï¼šå°†é¢æ¿å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„è¿›è¡Œå¤„ç†
                const panelsHTML = Object.entries(enabledPanels).map(([panelId, panelConfig]) => `
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 6px 8px;
                        margin-bottom: 4px;
                        background: ${themeColors.background};
                        border: 1px solid ${themeColors.border};
                        border-radius: 3px;
                        color: ${themeColors.text};
                        font-size: 11px;
                    ">
                        <i class="${this.getPanelIcon(panelId)}" style="
                            color: ${themeColors.accent};
                            margin-right: 6px;
                            font-size: 10px;
                        "></i>
                        <span style="flex-grow: 1;">${this.getPanelDisplayName(panelId)}</span>
                        <span style="
                            color: ${themeColors.textSecondary};
                            font-size: 9px;
                        ">${this.countEnabledFields(panelConfig)}ä¸ªå­—æ®µ</span>
                    </div>
                `).join('');

                panelsList.innerHTML = panelsHTML;
            } else {
                panelsList.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        color: ${this.getInfoBarThemeColor('textSecondary')};
                        font-size: 11px;
                    ">
                        <i class="fas fa-info-circle" style="margin-bottom: 8px; display: block; font-size: 16px;"></i>
                        æš‚æ— å¯ç”¨çš„æ•°æ®é¢æ¿<br>
                        <small style="font-size: 9px;">è¯·å…ˆåœ¨é¢æ¿ç®¡ç†ä¸­å¯ç”¨æ•°æ®é¢æ¿</small>
                    </div>
                `;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å¯ç”¨é¢æ¿åˆ—è¡¨å¤±è´¥:', error);
            const panelsList = document.querySelector('#enabled-panels-list');
            if (panelsList) {
                panelsList.innerHTML = `
                    <div style="color: #FF5722; font-size: 11px; text-align: center; padding: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè®¡ç®—é¢æ¿ä¸­å¯ç”¨çš„å­—æ®µæ•°é‡
     */
    countEnabledFields(panelConfig) {
        if (!panelConfig || typeof panelConfig !== 'object') return 0;

        let count = 0;
        // è®¡ç®—åŸºæœ¬å­—æ®µ
        Object.entries(panelConfig).forEach(([key, value]) => {
            if (key !== 'enabled' && key !== 'name' && key !== 'subItems' && value && value.enabled !== false) {
                count++;
            }
        });

        // è®¡ç®—å­é¡¹
        if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
            count += panelConfig.subItems.filter(item => item.enabled).length;
        }

        return count;
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–é¢æ¿å›¾æ ‡
     */
    getPanelIcon(panelId) {
        const iconMap = {
            'character': 'fas fa-user',
            'stats': 'fas fa-chart-bar',
            'inventory': 'fas fa-box',
            'location': 'fas fa-map-marker-alt',
            'relationship': 'fas fa-heart',
            'story': 'fas fa-book',
            'custom': 'fas fa-layer-group',
            'custom1': 'fas fa-cube',
            'custom2': 'fas fa-puzzle-piece',
            'custom3': 'fas fa-star'
        };

        // æ£€æŸ¥panelIdæ˜¯å¦åŒ¹é…è‡ªå®šä¹‰é¢æ¿æ ¼å¼
        if (panelId && panelId.toLowerCase().startsWith('custom')) {
            if (panelId === 'custom') return iconMap['custom'];
            // å¤„ç† custom_xxxxx æ ¼å¼
            if (panelId.includes('_')) {
                return iconMap['custom'];
            }
            // å¤„ç† Custom1, Custom2 ç­‰æ ¼å¼
            const customMatch = panelId.match(/^custom(\d+)$/i);
            if (customMatch) {
                const num = parseInt(customMatch[1]);
                return iconMap[`custom${Math.min(num, 3)}`] || iconMap['custom'];
            }
        }

        return iconMap[panelId] || 'fas fa-layer-group';
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨
     */
    async loadAvailableFieldsList() {
        try {
            const fieldsList = document.querySelector('#available-fields-list');
            if (!fieldsList) return;

            console.log('[InfoBarSettings] ğŸ·ï¸ åŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨...');

            // è·å–å½“å‰æ•°æ®å­—æ®µ
            const dataFields = await this.getCurrentDataFields();

            if (dataFields && Object.keys(dataFields).length > 0) {
                const themeColors = {
                    text: this.getInfoBarThemeColor('text'),
                    textSecondary: this.getInfoBarThemeColor('textSecondary'),
                    accent: this.getInfoBarThemeColor('accent'),
                    background: this.getInfoBarThemeColor('background'),
                    border: this.getInfoBarThemeColor('border')
                };

                let fieldsHTML = '';

                Object.entries(dataFields).forEach(([panelId, fields]) => {
                    if (fields && fields.length > 0) {
                        fieldsHTML += `
                            <div style="margin-bottom: 12px;">
                                <div style="
                                    font-weight: 600;
                                    color: ${themeColors.accent};
                                    font-size: 11px;
                                    margin-bottom: 6px;
                                    padding-bottom: 3px;
                                    border-bottom: 1px solid ${themeColors.border};
                                ">
                                    ${this.getPanelDisplayName(panelId)}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                        `;

                        fields.forEach(field => {
                            fieldsHTML += `
                                <button class="field-insert-btn"
                                        data-insert="{{data.${field}}}"
                                        style="
                                    padding: 2px 6px;
                                    background: transparent;
                                    border: 1px solid ${themeColors.border};
                                    color: ${themeColors.text};
                                    border-radius: 2px;
                                    cursor: pointer;
                                    font-size: 9px;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='${themeColors.accent}'; this.style.color='${themeColors.background}'"
                                   onmouseout="this.style.background='transparent'; this.style.color='${themeColors.text}'">
                                    ${field}
                                </button>
                            `;
                        });

                        fieldsHTML += `
                                </div>
                            </div>
                        `;
                    }
                });

                fieldsList.innerHTML = fieldsHTML;

                // ç»‘å®šå­—æ®µæ’å…¥æŒ‰é’®äº‹ä»¶
                fieldsList.querySelectorAll('.field-insert-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.insertTemplateText(btn.dataset.insert);
                    });
                });

            } else {
                fieldsList.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        color: ${this.getInfoBarThemeColor('textSecondary')};
                        font-size: 11px;
                    ">
                        <i class="fas fa-database" style="margin-bottom: 8px; display: block; font-size: 16px;"></i>
                        æš‚æ— å¯ç”¨æ•°æ®å­—æ®µ<br>
                        <small style="font-size: 9px;">è¯·å…ˆå‘é€AIæ¶ˆæ¯ç”Ÿæˆæ•°æ®</small>
                    </div>
                `;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨å¤±è´¥:', error);
            const fieldsList = document.querySelector('#available-fields-list');
            if (fieldsList) {
                fieldsList.innerHTML = `
                    <div style="color: #FF5722; font-size: 11px; text-align: center; padding: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šè·å–é¢æ¿æ˜¾ç¤ºåç§°
     */
    getPanelDisplayName(panelId) {
        const panelNames = {
            character: 'ğŸ§™â€â™‚ï¸ è§’è‰²ä¿¡æ¯',
            status: 'ğŸ’– çŠ¶æ€æ˜¾ç¤º',
            inventory: 'ğŸ’ ç‰©å“èƒŒåŒ…',
            skills: 'âš¡ æŠ€èƒ½èƒ½åŠ›',
            world: 'ğŸŒ ä¸–ç•Œä¿¡æ¯',
            tasks: 'ğŸ“‹ ä»»åŠ¡ç®¡ç†',
            relationships: 'ğŸ‘¥ äººé™…å…³ç³»',
            lore: 'ğŸ“š ä¼ è¯´å…¸æ•…',
            combat: 'âš”ï¸ æˆ˜æ–—çŠ¶æ€',
            progress: 'ğŸ“ˆ è¿›åº¦è¿½è¸ª'
        };

        return panelNames[panelId] || `ğŸ“Š ${panelId}`;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šç»‘å®šå¿«é€Ÿæ’å…¥äº‹ä»¶
     */
    bindQuickInsertEvents() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // é‡æ–°ç»‘å®šå¿«é€Ÿæ’å…¥æŒ‰é’®
            modal.querySelectorAll('.quick-insert-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.insertTemplateText(btn.dataset.insert);
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šå¿«é€Ÿæ’å…¥äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–è¯­æ³•é«˜äº®
     */
    initSyntaxHighlight() {
        try {
            // ç®€å•çš„è¯­æ³•é«˜äº®å®ç°
            console.log('[InfoBarSettings] ğŸ¨ è¯­æ³•é«˜äº®åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è¯­æ³•é«˜äº®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆ‡æ¢è‡ªåŠ¨æ¢è¡Œ
     */
    toggleWordWrap() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const isWrapped = textarea.style.whiteSpace === 'pre-wrap';
            textarea.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
            textarea.style.overflowWrap = isWrapped ? 'normal' : 'break-word';

            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨æ¢è¡Œå·²', isWrapped ? 'å…³é—­' : 'å¼€å¯');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢è‡ªåŠ¨æ¢è¡Œå¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šå¤„ç†ç¼–è¾‘å™¨é”®ç›˜äº‹ä»¶
     */
    handleEditorKeydown(e) {
        try {
            // Ctrl+S ä¿å­˜
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                this.saveHTMLTemplate();
                return;
            }

            // Ctrl+Shift+F æ ¼å¼åŒ–
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                this.formatTemplate();
                return;
            }

            // Tab é”®æ’å…¥ç©ºæ ¼
            if (e.key === 'Tab') {
                e.preventDefault();
                const textarea = e.target;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;

                textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + 2;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é”®ç›˜äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šè°ƒæ•´ç¼–è¾‘å™¨å¸ƒå±€
     */
    adjustEditorLayout() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // å“åº”å¼å¸ƒå±€è°ƒæ•´é€»è¾‘
            const container = modal.querySelector('.html-template-editor-container');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (windowWidth < 1200) {
                // å°å±å¹•ä¼˜åŒ–
                container.style.minWidth = '90vw';
                container.style.maxWidth = '95vw';
            } else {
                // æ¢å¤æ­£å¸¸å°ºå¯¸
                container.style.minWidth = '800px';
                container.style.maxWidth = '1600px';
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è°ƒæ•´ç¼–è¾‘å™¨å¸ƒå±€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šç»‘å®šè¯­æ³•å¸®åŠ©äº‹ä»¶
     */
    bindSyntaxHelpEvents() {
        try {
            // è¯­æ³•å¸®åŠ©ç›¸å…³äº‹ä»¶ç»‘å®š
            console.log('[InfoBarSettings] âœ… è¯­æ³•å¸®åŠ©äº‹ä»¶ç»‘å®šå®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šè¯­æ³•å¸®åŠ©äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½æ¨¡æ¿åº“
     */
    loadTemplateLibrary() {
        try {
            // æ¨¡æ¿åº“åŠ è½½é€»è¾‘
            console.log('[InfoBarSettings] âœ… æ¨¡æ¿åº“åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ¨¡æ¿åº“å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆ›å»ºæ¨¡æ¿åº“ä¿¡æ¯
     */
    createTemplateLibraryInfo() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="template-library-info">
                <div class="template-categories">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-layer-group"></i> æ¨¡æ¿åˆ†ç±»
                    </h4>
                    <div style="color: ${themeColors.textSecondary}; font-size: 11px;">
                        æ¨¡æ¿åº“åŠŸèƒ½å¼€å‘ä¸­...
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ å¤„ç†AIåˆ›ä½œçŠ¶æ€æ 
     */
    async handleAICreateStatusBar() {
        try {
            console.log('[InfoBarSettings] ğŸ¤– å¼€å§‹AIåˆ›ä½œçŠ¶æ€æ ...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const aiButton = modal?.querySelector('[data-action="ai-create-status-bar"]');

            if (!aiButton) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = aiButton.innerHTML;
            aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIåˆ›ä½œä¸­...';
            aiButton.disabled = true;

            try {
                // è·å–å½“å‰å¯ç”¨çš„é¢æ¿å’Œæ•°æ®è·å–æ–¹å¼
                const enabledPanels = await this.getEnabledPanelsForAI();
                const dataAccessMethods = await this.generateDataAccessMethods(enabledPanels);

                // æ„å»ºAIåˆ›ä½œæç¤ºè¯
                const prompt = this.buildAICreateStatusBarPrompt(enabledPanels, dataAccessMethods);

                // è°ƒç”¨AIç”ŸæˆçŠ¶æ€æ 
                const generatedStatusBar = await this.callAIForStatusBarCreation(prompt);

                // å°†ç”Ÿæˆçš„çŠ¶æ€æ æ’å…¥åˆ°ç¼–è¾‘å™¨
                const textarea = modal?.querySelector('.html-template-textarea');
                if (textarea && generatedStatusBar) {
                    textarea.value = generatedStatusBar;

                    // æ›´æ–°é¢„è§ˆ
                    this.updateTemplatePreview();
                    this.updateEditorStatus();

                    console.log('[InfoBarSettings] âœ… AIçŠ¶æ€æ åˆ›ä½œå®Œæˆ');
                    this.showNotification('AIçŠ¶æ€æ åˆ›ä½œå®Œæˆï¼', 'success');
                }

            } catch (error) {
                console.error('[InfoBarSettings] âŒ AIåˆ›ä½œçŠ¶æ€æ å¤±è´¥:', error);
                this.showNotification(`AIåˆ›ä½œå¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                aiButton.innerHTML = originalText;
                aiButton.disabled = false;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIåˆ›ä½œçŠ¶æ€æ å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯ï¼ˆç”¨äºAIï¼‰
     */
    async getEnabledPanelsForAI() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š è·å–å¯ç”¨é¢æ¿ä¿¡æ¯...');

            // ä½¿ç”¨SmartPromptSystemçš„æ–¹æ³•è·å–å¯ç”¨é¢æ¿
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (smartPromptSystem && typeof smartPromptSystem.getEnabledPanels === 'function') {
                const panels = await smartPromptSystem.getEnabledPanels();
                const enabledPanels = panels.map(panel => ({
                    id: panel.id,
                    name: panel.name || this.getPanelDisplayName(panel.id),
                    config: panel,
                    subItems: (panel.subItems || []).map(subItem => ({
                        key: subItem.key,
                        name: subItem.name || this.getSubItemDisplayName(panel.id, subItem.key),
                        config: subItem
                    }))
                }));

                console.log('[InfoBarSettings] âœ… è·å–åˆ°å¯ç”¨é¢æ¿:', enabledPanels.length, 'ä¸ª');
                return enabledPanels;
            }

            // ğŸ”§ ä¿®å¤ï¼šå¤‡ç”¨æ–¹æ³•ï¼Œä½¿ç”¨ä¸SmartPromptSystemç›¸åŒçš„é€»è¾‘
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            const enabledPanels = [];

            // åŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            for (const panelId of basicPanelIds) {
                if (configs[panelId]) {
                    const panel = configs[panelId];
                    const isEnabled = panel.enabled !== false; // é»˜è®¤ä¸ºtrueï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse

                    if (isEnabled) {
                        // ğŸ”§ ä¿®å¤ï¼šåŒæ—¶å¤„ç†åŸºç¡€è®¾ç½®å¤é€‰æ¡†å’Œé¢æ¿ç®¡ç†è‡ªå®šä¹‰å­é¡¹
                        const allSubItems = [];

                        // 1. å¤„ç†åŸºç¡€è®¾ç½®ä¸­çš„å¤é€‰æ¡†é…ç½®ï¼ˆpanel[key].enabledæ ¼å¼ï¼‰
                        const subItemKeys = Object.keys(panel).filter(key =>
                            key !== 'enabled' &&
                            key !== 'subItems' &&     // æ’é™¤è‡ªå®šä¹‰å­é¡¹æ•°ç»„
                            key !== 'description' &&  // æ’é™¤é¢æ¿å±æ€§
                            key !== 'icon' &&
                            key !== 'required' &&
                            key !== 'memoryInject' &&
                            key !== 'prompts' &&
                            typeof panel[key] === 'object' &&
                            panel[key].enabled !== undefined
                        );
                        const enabledSubItems = subItemKeys.filter(key => panel[key].enabled === true);

                        // æ·»åŠ åŸºç¡€è®¾ç½®çš„å­é¡¹
                        enabledSubItems.forEach(key => {
                            allSubItems.push({
                                key: key,
                                name: panel[key].name || this.getSubItemDisplayName(panelId, key),
                                enabled: true,
                                value: panel[key].value || '',
                                source: 'basicSettings'
                            });
                        });

                        // 2. å¤„ç†é¢æ¿ç®¡ç†ä¸­çš„è‡ªå®šä¹‰å­é¡¹ï¼ˆpanel.subItemsæ•°ç»„æ ¼å¼ï¼‰
                        let enabledCustomSubItems = [];
                        if (panel.subItems && Array.isArray(panel.subItems)) {
                            enabledCustomSubItems = panel.subItems.filter(subItem => subItem.enabled !== false);

                            // åˆ›å»ºé”®åé›†åˆï¼Œé¿å…é‡å¤æ·»åŠ 
                            const existingKeys = new Set(allSubItems.map(item => item.key));

                            enabledCustomSubItems.forEach(subItem => {
                                const key = subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_');

                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤
                                if (!existingKeys.has(key)) {
                                    allSubItems.push({
                                        key: key,
                                        name: subItem.displayName || subItem.name,
                                        enabled: true,
                                        value: subItem.value || '',
                                        source: 'panelManagement'
                                    });
                                    existingKeys.add(key);
                                }
                            });
                        }

                        if (allSubItems.length > 0) {
                            enabledPanels.push({
                                id: panelId,
                                name: this.getPanelDisplayName(panelId),
                                config: panel,
                                subItems: allSubItems
                            });
                        }
                    }
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥è‡ªå®šä¹‰é¢æ¿ï¼Œä½¿ç”¨ä¸SmartPromptSystemç›¸åŒçš„é€»è¾‘
            if (configs.customPanels) {
                for (const [panelId, panelConfig] of Object.entries(configs.customPanels)) {
                    if (panelConfig && panelConfig.enabled !== false) { // é»˜è®¤å¯ç”¨ï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse
                        const allSubItems = panelConfig.subItems || [];
                        // åªç»Ÿè®¡å¯ç”¨çš„å­é¡¹
                        const enabledSubItems = allSubItems.filter(subItem => subItem.enabled !== false);

                        // å¤„ç†å¯ç”¨çš„å­é¡¹
                        const processedSubItems = enabledSubItems.map(subItem => {
                            // å¤„ç†ä¸åŒçš„å­é¡¹æ ¼å¼
                            if (typeof subItem === 'string') {
                                return {
                                    key: subItem,
                                    name: subItem,
                                    enabled: true,
                                    value: ''
                                };
                            } else if (subItem && typeof subItem === 'object') {
                                return {
                                    key: subItem.key || subItem.name || subItem.id,
                                    name: subItem.name || subItem.displayName || subItem.key || subItem.id,
                                    enabled: subItem.enabled !== false,
                                    value: subItem.value || ''
                                };
                            }
                            return null;
                        }).filter(Boolean);

                        enabledPanels.push({
                            id: panelId,
                            key: panelConfig.key || panelId, // æ·»åŠ keyå±æ€§
                            type: 'custom',
                            name: panelConfig.name || 'æœªå‘½åé¢æ¿',
                            config: panelConfig,
                            subItems: processedSubItems
                        });
                    }
                }
            }

            console.log('[InfoBarSettings] âœ… è·å–åˆ°å¯ç”¨é¢æ¿:', enabledPanels.length, 'ä¸ª');
            return enabledPanels;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨é¢æ¿ä¿¡æ¯å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸš€ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼è¯´æ˜
     */
    async generateDataAccessMethods(enabledPanels) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼è¯´æ˜...');

            const accessMethods = [];

            enabledPanels.forEach(panel => {
                const panelAccess = {
                    panelId: panel.id,
                    panelName: panel.name,
                    accessSyntax: `{{data.${panel.id}.fieldName}}`,
                    availableFields: [],
                    examples: []
                };

                // ä¸ºæ¯ä¸ªå­é¡¹ç”Ÿæˆè®¿é—®ç¤ºä¾‹
                panel.subItems.forEach(subItem => {
                    panelAccess.availableFields.push({
                        key: subItem.key,
                        name: subItem.name,
                        syntax: `{{data.${panel.id}.${subItem.key}}}`
                    });

                    // ç”Ÿæˆç¤ºä¾‹
                    panelAccess.examples.push(
                        `<span class="${panel.id}-${subItem.key}">{{data.${panel.id}.${subItem.key}}}</span>`
                    );
                });

                accessMethods.push(panelAccess);
            });

            console.log('[InfoBarSettings] âœ… æ•°æ®è·å–æ–¹å¼ç”Ÿæˆå®Œæˆ');
            return accessMethods;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸš€ æ„å»ºAIåˆ›ä½œçŠ¶æ€æ æç¤ºè¯
     */
    buildAICreateStatusBarPrompt(enabledPanels, dataAccessMethods) {
        const panelSummary = enabledPanels.map(panel =>
            `${panel.name}(${panel.subItems.length}ä¸ªå­—æ®µ)`
        ).join('ã€');

        const dataExamples = dataAccessMethods.map(method => {
            const fieldExamples = method.availableFields.slice(0, 4).map(field =>
                `  ${field.syntax} // ${field.name}`
            ).join('\n');

            return `### ${method.panelName}\n${fieldExamples}`;
        }).join('\n\n');

        return `# çŠ¶æ€æ HTMLç”Ÿæˆä»»åŠ¡

## ä»»åŠ¡ç›®æ ‡
åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„HTMLçŠ¶æ€æ ï¼ŒåŒ…å«CSSæ ·å¼å’Œæ•°æ®ç»‘å®šã€‚

## å¯ç”¨çš„æ•°æ®é¢æ¿
${panelSummary}

## å¯ç”¨æ•°æ®å­—æ®µ
${dataExamples}

## HTMLæ ¼å¼è¦æ±‚
1. **å®Œæ•´HTMLæ–‡æ¡£ç»“æ„**ï¼š
   - å¿…é¡»åŒ…å« <!DOCTYPE html>
   - åŒ…å« <html>, <head>, <body> æ ‡ç­¾
   - åœ¨ <head> ä¸­å®šä¹‰æ‰€æœ‰CSSæ ·å¼

2. **CSSæ ·å¼è§„èŒƒ**ï¼š
   - æ‰€æœ‰æ ·å¼å¿…é¡»å†™åœ¨ <head> å†…çš„ <style> æ ‡ç­¾ä¸­
   - ä¸è¦ä½¿ç”¨å†…è”æ ·å¼ (style="...")
   - ä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸»é¢˜è‰²å½©
   - æ”¯æŒå“åº”å¼è®¾è®¡

3. **æ•°æ®ç»‘å®šè¯­æ³•**ï¼š
   - ä½¿ç”¨ {{data.é¢æ¿å.å­—æ®µå}} æ ¼å¼
   - æ¡ä»¶æ˜¾ç¤ºï¼š{{#if data.å­—æ®µ}}å†…å®¹{{/if}}
   - å¾ªç¯ï¼š{{#each data.æ•°ç»„}}{{this}}{{/each}}

## CSSé¢œè‰²è¦æ±‚
**é‡è¦ï¼šå¿…é¡»ä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼ï¼Œä¸è¦ä½¿ç”¨CSSå˜é‡**
- èƒŒæ™¯æ¸å˜ï¼šlinear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)
- å¡ç‰‡èƒŒæ™¯ï¼šrgba(255, 255, 255, 0.6)
- ä¸»æ–‡å­—è‰²ï¼š#5c2a52
- å¼ºè°ƒè‰²ï¼š#d9538d
- é˜´å½±ï¼š0 8px 32px 0 rgba(240, 128, 128, 0.3)

## è®¾è®¡é£æ ¼
- ç°ä»£åŒ–å¡ç‰‡å¼å¸ƒå±€ï¼Œ16pxåœ†è§’
- ç²‰è‰²ä¸»é¢˜ï¼šä½¿ç”¨ç²‰è‰²ç³»æ¸å˜å’ŒåŠé€æ˜æ•ˆæœ
- å“åº”å¼ç½‘æ ¼å¸ƒå±€
- æ‚¬åœæ•ˆæœï¼štransform: translateY(-8px)
- ä¸è¦ä½¿ç”¨var(--å˜é‡å)ï¼Œç›´æ¥å†™å…·ä½“é¢œè‰²å€¼

## è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºå®Œæ•´çš„HTMLä»£ç ï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ã€‚ä»£ç å¿…é¡»åŒ…å«ï¼š
1. å®Œæ•´çš„HTMLæ–‡æ¡£ç»“æ„
2. <head> ä¸­çš„CSSæ ·å¼å®šä¹‰
3. <body> ä¸­çš„å†…å®¹ç»“æ„
4. æ‰€æœ‰å¯ç”¨é¢æ¿çš„æ•°æ®ç»‘å®š`;
    }

    /**
     * ğŸš€ è°ƒç”¨AIè¿›è¡ŒçŠ¶æ€æ åˆ›ä½œ
     */
    async callAIForStatusBarCreation(prompt) {
        try {
            console.log('[InfoBarSettings] ğŸ¤– è°ƒç”¨AIè¿›è¡ŒçŠ¶æ€æ åˆ›ä½œ...');

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é€šç”¨APIé›†æˆæ¨¡å—è€Œä¸æ˜¯è‡ªå®šä¹‰å®ç°
            if (!this.apiIntegration || !this.apiIntegration.initialized) {
                throw new Error('AI APIæœªé…ç½®æˆ–æœªåˆå§‹åŒ–ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®API');
            }

            // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
            if (!this.apiIntegration.apiConfig || !this.apiIntegration.apiConfig.enabled) {
                throw new Error('AI APIæœªå¯ç”¨ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­å¯ç”¨API');
            }

            console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨é€šç”¨APIé›†æˆæ¨¡å—è°ƒç”¨AI...');

            // ä½¿ç”¨APIIntegrationçš„generateTextæ–¹æ³•
            const response = await this.apiIntegration.generateText(prompt, {
                maxTokens: this.apiIntegration.apiConfig.maxTokens || 20000,
                temperature: this.apiIntegration.apiConfig.temperature || 0.7,
                systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HTMLæ¨¡æ¿å¼€å‘åŠ©æ‰‹ï¼Œä¸“æ³¨äºç”Ÿæˆé«˜è´¨é‡ã€è¯­ä¹‰åŒ–çš„HTMLä»£ç ã€‚'
            });

            if (!response || !response.success) {
                throw new Error(response?.error || 'AI APIè¿”å›å¤±è´¥');
            }

            if (!response.text) {
                throw new Error('AI APIè¿”å›ç©ºå“åº”');
            }

            // æ¸…ç†AIè¿”å›çš„å†…å®¹
            const cleanedResult = this.cleanAIResponse(response.text);

            console.log('[InfoBarSettings] âœ… AIçŠ¶æ€æ åˆ›ä½œå®Œæˆ');
            return cleanedResult;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ AIçŠ¶æ€æ åˆ›ä½œå¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸš€ æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿
     */
    async showDataInfoPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿...');

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanels = await this.getEnabledPanelsForAI();

            // åˆ›å»ºæ•°æ®ä¿¡æ¯å¼¹çª—
            const dataInfoHTML = this.createDataInfoPopup(enabledPanels);

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', dataInfoHTML);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const popup = document.querySelector('.data-info-popup');
            if (popup) {
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        popup.remove();
                    }
                });

                // å…³é—­æŒ‰é’®
                const closeBtn = popup.querySelector('.popup-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        popup.remove();
                    });
                }

                // ESCé”®å…³é—­
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        popup.remove();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
            }

            console.log('[InfoBarSettings] âœ… æ•°æ®ä¿¡æ¯é¢æ¿æ˜¾ç¤ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ åˆ›å»ºæ•°æ®ä¿¡æ¯å¼¹çª—
     */
    createDataInfoPopup(enabledPanels) {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        // ç”Ÿæˆé¢æ¿ä¿¡æ¯å†…å®¹
        let panelsHTML = '';
        if (enabledPanels.length === 0) {
            panelsHTML = `
                <div style="text-align: center; padding: 40px; color: ${themeColors.textSecondary};">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>å½“å‰æ²¡æœ‰å¯ç”¨çš„é¢æ¿</p>
                    <p style="font-size: 12px;">è¯·å…ˆåœ¨è®¾ç½®ä¸­å¯ç”¨ä¸€äº›é¢æ¿</p>
                </div>
            `;
        } else {
            panelsHTML = enabledPanels.map(panel => {
                const subItemsHTML = panel.subItems.map(subItem => `
                    <div class="data-field-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 12px;
                        background: ${themeColors.surface};
                        border-radius: 6px;
                        margin-bottom: 6px;
                        border: 1px solid ${themeColors.border};
                    ">
                        <div class="field-info">
                            <div class="field-name" style="color: ${themeColors.text}; font-weight: 500;">
                                ${subItem.name}
                            </div>
                            <div class="field-syntax" style="
                                color: ${themeColors.textSecondary};
                                font-size: 11px;
                                font-family: 'Consolas', 'Monaco', monospace;
                                margin-top: 2px;
                            ">
                                {{data.${panel.id}.${subItem.key}}}
                            </div>
                        </div>
                        <button class="copy-syntax-btn" data-syntax="{{data.${panel.id}.${subItem.key}}}" style="
                            background: ${themeColors.accent};
                            color: ${themeColors.background};
                            border: none;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 10px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `).join('');

                return `
                    <div class="panel-section" style="margin-bottom: 24px;">
                        <div class="panel-header" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid ${themeColors.border};
                        ">
                            <h4 style="
                                margin: 0;
                                color: ${themeColors.text};
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <i class="fas fa-database" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                ${panel.name}
                            </h4>
                            <span style="
                                margin-left: auto;
                                background: ${themeColors.accent};
                                color: ${themeColors.background};
                                padding: 2px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: 500;
                            ">
                                ${panel.subItems.length} ä¸ªå­—æ®µ
                            </span>
                        </div>
                        <div class="panel-fields">
                            ${subItemsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }

        return `
            <div class="data-info-popup" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
            ">
                <div class="popup-container" style="
                    width: 100%;
                    max-width: 800px;
                    max-height: 80vh;
                    background: ${themeColors.background};
                    border-radius: 12px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    border: 1px solid ${themeColors.border};
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                ">
                    <div class="popup-header" style="
                        padding: 20px 24px;
                        background: ${themeColors.surface};
                        border-bottom: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <h3 style="margin: 0; color: ${themeColors.text}; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-info-circle" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                æ•°æ®å­—æ®µä¿¡æ¯
                            </h3>
                            <p style="margin: 4px 0 0 0; color: ${themeColors.textSecondary}; font-size: 13px;">
                                å½“å‰å¯ç”¨çš„é¢æ¿å’Œå¯ç”¨æ•°æ®å­—æ®µ
                            </p>
                        </div>
                        <button class="popup-close-btn" style="
                            background: transparent;
                            border: 1px solid ${themeColors.border};
                            color: ${themeColors.textSecondary};
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                           onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="popup-body" style="
                        flex: 1;
                        padding: 20px 24px;
                        overflow-y: auto;
                    ">
                        ${panelsHTML}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ è·å–å­é¡¹æ˜¾ç¤ºåç§°ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨8875è¡Œçš„æ–°ç‰ˆæœ¬ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šç§»é™¤å¯¹ä¸å­˜åœ¨çš„getFieldMappings()çš„è°ƒç”¨
     */
    // getSubItemDisplayName() æ–¹æ³•å·²åœ¨8875è¡Œé‡æ–°å®ç°ï¼Œæ­¤å¤„ä¸å†éœ€è¦

    /**
     * ğŸš€ ç»‘å®šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶
     */
    bindPromptEditorEvents(modal) {
        try {
            // ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶
            if (modal.dataset.promptEventsbound === 'true') {
                console.log('[InfoBarSettings] âš ï¸ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }

            // æç¤ºè¯æ¨¡æ¿æŒ‰é’®
            modal.querySelectorAll('.prompt-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.insertPromptTemplate(btn.dataset.template);
                });
            });

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æŒ‰é’® - æ·»åŠ é˜²é‡å¤ç‚¹å‡»
            const usePromptBtn = modal.querySelector('[data-action="use-custom-prompt"]');
            if (usePromptBtn) {
                usePromptBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // ğŸ”§ é˜²æ­¢é‡å¤ç‚¹å‡»
                    if (usePromptBtn.disabled || usePromptBtn.dataset.processing === 'true') {
                        console.log('[InfoBarSettings] âš ï¸ AIç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                        return;
                    }

                    await this.useCustomPrompt();
                });
            }

            // æ ‡è®°äº‹ä»¶å·²ç»‘å®š
            modal.dataset.promptEventsbound = 'true';
            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ’å…¥æç¤ºè¯æ¨¡æ¿
     */
    insertPromptTemplate(templateType) {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.prompt-textarea');
            if (!textarea) return;

            const templates = {
                character: 'åˆ›å»ºè§’è‰²çŠ¶æ€æ ï¼šå¤´åƒã€å§“åã€ç­‰çº§ã€ç”Ÿå‘½å€¼ï¼Œä½¿ç”¨ç²‰è‰²æ¸å˜èƒŒæ™¯#fff0f5åˆ°#ffe4e1ï¼Œå¡ç‰‡èƒŒæ™¯rgba(255,255,255,0.6)ï¼Œæ–‡å­—è‰²#5c2a52',
                inventory: 'è®¾è®¡ç‰©å“æ ç•Œé¢ï¼šç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºç‰©å“å›¾æ ‡ã€åç§°ã€æ•°é‡ï¼Œä½¿ç”¨å…·ä½“é¢œè‰²å€¼ä¸ç”¨CSSå˜é‡ï¼Œç²‰è‰²ä¸»é¢˜',
                stats: 'åˆ¶ä½œå±æ€§é¢æ¿ï¼šåŠ›é‡ã€æ•æ·ã€æ™ºåŠ›ç­‰æ•°å€¼ï¼Œå¸¦è¿›åº¦æ¡ï¼Œä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼#d9538dä½œä¸ºå¼ºè°ƒè‰²',
                modern: 'ç°ä»£åŒ–çŠ¶æ€æ ï¼šæ¸å˜èƒŒæ™¯linear-gradient(135deg,#fff0f5,#ffe4e1)ï¼Œåœ†è§’16pxï¼Œé˜´å½±rgba(240,128,128,0.3)ï¼Œä¸ä½¿ç”¨var()å˜é‡',
                minimal: 'ç®€çº¦çŠ¶æ€æ ï¼šæ¸…çˆ½å¸ƒå±€ï¼Œç›´æ¥ä½¿ç”¨å…·ä½“é¢œè‰²å€¼ï¼ŒèƒŒæ™¯#fff0f5ï¼Œæ–‡å­—#5c2a52ï¼Œå¼ºè°ƒè‰²#d9538d'
            };

            const template = templates[templateType];
            if (template) {
                textarea.value = template;
                textarea.focus();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ’å…¥æç¤ºè¯æ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯è¿›è¡ŒAIåˆ›ä½œ
     */
    async useCustomPrompt() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const promptTextarea = modal?.querySelector('.prompt-textarea');
            const usePromptBtn = modal?.querySelector('[data-action="use-custom-prompt"]');

            if (!promptTextarea || !usePromptBtn) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šå¼ºåŒ–é˜²é‡å¤ç‚¹å‡»æœºåˆ¶
            if (usePromptBtn.disabled || usePromptBtn.dataset.processing === 'true') {
                console.log('[InfoBarSettings] âš ï¸ AIç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                return;
            }

            const customPrompt = promptTextarea.value.trim();
            if (!customPrompt) {
                this.showNotification('è¯·è¾“å…¥æç¤ºè¯å†…å®¹', 'warning');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®å¤„ç†çŠ¶æ€æ ‡è®°
            usePromptBtn.dataset.processing = 'true';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = usePromptBtn.innerHTML;
            usePromptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIç”Ÿæˆä¸­...';
            usePromptBtn.disabled = true;

            console.log('[InfoBarSettings] ğŸš€ å¼€å§‹AIç”Ÿæˆï¼Œæç¤ºè¯é•¿åº¦:', customPrompt.length);

            try {
                // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
                const enabledPanels = await this.getEnabledPanelsForAI();
                const dataAccessMethods = await this.generateDataAccessMethods(enabledPanels);

                // æ„å»ºå¢å¼ºçš„AIæç¤ºè¯
                const enhancedPrompt = this.buildEnhancedAIPrompt(customPrompt, enabledPanels, dataAccessMethods);

                // è°ƒç”¨AIç”ŸæˆçŠ¶æ€æ 
                const generatedStatusBar = await this.callAIForStatusBarCreation(enhancedPrompt);

                // å°†ç”Ÿæˆçš„çŠ¶æ€æ æ’å…¥åˆ°ç¼–è¾‘å™¨
                const htmlTextarea = modal?.querySelector('.html-template-textarea');
                if (htmlTextarea && generatedStatusBar) {
                    htmlTextarea.value = generatedStatusBar;

                    // æ›´æ–°é¢„è§ˆ
                    this.updateTemplatePreview();
                    this.updateEditorStatus();

                    console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰æç¤ºè¯AIåˆ›ä½œå®Œæˆ');
                    this.showNotification('AIçŠ¶æ€æ åˆ›ä½œå®Œæˆï¼', 'success');
                }

            } catch (error) {
                console.error('[InfoBarSettings] âŒ è‡ªå®šä¹‰æç¤ºè¯AIåˆ›ä½œå¤±è´¥:', error);

                // ğŸ”§ ä¿®å¤ï¼šæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = error.message;
                if (error.message.includes('APIè¯·æ±‚å¤±è´¥')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®';
                } else if (error.message.includes('æœªå¯ç”¨') || error.message.includes('æœªé…ç½®')) {
                    errorMessage = 'è¯·å…ˆåœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®AI API';
                }

                this.showNotification(`AIç”Ÿæˆå¤±è´¥: ${errorMessage}`, 'error');
            } finally {
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿çŠ¶æ€å®Œå…¨æ¢å¤
                if (usePromptBtn) {
                    usePromptBtn.innerHTML = originalText;
                    usePromptBtn.disabled = false;
                    usePromptBtn.dataset.processing = 'false';
                }
                console.log('[InfoBarSettings] ğŸ”„ AIç”Ÿæˆæµç¨‹ç»“æŸï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ„å»ºå¢å¼ºçš„AIæç¤ºè¯
     */
    buildEnhancedAIPrompt(userPrompt, enabledPanels, dataAccessMethods) {
        const panelSummary = enabledPanels.map(panel =>
            `${panel.name}(${panel.subItems.length}ä¸ªå­—æ®µ)`
        ).join('ã€');

        const dataExamples = dataAccessMethods.map(method => {
            const fieldExamples = method.availableFields.slice(0, 4).map(field =>
                `  ${field.syntax} // ${field.name}`
            ).join('\n');

            return `### ${method.panelName}\n${fieldExamples}`;
        }).join('\n\n');

        return `# è‡ªå®šä¹‰çŠ¶æ€æ HTMLç”Ÿæˆ

## ç”¨æˆ·éœ€æ±‚
${userPrompt}

## å¯ç”¨æ•°æ®é¢æ¿
${panelSummary}

## æ•°æ®å­—æ®µè¯­æ³•
${dataExamples}

## HTMLç»“æ„è¦æ±‚
1. **å®Œæ•´HTMLæ–‡æ¡£**ï¼š
   - åŒ…å« <!DOCTYPE html>, <html>, <head>, <body>
   - æ‰€æœ‰CSSå†™åœ¨ <head> çš„ <style> æ ‡ç­¾å†…
   - ä¸ä½¿ç”¨å†…è”æ ·å¼

2. **CSSé¢œè‰²è§„èŒƒ**ï¼š
   **ç¦æ­¢ä½¿ç”¨CSSå˜é‡ï¼Œå¿…é¡»ä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼**
   - èƒŒæ™¯ï¼šlinear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)
   - å¡ç‰‡ï¼šrgba(255, 255, 255, 0.6)
   - æ–‡å­—ï¼š#5c2a52
   - å¼ºè°ƒï¼š#d9538d
   - é˜´å½±ï¼šrgba(240, 128, 128, 0.3)

3. **æ•°æ®ç»‘å®š**ï¼š
   - {{data.é¢æ¿å.å­—æ®µå}}
   - {{#if data.å­—æ®µ}}æ¡ä»¶å†…å®¹{{/if}}

## è®¾è®¡é£æ ¼
- ç²‰è‰²ä¸»é¢˜å¡ç‰‡å¸ƒå±€ï¼Œ16pxåœ†è§’
- ç›´æ¥ä½¿ç”¨å…·ä½“é¢œè‰²å€¼ï¼Œä¸ç”¨var()
- å“åº”å¼ç½‘æ ¼å¸ƒå±€
- æ‚¬åœæ•ˆæœï¼štranslateY(-8px)

ç›´æ¥è¾“å‡ºå®Œæ•´HTMLä»£ç ï¼Œæ— éœ€è§£é‡Šã€‚

## ğŸ”§ æŠ€æœ¯è§„èŒƒ
- ä½¿ç”¨å†…è”CSSæ ·å¼
- æ•°æ®ç»‘å®šè¯­æ³•: {{data.panelId.fieldName}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯æ¸²æŸ“: {{#each data.array}}{{this}}{{/each}}
- å›¾æ ‡ç±»å: fas fa-icon-name

## ğŸ“ è¾“å‡ºè¦æ±‚
è¯·ç›´æ¥è¾“å‡ºå®Œæ•´çš„HTMLä»£ç ï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„HTMLç»“æ„
- å†…è”CSSæ ·å¼
- æ‰€æœ‰å¯ç”¨é¢æ¿çš„æ•°æ®ç»‘å®š
- ç°ä»£åŒ–çš„è§†è§‰è®¾è®¡
- å“åº”å¼å¸ƒå±€

ä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ–‡å­—ï¼Œç›´æ¥è¾“å‡ºHTMLä»£ç ã€‚`;
    }

    /**
     * ğŸš€ åŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨
     */
    async loadDataFieldsToPromptEditor() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const fieldsList = modal?.querySelector('.data-fields-list');
            if (!fieldsList) return;

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanels = await this.getEnabledPanelsForAI();

            if (enabledPanels.length === 0) {
                fieldsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #aaa);">
                        <i class="fas fa-info-circle" style="margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>å½“å‰æ²¡æœ‰å¯ç”¨çš„é¢æ¿</p>
                    </div>
                `;
                return;
            }

            // ç”Ÿæˆå­—æ®µåˆ—è¡¨HTML
            const fieldsHTML = enabledPanels.map(panel => {
                const fieldsItems = panel.subItems.map(subItem => `
                    <div class="field-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0px 4px;
                        margin-bottom: 0px;
                        border-radius: 2px;
                        background: var(--theme-surface, #2a2a2a);
                        border: 1px solid var(--theme-border, #444);
                        min-height: 16px;
                        line-height: 1.0;
                        height: 16px;
                    ">
                        <span style="color: var(--theme-text, #fff); font-size: 9px; line-height: 1.0;">
                            ${subItem.name}
                        </span>
                        <code style="
                            color: var(--theme-accent, #007bff);
                            font-size: 8px;
                            font-family: 'Consolas', 'Monaco', monospace;
                            line-height: 1.0;
                        ">
                            {{data.${panel.id}.${subItem.key}}}
                        </code>
                    </div>
                `).join('');

                return `
                    <div class="panel-group" style="margin-bottom: 1px;">
                        <div class="panel-title" style="
                            color: var(--theme-accent, #007bff);
                            font-size: 10px;
                            font-weight: 600;
                            margin-bottom: 0px;
                            padding: 0px 4px;
                            background: var(--theme-background, #1a1a1a);
                            border-radius: 3px;
                            line-height: 1.1;
                            height: 16px;
                            display: flex;
                            align-items: center;
                        ">
                            <i class="fas fa-database" style="margin-right: 3px; font-size: 10px;"></i>
                            ${panel.name}
                        </div>
                        ${fieldsItems}
                    </div>
                `;
            }).join('');

            fieldsList.innerHTML = fieldsHTML;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨å¤±è´¥:', error);
            const fieldsList = document.querySelector('.data-fields-list');
            if (fieldsList) {
                fieldsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #aaa);">
                        <i class="fas fa-exclamation-triangle" style="margin-bottom: 8px; color: #ff6b6b;"></i>
                        <p>åŠ è½½æ•°æ®å­—æ®µå¤±è´¥</p>
                    </div>
                `;
            }
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createHTMLTemplateEditorHTML() {
        return this.createStatusBarEditorHTML();
    }

    // ==================== ğŸ†• ä¸–ç•Œä¹¦é…ç½®ç›¸å…³æ–¹æ³• ====================

    /**
     * åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿
     */
    async initWorldBookConfigPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ“š åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿...');

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
            if (this.worldBookConfigPanelInitialized) {
                console.log('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦é…ç½®é¢æ¿å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }

            // è·å–ä¸–ç•Œä¹¦ç®¡ç†å™¨å¼•ç”¨
            this.worldBookManager = window.SillyTavernInfobar?.modules?.worldBookManager;
            this.worldBookConfigPanel = window.SillyTavernInfobar?.modules?.worldBookConfigPanel;

            if (!this.worldBookManager || !this.worldBookConfigPanel) {
                console.warn('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦ç®¡ç†å™¨æˆ–é…ç½®é¢æ¿æœªæ‰¾åˆ°');
                return;
            }

            // è·å–ä¸–ç•Œä¹¦é…ç½®å®¹å™¨
            const container = this.modal.querySelector('#worldbook-config-container');
            if (!container) {
                console.warn('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦é…ç½®å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†å®¹å™¨å†…å®¹ï¼Œé¿å…é‡å¤æ¸²æŸ“
            container.innerHTML = '';

            // æ¸²æŸ“ä¸–ç•Œä¹¦é…ç½®é¢æ¿
            await this.worldBookConfigPanel.render(container);

            // ç»‘å®šä¸–ç•Œä¹¦å¤é€‰æ¡†äº‹ä»¶
            this.bindWorldBookEvents();

            // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
            this.worldBookConfigPanelInitialized = true;

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦é…ç½®é¢æ¿åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šä¸–ç•Œä¹¦ç›¸å…³äº‹ä»¶
     */
    bindWorldBookEvents() {
        try {
            // ç»‘å®šä¸–ç•Œä¹¦å¯ç”¨å¤é€‰æ¡†äº‹ä»¶
            const worldBookCheckbox = this.modal.querySelector('#infobar-api-include-worldbook');
            if (worldBookCheckbox) {
                worldBookCheckbox.addEventListener('change', (e) => {
                    this.handleWorldBookToggle(e.target.checked);
                });

                // åˆå§‹çŠ¶æ€æ£€æŸ¥
                this.handleWorldBookToggle(worldBookCheckbox.checked);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šä¸–ç•Œä¹¦äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†ä¸–ç•Œä¹¦å¯ç”¨/ç¦ç”¨åˆ‡æ¢
     */
    handleWorldBookToggle(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ“š ä¸–ç•Œä¹¦åŠŸèƒ½', enabled ? 'å¯ç”¨' : 'ç¦ç”¨');

            // æ˜¾ç¤º/éšè—ä¸–ç•Œä¹¦é…ç½®é¢æ¿
            const configSection = this.modal.querySelector('.worldbook-config-section');
            if (configSection) {
                configSection.style.display = enabled ? 'block' : 'none';
            }

            // å¦‚æœå¯ç”¨ä¸–ç•Œä¹¦ï¼Œç¡®ä¿é…ç½®é¢æ¿å·²åˆå§‹åŒ–
            if (enabled && this.worldBookConfigPanel) {
                this.worldBookConfigPanel.show();
            } else if (this.worldBookConfigPanel) {
                this.worldBookConfigPanel.hide();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ä¸–ç•Œä¹¦åˆ‡æ¢å¤±è´¥:', error);
        }
    }

    /**
     * è·å–ä¸–ç•Œä¹¦é…ç½®çŠ¶æ€
     */
    getWorldBookConfigStatus() {
        try {
            if (!this.worldBookManager || !this.worldBookConfigPanel) {
                return {
                    available: false,
                    enabled: false,
                    error: 'ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåˆå§‹åŒ–'
                };
            }

            const worldBookCheckbox = this.modal.querySelector('#infobar-api-include-worldbook');
            const enabled = worldBookCheckbox ? worldBookCheckbox.checked : false;

            return {
                available: true,
                enabled: enabled,
                config: this.worldBookManager.config,
                panelStatus: this.worldBookConfigPanel.getStatus()
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦é…ç½®çŠ¶æ€å¤±è´¥:', error);
            return {
                available: false,
                enabled: false,
                error: error.message
            };
        }
    }

    /**
     * æ›´æ–°ä¸–ç•Œä¹¦é…ç½®
     */
    async updateWorldBookConfig(config) {
        try {
            console.log('[InfoBarSettings] ğŸ“š æ›´æ–°ä¸–ç•Œä¹¦é…ç½®...');

            if (!this.worldBookManager) {
                throw new Error('ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°é…ç½®
            Object.assign(this.worldBookManager.config, config);

            // ä¿å­˜é…ç½®
            await this.worldBookManager.saveConfig();

            // åˆ·æ–°é…ç½®é¢æ¿
            if (this.worldBookConfigPanel) {
                await this.worldBookConfigPanel.refreshData();
            }

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦é…ç½®æ›´æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸–ç•Œä¹¦é…ç½®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸš€ å¤„ç†AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleAIMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ·±åº¦è®°å¿†ç®¡ç†å™¨ä¾èµ–
            if (enabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

                if (!deepMemoryEnabled) {
                    // æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼Œæé†’ç”¨æˆ·
                    const confirmEnable = confirm(
                        'âš ï¸ AIè®°å¿†æ€»ç»“åŠŸèƒ½ä¾èµ–æé†’\n\n' +
                        'AIè®°å¿†æ€»ç»“åŠŸèƒ½éœ€è¦é…åˆ"æ·±åº¦è®°å¿†ç®¡ç†å™¨"ä¸€èµ·ä½¿ç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚\n\n' +
                        'å½“å‰æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼ŒAIè®°å¿†æ€»ç»“ç”Ÿæˆçš„å†…å®¹å°†æ— æ³•è¢«å¤„ç†å’Œå­˜å‚¨ã€‚\n\n' +
                        'æ˜¯å¦åŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨ï¼Ÿ\n\n' +
                        'ç‚¹å‡»"ç¡®å®š"å°†åŒæ—¶å¯ç”¨ä¸¤ä¸ªåŠŸèƒ½\n' +
                        'ç‚¹å‡»"å–æ¶ˆ"å°†åªå¯ç”¨AIè®°å¿†æ€»ç»“ï¼ˆä½†åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼‰'
                    );

                    if (confirmEnable) {
                        // ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        console.log('[InfoBarSettings] ğŸ”§ ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨');

                        // å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        if (deepMemoryManager) {
                            deepMemoryManager.updateSettings({
                                enabled: true
                            });
                        }

                        // æ›´æ–°UIä¸­çš„æ·±åº¦è®°å¿†ç®¡ç†å™¨å¤é€‰æ¡†
                        const deepMemoryCheckbox = this.modal.querySelector('#memory-deep-memory-enabled');
                        if (deepMemoryCheckbox) {
                            deepMemoryCheckbox.checked = true;
                        }

                        this.showMessage(
                            'âœ… å·²åŒæ—¶å¯ç”¨AIè®°å¿†æ€»ç»“å’Œæ·±åº¦è®°å¿†ç®¡ç†å™¨',
                            'success'
                        );
                    } else {
                        // ç”¨æˆ·å–æ¶ˆï¼Œåªå¯ç”¨AIè®°å¿†æ€»ç»“ï¼Œä½†æ˜¾ç¤ºè­¦å‘Š
                        console.warn('[InfoBarSettings] âš ï¸ ç”¨æˆ·é€‰æ‹©åªå¯ç”¨AIè®°å¿†æ€»ç»“ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨');
                        this.showMessage(
                            'âš ï¸ AIè®°å¿†æ€»ç»“å·²å¯ç”¨ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼ŒåŠŸèƒ½å°†æ— æ³•æ­£å¸¸å·¥ä½œ',
                            'warning'
                        );
                    }
                }
            }

            // æ˜¾ç¤º/éšè—AIè®°å¿†é€‰é¡¹
            const aiMemoryOptions = this.modal.querySelectorAll('.ai-memory-options');
            aiMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    enabled: enabled
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨æ²¡æœ‰æ˜¾ç¤ºä¾èµ–æé†’çš„æƒ…å†µä¸‹æ‰æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

            if (!enabled || deepMemoryEnabled) {
                this.showMessage(
                    enabled ? 'âœ… AIè®°å¿†æ€»ç»“å·²å¯ç”¨' : 'âŒ AIè®°å¿†æ€»ç»“å·²ç¦ç”¨',
                    enabled ? 'success' : 'info'
                );
            }

            // ğŸ”§ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†æ¶ˆæ¯çº§åˆ«æ€»ç»“å˜åŒ–
     */
    handleAIMessageLevelChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ“ æ¶ˆæ¯çº§åˆ«æ€»ç»“çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    messageLevelSummary: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ¶ˆæ¯çº§åˆ«æ€»ç»“å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ—„ï¸ æ–°å¢ï¼šå¤„ç†AIè®°å¿†æ•°æ®åº“å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleAIMemoryDatabaseEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—AIè®°å¿†æ•°æ®åº“é€‰é¡¹
            const aiMemoryDatabaseOptions = this.modal.querySelector('#memory-ai-memory-database-options');
            if (aiMemoryDatabaseOptions) {
                aiMemoryDatabaseOptions.style.display = enabled ? 'block' : 'none';
            }

            // æ›´æ–°AIè®°å¿†æ•°æ®åº“è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const aiMemoryDatabase = infoBarTool?.modules?.aiMemoryDatabase;
            
            if (aiMemoryDatabase) {
                aiMemoryDatabase.config.enabled = enabled;
                console.log('[InfoBarSettings] âœ… AIè®°å¿†æ•°æ®åº“é…ç½®å·²æ›´æ–°');
                console.log('[InfoBarSettings] ğŸ“Š å½“å‰é…ç½®:', aiMemoryDatabase.config);
            } else {
                console.error('[InfoBarSettings] âŒ AIè®°å¿†æ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°ï¼');
                console.error('[InfoBarSettings] å¯ç”¨æ¨¡å—åˆ—è¡¨:', Object.keys(infoBarTool?.modules || {}));
                
                // ğŸ”§ é™çº§æ–¹æ¡ˆï¼šå°è¯•ä»å…¶ä»–ä½ç½®è®¿é—®
                if (infoBarTool?.aiMemoryDatabase) {
                    console.warn('[InfoBarSettings] ğŸ”§ ä»ä¸»å¯¹è±¡æ‰¾åˆ°AIè®°å¿†æ•°æ®åº“ï¼Œæ‰‹åŠ¨æ›´æ–°é…ç½®');
                    infoBarTool.aiMemoryDatabase.config.enabled = enabled;
                } else if (window.__TEST_AIMemoryDatabase) {
                    console.warn('[InfoBarSettings] ğŸ”§ ä»æµ‹è¯•å…¨å±€å˜é‡æ‰¾åˆ°AIè®°å¿†æ•°æ®åº“ï¼Œæ‰‹åŠ¨æ›´æ–°é…ç½®');
                    window.__TEST_AIMemoryDatabase.config.enabled = enabled;
                } else {
                    this.showMessage(
                        'âš ï¸ AIè®°å¿†æ•°æ®åº“æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+Ræ¸…é™¤ç¼“å­˜ï¼‰',
                        'error'
                    );
                    return;
                }
            }

            this.showMessage(
                enabled ? 'âœ… AIè®°å¿†æ•°æ®åº“å·²å¯ç”¨' : 'âŒ AIè®°å¿†æ•°æ®åº“å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

            // ğŸ”§ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIè®°å¿†æ•°æ®åº“å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ“– æ–°å¢ï¼šå¤„ç†å‰§æƒ…è§„åˆ’åŠ©æ‰‹å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleStoryPlanningEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—å‰§æƒ…è§„åˆ’åŠ©æ‰‹é€‰é¡¹
            const storyPlanningOptions = this.modal.querySelector('#memory-story-planning-options');
            if (storyPlanningOptions) {
                storyPlanningOptions.style.display = enabled ? 'block' : 'none';
            }

            // æ›´æ–°å‰§æƒ…è§„åˆ’åŠ©æ‰‹è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const storyPlanningAssistant = infoBarTool?.modules?.storyPlanningAssistant;
            
            if (storyPlanningAssistant) {
                storyPlanningAssistant.setEnabled(enabled);
                console.log('[InfoBarSettings] âœ… å‰§æƒ…è§„åˆ’åŠ©æ‰‹é…ç½®å·²æ›´æ–°');
            } else {
                console.error('[InfoBarSettings] âŒ å‰§æƒ…è§„åˆ’åŠ©æ‰‹æ¨¡å—æœªæ‰¾åˆ°ï¼');
                console.error('[InfoBarSettings] å¯ç”¨æ¨¡å—åˆ—è¡¨:', Object.keys(infoBarTool?.modules || {}));
                
                this.showMessage(
                    'âš ï¸ å‰§æƒ…è§„åˆ’åŠ©æ‰‹æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+Ræ¸…é™¤ç¼“å­˜ï¼‰',
                    'error'
                );
                return;
            }

            this.showMessage(
                enabled ? 'âœ… å‰§æƒ…è§„åˆ’åŠ©æ‰‹å·²å¯ç”¨' : 'â¸ï¸ å‰§æƒ…è§„åˆ’åŠ©æ‰‹å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

            // ğŸ”§ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰§æƒ…è§„åˆ’åŠ©æ‰‹å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†é‡è¦æ€§é˜ˆå€¼å˜åŒ–
     */
    handleAIImportanceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ é‡è¦æ€§é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-ai-importance-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    importanceThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é‡è¦æ€§é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†ç­›é€‰æ ‡ç­¾ç‚¹å‡»
     */
    handleFilterTabClick(filter) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç­›é€‰æ ‡ç­¾ç‚¹å‡»:', filter);

            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            const filterTabs = this.modal.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                    tab.style.color = 'var(--SmartThemeEmColor, #ff6b6b)';
                    tab.style.borderBottomColor = 'var(--SmartThemeEmColor, #ff6b6b)';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = 'var(--SmartThemeQuoteColor, #888)';
                    tab.style.borderBottomColor = 'transparent';
                }
            });

            // ç­›é€‰æ€»ç»“å†å²
            this.filterSummaryHistory(filter);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç­›é€‰æ ‡ç­¾ç‚¹å‡»å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ç­›é€‰æ€»ç»“å†å²
     */
    async filterSummaryHistory(filter) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç­›é€‰æ€»ç»“å†å²:', filter);

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ SummaryManageræœªæ‰¾åˆ°');
                return;
            }

            // è·å–å¢å¼ºçš„æ€»ç»“å†å²
            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            console.log('[InfoBarSettings] ğŸ“š è·å–åˆ°æ€»ç»“å†å²:', allSummaries.length, 'æ¡');

            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤
            let filteredSummaries = allSummaries;
            if (filter !== 'all') {
                filteredSummaries = allSummaries.filter(summary => {
                    // æ ¹æ®ä¸åŒçš„ç­›é€‰æ¡ä»¶è¿›è¡Œè¿‡æ»¤
                    switch (filter) {
                        case 'traditional':
                            // ä¼ ç»Ÿæ€»ç»“ï¼šåŒ…æ‹¬å°æ€»ç»“ã€å¤§æ€»ç»“ã€æ‰‹åŠ¨æ€»ç»“ã€è‡ªåŠ¨æ€»ç»“
                            return summary.source === 'traditional' ||
                                   summary.type === 'small' ||
                                   summary.type === 'large' ||
                                   summary.type === 'manual' ||
                                   summary.type === 'auto' ||
                                   !summary.source; // æ²¡æœ‰sourceå­—æ®µçš„é»˜è®¤ä¸ºä¼ ç»Ÿæ€»ç»“
                        case 'ai_memory':
                            // AIè®°å¿†æ€»ç»“ï¼šæ¥è‡ªAIè®°å¿†æ€»ç»“å™¨çš„æ€»ç»“
                            return summary.source === 'ai_memory_summarizer' ||
                                   summary.type === 'ai_memory';
                        default:
                            return true;
                    }
                });
            }

            console.log('[InfoBarSettings] ğŸ” ç­›é€‰åçš„æ€»ç»“:', filteredSummaries.length, 'æ¡');

            // æ›´æ–°æ˜¾ç¤º
            this.renderSummaryHistory(filteredSummaries);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç­›é€‰æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶
     */
    bindWorldBookUploadEvents() {
        try {
            console.log('[InfoBarSettings] ğŸ”— ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶...');

            // æ¡ç›®å‘½åæ ¼å¼å˜åŒ–äº‹ä»¶
            const entryFormatSelect = this.modal.querySelector('#worldbook-entry-format');
            const customNameRow = this.modal.querySelector('#worldbook-custom-name-row');

            if (entryFormatSelect && customNameRow) {
                entryFormatSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        customNameRow.style.display = 'block';
                    } else {
                        customNameRow.style.display = 'none';
                    }
                });
            }

            // æ‰¹é‡ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            const batchUploadBtn = this.modal.querySelector('#worldbook-batch-upload-btn');
            if (batchUploadBtn) {
                batchUploadBtn.addEventListener('click', async () => {
                    await this.handleBatchUploadToWorldBook();
                });
            }

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†å•ä¸ªæ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦
     */
    async handleUploadSummaryToWorldBook() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¤„ç†å•ä¸ªæ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦...');

            // è·å–é€‰ä¸­çš„æ€»ç»“ID
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            const summaryId = historySelect?.value;

            if (!summaryId) {
                this.showNotification('è¯·å…ˆé€‰æ‹©ä¸€æ¡æ€»ç»“è®°å½•', 'info');
                return;
            }

            // è·å–ä¸Šä¼ é…ç½®
            const uploadOptions = this.getWorldBookUploadOptions();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.showNotification('æ­£åœ¨ä¸Šä¼ æ€»ç»“åˆ°ä¸–ç•Œä¹¦...', 'info');

            // è·å–SummaryManager
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('SummaryManageræœªåˆå§‹åŒ–');
            }

            // æ‰§è¡Œä¸Šä¼ 
            const result = await summaryManager.uploadSummaryToWorldBook(summaryId, uploadOptions);

            if (result.success) {
                this.showNotification(`âœ… ${result.message}`, 'success');

                // åˆ·æ–°æ€»ç»“å†å²æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                await this.loadSummaryHistory();

                // é‡æ–°é€‰ä¸­å½“å‰æ€»ç»“
                if (historySelect) {
                    historySelect.value = summaryId;
                    this.showSummaryContent(summaryId);
                }
            } else {
                this.showNotification(`âŒ ${result.message}`, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸Šä¼ æ€»ç»“åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
            this.showNotification(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    /**
     * ğŸš€ å¤„ç†æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦
     */
    async handleBatchUploadToWorldBook() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¤„ç†æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦...');

            // ç¡®è®¤æ“ä½œ
            const confirmed = confirm('ç¡®å®šè¦å°†å½“å‰èŠå¤©çš„æ‰€æœ‰æ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦å—ï¼Ÿ\n\nè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');
            if (!confirmed) {
                return;
            }

            // è·å–æ‰€æœ‰æ€»ç»“
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('SummaryManageræœªåˆå§‹åŒ–');
            }

            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            if (!allSummaries || allSummaries.length === 0) {
                this.showNotification('å½“å‰èŠå¤©æ²¡æœ‰æ€»ç»“è®°å½•', 'info');
                return;
            }

            // è·å–ä¸Šä¼ é…ç½®
            const uploadOptions = this.getWorldBookUploadOptions();

            // æ˜¾ç¤ºè¿›åº¦
            this.showNotification(`å¼€å§‹æ‰¹é‡ä¸Šä¼  ${allSummaries.length} æ¡æ€»ç»“...`, 'info');

            // æå–æ‰€æœ‰æ€»ç»“ID
            const summaryIds = allSummaries.map(s => s.id);

            // æ‰§è¡Œæ‰¹é‡ä¸Šä¼ 
            const result = await summaryManager.batchUploadSummariesToWorldBook(summaryIds, uploadOptions);

            if (result.success) {
                const { success, failed, total } = result.results;
                this.showNotification(`âœ… æ‰¹é‡ä¸Šä¼ å®Œæˆ: ${success.length}/${total} æˆåŠŸ${failed.length > 0 ? `, ${failed.length} å¤±è´¥` : ''}`, 'success');

                // åˆ·æ–°æ€»ç»“å†å²
                await this.loadSummaryHistory();
            } else {
                this.showNotification(`âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥: ${result.message}`, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
            this.showNotification(`âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    /**
     * ğŸ”§ è·å–ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®é€‰é¡¹
     */
    getWorldBookUploadOptions() {
        try {
            const entryFormat = this.modal.querySelector('#worldbook-entry-format')?.value || 'auto';
            const customName = this.modal.querySelector('#worldbook-custom-name')?.value || '';
            const addTimestamp = this.modal.querySelector('#worldbook-add-timestamp')?.checked !== false;
            const useContentTags = this.modal.querySelector('#worldbook-use-tags')?.checked !== false;

            return {
                autoCreateWorldBook: true,
                bindToChatLore: true,
                entryNameFormat: entryFormat,
                customEntryName: entryFormat === 'custom' ? customName : null,
                addTimestamp: addTimestamp,
                useContentTags: useContentTags
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®å¤±è´¥:', error);
            return {
                autoCreateWorldBook: true,
                bindToChatLore: true,
                entryNameFormat: 'auto',
                customEntryName: null,
                addTimestamp: true,
                useContentTags: true
            };
        }
    }

    /**
     * ğŸ” å¤„ç†å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleVectorizedMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ” å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ·±åº¦è®°å¿†ç®¡ç†å™¨ä¾èµ–
            if (enabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

                if (!deepMemoryEnabled) {
                    // æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼Œæé†’ç”¨æˆ·
                    const confirmEnable = confirm(
                        'âš ï¸ è¯­ä¹‰æœç´¢åŠŸèƒ½ä¾èµ–æé†’\n\n' +
                        'è¯­ä¹‰æœç´¢åŠŸèƒ½éœ€è¦é…åˆ"æ·±åº¦è®°å¿†ç®¡ç†å™¨"ä¸€èµ·ä½¿ç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚\n\n' +
                        'å½“å‰æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼Œè¯­ä¹‰æœç´¢å°†æ— æ³•æ£€ç´¢åˆ°è®°å¿†æ•°æ®ã€‚\n\n' +
                        'æ˜¯å¦åŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨ï¼Ÿ\n\n' +
                        'ç‚¹å‡»"ç¡®å®š"å°†åŒæ—¶å¯ç”¨ä¸¤ä¸ªåŠŸèƒ½\n' +
                        'ç‚¹å‡»"å–æ¶ˆ"å°†åªå¯ç”¨è¯­ä¹‰æœç´¢ï¼ˆä½†åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼‰'
                    );

                    if (confirmEnable) {
                        // ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        console.log('[InfoBarSettings] ğŸ”§ ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨');

                        // å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        if (deepMemoryManager) {
                            deepMemoryManager.updateSettings({
                                enabled: true
                            });
                        }

                        // æ›´æ–°UIä¸­çš„æ·±åº¦è®°å¿†ç®¡ç†å™¨å¤é€‰æ¡†
                        const deepMemoryCheckbox = this.modal.querySelector('#memory-deep-memory-enabled');
                        if (deepMemoryCheckbox) {
                            deepMemoryCheckbox.checked = true;
                        }

                        this.showMessage(
                            'âœ… å·²åŒæ—¶å¯ç”¨è¯­ä¹‰æœç´¢å’Œæ·±åº¦è®°å¿†ç®¡ç†å™¨',
                            'success'
                        );
                    } else {
                        // ç”¨æˆ·å–æ¶ˆï¼Œåªå¯ç”¨è¯­ä¹‰æœç´¢ï¼Œä½†æ˜¾ç¤ºè­¦å‘Š
                        console.warn('[InfoBarSettings] âš ï¸ ç”¨æˆ·é€‰æ‹©åªå¯ç”¨è¯­ä¹‰æœç´¢ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨');
                        this.showMessage(
                            'âš ï¸ è¯­ä¹‰æœç´¢å·²å¯ç”¨ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼ŒåŠŸèƒ½å°†æ— æ³•æ­£å¸¸å·¥ä½œ',
                            'warning'
                        );
                    }
                }
            }

            // æ˜¾ç¤º/éšè—å‘é‡åŒ–è®°å¿†é€‰é¡¹
            const vectorizedMemoryOptions = this.modal.querySelectorAll('.vectorized-memory-options');
            vectorizedMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    enabled: enabled
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨æ²¡æœ‰æ˜¾ç¤ºä¾èµ–æé†’çš„æƒ…å†µä¸‹æ‰æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

            if (!enabled || deepMemoryEnabled) {
                this.showMessage(
                    enabled ? 'âœ… è¯­ä¹‰æœç´¢å·²å¯ç”¨' : 'âŒ è¯­ä¹‰æœç´¢å·²ç¦ç”¨',
                    enabled ? 'success' : 'info'
                );
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†è®°å¿†å¢å¼ºé¢æ¿çš„å‘é‡åŒ–å¼•æ“å˜åŒ–
     */
    handleMemoryVectorEngineChange(engine) {
        try {
            console.log('[InfoBarSettings] ğŸš€ è®°å¿†å¢å¼ºé¢æ¿ - å‘é‡åŒ–å¼•æ“å˜åŒ–:', engine);

            // æ˜¾ç¤º/éšè—å¯¹åº”çš„æç¤ºä¿¡æ¯
            const hintElement = this.modal.querySelector('#vector-engine-hint');
            const hintTextElement = this.modal.querySelector('#vector-engine-hint-text');
            
            if (hintElement) {
                if (engine === 'custom') {
                    hintElement.style.display = 'block';
                    if (hintTextElement) {
                        hintTextElement.innerHTML = `
                            ğŸ’¡ <strong>è‡ªå®šä¹‰å‘é‡åŒ–APIï¼š</strong>ä½¿ç”¨æ‚¨åœ¨"è‡ªå®šä¹‰API"é¢æ¿é…ç½®çš„å‘é‡åŒ–APIè¿›è¡Œå‘é‡è®¡ç®—<br>
                            <span style="color: #666;">è¯·å‰å¾€"è‡ªå®šä¹‰API"é¢æ¿ â†’ ç‚¹å‡»"ğŸ§  å‘é‡åŒ–API"æŒ‰é’®è¿›è¡Œé…ç½®</span>
                        `;
                    }
                } else if (engine === 'local') {
                    hintElement.style.display = 'block';
                    if (hintTextElement) {
                        hintTextElement.innerHTML = `
                            ğŸ’¡ <strong>Transformers.js (æœ¬åœ°)ï¼š</strong>ä½¿ç”¨æµè§ˆå™¨å†…çš„æœ¬åœ°å¼•æ“è®¡ç®—å‘é‡<br>
                            <span style="color: #666;">æ— éœ€é¢å¤–é…ç½®ï¼Œå®Œå…¨ç¦»çº¿å¯ç”¨ï¼Œä½†é¦–æ¬¡åŠ è½½éœ€è¦ä¸‹è½½æ¨¡å‹æ–‡ä»¶</span>
                        `;
                    }
                } else {
                    hintElement.style.display = 'none';
                }
            }

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    vectorEngine: engine
                });
                console.log('[InfoBarSettings] âœ… å·²åŒæ­¥å‘é‡åŒ–å¼•æ“è®¾ç½®åˆ°æ¨¡å—');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡åŒ–å¼•æ“å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ” å¤„ç†å‘é‡åŒ–å¼•æ“å˜åŒ–ï¼ˆæ€»ç»“é¢æ¿ï¼‰
     */
    handleVectorEngineChange(engine) {
        try {
            console.log('[InfoBarSettings] ğŸš€ å‘é‡åŒ–å¼•æ“å˜åŒ–:', engine);

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    vectorEngine: engine
                });
            }

            this.showMessage(
                `âœ… å‘é‡åŒ–å¼•æ“å·²åˆ‡æ¢ä¸º: ${engine === 'transformers' ? 'Transformers.js (æœ¬åœ°)' : 'OpenAI (åœ¨çº¿)'}`,
                'success'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡åŒ–å¼•æ“å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šå¤„ç†å‘é‡å­˜å‚¨æ¨¡å¼å˜åŒ–
     */
    handleVectorStorageModeChange(mode, silent = false) {
        try {
            console.log('[InfoBarSettings] ğŸ“¦ å‘é‡å­˜å‚¨æ¨¡å¼å˜åŒ–:', mode);

            // æ›´æ–°æç¤ºæ–‡æœ¬
            const hintText = this.modal.querySelector('#vector-storage-hint-text');
            if (hintText) {
                switch (mode) {
                    case 'local':
                        hintText.innerHTML = '<strong>èŠå¤©æ–‡ä»¶å­˜å‚¨ï¼š</strong>å‘é‡æ•°æ®å­˜å‚¨åœ¨èŠå¤©æ–‡ä»¶ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼Œä½†æ•°æ®é‡å¤§æ—¶å¯èƒ½å½±å“æ€§èƒ½ã€‚';
                        break;
                    case 'native':
                        hintText.innerHTML = '<strong>åŸç”Ÿå‘é‡APIï¼š</strong>ä½¿ç”¨SillyTavernå†…ç½®çš„å‘é‡APIï¼Œæ€§èƒ½æœ€ä¼˜ï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®ã€‚éœ€è¦å®‰è£…å¹¶é…ç½®å‘é‡æ‰©å±•ã€‚';
                        break;
                    case 'custom':
                        hintText.innerHTML = '<strong>è‡ªå®šä¹‰å‘é‡APIï¼š</strong>ä½¿ç”¨å¤–éƒ¨å‘é‡åŒ–APIæœåŠ¡ï¼Œçµæ´»æ€§é«˜ã€‚éœ€è¦é…ç½®APIåœ°å€å’Œå¯†é’¥ã€‚';
                        break;
                }
            }

            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰APIé…ç½®é€‰é¡¹
            const customApiOptions = this.modal.querySelectorAll('.custom-vector-api-options');
            customApiOptions.forEach(option => {
                option.style.display = mode === 'custom' ? 'block' : 'none';
            });

            // ğŸš€ æ–°å¢ï¼šæ˜¾ç¤º/éšè—æœ¬åœ°å­˜å‚¨å¤§å°é™åˆ¶é€‰é¡¹
            const localStorageOptions = this.modal.querySelectorAll('.local-storage-options');
            localStorageOptions.forEach(option => {
                option.style.display = mode === 'local' ? 'block' : 'none';
            });

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                const settings = {
                    useLocalStorage: mode === 'local',
                    useNativeVectorAPI: mode === 'native',
                    useCustomVectorAPI: mode === 'custom'
                };

                vectorizedMemoryRetrieval.updateSettings(settings);

                console.log('[InfoBarSettings] âœ… å‘é‡å­˜å‚¨æ¨¡å¼å·²æ›´æ–°:', settings);
            }

            // ğŸ”§ ä¿®å¤ï¼šåªåœ¨éé™é»˜æ¨¡å¼ä¸‹æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            if (!silent) {
                const modeNames = {
                    'local': 'èŠå¤©æ–‡ä»¶å­˜å‚¨',
                    'native': 'åŸç”Ÿå‘é‡API',
                    'custom': 'è‡ªå®šä¹‰å‘é‡API'
                };

                this.showMessage(
                    `âœ… å‘é‡å­˜å‚¨æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${modeNames[mode]}`,
                    'success'
                );
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡å­˜å‚¨æ¨¡å¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šå¤„ç†è‡ªå®šä¹‰å‘é‡APIé…ç½®å˜åŒ–
     */
    handleCustomVectorApiConfigChange() {
        try {
            const apiUrl = this.modal.querySelector('#memory-custom-vector-api-url')?.value || '';
            const apiKey = this.modal.querySelector('#memory-custom-vector-api-key')?.value || '';
            const model = this.modal.querySelector('#memory-custom-vector-model')?.value || '';

            console.log('[InfoBarSettings] ğŸ”§ è‡ªå®šä¹‰å‘é‡APIé…ç½®å˜åŒ–');

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    customVectorAPI: {
                        url: apiUrl,
                        apiKey: apiKey,
                        model: model
                    }
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªå®šä¹‰å‘é‡APIé…ç½®å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šå¤„ç†å‘é‡å­˜å‚¨å¤§å°é™åˆ¶å˜åŒ–
     */
    handleVectorStorageSizeLimitChange(sizeLimit) {
        try {
            console.log('[InfoBarSettings] ğŸ“ å‘é‡å­˜å‚¨å¤§å°é™åˆ¶å˜åŒ–:', sizeLimit, 'MB');

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    storageSizeLimit: sizeLimit
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡å­˜å‚¨å¤§å°é™åˆ¶å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†è‡ªå®šä¹‰å‘é‡æ¨¡å‹å˜åŒ–
     */
    handleCustomVectorModelChange(modelId) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ è‡ªå®šä¹‰å‘é‡æ¨¡å‹å˜åŒ–:', modelId);

            const apiUrl = this.modal.querySelector('#memory-custom-vector-api-url')?.value || '';
            const apiKey = this.modal.querySelector('#memory-custom-vector-api-key')?.value || '';

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval && vectorizedMemoryRetrieval.customVectorAPI) {
                vectorizedMemoryRetrieval.customVectorAPI.updateConfig({
                    url: apiUrl,
                    apiKey: apiKey,
                    model: modelId
                });

                vectorizedMemoryRetrieval.updateSettings({
                    customVectorAPI: {
                        url: apiUrl,
                        apiKey: apiKey,
                        model: modelId
                    }
                });

                this.showNotification(`âœ… å·²é€‰æ‹©æ¨¡å‹: ${modelId}`, 'success');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªå®šä¹‰å‘é‡æ¨¡å‹å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åˆ·æ–°è‡ªå®šä¹‰å‘é‡APIæ¨¡å‹åˆ—è¡¨
     */
    async refreshCustomVectorModels() {
        try {
            const statusDiv = this.modal.querySelector('#custom-vector-model-status');
            const modelSelect = this.modal.querySelector('#memory-custom-vector-model');
            const refreshBtn = this.modal.querySelector('#refresh-custom-vector-models');

            if (!modelSelect) return;

            // è·å–é…ç½®
            const apiUrl = this.modal.querySelector('#memory-custom-vector-api-url')?.value || '';
            const apiKey = this.modal.querySelector('#memory-custom-vector-api-key')?.value || '';

            if (!apiUrl || !apiKey) {
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #F44336;">âš ï¸ è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥</span>';
                }
                this.showNotification('è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥', 'warning');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (refreshBtn) refreshBtn.disabled = true;
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #2196F3;">ğŸ”„ æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</span>';
            }

            // è·å–å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿ
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;

            if (!vectorizedMemoryRetrieval || !vectorizedMemoryRetrieval.customVectorAPI) {
                throw new Error('è‡ªå®šä¹‰å‘é‡APIé€‚é…å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°é…ç½®å¹¶è·å–æ¨¡å‹
            vectorizedMemoryRetrieval.customVectorAPI.updateConfig({
                url: apiUrl,
                apiKey: apiKey
            });

            const embeddingModels = await vectorizedMemoryRetrieval.customVectorAPI.getEmbeddingModels(true);

            // æ›´æ–°ä¸‹æ‹‰æ¡†
            modelSelect.innerHTML = '';

            if (embeddingModels.length === 0) {
                modelSelect.innerHTML = '<option value="">-- æœªæ‰¾åˆ°embeddingæ¨¡å‹ --</option>';
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #FF9800;">âš ï¸ æœªæ‰¾åˆ°embeddingæ¨¡å‹</span>';
                }
            } else {
                embeddingModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                });

                // é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
                if (embeddingModels.length > 0) {
                    modelSelect.value = embeddingModels[0].id;
                    this.handleCustomVectorModelChange(embeddingModels[0].id);
                }

                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #4CAF50;">âœ… æˆåŠŸè·å– ${embeddingModels.length} ä¸ªæ¨¡å‹</span>`;
                }
                this.showNotification(`âœ… æˆåŠŸè·å– ${embeddingModels.length} ä¸ªembeddingæ¨¡å‹`, 'success');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°è‡ªå®šä¹‰å‘é‡æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            
            const statusDiv = this.modal.querySelector('#custom-vector-model-status');
            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #F44336;">âŒ è·å–å¤±è´¥: ${error.message}</span>`;
            }
            
            this.showNotification(`âŒ è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
        } finally {
            const refreshBtn = this.modal.querySelector('#refresh-custom-vector-models');
            if (refreshBtn) refreshBtn.disabled = false;
        }
    }

    /**
     * ğŸ†• æµ‹è¯•è‡ªå®šä¹‰å‘é‡APIè¿æ¥
     */
    async testCustomVectorConnection() {
        try {
            const statusDiv = this.modal.querySelector('#custom-vector-model-status');
            const testBtn = this.modal.querySelector('#test-custom-vector-connection');

            // è·å–é…ç½®
            const apiUrl = this.modal.querySelector('#memory-custom-vector-api-url')?.value || '';
            const apiKey = this.modal.querySelector('#memory-custom-vector-api-key')?.value || '';
            const model = this.modal.querySelector('#memory-custom-vector-model')?.value || '';

            if (!apiUrl || !apiKey) {
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #F44336;">âš ï¸ è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥</span>';
                }
                this.showNotification('è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥', 'warning');
                return;
            }

            // æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
            if (testBtn) testBtn.disabled = true;
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #2196F3;">ğŸ” æ­£åœ¨æµ‹è¯•è¿æ¥...</span>';
            }

            // è·å–å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿ
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;

            if (!vectorizedMemoryRetrieval || !vectorizedMemoryRetrieval.customVectorAPI) {
                throw new Error('è‡ªå®šä¹‰å‘é‡APIé€‚é…å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°é…ç½®å¹¶æµ‹è¯•
            vectorizedMemoryRetrieval.customVectorAPI.updateConfig({
                url: apiUrl,
                apiKey: apiKey,
                model: model
            });

            const result = await vectorizedMemoryRetrieval.customVectorAPI.testConnectionAndGetModels();

            if (result.success) {
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #4CAF50;">âœ… è¿æ¥æˆåŠŸï¼å‘é‡ç»´åº¦: ${result.vectorDimensions}, å¯ç”¨æ¨¡å‹: ${result.modelCount}ä¸ª</span>`;
                }
                this.showNotification(`âœ… ${result.message}`, 'success');

                // è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                if (result.embeddingModels && result.embeddingModels.length > 0) {
                    const modelSelect = this.modal.querySelector('#memory-custom-vector-model');
                    if (modelSelect) {
                        modelSelect.innerHTML = '';
                        result.embeddingModels.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m.id;
                            option.textContent = m.id;
                            if (m.id === result.currentModel) {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                    }
                }
            } else {
                throw new Error(result.error || 'è¿æ¥å¤±è´¥');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•è‡ªå®šä¹‰å‘é‡APIè¿æ¥å¤±è´¥:', error);
            
            const statusDiv = this.modal.querySelector('#custom-vector-model-status');
            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #F44336;">âŒ è¿æ¥å¤±è´¥: ${error.message}</span>`;
            }
            
            this.showNotification(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        } finally {
            const testBtn = this.modal.querySelector('#test-custom-vector-connection');
            if (testBtn) testBtn.disabled = false;
        }
    }

    /**
     * ğŸ” å¤„ç†ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–
     */
    handleSimilarityThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-similarity-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    similarityThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ” å¤„ç†æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–
     */
    handleMaxSearchResultsChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ“Š æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–:', value);

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    maxResults: parseInt(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleDeepMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—æ·±åº¦è®°å¿†é€‰é¡¹
            const deepMemoryOptions = this.modal.querySelectorAll('.deep-memory-options');
            deepMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    enabled: enabled
                });
            }

            this.showMessage(
                enabled ? 'âœ… æ·±åº¦è®°å¿†ç®¡ç†å·²å¯ç”¨' : 'âŒ æ·±åº¦è®°å¿†ç®¡ç†å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è‡ªåŠ¨è®°å¿†è¿ç§»å˜åŒ–
     */
    handleAutoMemoryMigrationChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨è®°å¿†è¿ç§»çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    autoMemoryMigration: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªåŠ¨è®°å¿†è¿ç§»å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–
     */
    handleMemoryImportanceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-memory-importance-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    shortTermToLongTermThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†å†²çªè§£å†³å˜åŒ–
     */
    handleMemoryConflictResolutionChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ è®°å¿†å†²çªè§£å†³çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    memoryConflictResolution: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†å†²çªè§£å†³å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–
     */
    handleMemoryCapacityChange(inputId, value) {
        try {
            console.log('[InfoBarSettings] ğŸ“Š è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–:', inputId, value);

            const capacityMap = {
                'content-sensory-capacity': 'sensoryMemoryCapacity',
                'content-short-term-capacity': 'shortTermMemoryCapacity',
                'content-long-term-capacity': 'longTermMemoryCapacity',
                'content-deep-archive-capacity': 'deepArchiveCapacity'
            };

            const settingKey = capacityMap[inputId];
            if (!settingKey) return;

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    [settingKey]: parseInt(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleIntelligentClassifierEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ·±åº¦è®°å¿†ç®¡ç†å™¨ä¾èµ–
            if (enabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

                if (!deepMemoryEnabled) {
                    // æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼Œæé†’ç”¨æˆ·
                    const confirmEnable = confirm(
                        'âš ï¸ æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨åŠŸèƒ½ä¾èµ–æé†’\n\n' +
                        'æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨éœ€è¦é…åˆ"æ·±åº¦è®°å¿†ç®¡ç†å™¨"ä¸€èµ·ä½¿ç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚\n\n' +
                        'å½“å‰æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å°†æ— æ³•å¯¹è®°å¿†è¿›è¡Œåˆ†ç±»å’Œç®¡ç†ã€‚\n\n' +
                        'æ˜¯å¦åŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨ï¼Ÿ\n\n' +
                        'ç‚¹å‡»"ç¡®å®š"å°†åŒæ—¶å¯ç”¨ä¸¤ä¸ªåŠŸèƒ½\n' +
                        'ç‚¹å‡»"å–æ¶ˆ"å°†åªå¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨ï¼ˆä½†åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼‰'
                    );

                    if (confirmEnable) {
                        // ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        console.log('[InfoBarSettings] ğŸ”§ ç”¨æˆ·ç¡®è®¤ï¼ŒåŒæ—¶å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨');

                        // å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†å™¨
                        if (deepMemoryManager) {
                            deepMemoryManager.updateSettings({
                                enabled: true
                            });
                        }

                        // æ›´æ–°UIä¸­çš„æ·±åº¦è®°å¿†ç®¡ç†å™¨å¤é€‰æ¡†
                        const deepMemoryCheckbox = this.modal.querySelector('#memory-deep-memory-enabled');
                        if (deepMemoryCheckbox) {
                            deepMemoryCheckbox.checked = true;
                        }

                        this.showMessage(
                            'âœ… å·²åŒæ—¶å¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å’Œæ·±åº¦è®°å¿†ç®¡ç†å™¨',
                            'success'
                        );
                    } else {
                        // ç”¨æˆ·å–æ¶ˆï¼Œåªå¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨ï¼Œä½†æ˜¾ç¤ºè­¦å‘Š
                        console.warn('[InfoBarSettings] âš ï¸ ç”¨æˆ·é€‰æ‹©åªå¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨');
                        this.showMessage(
                            'âš ï¸ æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å·²å¯ç”¨ï¼Œä½†æ·±åº¦è®°å¿†ç®¡ç†å™¨æœªå¯ç”¨ï¼ŒåŠŸèƒ½å°†æ— æ³•æ­£å¸¸å·¥ä½œ',
                            'warning'
                        );
                    }
                }
            }

            // æ˜¾ç¤º/éšè—æ™ºèƒ½åˆ†ç±»å™¨é€‰é¡¹
            const intelligentClassifierOptions = this.modal.querySelectorAll('.intelligent-classifier-options');
            intelligentClassifierOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    enabled: enabled
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨æ²¡æœ‰æ˜¾ç¤ºä¾èµ–æé†’çš„æƒ…å†µä¸‹æ‰æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            const deepMemoryEnabled = deepMemoryManager?.settings?.enabled;

            if (!enabled || deepMemoryEnabled) {
                this.showMessage(
                    enabled ? 'âœ… æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å·²å¯ç”¨' : 'âŒ æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å·²ç¦ç”¨',
                    enabled ? 'success' : 'info'
                );
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†è¯­ä¹‰èšç±»åˆ†æå˜åŒ–
     */
    handleSemanticClusteringChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ” è¯­ä¹‰èšç±»åˆ†æçŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    semanticClustering: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è¯­ä¹‰èšç±»åˆ†æå˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†æ—¶åºæ¨¡å¼è¯†åˆ«å˜åŒ–
     */
    handleTemporalPatternRecognitionChange(enabled) {
        try {
            console.log('[InfoBarSettings] â° æ—¶åºæ¨¡å¼è¯†åˆ«çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    temporalPatternRecognition: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ—¶åºæ¨¡å¼è¯†åˆ«å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†é‡è¦æ€§é¢„æµ‹å˜åŒ–
     */
    handleImportancePredictionChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ é‡è¦æ€§é¢„æµ‹çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    importancePrediction: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é‡è¦æ€§é¢„æµ‹å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–
     */
    handleClassificationConfidenceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-classification-confidence-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    classificationConfidenceThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†è‡ªé€‚åº”å­¦ä¹ å˜åŒ–
     */
    handleAdaptiveLearningChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  è‡ªé€‚åº”å­¦ä¹ çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    adaptationEnabled: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªé€‚åº”å­¦ä¹ å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿå¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleMemoryMaintenanceEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿå¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            const infoBarTool = window.SillyTavernInfobar;
            const memoryMaintenanceSystem = infoBarTool?.modules?.memoryMaintenanceSystem;
            if (memoryMaintenanceSystem) {
                memoryMaintenanceSystem.settings.enabled = enabled;
                console.log('[InfoBarSettings] âœ… è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿè®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿå·²å¯ç”¨' : 'âŒ è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿå·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†è‡ªåŠ¨ç»´æŠ¤ç³»ç»Ÿå¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleContextualRetrievalEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ” ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            const infoBarTool = window.SillyTavernInfobar;
            const contextualRetrieval = infoBarTool?.modules?.contextualRetrieval;
            if (contextualRetrieval) {
                contextualRetrieval.settings.enabled = enabled;
                console.log('[InfoBarSettings] âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢è®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢å·²å¯ç”¨' : 'âŒ ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†ç”¨æˆ·ç”»åƒç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleUserProfileEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ‘¤ ç”¨æˆ·ç”»åƒç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            const infoBarTool = window.SillyTavernInfobar;
            const userProfileManager = infoBarTool?.modules?.userProfileManager;
            if (userProfileManager) {
                userProfileManager.settings.enabled = enabled;
                console.log('[InfoBarSettings] âœ… ç”¨æˆ·ç”»åƒç®¡ç†è®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… ç”¨æˆ·ç”»åƒç®¡ç†å·²å¯ç”¨' : 'âŒ ç”¨æˆ·ç”»åƒç®¡ç†å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç”¨æˆ·ç”»åƒç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†çŸ¥è¯†å›¾è°±ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleKnowledgeGraphEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            const infoBarTool = window.SillyTavernInfobar;
            const knowledgeGraphManager = infoBarTool?.modules?.knowledgeGraphManager;
            if (knowledgeGraphManager) {
                knowledgeGraphManager.settings.enabled = enabled;
                console.log('[InfoBarSettings] âœ… çŸ¥è¯†å›¾è°±ç®¡ç†è®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… çŸ¥è¯†å›¾è°±ç®¡ç†å·²å¯ç”¨' : 'âŒ çŸ¥è¯†å›¾è°±ç®¡ç†å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†çŸ¥è¯†å›¾è°±ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†æ—¶é—´æ„ŸçŸ¥è®°å¿†å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleTimeAwareEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] â° æ—¶é—´æ„ŸçŸ¥è®°å¿†å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            const infoBarTool = window.SillyTavernInfobar;
            const timeAwareMemoryManager = infoBarTool?.modules?.timeAwareMemoryManager;
            if (timeAwareMemoryManager) {
                timeAwareMemoryManager.settings.enabled = enabled;
                console.log('[InfoBarSettings] âœ… æ—¶é—´æ„ŸçŸ¥è®°å¿†è®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… æ—¶é—´æ„ŸçŸ¥è®°å¿†å·²å¯ç”¨' : 'âŒ æ—¶é—´æ„ŸçŸ¥è®°å¿†å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ—¶é—´æ„ŸçŸ¥è®°å¿†å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†SillyTavernæ·±åº¦é›†æˆå¯ç”¨çŠ¶æ€å˜åŒ–
     */
    async handleSTIntegrationEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”— SillyTavernæ·±åº¦é›†æˆå¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // ğŸ”§ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

            const infoBarTool = window.SillyTavernInfobar;
            const sillyTavernIntegration = infoBarTool?.modules?.sillyTavernIntegration;
            if (sillyTavernIntegration && typeof sillyTavernIntegration.updateSettings === 'function') {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨updateSettingsæ–¹æ³•æ›´æ–°è®¾ç½®
                await sillyTavernIntegration.updateSettings({ enabled: enabled });
                console.log('[InfoBarSettings] âœ… SillyTavernæ·±åº¦é›†æˆè®¾ç½®å·²æ›´æ–°');
            }

            this.showMessage(
                enabled ? 'âœ… SillyTavernæ·±åº¦é›†æˆå·²å¯ç”¨' : 'âŒ SillyTavernæ·±åº¦é›†æˆå·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†SillyTavernæ·±åº¦é›†æˆå¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶
     */
    bindMemoryEnhancementEvents() {
        try {
            // ğŸ¯ çŠ¶æ€åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshStatusBtn = this.modal.querySelector('#refresh-memory-status');
            if (refreshStatusBtn) {
                refreshStatusBtn.addEventListener('click', () => {
                    this.refreshMemoryStatus();
                });
            }

            // AIè®°å¿†æ€»ç»“äº‹ä»¶
            const memoryAiMemoryEnabled = this.modal.querySelector('#memory-ai-memory-enabled');
            if (memoryAiMemoryEnabled) {
                memoryAiMemoryEnabled.addEventListener('change', (e) => {
                    this.handleAIMemoryEnabledChange(e.target.checked);
                });
            }

            const memoryAiMessageLevel = this.modal.querySelector('#memory-ai-message-level-summary');
            if (memoryAiMessageLevel) {
                memoryAiMessageLevel.addEventListener('change', (e) => {
                    this.handleAIMessageLevelChange(e.target.checked);
                });
            }

            // ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“äº‹ä»¶
            const memoryAiDatabaseEnabled = this.modal.querySelector('#memory-ai-memory-database-enabled');
            if (memoryAiDatabaseEnabled) {
                memoryAiDatabaseEnabled.addEventListener('change', (e) => {
                    this.handleAIMemoryDatabaseEnabledChange(e.target.checked);
                });
            }

            const memoryAiDbMaxResults = this.modal.querySelector('#memory-ai-db-max-results');
            const memoryAiDbMaxResultsValue = this.modal.querySelector('#memory-ai-db-max-results-value');
            if (memoryAiDbMaxResults && memoryAiDbMaxResultsValue) {
                memoryAiDbMaxResults.addEventListener('input', (e) => {
                    memoryAiDbMaxResultsValue.textContent = e.target.value;
                });
            }

            const memoryAiDbMinImportance = this.modal.querySelector('#memory-ai-db-min-importance');
            const memoryAiDbMinImportanceValue = this.modal.querySelector('#memory-ai-db-min-importance-value');
            if (memoryAiDbMinImportance && memoryAiDbMinImportanceValue) {
                memoryAiDbMinImportance.addEventListener('input', (e) => {
                    memoryAiDbMinImportanceValue.textContent = (parseFloat(e.target.value) * 100).toFixed(0) + '%';
                });
            }

            // ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹äº‹ä»¶
            const memoryStoryPlanningEnabled = this.modal.querySelector('#memory-story-planning-enabled');
            if (memoryStoryPlanningEnabled) {
                memoryStoryPlanningEnabled.addEventListener('change', (e) => {
                    this.handleStoryPlanningEnabledChange(e.target.checked);
                });
            }

            const memorySpMaxKeywords = this.modal.querySelector('#memory-sp-max-keywords');
            const memorySpMaxKeywordsValue = this.modal.querySelector('#memory-sp-max-keywords-value');
            if (memorySpMaxKeywords && memorySpMaxKeywordsValue) {
                memorySpMaxKeywords.addEventListener('input', (e) => {
                    memorySpMaxKeywordsValue.textContent = e.target.value;
                });
            }

            const memorySpMaxMemories = this.modal.querySelector('#memory-sp-max-memories');
            const memorySpMaxMemoriesValue = this.modal.querySelector('#memory-sp-max-memories-value');
            if (memorySpMaxMemories && memorySpMaxMemoriesValue) {
                memorySpMaxMemories.addEventListener('input', (e) => {
                    memorySpMaxMemoriesValue.textContent = e.target.value;
                });
            }

            const memorySpMinImportance = this.modal.querySelector('#memory-sp-min-importance');
            const memorySpMinImportanceValue = this.modal.querySelector('#memory-sp-min-importance-value');
            if (memorySpMinImportance && memorySpMinImportanceValue) {
                memorySpMinImportance.addEventListener('input', (e) => {
                    memorySpMinImportanceValue.textContent = (parseFloat(e.target.value) * 100).toFixed(0) + '%';
                });
            }

            // ğŸ”§ è¯­ä¹‰æœç´¢åŠŸèƒ½å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨å‘é‡åŠŸèƒ½é¢æ¿çš„AIè‡ªåŠ¨æ£€ç´¢

            // æ·±åº¦è®°å¿†ç®¡ç†äº‹ä»¶
            const memoryDeepMemoryEnabled = this.modal.querySelector('#memory-deep-memory-enabled');
            if (memoryDeepMemoryEnabled) {
                memoryDeepMemoryEnabled.addEventListener('change', (e) => {
                    this.handleDeepMemoryEnabledChange(e.target.checked);
                });
            }

            const memoryAutoMemoryMigration = this.modal.querySelector('#memory-auto-memory-migration');
            if (memoryAutoMemoryMigration) {
                memoryAutoMemoryMigration.addEventListener('change', (e) => {
                    this.handleAutoMemoryMigrationChange(e.target.checked);
                });
            }

            const memoryMemoryConflictResolution = this.modal.querySelector('#memory-memory-conflict-resolution');
            if (memoryMemoryConflictResolution) {
                memoryMemoryConflictResolution.addEventListener('change', (e) => {
                    this.handleMemoryConflictResolutionChange(e.target.checked);
                });
            }

            // æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨äº‹ä»¶
            const memoryIntelligentClassifierEnabled = this.modal.querySelector('#memory-intelligent-classifier-enabled');
            if (memoryIntelligentClassifierEnabled) {
                memoryIntelligentClassifierEnabled.addEventListener('change', (e) => {
                    this.handleIntelligentClassifierEnabledChange(e.target.checked);
                });
            }

            const memorySemanticClustering = this.modal.querySelector('#memory-semantic-clustering');
            if (memorySemanticClustering) {
                memorySemanticClustering.addEventListener('change', (e) => {
                    this.handleSemanticClusteringChange(e.target.checked);
                });
            }

            const memoryTemporalPatternRecognition = this.modal.querySelector('#memory-temporal-pattern-recognition');
            if (memoryTemporalPatternRecognition) {
                memoryTemporalPatternRecognition.addEventListener('change', (e) => {
                    this.handleTemporalPatternRecognitionChange(e.target.checked);
                });
            }

            const memoryImportancePrediction = this.modal.querySelector('#memory-importance-prediction');
            if (memoryImportancePrediction) {
                memoryImportancePrediction.addEventListener('change', (e) => {
                    this.handleImportancePredictionChange(e.target.checked);
                });
            }

            const memoryAdaptiveLearning = this.modal.querySelector('#memory-adaptive-learning');
            if (memoryAdaptiveLearning) {
                memoryAdaptiveLearning.addEventListener('change', (e) => {
                    this.handleAdaptiveLearningChange(e.target.checked);
                });
            }

            // ğŸ†• å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—äº‹ä»¶
            const memoryMaintenanceEnabled = this.modal.querySelector('#memory-maintenance-enabled');
            if (memoryMaintenanceEnabled) {
                memoryMaintenanceEnabled.addEventListener('change', (e) => {
                    this.handleMemoryMaintenanceEnabledChange(e.target.checked);
                });
            }

            const contextualRetrievalEnabled = this.modal.querySelector('#contextual-retrieval-enabled');
            if (contextualRetrievalEnabled) {
                contextualRetrievalEnabled.addEventListener('change', (e) => {
                    this.handleContextualRetrievalEnabledChange(e.target.checked);
                });
            }

            const userProfileEnabled = this.modal.querySelector('#user-profile-enabled');
            if (userProfileEnabled) {
                userProfileEnabled.addEventListener('change', (e) => {
                    this.handleUserProfileEnabledChange(e.target.checked);
                });
            }

            const knowledgeGraphEnabled = this.modal.querySelector('#knowledge-graph-enabled');
            if (knowledgeGraphEnabled) {
                knowledgeGraphEnabled.addEventListener('change', (e) => {
                    this.handleKnowledgeGraphEnabledChange(e.target.checked);
                });
            }

            const timeAwareEnabled = this.modal.querySelector('#time-aware-enabled');
            if (timeAwareEnabled) {
                timeAwareEnabled.addEventListener('change', (e) => {
                    this.handleTimeAwareEnabledChange(e.target.checked);
                });
            }

            const stIntegrationEnabled = this.modal.querySelector('#st-integration-enabled');
            if (stIntegrationEnabled) {
                stIntegrationEnabled.addEventListener('change', (e) => {
                    this.handleSTIntegrationEnabledChange(e.target.checked);
                });
            }

            // ğŸ—‘ï¸ æ•°æ®æ¸…ç†æŒ‰é’®äº‹ä»¶
            const cleanupAIMemoryBtn = this.modal.querySelector('#cleanup-ai-memory-database');
            if (cleanupAIMemoryBtn) {
                cleanupAIMemoryBtn.addEventListener('click', () => {
                    this.handleCleanupAIMemoryDatabase();
                });
            }

            const cleanupVectorBtn = this.modal.querySelector('#cleanup-vector-data');
            if (cleanupVectorBtn) {
                cleanupVectorBtn.addEventListener('click', () => {
                    this.handleCleanupVectorData();
                });
            }

            const cleanupDeepMemoryBtn = this.modal.querySelector('#cleanup-deep-memory');
            if (cleanupDeepMemoryBtn) {
                cleanupDeepMemoryBtn.addEventListener('click', () => {
                    this.handleCleanupDeepMemory();
                });
            }

            const cleanupKnowledgeGraphBtn = this.modal.querySelector('#cleanup-knowledge-graph');
            if (cleanupKnowledgeGraphBtn) {
                cleanupKnowledgeGraphBtn.addEventListener('click', () => {
                    this.handleCleanupKnowledgeGraph();
                });
            }

            const cleanupAllBtn = this.modal.querySelector('#cleanup-all-memory-data');
            if (cleanupAllBtn) {
                cleanupAllBtn.addEventListener('click', () => {
                    this.handleCleanupAllMemoryData();
                });
            }

            // ğŸ”§ æ–°å¢ï¼šç›‘å¬AIè®°å¿†æ•°æ®åº“çš„çŠ¶æ€æ›´æ–°äº‹ä»¶
            if (this.eventSystem) {
                // ç›‘å¬æ•°æ®åŠ è½½äº‹ä»¶
                this.eventSystem.on('aiMemoryDatabase:dataLoaded', (data) => {
                    this.handleAIMemoryDatabaseDataChanged(data);
                });

                // ç›‘å¬æ•°æ®ä¿å­˜äº‹ä»¶
                this.eventSystem.on('aiMemoryDatabase:dataSaved', (data) => {
                    this.handleAIMemoryDatabaseDataChanged(data);
                });

                // ç›‘å¬çŠ¶æ€å˜åŒ–äº‹ä»¶
                this.eventSystem.on('aiMemoryDatabase:statusChanged', (data) => {
                    this.handleAIMemoryDatabaseStatusChanged(data);
                });

                console.log('[InfoBarSettings] ğŸ”— å·²ç»‘å®šAIè®°å¿†æ•°æ®åº“è‡ªåŠ¨æ›´æ–°äº‹ä»¶');
            }

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†AIè®°å¿†æ•°æ®åº“æ•°æ®å˜åŒ–äº‹ä»¶
     */
    handleAIMemoryDatabaseDataChanged(data) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ AIè®°å¿†æ•°æ®åº“æ•°æ®å·²å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°UI...', data);
            
            // å¦‚æœè®°å¿†å¢å¼ºé¢æ¿å¯è§ï¼Œè‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            if (this.visible && this.modal) {
                const memoryEnhancementPanel = this.modal.querySelector('[data-content="memoryEnhancement"]');
                if (memoryEnhancementPanel && memoryEnhancementPanel.classList.contains('active')) {
                    // ä½¿ç”¨é˜²æŠ–åˆ·æ–°ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                    this.debouncedRefreshMemoryStatus();
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIè®°å¿†æ•°æ®åº“æ•°æ®å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†AIè®°å¿†æ•°æ®åº“çŠ¶æ€å˜åŒ–äº‹ä»¶
     */
    handleAIMemoryDatabaseStatusChanged(data) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ AIè®°å¿†æ•°æ®åº“çŠ¶æ€å·²å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°UI...', data);
            
            // å¦‚æœè®°å¿†å¢å¼ºé¢æ¿å¯è§ï¼Œè‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            if (this.visible && this.modal) {
                const memoryEnhancementPanel = this.modal.querySelector('[data-content="memoryEnhancement"]');
                if (memoryEnhancementPanel && memoryEnhancementPanel.classList.contains('active')) {
                    // ç›´æ¥æ›´æ–°AIè®°å¿†æ•°æ®åº“çŠ¶æ€ï¼ˆä¸åˆ·æ–°å…¨éƒ¨ï¼‰
                    const aiMemoryDatabase = window.SillyTavernInfobar?.modules?.aiMemoryDatabase || window.__TEST_AIMemoryDatabase;
                    if (aiMemoryDatabase) {
                        const status = aiMemoryDatabase.getStatus();
                        this.updateAIMemoryDatabaseStatus(status);
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIè®°å¿†æ•°æ®åº“çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šé˜²æŠ–åˆ·æ–°è®°å¿†çŠ¶æ€ï¼ˆé¿å…é¢‘ç¹åˆ·æ–°ï¼‰
     */
    debouncedRefreshMemoryStatus() {
        if (this._memoryStatusRefreshTimeout) {
            clearTimeout(this._memoryStatusRefreshTimeout);
        }
        
        this._memoryStatusRefreshTimeout = setTimeout(() => {
            this.refreshMemoryStatus();
        }, 1000); // 1ç§’é˜²æŠ–
    }

    /**
     * ğŸ§  åŠ è½½è®°å¿†å¢å¼ºé¢æ¿è®¾ç½®ï¼ˆæ”¯æŒæ¨¡å—è®¾ç½®ä¸æ‰©å±•è®¾ç½®åŒæ¥æºï¼‰
     */
    async loadMemoryEnhancementSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½è®°å¿†å¢å¼ºè®¾ç½®...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const savedMem = extCfg.memoryEnhancement || {};

            // ğŸš€ AIè®°å¿†æ€»ç»“è®¾ç½®
            const aiSettings = summaryManager?.aiMemorySummarizer?.settings || savedMem.ai || {};
            const aiEnabledEl = this.modal.querySelector('#memory-ai-memory-enabled');
            const aiMsgLevelEl = this.modal.querySelector('#memory-ai-message-level-summary');
            const aiThresholdEl = this.modal.querySelector('#memory-ai-importance-threshold');
            const aiThresholdVal = this.modal.querySelector('#memory-ai-importance-value');
            if (aiEnabledEl) aiEnabledEl.checked = !!aiSettings.enabled;
            if (aiMsgLevelEl) aiMsgLevelEl.checked = !!aiSettings.messageLevelSummary;
            if (aiThresholdEl) {
                const v = typeof aiSettings.importanceThreshold === 'number' ? aiSettings.importanceThreshold : parseFloat(aiThresholdEl.value) || 0.6;
                aiThresholdEl.value = v;
                if (aiThresholdVal) aiThresholdVal.textContent = `${Math.round(v * 100)}%`;
            }
            // æ˜¾ç¤º/éšè—AIè®°å¿†é€‰é¡¹
            this.modal.querySelectorAll('.ai-memory-options').forEach(opt => {
                opt.style.display = aiSettings.enabled ? 'block' : 'none';
            });

            // ğŸ†• æ¢å¤AIè®°å¿†æ€»ç»“APIæ¨¡å¼æŒ‰é’®çŠ¶æ€
            const aiApiMode = aiSettings.apiMode || 'auto';
            const aiMemoryApiModeButtons = this.modal.querySelectorAll('.ai-memory-api-mode-btn');
            aiMemoryApiModeButtons.forEach(btn => {
                const isActive = btn.dataset.mode === aiApiMode;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                }
            });

            // æ›´æ–°AIè®°å¿†æ€»ç»“APIæ¨¡å¼æè¿°æ–‡æœ¬
            const aiAutoDesc = this.modal.querySelector('.ai-memory-mode-description .auto-mode-desc');
            const aiMainDesc = this.modal.querySelector('.ai-memory-mode-description .main-mode-desc');
            const aiCustomDesc = this.modal.querySelector('.ai-memory-mode-description .custom-mode-desc');
            if (aiAutoDesc && aiMainDesc && aiCustomDesc) {
                aiAutoDesc.style.display = aiApiMode === 'auto' ? 'block' : 'none';
                aiMainDesc.style.display = aiApiMode === 'main' ? 'block' : 'none';
                aiCustomDesc.style.display = aiApiMode === 'custom' ? 'block' : 'none';
            }

            console.log('[InfoBarSettings] ğŸ”§ å·²æ¢å¤AIè®°å¿†æ€»ç»“APIæ¨¡å¼æŒ‰é’®çŠ¶æ€:', aiApiMode);

            // ğŸ—„ï¸ AIè®°å¿†æ•°æ®åº“è®¾ç½®
            const aiDatabaseSettings = savedMem.aiDatabase || {};
            const aiDbEnabledEl = this.modal.querySelector('#memory-ai-memory-database-enabled');
            const aiDbAutoIndexingEl = this.modal.querySelector('#memory-ai-db-auto-indexing');
            const aiDbThinkingEl = this.modal.querySelector('#memory-ai-db-thinking-interface');
            const aiDbMaxResultsEl = this.modal.querySelector('#memory-ai-db-max-results');
            const aiDbMaxResultsVal = this.modal.querySelector('#memory-ai-db-max-results-value');
            const aiDbMinImportanceEl = this.modal.querySelector('#memory-ai-db-min-importance');
            const aiDbMinImportanceVal = this.modal.querySelector('#memory-ai-db-min-importance-value');

            if (aiDbEnabledEl) aiDbEnabledEl.checked = !!aiDatabaseSettings.enabled;
            if (aiDbAutoIndexingEl) aiDbAutoIndexingEl.checked = aiDatabaseSettings.autoIndexing !== false;
            if (aiDbThinkingEl) aiDbThinkingEl.checked = aiDatabaseSettings.enableThinkingInterface !== false;
            if (aiDbMaxResultsEl) {
                const v = aiDatabaseSettings.maxSearchResults || 20;
                aiDbMaxResultsEl.value = v;
                if (aiDbMaxResultsVal) aiDbMaxResultsVal.textContent = v;
            }
            if (aiDbMinImportanceEl) {
                const v = aiDatabaseSettings.minImportance || 0.5;
                aiDbMinImportanceEl.value = v;
                if (aiDbMinImportanceVal) aiDbMinImportanceVal.textContent = (v * 100).toFixed(0) + '%';
            }
            // æ˜¾ç¤º/éšè—AIè®°å¿†æ•°æ®åº“é€‰é¡¹
            const aiDbOptions = this.modal.querySelector('#memory-ai-memory-database-options');
            if (aiDbOptions) {
                aiDbOptions.style.display = aiDatabaseSettings.enabled ? 'block' : 'none';
            }

            // ğŸ”§ è¯­ä¹‰æœç´¢åŠŸèƒ½å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨å‘é‡åŠŸèƒ½é¢æ¿çš„AIè‡ªåŠ¨æ£€ç´¢

            // ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†è®¾ç½®
            const deepManager = infoBarTool?.modules?.deepMemoryManager;
            const deepSettings = deepManager?.settings || savedMem.deep || {};
            const deepEnabledEl = this.modal.querySelector('#memory-deep-memory-enabled');
            if (deepEnabledEl) deepEnabledEl.checked = !!deepSettings.enabled;
            this.modal.querySelectorAll('.deep-memory-options').forEach(opt => {
                opt.style.display = deepSettings.enabled ? 'block' : 'none';
            });
            const autoMigEl = this.modal.querySelector('#memory-auto-memory-migration');
            const memImpEl = this.modal.querySelector('#memory-memory-importance-threshold');
            const memImpVal = this.modal.querySelector('#memory-memory-importance-value');
            const confResEl = this.modal.querySelector('#memory-memory-conflict-resolution');
            const capSens = this.modal.querySelector('#memory-sensory-capacity');
            const capShort = this.modal.querySelector('#memory-short-term-capacity');
            const capLong = this.modal.querySelector('#memory-long-term-capacity');
            const capArchive = this.modal.querySelector('#memory-deep-archive-capacity');
            if (autoMigEl) autoMigEl.checked = !!deepSettings.autoMemoryMigration;
            if (memImpEl) {
                const v = typeof deepSettings.memoryImportanceThreshold === 'number' ? deepSettings.memoryImportanceThreshold : parseFloat(memImpEl.value) || 0.6;
                memImpEl.value = v;
                if (memImpVal) memImpVal.textContent = `${Math.round(v * 100)}%`;
            }
            if (confResEl) confResEl.checked = !!deepSettings.memoryConflictResolution;
            if (capSens && deepSettings.capacities?.sensory) capSens.value = deepSettings.capacities.sensory;
            if (capShort && deepSettings.capacities?.shortTerm) capShort.value = deepSettings.capacities.shortTerm;
            if (capLong && deepSettings.capacities?.longTerm) capLong.value = deepSettings.capacities.longTerm;
            if (capArchive && deepSettings.capacities?.deepArchive) capArchive.value = deepSettings.capacities.deepArchive;

            // ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const clf = infoBarTool?.modules?.intelligentMemoryClassifier;
            const clfSettings = clf?.settings || savedMem.classifier || {};
            const clfEnabledEl = this.modal.querySelector('#memory-intelligent-classifier-enabled');
            if (clfEnabledEl) clfEnabledEl.checked = !!clfSettings.enabled;
            this.modal.querySelectorAll('.intelligent-classifier-options').forEach(opt => {
                opt.style.display = clfSettings.enabled ? 'block' : 'none';
            });
            const semClus = this.modal.querySelector('#memory-semantic-clustering');
            const tmpRec = this.modal.querySelector('#memory-temporal-pattern-recognition');
            const impPred = this.modal.querySelector('#memory-importance-prediction');
            const clfConf = this.modal.querySelector('#memory-classification-confidence-threshold');
            const clfConfVal = this.modal.querySelector('#memory-classification-confidence-value');
            const adapLearn = this.modal.querySelector('#memory-adaptive-learning');
            if (semClus) semClus.checked = !!clfSettings.semanticClustering;
            if (tmpRec) tmpRec.checked = !!clfSettings.temporalPatternRecognition;
            if (impPred) impPred.checked = !!clfSettings.importancePrediction;
            if (clfConf) {
                const v = typeof clfSettings.classificationConfidenceThreshold === 'number' ? clfSettings.classificationConfidenceThreshold : parseFloat(clfConf.value) || 0.7;
                clfConf.value = v;
                if (clfConfVal) clfConfVal.textContent = `${Math.round(v * 100)}%`;
            }
            if (adapLearn) adapLearn.checked = !!clfSettings.adaptationEnabled;

            // ğŸ†• å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾ç½®
            const enhancementSettings = savedMem.enhancement || {};

            const memoryMaintenanceEnabled = this.modal.querySelector('#memory-maintenance-enabled');
            const contextualRetrievalEnabled = this.modal.querySelector('#contextual-retrieval-enabled');
            const userProfileEnabled = this.modal.querySelector('#user-profile-enabled');
            const knowledgeGraphEnabled = this.modal.querySelector('#knowledge-graph-enabled');
            const timeAwareEnabled = this.modal.querySelector('#time-aware-enabled');
            const stIntegrationEnabled = this.modal.querySelector('#st-integration-enabled');

            // ä»æ¨¡å—æˆ–ä¿å­˜çš„è®¾ç½®ä¸­åŠ è½½
            const mms = infoBarTool?.modules?.memoryMaintenanceSystem;
            const cr = infoBarTool?.modules?.contextualRetrieval;
            const upm = infoBarTool?.modules?.userProfileManager;
            const kgm = infoBarTool?.modules?.knowledgeGraphManager;
            const tam = infoBarTool?.modules?.timeAwareMemoryManager;
            const sti = infoBarTool?.modules?.sillyTavernIntegration;

            if (memoryMaintenanceEnabled) {
                memoryMaintenanceEnabled.checked = mms?.settings?.enabled ?? enhancementSettings.memoryMaintenance ?? false;
            }
            if (contextualRetrievalEnabled) {
                contextualRetrievalEnabled.checked = cr?.settings?.enabled ?? enhancementSettings.contextualRetrieval ?? false;
            }
            if (userProfileEnabled) {
                userProfileEnabled.checked = upm?.settings?.enabled ?? enhancementSettings.userProfile ?? false;
            }
            if (knowledgeGraphEnabled) {
                knowledgeGraphEnabled.checked = kgm?.settings?.enabled ?? enhancementSettings.knowledgeGraph ?? false;
            }
            if (timeAwareEnabled) {
                timeAwareEnabled.checked = tam?.settings?.enabled ?? enhancementSettings.timeAware ?? false;
            }
            if (stIntegrationEnabled) {
                stIntegrationEnabled.checked = sti?.settings?.enabled ?? enhancementSettings.stIntegration ?? false;
            }

            // ğŸ“– å‰§æƒ…è§„åˆ’åŠ©æ‰‹è®¾ç½®
            const spSettings = savedMem.storyPlanning || {};
            const spa = infoBarTool.modules?.storyPlanningAssistant;
            
            const spEnabledEl = this.modal.querySelector('#memory-story-planning-enabled');
            const spAutoActivateEl = this.modal.querySelector('#memory-sp-auto-activate');
            const spSemanticAnalysisEl = this.modal.querySelector('#memory-sp-semantic-analysis');
            const spTimelineAwareEl = this.modal.querySelector('#memory-sp-timeline-aware');
            const spPlotContinuityEl = this.modal.querySelector('#memory-sp-plot-continuity');
            const spDetailLevelEl = this.modal.querySelector('#memory-sp-detail-level');
            const spMaxKeywordsEl = this.modal.querySelector('#memory-sp-max-keywords');
            const spMaxKeywordsVal = this.modal.querySelector('#memory-sp-max-keywords-value');
            const spMaxMemoriesEl = this.modal.querySelector('#memory-sp-max-memories');
            const spMaxMemoriesVal = this.modal.querySelector('#memory-sp-max-memories-value');
            const spMinImportanceEl = this.modal.querySelector('#memory-sp-min-importance');
            const spMinImportanceVal = this.modal.querySelector('#memory-sp-min-importance-value');

            if (spEnabledEl) spEnabledEl.checked = spa?.config?.enabled ?? spSettings.enabled ?? false;
            if (spAutoActivateEl) spAutoActivateEl.checked = spa?.config?.autoActivate ?? spSettings.autoActivate ?? true;
            if (spSemanticAnalysisEl) spSemanticAnalysisEl.checked = spa?.config?.enableSemanticAnalysis ?? spSettings.enableSemanticAnalysis ?? true;
            if (spTimelineAwareEl) spTimelineAwareEl.checked = spa?.config?.enableTimelineAware ?? spSettings.enableTimelineAware ?? true;
            if (spPlotContinuityEl) spPlotContinuityEl.checked = spa?.config?.enablePlotContinuity ?? spSettings.enablePlotContinuity ?? true;
            if (spDetailLevelEl) spDetailLevelEl.value = spa?.config?.suggestionDetailLevel ?? spSettings.suggestionDetailLevel ?? 'detailed';
            
            if (spMaxKeywordsEl) {
                const v = spa?.config?.maxKeywords ?? spSettings.maxKeywords ?? 10;
                spMaxKeywordsEl.value = v;
                if (spMaxKeywordsVal) spMaxKeywordsVal.textContent = v;
            }
            if (spMaxMemoriesEl) {
                const v = spa?.config?.maxMemoryResults ?? spSettings.maxMemoryResults ?? 15;
                spMaxMemoriesEl.value = v;
                if (spMaxMemoriesVal) spMaxMemoriesVal.textContent = v;
            }
            if (spMinImportanceEl) {
                const v = spa?.config?.minMemoryImportance ?? spSettings.minMemoryImportance ?? 0.5;
                spMinImportanceEl.value = v;
                if (spMinImportanceVal) spMinImportanceVal.textContent = (v * 100).toFixed(0) + '%';
            }

            // æ˜¾ç¤º/éšè—å‰§æƒ…è§„åˆ’åŠ©æ‰‹é€‰é¡¹
            const spOptions = this.modal.querySelector('#memory-story-planning-options');
            if (spOptions) {
                spOptions.style.display = (spa?.config?.enabled ?? spSettings.enabled) ? 'block' : 'none';
            }

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºè®¾ç½®åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è®°å¿†å¢å¼ºè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹
     */
    initMemoryEnhancementPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ§  åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool) {
                console.warn('[InfoBarSettings] âš ï¸ InfoBarå·¥å…·æœªæ‰¾åˆ°');
                return;
            }

            // åŠ è½½å½“å‰è®¾ç½®
            this.loadMemoryEnhancementSettings();

            // ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶
            this.bindMemoryEnhancementEvents();

            // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºé¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”® åˆå§‹åŒ–å‘é‡åŠŸèƒ½é¢æ¿å†…å®¹
     */
    initVectorFunctionPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ”® åˆå§‹åŒ–å‘é‡åŠŸèƒ½é¢æ¿å†…å®¹...');

            // åŠ è½½å½“å‰è®¾ç½®
            this.loadVectorFunctionSettings();

            // ç»‘å®šå‘é‡åŠŸèƒ½é¢æ¿äº‹ä»¶
            this.bindVectorFunctionEvents();

            // åˆ·æ–°è¯­æ–™åº“åˆ—è¡¨
            this.refreshCorpusList();

            // ğŸ†• åˆå§‹åŒ–å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ
            this.initVectorFileManagement();

            // ğŸ”§ å…³é”®ä¿®å¤ï¼šåŒæ­¥é…ç½®åˆ°UnifiedVectorRetrievalæ¨¡å—
            this.syncVectorFunctionConfigToModules();

            console.log('[InfoBarSettings] âœ… å‘é‡åŠŸèƒ½é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–å‘é‡åŠŸèƒ½é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ åŒæ­¥å‘é‡åŠŸèƒ½é…ç½®åˆ°ç›¸å…³æ¨¡å—
     */
    syncVectorFunctionConfigToModules() {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorCfg = extCfg.vectorFunction || {};

            console.log('[InfoBarSettings] ğŸ”„ åŒæ­¥å‘é‡åŠŸèƒ½é…ç½®åˆ°æ¨¡å—...', {
                enableAIRetrieval: vectorCfg.enableAIRetrieval
            });

            // åŒæ­¥åˆ°UnifiedVectorRetrieval
            const unifiedVectorRetrieval = window.SillyTavernInfobar?.modules?.unifiedVectorRetrieval;
            if (unifiedVectorRetrieval) {
                unifiedVectorRetrieval.loadConfig();
                console.log('[InfoBarSettings] âœ… å·²åŒæ­¥é…ç½®åˆ°UnifiedVectorRetrievalï¼Œå¯ç”¨çŠ¶æ€:', unifiedVectorRetrieval.enabled);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ UnifiedVectorRetrievalæ¨¡å—ä¸å­˜åœ¨');
            }

            // åŒæ­¥åˆ°CorpusRetrieval
            const corpusRetrieval = window.SillyTavernInfobar?.modules?.corpusRetrieval;
            if (corpusRetrieval) {
                corpusRetrieval.loadConfig();
                console.log('[InfoBarSettings] âœ… å·²åŒæ­¥é…ç½®åˆ°CorpusRetrieval');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŒæ­¥å‘é‡åŠŸèƒ½é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”® åŠ è½½å‘é‡åŠŸèƒ½è®¾ç½®
     */
    loadVectorFunctionSettings() {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorCfg = extCfg.vectorFunction || {};

            // åŠ è½½åˆ†å—é…ç½®
            const chunkSize = this.modal.querySelector('#vector-chunk-size');
            if (chunkSize) chunkSize.value = vectorCfg.chunkSize || 500;

            const overlapSize = this.modal.querySelector('#vector-overlap-size');
            if (overlapSize) overlapSize.value = vectorCfg.overlapSize || 50;

            const batchSize = this.modal.querySelector('#vector-batch-size');
            if (batchSize) batchSize.value = vectorCfg.batchSize || 10;

            // ğŸ”§ æ–°å¢ï¼šåŠ è½½æ™ºèƒ½åˆ†æé…ç½®
            const enableSmartAnalysis = this.modal.querySelector('#enable-smart-analysis');
            if (enableSmartAnalysis) {
                enableSmartAnalysis.checked = vectorCfg.enableSmartAnalysis || false;
                const smartAnalysisOptions = this.modal.querySelector('#smart-analysis-options');
                if (smartAnalysisOptions) {
                    smartAnalysisOptions.style.display = enableSmartAnalysis.checked ? 'block' : 'none';
                }
            }

            const extractPlotSummary = this.modal.querySelector('#extract-plot-summary');
            if (extractPlotSummary) extractPlotSummary.checked = vectorCfg.extractPlotSummary !== false;

            const analyzeWritingStyle = this.modal.querySelector('#analyze-writing-style');
            if (analyzeWritingStyle) analyzeWritingStyle.checked = vectorCfg.analyzeWritingStyle !== false;

            const extractTimeline = this.modal.querySelector('#extract-timeline');
            if (extractTimeline) extractTimeline.checked = vectorCfg.extractTimeline !== false;

            const markKeyScenes = this.modal.querySelector('#mark-key-scenes');
            if (markKeyScenes) markKeyScenes.checked = vectorCfg.markKeyScenes !== false;

            const extractCharacters = this.modal.querySelector('#extract-characters');
            if (extractCharacters) extractCharacters.checked = vectorCfg.extractCharacters !== false;

            // ğŸ”§ æ–°å¢ï¼šåŠ è½½AIæ£€ç´¢é…ç½®
            const enableAIRetrieval = this.modal.querySelector('#enable-ai-retrieval');
            if (enableAIRetrieval) {
                enableAIRetrieval.checked = vectorCfg.enableAIRetrieval || false;
                const aiRetrievalOptions = this.modal.querySelector('#ai-retrieval-options');
                if (aiRetrievalOptions) {
                    aiRetrievalOptions.style.display = enableAIRetrieval.checked ? 'block' : 'none';
                }
            }

            // ğŸ†• åŠ è½½å¤šè·¯å¬å›é…ç½®
            const enableMultiRecall = this.modal.querySelector('#enable-multi-recall');
            if (enableMultiRecall) {
                enableMultiRecall.checked = vectorCfg.enableMultiRecall || false;
                // ğŸ†• æ ¹æ®å¤šè·¯å¬å›çŠ¶æ€æ˜¾ç¤º/éšè—é‡æ’åºé˜ˆå€¼
                const rerankThresholdRow = this.modal.querySelector('#rerank-threshold-row');
                if (rerankThresholdRow) {
                    rerankThresholdRow.style.display = enableMultiRecall.checked ? 'block' : 'none';
                }
            }

            const enableCorpusRetrieval = this.modal.querySelector('#enable-corpus-retrieval');
            if (enableCorpusRetrieval) enableCorpusRetrieval.checked = vectorCfg.enableCorpusRetrieval !== false;

            const enableMemoryRetrieval = this.modal.querySelector('#enable-memory-retrieval');
            if (enableMemoryRetrieval) enableMemoryRetrieval.checked = vectorCfg.enableMemoryRetrieval !== false;

            const enableSummaryRetrieval = this.modal.querySelector('#enable-summary-retrieval');
            if (enableSummaryRetrieval) enableSummaryRetrieval.checked = vectorCfg.enableSummaryRetrieval !== false;

            const retrievalTopK = this.modal.querySelector('#retrieval-top-k');
            if (retrievalTopK) retrievalTopK.value = vectorCfg.retrievalTopK || 10;

            const retrievalThreshold = this.modal.querySelector('#retrieval-threshold');
            if (retrievalThreshold) retrievalThreshold.value = vectorCfg.retrievalThreshold || 0.5;

            // ğŸ†• åŠ è½½é‡æ’åºé˜ˆå€¼
            const rerankThreshold = this.modal.querySelector('#rerank-threshold');
            if (rerankThreshold) rerankThreshold.value = vectorCfg.rerankThreshold || 10;

            const retrievalCacheTimeout = this.modal.querySelector('#retrieval-cache-timeout');
            if (retrievalCacheTimeout) retrievalCacheTimeout.value = vectorCfg.retrievalCacheTimeout || 5000;

            const retrievalInjectionPosition = this.modal.querySelector('#retrieval-injection-position');
            if (retrievalInjectionPosition) retrievalInjectionPosition.value = vectorCfg.retrievalInjectionPosition || 'system';

            const retrievalInjectionDepth = this.modal.querySelector('#retrieval-injection-depth');
            if (retrievalInjectionDepth) retrievalInjectionDepth.value = vectorCfg.retrievalInjectionDepth || 0;

            const retrievalInjectionPriority = this.modal.querySelector('#retrieval-injection-priority');
            if (retrievalInjectionPriority) retrievalInjectionPriority.value = vectorCfg.retrievalInjectionPriority || 0;

            console.log('[InfoBarSettings] âœ… å‘é‡åŠŸèƒ½è®¾ç½®åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å‘é‡åŠŸèƒ½è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”® ç»‘å®šå‘é‡åŠŸèƒ½é¢æ¿äº‹ä»¶
     */
    bindVectorFunctionEvents() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (this._vectorFunctionEventsbound) {
                console.log('[InfoBarSettings] âš ï¸ å‘é‡åŠŸèƒ½é¢æ¿äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }

            // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const uploadArea = this.modal.querySelector('#file-upload-area');
            const fileInput = this.modal.querySelector('#novel-file-input');

            if (uploadArea && fileInput) {
                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // æ‹–æ‹½ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#4CAF50';
                    uploadArea.style.background = 'rgba(76, 175, 80, 0.1)';
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '';
                    uploadArea.style.background = '';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '';
                    uploadArea.style.background = '';

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleNovelFileUpload(files[0]);
                    }
                });

                // æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        this.handleNovelFileUpload(files[0]);
                    }
                });
            }

            // æ ‡è®°äº‹ä»¶å·²ç»‘å®š
            this._vectorFunctionEventsbound = true;

            // åˆ·æ–°è¯­æ–™åº“åˆ—è¡¨
            const refreshBtn = this.modal.querySelector('#refresh-corpus-list');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.refreshCorpusList();
                });
            }

            // ğŸ”§ æ–°å¢ï¼šä¸­æ­¢å‘é‡åŒ–æŒ‰é’®
            const abortBtn = this.modal.querySelector('#abort-vectorization-btn');
            if (abortBtn) {
                abortBtn.addEventListener('click', () => {
                    this.abortVectorization();
                });
            }

            // ğŸ”§ æ–°å¢ï¼šæ™ºèƒ½åˆ†æå¼€å…³
            const enableSmartAnalysis = this.modal.querySelector('#enable-smart-analysis');
            const smartAnalysisOptions = this.modal.querySelector('#smart-analysis-options');
            if (enableSmartAnalysis && smartAnalysisOptions) {
                enableSmartAnalysis.addEventListener('change', (e) => {
                    smartAnalysisOptions.style.display = e.target.checked ? 'block' : 'none';
                });
            }

            // ğŸ”§ æ–°å¢ï¼šAIæ£€ç´¢å¼€å…³
            const enableAIRetrieval = this.modal.querySelector('#enable-ai-retrieval');
            const aiRetrievalOptions = this.modal.querySelector('#ai-retrieval-options');
            if (enableAIRetrieval && aiRetrievalOptions) {
                enableAIRetrieval.addEventListener('change', (e) => {
                    aiRetrievalOptions.style.display = e.target.checked ? 'block' : 'none';
                });
            }

            // ğŸ†• æ–°å¢ï¼šå¤šè·¯å¬å›å¼€å…³ï¼ˆæ§åˆ¶é‡æ’åºé˜ˆå€¼æ˜¾ç¤ºï¼‰
            const enableMultiRecall = this.modal.querySelector('#enable-multi-recall');
            const rerankThresholdRow = this.modal.querySelector('#rerank-threshold-row');
            if (enableMultiRecall && rerankThresholdRow) {
                enableMultiRecall.addEventListener('change', (e) => {
                    rerankThresholdRow.style.display = e.target.checked ? 'block' : 'none';
                });
            }

            console.log('[InfoBarSettings] âœ… å‘é‡åŠŸèƒ½é¢æ¿äº‹ä»¶ç»‘å®šå®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šå‘é‡åŠŸèƒ½é¢æ¿äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
     */
    async refreshMemoryStatus() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool) {
                console.warn('[InfoBarSettings] âš ï¸ InfoBarå·¥å…·æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ è¯»å–åŠŸèƒ½å¯ç”¨çŠ¶æ€ï¼Œæ§åˆ¶çŠ¶æ€å¡ç‰‡çš„æ˜¾ç¤º/éšè—
            const featureEnabledMap = {
                'aiSummarizer': this.modal.querySelector('#memory-ai-memory-enabled')?.checked || false,
                'aiMemoryDatabase': this.modal.querySelector('#memory-ai-memory-database-enabled')?.checked || false,
                'memoryMaintenance': this.modal.querySelector('#memory-maintenance-enabled')?.checked || false,
                'contextualRetrieval': this.modal.querySelector('#contextual-retrieval-enabled')?.checked || false,
                'userProfile': this.modal.querySelector('#user-profile-enabled')?.checked || false,
                'knowledgeGraph': this.modal.querySelector('#knowledge-graph-enabled')?.checked || false,
                'timeAware': this.modal.querySelector('#time-aware-enabled')?.checked || false,
                'stIntegration': this.modal.querySelector('#st-integration-enabled')?.checked || false,
                'storyPlanning': this.modal.querySelector('#memory-story-planning-enabled')?.checked || false
            };

            console.log('[InfoBarSettings] ğŸ“Š åŠŸèƒ½å¯ç”¨çŠ¶æ€:', featureEnabledMap);

            // ğŸ”§ æ ¹æ®å¯ç”¨çŠ¶æ€æ˜¾ç¤º/éšè—çŠ¶æ€å¡ç‰‡
            Object.keys(featureEnabledMap).forEach(module => {
                const card = this.modal.querySelector(`[data-module="${module}"]`);
                if (card) {
                    card.style.display = featureEnabledMap[module] ? '' : 'none';
                }
            });

            // è·å–å„æ¨¡å—çŠ¶æ€
            const deepMemoryManager = infoBarTool.modules?.deepMemoryManager;
            const aiMemorySummarizer = infoBarTool.modules?.summaryManager?.aiMemorySummarizer;
            const vectorizedMemoryRetrieval = infoBarTool.modules?.vectorizedMemoryRetrieval;
            const intelligentMemoryClassifier = infoBarTool.modules?.intelligentMemoryClassifier;
            const aiMemoryDatabaseInjector = infoBarTool.modules?.aiMemoryDatabaseInjector;

            // æ›´æ–°å››å±‚è®°å¿†æ¶æ„çŠ¶æ€ï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼Œå› ä¸ºæ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
            if (deepMemoryManager) {
                const status = deepMemoryManager.getStatus();
                this.updateMemoryLayerStatus('sensory', status);
                this.updateMemoryLayerStatus('shortTerm', status);
                this.updateMemoryLayerStatus('longTerm', status);
                this.updateMemoryLayerStatus('deepArchive', status);
            }

            // æ›´æ–°æ¨¡å—çŠ¶æ€ï¼ˆåªåœ¨å¯ç”¨æ—¶æ›´æ–°æ•°æ®ï¼‰
            if (aiMemorySummarizer && featureEnabledMap.aiSummarizer) {
                const status = aiMemorySummarizer.getStatus();
                console.log('[InfoBarSettings] ğŸ“Š AIè®°å¿†æ€»ç»“å™¨çŠ¶æ€:', status);
                this.updateModuleStatus('aiSummarizer', status);
            } else {
                console.log('[InfoBarSettings] âš ï¸ AIè®°å¿†æ€»ç»“å™¨æœªæ‰¾åˆ°æˆ–æœªå¯ç”¨:', {
                    aiMemorySummarizer: !!aiMemorySummarizer,
                    enabled: featureEnabledMap.aiSummarizer
                });
            }

            // ğŸ”§ vectorSearch, classifier, injector æ˜¯åŸºç¡€æ¨¡å—ï¼Œæ€»æ˜¯æ˜¾ç¤º
            if (vectorizedMemoryRetrieval) {
                const status = vectorizedMemoryRetrieval.getStatus();
                this.updateModuleStatus('vectorSearch', status);
            }

            if (intelligentMemoryClassifier) {
                const status = intelligentMemoryClassifier.getStatus();
                this.updateModuleStatus('classifier', status);
            }

            if (aiMemoryDatabaseInjector) {
                const status = aiMemoryDatabaseInjector.getStatus();
                this.updateModuleStatus('injector', status);
            }

            // ğŸ†• æ›´æ–°å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—çŠ¶æ€ï¼ˆåªåœ¨å¯ç”¨æ—¶æ›´æ–°ï¼‰
            const memoryMaintenanceSystem = infoBarTool.modules?.memoryMaintenanceSystem;
            if (memoryMaintenanceSystem && featureEnabledMap.memoryMaintenance) {
                const status = memoryMaintenanceSystem.getStatus();
                this.updateEnhancementModuleStatus('memoryMaintenance', status);
            }

            const contextualRetrieval = infoBarTool.modules?.contextualRetrieval;
            if (contextualRetrieval && featureEnabledMap.contextualRetrieval) {
                const status = contextualRetrieval.getStatus();
                this.updateEnhancementModuleStatus('contextualRetrieval', status);
            }

            const userProfileManager = infoBarTool.modules?.userProfileManager;
            if (userProfileManager && featureEnabledMap.userProfile) {
                const status = userProfileManager.getStatus();
                this.updateEnhancementModuleStatus('userProfile', status);
            }

            const knowledgeGraphManager = infoBarTool.modules?.knowledgeGraphManager;
            if (knowledgeGraphManager && featureEnabledMap.knowledgeGraph) {
                const status = knowledgeGraphManager.getStatus();
                this.updateEnhancementModuleStatus('knowledgeGraph', status);
            }

            const timeAwareMemoryManager = infoBarTool.modules?.timeAwareMemoryManager;
            if (timeAwareMemoryManager && featureEnabledMap.timeAware) {
                const status = timeAwareMemoryManager.getStatus();
                this.updateEnhancementModuleStatus('timeAware', status);
            }

            const sillyTavernIntegration = infoBarTool.modules?.sillyTavernIntegration;
            if (sillyTavernIntegration && featureEnabledMap.stIntegration) {
                const status = sillyTavernIntegration.getStatus();
                this.updateEnhancementModuleStatus('stIntegration', status);
            }

            // ğŸ—„ï¸ æ›´æ–°AIè®°å¿†æ•°æ®åº“çŠ¶æ€ï¼ˆåªåœ¨å¯ç”¨æ—¶æ›´æ–°ï¼‰
            const aiMemoryDatabase = infoBarTool.modules?.aiMemoryDatabase || window.__TEST_AIMemoryDatabase;
            if (aiMemoryDatabase && featureEnabledMap.aiMemoryDatabase) {
                const status = aiMemoryDatabase.getStatus();
                this.updateAIMemoryDatabaseStatus(status);
            }

            // ğŸ“– æ›´æ–°å‰§æƒ…è§„åˆ’åŠ©æ‰‹çŠ¶æ€ï¼ˆåªåœ¨å¯ç”¨æ—¶æ›´æ–°ï¼‰
            const storyPlanningAssistant = infoBarTool.modules?.storyPlanningAssistant;
            if (storyPlanningAssistant && featureEnabledMap.storyPlanning) {
                const status = storyPlanningAssistant.getStatus();
                this.updateStoryPlanningStatus(status);
            }

            console.log('[InfoBarSettings] âœ… è®°å¿†ç³»ç»ŸçŠ¶æ€åˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ æ›´æ–°è®°å¿†å±‚çŠ¶æ€æ˜¾ç¤º
     */
    updateMemoryLayerStatus(layerName, status) {
        try {
            const layerData = status.memoryLayers?.[layerName];
            const stats = status.stats || {};
            const settings = status.settings || {};

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector(`#${layerName === 'shortTerm' ? 'shortterm' : layerName === 'longTerm' ? 'longterm' : layerName === 'deepArchive' ? 'archive' : layerName}-status`);
            if (statusElement) {
                const isActive = status.initialized && !status.isProcessing;
                statusElement.className = `layer-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°å…·ä½“æ•°æ®
            switch (layerName) {
                case 'sensory':
                    this.updateElement('#sensory-count', layerData || 0);
                    this.updateElement('#sensory-capacity', `${layerData || 0}/${settings.sensoryMemoryCapacity || 100}`);
                    break;
                case 'shortTerm':
                    this.updateElement('#shortterm-count', layerData || 0);
                    this.updateElement('#shortterm-importance', `${Math.round((stats.averageImportance || 0) * 100)}%`);
                    break;
                case 'longTerm':
                    this.updateElement('#longterm-count', layerData || 0);
                    this.updateElement('#longterm-migrations', stats.memoryMigrations || 0);
                    break;
                case 'deepArchive':
                    this.updateElement('#archive-count', layerData || 0);
                    this.updateElement('#archive-compression', `${Math.round((stats.compressionRatio || 0) * 100)}%`);
                    break;
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°è®°å¿†å±‚çŠ¶æ€å¤±è´¥ (${layerName}):`, error);
        }
    }

    /**
     * ğŸ¯ æ›´æ–°æ¨¡å—çŠ¶æ€æ˜¾ç¤º
     */
    updateModuleStatus(moduleName, status) {
        try {
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector(`#${moduleName === 'aiSummarizer' ? 'ai-summarizer' : moduleName === 'vectorSearch' ? 'vector-search' : moduleName}-status`);
            if (statusElement) {
                const isActive = status.initialized && !status.isProcessing;
                statusElement.className = `module-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°å…·ä½“æ•°æ®
            switch (moduleName) {
                case 'aiSummarizer':
                    this.updateElement('#ai-summarizer-queue', status.queueLength || 0);
                    this.updateElement('#ai-summarizer-cache', status.cacheSize || 0);
                    break;
                case 'vectorSearch':
                    this.updateElement('#vector-search-index', status.indexSize || 0);
                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—å‘½ä¸­ç‡
                    let hitRate = 0;
                    if (status.stats) {
                        const cacheHits = status.stats.cacheHits || 0;
                        const cacheMisses = status.stats.cacheMisses || 0;
                        const totalRequests = cacheHits + cacheMisses;
                        hitRate = totalRequests > 0 ? Math.round((cacheHits / totalRequests) * 100) : 0;
                    }
                    this.updateElement('#vector-search-hitrate', `${hitRate}%`);
                    break;
                case 'classifier':
                    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                    this.updateElement('#classifier-count', status.stats?.totalClassifications || 0);
                    this.updateElement('#classifier-confidence', `${Math.round((status.stats?.averageConfidence || 0) * 100)}%`);
                    break;
                case 'injector':
                    this.updateElement('#injector-count', status.stats?.totalInjections || 0);
                    this.updateElement('#injector-errors', status.errorCount || 0);
                    break;
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°æ¨¡å—çŠ¶æ€å¤±è´¥ (${moduleName}):`, error);
        }
    }

    /**
     * ğŸ†• æ›´æ–°å…­å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—çŠ¶æ€æ˜¾ç¤º
     */
    updateEnhancementModuleStatus(moduleName, status) {
        try {
            // çŠ¶æ€æŒ‡ç¤ºå™¨IDæ˜ å°„
            const statusIdMap = {
                'memoryMaintenance': 'memory-maintenance-status',
                'contextualRetrieval': 'contextual-retrieval-status',
                'userProfile': 'user-profile-status',
                'knowledgeGraph': 'knowledge-graph-status',
                'timeAware': 'time-aware-status',
                'stIntegration': 'st-integration-status'
            };

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector(`#${statusIdMap[moduleName]}`);
            if (statusElement) {
                const isActive = status.initialized && status.enabled;
                statusElement.className = `module-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°å…·ä½“æ•°æ®
            switch (moduleName) {
                case 'memoryMaintenance':
                    this.updateElement('#memory-maintenance-cleanups', status.stats?.totalCleanups || 0);
                    this.updateElement('#memory-maintenance-compressions', status.stats?.totalCompressions || 0);
                    break;
                case 'contextualRetrieval':
                    this.updateElement('#contextual-retrieval-queries', status.stats?.totalQueries || 0);
                    this.updateElement('#contextual-retrieval-cache-hits', status.stats?.cacheHits || 0);
                    break;
                case 'userProfile':
                    this.updateElement('#user-profile-count', status.profilesCount || 0);
                    const confidence = status.currentProfile?.confidence || 0;
                    this.updateElement('#user-profile-confidence', `${Math.round(confidence * 100)}%`);
                    break;
                case 'knowledgeGraph':
                    const currentGraph = status.currentGraph;
                    this.updateElement('#knowledge-graph-triples', currentGraph?.triples?.length || 0);
                    this.updateElement('#knowledge-graph-entities', currentGraph?.entities?.size || 0);
                    break;
                case 'timeAware':
                    const currentTimeline = status.currentTimeline;
                    this.updateElement('#time-aware-events', currentTimeline?.events?.length || 0);
                    this.updateElement('#time-aware-decayed', status.stats?.totalDecayed || 0);
                    break;
                case 'stIntegration':
                    this.updateElement('#st-integration-injections', status.stats?.totalInjections || 0);
                    const avgTime = status.stats?.avgInjectionTime || 0;
                    this.updateElement('#st-integration-avg-time', `${avgTime.toFixed(2)}ms`);
                    break;
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°å¢å¼ºæ¨¡å—çŠ¶æ€å¤±è´¥ (${moduleName}):`, error);
        }
    }

    /**
     * ğŸ“– æ›´æ–°å‰§æƒ…è§„åˆ’åŠ©æ‰‹çŠ¶æ€
     */
    updateStoryPlanningStatus(status) {
        try {
            console.log('[InfoBarSettings] ğŸ“– æ›´æ–°å‰§æƒ…è§„åˆ’åŠ©æ‰‹çŠ¶æ€:', status);

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector('#story-planning-status');
            if (statusElement) {
                const isActive = status.initialized && status.enabled;
                statusElement.className = `module-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const stats = status.stats || {};
            this.updateElement('#story-planning-count', stats.totalPlannings || 0);
            this.updateElement('#story-planning-suggestions', stats.totalSuggestionsGenerated || 0);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å‰§æƒ…è§„åˆ’åŠ©æ‰‹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ—„ï¸ æ›´æ–°AIè®°å¿†æ•°æ®åº“çŠ¶æ€ï¼ˆå¸¦å¯è§†åŒ–ï¼‰
     */
    updateAIMemoryDatabaseStatus(status) {
        try {
            console.log('[InfoBarSettings] ğŸ—„ï¸ æ›´æ–°AIè®°å¿†æ•°æ®åº“çŠ¶æ€:', status);

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector('#ai-memory-database-status');
            if (statusElement) {
                const isActive = status.initialized && status.enabled;
                statusElement.className = `module-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°åŸºç¡€ç»Ÿè®¡
            this.updateElement('#ai-memory-database-count', status.memoryCount || 0);
            this.updateElement('#ai-memory-database-keywords', status.keywordCount || 0);

            // ğŸ¯ æ›´æ–°å¯è§†åŒ–æ•°æ®
            const stats = status.stats || {};
            const totalMemories = status.memoryCount || 0;
            const indexedMemories = totalMemories; // å‡è®¾æ‰€æœ‰è®°å¿†éƒ½å·²ç´¢å¼•
            const totalPossibleMemories = 500; // æœ€å¤§å®¹é‡

            // 1. ç´¢å¼•å®Œæ•´åº¦è¿›åº¦æ¡
            const indexProgress = totalPossibleMemories > 0 ? (indexedMemories / totalPossibleMemories) * 100 : 0;
            const progressFill = this.modal.querySelector('#ai-db-index-progress .progress-fill');
            const progressText = this.modal.querySelector('#ai-db-index-text');
            if (progressFill && progressText) {
                progressFill.style.width = `${indexProgress}%`;
                progressFill.style.background = this.getProgressColor(indexProgress);
                progressText.textContent = `${indexProgress.toFixed(1)}%`;
            }

            // 2. å¹³å‡é‡è¦æ€§æ¡
            const avgImportance = stats.averageImportance || 0;
            const importanceFill = this.modal.querySelector('#ai-db-importance-bar .importance-fill');
            const importanceValue = this.modal.querySelector('#ai-db-importance-value');
            if (importanceFill && importanceValue) {
                importanceFill.style.width = `${avgImportance * 100}%`;
                importanceFill.style.background = this.getImportanceColor(avgImportance);
                importanceValue.textContent = avgImportance.toFixed(2);
            }

            // 3. åˆ†ç±»åˆ†å¸ƒæ ‡ç­¾äº‘
            this.updateCategoryDistribution(status);

            console.log('[InfoBarSettings] âœ… AIè®°å¿†æ•°æ®åº“çŠ¶æ€æ›´æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°AIè®°å¿†æ•°æ®åº“çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¨ æ›´æ–°åˆ†ç±»åˆ†å¸ƒæ˜¾ç¤º
     */
    updateCategoryDistribution(status) {
        try {
            const categoriesContainer = this.modal.querySelector('#ai-db-categories');
            if (!categoriesContainer) return;

            // è·å–åˆ†ç±»ç»Ÿè®¡
            const categoryStats = status.stats?.categoryStats || {};
            const categories = Object.keys(categoryStats);

            if (categories.length === 0) {
                categoriesContainer.innerHTML = '<span class="no-data">æš‚æ— æ•°æ®</span>';
                return;
            }

            // æŒ‰æ•°é‡æ’åº
            const sortedCategories = categories.sort((a, b) => categoryStats[b] - categoryStats[a]);
            
            // ç”Ÿæˆåˆ†ç±»æ ‡ç­¾ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
            const topCategories = sortedCategories.slice(0, 5);
            const maxCount = Math.max(...topCategories.map(cat => categoryStats[cat]));
            
            categoriesContainer.innerHTML = topCategories.map(category => {
                const count = categoryStats[category];
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const opacity = 0.5 + (percentage / 200); // 0.5-1.0
                
                return `<span class="category-tag" style="opacity: ${opacity};" title="${category}: ${count}æ¡è®°å¿†">
                    ${category} (${count})
                </span>`;
            }).join('');

            // å¦‚æœè¿˜æœ‰æ›´å¤šåˆ†ç±»ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
            if (categories.length > 5) {
                categoriesContainer.innerHTML += `<span class="category-tag more-categories" title="è¿˜æœ‰${categories.length - 5}ä¸ªåˆ†ç±»">
                    +${categories.length - 5}
                </span>`;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°åˆ†ç±»åˆ†å¸ƒå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¨ è·å–è¿›åº¦æ¡é¢œè‰²
     */
    getProgressColor(percentage) {
        if (percentage >= 80) return 'linear-gradient(90deg, #51cf66 0%, #37b24d 100%)'; // ç»¿è‰²
        if (percentage >= 50) return 'linear-gradient(90deg, #ffd43b 0%, #fab005 100%)'; // é»„è‰²
        if (percentage >= 20) return 'linear-gradient(90deg, #ff922b 0%, #fd7e14 100%)'; // æ©™è‰²
        return 'linear-gradient(90deg, #ff6b6b 0%, #fa5252 100%)'; // çº¢è‰²
    }

    /**
     * ğŸ¨ è·å–é‡è¦æ€§é¢œè‰²
     */
    getImportanceColor(importance) {
        if (importance >= 0.8) return 'linear-gradient(90deg, #d946ef 0%, #c026d3 100%)'; // ç´«è‰²
        if (importance >= 0.6) return 'linear-gradient(90deg, #3b82f6 0%, #2563eb 100%)'; // è“è‰²
        if (importance >= 0.4) return 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)'; // ç»¿è‰²
        if (importance >= 0.2) return 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)'; // æ©™è‰²
        return 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)'; // çº¢è‰²
    }

    /**
     * ğŸ¯ æ›´æ–°DOMå…ƒç´ å†…å®¹
     */
    updateElement(selector, value) {
        try {
            const element = this.modal.querySelector(selector);
            if (element) {
                element.textContent = value;
            }
        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°å…ƒç´ å¤±è´¥ (${selector}):`, error);
        }
    }

    /**
     * ğŸ§  å¤„ç†æç¤ºè¯æ¨¡å¼å˜åŒ–
     */
    handlePromptModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ§  æç¤ºè¯æ¨¡å¼å˜åŒ–:', mode);

            const smartConfig = this.modal.querySelector('#smart-prompt-config');
            const customConfig = this.modal.querySelector('#custom-prompt-config');

            if (mode === 'smart') {
                // æ˜¾ç¤ºæ™ºèƒ½æç¤ºè¯é…ç½®ï¼Œéšè—è‡ªå®šä¹‰æç¤ºè¯é…ç½®
                if (smartConfig) smartConfig.style.display = 'block';
                if (customConfig) customConfig.style.display = 'none';

                // å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                this.enableSmartPromptSystem();

                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°æ™ºèƒ½æç¤ºè¯æ¨¡å¼');
            } else if (mode === 'custom') {
                // éšè—æ™ºèƒ½æç¤ºè¯é…ç½®ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºè¯é…ç½®
                if (smartConfig) smartConfig.style.display = 'none';
                if (customConfig) customConfig.style.display = 'block';

                // ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                this.disableSmartPromptSystem();

                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°è‡ªå®šä¹‰æç¤ºè¯æ¨¡å¼');
            }

            // ä¿å­˜è®¾ç½®
            this.savePromptSettings();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æç¤ºè¯æ¨¡å¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
     */
    enableSmartPromptSystem() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (smartPromptSystem) {
                // é‡æ–°å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                smartPromptSystem.enabled = true;
                console.log('[InfoBarSettings] âœ… æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå·²å¯ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
     */
    disableSmartPromptSystem() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (smartPromptSystem) {
                // ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                smartPromptSystem.enabled = false;
                console.log('[InfoBarSettings] âš ï¸ æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå·²ç¦ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  æ›´æ–°è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡ä¿¡æ¯
     */
    updateCustomPromptStats() {
        try {
            const textarea = this.modal.querySelector('#custom-prompt-content');
            if (!textarea) return;

            const content = textarea.value;
            const charCount = content.length;
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lineCount = content.split('\n').length;

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            const charCountSpan = this.modal.querySelector('#custom-prompt-char-count');
            const wordCountSpan = this.modal.querySelector('#custom-prompt-word-count');
            const lineCountSpan = this.modal.querySelector('#custom-prompt-line-count');

            if (charCountSpan) charCountSpan.textContent = charCount;
            if (wordCountSpan) wordCountSpan.textContent = wordCount;
            if (lineCountSpan) lineCountSpan.textContent = lineCount;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åˆ·æ–°æç¤ºè¯é¢„è§ˆ
     */
    async refreshPromptPreview() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°æç¤ºè¯é¢„è§ˆ...');

            const previewContainer = this.modal.querySelector('#prompt-preview');
            const statusSpan = this.modal.querySelector('#preview-status');

            if (!previewContainer) return;

            // æ›´æ–°çŠ¶æ€
            if (statusSpan) statusSpan.textContent = 'ç”Ÿæˆä¸­...';

            // è·å–å½“å‰æç¤ºè¯æ¨¡å¼
            const modeRadio = this.modal.querySelector('input[name="promptSettings.mode"]:checked');
            const mode = modeRadio ? modeRadio.value : 'smart';

            let previewContent = '';

            if (mode === 'smart') {
                // ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆ
                previewContent = await this.generateSmartPromptPreview();
            } else {
                // è·å–è‡ªå®šä¹‰æç¤ºè¯å†…å®¹
                const customContent = this.modal.querySelector('#custom-prompt-content')?.value || '';
                previewContent = customContent || 'æš‚æ— è‡ªå®šä¹‰æç¤ºè¯å†…å®¹';
            }

            // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
            previewContainer.innerHTML = `
                <div class="prompt-preview-content">
                    <pre>${this.escapeXML(previewContent)}</pre>
                </div>
            `;

            // æ›´æ–°çŠ¶æ€
            if (statusSpan) statusSpan.textContent = 'é¢„è§ˆå·²æ›´æ–°';

            console.log('[InfoBarSettings] âœ… æç¤ºè¯é¢„è§ˆåˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æç¤ºè¯é¢„è§ˆå¤±è´¥:', error);

            const statusSpan = this.modal.querySelector('#preview-status');
            if (statusSpan) statusSpan.textContent = 'é¢„è§ˆå¤±è´¥';
        }
    }

    /**
     * ğŸ§  ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆï¼ˆä¸åŒ…å«æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼‰
     */
    async generateSmartPromptPreview() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (!smartPromptSystem) {
                return 'æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿæœªåˆå§‹åŒ–';
            }

            // ç”Ÿæˆå®Œæ•´çš„æ™ºèƒ½æç¤ºè¯
            const fullSmartPrompt = await smartPromptSystem.generateSmartPrompt();

            if (fullSmartPrompt) {
                // ç§»é™¤æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼Œåªæ˜¾ç¤ºæç¤ºè¯æ¨¡æ¿
                const previewPrompt = this.removeDataStatusFromPrompt(fullSmartPrompt);
                return previewPrompt || 'æ™ºèƒ½æç¤ºè¯æ¨¡æ¿ï¼ˆä¸åŒ…å«æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼‰';
            } else {
                return 'æš‚æ— æ™ºèƒ½æç¤ºè¯å†…å®¹ï¼ˆå¯èƒ½æ²¡æœ‰å¯ç”¨çš„é¢æ¿æˆ–æ•°æ®ï¼‰';
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆå¤±è´¥:', error);
            return 'ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆæ—¶å‡ºé”™: ' + error.message;
        }
    }

    /**
     * ğŸ§  ä»æç¤ºè¯ä¸­ç§»é™¤åœ¨é¢„è§ˆä¸­ä¸æ˜¾ç¤ºçš„éšè—éƒ¨åˆ†
     * - ã€ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç»Ÿä¸€è¡Œè§†å›¾ï¼‰ã€‘...ã€ğŸ¤– AIç”ŸæˆæŒ‡å¯¼ã€‘ï¼ˆAIè®°å¿†å¢å¼ºæ•°æ®æ•´ä½“å—ï¼‰
     * - ğŸ” ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨ï¼ˆå¿…é¡»è¡¥å……ï¼‰ å—
     */
    removeDataStatusFromPrompt(fullPrompt) {
        try {
            let result = fullPrompt;

            // 1) ç§»é™¤ AIè®°å¿†å¢å¼ºæ•°æ®æ•´ä½“å—ï¼ˆåŒ…å«æ•°æ®çŠ¶æ€ã€å†å²/æŒä¹…åŒ–/ä¸Šä¸‹æ–‡è®°å¿†ç­‰ï¼‰
            const dataStatusStart = result.indexOf('ã€ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç»Ÿä¸€è¡Œè§†å›¾ï¼‰ã€‘');
            if (dataStatusStart !== -1) {
                // å¯»æ‰¾AIè®°å¿†å¢å¼ºå—çš„ç»“æŸä½ç½®ï¼ˆåŒ…æ‹¬ã€ğŸ¤– AIç”ŸæˆæŒ‡å¯¼ã€‘ä¹‹åçš„å†…å®¹ï¼‰
                const possibleEnds = [
                    'ğŸ” **ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨',
                    'ã€ğŸ”„ å¢é‡æ•°æ®è¡¥å…… - é‡è¦ã€‘',
                    'ã€ğŸ“‹ è¾“å‡ºå®Œæ•´æ€§æ£€æŸ¥æ¸…å•ã€‘',
                    'ğŸ’¥ğŸ’¥ğŸ’¥ **æœ€ç»ˆæ‰§è¡Œæ£€æŸ¥æ¸…å•**',
                    'ã€å½“å‰è¡Œç´¢å¼•æç¤ºã€‘',
                    '\n\nã€', // ä¸‹ä¸€ä¸ªå¤§æ ‡é¢˜
                ];

                let endIndex = -1;
                for (const endMarker of possibleEnds) {
                    const idx = result.indexOf(endMarker, dataStatusStart);
                    if (idx !== -1) {
                        if (endIndex === -1 || idx < endIndex) {
                            endIndex = idx;
                        }
                    }
                }

                if (endIndex !== -1) {
                    const beforeData = result.substring(0, dataStatusStart);
                    const afterData = result.substring(endIndex);
                    result = (beforeData + afterData).trim();
                } else {
                    result = result.substring(0, dataStatusStart).trim();
                }
            }

            // 2) é¢å¤–ç§»é™¤ â€œç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨ï¼ˆå¿…é¡»è¡¥å……ï¼‰â€ å—
            const missingTitle = 'ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨';
            let missingStart = result.indexOf(missingTitle);
            if (missingStart !== -1) {
                // å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯èƒ½çš„åˆ†æ®µèµ·å§‹æ ‡è®°ï¼ˆä¸‹ä¸€ä¸ªå¤§æ ‡é¢˜/åŒºå—ï¼‰
                const markers = [
                    '\nã€', // ä¸‹ä¸€æ®µä»¥ã€ å¼€å¤´çš„å¤§æ ‡é¢˜
                    'ã€',   // å…œåº•ï¼šä»»æ„ã€ å¼€å¤´
                    'ğŸ’¥ğŸ’¥ğŸ’¥', // æœ€ç»ˆæ£€æŸ¥æ¸…å•æ ‡é¢˜
                    'ã€ğŸ“‹ è¾“å‡ºå®Œæ•´æ€§æ£€æŸ¥æ¸…å•ã€‘',
                    '\n\nã€',
                ];
                let nextIndex = -1;
                for (const m of markers) {
                    const idx = result.indexOf(m, missingStart + 1);
                    if (idx !== -1) {
                        if (nextIndex === -1 || idx < nextIndex) nextIndex = idx;
                    }
                }

                if (nextIndex !== -1) {
                    result = (result.substring(0, missingStart) + result.substring(nextIndex)).trim();
                } else {
                    // æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªåˆ†æ®µæ ‡è®°ï¼Œåˆ™æˆªæ–­åˆ°æœ«å°¾
                    result = result.substring(0, missingStart).trim();
                }
            }

            return result;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿‡æ»¤é¢„è§ˆéšè—éƒ¨åˆ†å¤±è´¥:', error);
            return fullPrompt;
        }
    }

    /**
     * ğŸ§  ä¿å­˜æç¤ºè¯è®¾ç½®
     */
    async savePromptSettings() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            // è·å–å½“å‰è®¾ç½®
            const modeRadio = this.modal.querySelector('input[name="promptSettings.mode"]:checked');
            const mode = modeRadio ? modeRadio.value : 'smart';
            const customContent = this.modal.querySelector('#custom-prompt-content')?.value || '';

            // ä¿å­˜è®¾ç½®
            configs.promptSettings = {
                mode: mode,
                customContent: customContent
            };

            // ä¿å­˜åˆ°SillyTavern
            extensionSettings['Information bar integration tool'] = configs;

            // ä½¿ç”¨configManagerä¿å­˜é…ç½®
            if (this.configManager && typeof this.configManager.setConfig === 'function') {
                await this.configManager.setConfig('promptSettings', configs.promptSettings);
            }

            // ä½¿ç”¨SillyTavernçš„ä¿å­˜æœºåˆ¶
            if (typeof saveSettingsDebounced === 'function') {
                saveSettingsDebounced();
            }

            console.log('[InfoBarSettings] âœ… æç¤ºè¯è®¾ç½®å·²ä¿å­˜:', { mode, customContentLength: customContent.length });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æç¤ºè¯è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åŠ è½½æç¤ºè¯è®¾ç½®
     */
    async loadPromptSettings() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const promptSettings = configs.promptSettings || {};

            // è®¾ç½®é»˜è®¤å€¼
            const mode = promptSettings.mode || 'smart';
            const customContent = promptSettings.customContent || '';

            // æ›´æ–°UI
            const smartRadio = this.modal.querySelector('#smart-prompt-mode');
            const customRadio = this.modal.querySelector('#custom-prompt-mode');
            const customTextarea = this.modal.querySelector('#custom-prompt-content');

            if (smartRadio && customRadio) {
                if (mode === 'smart') {
                    smartRadio.checked = true;
                } else {
                    customRadio.checked = true;
                }
            }

            if (customTextarea) {
                customTextarea.value = customContent;
            }

            // è§¦å‘æ¨¡å¼å˜åŒ–å¤„ç†
            this.handlePromptModeChange(mode);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            this.updateCustomPromptStats();

            console.log('[InfoBarSettings] âœ… æç¤ºè¯è®¾ç½®å·²åŠ è½½:', { mode, customContentLength: customContent.length });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æç¤ºè¯è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * åˆå§‹åŒ–NPCç®¡ç†é¢æ¿å†…å®¹
     */
    initNPCManagementPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ­ åˆå§‹åŒ–NPCç®¡ç†é¢æ¿å†…å®¹...');

            // ğŸ†• å¡«å……NPCæ•°æ®æºé¢æ¿é€‰é¡¹
            this.populateNPCSourcePanelOptions();

            // ğŸ†• å¡«å……ä¸–ç•Œä¹¦é€‰é¡¹
            this.populateNPCWorldBookOptions();

            // ğŸ”§ ä¿®å¤ï¼šåˆå§‹åŒ–å®Œæˆåï¼Œç«‹å³æ¢å¤NPCè®¾ç½®
            this.restoreNPCSettings();

            // ğŸ¯ æ–°å¢ï¼šåˆå§‹åŒ–NPC AIæ¶ˆæ¯è®¡æ•°
            this.initNpcAiMessageCount();

            // åˆ·æ–°NPCåˆ—è¡¨
            this.refreshNPCList();

            // ç»‘å®šæœç´¢äº‹ä»¶
            const searchInput = this.modal.querySelector('#npc-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.filterNPCList(e.target.value);
                });
            }

            // ğŸ†• ç»‘å®šæ•°æ®æºé¢æ¿é€‰æ‹©äº‹ä»¶
            const sourcePanelSelect = this.modal.querySelector('#npc-source-panel-select');
            if (sourcePanelSelect) {
                sourcePanelSelect.addEventListener('change', (e) => {
                    this.handleNPCSourcePanelChange(e.target.value);
                });
            }

            // ğŸ†• ç»‘å®šä¸–ç•Œä¹¦é€‰æ‹©äº‹ä»¶
            const worldBookSelect = this.modal.querySelector('#npc-target-worldbook-select');
            if (worldBookSelect) {
                worldBookSelect.addEventListener('change', (e) => {
                    this.handleNPCWorldBookChange(e.target.value);
                });
            }

            console.log('[InfoBarSettings] âœ… NPCç®¡ç†é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–NPCç®¡ç†é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ“– åˆå§‹åŒ–å‰§æƒ…ä¼˜åŒ–é¢æ¿å†…å®¹
     */
    async initPlotOptimizationPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“– åˆå§‹åŒ–å‰§æƒ…ä¼˜åŒ–é¢æ¿å†…å®¹...');

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            const enabledCheckbox = this.modal.querySelector('#plot-optimization-enabled');
            if (enabledCheckbox) {
                // å…‹éš†èŠ‚ç‚¹æ›¿æ¢ï¼Œç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newCheckbox = enabledCheckbox.cloneNode(true);
                enabledCheckbox.parentNode.replaceChild(newCheckbox, enabledCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    this.handlePlotOptimizationEnabledChange(e.target.checked);
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const editTemplateBtn = this.modal.querySelector('#plot-optimization-edit-template-btn');
            if (editTemplateBtn) {
                const newEditBtn = editTemplateBtn.cloneNode(true);
                editTemplateBtn.parentNode.replaceChild(newEditBtn, editTemplateBtn);

                newEditBtn.addEventListener('click', () => {
                    this.showPlotOptimizationTemplateEditor();
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const previewBtn = this.modal.querySelector('#plot-optimization-preview-btn');
            if (previewBtn) {
                const newPreviewBtn = previewBtn.cloneNode(true);
                previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);

                newPreviewBtn.addEventListener('click', () => {
                    this.showPlotOptimizationPreview();
                });
            }

            // ğŸ†• æ–°å¢ï¼šä½œå®¶æ–‡é£æ¨¡ä»¿åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
            const imitateAuthorCheckbox = this.modal.querySelector('#plot-optimization-imitate-author-enabled');
            if (imitateAuthorCheckbox) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newCheckbox = imitateAuthorCheckbox.cloneNode(true);
                imitateAuthorCheckbox.parentNode.replaceChild(newCheckbox, imitateAuthorCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    const optionsDiv = this.modal.querySelector('#author-imitate-options');
                    if (optionsDiv) {
                        optionsDiv.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            }

            // ğŸ†• æ–°å¢ï¼šåˆ†æä½œå®¶æŒ‰é’®äº‹ä»¶
            const analyzeAuthorBtn = this.modal.querySelector('#analyze-author-btn');
            if (analyzeAuthorBtn) {
                const newBtn = analyzeAuthorBtn.cloneNode(true);
                analyzeAuthorBtn.parentNode.replaceChild(newBtn, analyzeAuthorBtn);

                newBtn.addEventListener('click', async () => {
                    await this.handleAnalyzeAuthor();
                });
            }

            // ğŸ†• æ–°å¢ï¼šåˆ·æ–°æ–‡é£åˆ†ææŒ‰é’®äº‹ä»¶
            const refreshStyleBtn = this.modal.querySelector('#refresh-author-style-btn');
            if (refreshStyleBtn) {
                const newBtn = refreshStyleBtn.cloneNode(true);
                refreshStyleBtn.parentNode.replaceChild(newBtn, refreshStyleBtn);

                newBtn.addEventListener('click', async () => {
                    await this.handleAnalyzeAuthor(true); // å¼ºåˆ¶åˆ·æ–°
                });
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            this.updatePlotOptimizationStatus();

            // ğŸ†• æ–°å¢ï¼šæ¢å¤å·²ç¼“å­˜çš„ä½œå®¶æ–‡é£åˆ†æç»“æœ
            await this.restoreAuthorStyleAnalysis();

            console.log('[InfoBarSettings] âœ… å‰§æƒ…ä¼˜åŒ–é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–å‰§æƒ…ä¼˜åŒ–é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åˆå§‹åŒ–APIé…ç½®é¢æ¿å†…å®¹
     */
    async initAPIPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ”Œ åˆå§‹åŒ–APIé…ç½®é¢æ¿å†…å®¹...');

            // ğŸ”§ è¯»å–é…ç½®
            const context = window.SillyTavern?.getContext?.();
            const apiConfig = context?.extensionSettings?.['Information bar integration tool']?.apiConfig || {};

            // ç»‘å®šè¯»å–ä¸–ç•Œä¹¦checkboxäº‹ä»¶
            const includeWorldbookCheckbox = this.modal.querySelector('#api-include-worldbook');
            if (includeWorldbookCheckbox) {
                const newCheckbox = includeWorldbookCheckbox.cloneNode(true);
                includeWorldbookCheckbox.parentNode.replaceChild(newCheckbox, includeWorldbookCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    const worldbookSourceSelection = this.modal.querySelector('#worldbook-source-selection');
                    if (worldbookSourceSelection) {
                        worldbookSourceSelection.style.display = e.target.checked ? 'block' : 'none';
                    }

                    console.log('[InfoBarSettings] ğŸ“š è¯»å–ä¸–ç•Œä¹¦', e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨');
                });

                // åˆå§‹åŒ–æ—¶æ ¹æ®checkboxçŠ¶æ€æ˜¾ç¤º/éšè—ä¸–ç•Œä¹¦æ¥æºé€‰æ‹©
                const worldbookSourceSelection = this.modal.querySelector('#worldbook-source-selection');
                if (worldbookSourceSelection) {
                    worldbookSourceSelection.style.display = newCheckbox.checked ? 'block' : 'none';
                }
            }

            // ç»‘å®šä¸–ç•Œä¹¦æ¥æºé€‰æ‹©äº‹ä»¶
            const worldbookSourceSelect = this.modal.querySelector('#api-worldbook-source');
            if (worldbookSourceSelect) {
                // ğŸ”§ æ¢å¤ä¿å­˜çš„å€¼
                if (apiConfig.worldbookSource) {
                    worldbookSourceSelect.value = apiConfig.worldbookSource;
                    console.log('[InfoBarSettings] ğŸ”„ æ¢å¤ä¸–ç•Œä¹¦æ¥æºé…ç½®:', apiConfig.worldbookSource);
                }

                const newSelect = worldbookSourceSelect.cloneNode(true);
                // ğŸ”§ ä¿æŒæ¢å¤çš„å€¼
                newSelect.value = worldbookSourceSelect.value;
                worldbookSourceSelect.parentNode.replaceChild(newSelect, worldbookSourceSelect);

                newSelect.addEventListener('change', async (e) => {
                    const customSelection = this.modal.querySelector('#custom-worldbook-selection');
                    if (customSelection) {
                        const isCustom = e.target.value === 'custom';
                        customSelection.style.display = isCustom ? 'block' : 'none';
                        
                        // å¦‚æœåˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼ï¼ŒåŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨
                        if (isCustom) {
                            await this.loadWorldbookListForAPI();
                        }
                    }

                    console.log('[InfoBarSettings] ğŸ“š ä¸–ç•Œä¹¦æ¥æºåˆ‡æ¢:', e.target.value);
                });

                // åˆå§‹åŒ–æ—¶æ ¹æ®é€‰æ‹©æ˜¾ç¤º/éšè—è‡ªå®šä¹‰ä¸–ç•Œä¹¦é€‰æ‹©åŒºåŸŸ
                const customSelection = this.modal.querySelector('#custom-worldbook-selection');
                if (customSelection && newSelect.value === 'custom') {
                    customSelection.style.display = 'block';
                    await this.loadWorldbookListForAPI();
                }
            }

            // ç»‘å®šå…¨é€‰/å–æ¶ˆå…¨é€‰æŒ‰é’®
            const selectAllBtn = this.modal.querySelector('#worldbook-select-all-btn');
            if (selectAllBtn) {
                const newBtn = selectAllBtn.cloneNode(true);
                selectAllBtn.parentNode.replaceChild(newBtn, selectAllBtn);

                newBtn.addEventListener('click', () => {
                    const checkboxes = this.modal.querySelectorAll('#worldbook-list-container input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = true);
                    console.log('[InfoBarSettings] âœ… å·²å…¨é€‰ä¸–ç•Œä¹¦');
                });
            }

            const deselectAllBtn = this.modal.querySelector('#worldbook-deselect-all-btn');
            if (deselectAllBtn) {
                const newBtn = deselectAllBtn.cloneNode(true);
                deselectAllBtn.parentNode.replaceChild(newBtn, deselectAllBtn);

                newBtn.addEventListener('click', () => {
                    const checkboxes = this.modal.querySelectorAll('#worldbook-list-container input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = false);
                    console.log('[InfoBarSettings] âŒ å·²å–æ¶ˆå…¨é€‰ä¸–ç•Œä¹¦');
                });
            }

            console.log('[InfoBarSettings] âœ… APIé…ç½®é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–APIé…ç½®é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨ï¼ˆç”¨äºAPIé…ç½®ï¼‰
     */
    async loadWorldbookListForAPI() {
        try {
            console.log('[InfoBarSettings] ğŸ“š åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨...');

            const container = this.modal.querySelector('#worldbook-list-container');
            if (!container) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œä¹¦åˆ—è¡¨å®¹å™¨');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div style="text-align: center; color: var(--theme-text-secondary, #888); padding: 20px;">åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨ä¸­...</div>';

            // è·å–ä¸–ç•Œä¹¦ç®¡ç†å™¨
            const worldBookManager = window.SillyTavernInfobar?.modules?.worldBookManager;
            if (!worldBookManager) {
                container.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåˆå§‹åŒ–</div>';
                return;
            }

            // è·å–æ‰€æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦
            const worldBooks = await worldBookManager.getAvailableWorldBooks();
            
            if (!worldBooks || worldBooks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--theme-text-secondary, #888); padding: 20px;">æœªæ‰¾åˆ°å¯ç”¨çš„ä¸–ç•Œä¹¦</div>';
                return;
            }

            // è¯»å–å·²ä¿å­˜çš„é€‰æ‹©
            const context = window.SillyTavern?.getContext?.();
            const apiConfig = context?.extensionSettings?.['Information bar integration tool']?.apiConfig || {};
            const selectedWorldbooks = apiConfig.customSelectedWorldbooks || [];

            // ç”Ÿæˆä¸–ç•Œä¹¦åˆ—è¡¨HTML
            let html = '';
            worldBooks.forEach(wb => {
                const bookName = wb.name || wb.uid || 'Unknown';
                const bookUid = wb.uid || wb.name;
                const isSelected = selectedWorldbooks.includes(bookUid);
                
                html += `
                    <div class="worldbook-item" style="
                        padding: 8px 12px;
                        margin-bottom: 6px;
                        background: var(--infobar-bg, var(--theme-bg-tertiary, #1a1a1a));
                        border: 1px solid var(--infobar-border, var(--theme-border-color, #333));
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='var(--infobar-hover, var(--theme-bg-secondary, #2a2a2a))'"
                    onmouseout="this.style.background='var(--infobar-bg, var(--theme-bg-tertiary, #1a1a1a))'">
                        <input type="checkbox" 
                               class="worldbook-checkbox" 
                               data-worldbook-uid="${this.escapeHtml(bookUid)}" 
                               ${isSelected ? 'checked' : ''}
                               style="cursor: pointer; accent-color: var(--infobar-primary, var(--theme-primary-color, #4CAF50));">
                        <label style="
                            flex: 1;
                            cursor: pointer;
                            margin: 0;
                            color: var(--infobar-text, var(--theme-text-primary, #ddd));
                            font-size: 13px;
                        " onclick="this.previousElementSibling.click()">
                            ğŸ“– ${this.escapeHtml(bookName)}
                        </label>
                    </div>
                `;
            });

            container.innerHTML = html;

            // ç»‘å®šcheckboxäº‹ä»¶
            const checkboxes = container.querySelectorAll('.worldbook-checkbox');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    this.saveSelectedWorldbooks();
                });
            });

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…±', worldBooks.length, 'æœ¬');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨å¤±è´¥:', error);
            const container = this.modal.querySelector('#worldbook-list-container');
            if (container) {
                container.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }
    }

    /**
     * ğŸ†• ä¿å­˜é€‰ä¸­çš„ä¸–ç•Œä¹¦
     */
    saveSelectedWorldbooks() {
        try {
            const checkboxes = this.modal.querySelectorAll('.worldbook-checkbox:checked');
            const selectedWorldbooks = Array.from(checkboxes).map(cb => cb.getAttribute('data-worldbook-uid'));

            // ä¿å­˜åˆ°é…ç½®
            const context = window.SillyTavern?.getContext?.();
            const extensionSettings = context?.extensionSettings;
            if (!extensionSettings['Information bar integration tool'].apiConfig) {
                extensionSettings['Information bar integration tool'].apiConfig = {};
            }
            
            extensionSettings['Information bar integration tool'].apiConfig.customSelectedWorldbooks = selectedWorldbooks;
            
            console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜é€‰ä¸­çš„ä¸–ç•Œä¹¦:', selectedWorldbooks);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é€‰ä¸­ä¸–ç•Œä¹¦å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åˆå§‹åŒ–æ•°æ®è¡¨æ ¼é…ç½®é¢æ¿å†…å®¹
     */
    initDataTableConfigPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š åˆå§‹åŒ–æ•°æ®è¡¨æ ¼é…ç½®é¢æ¿å†…å®¹...');

            // ç»‘å®šå¯ç”¨æ•°æ®è¡¨æ ¼checkboxäº‹ä»¶
            const enabledCheckbox = this.modal.querySelector('#data-table-enabled');
            if (enabledCheckbox) {
                const newCheckbox = enabledCheckbox.cloneNode(true);
                enabledCheckbox.parentNode.replaceChild(newCheckbox, enabledCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    const apiModeSelection = this.modal.querySelector('#data-table-api-mode-selection');
                    const featuresSection = this.modal.querySelector('#data-table-features-section');
                    
                    const display = e.target.checked ? 'block' : 'none';
                    if (apiModeSelection) apiModeSelection.style.display = display;
                    if (featuresSection) featuresSection.style.display = display;

                    // åŒæ­¥åˆ°åŸºç¡€è®¾ç½®çš„checkboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const basicCheckbox = this.modal.querySelector('#table-records-checkbox');
                    if (basicCheckbox) {
                        basicCheckbox.checked = e.target.checked;
                    }

                    console.log('[InfoBarSettings] ğŸ“Š æ•°æ®è¡¨æ ¼åŠŸèƒ½', e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨');
                });
            }

            // ç»‘å®šå¯ç”¨çŠ¶æ€æ æ˜¾ç¤ºcheckboxäº‹ä»¶
            const renderInChatCheckbox = this.modal.querySelector('#data-table-render-in-chat');
            if (renderInChatCheckbox) {
                const newCheckbox = renderInChatCheckbox.cloneNode(true);
                renderInChatCheckbox.parentNode.replaceChild(newCheckbox, renderInChatCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    // åŒæ­¥åˆ°åŸºç¡€è®¾ç½®çš„checkboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const basicCheckbox = this.modal.querySelector('#render-in-chat-checkbox');
                    if (basicCheckbox) {
                        basicCheckbox.checked = e.target.checked;
                    }

                    console.log('[InfoBarSettings] ğŸ“Š çŠ¶æ€æ æ˜¾ç¤º', e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨');
                });
            }

            // ç»‘å®šä¿¡æ¯æ é»˜è®¤æŠ˜å checkboxäº‹ä»¶
            const defaultCollapsedCheckbox = this.modal.querySelector('#data-table-default-collapsed');
            if (defaultCollapsedCheckbox) {
                const newCheckbox = defaultCollapsedCheckbox.cloneNode(true);
                defaultCollapsedCheckbox.parentNode.replaceChild(newCheckbox, defaultCollapsedCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    // åŒæ­¥åˆ°åŸºç¡€è®¾ç½®çš„checkboxï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const basicCheckbox = this.modal.querySelector('#default-collapsed-checkbox');
                    if (basicCheckbox) {
                        basicCheckbox.checked = e.target.checked;
                    }

                    console.log('[InfoBarSettings] ğŸ“Š ä¿¡æ¯æ é»˜è®¤æŠ˜å ', e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨');
                });
            }

            // ç»‘å®šAPIæ¨¡å¼æŒ‰é’®äº‹ä»¶
            const apiModeButtons = this.modal.querySelectorAll('.data-table-api-mode-btn');
            apiModeButtons.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', async () => {
                    const mode = newBtn.getAttribute('data-mode');

                    // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æŸ¥è¯¢æ‰€æœ‰æŒ‰é’®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å·²å¤±æ•ˆçš„ NodeList
                    const currentButtons = this.modal.querySelectorAll('.data-table-api-mode-btn');
                    currentButtons.forEach(currentBtn => {
                        if (currentBtn === newBtn) return;

                        // é‡ç½®å…¶ä»–æŒ‰é’®çš„æ ·å¼
                        currentBtn.style.background = 'var(--theme-bg-tertiary, #1a1a1a)';
                        currentBtn.style.border = '1px solid var(--theme-border-color, #333)';
                        currentBtn.style.fontWeight = 'normal';
                        currentBtn.classList.remove('active');
                    });

                    // è®¾ç½®å½“å‰æŒ‰é’®çš„æ¿€æ´»æ ·å¼
                    newBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    newBtn.style.border = 'none';
                    newBtn.style.fontWeight = '500';
                    newBtn.classList.add('active');

                    // æ›´æ–°æè¿°æ˜¾ç¤º
                    const mainDesc = this.modal.querySelector('.main-mode-desc');
                    const customDesc = this.modal.querySelector('.custom-mode-desc');
                    if (mainDesc) mainDesc.style.display = mode === 'main' ? 'block' : 'none';
                    if (customDesc) customDesc.style.display = mode === 'custom' ? 'block' : 'none';

                    console.log('[InfoBarSettings] ğŸ“Š åˆ‡æ¢æ•°æ®è¡¨æ ¼APIæ¨¡å¼:', mode);

                    // ğŸ”§ ä¿®å¤ï¼šä¿å­˜é…ç½®åˆ°æ‰©å±•è®¾ç½®
                    try {
                        const context = SillyTavern.getContext();
                        const extensionSettings = context.extensionSettings;
                        const configs = extensionSettings['Information bar integration tool'] || {};

                        if (!configs.basic) configs.basic = {};
                        if (!configs.basic.tableRecords) configs.basic.tableRecords = {};

                        configs.basic.tableRecords.apiMode = mode;

                        extensionSettings['Information bar integration tool'] = configs;
                        await context.saveSettingsDebounced();

                        console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼APIæ¨¡å¼å·²ä¿å­˜:', mode);
                    } catch (error) {
                        console.error('[InfoBarSettings] âŒ ä¿å­˜æ•°æ®è¡¨æ ¼APIæ¨¡å¼å¤±è´¥:', error);
                    }
                });
            });

            // ç»‘å®šå»¶è¿Ÿç”Ÿæˆcheckboxäº‹ä»¶
            const delayedGenCheckbox = this.modal.querySelector('#data-table-delayed-generation');
            if (delayedGenCheckbox) {
                const newCheckbox = delayedGenCheckbox.cloneNode(true);
                delayedGenCheckbox.parentNode.replaceChild(newCheckbox, delayedGenCheckbox);

                newCheckbox.addEventListener('change', (e) => {
                    const delayedConfig = this.modal.querySelector('.data-table-delayed-config');
                    if (delayedConfig) {
                        delayedConfig.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            }

            console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼é…ç½®é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ•°æ®è¡¨æ ¼é…ç½®é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ¢å¤å·²ç¼“å­˜çš„ä½œå®¶æ–‡é£åˆ†æç»“æœ
     */
    async restoreAuthorStyleAnalysis() {
        try {
            const config = this.getPlotOptimizationConfig();
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ä½œå®¶æ¨¡ä»¿ä¸”æœ‰ç›®æ ‡ä½œå®¶
            if (!config.imitateAuthorEnabled || !config.targetAuthor) {
                console.log('[InfoBarSettings] â„¹ï¸ æœªå¯ç”¨ä½œå®¶æ¨¡ä»¿æˆ–æœªè®¾ç½®ç›®æ ‡ä½œå®¶ï¼Œè·³è¿‡æ¢å¤');
                return;
            }

            console.log('[InfoBarSettings] ğŸ”„ æ¢å¤ä½œå®¶æ–‡é£åˆ†æ:', config.targetAuthor);

            const authorStyleManager = window.SillyTavernInfobar?.modules?.authorStyleManager;
            if (!authorStyleManager) {
                console.warn('[InfoBarSettings] âš ï¸ AuthorStyleManageræœªåˆå§‹åŒ–');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜
            const cachedStyle = authorStyleManager.authorStyles.get(config.targetAuthor);
            if (!cachedStyle) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰ç¼“å­˜çš„æ–‡é£åˆ†ææ•°æ®');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            const previewDiv = this.modal.querySelector('#author-style-preview');
            const contentDiv = this.modal.querySelector('#author-style-content');
            
            if (!previewDiv || !contentDiv) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é¢„è§ˆåŒºåŸŸDOMå…ƒç´ ');
                return;
            }

            previewDiv.style.display = 'block';

            // ç”ŸæˆHTMLå±•ç¤ºï¼ˆå¤ç”¨handleAnalyzeAuthorä¸­çš„é€»è¾‘ï¼‰
            let html = '';

            // ä»£è¡¨ä½œå“
            if (cachedStyle.ä»£è¡¨ä½œå“ && cachedStyle.ä»£è¡¨ä½œå“.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ“š ä»£è¡¨ä½œå“</strong><br>
                    <span style="color: var(--theme-text-secondary, #aaa);">${cachedStyle.ä»£è¡¨ä½œå“.join('ã€')}</span>
                </div>`;
            }

            // æ ¸å¿ƒå†™ä½œç‰¹ç‚¹
            if (cachedStyle.å†™ä½œç‰¹ç‚¹ && cachedStyle.å†™ä½œç‰¹ç‚¹.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">âœï¸ æ ¸å¿ƒå†™ä½œç‰¹ç‚¹</strong><br>`;
                cachedStyle.å†™ä½œç‰¹ç‚¹.forEach((item, index) => {
                    html += `<span style="color: var(--theme-text-secondary, #aaa); display: block; margin-left: 8px;">
                        ${index + 1}. ${item}
                    </span>`;
                });
                html += `</div>`;
            }

            // è¯­è¨€é£æ ¼
            if (cachedStyle.è¯­è¨€é£æ ¼) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ¨ è¯­è¨€é£æ ¼</strong><br>
                    <span style="color: var(--theme-text-secondary, #aaa);">${cachedStyle.è¯­è¨€é£æ ¼}</span>
                </div>`;
            }

            // æ–‡é£æ ‡ç­¾
            if (cachedStyle.æ–‡é£æ ‡ç­¾ && cachedStyle.æ–‡é£æ ‡ç­¾.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ·ï¸ æ–‡é£æ ‡ç­¾</strong><br>`;
                cachedStyle.æ–‡é£æ ‡ç­¾.forEach(tag => {
                    html += `<span style="
                        display: inline-block;
                        padding: 2px 8px;
                        margin: 2px 4px 2px 0;
                        background: rgba(76, 175, 80, 0.2);
                        color: var(--theme-primary-color, #4CAF50);
                        border-radius: 4px;
                        font-size: 12px;
                    ">${tag}</span>`;
                });
                html += `</div>`;
            }

            // æ¨¡ä»¿å»ºè®®ï¼ˆç®€ç•¥ï¼‰
            if (cachedStyle.æ¨¡ä»¿å»ºè®® && cachedStyle.æ¨¡ä»¿å»ºè®®.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ’¡ æ¨¡ä»¿å»ºè®®ï¼ˆå‰3æ¡ï¼‰</strong><br>`;
                cachedStyle.æ¨¡ä»¿å»ºè®®.slice(0, 3).forEach((item, index) => {
                    html += `<span style="color: var(--theme-text-secondary, #aaa); display: block; margin-left: 8px; font-size: 12px;">
                        ${index + 1}. ${item}
                    </span>`;
                });
                if (cachedStyle.æ¨¡ä»¿å»ºè®®.length > 3) {
                    html += `<span style="color: var(--theme-text-secondary, #666); display: block; margin-left: 8px; font-size: 12px;">
                        ...å…±${cachedStyle.æ¨¡ä»¿å»ºè®®.length}æ¡å»ºè®®
                    </span>`;
                }
                html += `</div>`;
            }

            // æ•°æ®æ¥æº
            const source = cachedStyle.source === 'builtin' ? 'å†…ç½®æ•°æ®' : cachedStyle.source === 'ai' ? 'AIåˆ†æ' : 'ç¼“å­˜æ•°æ®';
            html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border-color, #333);">
                <span style="color: var(--theme-text-secondary, #666); font-size: 12px;">
                    æ•°æ®æ¥æºï¼š${source} | ç¼“å­˜æ—¶é—´ï¼š${new Date(cachedStyle.cachedAt).toLocaleString()}
                </span>
            </div>`;

            contentDiv.innerHTML = html;

            console.log('[InfoBarSettings] âœ… å·²æ¢å¤ä½œå®¶æ–‡é£åˆ†æç»“æœ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤ä½œå®¶æ–‡é£åˆ†æå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†åˆ†æä½œå®¶æ–‡é£
     */
    async handleAnalyzeAuthor(forceRefresh = false) {
        try {
            const authorInput = this.modal.querySelector('#plot-optimization-target-author');
            const previewDiv = this.modal.querySelector('#author-style-preview');
            const contentDiv = this.modal.querySelector('#author-style-content');
            const analyzeBtn = this.modal.querySelector('#analyze-author-btn');

            if (!authorInput || !previewDiv || !contentDiv) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }

            const authorName = authorInput.value.trim();
            if (!authorName) {
                this.showNotification('âš ï¸ è¯·è¾“å…¥ä½œå®¶åç§°', 'warning');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            previewDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; padding: 20px;">ğŸ”„ æ­£åœ¨åˆ†æä½œå®¶æ–‡é£ï¼Œè¯·ç¨å€™...</div>';
            
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'åˆ†æä¸­...';
            }

            // è·å–AuthorStyleManager
            const authorStyleManager = window.SillyTavernInfobar?.modules?.authorStyleManager;
            if (!authorStyleManager) {
                throw new Error('AuthorStyleManageræœªåˆå§‹åŒ–');
            }

            console.log('[InfoBarSettings] ğŸ“š å¼€å§‹åˆ†æä½œå®¶:', authorName);

            // è°ƒç”¨åˆ†æ
            const styleData = await authorStyleManager.getAuthorStyle(authorName, forceRefresh);

            // ç”ŸæˆHTMLå±•ç¤º
            let html = '';

            // ä»£è¡¨ä½œå“
            if (styleData.ä»£è¡¨ä½œå“ && styleData.ä»£è¡¨ä½œå“.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ“š ä»£è¡¨ä½œå“</strong><br>
                    <span style="color: var(--theme-text-secondary, #aaa);">${styleData.ä»£è¡¨ä½œå“.join('ã€')}</span>
                </div>`;
            }

            // æ ¸å¿ƒå†™ä½œç‰¹ç‚¹
            if (styleData.å†™ä½œç‰¹ç‚¹ && styleData.å†™ä½œç‰¹ç‚¹.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">âœï¸ æ ¸å¿ƒå†™ä½œç‰¹ç‚¹</strong><br>`;
                styleData.å†™ä½œç‰¹ç‚¹.forEach((item, index) => {
                    html += `<span style="color: var(--theme-text-secondary, #aaa); display: block; margin-left: 8px;">
                        ${index + 1}. ${item}
                    </span>`;
                });
                html += `</div>`;
            }

            // è¯­è¨€é£æ ¼
            if (styleData.è¯­è¨€é£æ ¼) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ¨ è¯­è¨€é£æ ¼</strong><br>
                    <span style="color: var(--theme-text-secondary, #aaa);">${styleData.è¯­è¨€é£æ ¼}</span>
                </div>`;
            }

            // æ–‡é£æ ‡ç­¾
            if (styleData.æ–‡é£æ ‡ç­¾ && styleData.æ–‡é£æ ‡ç­¾.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ·ï¸ æ–‡é£æ ‡ç­¾</strong><br>`;
                styleData.æ–‡é£æ ‡ç­¾.forEach(tag => {
                    html += `<span style="
                        display: inline-block;
                        padding: 2px 8px;
                        margin: 2px 4px 2px 0;
                        background: rgba(76, 175, 80, 0.2);
                        color: var(--theme-primary-color, #4CAF50);
                        border-radius: 4px;
                        font-size: 12px;
                    ">${tag}</span>`;
                });
                html += `</div>`;
            }

            // æ¨¡ä»¿å»ºè®®ï¼ˆç®€ç•¥ï¼‰
            if (styleData.æ¨¡ä»¿å»ºè®® && styleData.æ¨¡ä»¿å»ºè®®.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong style="color: var(--theme-primary-color, #4CAF50);">ğŸ’¡ æ¨¡ä»¿å»ºè®®ï¼ˆå‰3æ¡ï¼‰</strong><br>`;
                styleData.æ¨¡ä»¿å»ºè®®.slice(0, 3).forEach((item, index) => {
                    html += `<span style="color: var(--theme-text-secondary, #aaa); display: block; margin-left: 8px; font-size: 12px;">
                        ${index + 1}. ${item}
                    </span>`;
                });
                if (styleData.æ¨¡ä»¿å»ºè®®.length > 3) {
                    html += `<span style="color: var(--theme-text-secondary, #666); display: block; margin-left: 8px; font-size: 12px;">
                        ...å…±${styleData.æ¨¡ä»¿å»ºè®®.length}æ¡å»ºè®®
                    </span>`;
                }
                html += `</div>`;
            }

            // æ•°æ®æ¥æº
            const source = styleData.source === 'builtin' ? 'å†…ç½®æ•°æ®' : styleData.source === 'ai' ? 'AIåˆ†æ' : 'ç¼“å­˜æ•°æ®';
            html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border-color, #333);">
                <span style="color: var(--theme-text-secondary, #666); font-size: 12px;">
                    æ•°æ®æ¥æºï¼š${source} | ç¼“å­˜æ—¶é—´ï¼š${new Date(styleData.cachedAt).toLocaleString()}
                </span>
            </div>`;

            contentDiv.innerHTML = html;

            console.log('[InfoBarSettings] âœ… ä½œå®¶æ–‡é£åˆ†æå®Œæˆ');
            this.showNotification(`âœ… ä½œå®¶"${authorName}"çš„æ–‡é£åˆ†æå®Œæˆ`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ†æä½œå®¶æ–‡é£å¤±è´¥:', error);
            
            const contentDiv = this.modal.querySelector('#author-style-content');
            if (contentDiv) {
                contentDiv.innerHTML = `<div style="color: #f44336; padding: 12px;">
                    âŒ åˆ†æå¤±è´¥: ${error.message}<br>
                    <span style="font-size: 12px; color: #888;">
                        è¯·æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åé‡è¯•
                    </span>
                </div>`;
            }
            
            this.showNotification(`âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const analyzeBtn = this.modal.querySelector('#analyze-author-btn');
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸ” åˆ†æ';
            }
        }
    }

    /**
     * ğŸ“– å¤„ç†å‰§æƒ…ä¼˜åŒ–å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handlePlotOptimizationEnabledChange(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ“– å‰§æƒ…ä¼˜åŒ–${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusText = this.modal.querySelector('#plot-optimization-status-text');
            if (statusText) {
                statusText.textContent = enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
            }

            // é€šçŸ¥å‰§æƒ…ä¼˜åŒ–ç³»ç»Ÿ
            const plotOptimizationSystem = window.SillyTavernInfobar?.modules?.plotOptimizationSystem;
            if (plotOptimizationSystem) {
                plotOptimizationSystem.setEnabled(enabled);
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰§æƒ…ä¼˜åŒ–å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ“– æ˜¾ç¤ºå‰§æƒ…ä¼˜åŒ–æ¨¡æ¿ç¼–è¾‘å™¨
     */
    async showPlotOptimizationTemplateEditor() {
        try {
            console.log('[InfoBarSettings] ğŸ“– æ‰“å¼€å‰§æƒ…ä¼˜åŒ–æ¨¡æ¿ç¼–è¾‘å™¨...');

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å¯¹è¯æ¡†ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆç§»é™¤
            const existingDialog = document.querySelector('.plot-optimization-template-editor-dialog');
            if (existingDialog) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°å·²å­˜åœ¨çš„æ¨¡æ¿ç¼–è¾‘å™¨å¯¹è¯æ¡†ï¼Œå…ˆç§»é™¤');
                existingDialog.parentElement.remove();
            }

            // è¯»å–æ¨¡æ¿æ–‡ä»¶
            const templatePath = 'scripts/extensions/third-party/Information bar integration tool/å‰§æƒ…ä¼˜åŒ–æç¤ºè¯';
            let templateContent = '';

            try {
                const response = await fetch(templatePath);
                if (response.ok) {
                    templateContent = await response.text();
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿');
                    templateContent = '# å‰§æƒ…ä¼˜åŒ–æç¤ºè¯\n\nè¯·åœ¨è¿™é‡Œç¼–è¾‘å‰§æƒ…ä¼˜åŒ–çš„æç¤ºè¯æ¨¡æ¿...';
                }
            } catch (error) {
                console.warn('[InfoBarSettings] âš ï¸ è¯»å–æ¨¡æ¿æ–‡ä»¶å¤±è´¥:', error);
                templateContent = '# å‰§æƒ…ä¼˜åŒ–æç¤ºè¯\n\nè¯·åœ¨è¿™é‡Œç¼–è¾‘å‰§æƒ…ä¼˜åŒ–çš„æç¤ºè¯æ¨¡æ¿...';
            }

            // åˆ›å»ºç¼–è¾‘å™¨å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'plot-optimization-template-editor-dialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                backdrop-filter: blur(4px);
            `;

            dialog.innerHTML = `
                <div class="plot-optimization-template-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border-radius: 12px;
                    padding: 24px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 20px;">ğŸ“– ç¼–è¾‘å‰§æƒ…ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿</h3>
                        <button class="dialog-close-btn" style="
                            background: transparent;
                            border: none;
                            color: var(--theme-text-secondary, #888);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">Ã—</button>
                    </div>

                    <textarea id="plot-optimization-template-editor" style="
                        flex: 1;
                        width: 100%;
                        padding: 12px;
                        background: var(--theme-bg-secondary, #1a1a1a);
                        color: var(--theme-text-primary, #e0e0e0);
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 6px;
                        font-family: 'Consolas', 'Monaco', monospace;
                        font-size: 13px;
                        line-height: 1.5;
                        resize: none;
                    ">${this.escapeHtml(templateContent)}</textarea>

                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button class="btn-cancel" style="
                            padding: 10px 20px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            color: var(--theme-text-primary, #e0e0e0);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                        <button class="btn-save" style="
                            padding: 10px 20px;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">ä¿å­˜</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            if (!document.body) {
                console.error('[InfoBarSettings] âŒ document.bodyä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ å¯¹è¯æ¡†');
                return;
            }
            const dialogElement = dialog.firstElementChild;
            document.body.appendChild(dialogElement);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogElement.querySelector('.dialog-close-btn');
            const cancelBtn = dialogElement.querySelector('.btn-cancel');
            const saveBtn = dialogElement.querySelector('.btn-save');
            const editor = dialogElement.querySelector('#plot-optimization-template-editor');

            const closeDialog = () => {
                dialogElement.remove();
            };

            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) closeDialog();
            });

            saveBtn.addEventListener('click', () => {
                const newTemplate = editor.value;
                // ä¿å­˜åˆ°é…ç½®
                const context = SillyTavern.getContext();
                const settings = context.extensionSettings['Information bar integration tool'] || {};
                if (!settings.plotOptimization) {
                    settings.plotOptimization = {};
                }
                settings.plotOptimization.promptTemplate = newTemplate;
                context.saveSettingsDebounced();

                // é€šçŸ¥å‰§æƒ…ä¼˜åŒ–ç³»ç»Ÿ
                const plotOptimizationSystem = window.SillyTavernInfobar?.modules?.plotOptimizationSystem;
                if (plotOptimizationSystem) {
                    plotOptimizationSystem.config.promptTemplate = newTemplate;
                }

                this.showNotification('âœ… æ¨¡æ¿å·²ä¿å­˜', 'success');
                closeDialog();
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå‰§æƒ…ä¼˜åŒ–æ¨¡æ¿ç¼–è¾‘å™¨å¤±è´¥:', error);
            this.showNotification('âŒ æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ“– æ›´æ–°å‰§æƒ…ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º
     */
    updatePlotOptimizationStatus() {
        try {
            const plotOptimizationSystem = window.SillyTavernInfobar?.modules?.plotOptimizationSystem;
            if (!plotOptimizationSystem) {
                return;
            }

            const status = plotOptimizationSystem.getStatus();

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            const statusText = this.modal.querySelector('#plot-optimization-status-text');
            if (statusText) {
                statusText.textContent = status.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
            }

            // æ›´æ–°æˆåŠŸæ¬¡æ•°
            const successCount = this.modal.querySelector('#plot-optimization-success-count');
            if (successCount) {
                successCount.textContent = status.successCount || 0;
            }

            // æ›´æ–°å¤±è´¥æ¬¡æ•°
            const errorCount = this.modal.querySelector('#plot-optimization-error-count');
            if (errorCount) {
                errorCount.textContent = status.errorCount || 0;
            }

            // æ›´æ–°æœ€åä¼˜åŒ–æ—¶é—´
            const lastTime = this.modal.querySelector('#plot-optimization-last-time');
            if (lastTime) {
                if (status.lastOptimizationTime) {
                    const date = new Date(status.lastOptimizationTime);
                    lastTime.textContent = date.toLocaleString();
                } else {
                    lastTime.textContent = 'ä»æœª';
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å‰§æƒ…ä¼˜åŒ–çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºå‰§æƒ…ä¼˜åŒ–é¢„è§ˆå¯¹è¯æ¡†
     */
    async showPlotOptimizationPreview() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ‰“å¼€å‰§æƒ…ä¼˜åŒ–é¢„è§ˆ...');

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å¯¹è¯æ¡†ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆç§»é™¤
            const existingDialog = document.querySelector('.plot-optimization-preview-dialog');
            if (existingDialog) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°å·²å­˜åœ¨çš„é¢„è§ˆå¯¹è¯æ¡†ï¼Œå…ˆç§»é™¤');
                existingDialog.remove();
            }

            const plotOptimizationSystem = window.SillyTavernInfobar?.modules?.plotOptimizationSystem;
            if (!plotOptimizationSystem) {
                this.showNotification('âŒ å‰§æƒ…ä¼˜åŒ–ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error');
                return;
            }

            const ctx = window.SillyTavern?.getContext?.();
            if (!ctx || !ctx.chat) {
                this.showNotification('âŒ æ— æ³•è·å–èŠå¤©ä¸Šä¸‹æ–‡', 'error');
                return;
            }

            // è·å–æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¿ç•™åŸå§‹æ¥¼å±‚å·ï¼‰å’Œå¯¹åº”çš„å‰§æƒ…ä¼˜åŒ–å»ºè®®
            const userEntries = ctx.chat
                .map((msg, idx) => ({ msg, floorNumber: idx + 1 }))
                .filter(e => e.msg && e.msg.is_user);
            const suggestions = plotOptimizationSystem.plotSuggestions || new Map();

            // åˆ›å»ºé¢„è§ˆå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'plot-optimization-preview-dialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            dialog.innerHTML = `
                <div style="
                    background: var(--theme-bg-primary, var(--SmartThemeBlurTintColor, #1a1a1a));
                    border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                    border-radius: 12px;
                    width: 90%;
                    max-width: 1200px;
                    max-height: 90vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                ">
                    <!-- æ ‡é¢˜æ  -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid var(--theme-border-color, #333);
                    ">
                        <h3 style="margin: 0; font-size: 20px; color: var(--theme-text-primary, #ddd);">
                            ğŸ“‹ å‰§æƒ…ä¼˜åŒ–è®°å½• (å…± ${userEntries.length} æ¡ç”¨æˆ·æ¶ˆæ¯)
                        </h3>
                        <button class="dialog-close-btn" style="
                            background: transparent;
                            border: none;
                            color: var(--theme-text-secondary, #888);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">âœ•</button>
                    </div>

                    <!-- å†…å®¹åŒºåŸŸ -->
                    <div style="
                        display: flex;
                        flex: 1;
                        overflow: hidden;
                    ">
                        <!-- å·¦ä¾§ï¼šæ¶ˆæ¯åˆ—è¡¨ -->
                        <div style="
                            width: 350px;
                            border-right: 1px solid var(--theme-border-color, #333);
                            overflow-y: auto;
                            padding: 16px;
                        " id="plot-preview-message-list">
                            ${this.renderPlotPreviewMessageList(userEntries, suggestions)}
                        </div>

                        <!-- å³ä¾§ï¼šè¯¦æƒ…ç¼–è¾‘åŒº -->
                        <div style="
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            padding: 20px;
                            overflow-y: auto;
                        " id="plot-preview-detail">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                height: 100%;
                                color: var(--theme-text-secondary, #888);
                            ">
                                è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€æ¡æ¶ˆæ¯æŸ¥çœ‹è¯¦æƒ…
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            if (!document.body) {
                console.error('[InfoBarSettings] âŒ document.bodyä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ å¯¹è¯æ¡†');
                return;
            }
            document.body.appendChild(dialog);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const closeBtn = dialog.querySelector('.dialog-close-btn');
            const closeDialog = () => {
                document.body.removeChild(dialog);
            };
            closeBtn.addEventListener('click', closeDialog);
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) closeDialog();
            });

            // ç»‘å®šæ¶ˆæ¯åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
            const messageList = dialog.querySelector('#plot-preview-message-list');
            messageList.addEventListener('click', (e) => {
                const messageItem = e.target.closest('.plot-preview-message-item');
                if (messageItem) {
                    const messageId = messageItem.dataset.messageId;
                    const floorNumber = parseInt(messageItem.dataset.floorNumber);
                    this.showPlotPreviewDetail(dialog, messageId, floorNumber, plotOptimizationSystem);
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå‰§æƒ…ä¼˜åŒ–é¢„è§ˆå¤±è´¥:', error);
            this.showNotification('âŒ æ‰“å¼€é¢„è§ˆå¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
     */
    renderPlotPreviewMessageList(userEntries, suggestions) {
        return userEntries.map((entry) => {
            const floorNumber = entry.floorNumber;
            const msg = entry.msg || {};
            const messageId = `floor_${floorNumber}`;
            const hasSuggestion = suggestions.has(messageId);
            const raw = msg.mes || '';
            const preview = raw.substring(0, 50) + (raw.length > 50 ? '...' : '');

            return `
                <div class="plot-preview-message-item"
                     data-message-id="${messageId}"
                     data-floor-number="${floorNumber}"
                     style="
                        padding: 12px;
                        margin-bottom: 8px;
                        background: var(--theme-bg-secondary, #2a2a2a);
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                    "
                    onmouseover="this.style.background='var(--theme-bg-hover, #333)'"
                    onmouseout="this.style.background='var(--theme-bg-secondary, #2a2a2a)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-weight: bold; color: var(--theme-text-primary, #ddd);">
                            #${floorNumber}
                        </span>
                        <span style="
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-size: 11px;
                            ${hasSuggestion
                                ? 'background: rgba(76, 175, 80, 0.2); color: #4CAF50;'
                                : 'background: rgba(158, 158, 158, 0.2); color: #9e9e9e;'}
                        ">
                            ${hasSuggestion ? 'âœ“ å·²ä¼˜åŒ–' : 'æœªä¼˜åŒ–'}
                        </span>
                    </div>
                    <div style="
                        font-size: 13px;
                        color: var(--theme-text-secondary, #888);
                        line-height: 1.4;
                    ">
                        ${preview}
                    </div>
                </div>
            `;
        }).join('');
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè¯¦æƒ…ç¼–è¾‘åŒº
     */
    async showPlotPreviewDetail(dialog, messageId, floorNumber, plotOptimizationSystem) {
        try {
            const detailContainer = dialog.querySelector('#plot-preview-detail');
            const suggestion = plotOptimizationSystem.plotSuggestions?.get(messageId);
            const ctx = window.SillyTavern?.getContext?.();
            const userMessage = Array.isArray(ctx.chat) ? ctx.chat[floorNumber - 1] : null;

            if (!userMessage) {
                detailContainer.innerHTML = '<div style="color: var(--theme-text-secondary, #888);">æ¶ˆæ¯æœªæ‰¾åˆ°</div>';
                return;
            }

            detailContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <!-- æ¶ˆæ¯ä¿¡æ¯ -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--theme-text-primary, #ddd);">
                            æ¶ˆæ¯ #${floorNumber}
                        </h4>
                        <div style="
                            padding: 12px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                            color: var(--theme-text-secondary, #888);
                            max-height: 150px;
                            overflow-y: auto;
                        ">
                            ${userMessage.mes}
                        </div>
                    </div>

                    <!-- å‰§æƒ…ä¼˜åŒ–å»ºè®® -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: var(--theme-text-primary, #ddd);">
                                å‰§æƒ…ä¼˜åŒ–å»ºè®®
                            </h4>
                            <div style="display: flex; gap: 8px;">
                                ${suggestion ? `
                                    <button class="plot-preview-edit-btn" style="
                                        padding: 6px 12px;
                                        background: var(--theme-primary-color, #4CAF50);
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 12px;
                                    ">âœï¸ ç¼–è¾‘</button>
                                    <button class="plot-preview-delete-btn" style="
                                        padding: 6px 12px;
                                        background: #f44336;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 12px;
                                    ">ğŸ—‘ï¸ åˆ é™¤</button>
                                ` : ''}
                                <button class="plot-preview-regenerate-btn" style="
                                    padding: 6px 12px;
                                    background: #2196F3;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                ">ğŸ”„ ${suggestion ? 'é‡æ–°ç”Ÿæˆ' : 'ç”Ÿæˆ'}</button>
                            </div>
                        </div>
                        <textarea id="plot-preview-suggestion-text" style="
                            flex: 1;
                            padding: 12px;
                            background: var(--theme-bg-secondary, #2a2a2a);
                            border: 1px solid var(--theme-border-color, #333);
                            border-radius: 6px;
                            color: var(--theme-text-primary, #ddd);
                            font-family: monospace;
                            font-size: 13px;
                            resize: none;
                            ${!suggestion ? 'opacity: 0.5;' : ''}
                        " ${!suggestion ? 'readonly' : ''}>${suggestion?.suggestion || 'æš‚æ— å‰§æƒ…ä¼˜åŒ–å»ºè®®'}</textarea>
                    </div>
                </div>
            `;

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            const editBtn = detailContainer.querySelector('.plot-preview-edit-btn');
            const deleteBtn = detailContainer.querySelector('.plot-preview-delete-btn');
            const regenerateBtn = detailContainer.querySelector('.plot-preview-regenerate-btn');
            const textArea = detailContainer.querySelector('#plot-preview-suggestion-text');

            if (editBtn) {
                editBtn.addEventListener('click', async () => {
                    if (textArea.hasAttribute('readonly')) {
                        textArea.removeAttribute('readonly');
                        textArea.style.opacity = '1';
                        editBtn.textContent = 'ğŸ’¾ ä¿å­˜';
                    } else {
                        // ä¿å­˜ç¼–è¾‘ï¼ˆåŒæ­¥åˆ°å†…å­˜ä¸æ¶ˆæ¯å¯¹è±¡ï¼‰
                        const newSuggestion = textArea.value;
                        const now = Date.now();
                        plotOptimizationSystem.plotSuggestions.set(messageId, {
                            suggestion: newSuggestion,
                            timestamp: now,
                            floorNumber: floorNumber
                        });
                        try {
                            const ctx = window.SillyTavern?.getContext?.();
                            if (ctx) {
                                const userMessage = ctx.chat.find(msg => (msg.send_date || msg.mes) === messageId);
                                if (userMessage && userMessage.is_user) {
                                    userMessage.infobar_plot_optimization = {
                                        ...(userMessage.infobar_plot_optimization || {}),
                                        suggestion: newSuggestion,
                                        timestamp: now,
                                        floorNumber,
                                        messageId,
                                        version: 1,
                                    };
                                    if (typeof ctx.saveChat === 'function') {
                                        await ctx.saveChat();
                                        console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜èŠå¤©ï¼ˆç¼–è¾‘å»ºè®®ï¼‰');
                                    }
                                }
                            }
                        } catch (persistErr) {
                            console.warn('[InfoBarSettings] âš ï¸ æŒä¹…åŒ–ç¼–è¾‘åçš„å»ºè®®å¤±è´¥:', persistErr);
                        }
                        textArea.setAttribute('readonly', 'true');
                        editBtn.textContent = 'âœï¸ ç¼–è¾‘';
                        this.showNotification('âœ… å·²ä¿å­˜ä¿®æ”¹', 'success');
                    }
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å‰§æƒ…ä¼˜åŒ–å»ºè®®å—ï¼Ÿ')) {
                        // ğŸ”§ ä¿®å¤ï¼šä»å†…å­˜ä¸­åˆ é™¤å»ºè®®
                        plotOptimizationSystem.plotSuggestions.delete(messageId);

                        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ¥¼å±‚å·å®šä½ç”¨æˆ·æ¶ˆæ¯å¹¶åˆ é™¤æŒä¹…åŒ–æ•°æ®
                        try {
                            const ctx = window.SillyTavern?.getContext?.();
                            if (ctx && Array.isArray(ctx.chat)) {
                                // ä½¿ç”¨æ¥¼å±‚å·å®šä½æ¶ˆæ¯ï¼ˆæ¥¼å±‚å·ä»1å¼€å§‹ï¼Œæ•°ç»„ç´¢å¼•ä»0å¼€å§‹ï¼‰
                                const messageIndex = floorNumber - 1;
                                const userMessage = ctx.chat[messageIndex];

                                if (userMessage && userMessage.is_user && userMessage.infobar_plot_optimization) {
                                    // åˆ é™¤æŒä¹…åŒ–æ•°æ®
                                    delete userMessage.infobar_plot_optimization;
                                    console.log('[InfoBarSettings] ğŸ—‘ï¸ å·²åˆ é™¤æ¶ˆæ¯å¯¹è±¡ä¸Šçš„æŒä¹…åŒ–æ•°æ®, floorNumber:', floorNumber);

                                    // ä¿å­˜èŠå¤©
                                    if (typeof ctx.saveChat === 'function') {
                                        await ctx.saveChat();
                                        console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜èŠå¤©ï¼ˆåˆ é™¤å»ºè®®ï¼‰');
                                    }
                                } else {
                                    console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯æˆ–æŒä¹…åŒ–æ•°æ®, floorNumber:', floorNumber);
                                }
                            }
                        } catch (persistErr) {
                            console.error('[InfoBarSettings] âŒ åˆ é™¤å»ºè®®æŒä¹…åŒ–å¤±è´¥:', persistErr);
                        }

                        this.showNotification('âœ… å·²åˆ é™¤å‰§æƒ…ä¼˜åŒ–å»ºè®®', 'success');

                        // åˆ·æ–°åˆ—è¡¨å’Œè¯¦æƒ…
                        const messageList = dialog.querySelector('#plot-preview-message-list');
                        const ctx = window.SillyTavern?.getContext?.();
                        const userEntries = ctx.chat
                            .map((msg, idx) => ({ msg, floorNumber: idx + 1 }))
                            .filter(e => e.msg && e.msg.is_user);
                        messageList.innerHTML = this.renderPlotPreviewMessageList(userEntries, plotOptimizationSystem.plotSuggestions);
                        this.showPlotPreviewDetail(dialog, messageId, floorNumber, plotOptimizationSystem);
                    }
                });
            }

            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', async () => {
                    try {
                        regenerateBtn.disabled = true;
                        regenerateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

                        const contextMessages = await plotOptimizationSystem.getContextMessages();
                        const newSuggestion = await plotOptimizationSystem.getPlotSuggestion(contextMessages);

                        if (newSuggestion) {
                            const now = Date.now();
                            plotOptimizationSystem.plotSuggestions.set(messageId, {
                                suggestion: newSuggestion,
                                timestamp: now,
                                floorNumber: floorNumber
                            });
                            try {
                                const ctx = window.SillyTavern?.getContext?.();
                                if (ctx) {
                                    const userMessage = ctx.chat.find(msg => (msg.send_date || msg.mes) === messageId);
                                    if (userMessage && userMessage.is_user) {
                                        userMessage.infobar_plot_optimization = {
                                            ...(userMessage.infobar_plot_optimization || {}),
                                            suggestion: newSuggestion,
                                            timestamp: now,
                                            floorNumber,
                                            messageId,
                                            version: 1,
                                        };
                                        if (typeof ctx.saveChat === 'function') {
                                            await ctx.saveChat();
                                            console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜èŠå¤©ï¼ˆé‡æ–°ç”Ÿæˆå»ºè®®ï¼‰');
                                        }
                                    }
                                }
                            } catch (persistErr) {
                                console.warn('[InfoBarSettings] âš ï¸ é‡æ–°ç”Ÿæˆå»ºè®®æŒä¹…åŒ–å¤±è´¥:', persistErr);
                            }
                            this.showNotification('âœ… å‰§æƒ…ä¼˜åŒ–å»ºè®®å·²é‡æ–°ç”Ÿæˆ', 'success');
                            // åˆ·æ–°è¯¦æƒ…
                            this.showPlotPreviewDetail(dialog, messageId, floorNumber, plotOptimizationSystem);
                        } else {
                            this.showNotification('âŒ ç”Ÿæˆå¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('[InfoBarSettings] âŒ é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                        this.showNotification('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                    } finally {
                        regenerateBtn.disabled = false;
                        regenerateBtn.textContent = 'ğŸ”„ é‡æ–°ç”Ÿæˆ';
                    }
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºè¯¦æƒ…å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¡«å……NPCæ•°æ®æºé¢æ¿é€‰é¡¹
     */
    populateNPCSourcePanelOptions() {
        try {
            const select = this.modal.querySelector('#npc-source-panel-select');
            if (!select) return;

            // è·å–æ‰€æœ‰å¯ç”¨çš„é¢æ¿
            const context = SillyTavern.getContext();
            const settings = context.extensionSettings['Information bar integration tool'] || {};

            // ğŸ”§ ä¿®å¤ï¼šè·å–ä¿å­˜çš„æ•°æ®æºé¢æ¿
            const savedSourcePanel = localStorage.getItem('npcPanel_sourcePanel') || 'interaction';

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '';

            // æ·»åŠ é»˜è®¤é€‰é¡¹
            const defaultOption = document.createElement('option');
            defaultOption.value = 'interaction';
            defaultOption.textContent = 'äº¤äº’å¯¹è±¡é¢æ¿ï¼ˆé»˜è®¤ï¼‰';
            select.appendChild(defaultOption);

            // ğŸ”§ ä¿®å¤ï¼šåªä»customPanelsè·å–é¢æ¿ï¼Œä¸å†æ·»åŠ åŸºç¡€é¢æ¿
            // å› ä¸ºæ‰€æœ‰åŸºç¡€é¢æ¿éƒ½å·²ç»æ”¹ä¸ºè‡ªå®šä¹‰é¢æ¿äº†
            if (settings.customPanels) {
                Object.entries(settings.customPanels).forEach(([panelId, panelConfig]) => {
                    // è·³è¿‡interactioné¢æ¿ï¼ˆå·²ç»ä½œä¸ºé»˜è®¤é€‰é¡¹æ·»åŠ ï¼‰
                    if (panelId === 'interaction') return;

                    if (panelConfig.enabled !== false) {
                        const option = document.createElement('option');
                        option.value = panelId;
                        // ğŸ”§ ä¿®å¤ï¼šä¸å†æ·»åŠ "ï¼ˆè‡ªå®šä¹‰é¢æ¿ï¼‰"åç¼€ï¼Œå› ä¸ºç°åœ¨æ‰€æœ‰é¢æ¿éƒ½æ˜¯è‡ªå®šä¹‰é¢æ¿
                        option.textContent = panelConfig.name || panelId;
                        select.appendChild(option);
                    }
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¢å¤ä¹‹å‰ä¿å­˜çš„é€‰æ‹©
            select.value = savedSourcePanel;
            console.log('[InfoBarSettings] âœ… NPCæ•°æ®æºé¢æ¿é€‰é¡¹å·²å¡«å……ï¼Œå½“å‰é€‰æ‹©:', savedSourcePanel);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¡«å……NPCæ•°æ®æºé¢æ¿é€‰é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¡«å……ä¸–ç•Œä¹¦é€‰é¡¹
     */
    async populateNPCWorldBookOptions() {
        try {
            const select = this.modal.querySelector('#npc-target-worldbook-select');
            if (!select) return;

            // è·å–ä¿å­˜çš„ä¸–ç•Œä¹¦é€‰æ‹©
            const savedWorldBook = localStorage.getItem('npcPanel_targetWorldBook') || 'auto';

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '';

            // æ·»åŠ é»˜è®¤é€‰é¡¹
            const autoOption = document.createElement('option');
            autoOption.value = 'auto';
            autoOption.textContent = 'è§’è‰²é“¾æ¥çš„ä¸»è¦ä¸–ç•Œä¹¦ï¼ˆé»˜è®¤ï¼‰';
            select.appendChild(autoOption);

            // è·å–æ‰€æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦
            const worldBooks = await this.getAllWorldBooks();
            
            if (worldBooks && worldBooks.length > 0) {
                worldBooks.forEach(worldBook => {
                    const option = document.createElement('option');
                    option.value = worldBook.name;
                    option.textContent = worldBook.name;
                    select.appendChild(option);
                });
            }

            // æ¢å¤ä¹‹å‰ä¿å­˜çš„é€‰æ‹©
            select.value = savedWorldBook;
            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦é€‰é¡¹å·²å¡«å……ï¼Œå½“å‰é€‰æ‹©:', savedWorldBook);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¡«å……ä¸–ç•Œä¹¦é€‰é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• è·å–æ‰€æœ‰ä¸–ç•Œä¹¦åˆ—è¡¨
     */
    async getAllWorldBooks() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šä»DOMé€‰æ‹©å™¨è·å–ä¸–ç•Œä¹¦åˆ—è¡¨
            const worldInfoSelect = document.querySelector('#world_info');
            
            if (!worldInfoSelect || !worldInfoSelect.options) {
                console.warn('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦é€‰æ‹©å™¨ä¸å¯ç”¨');
                return [];
            }

            const worldBooks = [];
            for (let i = 0; i < worldInfoSelect.options.length; i++) {
                const option = worldInfoSelect.options[i];
                if (option.value && option.text) {
                    worldBooks.push({
                        name: option.text,
                        value: option.value,
                        selected: option.selected
                    });
                }
            }

            console.log('[InfoBarSettings] ğŸ“š æ‰¾åˆ°', worldBooks.length, 'ä¸ªä¸–ç•Œä¹¦');
            return worldBooks;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦åˆ—è¡¨å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸ†• å¤„ç†ä¸–ç•Œä¹¦é€‰æ‹©å˜æ›´
     */
    handleNPCWorldBookChange(worldBookName) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ NPCç›®æ ‡ä¸–ç•Œä¹¦å˜æ›´:', worldBookName);

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('npcPanel_targetWorldBook', worldBookName);
            console.log('[InfoBarSettings] âœ… NPCç›®æ ‡ä¸–ç•Œä¹¦è®¾ç½®å·²ä¿å­˜');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ä¸–ç•Œä¹¦é€‰æ‹©å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¤„ç†NPCæ•°æ®æºé¢æ¿å˜æ›´
     */
    handleNPCSourcePanelChange(panelId) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ NPCæ•°æ®æºé¢æ¿å˜æ›´:', panelId);

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('npcPanel_sourcePanel', panelId);
            console.log('[InfoBarSettings] âœ… NPCæ•°æ®æºé¢æ¿è®¾ç½®å·²ä¿å­˜');

            // åˆ·æ–°NPCåˆ—è¡¨
            this.refreshNPCList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†NPCæ•°æ®æºé¢æ¿å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * è¿‡æ»¤NPCåˆ—è¡¨
     */
    filterNPCList(searchText) {
        try {
            const cards = this.modal.querySelectorAll('.npc-card');
            const searchLower = searchText.toLowerCase();

            cards.forEach(card => {
                const npcName = card.querySelector('.npc-name')?.textContent?.toLowerCase() || '';
                const shouldShow = !searchText || npcName.includes(searchLower);
                card.style.display = shouldShow ? 'block' : 'none';
            });

            console.log('[InfoBarSettings] ğŸ” NPCåˆ—è¡¨å·²è¿‡æ»¤ï¼Œæœç´¢è¯:', searchText);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿‡æ»¤NPCåˆ—è¡¨å¤±è´¥:', error);
        }
    }

    // ==================== NPCç®¡ç†ç›¸å…³æ–¹æ³• ====================

    /**
     * å¤„ç†NPCè‡ªåŠ¨åŒæ­¥å¼€å…³å˜æ›´
     */
    handleNPCAutoSyncChange(enabled) {
        try {
            localStorage.setItem('npcPanel_autoSync', enabled.toString());
            console.log('[InfoBarSettings] ğŸ”„ NPCè‡ªåŠ¨åŒæ­¥è®¾ç½®å·²æ›´æ–°:', enabled ? 'å¼€å¯' : 'å…³é—­');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°NPCè‡ªåŠ¨åŒæ­¥è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†NPCä¸–ç•Œä¹¦åŒæ­¥å¼€å…³å˜æ›´
     */
    handleNPCWorldBookSyncChange(enabled) {
        try {
            localStorage.setItem('npcPanel_worldBookSync', enabled.toString());
            console.log('[InfoBarSettings] ğŸŒ NPCä¸–ç•Œä¹¦åŒæ­¥è®¾ç½®å·²æ›´æ–°:', enabled ? 'å¼€å¯' : 'å…³é—­');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°NPCä¸–ç•Œä¹¦åŒæ­¥è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åˆ‡æ¢APIé…ç½®ç±»å‹ï¼ˆé€šç”¨API / å‘é‡åŒ–APIï¼‰
     */
    switchAPIType(apiType) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢APIç±»å‹:', apiType);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = this.modal.querySelectorAll('.api-type-switch-btn');
            buttons.forEach(btn => {
                const isActive = btn.dataset.apiType === apiType;
                if (isActive) {
                    btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'var(--theme-bg-secondary, #2a2a2a)';
                    btn.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    btn.style.border = '1px solid var(--theme-border-color, #333)';
                    btn.classList.remove('active');
                }
            });

            // åˆ‡æ¢é…ç½®åŒºåŸŸæ˜¾ç¤º
            const generalSection = this.modal.querySelector('.general-api-config-section');
            const vectorSection = this.modal.querySelector('.vector-api-config-section');

            if (apiType === 'general') {
                // æ˜¾ç¤ºé€šç”¨APIé…ç½®
                if (generalSection) generalSection.style.display = 'block';
                if (vectorSection) vectorSection.style.display = 'none';
                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°é€šç”¨APIé…ç½®');
            } else if (apiType === 'vector') {
                // æ˜¾ç¤ºå‘é‡åŒ–APIé…ç½®
                if (generalSection) generalSection.style.display = 'none';
                if (vectorSection) vectorSection.style.display = 'block';
                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°å‘é‡åŒ–APIé…ç½®');
            }

            // ä¿å­˜å½“å‰é€‰æ‹©çš„APIç±»å‹
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            extensionSettings['Information bar integration tool'].currentAPIType = apiType;
            context.saveSettingsDebounced();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢APIç±»å‹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åˆ‡æ¢NPCç®¡ç†æ¨¡å¼
     */
    switchNPCMode(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢NPCæ¨¡å¼:', mode);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            const tabs = this.modal.querySelectorAll('.npc-mode-tab');
            tabs.forEach(tab => {
                const isActive = tab.dataset.mode === mode;
                if (isActive) {
                    tab.style.background = 'var(--theme-primary-color, #4CAF50)';
                    tab.style.color = 'white';
                    tab.style.borderColor = 'var(--theme-primary-color, #4CAF50)';
                    tab.classList.add('active');
                } else {
                    tab.style.background = 'var(--theme-bg-secondary, #2a2a2a)';
                    tab.style.color = 'var(--theme-text-primary, #e0e0e0)';
                    tab.style.borderColor = 'var(--theme-border-color, #333)';
                    tab.classList.remove('active');
                }
            });
            
            // åˆ‡æ¢è®¾ç½®åŒºåŸŸæ˜¾ç¤º
            const panelSettings = this.modal.querySelectorAll('.npc-panel-mode-settings');
            const aiSettings = this.modal.querySelectorAll('.npc-ai-mode-settings');
            const aiOnlyElements = this.modal.querySelectorAll('.npc-ai-mode-only');
            
            if (mode === 'ai') {
                // æ˜¾ç¤ºAIæ¨¡å¼è®¾ç½®
                panelSettings.forEach(el => el.style.display = 'none');
                aiSettings.forEach(el => el.style.display = 'block');
                aiOnlyElements.forEach(el => el.style.display = 'inline-block');
                
                // ğŸ†• æ¢å¤NPCå˜æ›´æ—¥å¿—æ˜¾ç¤º
                this.restoreNPCChangeLogs();
            } else {
                // æ˜¾ç¤ºé¢æ¿æ¨¡å¼è®¾ç½®
                panelSettings.forEach(el => el.style.display = 'block');
                aiSettings.forEach(el => el.style.display = 'none');
                aiOnlyElements.forEach(el => el.style.display = 'none');
            }
            
            console.log('[InfoBarSettings] âœ… NPCæ¨¡å¼åˆ‡æ¢å®Œæˆ');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢NPCæ¨¡å¼å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ æ–°å¢ï¼šåˆå§‹åŒ–NPC AIæ¶ˆæ¯è®¡æ•°
     */
    initNpcAiMessageCount() {
        try {
            console.log('[InfoBarSettings] ğŸ”¢ åˆå§‹åŒ–NPC AIæ¶ˆæ¯è®¡æ•°...');

            const context = SillyTavern?.getContext?.();
            if (context && context.chat) {
                this.lastNpcAiMessageCount = context.chat.length;
                console.log('[InfoBarSettings] ğŸ“Š NPC AIæ¶ˆæ¯è®¡æ•°åˆå§‹åŒ–å®Œæˆ:', {
                    currentMessageCount: this.lastNpcAiMessageCount,
                    lastUpdateMessageId: this.lastNpcAiUpdateMessageId,
                    messagesSinceLastUpdate: this.lastNpcAiMessageCount - this.lastNpcAiUpdateMessageId
                });
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–NPC AIæ¶ˆæ¯è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘NPC AIæ›´æ–°ï¼ˆæ¥¼å±‚æ£€æµ‹ï¼‰
     */
    shouldTriggerNpcAiUpdate(currentMessageCount) {
        try {
            // ä»UIè·å–æ¥¼å±‚è®¾ç½®
            const updateFloor = parseInt(this.modal?.querySelector('#npc-ai-update-floor')?.value || this.npcAiUpdateFloorCount);
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ›´æ–°æ¥¼å±‚æ•°
            const messagesSinceLastUpdate = currentMessageCount - this.lastNpcAiUpdateMessageId;
            const shouldTrigger = messagesSinceLastUpdate >= updateFloor;

            console.log('[InfoBarSettings] ğŸ¤” NPC AIæ›´æ–°è§¦å‘æ£€æŸ¥:', {
                currentMessageCount,
                lastUpdateMessageId: this.lastNpcAiUpdateMessageId,
                messagesSinceLastUpdate,
                updateFloor,
                shouldTrigger
            });

            return shouldTrigger;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ¤æ–­NPC AIæ›´æ–°è§¦å‘å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * ğŸ¯ æ–°å¢ï¼šå¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼ˆæ¥¼å±‚æ£€æµ‹ï¼‰
     */
    async handleNpcAiMessageReceived(data) {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨NPC AIæ¨¡å¼ä¸‹
            const currentMode = this.modal?.querySelector('.npc-mode-tab.active')?.dataset?.mode;
            if (currentMode !== 'ai') {
                return; // ä¸åœ¨AIæ¨¡å¼ä¸‹ï¼Œè·³è¿‡
            }

            if (this.npcAiUpdateInProgress) {
                return; // æ›´æ–°æ­£åœ¨è¿›è¡Œä¸­
            }

            // æ›´æ–°æ¶ˆæ¯è®¡æ•°
            const context = SillyTavern?.getContext?.();
            if (!context || !context.chat) return;

            const currentMessageCount = context.chat.length;
            const newMessages = currentMessageCount - this.lastNpcAiMessageCount;

            console.log('[InfoBarSettings] ğŸ“Š NPC AIæ¶ˆæ¯è®¡æ•°æ›´æ–°:', {
                previous: this.lastNpcAiMessageCount,
                current: currentMessageCount,
                new: newMessages
            });

            this.lastNpcAiMessageCount = currentMessageCount;

            // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ›´æ–°
            if (this.shouldTriggerNpcAiUpdate(currentMessageCount)) {
                console.log('[InfoBarSettings] ğŸ¯ è§¦å‘æ¥¼å±‚æ£€æµ‹æ›´æ–°ï¼Œå½“å‰æ¶ˆæ¯æ•°:', currentMessageCount);
                
                this.npcAiUpdateInProgress = true;
                await this.updateNPCWithAI();
                this.npcAiUpdateInProgress = false;

                // æ›´æ–°æœ€åæ›´æ–°çš„æ¶ˆæ¯ID
                this.lastNpcAiUpdateMessageId = currentMessageCount;
                console.log('[InfoBarSettings] âœ… æ¥¼å±‚æ£€æµ‹æ›´æ–°å®Œæˆï¼Œæ›´æ–°lastNpcAiUpdateMessageId:', this.lastNpcAiUpdateMessageId);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†NPC AIæ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
            this.npcAiUpdateInProgress = false;
        }
    }

    /**
     * ğŸ†• NPC AIæ¨¡å¼ï¼šè‡ªåŠ¨æ›´æ–°NPCæ•°æ®
     */
    async updateNPCWithAI() {
        // ğŸ¯ æå‡åˆ°æ–¹æ³•ä½œç”¨åŸŸï¼Œä¾¿äºåœ¨finallyå—ä¸­è®¿é—®
        const updateBtn = this.modal?.querySelector('#npc-ai-update-now-btn');
        let updateInterval = null;
        
        try {
            console.log('[InfoBarSettings] ğŸ¤– å¼€å§‹NPC AIæ¨¡å¼æ›´æ–°...');
            
            // ğŸ¯ æ–°å¢ï¼šæ›´æ–°æŒ‰é’®çŠ¶æ€ä¸º"æ­£åœ¨æ›´æ–°ä¸­"
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = 'â³ æ­£åœ¨æ›´æ–°NPCæ•°æ®ä¸­...';
                updateBtn.style.opacity = '0.6';
                updateBtn.style.cursor = 'not-allowed';
            }
            
            // ğŸ¯ æ–°å¢ï¼šè®°å½•å¼€å§‹æ—¶é—´ï¼Œç”¨äºæ˜¾ç¤ºç»è¿‡æ—¶é—´
            const updateStartTime = Date.now();
            
            // ğŸ¯ æ–°å¢ï¼šå®šæœŸæ›´æ–°æŒ‰é’®çŠ¶æ€æ˜¾ç¤ºç»è¿‡æ—¶é—´
            updateInterval = setInterval(() => {
                if (updateBtn && updateBtn.disabled) {
                    const elapsed = Math.floor((Date.now() - updateStartTime) / 1000);
                    if (elapsed > 2) {
                        updateBtn.innerHTML = `â³ æ­£åœ¨æ›´æ–°NPCæ•°æ®ä¸­...${elapsed}ç§’`;
                    }
                } else {
                    clearInterval(updateInterval);
                }
            }, 1000);
            
            // è·å–é…ç½®
            const updateFloor = parseInt(this.modal.querySelector('#npc-ai-update-floor')?.value || 20);
            
            // è·å–æœ€è¿‘Næ¡æ¶ˆæ¯
            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                console.log('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ¶ˆæ¯');
                // ğŸ¯ æ¢å¤æŒ‰é’®çŠ¶æ€
                if (updateBtn) {
                    clearInterval(updateInterval);
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = 'ğŸ¤– ç«‹å³æ›´æ–°NPCæ•°æ®';
                    updateBtn.style.opacity = '1';
                    updateBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            const messages = context.chat.slice(-updateFloor);
            console.log(`[InfoBarSettings] ğŸ“ è·å–æœ€è¿‘ ${updateFloor} æ¡æ¶ˆæ¯ï¼Œå®é™…è·å–: ${messages.length} æ¡`);
            
            // ğŸ†• æ£€æŸ¥æ˜¯å¦å¯ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
            const useRegex = this.modal.querySelector('#npc-ai-use-regex')?.checked !== false;
            
            // ğŸ†• åº”ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ¶ˆæ¯
            let filteredMessages = messages;
            if (useRegex) {
                const regexScriptManager = window.SillyTavernInfobar?.modules?.regexScriptManager;
                if (regexScriptManager) {
                    filteredMessages = messages.map(msg => {
                        if (msg.mes) {
                            const filtered = regexScriptManager.applyAllScripts(msg.mes, 'OUTPUT', 'AI_OUTPUT');
                            return { ...msg, mes: filtered };
                        }
                        return msg;
                    });
                    console.log('[InfoBarSettings] ğŸ“ æ¶ˆæ¯å·²åº”ç”¨æ­£åˆ™è¿‡æ»¤');
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ RegexScriptManagerä¸å¯ç”¨');
                }
            } else {
                console.log('[InfoBarSettings] â„¹ï¸ æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤å·²ç¦ç”¨');
            }
            
            // ç”Ÿæˆæ¶ˆæ¯æ–‡æœ¬
            const messageText = filteredMessages.map((msg, index) => {
                const role = msg.is_user ? 'ç”¨æˆ·' : 'AI';
                return `[${index + 1}] ${role}: ${msg.mes}`;
            }).join('\n\n');
            
            // ç”Ÿæˆå½“å‰NPCåˆ—è¡¨è¡¨æ ¼
            const npcTable = await this.generateNPCListTable();
            
            // è¯»å–NPCæ“ä½œæç¤ºè¯
            const npcPrompt = await this.loadNPCPrompt();
            
            // ğŸ†• è·å–NPCæ¨¡æ¿
            const npcTemplate = this.loadNPCTemplate();
            const templateInfo = this.generateTemplateInfo(npcTemplate);
            
            // ğŸ†• æ£€æŸ¥æ˜¯å¦å¯ç”¨è·¯äººè¿‡æ»¤
            const filterMinorRoles = this.modal.querySelector('#npc-ai-filter-minor-roles')?.checked !== false;
            const filterInfo = filterMinorRoles ? this.generateFilterRules() : '';
            
            // ğŸ”§ ä¼˜åŒ–ï¼šæ„å»ºé€‚åˆè§’è‰²æ¡£æ¡ˆæ ¼å¼çš„æç¤ºè¯
            const fullPrompt = `${npcPrompt}

## ğŸ“‹ å½“å‰NPCè§’è‰²æ¡£æ¡ˆ

${npcTable}

${templateInfo}

${filterInfo}

## ğŸ’¬ æœ€è¿‘å¯¹è¯å†…å®¹

${messageText}

## ğŸ¯ ä»»åŠ¡è¦æ±‚

è¯·ä»”ç»†é˜…è¯»ä»¥ä¸Š**NPCè§’è‰²æ¡£æ¡ˆ**ã€**NPCä¿¡æ¯æ¨¡æ¿**å’Œ**å¯¹è¯å†…å®¹**ï¼Œåˆ†æå“ªäº›NPCçš„ä¿¡æ¯éœ€è¦æ›´æ–°æˆ–æ·»åŠ æ–°çš„NPCã€‚

### ğŸ“Œ è¾“å‡ºæ ¼å¼è¯´æ˜

å¯¹äºéœ€è¦æ›´æ–°æˆ–æ·»åŠ çš„NPCï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼è¾“å‡ºæ“ä½œæŒ‡ä»¤ï¼š

<npc>
<!--
add ï¼ˆ"NPCå§“åï¼Œå­—æ®µå"ï¼Œ"æ–°å€¼"ï¼‰ï¼›//æ·»åŠ ç†ç”±
update ï¼ˆ"NPCå§“åï¼Œå­—æ®µå"ï¼Œ"æ–°å€¼"ï¼‰ï¼›//å˜åŒ–ç†ç”±
-->
</npc>

### âœ… æ“ä½œè§„åˆ™

1. **æ–°å¢NPC**ï¼šå¦‚æœNPCä¸åœ¨å½“å‰è§’è‰²æ¡£æ¡ˆåˆ—è¡¨ä¸­ï¼Œä½¿ç”¨ \`add\` æ·»åŠ 
2. **æ›´æ–°NPC**ï¼šå¦‚æœNPCå·²å­˜åœ¨äºæ¡£æ¡ˆä¸­ï¼Œä½¿ç”¨ \`update\` æ›´æ–°å…¶å­—æ®µä¿¡æ¯
3. **å­—æ®µåä¸€è‡´æ€§**ï¼šå­—æ®µåå¿…é¡»ä¸å½“å‰NPCåˆ—è¡¨ä¸­çš„å­—æ®µå**å®Œå…¨ä¸€è‡´**
4. **åˆç†æ€§è¯´æ˜**ï¼šæ¯ä¸ªæ“ä½œå¿…é¡»æä¾›**åˆç†çš„ç†ç”±è¯´æ˜**
5. **ç²¾å‡†æ›´æ–°**ï¼šåªè¾“å‡º**ç¡®å®éœ€è¦æ›´æ–°**çš„NPCæ•°æ®ï¼Œé¿å…ä¸å¿…è¦çš„ä¿®æ”¹

### ğŸ“– è§’è‰²æ¡£æ¡ˆè¯´æ˜

- æ¯ä¸ªNPCéƒ½ä»¥ã€è§’è‰²æ¡£æ¡ˆ Xï¼šå§“åã€‘çš„å½¢å¼å±•ç¤º
- ID: NPCçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆè¯·å‹¿ä¿®æ”¹ï¼‰
- å‡ºç°æ¬¡æ•°ã€æœ€åå‡ºç°ï¼šç»Ÿè®¡ä¿¡æ¯ï¼ˆç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼‰
- è§’è‰²ä¿¡æ¯ï¼šNPCçš„å„ä¸ªå­—æ®µæ•°æ®ï¼ˆå¯æ›´æ–°æˆ–æ·»åŠ ï¼‰

### ğŸ’¡ ç¤ºä¾‹

æ­£ç¡®ç¤ºä¾‹ï¼š
- \`add ("å¼ ä¸‰ï¼Œå¯¹è±¡ç±»å‹"ï¼Œ"æœ‹å‹"ï¼‰ï¼›//å¯¹è¯ä¸­é¦–æ¬¡æåˆ°å¼ ä¸‰ï¼Œå…³ç³»ä¸ºæœ‹å‹\`
- \`update ("æå››ï¼Œå½“å‰çŠ¶æ€"ï¼Œ"æ„¤æ€’"ï¼‰ï¼›//å¯¹è¯ä¸­æå››è¡¨ç°å‡ºæ„¤æ€’æƒ…ç»ª\`

é”™è¯¯ç¤ºä¾‹ï¼ˆè¯·é¿å…ï¼‰ï¼š
- \`add ("å¼ ä¸‰ï¼Œtype"ï¼Œ"æœ‹å‹"ï¼‰ï¼›//âŒ å­—æ®µååº”ä¸º"å¯¹è±¡ç±»å‹"è€Œä¸æ˜¯è‹±æ–‡\`
- \`update ("æå››ï¼Œmood"ï¼Œ"happy"ï¼‰ï¼›//âŒ å€¼åº”ä¸ºä¸­æ–‡"å¼€å¿ƒ"è€Œä¸æ˜¯è‹±æ–‡\`
`;
            
            console.log('[InfoBarSettings] ğŸ“¡ å‘é€NPCæ›´æ–°è¯·æ±‚åˆ°è‡ªå®šä¹‰API...');
            
            // ğŸ†• ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†NPCæ›´æ–°
            if (this.customAPITaskQueue) {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†NPC AIæ›´æ–°');
                this.customAPITaskQueue.addTask({
                    type: 'MANUAL',
                    data: { 
                        callback: async () => {
                            // è°ƒç”¨è‡ªå®šä¹‰API
                            const result = await this.sendCustomAPIRequest([
                                {
                                    role: 'system',
                                    content: fullPrompt
                                },
                                {
                                    role: 'user',
                                    content: 'è¯·åˆ†æå¯¹è¯å†…å®¹ï¼Œæ›´æ–°NPCæ•°æ®ã€‚'
                                }
                            ], { skipSystemPrompt: true });
                            
                            if (result.success && result.text) {
                                console.log('[InfoBarSettings] âœ… æ”¶åˆ°AIå“åº”ï¼Œé•¿åº¦:', result.text.length);
                                
                                // è§£æNPCæ“ä½œæŒ‡ä»¤
                                await this.parseNPCOperations(result.text);
                                
                                // åˆ·æ–°NPCåˆ—è¡¨
                                await this.refreshNPCList();
                                
                                // ğŸ†• AIæ¨¡å¼ä¸‹ï¼šè§¦å‘ä¸–ç•Œä¹¦åŒæ­¥
                                await this.handleNPCWorldBookSyncAfterAI();
                                
                                this.showNotification('NPCæ•°æ®æ›´æ–°å®Œæˆ', 'success');
                            } else {
                                throw new Error(result.error || 'AIå“åº”å¤±è´¥');
                            }
                        }
                    },
                    source: 'npc_ai_update'
                });
            } else {
                // ç›´æ¥è°ƒç”¨ï¼ˆé™çº§å¤„ç†ï¼‰
                const result = await this.sendCustomAPIRequest([
                    {
                        role: 'system',
                        content: fullPrompt
                    },
                    {
                        role: 'user',
                        content: 'è¯·åˆ†æå¯¹è¯å†…å®¹ï¼Œæ›´æ–°NPCæ•°æ®ã€‚'
                    }
                ], { skipSystemPrompt: true });
                
                if (result.success && result.text) {
                    console.log('[InfoBarSettings] âœ… æ”¶åˆ°AIå“åº”ï¼Œé•¿åº¦:', result.text.length);
                    
                    // è§£æNPCæ“ä½œæŒ‡ä»¤
                    await this.parseNPCOperations(result.text);
                    
                    // åˆ·æ–°NPCåˆ—è¡¨
                    await this.refreshNPCList();
                    
                    // ğŸ†• AIæ¨¡å¼ä¸‹ï¼šè§¦å‘ä¸–ç•Œä¹¦åŒæ­¥
                    await this.handleNPCWorldBookSyncAfterAI();
                    
                    this.showNotification('NPCæ•°æ®æ›´æ–°å®Œæˆ', 'success');
                } else {
                    throw new Error(result.error || 'AIå“åº”å¤±è´¥');
                }
            }
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ NPC AIæ›´æ–°å¤±è´¥:', error);
            this.showNotification('NPC AIæ›´æ–°å¤±è´¥: ' + error.message, 'error');
        } finally {
            // ğŸ¯ æ–°å¢ï¼šç»Ÿä¸€æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (updateBtn) {
                updateBtn.disabled = false;
                updateBtn.innerHTML = 'ğŸ¤– ç«‹å³æ›´æ–°NPCæ•°æ®';
                updateBtn.style.opacity = '1';
                updateBtn.style.cursor = 'pointer';
            }
        }
    }

    /**
     * ğŸ†• ç”ŸæˆNPCåˆ—è¡¨ï¼ˆè§’è‰²ä¿¡æ¯æ¡£æ¡ˆæ ¼å¼ï¼‰
     */
    async generateNPCListTable() {
        try {
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB || !npcDB.db || !npcDB.db.npcs) {
                return 'å½“å‰æ— NPCæ•°æ®';
            }
            
            const npcs = Object.values(npcDB.db.npcs);
            
            if (npcs.length === 0) {
                return 'å½“å‰æ— NPCæ•°æ®';
            }
            
            console.log(`[InfoBarSettings] ğŸ“ ç”Ÿæˆ ${npcs.length} ä¸ªNPCçš„è§’è‰²ä¿¡æ¯æ¡£æ¡ˆ...`);
            
            // ğŸ”§ ä¼˜åŒ–ï¼šå°†æ¯ä¸ªNPCæ‰“åŒ…æˆè§’è‰²ä¿¡æ¯æ¡£æ¡ˆï¼Œè€Œä¸æ˜¯è¡¨æ ¼æ ¼å¼
            const profiles = npcs.map((npc, index) => {
                // æ”¶é›†NPCçš„æœ‰æ•ˆå­—æ®µï¼ˆè¿‡æ»¤æŠ€æœ¯å­—æ®µï¼‰
                const validFields = {};
                if (npc.fields) {
                    Object.entries(npc.fields).forEach(([key, value]) => {
                        if (!this.isTechnicalField(key) && !key.startsWith('_')) {
                            validFields[key] = value;
                        }
                    });
                }
                
                // æ„å»ºè§’è‰²ä¿¡æ¯æ¡£æ¡ˆ
                let profile = `ã€è§’è‰²æ¡£æ¡ˆ ${index + 1}ï¼š${npc.name}ã€‘\n`;
                profile += `â”œ ID: ${npc.id}\n`;
                
                // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                if (npc.appearCount) {
                    profile += `â”œ å‡ºç°æ¬¡æ•°: ${npc.appearCount}\n`;
                }
                if (npc.lastSeen) {
                    const lastSeenDate = new Date(npc.lastSeen).toLocaleString('zh-CN');
                    profile += `â”œ æœ€åå‡ºç°: ${lastSeenDate}\n`;
                }
                
                // æ·»åŠ å­—æ®µä¿¡æ¯
                const fieldEntries = Object.entries(validFields);
                if (fieldEntries.length > 0) {
                    profile += `â”” è§’è‰²ä¿¡æ¯:\n`;
                    fieldEntries.forEach(([key, value], idx) => {
                        const prefix = idx === fieldEntries.length - 1 ? '  â””' : '  â”œ';
                        profile += `${prefix} ${key}: ${value}\n`;
                    });
                }
                
                return profile;
            });
            
            // å°†æ‰€æœ‰è§’è‰²æ¡£æ¡ˆç»„åˆèµ·æ¥
            const result = profiles.join('\n');
            console.log(`[InfoBarSettings] âœ… è§’è‰²æ¡£æ¡ˆç”Ÿæˆå®Œæˆï¼Œæ€»é•¿åº¦: ${result.length} å­—ç¬¦`);
            
            return result;
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”ŸæˆNPCåˆ—è¡¨è¡¨æ ¼å¤±è´¥:', error);
            return 'ç”ŸæˆNPCåˆ—è¡¨å¤±è´¥';
        }
    }

    /**
     * ğŸ†• è¯»å–NPCæ“ä½œæç¤ºè¯
     */
    async loadNPCPrompt() {
        try {
            // ä»æ–‡ä»¶è¯»å–NPCæ“ä½œæç¤ºè¯
            const response = await fetch('./scripts/extensions/third-party/Information bar integration tool/NPCæ“ä½œæç¤ºè¯');
            if (response.ok) {
                const text = await response.text();
                console.log('[InfoBarSettings] âœ… NPCæ“ä½œæç¤ºè¯åŠ è½½æˆåŠŸ');
                return text;
            } else {
                console.warn('[InfoBarSettings] âš ï¸ NPCæ“ä½œæç¤ºè¯æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯');
                return this.getDefaultNPCPrompt();
            }
        } catch (error) {
            console.warn('[InfoBarSettings] âš ï¸ è¯»å–NPCæ“ä½œæç¤ºè¯å¤±è´¥:', error);
            return this.getDefaultNPCPrompt();
        }
    }

    /**
     * ğŸ†• è·å–é»˜è®¤NPCæ“ä½œæç¤ºè¯
     */
    getDefaultNPCPrompt() {
        return `ä½ çš„èŒä¸šæ˜¯å°è¯´ä½œè€…åŠ©ç†ï¼Œåå­—æ˜¯ï¼š"Guhan 2å·"
è´Ÿè´£å°è¯´å†…çš„è§’è‰²äººè®¾ã€ä¸ªæ€§åŒ–ç­‰æ•°æ®çš„æ”¶é›†ã€ä¼˜åŒ–å’Œä¿®æ­£å·¥ä½œã€‚

## æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

**æ ¼å¼è¦æ±‚ï¼š**
- add ï¼ˆ"NPCå§“åï¼Œå­—æ®µå"ï¼Œ"å­—æ®µå€¼"ï¼‰ï¼›//æ·»åŠ ç†ç”±
- update ï¼ˆ"NPCå§“åï¼Œå­—æ®µå"ï¼Œ"æ–°å€¼"ï¼‰ï¼›//æ›´æ–°ç†ç”±

**é‡è¦è¯´æ˜ï¼š**
1. å¿…é¡»ä½¿ç”¨ä¸­æ–‡å…¨è§’æ‹¬å· ï¼ˆï¼‰
2. ç¬¬ä¸€ä¸ªå‚æ•°ï¼š"NPCå§“åï¼Œå­—æ®µå" - ç”¨é€—å·åˆ†éš”
3. ç¬¬äºŒä¸ªå‚æ•°ï¼š"å­—æ®µå€¼" - å…·ä½“çš„å€¼
4. ä»¥ä¸­æ–‡åˆ†å·ç»“å°¾ ï¼›
5. ç†ç”±å‰ç”¨åŒæ–œæ  //

**æ­£ç¡®ç¤ºä¾‹ï¼š**
add ï¼ˆ"æ—å‡¡ï¼Œå¥½æ„Ÿåº¦"ï¼Œ"15"ï¼‰ï¼›//å› ä¸ºå¯¹è¯ä¸­çš„èµç¾å¢åŠ äº†å¥½æ„Ÿ
update ï¼ˆ"å¼ ä¸‰ï¼ŒçŠ¶æ€"ï¼Œ"æ„¤æ€’"ï¼‰ï¼›//å› ä¸ºå‘ç”Ÿäº†å†²çª
add ï¼ˆ"æå››ï¼ŒèŒä¸š"ï¼Œ"å•†äºº"ï¼‰ï¼›//å‰§æƒ…ä¸­å‡ºç°çš„æ–°NPC

**é”™è¯¯ç¤ºä¾‹ï¼ˆç¦æ­¢ï¼‰ï¼š**
âŒ update ï¼ˆ"ä¹¦è®°å®˜", "NPCçŠ¶æ€"ï¼‰ - ç¼ºå°‘å€¼å‚æ•°
âŒ add ("æ—å‡¡", "å¥½æ„Ÿåº¦", "15") - æ ¼å¼é”™è¯¯
âŒ update æ—å‡¡ å¥½æ„Ÿåº¦ 15 - ç¼ºå°‘æ‹¬å·å’Œå¼•å·

## è¾“å‡ºæ ¼å¼

<npc>
<!--
add ï¼ˆ"æ—å‡¡ï¼Œå¥½æ„Ÿåº¦"ï¼Œ"15"ï¼‰ï¼›//å› ä¸ºå¯¹è¯ä¸­çš„èµç¾å¢åŠ äº†å¥½æ„Ÿ
update ï¼ˆ"å¼ ä¸‰ï¼ŒçŠ¶æ€"ï¼Œ"æ„¤æ€’"ï¼‰ï¼›//å› ä¸ºå‘ç”Ÿäº†å†²çª
-->
</npc>

**æ³¨æ„ï¼šåªè¾“å‡ºç¡®å®éœ€è¦æ›´æ–°çš„NPCæ•°æ®ï¼Œä¸è¦è¾“å‡ºæ‰€æœ‰NPCã€‚**`;
    }

    /**
     * ğŸ†• è§£æNPCæ“ä½œæŒ‡ä»¤
     */
    async parseNPCOperations(text) {
        try {
            console.log('[InfoBarSettings] ğŸ” è§£æNPCæ“ä½œæŒ‡ä»¤...');
            console.log('[InfoBarSettings] ğŸ“„ AIåŸå§‹å“åº”ï¼ˆå‰500å­—ç¬¦ï¼‰:', text.substring(0, 500));
            
            // æå–<npc>æ ‡ç­¾å†…å®¹
            const npcMatch = text.match(/<npc>([\s\S]*?)<\/npc>/);
            if (!npcMatch) {
                console.log('[InfoBarSettings] â„¹ï¸ æœªæ‰¾åˆ°NPCæ“ä½œæŒ‡ä»¤');
                console.log('[InfoBarSettings] ğŸ“„ å®Œæ•´å“åº”:', text);
                return;
            }
            
            const npcContent = npcMatch[1];
            console.log('[InfoBarSettings] ğŸ“„ NPCæ ‡ç­¾å†…å®¹:', npcContent);
            
            // æå–æ³¨é‡Šä¸­çš„æ“ä½œæŒ‡ä»¤
            const commentMatch = npcContent.match(/<!--([\s\S]*?)-->/);
            if (!commentMatch) {
                console.log('[InfoBarSettings] â„¹ï¸ æœªæ‰¾åˆ°æ“ä½œæŒ‡ä»¤æ³¨é‡Š');
                console.log('[InfoBarSettings] ğŸ“„ NPCå†…å®¹:', npcContent);
                return;
            }
            
            const operations = commentMatch[1].trim().split('\n');
            console.log('[InfoBarSettings] ğŸ“Š æ‰¾åˆ° ', operations.length, ' æ¡æ“ä½œæŒ‡ä»¤');
            console.log('[InfoBarSettings] ğŸ“„ æ“ä½œæŒ‡ä»¤åˆ—è¡¨:', operations);
            
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                throw new Error('NPCæ•°æ®åº“ç®¡ç†å™¨æœªæ‰¾åˆ°');
            }
            
            let successCount = 0;
            let failCount = 0;
            const changeLogs = []; // ğŸ†• å˜æ›´æ—¥å¿—
            
            for (const op of operations) {
                const trimmed = op.trim();
                if (!trimmed || trimmed.startsWith('//')) continue;
                
                console.log('[InfoBarSettings] ğŸ” å°è¯•è§£æ:', trimmed);
                
                try {
                    // ğŸ”§ è¶…å®½å®¹çš„è§£æé€»è¾‘ï¼šæ”¯æŒå„ç§æ ¼å¼å˜ä½“
                    let operation, npcName, fieldName, value, reason;
                    
                    // æ­¥éª¤1ï¼šæå–æ“ä½œç±»å‹
                    if (trimmed.startsWith('add')) {
                        operation = 'add';
                    } else if (trimmed.startsWith('update')) {
                        operation = 'update';
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ æœªè¯†åˆ«çš„æ“ä½œç±»å‹:', trimmed);
                        continue;
                    }
                    
                    // æ­¥éª¤2ï¼šæå–æ‰€æœ‰å¼•å·å†…çš„å†…å®¹
                    const quotedParts = [];
                    const quoteRegex = /["""]([^"""]+)["""]/g;
                    let quoteMatch;
                    while ((quoteMatch = quoteRegex.exec(trimmed)) !== null) {
                        quotedParts.push(quoteMatch[1]);
                    }
                    
                    console.log('[InfoBarSettings] ğŸ“‹ æå–çš„å¼•å·å†…å®¹:', quotedParts);
                    
                    if (quotedParts.length < 2) {
                        console.warn('[InfoBarSettings] âš ï¸ å¼•å·å†…å®¹ä¸è¶³2ä¸ª:', quotedParts);
                        continue;
                    }
                    
                    // æ­¥éª¤3ï¼šè§£æç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆNPCå§“åï¼Œå­—æ®µåï¼‰
                    const firstParam = quotedParts[0];
                    const parts = firstParam.split(/[ï¼Œ,]/).map(s => s.trim());
                    
                    if (parts.length < 2) {
                        console.warn('[InfoBarSettings] âš ï¸ ç¬¬ä¸€ä¸ªå‚æ•°æ ¼å¼é”™è¯¯:', firstParam);
                        continue;
                    }
                    
                    npcName = parts[0];
                    fieldName = parts[1];
                    
                    // æ­¥éª¤4ï¼šç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å€¼
                    value = quotedParts[1];
                    
                    // æ­¥éª¤5ï¼šæå–ç†ç”±ï¼ˆåœ¨//ä¹‹åï¼‰
                    const reasonMatch = trimmed.match(/\/\/(.*)$/);
                    reason = reasonMatch ? reasonMatch[1].trim() : 'æ— è¯´æ˜';
                    
                    if (!npcName || !fieldName || !value) {
                        console.warn('[InfoBarSettings] âš ï¸ å¿…è¦å‚æ•°ç¼ºå¤±:', { npcName, fieldName, value });
                        continue;
                    }
                    
                    console.log(`[InfoBarSettings] ğŸ“ ${operation}: ${npcName}.${fieldName} = ${value}`);
                    
                    // è·å–æ—§å€¼ï¼ˆç”¨äºæ˜¾ç¤ºå˜åŒ–ï¼‰
                    const oldValue = npcDB.db?.npcs?.[npcDB.db?.nameToId?.[npcName]]?.fields?.[fieldName] || '-';
                    
                    // æ‰§è¡Œæ“ä½œ
                    const npcData = { 
                        name: npcName,
                        [fieldName]: value
                    };
                    
                    await npcDB.addNPC(npcData);
                    successCount++;
                    
                    // ğŸ†• è®°å½•å˜æ›´
                    const changeType = operation === 'add' ? 'æ–°å¢' : 'æ›´æ–°';
                    const changeDesc = operation === 'add' 
                        ? `${value}` 
                        : `${oldValue} â†’ ${value}`;
                    
                    changeLogs.push({
                        npcName,
                        fieldName,
                        changeType,
                        changeDesc,
                        reason: reason?.trim() || 'æ— è¯´æ˜',
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ æ‰§è¡Œæ“ä½œå¤±è´¥:', trimmed, error);
                    failCount++;
                }
            }
            
            console.log(`[InfoBarSettings] âœ… NPCæ“ä½œå®Œæˆ: æˆåŠŸ${successCount}æ¡, å¤±è´¥${failCount}æ¡`);
            
            // ğŸ†• æ˜¾ç¤ºå˜æ›´æ—¥å¿—
            if (changeLogs.length > 0) {
                this.displayNPCChangeLogs(changeLogs);
            }
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è§£æNPCæ“ä½œæŒ‡ä»¤å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºNPCå˜æ›´æ—¥å¿—
     */
    displayNPCChangeLogs(changeLogs) {
        try {
            const changeLogContainer = this.modal.querySelector('#npc-change-log');
            if (!changeLogContainer) {
                console.warn('[InfoBarSettings] âš ï¸ å˜æ›´æ—¥å¿—å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            console.log('[InfoBarSettings] ğŸ“Š æ˜¾ç¤ºNPCå˜æ›´æ—¥å¿—ï¼Œæ–°å¢', changeLogs.length, 'æ¡');
            
            // ğŸ†• åªåœ¨æœ‰æ–°æ—¥å¿—æ—¶æ‰è¿½åŠ ä¿å­˜
            let recentLogs;
            if (changeLogs.length > 0) {
                const existingLogs = this.loadNPCChangeLogs();
                const allLogs = [...existingLogs, ...changeLogs];
                // åªä¿ç•™æœ€è¿‘50æ¡
                recentLogs = allLogs.slice(-50);
                this.saveNPCChangeLogs(recentLogs);
            } else {
                // æ²¡æœ‰æ–°æ—¥å¿—ï¼Œåªæ˜¾ç¤ºç°æœ‰æ—¥å¿—
                recentLogs = this.loadNPCChangeLogs();
            }
            
            // ç”Ÿæˆå˜æ›´æ—¥å¿—HTML
            const logsHTML = recentLogs.map((log, index) => {
                const icon = log.changeType === 'æ–°å¢' ? 'â•' : 'ğŸ”„';
                const color = log.changeType === 'æ–°å¢' ? '#4CAF50' : '#2196F3';
                
                return `
                    <div style="
                        padding: 10px 12px;
                        margin-bottom: 8px;
                        background: var(--theme-bg-secondary, #2a2a2a);
                        border-left: 3px solid ${color};
                        border-radius: 4px;
                    ">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-size: 14px;">${icon}</span>
                            <strong style="color: var(--theme-text-primary, #e0e0e0);">${this.escapeHtml(log.npcName)}</strong>
                            <span style="color: var(--theme-text-secondary, #888); font-size: 12px;">${log.changeType}</span>
                        </div>
                        <div style="color: var(--theme-text-primary, #e0e0e0); font-size: 13px; margin-bottom: 4px;">
                            <strong>${this.escapeHtml(log.fieldName)}:</strong> ${this.escapeHtml(log.changeDesc)}
                        </div>
                        <div style="color: var(--theme-text-secondary, #888); font-size: 12px; font-style: italic;">
                            åŸå› ï¼š${this.escapeHtml(log.reason)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ›´æ–°å®¹å™¨å†…å®¹
            changeLogContainer.innerHTML = logsHTML || '<div class="npc-change-empty">æš‚æ— å˜æ›´è®°å½•</div>';
            
            // æ»šåŠ¨åˆ°æœ€æ–°çš„æ—¥å¿—
            changeLogContainer.scrollTop = changeLogContainer.scrollHeight;
            
            console.log('[InfoBarSettings] âœ… å˜æ›´æ—¥å¿—å·²æ˜¾ç¤º');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå˜æ›´æ—¥å¿—å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• ä¿å­˜NPCå˜æ›´æ—¥å¿—
     */
    saveNPCChangeLogs(logs) {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            
            if (!extensionSettings['Information bar integration tool'].npcSettings) {
                extensionSettings['Information bar integration tool'].npcSettings = {};
            }
            
            extensionSettings['Information bar integration tool'].npcSettings.changeLogs = logs;
            context.saveSettingsDebounced();
            
            console.log('[InfoBarSettings] ğŸ’¾ NPCå˜æ›´æ—¥å¿—å·²ä¿å­˜ï¼Œå…±', logs.length, 'æ¡');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜NPCå˜æ›´æ—¥å¿—å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åŠ è½½NPCå˜æ›´æ—¥å¿—
     */
    loadNPCChangeLogs() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const logs = extensionSettings['Information bar integration tool']?.npcSettings?.changeLogs || [];
            
            console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½NPCå˜æ›´æ—¥å¿—ï¼Œå…±', logs.length, 'æ¡');
            return logs;
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½NPCå˜æ›´æ—¥å¿—å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸ†• æ¢å¤NPCå˜æ›´æ—¥å¿—æ˜¾ç¤º
     */
    restoreNPCChangeLogs() {
        try {
            // ç›´æ¥è°ƒç”¨displayNPCChangeLogsï¼Œä¼ å…¥ç©ºæ•°ç»„è¡¨ç¤ºåªæ˜¾ç¤ºç°æœ‰æ—¥å¿—
            this.displayNPCChangeLogs([]);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤NPCå˜æ›´æ—¥å¿—å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ¸…é™¤NPCå˜æ›´æ—¥å¿—
     */
    clearNPCChangeLogs() {
        try {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰NPCå˜æ›´è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…ç©ºæ—¥å¿—
            this.saveNPCChangeLogs([]);
            
            // æ›´æ–°æ˜¾ç¤º
            const changeLogContainer = this.modal.querySelector('#npc-change-log');
            if (changeLogContainer) {
                changeLogContainer.innerHTML = '<div class="npc-change-empty">æš‚æ— å˜æ›´è®°å½•</div>';
            }
            
            console.log('[InfoBarSettings] ğŸ—‘ï¸ NPCå˜æ›´æ—¥å¿—å·²æ¸…é™¤');
            this.showNotification('å˜æ›´è®°å½•å·²æ¸…é™¤', 'success');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…é™¤NPCå˜æ›´æ—¥å¿—å¤±è´¥:', error);
            this.showNotification('æ¸…é™¤å˜æ›´è®°å½•å¤±è´¥', 'error');
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºæ–°å¢NPCå¯¹è¯æ¡†
     */
    async showAddNPCDialog() {
        try {
            console.log('[InfoBarSettings] â• æ˜¾ç¤ºæ–°å¢NPCå¯¹è¯æ¡†');
            
            // ğŸ†• åŠ è½½æ¨¡æ¿
            const npcTemplate = this.loadNPCTemplate();
            const templateFields = this.generateTemplateFieldsHTML(npcTemplate);
            
            // åˆ›å»ºå¯¹è¯æ¡†HTML
            const dialogHTML = `
                <div class="regex-script-overlay" id="add-npc-overlay" style="z-index: 20001;">
                    <div class="regex-script-modal" style="width: 700px; max-width: 95vw; height: auto; max-height: 90vh;">
                        <div class="regex-script-header">
                            <h3>â• æ–°å¢NPC</h3>
                            <button class="regex-btn regex-btn-small" data-action="close-add-npc">å…³é—­</button>
                        </div>
                        
                        <div class="regex-script-body">
                            <form id="add-npc-form">
                                <!-- å›ºå®šå­—æ®µï¼šNPCå§“å -->
                                <div class="regex-form-group">
                                    <label class="regex-form-label">NPCå§“å *</label>
                                    <input type="text" class="regex-form-input" name="npcName" placeholder="è¾“å…¥NPCå§“å" required>
                                </div>
                                
                                <!-- åŠ¨æ€å­—æ®µå®¹å™¨ï¼ˆåŸºäºæ¨¡æ¿ç”Ÿæˆï¼‰ -->
                                <div id="npc-dynamic-fields">
                                    ${templateFields}
                                </div>
                                
                                <!-- æ·»åŠ æ–°å­—æ®µæŒ‰é’® -->
                                <div style="margin: 16px 0;">
                                    <button type="button" id="npc-add-field-btn" class="regex-btn" style="width: 100%;">
                                        â• æ·»åŠ æ–°å­—æ®µ
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="regex-script-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--theme-border-color, #333);">
                            <button type="button" class="regex-btn" data-action="cancel-add-npc">å–æ¶ˆ</button>
                            <button type="button" class="regex-btn regex-btn-primary" data-action="confirm-add-npc">
                                â• åˆ›å»ºNPC
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            const container = document.createElement('div');
            container.innerHTML = dialogHTML;
            document.body.appendChild(container.firstElementChild);
            
            const overlay = document.getElementById('add-npc-overlay');
            const form = document.getElementById('add-npc-form');
            
            // å…³é—­å¯¹è¯æ¡†
            const closeDialog = () => {
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            };
            
            // ç»‘å®šäº‹ä»¶
            overlay.querySelector('[data-action="close-add-npc"]').addEventListener('click', closeDialog);
            overlay.querySelector('[data-action="cancel-add-npc"]').addEventListener('click', closeDialog);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDialog();
                }
            });
            
            // æ·»åŠ æ–°å­—æ®µæŒ‰é’®
            let fieldCounter = npcTemplate.fields.length; // åŸºäºæ¨¡æ¿å­—æ®µæ•°é‡
            overlay.querySelector('#npc-add-field-btn').addEventListener('click', () => {
                fieldCounter++;
                const fieldsContainer = overlay.querySelector('#npc-dynamic-fields');
                
                const newField = document.createElement('div');
                newField.className = 'npc-field-item regex-form-group';
                newField.dataset.fieldId = fieldCounter;
                newField.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="text" class="regex-form-input npc-field-label" placeholder="å­—æ®µåç§°ï¼ˆå¦‚ï¼šèŒä¸šã€çˆ±å¥½ç­‰ï¼‰" style="flex: 1;">
                        <button type="button" class="npc-field-delete-btn" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 4px 8px;
                            font-size: 12px;
                            cursor: pointer;
                        " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                    </div>
                    <input type="text" class="regex-form-input npc-field-value" placeholder="å­—æ®µå€¼">
                `;
                
                fieldsContainer.appendChild(newField);
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®
                newField.querySelector('.npc-field-delete-btn').addEventListener('click', () => {
                    newField.remove();
                });
                
                console.log('[InfoBarSettings] â• æ·»åŠ æ–°å­—æ®µ:', fieldCounter);
            });
            
            // ç»‘å®šé»˜è®¤å­—æ®µçš„åˆ é™¤æŒ‰é’®
            overlay.querySelectorAll('.npc-field-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fieldItem = e.target.closest('.npc-field-item');
                    if (fieldItem) {
                        fieldItem.remove();
                        console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å­—æ®µ');
                    }
                });
            });
            
            // ç¡®è®¤åˆ›å»ºNPC
            overlay.querySelector('[data-action="confirm-add-npc"]').addEventListener('click', async () => {
                try {
                    // æ”¶é›†NPCå§“å
                    const npcName = form.querySelector('[name="npcName"]').value;
                    
                    if (!npcName || npcName.trim() === '') {
                        alert('NPCå§“åä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    // æ”¶é›†æ‰€æœ‰åŠ¨æ€å­—æ®µ
                    const npcData = { name: npcName };
                    const fieldItems = overlay.querySelectorAll('.npc-field-item');
                    
                    fieldItems.forEach(item => {
                        const labelInput = item.querySelector('.npc-field-label');
                        const valueInput = item.querySelector('.npc-field-value');
                        
                        let fieldName;
                        let fieldValue;
                        
                        if (labelInput) {
                            // è‡ªå®šä¹‰å­—æ®µï¼ˆç”¨æˆ·è¾“å…¥çš„å­—æ®µåï¼‰
                            fieldName = labelInput.value.trim();
                            fieldValue = valueInput.value.trim();
                        } else {
                            // é¢„è®¾å­—æ®µï¼ˆæœ‰data-field-nameï¼‰
                            fieldName = valueInput.dataset.fieldName;
                            fieldValue = valueInput.value.trim();
                        }
                        
                        if (fieldName && fieldValue) {
                            npcData[fieldName] = fieldValue;
                        }
                    });
                    
                    console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„NPCæ•°æ®:', npcData);
                    
                    // ä¿å­˜NPCæ•°æ®åˆ°æ•°æ®åº“
                    const npcDatabaseManager = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
                    if (npcDatabaseManager) {
                        await npcDatabaseManager.addNPC(npcData);
                        console.log('[InfoBarSettings] âœ… NPCåˆ›å»ºæˆåŠŸ:', npcData.name);
                        alert(`âœ… NPC "${npcData.name}" åˆ›å»ºæˆåŠŸï¼`);
                        
                        // åˆ·æ–°NPCåˆ—è¡¨
                        await this.refreshNPCList();
                        
                        closeDialog();
                    } else {
                        throw new Error('NPCæ•°æ®åº“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                    }
                    
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ åˆ›å»ºNPCå¤±è´¥:', error);
                    alert(`åˆ›å»ºNPCå¤±è´¥: ${error.message}`);
                }
            });
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ–°å¢NPCå¯¹è¯æ¡†å¤±è´¥:', error);
            alert(`æ˜¾ç¤ºæ–°å¢NPCå¯¹è¯æ¡†å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºç¼–è¾‘NPCæ¨¡æ¿å¯¹è¯æ¡†
     */
    async showEditNPCTemplateDialog() {
        try {
            console.log('[InfoBarSettings] ğŸ“ æ˜¾ç¤ºç¼–è¾‘NPCæ¨¡æ¿å¯¹è¯æ¡†');
            
            // åŠ è½½ç°æœ‰æ¨¡æ¿
            const template = this.loadNPCTemplate();
            
            // åˆ›å»ºå¯¹è¯æ¡†HTML
            const dialogHTML = `
                <div class="regex-script-overlay" id="edit-npc-template-overlay" style="z-index: 20001;">
                    <div class="regex-script-modal" style="width: 700px; max-width: 95vw; height: auto; max-height: 90vh;">
                        <div class="regex-script-header">
                            <h3>ğŸ“ ç¼–è¾‘NPCä¿¡æ¯æ¨¡æ¿</h3>
                            <button class="regex-btn regex-btn-small" data-action="close-edit-template">å…³é—­</button>
                        </div>
                        
                        <div class="regex-script-body">
                            <div style="margin-bottom: 16px; padding: 12px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 6px;">
                                <p style="margin: 0; color: var(--theme-text-secondary, #888); font-size: 13px;">
                                    ğŸ’¡ <strong>æ¨¡æ¿è¯´æ˜ï¼š</strong>å®šä¹‰NPCä¿¡æ¯çš„æ ‡å‡†å­—æ®µç»“æ„ï¼ŒAIå°†æ ¹æ®æ­¤æ¨¡æ¿ç”Ÿæˆå’Œæ›´æ–°NPCæ•°æ®ã€‚<br>
                                    å»ºè®®æ·»åŠ å¸¸ç”¨å­—æ®µå¦‚ï¼šå¹´é¾„ã€æ€§åˆ«ã€èŒä¸šã€æ€§æ ¼ã€å¤–è²Œã€å…³ç³»ç­‰ã€‚
                                </p>
                            </div>
                            
                            <form id="edit-npc-template-form">
                                <!-- åŠ¨æ€å­—æ®µå®¹å™¨ -->
                                <div id="npc-template-fields">
                                    ${this.renderTemplateFields(template.fields)}
                                </div>
                                
                                <!-- æ·»åŠ æ–°å­—æ®µæŒ‰é’® -->
                                <div style="margin: 16px 0;">
                                    <button type="button" id="npc-template-add-field-btn" class="regex-btn" style="width: 100%;">
                                        â• æ·»åŠ æ–°å­—æ®µ
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="regex-script-footer" style="display: flex; gap: 10px; justify-content: space-between; padding: 16px 20px; border-top: 1px solid var(--theme-border-color, #333);">
                            <button type="button" class="regex-btn" data-action="reset-template" style="background: #ff9800;">
                                ğŸ”„ é‡ç½®ä¸ºé»˜è®¤
                            </button>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="regex-btn" data-action="cancel-edit-template">å–æ¶ˆ</button>
                                <button type="button" class="regex-btn regex-btn-primary" data-action="confirm-edit-template">
                                    âœ… ä¿å­˜æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            const container = document.createElement('div');
            container.innerHTML = dialogHTML;
            document.body.appendChild(container.firstElementChild);
            
            const overlay = document.getElementById('edit-npc-template-overlay');
            const form = document.getElementById('edit-npc-template-form');
            
            // å…³é—­å¯¹è¯æ¡†
            const closeDialog = () => {
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            };
            
            // ç»‘å®šäº‹ä»¶
            overlay.querySelector('[data-action="close-edit-template"]').addEventListener('click', closeDialog);
            overlay.querySelector('[data-action="cancel-edit-template"]').addEventListener('click', closeDialog);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDialog();
                }
            });
            
            // æ·»åŠ æ–°å­—æ®µæŒ‰é’®
            let fieldCounter = template.fields.length;
            overlay.querySelector('#npc-template-add-field-btn').addEventListener('click', () => {
                fieldCounter++;
                const fieldsContainer = overlay.querySelector('#npc-template-fields');
                
                const newField = document.createElement('div');
                newField.className = 'npc-template-field-item regex-form-group';
                newField.dataset.fieldId = fieldCounter;
                newField.innerHTML = `
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div style="flex: 1;">
                            <label class="regex-form-label" style="font-size: 12px; color: var(--theme-text-secondary, #888);">å­—æ®µåç§°</label>
                            <input type="text" class="regex-form-input npc-template-field-name" placeholder="ä¾‹å¦‚ï¼šèŒä¸šã€çˆ±å¥½ã€èƒŒæ™¯ç­‰">
                        </div>
                        <div style="flex: 2;">
                            <label class="regex-form-label" style="font-size: 12px; color: var(--theme-text-secondary, #888);">ç¤ºä¾‹å€¼ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="regex-form-input npc-template-field-example" placeholder="ä¾‹å¦‚ï¼šåŒ»ç”Ÿã€é˜…è¯»ã€ç¥ç§˜è¿‡å»ç­‰">
                        </div>
                        <button type="button" class="npc-template-field-delete-btn" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 8px 12px;
                            font-size: 12px;
                            cursor: pointer;
                            margin-top: 24px;
                        " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                fieldsContainer.appendChild(newField);
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®
                newField.querySelector('.npc-template-field-delete-btn').addEventListener('click', () => {
                    newField.remove();
                });
                
                console.log('[InfoBarSettings] â• æ·»åŠ æ–°æ¨¡æ¿å­—æ®µ:', fieldCounter);
            });
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®
            overlay.querySelectorAll('.npc-template-field-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fieldItem = e.target.closest('.npc-template-field-item');
                    if (fieldItem) {
                        fieldItem.remove();
                        console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤æ¨¡æ¿å­—æ®µ');
                    }
                });
            });
            
            // é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿
            overlay.querySelector('[data-action="reset-template"]').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µã€‚')) {
                    const fieldsContainer = overlay.querySelector('#npc-template-fields');
                    const defaultTemplate = this.getDefaultNPCTemplate();
                    fieldsContainer.innerHTML = this.renderTemplateFields(defaultTemplate.fields);
                    
                    // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®
                    fieldsContainer.querySelectorAll('.npc-template-field-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const fieldItem = e.target.closest('.npc-template-field-item');
                            if (fieldItem) {
                                fieldItem.remove();
                            }
                        });
                    });
                    
                    this.showNotification('å·²é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿', 'success');
                }
            });
            
            // ç¡®è®¤ä¿å­˜æ¨¡æ¿
            overlay.querySelector('[data-action="confirm-edit-template"]').addEventListener('click', () => {
                try {
                    // æ”¶é›†æ‰€æœ‰å­—æ®µ
                    const fields = [];
                    const fieldItems = overlay.querySelectorAll('.npc-template-field-item');
                    
                    fieldItems.forEach(item => {
                        const nameInput = item.querySelector('.npc-template-field-name');
                        const exampleInput = item.querySelector('.npc-template-field-example');
                        
                        const fieldName = nameInput.value.trim();
                        const fieldExample = exampleInput.value.trim();
                        
                        if (fieldName) {
                            fields.push({
                                name: fieldName,
                                example: fieldExample || ''
                            });
                        }
                    });
                    
                    if (fields.length === 0) {
                        alert('è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ªå­—æ®µ');
                        return;
                    }
                    
                    // ä¿å­˜æ¨¡æ¿
                    this.saveNPCTemplate({ fields });
                    
                    console.log('[InfoBarSettings] âœ… NPCæ¨¡æ¿å·²ä¿å­˜:', fields);
                    this.showNotification('NPCæ¨¡æ¿å·²ä¿å­˜', 'success');
                    
                    closeDialog();
                    
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ ä¿å­˜NPCæ¨¡æ¿å¤±è´¥:', error);
                    alert(`ä¿å­˜NPCæ¨¡æ¿å¤±è´¥: ${error.message}`);
                }
            });
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºç¼–è¾‘NPCæ¨¡æ¿å¯¹è¯æ¡†å¤±è´¥:', error);
            alert(`æ˜¾ç¤ºç¼–è¾‘NPCæ¨¡æ¿å¯¹è¯æ¡†å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * ğŸ†• æ¸²æŸ“æ¨¡æ¿å­—æ®µ
     */
    renderTemplateFields(fields) {
        return fields.map((field, index) => `
            <div class="npc-template-field-item regex-form-group" data-field-id="${index}">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="flex: 1;">
                        <label class="regex-form-label" style="font-size: 12px; color: var(--theme-text-secondary, #888);">å­—æ®µåç§°</label>
                        <input type="text" class="regex-form-input npc-template-field-name" value="${field.name}" placeholder="ä¾‹å¦‚ï¼šèŒä¸šã€çˆ±å¥½ã€èƒŒæ™¯ç­‰">
                    </div>
                    <div style="flex: 2;">
                        <label class="regex-form-label" style="font-size: 12px; color: var(--theme-text-secondary, #888);">ç¤ºä¾‹å€¼ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="regex-form-input npc-template-field-example" value="${field.example || ''}" placeholder="ä¾‹å¦‚ï¼šåŒ»ç”Ÿã€é˜…è¯»ã€ç¥ç§˜è¿‡å»ç­‰">
                    </div>
                    <button type="button" class="npc-template-field-delete-btn" style="
                        background: #f44336;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 8px 12px;
                        font-size: 12px;
                        cursor: pointer;
                        margin-top: 24px;
                    " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }

    /**
     * ğŸ†• è·å–é»˜è®¤NPCæ¨¡æ¿
     */
    getDefaultNPCTemplate() {
        return {
            fields: [
                { name: 'ç±»å‹', example: 'æœ‹å‹/æ•Œäºº/ç›Ÿå‹ç­‰' },
                { name: 'æ€§åˆ«', example: 'ç”·/å¥³/æœªçŸ¥' },
                { name: 'å¹´é¾„', example: '25å²/çº¦30å²ç­‰' },
                { name: 'èŒä¸š', example: 'åŒ»ç”Ÿ/æ•™å¸ˆ/å•†äººç­‰' },
                { name: 'æ€§æ ¼', example: 'å¼€æœ—/å†·é™/çƒ­æƒ…ç­‰' },
                { name: 'å¤–è²Œ', example: 'é«˜æŒ‘/è‹±ä¿Š/ç¾ä¸½ç­‰' }
            ]
        };
    }

    /**
     * ğŸ†• åŠ è½½NPCæ¨¡æ¿
     */
    loadNPCTemplate() {
        try {
            const saved = localStorage.getItem('infobar_npc_template');
            if (saved) {
                return JSON.parse(saved);
            }
            return this.getDefaultNPCTemplate();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½NPCæ¨¡æ¿å¤±è´¥:', error);
            return this.getDefaultNPCTemplate();
        }
    }

    /**
     * ğŸ†• ä¿å­˜NPCæ¨¡æ¿
     */
    saveNPCTemplate(template) {
        try {
            localStorage.setItem('infobar_npc_template', JSON.stringify(template));
            console.log('[InfoBarSettings] âœ… NPCæ¨¡æ¿å·²ä¿å­˜');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜NPCæ¨¡æ¿å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ†• ç”Ÿæˆæ¨¡æ¿å­—æ®µHTMLï¼ˆç”¨äºæ–°å¢NPCå¯¹è¯æ¡†ï¼‰
     */
    generateTemplateFieldsHTML(template) {
        if (!template || !template.fields || template.fields.length === 0) {
            // å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œè¿”å›é»˜è®¤å­—æ®µ
            return `
                <div class="npc-field-item regex-form-group" data-field-id="1">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <label class="regex-form-label" style="flex: 1; margin: 0;">NPCç±»å‹</label>
                        <button type="button" class="npc-field-delete-btn" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 4px 8px;
                            font-size: 12px;
                            cursor: pointer;
                        " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                    </div>
                    <input type="text" class="regex-form-input npc-field-value" data-field-name="ç±»å‹" placeholder="ä¾‹å¦‚ï¼šæœ‹å‹ã€æ•Œäººã€è·¯äººç­‰">
                </div>
            `;
        }
        
        return template.fields.map((field, index) => `
            <div class="npc-field-item regex-form-group" data-field-id="${index + 1}">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <label class="regex-form-label" style="flex: 1; margin: 0;">${field.name}</label>
                    <button type="button" class="npc-field-delete-btn" style="
                        background: #f44336;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 4px 8px;
                        font-size: 12px;
                        cursor: pointer;
                    " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                </div>
                <input type="text" class="regex-form-input npc-field-value" data-field-name="${field.name}" placeholder="${field.example || ''}">
            </div>
        `).join('');
    }

    /**
     * ğŸ†• ç”Ÿæˆæ¨¡æ¿ä¿¡æ¯ï¼ˆç”¨äºAIæç¤ºè¯ï¼‰
     */
    generateTemplateInfo(template) {
        if (!template || !template.fields || template.fields.length === 0) {
            return '';
        }
        
        let info = `## ğŸ“ NPCä¿¡æ¯æ¨¡æ¿\n\n`;
        info += `è¯·æ ¹æ®ä»¥ä¸‹æ¨¡æ¿å­—æ®µç”Ÿæˆæˆ–æ›´æ–°NPCä¿¡æ¯ï¼š\n\n`;
        
        template.fields.forEach((field, index) => {
            const example = field.example ? ` (ç¤ºä¾‹: ${field.example})` : '';
            info += `${index + 1}. **${field.name}**${example}\n`;
        });
        
        info += `\nâš ï¸ **é‡è¦æç¤º**ï¼š\n`;
        info += `- æ–°å¢NPCæ—¶ï¼Œè¯·å°½é‡æŒ‰ç…§æ¨¡æ¿å­—æ®µå¡«å†™å®Œæ•´ä¿¡æ¯\n`;
        info += `- å­—æ®µåå¿…é¡»ä¸æ¨¡æ¿ä¸­çš„å­—æ®µå**å®Œå…¨ä¸€è‡´**\n`;
        info += `- å¦‚æœå¯¹è¯ä¸­æœªæ˜ç¡®æåˆ°æŸä¸ªå­—æ®µï¼Œå¯ä»¥ç•™ç©ºæˆ–ä½¿ç”¨"æœªçŸ¥"\n`;
        
        return info;
    }

    /**
     * ğŸ†• ç”Ÿæˆè¿‡æ»¤è§„åˆ™ï¼ˆç”¨äºAIæç¤ºè¯ï¼‰
     */
    generateFilterRules() {
        return `## ğŸš« è·¯äººè§’è‰²è¿‡æ»¤è§„åˆ™

**è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¿‡æ»¤è§„åˆ™ï¼Œé¿å…æ·»åŠ æ— å…³ç´§è¦çš„è·¯äººè§’è‰²ï¼š**

### âŒ ç¦æ­¢æ·»åŠ çš„è§’è‰²ç±»å‹

1. **æ³›æŒ‡è§’è‰²**ï¼šç”²ã€ä¹™ã€ä¸™ã€ä¸ã€è·¯äººA/B/Cã€æŸäººã€ä¼—äººç­‰
2. **èŒä¸šæ³›ç§°**ï¼šæ¸…æ´å·¥ã€æœåŠ¡å‘˜ã€å”®è´§å‘˜ã€ä¿å®‰ã€å¸æœºç­‰ï¼ˆé™¤éæœ‰å…·ä½“å§“åæˆ–é‡è¦å‰§æƒ…å…³è”ï¼‰
3. **ç¾¤ä½“è§’è‰²**ï¼šäººç¾¤ã€è§‚ä¼—ã€è·¯äººã€ç¾¤ä¼—ã€å›´è§‚è€…ç­‰
4. **èƒŒæ™¯è§’è‰²**ï¼šåªè¢«ç®€å•æåŠä¸€æ¬¡ï¼Œæ²¡æœ‰å¯¹è¯æˆ–äº’åŠ¨çš„è§’è‰²
5. **åŠŸèƒ½æ€§è§’è‰²**ï¼šä»…ç”¨äºæ¨åŠ¨å‰§æƒ…ï¼Œæ²¡æœ‰ç‹¬ç«‹äººæ ¼ç‰¹å¾çš„è§’è‰²

### âœ… å¯ä»¥æ·»åŠ çš„è§’è‰²æ ‡å‡†

**åªæœ‰æ»¡è¶³ä»¥ä¸‹**è‡³å°‘ä¸€ä¸ª**æ¡ä»¶çš„è§’è‰²æ‰åº”è¯¥è¢«æ·»åŠ ï¼š**

1. **æœ‰æ˜ç¡®å§“å**ï¼šè§’è‰²æœ‰å…·ä½“çš„å§“åï¼ˆé"å¼ ä¸‰"ã€"å°æ"ç­‰å¸¸è§å‡åï¼‰
2. **é‡å¤å‡ºç°**ï¼šåœ¨å¯¹è¯ä¸­å¤šæ¬¡å‡ºç°æˆ–æåŠï¼ˆè‡³å°‘2æ¬¡ä»¥ä¸Šï¼‰
3. **æœ‰å¯¹è¯äº’åŠ¨**ï¼šä¸ä¸»è¦è§’è‰²æœ‰å®è´¨æ€§çš„å¯¹è¯äº¤æµ
4. **é‡è¦å…³ç³»**ï¼šä¸ä¸»è§’æˆ–å…¶ä»–é‡è¦è§’è‰²æœ‰æ˜ç¡®çš„å…³ç³»ï¼ˆäº²äººã€æœ‹å‹ã€æ•Œäººç­‰ï¼‰
5. **å‰§æƒ…å…³é”®**ï¼šå¯¹å‰§æƒ…å‘å±•æœ‰é‡è¦å½±å“
6. **ç‹¬ç‰¹ç‰¹å¾**ï¼šæœ‰æ˜ç¡®çš„æ€§æ ¼ã€å¤–è²Œæˆ–èƒŒæ™¯æè¿°

### ğŸ’¡ åˆ¤æ–­ç¤ºä¾‹

**âŒ ä¸åº”æ·»åŠ ï¼š**
- "ä¸€ä¸ªæ¸…æ´å·¥ç»è¿‡" â†’ èƒŒæ™¯è§’è‰²ï¼Œæ— é‡è¦æ€§
- "è·¯äººç”²å¯¹è·¯äººä¹™è¯´" â†’ æ³›æŒ‡è§’è‰²
- "æœåŠ¡å‘˜ç«¯ä¸Šå’–å•¡" â†’ åŠŸèƒ½æ€§è§’è‰²ï¼Œæ— ä¸ªæ€§
- "é—¨å«æ£€æŸ¥äº†è¯ä»¶" â†’ èŒä¸šæ³›ç§°ï¼Œæ— å…·ä½“ç‰¹å¾

**âœ… åº”è¯¥æ·»åŠ ï¼š**
- "å¼ æ˜ï¼ˆå’–å•¡åº—è€æ¿ï¼‰çƒ­æƒ…åœ°æ‹›å‘¼" â†’ æœ‰å§“å+èŒä¸š+æ€§æ ¼ç‰¹å¾
- "æåŒ»ç”Ÿå†æ¬¡å®å˜±è¦æŒ‰æ—¶åƒè¯" â†’ æœ‰ç§°å‘¼+é‡å¤å‡ºç°+æœ‰å¯¹è¯
- "è‰¾ç±³è‰æ˜¯ä¸»è§’çš„é’æ¢…ç«¹é©¬" â†’ æœ‰å§“å+é‡è¦å…³ç³»

### ğŸ¯ æ‰§è¡Œè¦æ±‚

- **ä¸¥æ ¼å®¡æŸ¥**ï¼šåœ¨æ·»åŠ ä»»ä½•NPCå‰ï¼Œå¿…é¡»æ£€æŸ¥æ˜¯å¦ç¬¦åˆ"å¯ä»¥æ·»åŠ çš„è§’è‰²æ ‡å‡†"
- **å®ç¼ºæ¯‹æ»¥**ï¼šå¦‚æœä¸ç¡®å®šï¼Œé€‰æ‹©ä¸æ·»åŠ 
- **ä¼˜å…ˆé‡è¦æ€§**ï¼šä¼˜å…ˆæ·»åŠ å¯¹å‰§æƒ…å’Œè§’è‰²å…³ç³»é‡è¦çš„NPC
`;
    }

    /**
     * å¤„ç†ç«‹å³åŒæ­¥NPCæ•°æ®ï¼ˆé¢æ¿æ¨¡å¼ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šä¸å†ä¾èµ–å·²åˆ é™¤çš„NPCManagementPanelï¼Œç›´æ¥åˆ·æ–°åˆ—è¡¨
     */
    async handleNPCSyncNow() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°NPCåˆ—è¡¨...');
            
            // é¢æ¿æ¨¡å¼ä¸‹ï¼ŒNPCæ•°æ®ç”±NPCDatabaseManagerè‡ªåŠ¨ç®¡ç†ï¼ˆç›‘å¬data:updatedäº‹ä»¶ï¼‰
            // è¿™é‡Œåªéœ€è¦åˆ·æ–°æ˜¾ç¤ºçš„åˆ—è¡¨å³å¯
            await this.refreshNPCList();
            
            this.showNotification('NPCåˆ—è¡¨å·²åˆ·æ–°', 'success');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°NPCåˆ—è¡¨å¤±è´¥:', error);
            this.showNotification('åˆ·æ–°NPCåˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†åŒæ­¥NPCåˆ°ä¸–ç•Œä¹¦
     * ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ç›®æ ‡ä¸–ç•Œä¹¦ï¼Œè€Œä¸æ˜¯æ€»æ˜¯ä½¿ç”¨é»˜è®¤ä¸–ç•Œä¹¦
     */
    async handleNPCWorldBookSyncNow() {
        try {
            console.log('[InfoBarSettings] ğŸŒ å¼€å§‹æ‰‹åŠ¨åŒæ­¥NPCåˆ°ä¸–ç•Œä¹¦...');

            // è·å–WorldBookManagerå’ŒNPCDatabaseManager
            const worldBookManager = window.SillyTavernInfobar?.modules?.worldBookManager;
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;

            if (!worldBookManager) {
                this.showNotification('ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }

            if (!npcDB) {
                this.showNotification('NPCæ•°æ®åº“ç®¡ç†å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }

            // è·å–å½“å‰èŠå¤©çš„æ‰€æœ‰NPC
            const npcs = await npcDB.getAllNpcsForCurrentChat();
            if (!npcs || npcs.length === 0) {
                this.showNotification('å½“å‰æ²¡æœ‰NPCæ•°æ®å¯åŒæ­¥', 'info');
                return;
            }

            console.log(`[InfoBarSettings] ğŸŒ æ‰¾åˆ° ${npcs.length} ä¸ªNPCï¼Œå¼€å§‹åŒæ­¥åˆ°ä¸–ç•Œä¹¦...`);

            // ğŸ”§ ä¿®å¤ï¼šè·å–ç”¨æˆ·é€‰æ‹©çš„ç›®æ ‡ä¸–ç•Œä¹¦
            const selectedWorldBook = localStorage.getItem('npcPanel_targetWorldBook') || 'auto';
            console.log('[InfoBarSettings] ğŸ¯ ç”¨æˆ·é€‰æ‹©çš„ç›®æ ‡ä¸–ç•Œä¹¦:', selectedWorldBook);

            let worldBookResult;

            if (selectedWorldBook === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è§’è‰²é“¾æ¥çš„ä¸»è¦ä¸–ç•Œä¹¦
                worldBookResult = await worldBookManager.getOrCreateTargetWorldBook(true);
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ï¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ä¸–ç•Œä¹¦
                worldBookResult = await this.getSpecificWorldBook(selectedWorldBook);
            }

            if (!worldBookResult.success) {
                throw new Error(`è·å–ç›®æ ‡ä¸–ç•Œä¹¦å¤±è´¥: ${worldBookResult.error}`);
            }

            const { worldBookName, worldBookData, isNewWorldBook } = worldBookResult;
            console.log('[InfoBarSettings] ğŸ“š ç›®æ ‡ä¸–ç•Œä¹¦:', worldBookName);

            let syncedCount = 0;

            // ä¸ºæ¯ä¸ªNPCåˆ›å»ºæˆ–æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®
            for (const npc of npcs) {
                try {
                    // æ ¼å¼åŒ–NPCæ•°æ®ä¸ºä¸–ç•Œä¹¦æ¡ç›®
                    const entryData = this.formatNPCAsWorldBookEntry(npc);

                    // åˆ›å»ºæˆ–æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®
                    const entryResult = await worldBookManager.createOrUpdateWorldBookEntry(
                        worldBookName,
                        worldBookData,
                        entryData
                    );

                    if (entryResult.success) {
                        syncedCount++;
                        console.log(`[InfoBarSettings] âœ… NPC "${npc.name}" å·²åŒæ­¥åˆ°ä¸–ç•Œä¹¦ "${worldBookName}"`);
                    }
                } catch (error) {
                    console.error(`[InfoBarSettings] âŒ å¤„ç†NPC "${npc.name}" å¤±è´¥:`, error);
                }
            }

            // å»é‡
            await worldBookManager.deduplicateWorldBookEntries(worldBookName, worldBookData);

            // ç»‘å®šä¸–ç•Œä¹¦ï¼ˆå¦‚æœæ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (isNewWorldBook) {
                await worldBookManager.bindWorldBookToChatLore(worldBookName);
            }

            // åˆ·æ–°ç¼“å­˜
            await worldBookManager.refreshCache();

            this.showNotification(`NPCæ•°æ®å·²åŒæ­¥åˆ°ä¸–ç•Œä¹¦ "${worldBookName}" (${syncedCount}/${npcs.length})`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰‹åŠ¨åŒæ­¥NPCåˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
            this.showNotification('åŒæ­¥åˆ°ä¸–ç•Œä¹¦å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• è·å–æŒ‡å®šçš„ä¸–ç•Œä¹¦
     */
    async getSpecificWorldBook(worldBookName) {
        try {
            const context = window.SillyTavern?.getContext?.();
            if (!context) {
                return {
                    success: false,
                    error: 'æ— æ³•è·å–SillyTavernä¸Šä¸‹æ–‡'
                };
            }

            console.log('[InfoBarSettings] ğŸ“š å°è¯•åŠ è½½æŒ‡å®šçš„ä¸–ç•Œä¹¦:', worldBookName);

            // å°è¯•åŠ è½½ä¸–ç•Œä¹¦æ•°æ®
            let worldData = null;
            if (typeof context.loadWorldInfo === 'function') {
                try {
                    worldData = await context.loadWorldInfo(worldBookName);
                } catch (loadError) {
                    console.warn('[InfoBarSettings] âš ï¸ åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥:', loadError);
                    return {
                        success: false,
                        error: `åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥: ${loadError.message}`
                    };
                }
            }

            if (!worldData) {
                return {
                    success: false,
                    error: `ä¸–ç•Œä¹¦ "${worldBookName}" ä¸å­˜åœ¨æˆ–æ— æ³•åŠ è½½`
                };
            }

            console.log('[InfoBarSettings] âœ… æˆåŠŸåŠ è½½ä¸–ç•Œä¹¦:', worldBookName);

            return {
                success: true,
                worldBookName: worldBookName,
                worldBookData: worldData,
                isNewWorldBook: false
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æŒ‡å®šä¸–ç•Œä¹¦å¤±è´¥:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * ğŸ”§ æ ¼å¼åŒ–NPCæ•°æ®ä¸ºä¸–ç•Œä¹¦æ¡ç›®
     */
    formatNPCAsWorldBookEntry(npc) {
        const entryName = npc.name;
        const keywords = [npc.name];
        
        if (npc.alias && npc.alias.length > 0) {
            keywords.push(...npc.alias);
        }
        
        let content = `# ${npc.name}\n\n`;
        
        if (npc.appearCount) {
            content += `**å‡ºç°æ¬¡æ•°**: ${npc.appearCount}\n`;
        }
        
        if (npc.lastSeen) {
            const lastSeenDate = new Date(npc.lastSeen).toLocaleString('zh-CN');
            content += `**æœ€åå‡ºç°**: ${lastSeenDate}\n`;
        }
        
        content += '\n';
        
        if (npc.fields && Object.keys(npc.fields).length > 0) {
            content += '## è§’è‰²ä¿¡æ¯\n\n';
            Object.entries(npc.fields).forEach(([fieldName, value]) => {
                if (fieldName === 'index' || fieldName === 'source' || fieldName.startsWith('_')) {
                    return;
                }
                if (!value || value.toString().trim() === '') {
                    return;
                }
                content += `**${fieldName}**: ${value}\n`;
            });
        }
        
        content += '\n---\n';
        content += `*æ•°æ®æ¥æº: NPCæ•°æ®åº“ | æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}*`;
        
        return {
            entryName: entryName,
            content: content,
            keywords: keywords,
            order: 100,
            summaryId: `npc_${npc.id}`,
            summaryType: 'npc',
            summarySource: 'npc_database',
            npcId: npc.id,
            npcName: npc.name,
            sourceType: 'npc_database'
        };
    }

    /**
     * ğŸ†• AIæ¨¡å¼ä¸‹ï¼šåœ¨è§£æå®ŒNPCæ“ä½œåè§¦å‘ä¸–ç•Œä¹¦åŒæ­¥
     * ğŸ”§ ä¿®å¤ï¼šä¸å†ä¾èµ–å·²åˆ é™¤çš„NPCManagementPanelï¼Œç›´æ¥è°ƒç”¨åŒæ­¥é€»è¾‘
     */
    async handleNPCWorldBookSyncAfterAI() {
        try {
            // æ£€æŸ¥ä¸–ç•Œä¹¦åŒæ­¥æ˜¯å¦å¯ç”¨
            const syncCheckbox = this.modal.querySelector('#npc-worldbook-sync-enabled');
            if (!syncCheckbox || !syncCheckbox.checked) {
                console.log('[InfoBarSettings] â„¹ï¸ ä¸–ç•Œä¹¦åŒæ­¥æœªå¯ç”¨ï¼Œè·³è¿‡');
                return;
            }

            console.log('[InfoBarSettings] ğŸŒ AIæ¨¡å¼ï¼šNPCæ•°æ®å·²å­˜å‚¨ï¼Œè§¦å‘ä¸–ç•Œä¹¦åŒæ­¥...');
            
            // ç›´æ¥è°ƒç”¨handleNPCWorldBookSyncNowæ–¹æ³•
            await this.handleNPCWorldBookSyncNow();
            
            console.log('[InfoBarSettings] âœ… AIæ¨¡å¼ï¼šä¸–ç•Œä¹¦åŒæ­¥å®Œæˆ');
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ AIæ¨¡å¼ä¸–ç•Œä¹¦åŒæ­¥å¤±è´¥:', error);
            // ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
        }
    }

    /**
     * åˆ·æ–°NPCåˆ—è¡¨
     */
    async refreshNPCList() {
        try {
            const container = this.modal.querySelector('#npc-cards-container');
            if (!container) {
                console.log('[InfoBarSettings] âš ï¸ NPCå®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="npc-loading">æ­£åœ¨åŠ è½½NPCæ•°æ®...</div>';

            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                container.innerHTML = '<div class="npc-error">NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°</div>';
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šå¼ºåˆ¶é‡æ–°åŠ è½½NPCæ•°æ®åº“ï¼Œç¡®ä¿è·å–å½“å‰èŠå¤©çš„æ•°æ®
            console.log('[InfoBarSettings] ğŸ”„ å¼ºåˆ¶é‡æ–°åŠ è½½NPCæ•°æ®åº“...');
            await npcDB.load(); // å¼ºåˆ¶é‡æ–°åŠ è½½

            // è·å–å½“å‰èŠå¤©çš„NPCæ•°æ®
            const currentChatId = npcDB.getCurrentChatId();
            console.log('[InfoBarSettings] ğŸ“ å½“å‰èŠå¤©ID:', currentChatId);
            
            const npcs = await npcDB.getAllNpcsForCurrentChat();

            if (!npcs || npcs.length === 0) {
                container.innerHTML = '<div class="npc-empty">å½“å‰èŠå¤©ä¸­æš‚æ— NPCæ•°æ®</div>';
                return;
            }

            // ç”ŸæˆNPCå¡ç‰‡
            const cardsHtml = npcs.map(npc => this.createNPCCard(npc)).join('');
            container.innerHTML = cardsHtml;

            // ç»‘å®šå¡ç‰‡ç‚¹å‡»äº‹ä»¶
            this.bindNPCCardEvents();

            console.log('[InfoBarSettings] âœ… NPCåˆ—è¡¨å·²åˆ·æ–°ï¼Œæ˜¾ç¤º', npcs.length, 'ä¸ªNPC');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°NPCåˆ—è¡¨å¤±è´¥:', error);
            const container = this.modal.querySelector('#npc-cards-container');
            if (container) {
                container.innerHTML = '<div class="npc-error">åŠ è½½NPCæ•°æ®å¤±è´¥</div>';
            }
        }
    }

    /**
     * åˆ›å»ºNPCå¡ç‰‡HTML
     */
    createNPCCard(npc) {
        const lastSeenTime = npc.lastSeen ? new Date(npc.lastSeen).toLocaleString() : 'æœªçŸ¥';
        const fieldCount = Object.keys(npc.fields || {}).length;
        const isSelected = this.selectedNpcIds?.has(npc.id) || false;

        return `
            <div class="npc-card ${isSelected ? 'selected' : ''}" data-npc-id="${npc.id}">
                <div class="npc-card-header">
                    <div class="npc-checkbox-wrapper" style="display: flex; align-items: center; gap: 8px;">
                        <div class="npc-checkbox" data-npc-id="${npc.id}" style="
                            width: 18px;
                            height: 18px;
                            border: 2px solid var(--theme-border-color, var(--SmartThemeBorderColor, #555));
                            border-radius: 3px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: ${isSelected ? 'var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff))' : 'transparent'};
                            transition: all 0.2s ease;
                            flex-shrink: 0;
                        " title="é€‰æ‹©æ­¤NPC" onmouseover="if(!this.querySelector('span')){this.style.borderColor='var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff))'}" onmouseout="if(!this.querySelector('span')){this.style.borderColor='var(--theme-border-color, var(--SmartThemeBorderColor, #555))'}">
                            ${isSelected ? '<span style="color: white; font-size: 12px; font-weight: bold;">âœ“</span>' : ''}
                        </div>
                        <h4 class="npc-name" style="margin: 0; flex: 1;">${this.escapeHtml(npc.name)}</h4>
                    </div>
                    <span class="npc-appear-count">${npc.appearCount || 0}æ¬¡</span>
                </div>
                <div class="npc-card-body">
                    <div class="npc-info">
                        <span class="npc-field-count">ğŸ“‹ ${fieldCount} ä¸ªå­—æ®µ</span>
                        <span class="npc-last-seen">ğŸ•’ ${lastSeenTime}</span>
                    </div>
                </div>
                <div class="npc-card-footer">
                    <div class="npc-card-actions">
                        <button class="btn btn-sm npc-view-btn" data-npc-id="${npc.id}" style="
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                            border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                            padding: 4px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='var(--theme-accent-color, var(--SmartThemeQuoteColor, #007bff))'" onmouseout="this.style.background='var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a))'">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="btn btn-sm npc-delete-btn" data-npc-id="${npc.id}" title="åˆ é™¤æ­¤NPC" style="
                            background: var(--theme-bg-danger, #dc3545);
                            color: white;
                            border: none;
                            padding: 4px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='var(--theme-bg-danger-hover, #c82333)'" onmouseout="this.style.background='var(--theme-bg-danger, #dc3545)'">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šNPCå¡ç‰‡äº‹ä»¶
     */
    bindNPCCardEvents() {
        const cards = this.modal.querySelectorAll('.npc-card');
        cards.forEach(card => {
            card.addEventListener('click', (e) => {
                // ğŸ†• å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶
                if (e.target.closest('.npc-checkbox')) {
                    e.stopPropagation();
                    const checkbox = e.target.closest('.npc-checkbox');
                    const npcId = checkbox.dataset.npcId;
                    this.toggleNpcSelection(npcId);
                    return;
                }
                
                if (e.target.classList.contains('npc-view-btn')) {
                    const npcId = e.target.dataset.npcId;
                    this.showNPCDetails(npcId);
                } else if (e.target.classList.contains('npc-delete-btn')) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    const npcId = e.target.dataset.npcId;
                    this.deleteNPC(npcId);
                }
            });
        });
        
        // ğŸ”§ ä¿®å¤ï¼šæ‰¹é‡æ“ä½œæŒ‰é’®åªåœ¨ç¬¬ä¸€æ¬¡ç»‘å®šï¼Œé¿å…é‡å¤ç»‘å®š
        if (!this._batchOperationEventsBound) {
            const selectAllBtn = this.modal.querySelector('#npc-select-all-btn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => this.toggleSelectAllNpcs());
                console.log('[InfoBarSettings] ğŸ”— å·²ç»‘å®šå…¨é€‰æŒ‰é’®äº‹ä»¶');
            }

            const mergeBtn = this.modal.querySelector('#npc-merge-btn');
            if (mergeBtn) {
                mergeBtn.addEventListener('click', () => this.showMergeNPCDialog());
                console.log('[InfoBarSettings] ğŸ”— å·²ç»‘å®šåˆå¹¶è§’è‰²æŒ‰é’®äº‹ä»¶');
            }

            const batchDeleteBtn = this.modal.querySelector('#npc-batch-delete-btn');
            if (batchDeleteBtn) {
                batchDeleteBtn.addEventListener('click', () => this.batchDeleteNpcs());
                console.log('[InfoBarSettings] ğŸ”— å·²ç»‘å®šæ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶');
            }

            this._batchOperationEventsBound = true;
        }
    }

    /**
     * åˆ é™¤NPC
     */
    async deleteNPC(npcId) {
        try {
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                console.error('[InfoBarSettings] âŒ NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°');
                return;
            }

            // è·å–NPCä¿¡æ¯ç”¨äºç¡®è®¤å¯¹è¯æ¡†
            const npc = npcDB.getNPCById(npcId);
            if (!npc) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°NPC:', npcId);
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤NPC "${npc.name}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†æ°¸ä¹…åˆ é™¤è¯¥NPCçš„æ‰€æœ‰æ•°æ®ã€‚`);
            if (!confirmed) {
                console.log('[InfoBarSettings] ğŸš« ç”¨æˆ·å–æ¶ˆåˆ é™¤æ“ä½œ');
                return;
            }

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹åˆ é™¤NPC:', npcId, npc.name);

            // æ‰§è¡Œåˆ é™¤æ“ä½œ
            const success = await npcDB.deleteNPC(npcId);
            if (success) {
                console.log('[InfoBarSettings] âœ… NPCåˆ é™¤æˆåŠŸ:', npcId);

                // åˆ·æ–°NPCåˆ—è¡¨
                await this.refreshNPCList();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.showToast(`NPC "${npc.name}" å·²æˆåŠŸåˆ é™¤`, 'success');
            } else {
                console.error('[InfoBarSettings] âŒ NPCåˆ é™¤å¤±è´¥:', npcId);
                this.showToast(`åˆ é™¤NPC "${npc.name}" å¤±è´¥`, 'error');
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤NPCæ—¶å‘ç”Ÿé”™è¯¯:', error);
            this.showToast('åˆ é™¤NPCæ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    }

    /**
     * ğŸ†• åˆ‡æ¢å•ä¸ªNPCçš„é€‰ä¸­çŠ¶æ€
     */
    toggleNpcSelection(npcId) {
        if (this.selectedNpcIds.has(npcId)) {
            this.selectedNpcIds.delete(npcId);
            console.log('[InfoBarSettings] â˜‘ï¸ å–æ¶ˆé€‰ä¸­NPC:', npcId);
        } else {
            this.selectedNpcIds.add(npcId);
            console.log('[InfoBarSettings] âœ… é€‰ä¸­NPC:', npcId);
        }
        
        // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
        this.refreshNPCList();
        this.updateBatchOperationUI();
    }

    /**
     * ğŸ†• å…¨é€‰/å–æ¶ˆå…¨é€‰NPC
     */
    async toggleSelectAllNpcs() {
        try {
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) return;

            const npcs = await npcDB.getAllNpcsForCurrentChat();
            
            // æ£€æŸ¥æ˜¯å¦å…¨é€‰
            const allSelected = npcs.length > 0 && npcs.every(npc => this.selectedNpcIds.has(npc.id));
            
            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                npcs.forEach(npc => this.selectedNpcIds.delete(npc.id));
                console.log('[InfoBarSettings] â˜ å–æ¶ˆå…¨é€‰');
            } else {
                // å…¨é€‰
                npcs.forEach(npc => this.selectedNpcIds.add(npc.id));
                console.log('[InfoBarSettings] â˜‘ï¸ å·²å…¨é€‰', npcs.length, 'ä¸ªNPC');
            }
            
            // åˆ·æ–°åˆ—è¡¨
            await this.refreshNPCList();
            this.updateBatchOperationUI();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å…¨é€‰æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• æ‰¹é‡åˆ é™¤NPC
     */
    async batchDeleteNpcs() {
        try {
            if (this.selectedNpcIds.size === 0) {
                this.showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„NPC', 'warning');
                return;
            }

            if (this.batchDeleteInProgress) {
                this.showToast('æ‰¹é‡åˆ é™¤æ­£åœ¨è¿›è¡Œä¸­...', 'info');
                return;
            }

            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                this.showToast('NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°', 'error');
                return;
            }

            // è·å–é€‰ä¸­çš„NPCä¿¡æ¯
            const selectedNpcs = [];
            for (const npcId of this.selectedNpcIds) {
                const npc = npcDB.getNPCById(npcId);
                if (npc) {
                    selectedNpcs.push({ id: npcId, npc });
                }
            }

            if (selectedNpcs.length === 0) {
                this.showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„NPC', 'warning');
                this.selectedNpcIds.clear();
                await this.refreshNPCList();
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const npcNames = selectedNpcs.slice(0, 5).map(item => item.npc.name).join('ã€');
            const moreText = selectedNpcs.length > 5 ? ` ç­‰ ${selectedNpcs.length} ä¸ª` : '';
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ ${selectedNpcs.length} ä¸ªNPCå—ï¼Ÿ\n\n${npcNames}${moreText}\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†æ°¸ä¹…åˆ é™¤è¿™äº›NPCåŠå…¶åœ¨ä¸–ç•Œä¹¦ä¸­çš„ç›¸å…³æ¡ç›®ã€‚`;
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) {
                console.log('[InfoBarSettings] â„¹ï¸ ç”¨æˆ·å–æ¶ˆæ‰¹é‡åˆ é™¤æ“ä½œ');
                return;
            }

            // å¼€å§‹æ‰¹é‡åˆ é™¤
            this.batchDeleteInProgress = true;
            this.updateBatchOperationUI();

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ‰¹é‡åˆ é™¤', selectedNpcs.length, 'ä¸ªNPC...');

            let successCount = 0;
            let failCount = 0;

            // é€ä¸ªåˆ é™¤NPC
            for (const { id, npc } of selectedNpcs) {
                try {
                    const success = await npcDB.deleteNPC(id);
                    if (success) {
                        successCount++;
                        console.log(`[InfoBarSettings] âœ… åˆ é™¤æˆåŠŸ: ${npc.name} (${id})`);
                    } else {
                        failCount++;
                        console.warn(`[InfoBarSettings] âš ï¸ åˆ é™¤å¤±è´¥: ${npc.name} (${id})`);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`[InfoBarSettings] âŒ åˆ é™¤å‡ºé”™: ${npc.name} (${id})`, error);
                }
            }

            // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
            this.selectedNpcIds.clear();

            // åˆ·æ–°åˆ—è¡¨
            await this.refreshNPCList();

            // æ˜¾ç¤ºç»“æœ
            const message = `æ‰¹é‡åˆ é™¤å®Œæˆï¼æˆåŠŸ: ${successCount} ä¸ªï¼Œå¤±è´¥: ${failCount} ä¸ª`;
            console.log('[InfoBarSettings] âœ…', message);
            this.showToast(message, successCount > 0 ? 'success' : 'error');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            this.showToast('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        } finally {
            this.batchDeleteInProgress = false;
            this.updateBatchOperationUI();
        }
    }

    /**
     * ğŸ†• æ›´æ–°æ‰¹é‡æ“ä½œUIçŠ¶æ€
     */
    updateBatchOperationUI() {
        if (!this.modal) return;

        const selectedCount = this.selectedNpcIds.size;
        const countElement = this.modal.querySelector('.npc-count-number');
        const mergeBtn = this.modal.querySelector('#npc-merge-btn');
        const batchDeleteBtn = this.modal.querySelector('#npc-batch-delete-btn');
        const selectAllBtn = this.modal.querySelector('#npc-select-all-btn');
        const selectAllIcon = this.modal.querySelector('.select-all-icon');

        // æ›´æ–°é€‰ä¸­æ•°é‡
        if (countElement) {
            countElement.textContent = selectedCount;
        }

        // ğŸ†• æ›´æ–°åˆå¹¶æŒ‰é’®çŠ¶æ€ï¼ˆåªåœ¨é€‰ä¸­æ°å¥½2ä¸ªNPCæ—¶å¯ç”¨ï¼‰
        if (mergeBtn) {
            if (selectedCount === 2) {
                mergeBtn.disabled = false;
                mergeBtn.style.opacity = '1';
                mergeBtn.style.cursor = 'pointer';
                mergeBtn.onmouseover = () => {
                    mergeBtn.style.background = 'var(--theme-primary-hover, #45a049)';
                };
                mergeBtn.onmouseout = () => {
                    mergeBtn.style.background = 'var(--theme-primary-color, #4CAF50)';
                };
            } else {
                mergeBtn.disabled = true;
                mergeBtn.style.opacity = '0.5';
                mergeBtn.style.cursor = 'not-allowed';
                mergeBtn.onmouseover = null;
                mergeBtn.onmouseout = null;
            }
        }

        // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
        if (batchDeleteBtn) {
            if (selectedCount > 0 && !this.batchDeleteInProgress) {
                batchDeleteBtn.disabled = false;
                batchDeleteBtn.style.opacity = '1';
                batchDeleteBtn.style.cursor = 'pointer';
                // ğŸ”§ æ·»åŠ æ‚¬åœæ•ˆæœï¼ˆä½¿ç”¨ä¿¡æ¯æ ä¸»é¢˜å˜é‡ï¼‰
                batchDeleteBtn.onmouseover = () => {
                    batchDeleteBtn.style.background = 'var(--theme-bg-danger-hover, #c82333)';
                };
                batchDeleteBtn.onmouseout = () => {
                    batchDeleteBtn.style.background = 'var(--theme-bg-danger, #dc3545)';
                };
            } else {
                batchDeleteBtn.disabled = true;
                batchDeleteBtn.style.opacity = '0.5';
                batchDeleteBtn.style.cursor = 'not-allowed';
                // ğŸ”§ ç§»é™¤æ‚¬åœæ•ˆæœ
                batchDeleteBtn.onmouseover = null;
                batchDeleteBtn.onmouseout = null;
            }

            if (this.batchDeleteInProgress) {
                batchDeleteBtn.innerHTML = 'â³ åˆ é™¤ä¸­...';
            } else {
                batchDeleteBtn.innerHTML = 'ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤';
            }
        }

        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        if (selectAllBtn && selectAllIcon) {
            // å¼‚æ­¥æ£€æŸ¥æ˜¯å¦å…¨é€‰
            (async () => {
                try {
                    const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
                    if (!npcDB) return;
                    
                    const npcs = await npcDB.getAllNpcsForCurrentChat();
                    const allSelected = npcs.length > 0 && npcs.every(npc => this.selectedNpcIds.has(npc.id));
                    
                    if (allSelected) {
                        selectAllIcon.textContent = 'â˜‘';
                        selectAllBtn.innerHTML = '<span class="select-all-icon">â˜‘</span> å–æ¶ˆå…¨é€‰';
                    } else {
                        selectAllIcon.textContent = 'â˜';
                        selectAllBtn.innerHTML = '<span class="select-all-icon">â˜</span> å…¨é€‰';
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€å¤±è´¥:', error);
                }
            })();
        }
    }

    /**
     * æ˜¾ç¤ºToastæç¤º
     */
    showToast(message, type = 'info') {
        try {
            // å°è¯•ä½¿ç”¨SillyTavernçš„toastç³»ç»Ÿ
            if (window.toastr) {
                switch (type) {
                    case 'success':
                        window.toastr.success(message);
                        break;
                    case 'error':
                        window.toastr.error(message);
                        break;
                    case 'warning':
                        window.toastr.warning(message);
                        break;
                    default:
                        window.toastr.info(message);
                }
            } else {
                // é™çº§åˆ°consoleè¾“å‡º
                console.log(`[InfoBarSettings] ğŸ“¢ ${type.toUpperCase()}: ${message}`);
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºToastå¤±è´¥:', error);
            console.log(`[InfoBarSettings] ğŸ“¢ ${type.toUpperCase()}: ${message}`);
        }
    }

    /**
     * æ˜¾ç¤ºNPCè¯¦æƒ…ï¼ˆæ”¯æŒç¼–è¾‘æ¨¡å¼ï¼‰
     */
    async showNPCDetails(npcId) {
        try {
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                this.showNotification('NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°', 'error');
                return;
            }

            const npc = npcDB.db?.npcs?.[npcId];
            if (!npc) {
                this.showNotification('NPCæ•°æ®æœªæ‰¾åˆ°', 'error');
                return;
            }

            // ğŸ†• æ£€æŸ¥æ˜¯å¦ä¸ºAIæ¨¡å¼
            const isAIMode = this.modal.querySelector('.npc-mode-tab.active')?.dataset.mode === 'ai';

            // ä½¿ç”¨å¯ç¼–è¾‘çš„NPCè¯¦æƒ…ç•Œé¢ï¼ˆç±»ä¼¼æ–°å¢NPCï¼‰
            this.showEditableNPCDialog(npc, isAIMode);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºNPCè¯¦æƒ…å¤±è´¥:', error);
            this.showNotification('æ˜¾ç¤ºNPCè¯¦æƒ…å¤±è´¥', 'error');
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºå¯ç¼–è¾‘çš„NPCè¯¦æƒ…å¯¹è¯æ¡†
     */
    async showEditableNPCDialog(npc, isEditMode = true) {
        try {
            console.log('[InfoBarSettings] ğŸ“ æ˜¾ç¤ºNPCè¯¦æƒ…å¯¹è¯æ¡†ï¼ˆç¼–è¾‘æ¨¡å¼:' + isEditMode + 'ï¼‰');
            
            // æå–NPCå­—æ®µ
            const npcFields = {};
            if (npc.fields && npc.fields._åŸå§‹æ•°æ®) {
                Object.assign(npcFields, npc.fields._åŸå§‹æ•°æ®);
            }
            Object.entries(npc.fields || {}).forEach(([key, value]) => {
                if (!this.isTechnicalField(key) && !key.startsWith('_')) {
                    npcFields[key] = value;
                }
            });
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialogHTML = `
                <div class="regex-script-overlay" id="edit-npc-overlay" style="z-index: 20001;">
                    <div class="regex-script-modal" style="width: 700px; max-width: 95vw; height: auto; max-height: 90vh;">
                        <div class="regex-script-header">
                            <h3>${isEditMode ? 'âœï¸ ç¼–è¾‘NPC' : 'ğŸ‘ï¸ æŸ¥çœ‹NPC'} - ${this.escapeHtml(npc.name)}</h3>
                            <button class="regex-btn regex-btn-small" data-action="close-edit-npc">å…³é—­</button>
                        </div>
                        
                        <div class="regex-script-body">
                            <form id="edit-npc-form">
                                <!-- åŠ¨æ€å­—æ®µå®¹å™¨ -->
                                <div id="edit-npc-dynamic-fields">
                                    ${Object.entries(npcFields).map(([key, value], index) => `
                                        <div class="npc-field-item regex-form-group" data-field-id="${index}">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <label class="regex-form-label" style="flex: 1; margin: 0;">${this.escapeHtml(key)}</label>
                                                ${isEditMode ? `
                                                <button type="button" class="npc-field-delete-btn" style="
                                                    background: #f44336;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 4px;
                                                    padding: 4px 8px;
                                                    font-size: 12px;
                                                    cursor: pointer;
                                                " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                                                ` : ''}
                                            </div>
                                            <input type="text" class="regex-form-input npc-field-value" 
                                                   data-field-name="${this.escapeHtml(key)}" 
                                                   value="${this.escapeHtml(String(value))}"
                                                   ${!isEditMode ? 'readonly' : ''}>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                ${isEditMode ? `
                                <!-- æ·»åŠ æ–°å­—æ®µæŒ‰é’® -->
                                <div style="margin: 16px 0;">
                                    <button type="button" id="edit-npc-add-field-btn" class="regex-btn" style="width: 100%;">
                                        â• æ·»åŠ æ–°å­—æ®µ
                                    </button>
                                </div>
                                ` : ''}
                            </form>
                        </div>
                        
                        <div class="regex-script-footer" style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--theme-border-color, #333);">
                            <button type="button" class="regex-btn" data-action="cancel-edit-npc">å…³é—­</button>
                            ${isEditMode ? `
                            <button type="button" class="regex-btn regex-btn-primary" data-action="confirm-edit-npc">
                                ğŸ’¾ ä¿å­˜ä¿®æ”¹
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            const container = document.createElement('div');
            container.innerHTML = dialogHTML;
            document.body.appendChild(container.firstElementChild);
            
            const overlay = document.getElementById('edit-npc-overlay');
            const form = document.getElementById('edit-npc-form');
            
            // å…³é—­å¯¹è¯æ¡†
            const closeDialog = () => {
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            };
            
            // ç»‘å®šäº‹ä»¶
            overlay.querySelector('[data-action="close-edit-npc"]').addEventListener('click', closeDialog);
            overlay.querySelector('[data-action="cancel-edit-npc"]').addEventListener('click', closeDialog);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDialog();
                }
            });
            
            if (isEditMode) {
                // æ·»åŠ æ–°å­—æ®µæŒ‰é’®
                let fieldCounter = Object.keys(npcFields).length;
                const addFieldBtn = overlay.querySelector('#edit-npc-add-field-btn');
                if (addFieldBtn) {
                    addFieldBtn.addEventListener('click', () => {
                        fieldCounter++;
                        const fieldsContainer = overlay.querySelector('#edit-npc-dynamic-fields');
                        
                        const newField = document.createElement('div');
                        newField.className = 'npc-field-item regex-form-group';
                        newField.dataset.fieldId = fieldCounter;
                        newField.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="text" class="regex-form-input npc-field-label" placeholder="å­—æ®µåç§°" style="flex: 1;">
                                <button type="button" class="npc-field-delete-btn" style="
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    padding: 4px 8px;
                                    font-size: 12px;
                                    cursor: pointer;
                                " title="åˆ é™¤æ­¤å­—æ®µ">ğŸ—‘ï¸</button>
                            </div>
                            <input type="text" class="regex-form-input npc-field-value" placeholder="å­—æ®µå€¼">
                        `;
                        
                        fieldsContainer.appendChild(newField);
                        
                        // ç»‘å®šåˆ é™¤æŒ‰é’®
                        newField.querySelector('.npc-field-delete-btn').addEventListener('click', () => {
                            newField.remove();
                        });
                    });
                }
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®
                overlay.querySelectorAll('.npc-field-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fieldItem = e.target.closest('.npc-field-item');
                        if (fieldItem) {
                            fieldItem.remove();
                        }
                    });
                });
                
                // ä¿å­˜ä¿®æ”¹
                const confirmBtn = overlay.querySelector('[data-action="confirm-edit-npc"]');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', async () => {
                        try {
                            // æ”¶é›†æ‰€æœ‰å­—æ®µ
                            const updatedData = { name: npc.name };
                            const fieldItems = overlay.querySelectorAll('.npc-field-item');
                            
                            fieldItems.forEach(item => {
                                const labelInput = item.querySelector('.npc-field-label');
                                const valueInput = item.querySelector('.npc-field-value');
                                
                                let fieldName;
                                let fieldValue;
                                
                                if (labelInput) {
                                    fieldName = labelInput.value.trim();
                                    fieldValue = valueInput.value.trim();
                                } else {
                                    fieldName = valueInput.dataset.fieldName;
                                    fieldValue = valueInput.value.trim();
                                }
                                
                                if (fieldName && fieldValue) {
                                    updatedData[fieldName] = fieldValue;
                                }
                            });
                            
                            // æ›´æ–°NPCæ•°æ®
                            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
                            if (npcDB) {
                                await npcDB.addNPC(updatedData);
                                console.log('[InfoBarSettings] âœ… NPCæ›´æ–°æˆåŠŸ:', updatedData.name);
                                alert(`âœ… NPC "${updatedData.name}" æ›´æ–°æˆåŠŸï¼`);
                                
                                // åˆ·æ–°NPCåˆ—è¡¨
                                await this.refreshNPCList();
                                
                                closeDialog();
                            }

        } catch (error) {
                            console.error('[InfoBarSettings] âŒ æ›´æ–°NPCå¤±è´¥:', error);
                            alert(`æ›´æ–°NPCå¤±è´¥: ${error.message}`);
                        }
                    });
                }
            }
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºNPCè¯¦æƒ…å¯¹è¯æ¡†å¤±è´¥:', error);
            alert(`æ˜¾ç¤ºNPCè¯¦æƒ…å¯¹è¯æ¡†å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * åˆ›å»ºNPCè¯¦æƒ…HTMLï¼ˆå·²å¼ƒç”¨ï¼Œæ”¹ç”¨showEditableNPCDialogï¼‰
     */
    createNPCDetailHTML(npc) {
        // è·å–å‰§æƒ…ä¸–ç•Œæ—¶é—´ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        const lastSeenTime = this.getStoryWorldTime(npc.lastSeen) || 'æœªçŸ¥';

        // æå–NPCçš„å®é™…æ•°æ®å­—æ®µ
        const npcData = {};

        if (npc.fields && Object.keys(npc.fields).length > 0) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰_åŸå§‹æ•°æ®å­—æ®µï¼ˆè¿™æ˜¯ä¸»è¦çš„æ•°æ®æ¥æºï¼‰
            if (npc.fields._åŸå§‹æ•°æ® && typeof npc.fields._åŸå§‹æ•°æ® === 'object') {
                const rawData = npc.fields._åŸå§‹æ•°æ®;

                // å®šä¹‰æ•°å­—é”®å¯¹åº”çš„å­—æ®µåæ˜ å°„ï¼ˆåŸºäºäº¤äº’å¯¹è±¡é¢æ¿çš„ç»“æ„ï¼‰
                const fieldMapping = {
                    '1': 'å§“å',
                    '2': 'èŒä¸š/èº«ä»½',
                    '3': 'æ€§æ ¼/æ€åº¦',
                    '4': 'å…³ç³»',
                    '5': 'å¥½æ„Ÿåº¦',
                    '6': 'èƒŒæ™¯/æè¿°',
                    '7': 'çŠ¶æ€',
                    '8': 'å¤–è²Œç‰¹å¾',
                    '9': 'æœè£…/è£…å¤‡'
                };

                // æå–åŸå§‹æ•°æ®ä¸­çš„å­—æ®µ
                Object.entries(rawData).forEach(([key, value]) => {
                    const fieldName = fieldMapping[key] || `å­—æ®µ${key}`;
                    // ğŸ”§ ä¿®å¤ï¼šæ˜¾ç¤ºæ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬"æ— "å€¼çš„è‡ªå®šä¹‰å­—æ®µ
                    if (value && String(value).trim() !== '') {
                        npcData[fieldName] = String(value);
                    }
                });
            }

            // ç„¶åæ·»åŠ å…¶ä»–éæŠ€æœ¯æ€§å­—æ®µ
            Object.entries(npc.fields).forEach(([key, value]) => {
                if (!this.isTechnicalField(key) && !key.startsWith('_')) {
                    npcData[key] = String(value);
                }
            });
        }

        let dataHtml = '';
        if (Object.keys(npcData).length > 0) {
            dataHtml = Object.entries(npcData).map(([key, value]) => `
                <div class="npc-info-item">
                    <strong>${this.escapeHtml(key)}:</strong>
                    <span>${this.escapeHtml(String(value))}</span>
                </div>
            `).join('');
        } else {
            dataHtml = '<div class="npc-no-data">æš‚æ— è¯¦ç»†æ•°æ®</div>';
        }

        return `
            <div class="npc-detail-section">
                <h4>NPCä¿¡æ¯</h4>
                <div class="npc-basic-info">
                    <div class="npc-info-item">
                        <strong>å‡ºç°æ¬¡æ•°:</strong> ${npc.appearCount || 0}æ¬¡
                    </div>
                    <div class="npc-info-item">
                        <strong>æœ€åå‡ºç°:</strong> ${lastSeenTime}
                    </div>
                </div>
            </div>

            <div class="npc-detail-section">
                <h4>è¯¦ç»†èµ„æ–™</h4>
                <div class="npc-data-list">
                    ${dataHtml}
                </div>
            </div>
        `;
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæŠ€æœ¯æ€§å­—æ®µ
     */
    isTechnicalField(fieldName) {
        const technicalFields = ['id', 'createdAt', 'updatedAt', 'lastSeen', 'appearCount', 'chatId', 'timestamp'];
        return technicalFields.includes(fieldName) || fieldName.startsWith('_') || fieldName.includes('Id');
    }

    /**
     * è·å–å‰§æƒ…ä¸–ç•Œæ—¶é—´
     */
    getStoryWorldTime(timestamp) {
        if (!timestamp) return null;

        try {
            // å°è¯•è·å–SillyTavernçš„ä¸–ç•Œæ—¶é—´è®¾ç½®
            const context = SillyTavern?.getContext?.();
            if (context?.worldInfoSettings?.calendar) {
                // å¦‚æœæœ‰ä¸–ç•Œæ—¶é—´è®¾ç½®ï¼Œä½¿ç”¨ä¸–ç•Œæ—¶é—´æ ¼å¼
                // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„ä¸–ç•Œæ—¶é—´ç³»ç»Ÿè¿›è¡Œè½¬æ¢
                return 'å‰§æƒ…æ—¶é—´ï¼š' + new Date(timestamp).toLocaleDateString();
            }

            // å¦åˆ™ä½¿ç”¨ç›¸å¯¹æ—¶é—´æè¿°
            const now = Date.now();
            const diff = now - timestamp;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor(diff / (1000 * 60));

            if (days > 0) {
                return `${days}å¤©å‰`;
            } else if (hours > 0) {
                return `${hours}å°æ—¶å‰`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿå‰`;
            } else {
                return 'åˆšåˆš';
            }
        } catch (error) {
            console.warn('[InfoBarSettings] è·å–å‰§æƒ…ä¸–ç•Œæ—¶é—´å¤±è´¥:', error);
            return new Date(timestamp).toLocaleString();
        }
    }

    /**
     * HTMLè½¬ä¹‰
     */
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * ğŸ—‘ï¸ æ¸…ç†AIè®°å¿†æ•°æ®åº“ç´¢å¼•
     */
    async handleCleanupAIMemoryDatabase() {
        try {
            const confirmed = confirm(
                'âš ï¸ ç¡®è®¤æ¸…ç†AIè®°å¿†æ•°æ®åº“ç´¢å¼•ï¼Ÿ\n\n' +
                'æ­¤æ“ä½œå°†æ¸…ç©ºAIè®°å¿†æ•°æ®åº“çš„ç´¢å¼•æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\n' +
                'â€¢ å…³é”®è¯ç´¢å¼•\n' +
                'â€¢ é‡è¦æ€§ç´¢å¼•\n' +
                'â€¢ åˆ†ç±»ç´¢å¼•\n' +
                'â€¢ æ£€ç´¢ç¼“å­˜\n\n' +
                'æ³¨æ„ï¼šè¿™ä¸ä¼šåˆ é™¤åŸå§‹è®°å¿†æ•°æ®ï¼Œåªä¼šæ¸…ç©ºç´¢å¼•ã€‚\n' +
                'ä¸‹æ¬¡æœ‰æ–°è®°å¿†æ—¶ä¼šè‡ªåŠ¨é‡å»ºç´¢å¼•ã€‚\n\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'
            );

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†AIè®°å¿†æ•°æ®åº“ç´¢å¼•...');

            const infoBarTool = window.SillyTavernInfobar;
            const aiMemoryDatabase = infoBarTool?.modules?.aiMemoryDatabase;
            
            if (!aiMemoryDatabase) {
                throw new Error('AIè®°å¿†æ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ¸…ç©ºç´¢å¼•
            aiMemoryDatabase.clearIndex();
            console.log('[InfoBarSettings] âœ… AIè®°å¿†æ•°æ®åº“ç´¢å¼•å·²æ¸…ç©º');

            this.showNotification('âœ… AIè®°å¿†æ•°æ®åº“ç´¢å¼•å·²æˆåŠŸæ¸…ç©º', 'success');
            
            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            await this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†AIè®°å¿†æ•°æ®åº“ç´¢å¼•å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç†å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ æ¸…ç†å‘é‡åŒ–æ•°æ®
     */
    async handleCleanupVectorData() {
        try {
            const confirmed = confirm(
                'âš ï¸ ç¡®è®¤æ¸…ç†å‘é‡åŒ–æ•°æ®ï¼Ÿ\n\n' +
                'æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å‘é‡ç´¢å¼•å’ŒåµŒå…¥æ•°æ®ã€‚\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'
            );

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†å‘é‡åŒ–æ•°æ®...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool?.modules?.vectorizedMemoryRetrieval) {
                throw new Error('å‘é‡åŒ–è®°å¿†æ£€ç´¢æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ¸…ç©ºå‘é‡ç´¢å¼•
            const vectorModule = infoBarTool.modules.vectorizedMemoryRetrieval;
            if (vectorModule.vectorIndex) {
                vectorModule.vectorIndex.clear();
            }
            if (vectorModule.embeddingCache) {
                vectorModule.embeddingCache.clear();
            }

            // æ¸…ç©ºå­˜å‚¨
            const chatId = window.SillyTavern?.getContext?.()?.chatId;
            if (chatId && vectorModule.unifiedDataCore) {
                await vectorModule.unifiedDataCore.deleteData('vector_index', chatId);
                console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ•°æ®å·²æ¸…ç©º');
            }

            this.showNotification('âœ… å‘é‡åŒ–æ•°æ®å·²æˆåŠŸæ¸…ç©º', 'success');
            
            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            await this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†å‘é‡åŒ–æ•°æ®å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç†å‘é‡åŒ–æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®
     */
    async handleCleanupDeepMemory() {
        try {
            const confirmed = confirm(
                'âš ï¸ ç¡®è®¤æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®ï¼Ÿ\n\n' +
                'æ­¤æ“ä½œå°†æ¸…ç©ºå››å±‚è®°å¿†æ¶æ„ä¸­çš„æ‰€æœ‰æ•°æ®ï¼š\n' +
                'â€¢ æ„ŸçŸ¥è®°å¿†å±‚\n' +
                'â€¢ çŸ­æœŸè®°å¿†å±‚\n' +
                'â€¢ é•¿æœŸè®°å¿†å±‚\n' +
                'â€¢ æ·±åº¦å½’æ¡£å±‚\n\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'
            );

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool?.modules?.deepMemoryManager) {
                throw new Error('æ·±åº¦è®°å¿†ç®¡ç†å™¨æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ¸…ç©ºæ·±åº¦è®°å¿†å±‚
            const deepMemory = infoBarTool.modules.deepMemoryManager;
            if (deepMemory.memoryLayers) {
                deepMemory.memoryLayers.sensory.clear();
                deepMemory.memoryLayers.shortTerm.clear();
                deepMemory.memoryLayers.longTerm.clear();
                deepMemory.memoryLayers.deepArchive.clear();
            }

            // æ¸…ç©ºèŠå¤©çº§åˆ«è®°å¿†
            if (deepMemory.chatMemories) {
                deepMemory.chatMemories.clear();
            }

            // æ¸…ç©ºå­˜å‚¨
            const chatId = window.SillyTavern?.getContext?.()?.chatId;
            if (chatId && deepMemory.unifiedDataCore) {
                await deepMemory.unifiedDataCore.deleteData('deep_memory', chatId);
                console.log('[InfoBarSettings] âœ… æ·±åº¦è®°å¿†æ•°æ®å·²æ¸…ç©º');
            }

            this.showNotification('âœ… æ·±åº¦è®°å¿†æ•°æ®å·²æˆåŠŸæ¸…ç©º', 'success');
            
            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            await this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®
     */
    async handleCleanupKnowledgeGraph() {
        try {
            const confirmed = confirm(
                'âš ï¸ ç¡®è®¤æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®ï¼Ÿ\n\n' +
                'æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰çŸ¥è¯†å›¾è°±ä¸‰å…ƒç»„å’Œå…³ç³»æ•°æ®ã€‚\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'
            );

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool?.modules?.knowledgeGraphManager) {
                throw new Error('çŸ¥è¯†å›¾è°±ç®¡ç†å™¨æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ¸…ç©ºçŸ¥è¯†å›¾è°±
            const kgManager = infoBarTool.modules.knowledgeGraphManager;
            if (kgManager.graphs) {
                kgManager.graphs.clear();
            }

            // æ¸…ç©ºå­˜å‚¨
            const chatId = window.SillyTavern?.getContext?.()?.chatId;
            if (chatId && kgManager.unifiedDataCore) {
                await kgManager.unifiedDataCore.deleteData('knowledge_graph', chatId);
                console.log('[InfoBarSettings] âœ… çŸ¥è¯†å›¾è°±æ•°æ®å·²æ¸…ç©º');
            }

            this.showNotification('âœ… çŸ¥è¯†å›¾è°±æ•°æ®å·²æˆåŠŸæ¸…ç©º', 'success');
            
            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            await this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰
     */
    async handleCleanupAllMemoryData() {
        try {
            const confirmed = confirm(
                'ğŸ’¥ âš ï¸ å±é™©æ“ä½œè­¦å‘Š âš ï¸ ğŸ’¥\n\n' +
                'æ‚¨å³å°†æ¸…ç©ºæ‰€æœ‰è®°å¿†å¢å¼ºç›¸å…³æ•°æ®ï¼\n\n' +
                'åŒ…æ‹¬ï¼š\n' +
                'â€¢ AIè®°å¿†æ•°æ®åº“ï¼ˆæ‰€æœ‰å±‚çº§ï¼‰\n' +
                'â€¢ å‘é‡åŒ–ç´¢å¼•å’ŒåµŒå…¥\n' +
                'â€¢ æ·±åº¦è®°å¿†æ¶æ„æ•°æ®\n' +
                'â€¢ çŸ¥è¯†å›¾è°±å’Œå…³ç³»\n' +
                'â€¢ ç”¨æˆ·ç”»åƒæ•°æ®\n' +
                'â€¢ æ—¶é—´çº¿æ•°æ®\n\n' +
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\n' +
                'è¯·å†æ¬¡ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ'
            );

            if (!confirmed) return;

            // äºŒæ¬¡ç¡®è®¤
            const doubleConfirmed = confirm(
                'âš ï¸ æœ€åç¡®è®¤ âš ï¸\n\n' +
                'æ‚¨çœŸçš„è¦æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®å—ï¼Ÿ\n' +
                'è¿™å°†åˆ é™¤æ‰€æœ‰èŠå¤©ä¸­çš„è®°å¿†å¢å¼ºæ•°æ®ï¼\n\n' +
                'ç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"æ”¾å¼ƒæ“ä½œã€‚'
            );

            if (!doubleConfirmed) return;

            console.log('[InfoBarSettings] ğŸ’¥ å¼€å§‹æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool?.modules) {
                throw new Error('InfoBaræ¨¡å—æœªæ‰¾åˆ°');
            }

            const modules = infoBarTool.modules;
            let successCount = 0;
            let failCount = 0;

            // 1. æ¸…ç†AIMemoryDatabaseç´¢å¼•
            try {
                if (modules.aiMemoryDatabase) {
                    modules.aiMemoryDatabase.clearIndex();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… AIè®°å¿†æ•°æ®åº“ç´¢å¼•å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†AIè®°å¿†æ•°æ®åº“ç´¢å¼•å¤±è´¥:', error);
                failCount++;
            }

            // 2. æ¸…ç†å‘é‡åŒ–æ•°æ®
            try {
                if (modules.vectorizedMemoryRetrieval) {
                    const vm = modules.vectorizedMemoryRetrieval;
                    vm.vectorIndex?.clear();
                    vm.embeddingCache?.clear();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†å‘é‡åŒ–æ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            // 3. æ¸…ç†æ·±åº¦è®°å¿†
            try {
                if (modules.deepMemoryManager?.memoryLayers) {
                    const dm = modules.deepMemoryManager;
                    dm.memoryLayers.sensory.clear();
                    dm.memoryLayers.shortTerm.clear();
                    dm.memoryLayers.longTerm.clear();
                    dm.memoryLayers.deepArchive.clear();
                    dm.chatMemories?.clear();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… æ·±åº¦è®°å¿†æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†æ·±åº¦è®°å¿†æ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            // 4. æ¸…ç†çŸ¥è¯†å›¾è°±
            try {
                if (modules.knowledgeGraphManager?.graphs) {
                    modules.knowledgeGraphManager.graphs.clear();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… çŸ¥è¯†å›¾è°±æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†çŸ¥è¯†å›¾è°±æ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            // 5. æ¸…ç†ç”¨æˆ·ç”»åƒ
            try {
                if (modules.userProfileManager?.profiles) {
                    modules.userProfileManager.profiles.clear();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… ç”¨æˆ·ç”»åƒæ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†ç”¨æˆ·ç”»åƒæ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            // 6. æ¸…ç†æ—¶é—´çº¿
            try {
                if (modules.timeAwareMemoryManager?.timelines) {
                    modules.timeAwareMemoryManager.timelines.clear();
                    successCount++;
                    console.log('[InfoBarSettings] âœ… æ—¶é—´çº¿æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†æ—¶é—´çº¿æ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            // 7. æ¸…ç†UnifiedDataCoreä¸­çš„è®°å¿†æ•°æ®
            try {
                const chatId = window.SillyTavern?.getContext?.()?.chatId;
                if (chatId && modules.deepMemoryManager?.unifiedDataCore) {
                    const udc = modules.deepMemoryManager.unifiedDataCore;
                    await udc.deleteData('deep_memory', chatId);
                    await udc.deleteData('vector_index', chatId);
                    await udc.deleteData('knowledge_graph', chatId);
                    await udc.deleteData('user_profile', chatId);
                    await udc.deleteData('timeline', chatId);
                    successCount++;
                    console.log('[InfoBarSettings] âœ… UnifiedDataCoreè®°å¿†æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ¸…ç†UnifiedDataCoreæ•°æ®å¤±è´¥:', error);
                failCount++;
            }

            console.log(`[InfoBarSettings] ğŸ’¥ æ¸…ç†å®Œæˆ: æˆåŠŸ${successCount}é¡¹, å¤±è´¥${failCount}é¡¹`);

            if (failCount === 0) {
                this.showNotification(`âœ… æ‰€æœ‰è®°å¿†æ•°æ®å·²æˆåŠŸæ¸…ç©ºï¼ˆ${successCount}é¡¹ï¼‰`, 'success');
            } else {
                this.showNotification(`âš ï¸ éƒ¨åˆ†æ•°æ®æ¸…ç†å¤±è´¥ï¼ˆæˆåŠŸ${successCount}é¡¹ï¼Œå¤±è´¥${failCount}é¡¹ï¼‰`, 'warning');
            }

            // ğŸ”§ ä¿®å¤ï¼šç«‹å³åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
            await this.refreshMemoryStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®å¤±è´¥:', error);
            this.showNotification('âŒ æ¸…ç©ºæ‰€æœ‰è®°å¿†æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤é‡å¤çš„ showAPIRequestConfirmation() æ–¹æ³•
    // è¯·æ±‚ç¡®è®¤å·²ç”± CustomAPITaskQueue.showConfirmationDialog() ç»Ÿä¸€å¤„ç†
    // é¿å…å‡ºç°ä¸¤ä¸ªç¡®è®¤å¼¹çª—

    /**
     * ğŸ”® å¤„ç†å°è¯´æ–‡ä»¶ä¸Šä¼ 
     */
    async handleNovelFileUpload(file) {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¤„ç†æ–‡ä»¶ä¸Šä¼ :', file.name);

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.txt') && !file.name.endsWith('.md')) {
                this.showNotification('âŒ ä»…æ”¯æŒ .txt å’Œ .md æ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶20MBï¼‰
            if (file.size > 20 * 1024 * 1024) {
                this.showNotification('âŒ æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡20MB', 'error');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ–‡ä»¶ä¿¡æ¯:', {
                name: file.name,
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                type: file.type
            });

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½æ£€æµ‹æ–‡ä»¶ç¼–ç å¹¶è¯»å–
            const content = await this.readFileWithEncoding(file);

            if (!content || content.trim().length === 0) {
                this.showNotification('âŒ æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ— æ³•è¯»å–', 'error');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“– æ–‡ä»¶è¯»å–å®Œæˆï¼Œé•¿åº¦:', content.length);

            // å¤„ç†å‘é‡åŒ–
            await this.processNovelVectorization(file.name, content);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
            this.showNotification('âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ™ºèƒ½è¯»å–æ–‡ä»¶ï¼ˆæ”¯æŒå¤šç§ç¼–ç ï¼‰
     */
    async readFileWithEncoding(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    let content = e.target.result;

                    // ğŸ”§ æ£€æµ‹å¹¶ç§»é™¤UTF-8 BOM
                    if (content.charCodeAt(0) === 0xFEFF) {
                        content = content.substring(1);
                        console.log('[InfoBarSettings] ğŸ”§ æ£€æµ‹åˆ°UTF-8 BOMï¼Œå·²ç§»é™¤');
                    }

                    // ğŸ”§ æ£€æµ‹ä¹±ç ï¼ˆå¦‚æœåŒ…å«å¤§é‡æ›¿æ¢å­—ç¬¦ï¼Œå°è¯•å…¶ä»–ç¼–ç ï¼‰
                    const replacementCharCount = (content.match(/ï¿½/g) || []).length;
                    const replacementRatio = replacementCharCount / content.length;

                    if (replacementRatio > 0.01) {
                        console.warn('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„ç¼–ç é—®é¢˜ï¼Œæ›¿æ¢å­—ç¬¦æ¯”ä¾‹:', (replacementRatio * 100).toFixed(2) + '%');
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ä½¿ç”¨GBKç¼–ç é‡æ–°è¯»å–...');

                        // å°è¯•ä½¿ç”¨GBKç¼–ç 
                        const gbkContent = await this.readFileAsGBK(file);
                        if (gbkContent && (gbkContent.match(/ï¿½/g) || []).length < replacementCharCount) {
                            console.log('[InfoBarSettings] âœ… GBKç¼–ç è¯»å–æˆåŠŸ');
                            resolve(gbkContent);
                            return;
                        }
                    }

                    resolve(content);
                } catch (error) {
                    reject(error);
                }
            };

            reader.onerror = (error) => {
                console.error('[InfoBarSettings] âŒ æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
            };

            // é¦–å…ˆå°è¯•UTF-8ç¼–ç 
            reader.readAsText(file, 'UTF-8');
        });
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä½¿ç”¨GBKç¼–ç è¯»å–æ–‡ä»¶
     */
    async readFileAsGBK(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);

                    // ä½¿ç”¨TextDecoderå°è¯•GBKè§£ç 
                    try {
                        const decoder = new TextDecoder('gbk');
                        const content = decoder.decode(uint8Array);
                        resolve(content);
                    } catch (error) {
                        // GBKè§£ç å¤±è´¥ï¼Œå°è¯•GB2312
                        try {
                            const decoder = new TextDecoder('gb2312');
                            const content = decoder.decode(uint8Array);
                            resolve(content);
                        } catch (error2) {
                            console.warn('[InfoBarSettings] âš ï¸ GBK/GB2312è§£ç å¤±è´¥');
                            resolve(null);
                        }
                    }
                } catch (error) {
                    reject(error);
                }
            };

            reader.onerror = (error) => {
                reject(error);
            };

            reader.readAsArrayBuffer(file);
        });
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä¸­æ­¢å‘é‡åŒ–
     */
    abortVectorization() {
        console.log('[InfoBarSettings] ğŸ›‘ ç”¨æˆ·è¯·æ±‚ä¸­æ­¢å‘é‡åŒ–');
        this._vectorizationAborted = true;

        const progressText = this.modal.querySelector('#progress-text');
        const progressDetails = this.modal.querySelector('#progress-details');
        const progressBar = this.modal.querySelector('#progress-bar');

        if (progressText) progressText.textContent = 'ğŸ›‘ å·²ä¸­æ­¢';
        if (progressDetails) progressDetails.textContent = 'ç”¨æˆ·å·²ä¸­æ­¢å‘é‡åŒ–å¤„ç†';
        if (progressBar) {
            progressBar.style.background = 'linear-gradient(90deg, #FF9800, #FFC107)';
        }

        this.showNotification('ğŸ›‘ å‘é‡åŒ–å·²ä¸­æ­¢', 'warning');

        // å»¶è¿Ÿéšè—è¿›åº¦æ¡
        setTimeout(() => {
            const progressContainer = this.modal.querySelector('#upload-progress-container');
            if (progressContainer) progressContainer.style.display = 'none';
        }, 2000);
    }

    /**
     * ğŸ”® å¤„ç†å°è¯´å‘é‡åŒ–
     */
    async processNovelVectorization(fileName, content) {
        const progressContainer = this.modal.querySelector('#upload-progress-container');
        const progressBar = this.modal.querySelector('#progress-bar');
        const progressText = this.modal.querySelector('#progress-text');
        const progressPercentage = this.modal.querySelector('#progress-percentage');
        const progressDetails = this.modal.querySelector('#progress-details');

        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹å‘é‡åŒ–å¤„ç†...');

            // ğŸ”§ é‡ç½®ä¸­æ­¢æ ‡å¿—
            this._vectorizationAborted = false;

            // æ˜¾ç¤ºè¿›åº¦æ¡
            if (progressContainer) progressContainer.style.display = 'block';

            // æ›´æ–°è¿›åº¦
            const updateProgress = (percent, text, details) => {
                if (progressBar) progressBar.style.width = `${percent}%`;
                if (progressPercentage) progressPercentage.textContent = `${Math.round(percent)}%`;
                if (progressText) progressText.textContent = text;
                if (progressDetails) progressDetails.textContent = details;
            };

            updateProgress(5, 'ğŸ“– æ­£åœ¨è¯»å–æ–‡ä»¶...', `æ–‡ä»¶å¤§å°: ${(content.length / 1024).toFixed(2)} KB`);

            // ğŸ”§ ä¿®å¤ï¼šæå‰è·å–é…ç½®
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorCfg = extCfg.vectorFunction || {};

            // è·å–é…ç½®
            const batchSize = parseInt(this.modal.querySelector('#vector-batch-size')?.value || 10);

            // ğŸ”§ æ–°å¢ï¼šä½¿ç”¨NovelChunkAnalyzerè¿›è¡Œæ™ºèƒ½åˆ†æå’Œåˆ†å—
            updateProgress(10, 'ğŸ§  æ­£åœ¨åˆå§‹åŒ–æ™ºèƒ½åˆ†æå™¨...', 'å‡†å¤‡åˆ†æå°è¯´ç»“æ„');

            // åŠ¨æ€å¯¼å…¥NovelChunkAnalyzerï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
            const extensionPath = 'scripts/extensions/third-party/Information bar integration tool';
            const { NovelChunkAnalyzer } = await import(`/${extensionPath}/core/NovelChunkAnalyzer.js`);
            const chunkAnalyzer = new NovelChunkAnalyzer();

            // ğŸ”§ ä¿®å¤:ç­‰å¾…NovelChunkAnalyzeråˆå§‹åŒ–å®Œæˆ(åŒ…æ‹¬NovelAnalyzerçš„åŠ è½½)
            await chunkAnalyzer.ensureInitialized();

            // ç”Ÿæˆå°è¯´ID
            const novelId = `novel_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;

            const enableSmartAnalysis = vectorCfg.enableSmartAnalysis || false;

            // åˆ†æå¹¶åˆ†å—
            const chunks = await chunkAnalyzer.analyzeNovel(
                content,
                novelId,
                {
                    enableSmartAnalysis: enableSmartAnalysis,
                    extractPlotSummary: vectorCfg.extractPlotSummary,
                    analyzeWritingStyle: vectorCfg.analyzeWritingStyle,
                    extractTimeline: vectorCfg.extractTimeline,
                    markKeyScenes: vectorCfg.markKeyScenes,
                    extractCharacters: vectorCfg.extractCharacters
                },
                (progress, text, details) => {
                    updateProgress(10 + progress * 0.4, text, details);
                }
            );

            console.log('[InfoBarSettings] ğŸ“Š æ™ºèƒ½åˆ†æå®Œæˆï¼Œç”Ÿæˆ', chunks.length, 'ä¸ªå—');

            updateProgress(50, 'ğŸ”§ æ­£åœ¨åˆå§‹åŒ–å‘é‡åŒ–å¼•æ“...', `å…± ${chunks.length} ä¸ªå—éœ€è¦å¤„ç†`);

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰APIé¢æ¿çš„å‘é‡åŒ–APIé…ç½®
            const vectorAPIConfig = extCfg.vectorAPIConfig || {};

            // æ£€æŸ¥å‘é‡åŒ–APIé…ç½®
            if (!vectorAPIConfig.baseUrl || !vectorAPIConfig.apiKey) {
                throw new Error('è¯·å…ˆåœ¨"è‡ªå®šä¹‰API"é¢æ¿ä¸­é…ç½®å‘é‡åŒ–APIï¼ˆç‚¹å‡»"ğŸ§  å‘é‡åŒ–API"æŒ‰é’®ï¼‰');
            }

            // è·å–CustomVectorAPIAdapter
            const infoBarTool = window.SillyTavernInfobar;
            const vectorRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;

            if (!vectorRetrieval || !vectorRetrieval.customVectorAPI) {
                throw new Error('å‘é‡åŒ–æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ›´æ–°CustomVectorAPIAdapteré…ç½®
            vectorRetrieval.customVectorAPI.updateConfig({
                url: vectorAPIConfig.baseUrl,
                apiKey: vectorAPIConfig.apiKey,
                model: vectorAPIConfig.model || 'text-embedding-ada-002'
            });

            console.log('[InfoBarSettings] ğŸ”§ ä½¿ç”¨è‡ªå®šä¹‰APIé¢æ¿çš„å‘é‡åŒ–é…ç½®:', {
                url: vectorAPIConfig.baseUrl,
                model: vectorAPIConfig.model
            });

            // å‘é‡åŒ–æ¯ä¸ªå—ï¼ˆæ‰¹å¤„ç†ï¼‰
            const vectorizedChunks = [];
            const totalChunks = chunks.length;

            for (let i = 0; i < totalChunks; i++) {
                // ğŸ”§ æ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
                if (this._vectorizationAborted) {
                    console.log('[InfoBarSettings] ğŸ›‘ å‘é‡åŒ–å·²ä¸­æ­¢ï¼Œåœæ­¢å¤„ç†');
                    throw new Error('ç”¨æˆ·å·²ä¸­æ­¢å‘é‡åŒ–');
                }

                const chunk = chunks[i];
                const progress = 50 + (i / totalChunks) * 40; // 50% - 90%

                updateProgress(
                    progress,
                    `ğŸ”„ æ­£åœ¨å‘é‡åŒ–... (${i + 1}/${totalChunks})`,
                    `å½“å‰å—: ${chunk.text.substring(0, 50)}...`
                );

                try {
                    // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨customVectorAPIè¿›è¡Œå‘é‡åŒ–
                    const vector = await vectorRetrieval.customVectorAPI.vectorizeText(chunk.text);

                    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨NovelChunkAnalyzerç”Ÿæˆçš„å¯Œmetadata
                    vectorizedChunks.push({
                        id: `${novelId}_chunk_${i}`,
                        text: chunk.text,
                        vector: vector,
                        metadata: {
                            // ä¿ç•™åŸæœ‰çš„åŸºç¡€ä¿¡æ¯
                            fileName: fileName,
                            chunkIndex: i,
                            totalChunks: totalChunks,
                            timestamp: Date.now(),

                            // ğŸ”¥ æ·»åŠ NovelChunkAnalyzerç”Ÿæˆçš„æ™ºèƒ½metadata
                            ...chunk.metadata
                        }
                    });
                } catch (error) {
                    console.error(`[InfoBarSettings] âŒ å‘é‡åŒ–ç¬¬ ${i + 1} å—å¤±è´¥:`, error);
                    // ç»§ç»­å¤„ç†ä¸‹ä¸€å—ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                }

                // æ‰¹å¤„ç†å»¶è¿Ÿï¼Œé¿å…å†…å­˜é—®é¢˜
                if ((i + 1) % batchSize === 0 && i < totalChunks - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            // ğŸ”§ æœ€åæ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
            if (this._vectorizationAborted) {
                console.log('[InfoBarSettings] ğŸ›‘ å‘é‡åŒ–å·²ä¸­æ­¢ï¼Œåœæ­¢ä¿å­˜');
                throw new Error('ç”¨æˆ·å·²ä¸­æ­¢å‘é‡åŒ–');
            }

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½åˆ†æå·²ç»åœ¨NovelChunkAnalyzerä¸­å®Œæˆï¼Œè¿™é‡Œä¸å†éœ€è¦
            // ä¿ç•™analysisResultså˜é‡ä»¥å…¼å®¹åç»­ä»£ç 
            let analysisResults = null;

            updateProgress(95, 'ğŸ’¾ æ­£åœ¨ä¿å­˜è¯­æ–™åº“...', `å…± ${vectorizedChunks.length} ä¸ªå—å·²å‘é‡åŒ–`);

            // ä¿å­˜è¯­æ–™åº“ï¼ˆåŒ…å«åˆ†æç»“æœï¼‰
            await this.saveCorpus(fileName, vectorizedChunks, content.length, analysisResults);

            updateProgress(100, 'âœ… å‘é‡åŒ–å®Œæˆï¼', `æˆåŠŸå¤„ç† ${vectorizedChunks.length} ä¸ªå—`);

            // å»¶è¿Ÿéšè—è¿›åº¦æ¡
            setTimeout(() => {
                if (progressContainer) progressContainer.style.display = 'none';
            }, 2000);

            this.showNotification(`âœ… å‘é‡åŒ–å®Œæˆï¼å…±å¤„ç† ${vectorizedChunks.length} ä¸ªå—`, 'success');
            this.refreshCorpusList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å‘é‡åŒ–å¤„ç†å¤±è´¥:', error);

            // ğŸ”§ åŒºåˆ†ä¸­æ­¢å’Œé”™è¯¯
            if (error.message.includes('ä¸­æ­¢')) {
                // ä¸­æ­¢æƒ…å†µå·²åœ¨abortVectorization()ä¸­å¤„ç†
                return;
            }

            if (progressText) progressText.textContent = 'âŒ å¤„ç†å¤±è´¥';
            if (progressDetails) progressDetails.textContent = error.message;
            if (progressBar) {
                progressBar.style.background = 'linear-gradient(90deg, #f44336, #e91e63)';
            }

            this.showNotification('âŒ å‘é‡åŒ–å¤±è´¥: ' + error.message, 'error');

            // å»¶è¿Ÿéšè—è¿›åº¦æ¡
            setTimeout(() => {
                if (progressContainer) progressContainer.style.display = 'none';
            }, 3000);
        } finally {
            // ğŸ”§ æ¸…ç†ä¸­æ­¢æ ‡å¿—
            this._vectorizationAborted = false;
        }
    }

    /**
     * ğŸ”® åˆ†å‰²æ–‡æœ¬ä¸ºå—
     */
    splitTextIntoChunks(text, chunkSize, overlapSize) {
        const chunks = [];
        let startPos = 0;

        while (startPos < text.length) {
            const endPos = Math.min(startPos + chunkSize, text.length);
            const chunkText = text.substring(startPos, endPos);

            chunks.push({
                text: chunkText,
                startPos: startPos,
                endPos: endPos
            });

            startPos += chunkSize - overlapSize;
        }

        return chunks;
    }

    /**
     * ğŸ”® ä¿å­˜è¯­æ–™åº“
     * ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨SillyTavernåŸç”Ÿå‘é‡APIå­˜å‚¨ï¼Œé¿å…settings.jsonè¿‡å¤§
     */
    async saveCorpus(fileName, vectorizedChunks, fileSize = 0, analysisResults = null) {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};

            if (!extCfg.vectorCorpus) {
                extCfg.vectorCorpus = {};
            }

            // ğŸ”§ ä¿®å¤ï¼šç”Ÿæˆé›†åˆIDä½¿ç”¨ {cuerpo} æ ¼å¼ï¼Œä¸å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒå‘½åè§„åˆ™ä¸€è‡´
            // æ ¼å¼ï¼š{chatId}{cuerpo}
            const chatId = context?.chatId || 'default';
            const collectionId = `${chatId}{cuerpo}`;

            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹ä¿å­˜å‘é‡æ•°æ®åˆ°åç«¯API...');
            console.log('[InfoBarSettings] ğŸ“Š èŠå¤©ID:', chatId);
            console.log('[InfoBarSettings] ğŸ“Š é›†åˆID:', collectionId);
            console.log('[InfoBarSettings] ğŸ“Š å‘é‡å—æ•°:', vectorizedChunks.length);

            // ğŸ”§ å‡†å¤‡å‘é‡æ•°æ®
            const items = vectorizedChunks.map((chunk, index) => ({
                hash: this.generateHash(chunk.text + Date.now() + index),
                text: chunk.text,
                metadata: chunk.metadata || {}
            }));

            // ğŸ”§ å‡†å¤‡embeddings
            const embeddings = vectorizedChunks.reduce((acc, chunk) => {
                acc[chunk.text] = chunk.vector;
                return acc;
            }, {});

            // ğŸ”§ è°ƒç”¨SillyTavernåŸç”Ÿå‘é‡APIæ’å…¥æ•°æ®
            const insertPayload = {
                collectionId: collectionId,
                items: items,
                source: 'webllm',
                embeddings: embeddings
            };

            const response = await fetch('/api/vector/insert', {
                method: 'POST',
                headers: context.getRequestHeaders(),
                body: JSON.stringify(insertPayload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`å‘é‡APIæ’å…¥å¤±è´¥ (${response.status}): ${errorText}`);
            }

            console.log('[InfoBarSettings] âœ… å‘é‡æ•°æ®å·²ä¿å­˜åˆ°åç«¯API');

            // ğŸ”§ åªåœ¨settings.jsonä¸­ä¿å­˜å…ƒæ•°æ®ï¼ˆä¸åŒ…å«å‘é‡æ•°æ®ï¼‰
            extCfg.vectorCorpus[fileName] = {
                fileName: fileName,
                collectionId: collectionId,  // ä¿å­˜é›†åˆIDç”¨äºåç»­æŸ¥è¯¢å’Œåˆ é™¤
                createdAt: Date.now(),
                chunkCount: vectorizedChunks.length,
                fileSize: fileSize,
                // ğŸ”§ æ–°å¢ï¼šä¿å­˜æ™ºèƒ½åˆ†æç»“æœ
                analysis: analysisResults || null
            };

            context.saveSettingsDebounced();
            console.log('[InfoBarSettings] ğŸ’¾ è¯­æ–™åº“å…ƒæ•°æ®å·²ä¿å­˜:', fileName);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è¯­æ–™åº“å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç”Ÿæˆå“ˆå¸Œå€¼
     */
    generateHash(text) {
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
            const char = text.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return Math.abs(hash).toString(36);
    }

    /**
     * ğŸ”® åˆ·æ–°è¯­æ–™åº“åˆ—è¡¨
     */
    refreshCorpusList() {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const corpusData = extCfg.vectorCorpus || {};

            const corpusList = this.modal.querySelector('#corpus-list');
            const corpusCount = this.modal.querySelector('#corpus-count');

            if (!corpusList || !corpusCount) return;

            const corpusArray = Object.values(corpusData);
            corpusCount.textContent = corpusArray.length;

            if (corpusArray.length === 0) {
                corpusList.innerHTML = `
                    <div class="no-corpus" style="
                        text-align: center;
                        padding: 40px 20px;
                        color: var(--theme-text-secondary, #888);
                    ">
                        æš‚æ— è¯­æ–™åº“ï¼Œè¯·ä¸Šä¼ å°è¯´æ–‡ä»¶
                    </div>
                `;
                return;
            }

            corpusList.innerHTML = corpusArray.map(corpus => `
                <div class="corpus-item" style="
                    border: 1px solid var(--theme-border-color, #333);
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 10px;
                    background: var(--theme-bg-primary, #111);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--theme-text-primary, #ddd); margin-bottom: 5px;">
                                ğŸ“š ${corpus.fileName}
                            </div>
                            <div style="font-size: 12px; color: var(--theme-text-secondary, #888);">
                                å—æ•°: ${corpus.chunkCount} | åˆ›å»ºæ—¶é—´: ${new Date(corpus.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="view-corpus-btn" data-filename="${corpus.fileName}" style="
                                padding: 6px 12px;
                                border: 1px solid #2196F3;
                                border-radius: 4px;
                                background: transparent;
                                color: #2196F3;
                                cursor: pointer;
                                transition: all 0.3s;
                            " title="æŸ¥çœ‹å‘é‡åŒ–æ•°æ®">
                                ğŸ‘ï¸ æŸ¥çœ‹
                            </button>
                            <button class="delete-corpus-btn" data-filename="${corpus.fileName}" style="
                                padding: 6px 12px;
                                border: 1px solid #f44336;
                                border-radius: 4px;
                                background: transparent;
                                color: #f44336;
                                cursor: pointer;
                                transition: all 0.3s;
                            " title="åˆ é™¤è¯­æ–™åº“">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // ç»‘å®šæŸ¥çœ‹æŒ‰é’®äº‹ä»¶
            corpusList.querySelectorAll('.view-corpus-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileName = e.target.dataset.filename;
                    this.viewCorpusDetails(fileName);
                });
            });

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            corpusList.querySelectorAll('.delete-corpus-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileName = e.target.dataset.filename;
                    this.deleteCorpus(fileName);
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°è¯­æ–™åº“åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”® æŸ¥çœ‹è¯­æ–™åº“è¯¦æƒ…
     * ğŸ”§ ä¿®å¤ï¼šä»åç«¯APIè·å–å‘é‡æ•°æ®
     */
    async viewCorpusDetails(fileName) {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const corpus = extCfg.vectorCorpus?.[fileName];

            if (!corpus) {
                this.showNotification('âŒ æœªæ‰¾åˆ°è¯­æ–™åº“æ•°æ®', 'error');
                return;
            }

            // ğŸ”§ ç§»åŠ¨ç«¯é€‚é…ï¼šæ£€æµ‹è®¾å¤‡ç±»å‹
            const isMobile = window.innerWidth <= 768;
            console.log(`[InfoBarSettings] ğŸ“± æ£€æµ‹åˆ°è®¾å¤‡ç±»å‹: ${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}, å±å¹•å®½åº¦: ${window.innerWidth}px`);

            // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'corpus-details-modal';
            
            // ğŸ”§ ç§»åŠ¨ç«¯é€‚é…ï¼šä½¿ç”¨å…¨å±é®ç½©æ–¹å¼
            if (isMobile) {
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.5);
                    backdrop-filter: blur(4px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 0;
                `;
            } else {
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
            }

            const content = document.createElement('div');
            // ğŸ”§ ç§»åŠ¨ç«¯é€‚é…ï¼šæ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
            if (isMobile) {
                content.style.cssText = `
                    background: var(--theme-bg-primary, #111);
                    border: 1px solid var(--theme-border-color, #333);
                    border-radius: 12px;
                    padding: 16px;
                    width: 90vw;
                    max-width: 90vw;
                    max-height: 85vh;
                    overflow-y: auto;
                    color: var(--theme-text-primary, #ddd);
                    box-sizing: border-box;
                    margin: auto;
                `;
            } else {
                content.style.cssText = `
                    background: var(--theme-bg-primary, #111);
                    border: 1px solid var(--theme-border-color, #333);
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    color: var(--theme-text-primary, #ddd);
                `;
            }

            // ğŸ”§ åˆ é™¤ï¼šä¸å†æ˜¾ç¤ºæ•°æ®å—å†…å®¹éƒ¨åˆ†ï¼Œç®€åŒ–ç•Œé¢

            // ğŸ”§ ä¿®å¤ï¼šè·å–å‘é‡åŒ–æ¨¡å‹ä¿¡æ¯
            const vectorAPIConfig = extCfg.vectorAPIConfig || {};
            const modelName = vectorAPIConfig.model || 'æœªçŸ¥';
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¿®æ”¹å­˜å‚¨ä½ç½®æ–‡å­—æ˜¾ç¤º
            const storageLocation = corpus.collectionId ? '\\data\\default-user\\vectors\\webllm' : 'æœ¬åœ°å­˜å‚¨';
            const collectionId = corpus.collectionId || 'æ— ';

            // ğŸ”§ ç§»åŠ¨ç«¯é€‚é…ï¼šæ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´HTMLå¸ƒå±€ï¼Œåˆ é™¤æ•°æ®å—å†…å®¹éƒ¨åˆ†
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${isMobile ? '12px' : '20px'}; ${isMobile ? 'flex-wrap: wrap; gap: 8px;' : ''}">
                    <h3 style="margin: 0; color: #4CAF50; ${isMobile ? 'font-size: 16px; flex: 1 1 100%;' : ''}">ğŸ“š ${fileName}</h3>
                    <button id="close-corpus-details" style="
                        padding: ${isMobile ? '10px 16px' : '6px 12px'};
                        border: 1px solid var(--theme-border-color, #333);
                        border-radius: 4px;
                        background: var(--theme-bg-secondary, #1a1a1a);
                        color: var(--theme-text-primary, #ddd);
                        cursor: pointer;
                        font-size: ${isMobile ? '14px' : '13px'};
                        ${isMobile ? 'width: 100%; min-height: 44px; -webkit-tap-highlight-color: transparent;' : ''}
                    ">âœ– å…³é—­</button>
                </div>

                <div style="padding: ${isMobile ? '12px' : '12px'}; background: var(--theme-bg-secondary, #1a1a1a); border-radius: 6px;">
                    <div style="margin-bottom: 10px; font-size: ${isMobile ? '13px' : '14px'};">
                        <strong>ğŸ“Š æ€»å—æ•°:</strong> ${corpus.chunkCount || corpus.chunks?.length || 0}
                    </div>
                    <div style="margin-bottom: 10px; font-size: ${isMobile ? '13px' : '14px'};">
                        <strong>â° åˆ›å»ºæ—¶é—´:</strong> ${new Date(corpus.createdAt).toLocaleString()}
                    </div>
                    <div style="margin-bottom: 10px; font-size: ${isMobile ? '13px' : '14px'};">
                        <strong>ğŸ“¦ æ–‡ä»¶å¤§å°:</strong> ${corpus.fileSize ? (corpus.fileSize / 1024).toFixed(2) + ' KB' : 'æœªçŸ¥'}
                    </div>
                    <div style="margin-bottom: 10px; font-size: ${isMobile ? '13px' : '14px'};">
                        <strong>ğŸ¤– å‘é‡åŒ–æ¨¡å‹:</strong> ${modelName}
                    </div>
                    <div style="margin-bottom: 10px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'word-break: break-all;' : ''}">
                        <strong>ğŸ’¾ å­˜å‚¨ä½ç½®:</strong> ${storageLocation}
                    </div>
                    <div style="margin-bottom: 0; font-size: ${isMobile ? '11px' : '11px'}; color: var(--theme-text-secondary, #888); ${isMobile ? 'word-break: break-all;' : ''}">
                        <strong>ğŸ”‘ é›†åˆID:</strong> ${collectionId}
                    </div>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const closeBtn = content.querySelector('#close-corpus-details');
            const closeModal = () => {
                modal.remove();
            };
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æŸ¥çœ‹è¯­æ–™åº“è¯¦æƒ…å¤±è´¥:', error);
            this.showNotification('âŒ æŸ¥çœ‹å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”® åˆ é™¤è¯­æ–™åº“
     * ğŸ”§ ä¿®å¤ï¼šåŒæ—¶æ¸…ç†åç«¯å‘é‡æ•°æ®
     */
    async deleteCorpus(fileName) {
        try {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¯­æ–™åº“ "${fileName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤æ‰€æœ‰å‘é‡æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};

            if (extCfg.vectorCorpus && extCfg.vectorCorpus[fileName]) {
                const corpus = extCfg.vectorCorpus[fileName];
                const collectionId = corpus.collectionId;

                // ğŸ”§ å¦‚æœæœ‰collectionIdï¼Œæ¸…ç†åç«¯å‘é‡æ•°æ®
                if (collectionId) {
                    console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†åç«¯å‘é‡æ•°æ®...');
                    console.log('[InfoBarSettings] ğŸ“Š é›†åˆID:', collectionId);

                    try {
                        const purgePayload = {
                            collectionId: collectionId
                        };

                        const response = await fetch('/api/vector/purge', {
                            method: 'POST',
                            headers: context.getRequestHeaders(),
                            body: JSON.stringify(purgePayload)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†å‘é‡æ•°æ®å¤±è´¥:', errorText);
                            // ç»§ç»­åˆ é™¤å…ƒæ•°æ®ï¼Œå³ä½¿æ¸…ç†å¤±è´¥
                        } else {
                            console.log('[InfoBarSettings] âœ… åç«¯å‘é‡æ•°æ®å·²æ¸…ç†');
                        }
                    } catch (purgeError) {
                        console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†å‘é‡æ•°æ®æ—¶å‡ºé”™:', purgeError);
                        // ç»§ç»­åˆ é™¤å…ƒæ•°æ®
                    }
                }

                // ğŸ”§ åˆ é™¤å…ƒæ•°æ®
                delete extCfg.vectorCorpus[fileName];
                context.saveSettingsDebounced();

                this.showNotification(`âœ… å·²åˆ é™¤è¯­æ–™åº“: ${fileName}`, 'success');
                this.refreshCorpusList();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤è¯­æ–™åº“å¤±è´¥:', error);
            this.showNotification('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”® æ”¶é›†å‘é‡åŠŸèƒ½è®¾ç½®
     */
    collectVectorFunctionSettings() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿æ‰€æœ‰é…ç½®éƒ½è¢«æ­£ç¡®æ”¶é›†
            const settings = {
                // åˆ†å—é…ç½®
                chunkSize: parseInt(this.modal.querySelector('#vector-chunk-size')?.value || 500),
                overlapSize: parseInt(this.modal.querySelector('#vector-overlap-size')?.value || 50),
                batchSize: parseInt(this.modal.querySelector('#vector-batch-size')?.value || 10),

                // æ™ºèƒ½åˆ†æé…ç½®
                enableSmartAnalysis: this.modal.querySelector('#enable-smart-analysis')?.checked || false,
                extractPlotSummary: this.modal.querySelector('#extract-plot-summary')?.checked || false,
                analyzeWritingStyle: this.modal.querySelector('#analyze-writing-style')?.checked || false,
                extractTimeline: this.modal.querySelector('#extract-timeline')?.checked || false,
                markKeyScenes: this.modal.querySelector('#mark-key-scenes')?.checked || false,
                extractCharacters: this.modal.querySelector('#extract-characters')?.checked || false,

                // AIæ£€ç´¢é…ç½®
                enableAIRetrieval: this.modal.querySelector('#enable-ai-retrieval')?.checked || false,
                enableMultiRecall: this.modal.querySelector('#enable-multi-recall')?.checked || false, // ğŸ†• å¤šè·¯å¬å›
                enableCorpusRetrieval: this.modal.querySelector('#enable-corpus-retrieval')?.checked !== false,
                enableMemoryRetrieval: this.modal.querySelector('#enable-memory-retrieval')?.checked !== false,
                enableSummaryRetrieval: this.modal.querySelector('#enable-summary-retrieval')?.checked !== false,
                retrievalTopK: parseInt(this.modal.querySelector('#retrieval-top-k')?.value || 10),
                retrievalThreshold: parseFloat(this.modal.querySelector('#retrieval-threshold')?.value || 0.5),
                rerankThreshold: parseInt(this.modal.querySelector('#rerank-threshold')?.value || 10), // ğŸ†• é‡æ’åºé˜ˆå€¼
                retrievalCacheTimeout: parseInt(this.modal.querySelector('#retrieval-cache-timeout')?.value || 5000),
                retrievalInjectionPosition: this.modal.querySelector('#retrieval-injection-position')?.value || 'system',
                retrievalInjectionDepth: parseInt(this.modal.querySelector('#retrieval-injection-depth')?.value || 0),
                retrievalInjectionPriority: parseInt(this.modal.querySelector('#retrieval-injection-priority')?.value || 0)
            };

            console.log('[InfoBarSettings] ğŸ“¦ æ”¶é›†çš„å‘é‡åŠŸèƒ½è®¾ç½®:', settings);
            return settings;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‘é‡åŠŸèƒ½è®¾ç½®å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”® æ”¶é›†å‘é‡åŒ–æ€»ç»“è®¾ç½®
     */
    collectVectorizedSummarySettings() {
        try {
            // ğŸ”§ æ–°å¢ï¼šæ”¶é›†æ¨¡å¼åˆ‡æ¢çŠ¶æ€
            const summaryModeTab = this.modal?.querySelector('.summary-mode-tab.active');
            const summaryMode = summaryModeTab?.dataset?.mode || 'traditional';

            return {
                mode: summaryMode, // ğŸ”§ æ–°å¢ï¼šä¿å­˜æ¨¡å¼çŠ¶æ€
                enabled: this.modal.querySelector('#vectorized-summary-enabled')?.checked || false,
                floorCount: parseInt(this.modal.querySelector('#vectorized-summary-floor-count')?.value || 20),
                autoHideEnabled: this.modal.querySelector('#vectorized-auto-hide-enabled')?.checked || false,
                keepRecentCount: parseInt(this.modal.querySelector('#vectorized-keep-recent-count')?.value || 10)
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‘é‡åŒ–æ€»ç»“è®¾ç½®å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ†• æ£€æŸ¥AIè®°å¿†æ€»ç»“çŠ¶æ€
     */
    checkAIMemorySummaryStatus() {
        try {
            const statusDiv = this.modal.querySelector('#ai-memory-status');
            if (!statusDiv) return;

            const infobar = window.SillyTavernInfobar;
            // ğŸ”§ ä¿®å¤ï¼šaiMemorySummarizerç›´æ¥åœ¨modulesä¸‹ï¼Œä¸åœ¨summaryManagerä¸‹
            const aiMemorySummarizer = infobar?.modules?.aiMemorySummarizer;

            if (!aiMemorySummarizer) {
                statusDiv.innerHTML = `
                    <span style="color: var(--theme-error-color, #f44336);">âŒ AIè®°å¿†æ€»ç»“æ¨¡å—æœªåˆå§‹åŒ–</span>
                `;
                return;
            }

            const enabled = aiMemorySummarizer.settings?.enabled || false;
            const messageLevelEnabled = aiMemorySummarizer.settings?.messageLevelSummary || false;

            console.log('[InfoBarSettings] ğŸ” AIè®°å¿†æ€»ç»“çŠ¶æ€æ£€æŸ¥:', { enabled, messageLevelEnabled });

            if (enabled && messageLevelEnabled) {
                statusDiv.innerHTML = `
                    <span style="color: var(--theme-success-color, #4CAF50);">âœ… AIè®°å¿†æ€»ç»“å·²å¯ç”¨ï¼ˆæ¶ˆæ¯çº§åˆ«æ€»ç»“å·²å¯ç”¨ï¼‰</span>
                `;
            } else if (enabled && !messageLevelEnabled) {
                statusDiv.innerHTML = `
                    <span style="color: var(--theme-warning-color, #ff9800);">âš ï¸ AIè®°å¿†æ€»ç»“å·²å¯ç”¨ï¼Œä½†æœªå¯ç”¨æ¶ˆæ¯çº§åˆ«æ€»ç»“</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <span style="color: var(--theme-error-color, #f44336);">âŒ AIè®°å¿†æ€»ç»“æœªå¯ç”¨</span>
                `;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ£€æŸ¥AIè®°å¿†æ€»ç»“çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åŠ è½½å‘é‡åŒ–æ€»ç»“æ•°æ®
     */
    async loadVectorizedSummaryData() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½å‘é‡åŒ–æ€»ç»“æ•°æ®...');

            // åŠ è½½AIè®°å¿†æ€»ç»“è®°å½•
            await this.loadAIMemorySummaryList();

            // åŠ è½½å·²å‘é‡åŒ–æ€»ç»“è®°å½•
            await this.loadVectorizedSummaryList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å‘é‡åŒ–æ€»ç»“æ•°æ®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åŠ è½½AIè®°å¿†æ€»ç»“åˆ—è¡¨
     */
    async loadAIMemorySummaryList() {
        try {
            const listDiv = this.modal.querySelector('#ai-memory-summary-list');
            if (!listDiv) return;

            // ğŸ”§ ä»å½“å‰èŠå¤©çš„æ•°æ®æ ¸å¿ƒè·å–AIè®°å¿†æ€»ç»“è®°å½•
            const context = SillyTavern.getContext();
            const chatId = context?.chatId;

            if (!chatId) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©
                    </div>
                `;
                return;
            }

            // ğŸ”§ ä»æ‰©å±•è®¾ç½®ä¸­è·å–å½“å‰èŠå¤©çš„AIè®°å¿†æ€»ç»“è®°å½•
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorizedSummarySettings = extCfg.vectorizedSummary || {};
            const chatSummaries = vectorizedSummarySettings[chatId] || {};
            const aiMemorySummaries = chatSummaries.pendingSummaries || [];

            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½AIè®°å¿†æ€»ç»“åˆ—è¡¨:', { chatId, count: aiMemorySummaries.length });

            if (aiMemorySummaries.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                        æš‚æ— AIè®°å¿†æ€»ç»“è®°å½•<br>
                        <small style="color: var(--theme-text-tertiary, #666);">AIç”Ÿæˆæ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºè®°å¿†æ€»ç»“</small>
                    </div>
                `;
                return;
            }

            let html = '';
            aiMemorySummaries.forEach((summary, index) => {
                const content = summary.summary?.content || summary.content || 'æ— å†…å®¹';
                const timestamp = summary.timestamp || Date.now();
                const importance = summary.summary?.importance || summary.importance || 0;
                const floorNumber = summary.floorNumber || summary.summary?.floorNumber || 0;

                html += `
                    <div class="ai-memory-summary-item" style="padding: 10px; margin-bottom: 10px; background: var(--theme-bg-tertiary, #1a1a1a); border: 1px solid var(--theme-border-color, #333); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 500; color: var(--theme-primary-color, #4CAF50);">æ€»ç»“ #${index + 1}${floorNumber > 0 ? ` (æ¥¼å±‚${floorNumber})` : ''}</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 12px; color: var(--theme-text-secondary, #888);">${new Date(timestamp).toLocaleString()}</span>
                                <button class="delete-ai-memory-summary-btn" data-index="${index}" data-floor="${floorNumber}" style="
                                    padding: 4px 8px;
                                    background: var(--theme-error-color, #f44336);
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    transition: opacity 0.2s;
                                " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--theme-text-primary, #e0e0e0); line-height: 1.5; margin-bottom: 5px;">
                            ${content.substring(0, 100)}${content.length > 100 ? '...' : ''}
                        </div>
                        <div style="font-size: 11px; color: var(--theme-text-tertiary, #666);">
                            é‡è¦æ€§: ${(importance * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;

            // ğŸ”§ æ–°å¢ï¼šç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            listDiv.querySelectorAll('.delete-ai-memory-summary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const floorNumber = parseInt(e.target.dataset.floor);
                    this.deleteAIMemorySummary(index, floorNumber);
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½AIè®°å¿†æ€»ç»“åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• åŠ è½½å·²å‘é‡åŒ–æ€»ç»“åˆ—è¡¨
     */
    async loadVectorizedSummaryList() {
        try {
            const listDiv = this.modal.querySelector('#vectorized-summary-list');
            if (!listDiv) return;

            // ğŸ”§ ä»å½“å‰èŠå¤©çš„æ•°æ®æ ¸å¿ƒè·å–å·²å‘é‡åŒ–æ€»ç»“è®°å½•
            const context = SillyTavern.getContext();
            const chatId = context?.chatId;

            if (!chatId) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©
                    </div>
                `;
                return;
            }

            // ğŸ”§ ä»æ‰©å±•è®¾ç½®ä¸­è·å–å½“å‰èŠå¤©çš„å·²å‘é‡åŒ–æ€»ç»“è®°å½•
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorizedSummarySettings = extCfg.vectorizedSummary || {};
            const chatSummaries = vectorizedSummarySettings[chatId] || {};
            const vectorizedSummaries = chatSummaries.vectorizedRecords || [];

            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½å·²å‘é‡åŒ–æ€»ç»“åˆ—è¡¨:', { chatId, count: vectorizedSummaries.length });

            if (vectorizedSummaries.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #888);">
                        æš‚æ— å‘é‡åŒ–æ€»ç»“è®°å½•<br>
                        <small style="color: var(--theme-text-tertiary, #666);">è¾¾åˆ°æ€»ç»“æ¥¼å±‚åä¼šè‡ªåŠ¨å‘é‡åŒ–</small>
                    </div>
                `;
                return;
            }

            let html = '';
            vectorizedSummaries.forEach((summary, index) => {
                const startFloor = summary.startFloor || 0;
                const endFloor = summary.endFloor || 0;
                const timestamp = summary.timestamp || Date.now();
                const vectorCount = summary.vectorCount || 0;
                const collectionId = summary.collectionId || 'æœªçŸ¥';

                html += `
                    <div class="vectorized-summary-item" style="padding: 10px; margin-bottom: 10px; background: var(--theme-bg-tertiary, #1a1a1a); border: 1px solid var(--theme-border-color, #333); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 500; color: var(--theme-primary-color, #4CAF50);">æ¥¼å±‚ ${startFloor}-${endFloor}</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 12px; color: var(--theme-text-secondary, #888);">${new Date(timestamp).toLocaleString()}</span>
                                <button class="delete-vectorized-summary-btn" data-index="${index}" data-collection-id="${collectionId}" style="
                                    padding: 4px 8px;
                                    background: var(--theme-error-color, #f44336);
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    transition: opacity 0.2s;
                                " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--theme-text-secondary, #aaa);">
                            å‘é‡æ•°é‡: ${vectorCount} | é›†åˆID: ${collectionId.substring(0, 20)}...
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;

            // ğŸ”§ æ–°å¢ï¼šç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            listDiv.querySelectorAll('.delete-vectorized-summary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const collectionId = e.target.dataset.collectionId;
                    this.deleteVectorizedSummary(index, collectionId);
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å·²å‘é‡åŒ–æ€»ç»“åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”® ä¿å­˜å‘é‡åŠŸèƒ½è®¾ç½®ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ä¸»ä¿å­˜æŒ‰é’®ï¼‰
     * @deprecated ä½¿ç”¨ä¸»ä¿å­˜æŒ‰é’®ä»£æ›¿
     */
    async saveVectorFunctionSettings() {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};

            extCfg.vectorFunction = this.collectVectorFunctionSettings();

            context.saveSettingsDebounced();
            this.showNotification('âœ… æ‰€æœ‰é…ç½®å·²ä¿å­˜', 'success');

            console.log('[InfoBarSettings] ğŸ’¾ å‘é‡åŠŸèƒ½è®¾ç½®å·²ä¿å­˜:', extCfg.vectorFunction);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜å‘é‡åŠŸèƒ½è®¾ç½®å¤±è´¥:', error);
            this.showNotification('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ é™¤AIè®°å¿†æ€»ç»“
     */
    async deleteAIMemorySummary(index, floorNumber) {
        try {
            const confirmed = confirm(`ç¡®è®¤åˆ é™¤æ€»ç»“ #${index + 1}${floorNumber > 0 ? ` (æ¥¼å±‚ ${floorNumber})` : ''}ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\nâ€¢ å‘é‡åŒ–æ€»ç»“ä¸­çš„å¾…å¤„ç†è®°å½•\nâ€¢ AIè®°å¿†æ•°æ®åº“ä¸­çš„ç›¸å…³è®°å¿†\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤AIè®°å¿†æ€»ç»“:', { index, floorNumber });

            const context = SillyTavern.getContext();
            const chatId = context?.chatId;
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorizedSummarySettings = extCfg.vectorizedSummary || {};
            const chatSummaries = vectorizedSummarySettings[chatId] || {};
            const aiMemorySummaries = chatSummaries.pendingSummaries || [];

            // 1. ä»å¾…å‘é‡åŒ–åˆ—è¡¨ä¸­åˆ é™¤
            if (index >= 0 && index < aiMemorySummaries.length) {
                aiMemorySummaries.splice(index, 1);
                chatSummaries.pendingSummaries = aiMemorySummaries;
                vectorizedSummarySettings[chatId] = chatSummaries;
                extCfg.vectorizedSummary = vectorizedSummarySettings;

                context.saveSettingsDebounced();
                console.log('[InfoBarSettings] âœ… å·²ä»å¾…å‘é‡åŒ–åˆ—è¡¨ä¸­åˆ é™¤');
            }

            // 2. ä»AIè®°å¿†æ•°æ®åº“ä¸­åˆ é™¤ï¼ˆå¦‚æœæœ‰æ¥¼å±‚å·ï¼‰
            if (floorNumber > 0) {
                const infobar = window.SillyTavernInfobar;
                const aiMemoryDatabase = infobar?.modules?.aiMemoryDatabase;

                if (aiMemoryDatabase && aiMemoryDatabase.database) {
                    // åˆ é™¤è¯¥æ¥¼å±‚çš„æ‰€æœ‰è®°å¿†
                    const memoriesToDelete = [];
                    for (const [memoryId, memory] of aiMemoryDatabase.database.memories) {
                        if (memory.floorNumber === floorNumber) {
                            memoriesToDelete.push(memoryId);
                        }
                    }

                    memoriesToDelete.forEach(id => {
                        aiMemoryDatabase.database.memories.delete(id);
                    });

                    if (memoriesToDelete.length > 0) {
                        console.log(`[InfoBarSettings] âœ… å·²ä»AIè®°å¿†æ•°æ®åº“åˆ é™¤ ${memoriesToDelete.length} æ¡è®°å¿†`);
                    }
                }
            }

            // 3. åˆ·æ–°UI
            await this.loadAIMemorySummaryList();
            this.showNotification('âœ… AIè®°å¿†æ€»ç»“å·²åˆ é™¤', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤AIè®°å¿†æ€»ç»“å¤±è´¥:', error);
            this.showNotification('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ é™¤å·²å‘é‡åŒ–æ€»ç»“
     */
    async deleteVectorizedSummary(index, collectionId) {
        try {
            const confirmed = confirm(`ç¡®è®¤åˆ é™¤å·²å‘é‡åŒ–æ€»ç»“è®°å½•ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\nâ€¢ å‘é‡åŒ–æ€»ç»“è®°å½•\nâ€¢ åç«¯å‘é‡æ•°æ®ï¼ˆé›†åˆID: ${collectionId.substring(0, 20)}...ï¼‰\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);

            if (!confirmed) return;

            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å·²å‘é‡åŒ–æ€»ç»“:', { index, collectionId });

            const context = SillyTavern.getContext();
            const chatId = context?.chatId;
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorizedSummarySettings = extCfg.vectorizedSummary || {};
            const chatSummaries = vectorizedSummarySettings[chatId] || {};
            const vectorizedSummaries = chatSummaries.vectorizedRecords || [];

            // 1. ä»å·²å‘é‡åŒ–åˆ—è¡¨ä¸­åˆ é™¤
            if (index >= 0 && index < vectorizedSummaries.length) {
                vectorizedSummaries.splice(index, 1);
                chatSummaries.vectorizedRecords = vectorizedSummaries;
                vectorizedSummarySettings[chatId] = chatSummaries;
                extCfg.vectorizedSummary = vectorizedSummarySettings;

                context.saveSettingsDebounced();
                console.log('[InfoBarSettings] âœ… å·²ä»å·²å‘é‡åŒ–åˆ—è¡¨ä¸­åˆ é™¤');
            }

            // 2. åˆ é™¤åç«¯å‘é‡æ•°æ®
            if (collectionId && collectionId !== 'æœªçŸ¥') {
                try {
                    const purgePayload = {
                        collectionId: collectionId
                    };

                    const response = await fetch('/api/vector/purge', {
                        method: 'POST',
                        headers: context.getRequestHeaders(),
                        body: JSON.stringify(purgePayload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†å‘é‡æ•°æ®å¤±è´¥:', errorText);
                    } else {
                        console.log('[InfoBarSettings] âœ… åç«¯å‘é‡æ•°æ®å·²æ¸…ç†');
                    }
                } catch (purgeError) {
                    console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†å‘é‡æ•°æ®æ—¶å‡ºé”™:', purgeError);
                }
            }

            // 3. åˆ·æ–°UI
            await this.loadVectorizedSummaryList();
            this.showNotification('âœ… å·²å‘é‡åŒ–æ€»ç»“å·²åˆ é™¤', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤å·²å‘é‡åŒ–æ€»ç»“å¤±è´¥:', error);
            this.showNotification('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• å¤„ç†æ‰‹åŠ¨å‘é‡åŒ–
     */
    async handleManualVectorize() {
        try {
            console.log('[InfoBarSettings] ğŸ”® å¼€å§‹æ‰‹åŠ¨å‘é‡åŒ–...');

            // è·å–VectorizedSummaryManageræ¨¡å—
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedSummaryManager = infoBarTool?.modules?.vectorizedSummaryManager;

            if (!vectorizedSummaryManager) {
                this.showNotification('âŒ å‘é‡åŒ–æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘é‡åŒ–çš„æ€»ç»“
            if (!vectorizedSummaryManager.pendingSummaries || vectorizedSummaryManager.pendingSummaries.length === 0) {
                this.showNotification('â„¹ï¸ æš‚æ— å¾…å‘é‡åŒ–çš„AIè®°å¿†æ€»ç»“', 'info');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            this.showVectorizeProgress(true);
            this.updateVectorizeProgress(0, 'å‡†å¤‡å‘é‡åŒ–...');

            // è°ƒç”¨å‘é‡åŒ–æ–¹æ³•
            await vectorizedSummaryManager.vectorizeSummaries((progress, message) => {
                this.updateVectorizeProgress(progress, message);
            });

            // éšè—è¿›åº¦æ¡
            this.showVectorizeProgress(false);

            // åˆ·æ–°UI
            await this.loadAIMemorySummaryList();
            await this.loadVectorizedSummaryList();

            this.showNotification('âœ… å‘é‡åŒ–å®Œæˆ', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰‹åŠ¨å‘é‡åŒ–å¤±è´¥:', error);
            this.showVectorizeProgress(false);
            this.showNotification('âŒ å‘é‡åŒ–å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤º/éšè—å‘é‡åŒ–è¿›åº¦æ¡
     */
    showVectorizeProgress(show) {
        const progressContainer = this.modal.querySelector('#vectorize-progress-container');
        if (progressContainer) {
            progressContainer.style.display = show ? 'block' : 'none';
        }

        // ç¦ç”¨/å¯ç”¨æ‰‹åŠ¨å‘é‡åŒ–æŒ‰é’®
        const manualVectorizeBtn = this.modal.querySelector('#manual-vectorize-btn');
        if (manualVectorizeBtn) {
            manualVectorizeBtn.disabled = show;
            manualVectorizeBtn.style.opacity = show ? '0.5' : '1';
            manualVectorizeBtn.style.cursor = show ? 'not-allowed' : 'pointer';
        }
    }

    /**
     * ğŸ†• æ›´æ–°å‘é‡åŒ–è¿›åº¦
     */
    updateVectorizeProgress(progress, message) {
        const progressBar = this.modal.querySelector('#vectorize-progress-bar');
        const progressText = this.modal.querySelector('#vectorize-progress-text');
        const progressDetail = this.modal.querySelector('#vectorize-progress-detail');

        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }

        if (progressText) {
            progressText.textContent = `æ­£åœ¨å‘é‡åŒ–... ${Math.round(progress)}%`;
        }

        if (progressDetail) {
            progressDetail.textContent = message || '';
        }
    }

    /**
     * ğŸ“ åˆå§‹åŒ–å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ
     */
    initVectorFileManagement() {
        try {
            console.log('[InfoBarSettings] ğŸ“ åˆå§‹åŒ–å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ...');

            // åˆå§‹åŒ–å½“å‰çŠ¶æ€
            this.currentFileType = 'corpus'; // å½“å‰é€‰ä¸­çš„æ–‡ä»¶ç±»å‹
            this.currentScopeMode = 'local'; // å½“å‰ä½œç”¨åŸŸæ¨¡å¼ï¼ˆlocal/globalï¼‰

            // ç»‘å®šæ–‡ä»¶ç±»å‹æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            const fileTabs = this.modal.querySelectorAll('.vector-file-tab');
            fileTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const fileType = e.target.dataset.fileType;
                    this.switchFileType(fileType);
                });
            });

            // ç»‘å®šä½œç”¨åŸŸåˆ‡æ¢æŒ‰é’®äº‹ä»¶
            const toggleScopeBtn = this.modal.querySelector('#toggle-scope-btn');
            if (toggleScopeBtn) {
                toggleScopeBtn.addEventListener('click', () => {
                    this.toggleScopeMode();
                });
            }

            // åŠ è½½æ–‡ä»¶åˆ—è¡¨
            this.loadVectorFileList();

            console.log('[InfoBarSettings] âœ… å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒåˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–å‘é‡åŒ–æ–‡ä»¶ç®¡ç†ä¸­å¿ƒå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ“ åˆ‡æ¢æ–‡ä»¶ç±»å‹
     */
    switchFileType(fileType) {
        try {
            console.log('[InfoBarSettings] ğŸ“ åˆ‡æ¢æ–‡ä»¶ç±»å‹:', fileType);

            this.currentFileType = fileType;

            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            const fileTabs = this.modal.querySelectorAll('.vector-file-tab');
            fileTabs.forEach(tab => {
                if (tab.dataset.fileType === fileType) {
                    tab.classList.add('active');
                    tab.style.background = 'var(--theme-primary-color, #4CAF50)';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'var(--theme-bg-secondary, #2a2a2a)';
                    tab.style.color = 'var(--theme-text-primary, #ddd)';
                }
            });

            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            this.loadVectorFileList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ–‡ä»¶ç±»å‹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”„ åˆ‡æ¢ä½œç”¨åŸŸæ¨¡å¼
     */
    toggleScopeMode() {
        try {
            // åˆ‡æ¢æ¨¡å¼
            this.currentScopeMode = this.currentScopeMode === 'local' ? 'global' : 'local';

            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢ä½œç”¨åŸŸæ¨¡å¼:', this.currentScopeMode);

            // æ›´æ–°UIæ˜¾ç¤º
            const scopeModeText = this.modal.querySelector('#current-scope-mode');
            const toggleBtn = this.modal.querySelector('#toggle-scope-btn');

            if (scopeModeText) {
                scopeModeText.textContent = this.currentScopeMode === 'local' ? 'å±€éƒ¨æ¨¡å¼' : 'å…¨å±€æ¨¡å¼';
                scopeModeText.style.color = this.currentScopeMode === 'local' ? 'var(--theme-primary-color, #4CAF50)' : 'var(--theme-warning-color, #FFA726)';
            }

            if (toggleBtn) {
                toggleBtn.textContent = this.currentScopeMode === 'local' ? 'ğŸ”„ åˆ‡æ¢ä¸ºå…¨å±€æ¨¡å¼' : 'ğŸ”„ åˆ‡æ¢ä¸ºå±€éƒ¨æ¨¡å¼';
            }

            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            this.loadVectorFileList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢ä½œç”¨åŸŸæ¨¡å¼å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ“ åŠ è½½å‘é‡åŒ–æ–‡ä»¶åˆ—è¡¨
     */
    async loadVectorFileList() {
        try {
            console.log('[InfoBarSettings] ğŸ“ åŠ è½½å‘é‡åŒ–æ–‡ä»¶åˆ—è¡¨...', {
                fileType: this.currentFileType,
                scopeMode: this.currentScopeMode
            });

            const listContainer = this.modal.querySelector('#vector-file-list-container');
            if (!listContainer) return;

            const context = SillyTavern.getContext();
            const chatId = context?.chatId || 'default';
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};

            // æ ¹æ®æ–‡ä»¶ç±»å‹è·å–å¯¹åº”çš„æ•°æ®
            let files = [];

            switch (this.currentFileType) {
                case 'corpus':
                    files = this.getCorpusFiles(extCfg, chatId);
                    break;
                case 'summary':
                    files = this.getSummaryFiles(extCfg, chatId);
                    break;
                case 'memory':
                    files = this.getMemoryFiles(extCfg, chatId);
                    break;
            }

            // æ ¹æ®ä½œç”¨åŸŸæ¨¡å¼è¿‡æ»¤æ–‡ä»¶
            if (this.currentScopeMode === 'local') {
                // å±€éƒ¨æ¨¡å¼ï¼šåªæ˜¾ç¤ºå±äºå½“å‰èŠå¤©çš„æ–‡ä»¶
                files = files.filter(file => file.belongsToCurrentChat || file.scope === 'global');
            }
            // å…¨å±€æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆä¸è¿‡æ»¤ï¼‰

            console.log('[InfoBarSettings] ğŸ“ æ–‡ä»¶åˆ—è¡¨åŠ è½½å®Œæˆ:', {
                totalFiles: files.length,
                fileType: this.currentFileType,
                scopeMode: this.currentScopeMode
            });

            // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
            this.renderVectorFileList(files, listContainer);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å‘é‡åŒ–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ ‡å‡†åŒ–chatIdç”¨äºåŒ¹é…
     * chatIdæ ¼å¼ï¼š
     *   æ–°æ ¼å¼ï¼š{èŠå¤©åç§°} - {åˆ›å»ºæ—¥æœŸ}@{å¯¹è¯æ€»æ—¶é•¿}  ä¾‹å¦‚ï¼š1123 - 2025-10-24@23h19m56s
     *   æ—§æ ¼å¼ï¼š{èŠå¤©åç§°}_-_{åˆ›å»ºæ—¥æœŸ}_{å¯¹è¯æ€»æ—¶é•¿}  ä¾‹å¦‚ï¼š1123_-_2025-10-24_07h23m22s
     * æˆ‘ä»¬åªåŒ¹é…èŠå¤©åç§°å’Œåˆ›å»ºæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é•¿
     */
    normalizeChatIdForMatching(chatId) {
        if (!chatId) return '';

        // ç§»é™¤@åé¢çš„æ—¶é•¿éƒ¨åˆ†ï¼ˆæ–°æ ¼å¼ï¼‰
        let normalized = chatId.split('@')[0];

        // å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œç»Ÿä¸€æ ¼å¼
        normalized = normalized.replace(/\s/g, '_');

        // ç§»é™¤æ—¶é•¿éƒ¨åˆ†ï¼ˆæ—§æ ¼å¼ï¼‰
        // åŒ¹é…æ¨¡å¼ï¼š_XXhXXmXXs æˆ– _XXhXXm æˆ– _XXh
        normalized = normalized.replace(/_\d+h\d+m\d+s$/, '');
        normalized = normalized.replace(/_\d+h\d+m$/, '');
        normalized = normalized.replace(/_\d+h$/, '');

        return normalized;
    }

    /**
     * ğŸ“š è·å–è¯­æ–™åº“æ–‡ä»¶åˆ—è¡¨
     */
    getCorpusFiles(extCfg, currentChatId) {
        const corpusData = extCfg.vectorCorpus || {};
        const files = [];

        // ğŸ”§ æ ‡å‡†åŒ–å½“å‰chatIdï¼Œç”¨äºåŒ¹é…ï¼ˆåªä¿ç•™èŠå¤©åç§°å’Œåˆ›å»ºæ—¥æœŸï¼‰
        const normalizedCurrentChatId = this.normalizeChatIdForMatching(currentChatId);

        for (const [fileName, corpus] of Object.entries(corpusData)) {
            // ğŸ”§ ä¿®å¤ï¼šä»collectionIdä¸­æå–chatId
            // æ–°æ ¼å¼ï¼š{chatId}{cuerpo}
            // æ—§æ ¼å¼ï¼š{chatId}/{modelName} (å…¼å®¹)
            const collectionId = corpus.collectionId || '';
            let chatIdFromCollection = '';
            let isGlobal = false;

            if (collectionId.includes('{cuerpo}')) {
                // æ–°æ ¼å¼ï¼š{chatId}{cuerpo}
                chatIdFromCollection = collectionId.replace('{cuerpo}', '');
                isGlobal = collectionId.startsWith('global{cuerpo}');
            } else if (collectionId.includes('/')) {
                // æ—§æ ¼å¼ï¼š{chatId}/{modelName}ï¼ˆå…¼å®¹ï¼‰
                chatIdFromCollection = collectionId.split('/')[0] || '';
                isGlobal = collectionId.startsWith('global/');
            } else {
                // æœªçŸ¥æ ¼å¼ï¼Œä½¿ç”¨åŸå€¼
                chatIdFromCollection = collectionId;
            }

            // ğŸ”§ æ ‡å‡†åŒ–æ–‡ä»¶çš„chatIdï¼Œç”¨äºåŒ¹é…ï¼ˆåªä¿ç•™èŠå¤©åç§°å’Œåˆ›å»ºæ—¥æœŸï¼‰
            const normalizedFileChatId = this.normalizeChatIdForMatching(chatIdFromCollection);

            // åˆ¤æ–­æ˜¯å¦å±äºå½“å‰èŠå¤©
            // ä½¿ç”¨æ ‡å‡†åŒ–åçš„chatIdè¿›è¡Œæ¯”è¾ƒ
            const belongsToCurrentChat = isGlobal || normalizedFileChatId === normalizedCurrentChatId;

            files.push({
                id: `${chatIdFromCollection}{cuerpo}`,
                name: fileName,
                type: 'corpus',
                chatId: chatIdFromCollection,
                scope: isGlobal ? 'global' : (corpus.scope || 'local'),
                collectionId: collectionId,
                chunkCount: corpus.chunkCount || 0,
                fileSize: corpus.fileSize || 0,
                createdAt: corpus.createdAt || Date.now(),
                belongsToCurrentChat: belongsToCurrentChat,
                metadata: corpus
            });
        }

        return files;
    }

    /**
     * ğŸ“ è·å–æ€»ç»“æ–‡ä»¶åˆ—è¡¨
     */
    getSummaryFiles(extCfg, currentChatId) {
        const vectorizedSummary = extCfg.vectorizedSummary || {};
        const files = [];

        // ğŸ”§ æ ‡å‡†åŒ–å½“å‰chatIdï¼Œç”¨äºåŒ¹é…ï¼ˆåªä¿ç•™èŠå¤©åç§°å’Œåˆ›å»ºæ—¥æœŸï¼‰
        const normalizedCurrentChatId = this.normalizeChatIdForMatching(currentChatId);

        for (const [chatId, chatData] of Object.entries(vectorizedSummary)) {
            // è·³è¿‡settingså­—æ®µ
            if (chatId === 'settings') continue;

            const vectorizedRecords = chatData.vectorizedRecords || [];

            // ğŸ”§ æ ‡å‡†åŒ–æ–‡ä»¶çš„chatIdï¼Œç”¨äºåŒ¹é…ï¼ˆåªä¿ç•™èŠå¤©åç§°å’Œåˆ›å»ºæ—¥æœŸï¼‰
            const normalizedFileChatId = this.normalizeChatIdForMatching(chatId);

            // åˆ¤æ–­æ˜¯å¦å±äºå½“å‰èŠå¤©
            const belongsToCurrentChat = normalizedFileChatId === normalizedCurrentChatId;

            vectorizedRecords.forEach((record, index) => {
                files.push({
                    id: `${chatId}{summary}_${index}`,
                    name: `æ€»ç»“ #${index + 1} (æ¥¼å±‚ ${record.startFloor}-${record.endFloor})`,
                    type: 'summary',
                    chatId: chatId,
                    scope: record.scope || 'local',
                    collectionId: record.collectionId || '',
                    vectorCount: record.vectorCount || 0,
                    startFloor: record.startFloor || 0,
                    endFloor: record.endFloor || 0,
                    createdAt: record.timestamp || Date.now(),
                    belongsToCurrentChat: belongsToCurrentChat,
                    recordIndex: index,
                    metadata: record
                });
            });
        }

        return files;
    }

    /**
     * ğŸ§  è·å–è®°å¿†æ–‡ä»¶åˆ—è¡¨
     */
    getMemoryFiles(extCfg, currentChatId) {
        // TODO: å®ç°è®°å¿†æ–‡ä»¶è·å–é€»è¾‘
        // è¿™éœ€è¦ä» DeepMemoryManager æˆ– VectorizedMemoryRetrieval è·å–æ•°æ®
        const files = [];

        // æš‚æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œåç»­å®ç°
        console.log('[InfoBarSettings] âš ï¸ è®°å¿†æ–‡ä»¶åˆ—è¡¨åŠŸèƒ½å¾…å®ç°');

        return files;
    }

    /**
     * ğŸ“ æ¸²æŸ“å‘é‡åŒ–æ–‡ä»¶åˆ—è¡¨
     */
    renderVectorFileList(files, container) {
        if (!container) return;

        if (files.length === 0) {
            const typeText = this.currentFileType === 'corpus' ? 'è¯­æ–™åº“' :
                           this.currentFileType === 'summary' ? 'æ€»ç»“' : 'è®°å¿†';
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--theme-text-secondary, #888);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‚</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">æš‚æ— å‘é‡åŒ–æ–‡ä»¶</div>
                    <div style="font-size: 13px;">å½“å‰ä½œç”¨åŸŸä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»ä½•${typeText}æ–‡ä»¶</div>
                </div>
            `;
            return;
        }

        let html = `
            <div style="margin-bottom: 15px; padding: 10px; background: var(--theme-bg-secondary, #2a2a2a); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: var(--theme-text-primary, #ddd);">
                    å…±æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶
                </div>
                <div style="font-size: 12px; color: var(--theme-text-secondary, #888);">
                    ${this.currentScopeMode === 'local' ? 'ä»…æ˜¾ç¤ºå½“å‰èŠå¤©' : 'æ˜¾ç¤ºæ‰€æœ‰èŠå¤©'}
                </div>
            </div>
        `;

        files.forEach(file => {
            const scopeColor = file.scope === 'global' ? '#FFA726' : '#4CAF50';
            const scopeText = file.scope === 'global' ? 'å…¨å±€' : 'å±€éƒ¨';
            const typeIcon = file.type === 'corpus' ? 'ğŸ“š' : file.type === 'summary' ? 'ğŸ“' : 'ğŸ§ ';

            html += `
                <div class="vector-file-item" data-file-id="${file.id}" style="
                    padding: 12px;
                    margin-bottom: 10px;
                    background: var(--theme-bg-secondary, #2a2a2a);
                    border: 1px solid var(--theme-border-color, #333);
                    border-radius: 6px;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 20px;">${typeIcon}</span>
                                <span style="font-weight: 600; color: var(--theme-text-primary, #ddd); font-size: 14px;">${file.name}</span>
                                <span style="
                                    padding: 2px 8px;
                                    background: ${scopeColor};
                                    color: white;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                ">${scopeText}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--theme-text-secondary, #888); margin-bottom: 4px;">
                                ${file.type === 'corpus' ? `ğŸ“¦ ${file.chunkCount} ä¸ªå— | ğŸ’¾ ${(file.fileSize / 1024).toFixed(2)} KB` : ''}
                                ${file.type === 'summary' ? `ğŸ”¢ ${file.vectorCount} ä¸ªå‘é‡ | ğŸ“Š æ¥¼å±‚ ${file.startFloor}-${file.endFloor}` : ''}
                            </div>
                            <div style="font-size: 11px; color: var(--theme-text-tertiary, #666);">
                                ğŸ†” ${file.id} | ğŸ“… ${new Date(file.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button class="toggle-file-scope-btn" data-file-id="${file.id}" style="
                                padding: 6px 12px;
                                background: ${file.scope === 'global' ? 'var(--theme-primary-color, #4CAF50)' : 'var(--theme-warning-color, #FFA726)'};
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: 600;
                                transition: all 0.2s;
                            " title="${file.scope === 'global' ? 'åˆ‡æ¢ä¸ºå±€éƒ¨' : 'åˆ‡æ¢ä¸ºå…¨å±€'}">
                                ${file.scope === 'global' ? 'ğŸ”’ è®¾ä¸ºå±€éƒ¨' : 'ğŸŒ è®¾ä¸ºå…¨å±€'}
                            </button>
                            <button class="delete-vector-file-btn" data-file-id="${file.id}" style="
                                padding: 6px 12px;
                                background: var(--theme-error-color, #f44336);
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                                transition: all 0.2s;
                            " title="åˆ é™¤æ–‡ä»¶">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // ç»‘å®šäº‹ä»¶
        container.querySelectorAll('.toggle-file-scope-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileId = e.target.dataset.fileId;
                this.toggleFileScope(fileId);
            });
        });

        container.querySelectorAll('.delete-vector-file-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileId = e.target.dataset.fileId;
                this.deleteVectorFile(fileId);
            });
        });
    }

    /**
     * ğŸ”„ åˆ‡æ¢æ–‡ä»¶ä½œç”¨åŸŸ
     */
    async toggleFileScope(fileId) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢æ–‡ä»¶ä½œç”¨åŸŸ:', fileId);

            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};

            // è§£æfileIdè·å–chatIdå’Œç±»å‹
            const parts = fileId.split('{');
            const chatId = parts[0];
            const typeWithIndex = parts[1].replace('}', '');
            const [type, indexStr] = typeWithIndex.split('_');

            // ğŸ”§ æ ‡å‡†åŒ–chatIdç”¨äºåŒ¹é…
            const normalizedChatId = this.normalizeChatIdForMatching(chatId);

            // æ ¹æ®ç±»å‹æ›´æ–°å¯¹åº”çš„é…ç½®
            if (type === 'cuerpo') {
                // è¯­æ–™åº“æ–‡ä»¶
                const corpusData = extCfg.vectorCorpus || {};
                for (const [fileName, corpus] of Object.entries(corpusData)) {
                    if (corpus.collectionId) {
                        // ä»collectionIdä¸­æå–chatIdå¹¶æ ‡å‡†åŒ–
                        let collectionChatId = '';
                        if (corpus.collectionId.includes('{cuerpo}')) {
                            collectionChatId = corpus.collectionId.replace('{cuerpo}', '');
                        } else if (corpus.collectionId.includes('/')) {
                            collectionChatId = corpus.collectionId.split('/')[0];
                        }

                        const normalizedCollectionChatId = this.normalizeChatIdForMatching(collectionChatId);

                        if (normalizedCollectionChatId === normalizedChatId) {
                            corpus.scope = corpus.scope === 'global' ? 'local' : 'global';
                            console.log(`[InfoBarSettings] âœ… å·²åˆ‡æ¢è¯­æ–™åº“ "${fileName}" çš„ä½œç”¨åŸŸä¸º: ${corpus.scope}`);
                            break;
                        }
                    }
                }
            } else if (type === 'summary') {
                // æ€»ç»“æ–‡ä»¶
                const vectorizedSummary = extCfg.vectorizedSummary || {};

                // ğŸ”§ æŸ¥æ‰¾åŒ¹é…çš„chatIdï¼ˆä½¿ç”¨æ ‡å‡†åŒ–åŒ¹é…ï¼‰
                let matchedChatId = null;
                for (const storedChatId of Object.keys(vectorizedSummary)) {
                    if (storedChatId === 'settings') continue;
                    const normalizedStoredChatId = this.normalizeChatIdForMatching(storedChatId);
                    if (normalizedStoredChatId === normalizedChatId) {
                        matchedChatId = storedChatId;
                        break;
                    }
                }

                if (matchedChatId) {
                    const chatData = vectorizedSummary[matchedChatId] || {};
                    const vectorizedRecords = chatData.vectorizedRecords || [];

                    const recordIndex = parseInt(indexStr);
                    if (!isNaN(recordIndex) && vectorizedRecords[recordIndex]) {
                        vectorizedRecords[recordIndex].scope = vectorizedRecords[recordIndex].scope === 'global' ? 'local' : 'global';
                        console.log(`[InfoBarSettings] âœ… å·²åˆ‡æ¢æ€»ç»“ #${recordIndex + 1} çš„ä½œç”¨åŸŸä¸º: ${vectorizedRecords[recordIndex].scope}`);
                    }
                }
            }

            // ä¿å­˜é…ç½®
            context.saveSettingsDebounced();

            // åˆ·æ–°åˆ—è¡¨
            await this.loadVectorFileList();

            this.showNotification('âœ… ä½œç”¨åŸŸå·²åˆ‡æ¢', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ–‡ä»¶ä½œç”¨åŸŸå¤±è´¥:', error);
            this.showNotification('âŒ åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ åˆ é™¤å‘é‡åŒ–æ–‡ä»¶
     */
    async deleteVectorFile(fileId) {
        try {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ­¤å‘é‡åŒ–æ–‡ä»¶å—ï¼Ÿ\n\næ–‡ä»¶ID: ${fileId}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å‘é‡åŒ–æ–‡ä»¶:', fileId);

            // è§£æfileIdè·å–chatIdå’Œç±»å‹
            const parts = fileId.split('{');
            const chatId = parts[0];
            const typeWithIndex = parts[1].replace('}', '');
            const [type, indexStr] = typeWithIndex.split('_');

            // æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”çš„åˆ é™¤æ–¹æ³•
            if (type === 'cuerpo') {
                // åˆ é™¤è¯­æ–™åº“æ–‡ä»¶
                await this.deleteCorpusFileByCollectionId(chatId);
            } else if (type === 'summary') {
                // åˆ é™¤æ€»ç»“æ–‡ä»¶
                const recordIndex = parseInt(indexStr);
                await this.deleteSummaryFileByIndex(chatId, recordIndex);
            }

            // åˆ·æ–°åˆ—è¡¨
            await this.loadVectorFileList();

            this.showNotification('âœ… æ–‡ä»¶å·²åˆ é™¤', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤å‘é‡åŒ–æ–‡ä»¶å¤±è´¥:', error);
            this.showNotification('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ—‘ï¸ æ ¹æ®collectionIdåˆ é™¤è¯­æ–™åº“æ–‡ä»¶
     */
    async deleteCorpusFileByCollectionId(chatId) {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const corpusData = extCfg.vectorCorpus || {};

            // ğŸ”§ æ ‡å‡†åŒ–chatIdç”¨äºåŒ¹é…
            const normalizedChatId = this.normalizeChatIdForMatching(chatId);

            // æŸ¥æ‰¾åŒ¹é…çš„è¯­æ–™åº“æ–‡ä»¶
            for (const [fileName, corpus] of Object.entries(corpusData)) {
                if (corpus.collectionId) {
                    // ä»collectionIdä¸­æå–chatIdå¹¶æ ‡å‡†åŒ–
                    let collectionChatId = '';
                    if (corpus.collectionId.includes('{cuerpo}')) {
                        collectionChatId = corpus.collectionId.replace('{cuerpo}', '');
                    } else if (corpus.collectionId.includes('/')) {
                        collectionChatId = corpus.collectionId.split('/')[0];
                    }

                    const normalizedCollectionChatId = this.normalizeChatIdForMatching(collectionChatId);

                    if (normalizedCollectionChatId === normalizedChatId) {
                        // è°ƒç”¨ç°æœ‰çš„åˆ é™¤æ–¹æ³•
                        await this.deleteCorpus(fileName);
                        break;
                    }
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤è¯­æ–™åº“æ–‡ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸ—‘ï¸ æ ¹æ®ç´¢å¼•åˆ é™¤æ€»ç»“æ–‡ä»¶
     */
    async deleteSummaryFileByIndex(chatId, recordIndex) {
        try {
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const vectorizedSummary = extCfg.vectorizedSummary || {};

            // ğŸ”§ æ ‡å‡†åŒ–chatIdç”¨äºåŒ¹é…
            const normalizedChatId = this.normalizeChatIdForMatching(chatId);

            // ğŸ”§ æŸ¥æ‰¾åŒ¹é…çš„chatIdï¼ˆä½¿ç”¨æ ‡å‡†åŒ–åŒ¹é…ï¼‰
            let matchedChatId = null;
            for (const storedChatId of Object.keys(vectorizedSummary)) {
                if (storedChatId === 'settings') continue;
                const normalizedStoredChatId = this.normalizeChatIdForMatching(storedChatId);
                if (normalizedStoredChatId === normalizedChatId) {
                    matchedChatId = storedChatId;
                    break;
                }
            }

            if (!matchedChatId) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„èŠå¤©ID:', chatId);
                return;
            }

            const chatData = vectorizedSummary[matchedChatId] || {};
            const vectorizedRecords = chatData.vectorizedRecords || [];

            if (!isNaN(recordIndex) && vectorizedRecords[recordIndex]) {
                const record = vectorizedRecords[recordIndex];

                // æ¸…ç†åç«¯å‘é‡æ•°æ®
                if (record.collectionId) {
                    const purgePayload = {
                        collectionId: record.collectionId,
                        source: 'vectorized_summary'
                    };

                    const response = await fetch('/api/vector/purge', {
                        method: 'POST',
                        headers: context.getRequestHeaders(),
                        body: JSON.stringify(purgePayload)
                    });

                    if (!response.ok) {
                        console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†å‘é‡æ•°æ®å¤±è´¥');
                    }
                }

                // ä»æ•°ç»„ä¸­åˆ é™¤
                vectorizedRecords.splice(recordIndex, 1);

                // ä¿å­˜é…ç½®
                context.saveSettingsDebounced();

                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤æ€»ç»“ #${recordIndex + 1}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤æ€»ç»“æ–‡ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    // ==================== é¢„è®¾ç®¡ç†åŠŸèƒ½ ====================

    /**
     * ğŸ†• åˆ·æ–°é¢„è®¾åˆ—è¡¨
     */
    async refreshPresetList() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°é¢„è®¾åˆ—è¡¨...');

            const container = this.modal.querySelector('#preset-list-container');
            if (!container) {
                console.warn('[InfoBarSettings] âš ï¸ é¢„è®¾åˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // è·å–å·²ä¿å­˜çš„é¢„è®¾
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};
            const presets = extensionSettings.presets || {};
            const activePresetId = extensionSettings.activePreset || null;

            // å¦‚æœæ²¡æœ‰é¢„è®¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (Object.keys(presets).length === 0) {
                container.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: var(--SmartThemeTextSecondaryColor, #aaa);">
                        <p>æš‚æ— å¯¼å…¥çš„é¢„è®¾</p>
                        <p style="font-size: 12px; margin-top: 8px;">ç‚¹å‡»"å¯¼å…¥é¢„è®¾"æŒ‰é’®å¯¼å…¥é…ç½®é¢„è®¾</p>
                    </div>
                `;
                return;
            }

            // ç”Ÿæˆé¢„è®¾åˆ—è¡¨HTML
            let html = '<div class="preset-list" style="display: flex; flex-direction: column; gap: 8px;">';

            for (const [presetId, preset] of Object.entries(presets)) {
                const isActive = presetId === activePresetId;
                const timestamp = preset.timestamp ? new Date(preset.timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';

                html += `
                    <div class="preset-item" style="
                        padding: 12px;
                        border: 1px solid var(--SmartThemeBorderColor, #333);
                        border-radius: 6px;
                        background: ${isActive ? 'var(--SmartThemeQuoteColor, rgba(255,255,255,.03))' : 'transparent'};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">
                                ${this.escapeHtml(preset.name || presetId)}
                                ${isActive ? '<span style="color: var(--SmartThemeAccentColor, #4a9eff); font-size: 12px; margin-left: 8px;">[å½“å‰]</span>' : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--SmartThemeTextSecondaryColor, #aaa);">
                                å¯¼å…¥æ—¶é—´: ${timestamp}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${!isActive ? `<button class="btn btn-small" data-action="switch-preset" data-preset-id="${presetId}">åˆ‡æ¢</button>` : ''}
                            <button class="btn btn-small btn-danger" data-action="delete-preset" data-preset-id="${presetId}">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            console.log('[InfoBarSettings] âœ… é¢„è®¾åˆ—è¡¨åˆ·æ–°å®Œæˆï¼Œå…±', Object.keys(presets).length, 'ä¸ªé¢„è®¾');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°é¢„è®¾åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• å¯¼å‡ºé¢„è®¾
     */
    async exportPreset() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¯¼å‡ºé¢„è®¾...');

            // ä½¿ç”¨ç°æœ‰çš„å¯¼å‡ºé…ç½®åŠŸèƒ½
            const exportData = await this.configManager.exportConfigs();

            // æ·»åŠ é¢„è®¾å…ƒæ•°æ®
            exportData.presetMetadata = {
                name: `é¢„è®¾_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}`,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };

            // ç”Ÿæˆæ–‡ä»¶å
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `infobar_preset_${timestamp}.json`;

            // ä¸‹è½½æ–‡ä»¶
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            this.showMessage('é¢„è®¾å¯¼å‡ºæˆåŠŸ: ' + filename, 'success');
            console.log('[InfoBarSettings] âœ… é¢„è®¾å¯¼å‡ºæˆåŠŸ:', filename);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºé¢„è®¾å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºé¢„è®¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• å¯¼å…¥é¢„è®¾
     */
    async importPreset() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ å¼€å§‹å¯¼å…¥é¢„è®¾...');

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);

                    // éªŒè¯é¢„è®¾æ•°æ®
                    if (!importData.configs) {
                        throw new Error('æ— æ•ˆçš„é¢„è®¾æ–‡ä»¶æ ¼å¼');
                    }

                    // ç”Ÿæˆé¢„è®¾ID
                    const presetId = `preset_${Date.now()}`;
                    const presetName = importData.presetMetadata?.name || file.name.replace('.json', '');

                    // ä¿å­˜é¢„è®¾åˆ°extensionSettings
                    const context = SillyTavern.getContext();
                    const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};

                    if (!extensionSettings.presets) {
                        extensionSettings.presets = {};
                    }

                    extensionSettings.presets[presetId] = {
                        name: presetName,
                        timestamp: new Date().toISOString(),
                        data: importData
                    };

                    // ä¿å­˜åˆ°SillyTavern
                    context.extensionSettings['Information bar integration tool'] = extensionSettings;
                    await context.saveSettingsDebounced();

                    this.showMessage(`é¢„è®¾å¯¼å…¥æˆåŠŸ: ${presetName}`, 'success');
                    console.log('[InfoBarSettings] âœ… é¢„è®¾å¯¼å…¥æˆåŠŸ:', presetName);

                    // åˆ·æ–°é¢„è®¾åˆ—è¡¨
                    await this.refreshPresetList();

                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å¯¼å…¥é¢„è®¾å¤±è´¥:', error);
                    this.showMessage('å¯¼å…¥é¢„è®¾å¤±è´¥: ' + error.message, 'error');
                }
            };

            input.click();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å…¥é¢„è®¾å¤±è´¥:', error);
            this.showMessage('å¯¼å…¥é¢„è®¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• åˆ‡æ¢é¢„è®¾
     */
    async switchPreset(presetId) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢é¢„è®¾:', presetId);

            if (!confirm('åˆ‡æ¢é¢„è®¾å°†è¦†ç›–å½“å‰é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }

            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};
            const presets = extensionSettings.presets || {};
            const preset = presets[presetId];

            if (!preset || !preset.data) {
                throw new Error('é¢„è®¾ä¸å­˜åœ¨æˆ–æ•°æ®æ— æ•ˆ');
            }

            // åº”ç”¨é¢„è®¾é…ç½®
            await this.configManager.importConfigs(preset.data);

            // è®¾ç½®ä¸ºå½“å‰æ¿€æ´»çš„é¢„è®¾
            extensionSettings.activePreset = presetId;
            context.extensionSettings['Information bar integration tool'] = extensionSettings;
            await context.saveSettingsDebounced();

            // é‡æ–°åŠ è½½è®¾ç½®
            await this.loadSettings();

            this.showMessage(`å·²åˆ‡æ¢åˆ°é¢„è®¾: ${preset.name}`, 'success');
            console.log('[InfoBarSettings] âœ… é¢„è®¾åˆ‡æ¢æˆåŠŸ:', preset.name);

            // åˆ·æ–°é¢„è®¾åˆ—è¡¨
            await this.refreshPresetList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢é¢„è®¾å¤±è´¥:', error);
            this.showMessage('åˆ‡æ¢é¢„è®¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• åˆ é™¤é¢„è®¾
     */
    async deletePreset(presetId) {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤é¢„è®¾:', presetId);

            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};
            const presets = extensionSettings.presets || {};
            const preset = presets[presetId];

            if (!preset) {
                throw new Error('é¢„è®¾ä¸å­˜åœ¨');
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾"${preset.name}"å—ï¼Ÿ`)) {
                return;
            }

            // åˆ é™¤é¢„è®¾
            delete presets[presetId];

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ¿€æ´»çš„é¢„è®¾ï¼Œæ¸…é™¤æ¿€æ´»çŠ¶æ€
            if (extensionSettings.activePreset === presetId) {
                delete extensionSettings.activePreset;
            }

            // ä¿å­˜åˆ°SillyTavern
            context.extensionSettings['Information bar integration tool'] = extensionSettings;
            await context.saveSettingsDebounced();

            this.showMessage(`é¢„è®¾å·²åˆ é™¤: ${preset.name}`, 'success');
            console.log('[InfoBarSettings] âœ… é¢„è®¾åˆ é™¤æˆåŠŸ:', preset.name);

            // åˆ·æ–°é¢„è®¾åˆ—è¡¨
            await this.refreshPresetList();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤é¢„è®¾å¤±è´¥:', error);
            this.showMessage('åˆ é™¤é¢„è®¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• åŠ è½½é¢„è®¾é¢æ¿ï¼ˆé‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿ï¼‰
     */
    async loadPresetPanels() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åŠ è½½é¢„è®¾é¢æ¿...');

            if (!confirm('æ­¤æ“ä½œå°†é‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿ï¼Œå¯èƒ½ä¼šè¦†ç›–æ‚¨çš„è‡ªå®šä¹‰ä¿®æ”¹ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }

            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};

            // è·å–PresetPanelsManager
            const PresetPanelsManager = window.SillyTavernInfobar?.PresetPanelsManager;
            if (!PresetPanelsManager) {
                throw new Error('PresetPanelsManageræœªæ‰¾åˆ°');
            }

            // è·å–é¢„è®¾é¢æ¿é…ç½®
            const presets = PresetPanelsManager.getPresets();
            let customPanels = extensionSettings.customPanels || {};

            // é‡æ–°åŠ è½½æ‰€æœ‰é¢„è®¾é¢æ¿
            let loadedCount = 0;
            for (const [key, preset] of Object.entries(presets)) {
                customPanels[key] = JSON.parse(JSON.stringify(preset)); // æ·±æ‹·è´
                loadedCount++;
                console.log(`[InfoBarSettings] âœ… åŠ è½½é¢„è®¾é¢æ¿: ${key}`);
            }

            // ä¿å­˜åˆ°extensionSettings
            extensionSettings.customPanels = customPanels;
            context.extensionSettings['Information bar integration tool'] = extensionSettings;
            await context.saveSettingsDebounced();

            this.showMessage(`æˆåŠŸåŠ è½½ ${loadedCount} ä¸ªé¢„è®¾é¢æ¿`, 'success');
            console.log('[InfoBarSettings] âœ… é¢„è®¾é¢æ¿åŠ è½½å®Œæˆï¼Œå…±', loadedCount, 'ä¸ª');

            // é‡æ–°åŠ è½½è®¾ç½®ç•Œé¢
            await this.loadSettings();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é¢„è®¾é¢æ¿å¤±è´¥:', error);
            this.showMessage('åŠ è½½é¢„è®¾é¢æ¿å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• åŠ è½½é¢„è®¾è§„åˆ™ï¼ˆé‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿çš„è§„åˆ™ï¼‰
     */
    async loadPresetRules() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ å¼€å§‹åŠ è½½é¢„è®¾è§„åˆ™...');

            if (!confirm('æ­¤æ“ä½œå°†é‡æ–°åŠ è½½15ä¸ªé¢„è®¾é¢æ¿çš„è§„åˆ™ï¼ˆpromptså­—æ®µï¼‰ï¼Œå¯èƒ½ä¼šè¦†ç›–æ‚¨çš„è‡ªå®šä¹‰è§„åˆ™ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }

            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};

            // è·å–PresetPanelsManager
            const PresetPanelsManager = window.SillyTavernInfobar?.PresetPanelsManager;
            if (!PresetPanelsManager) {
                throw new Error('PresetPanelsManageræœªæ‰¾åˆ°');
            }

            // è·å–é¢„è®¾é¢æ¿é…ç½®
            const presets = PresetPanelsManager.getPresets();
            let customPanels = extensionSettings.customPanels || {};

            // åªæ›´æ–°é¢„è®¾é¢æ¿çš„promptså­—æ®µ
            let updatedCount = 0;
            for (const [key, preset] of Object.entries(presets)) {
                if (customPanels[key] && preset.prompts) {
                    customPanels[key].prompts = JSON.parse(JSON.stringify(preset.prompts)); // æ·±æ‹·è´
                    updatedCount++;
                    console.log(`[InfoBarSettings] âœ… æ›´æ–°é¢„è®¾è§„åˆ™: ${key}`);
                }
            }

            // ä¿å­˜åˆ°extensionSettings
            extensionSettings.customPanels = customPanels;
            context.extensionSettings['Information bar integration tool'] = extensionSettings;
            await context.saveSettingsDebounced();

            // ğŸ”§ åŒæ­¥è§„åˆ™åˆ° PanelRuleManager
            const panelRuleManager = window.SillyTavernInfobar?.modules?.panelRuleManager;
            if (panelRuleManager) {
                console.log('[InfoBarSettings] ğŸ“ å¼€å§‹åŒæ­¥è§„åˆ™åˆ° PanelRuleManager...');

                for (const [key, preset] of Object.entries(presets)) {
                    if (customPanels[key] && preset.prompts) {
                        // æ„å»ºè§„åˆ™å¯¹è±¡
                        const rule = {
                            description: preset.prompts.description || '',
                            updateRule: preset.prompts.update || '',
                            addRule: preset.prompts.insert || '',
                            deleteRule: preset.prompts.delete || '',
                            initRule: preset.prompts.init || '',
                            updatedAt: new Date().toISOString()
                        };

                        // ä¿å­˜åˆ°è§„åˆ™ç®¡ç†å™¨
                        const success = await panelRuleManager.setPanelRule(key, rule);
                        if (success) {
                            console.log(`[InfoBarSettings] âœ… é¢æ¿ ${key} çš„è§„åˆ™å·²åŒæ­¥åˆ° PanelRuleManager`);
                        } else {
                            console.error(`[InfoBarSettings] âŒ é¢æ¿ ${key} çš„è§„åˆ™åŒæ­¥å¤±è´¥`);
                        }
                    }
                }

                console.log('[InfoBarSettings] âœ… è§„åˆ™åŒæ­¥å®Œæˆ');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ PanelRuleManager ä¸å¯ç”¨ï¼Œè§„åˆ™æœªåŒæ­¥');
            }

            this.showMessage(`æˆåŠŸæ›´æ–° ${updatedCount} ä¸ªé¢æ¿çš„è§„åˆ™`, 'success');
            console.log('[InfoBarSettings] âœ… é¢„è®¾è§„åˆ™åŠ è½½å®Œæˆï¼Œå…±æ›´æ–°', updatedCount, 'ä¸ª');

            // ğŸ”§ åˆ·æ–°æ•°æ®è¡¨æ ¼æ˜¾ç¤º
            const dataTable = window.SillyTavernInfobar?.modules?.dataTable;
            if (dataTable) {
                console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°æ•°æ®è¡¨æ ¼æ˜¾ç¤º...');
                // æ¸…é™¤é¢æ¿ç¼“å­˜
                dataTable.clearPanelsCache();
                // åˆ·æ–°è¡¨æ ¼ç»“æ„
                dataTable.refreshTableStructure();
                console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼å·²åˆ·æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é¢„è®¾è§„åˆ™å¤±è´¥:', error);
            this.showMessage('åŠ è½½é¢„è®¾è§„åˆ™å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
     */
    async checkVersion() {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯...');

            // 1. è¯»å–å½“å‰ç‰ˆæœ¬ï¼ˆä»manifest.jsonï¼‰
            const currentVersion = await this.getCurrentVersion();
            
            // 2. æ›´æ–°å½“å‰ç‰ˆæœ¬æ˜¾ç¤º
            const currentVersionSpan = this.modal.querySelector('#current-version');
            if (currentVersionSpan) {
                currentVersionSpan.textContent = currentVersion || 'Unknown';
                currentVersionSpan.style.color = 'var(--theme-primary-color, #4CAF50)';
            }

            // 3. æ£€æµ‹æœ€æ–°ç‰ˆæœ¬ï¼ˆä»GitHubï¼‰
            this.getLatestVersion().then(latestVersion => {
                const latestVersionSpan = this.modal.querySelector('#latest-version');
                if (latestVersionSpan) {
                    latestVersionSpan.textContent = latestVersion || 'æ£€æµ‹å¤±è´¥';
                    
                    // 4. æ¯”è¾ƒç‰ˆæœ¬å¹¶æ˜¾ç¤ºçŠ¶æ€
                    if (latestVersion && currentVersion) {
                        if (this.compareVersions(currentVersion, latestVersion) < 0) {
                            // æœ‰æ–°ç‰ˆæœ¬
                            latestVersionSpan.style.color = '#ff9800';
                            const versionDisplay = this.modal.querySelector('#infobar-version-display');
                            if (versionDisplay) {
                                versionDisplay.innerHTML = `
                                    <span id="current-version" style="color: var(--theme-primary-color, #4CAF50);">${currentVersion}</span> / 
                                    <span id="latest-version" style="color: #ff9800;">${latestVersion}</span>
                                    <span style="color: #ff9800; margin-left: 8px;">ğŸ†• æœ‰æ–°ç‰ˆæœ¬</span>
                                `;
                            }
                        } else {
                            // å·²æ˜¯æœ€æ–°ç‰ˆæœ¬
                            latestVersionSpan.style.color = 'var(--theme-primary-color, #4CAF50)';
                        }
                    }
                }
            }).catch(error => {
                console.warn('[InfoBarSettings] âš ï¸ è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥:', error);
                const latestVersionSpan = this.modal.querySelector('#latest-version');
                if (latestVersionSpan) {
                    latestVersionSpan.textContent = 'æ£€æµ‹å¤±è´¥';
                    latestVersionSpan.style.color = '#888';
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ†• è·å–å½“å‰ç‰ˆæœ¬ï¼ˆä»manifest.jsonï¼‰
     */
    async getCurrentVersion() {
        try {
            const manifestPath = 'scripts/extensions/third-party/Information bar integration tool/manifest.json';
            const response = await fetch(manifestPath);
            
            if (!response.ok) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–manifest.json');
                return null;
            }
            
            const manifest = await response.json();
            return manifest.version || null;
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰ç‰ˆæœ¬å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ†• è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆä»GitHubï¼‰
     */
    async getLatestVersion() {
        try {
            const githubUrl = 'https://raw.githubusercontent.com/loveyouguhan/Information-bar-integration-tool/main/manifest.json';
            
            const response = await fetch(githubUrl, {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä»GitHubè·å–æœ€æ–°ç‰ˆæœ¬');
                return null;
            }
            
            const manifest = await response.json();
            return manifest.version || null;
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ†• æ¯”è¾ƒç‰ˆæœ¬å·
     * @returns {number} -1: v1 < v2, 0: v1 = v2, 1: v1 > v2
     */
    compareVersions(v1, v2) {
        try {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const part1 = parts1[i] || 0;
                const part2 = parts2[i] || 0;
                
                if (part1 < part2) return -1;
                if (part1 > part2) return 1;
            }
            
            return 0;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¯”è¾ƒç‰ˆæœ¬å·å¤±è´¥:', error);
            return 0;
        }
    }

    /**
     * ğŸ†• åŠ è½½å…¬å‘Šä¿¡æ¯
     */
    async loadAnnouncement() {
        try {
            console.log('[InfoBarSettings] ğŸ“¢ å¼€å§‹åŠ è½½å…¬å‘Šä¿¡æ¯...');

            const announcementContent = this.modal.querySelector('#announcement-content');
            if (!announcementContent) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å…¬å‘Šæ˜¾ç¤ºå…ƒç´ ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            announcementContent.textContent = 'åŠ è½½å…¬å‘Šä¸­...';
            announcementContent.style.color = 'var(--theme-text-secondary, #888)';

            // ä»GitHubè·å–å…¬å‘Šå†…å®¹
            const announcement = await this.getAnnouncementFromGitHub();
            
            if (announcement && announcementContent) {
                announcementContent.textContent = announcement;
                announcementContent.style.color = 'var(--theme-primary-color, #4CAF50)';
                console.log('[InfoBarSettings] âœ… å…¬å‘ŠåŠ è½½æˆåŠŸ:', announcement);
            } else {
                announcementContent.textContent = 'æš‚æ— å…¬å‘Š';
                announcementContent.style.color = 'var(--theme-text-secondary, #666)';
                console.log('[InfoBarSettings] â„¹ï¸ æœªè·å–åˆ°å…¬å‘Šå†…å®¹');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å…¬å‘Šä¿¡æ¯å¤±è´¥:', error);
            const announcementContent = this.modal.querySelector('#announcement-content');
            if (announcementContent) {
                announcementContent.textContent = 'å…¬å‘ŠåŠ è½½å¤±è´¥';
                announcementContent.style.color = 'var(--theme-text-secondary, #666)';
            }
        }
    }

    /**
     * ğŸ†• ä»GitHubè·å–å…¬å‘Šå†…å®¹
     */
    async getAnnouncementFromGitHub() {
        try {
            const githubUrl = 'https://raw.githubusercontent.com/loveyouguhan/Information-bar-integration-tool/main/gonggao';
            
            const response = await fetch(githubUrl, {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Accept': 'text/plain'
                }
            });
            
            if (!response.ok) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä»GitHubè·å–å…¬å‘Š');
                return null;
            }
            
            const content = await response.text();
            
            // è§£æå…¬å‘Šæ ¼å¼: gonggao = å…¬å‘Šå†…å®¹
            const match = content.match(/gonggao\s*=\s*(.+)/);
            if (match && match[1]) {
                const announcement = match[1].trim();
                console.log('[InfoBarSettings] ğŸ“¢ è§£æåˆ°å…¬å‘Šå†…å®¹:', announcement);
                return announcement;
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ¼å¼ï¼Œè¿”å›æ•´ä¸ªå†…å®¹
            if (content && content.trim()) {
                console.log('[InfoBarSettings] ğŸ“¢ ä½¿ç”¨åŸå§‹å…¬å‘Šå†…å®¹');
                return content.trim();
            }
            
            return null;
            
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–GitHubå…¬å‘Šå¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ†• æ˜¾ç¤ºåˆå¹¶NPCå¯¹è¯æ¡†
     */
    async showMergeNPCDialog() {
        try {
            if (this.selectedNpcIds.size !== 2) {
                this.showToast('è¯·é€‰æ‹©æ°å¥½2ä¸ªNPCè¿›è¡Œåˆå¹¶', 'warning');
                return;
            }

            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                console.error('[InfoBarSettings] âŒ NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°');
                return;
            }

            // è·å–é€‰ä¸­çš„ä¸¤ä¸ªNPC
            const selectedIds = Array.from(this.selectedNpcIds);
            const npc1 = npcDB.db.npcs[selectedIds[0]];
            const npc2 = npcDB.db.npcs[selectedIds[1]];

            if (!npc1 || !npc2) {
                this.showToast('æ— æ³•æ‰¾åˆ°é€‰ä¸­çš„NPC', 'error');
                return;
            }

            console.log('[InfoBarSettings] ğŸ”€ å‡†å¤‡åˆå¹¶NPC:', npc1.name, 'å’Œ', npc2.name);

            // åˆ›å»ºåˆå¹¶çª—å£
            const { html, styles } = this.createMergeNPCDialogHTML(npc1, npc2);

            const container = document.createElement('div');
            container.innerHTML = html;
            document.body.appendChild(container.firstElementChild);

            // ğŸ”§ æ·»åŠ æ ·å¼åˆ°head
            const styleElement = document.createElement('style');
            styleElement.id = 'merge-npc-dialog-styles';
            styleElement.textContent = styles;
            document.head.appendChild(styleElement);

            const overlay = document.getElementById('merge-npc-overlay');

            // å…³é—­å¯¹è¯æ¡†
            const closeDialog = () => {
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                // ğŸ”§ ç§»é™¤æ ·å¼
                const styleEl = document.getElementById('merge-npc-dialog-styles');
                if (styleEl && styleEl.parentNode) {
                    styleEl.parentNode.removeChild(styleEl);
                }
            };

            // ç»‘å®šå…³é—­äº‹ä»¶
            overlay.querySelector('[data-action="close-merge"]').addEventListener('click', closeDialog);
            overlay.querySelector('[data-action="cancel-merge"]').addEventListener('click', closeDialog);

            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDialog();
                }
            });

            // ç»‘å®šåˆå¹¶ç¡®è®¤äº‹ä»¶
            overlay.querySelector('[data-action="confirm-merge"]').addEventListener('click', async () => {
                await this.handleMergeNPCConfirm(npc1, npc2, overlay);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºåˆå¹¶å¯¹è¯æ¡†å¤±è´¥:', error);
            this.showToast('æ˜¾ç¤ºåˆå¹¶å¯¹è¯æ¡†å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * ğŸ†• åˆ›å»ºåˆå¹¶NPCå¯¹è¯æ¡†HTML
     */
    createMergeNPCDialogHTML(npc1, npc2) {
        // è·å–æ‰€æœ‰å­—æ®µçš„å¹¶é›†
        const allFields = new Set([
            ...Object.keys(npc1.fields || {}),
            ...Object.keys(npc2.fields || {})
        ]);

        // ç”Ÿæˆå­—æ®µå¯¹æ¯”HTML - æ”¹ä¸ºå¡ç‰‡å¼æ¨ªå‘å¸ƒå±€
        let fieldsHtml = '';

        // åŸºç¡€ä¿¡æ¯ï¼šåç§°
        fieldsHtml += `
            <div class="merge-field-row">
                <div class="merge-field-label">åç§°</div>
                <div class="merge-field-cards">
                    <label class="merge-card merge-card-npc1">
                        <input type="radio" name="field_name" value="npc1" checked>
                        <div class="merge-card-header">
                            <span class="merge-card-badge">è§’è‰²1</span>
                        </div>
                        <div class="merge-card-value">${this.escapeHtml(npc1.name)}</div>
                    </label>
                    <label class="merge-card merge-card-npc2">
                        <input type="radio" name="field_name" value="npc2">
                        <div class="merge-card-header">
                            <span class="merge-card-badge">è§’è‰²2</span>
                        </div>
                        <div class="merge-card-value">${this.escapeHtml(npc2.name)}</div>
                    </label>
                </div>
            </div>
        `;

        // å…¶ä»–å­—æ®µ
        for (const fieldName of allFields) {
            const value1 = npc1.fields[fieldName];
            const value2 = npc2.fields[fieldName];

            // å¦‚æœä¸¤ä¸ªå€¼ç›¸åŒï¼Œåªæ˜¾ç¤ºä¸€ä¸ªé€‰é¡¹
            if (value1 === value2 && value1 !== undefined) {
                fieldsHtml += `
                    <div class="merge-field-row">
                        <div class="merge-field-label">${this.escapeHtml(fieldName)}</div>
                        <div class="merge-field-cards merge-field-same">
                            <div class="merge-card merge-card-same">
                                <input type="radio" name="field_${this.escapeHtml(fieldName)}" value="same" checked style="display: none;">
                                <div class="merge-card-header">
                                    <span class="merge-card-badge merge-badge-same">ç›¸åŒ</span>
                                </div>
                                <div class="merge-card-value">${this.escapeHtml(String(value1))}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // å€¼ä¸åŒï¼Œæ˜¾ç¤ºä¸¤ä¸ªé€‰é¡¹
                const hasValue1 = value1 !== undefined && value1 !== null && value1 !== '';
                const hasValue2 = value2 !== undefined && value2 !== null && value2 !== '';

                fieldsHtml += `
                    <div class="merge-field-row">
                        <div class="merge-field-label">${this.escapeHtml(fieldName)}</div>
                        <div class="merge-field-cards">
                            <label class="merge-card merge-card-npc1 ${!hasValue1 ? 'merge-card-empty' : ''}">
                                <input type="radio" name="field_${this.escapeHtml(fieldName)}" value="npc1" ${hasValue1 ? 'checked' : ''} ${!hasValue1 ? 'disabled' : ''}>
                                <div class="merge-card-header">
                                    <span class="merge-card-badge">è§’è‰²1</span>
                                </div>
                                <div class="merge-card-value">${hasValue1 ? this.escapeHtml(String(value1)) : '<span class="merge-empty-text">æ— æ•°æ®</span>'}</div>
                            </label>
                            <label class="merge-card merge-card-npc2 ${!hasValue2 ? 'merge-card-empty' : ''}">
                                <input type="radio" name="field_${this.escapeHtml(fieldName)}" value="npc2" ${!hasValue1 && hasValue2 ? 'checked' : ''} ${!hasValue2 ? 'disabled' : ''}>
                                <div class="merge-card-header">
                                    <span class="merge-card-badge">è§’è‰²2</span>
                                </div>
                                <div class="merge-card-value">${hasValue2 ? this.escapeHtml(String(value2)) : '<span class="merge-empty-text">æ— æ•°æ®</span>'}</div>
                            </label>
                        </div>
                    </div>
                `;
            }
        }

        // ğŸ”§ åˆ†ç¦»HTMLå’Œæ ·å¼
        const html = `
            <div id="merge-npc-overlay" class="regex-overlay" style="
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            ">
                <div class="regex-modal" style="
                    background: var(--theme-bg-primary, var(--SmartThemeBodyColor, #1a1a1a));
                    border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                    border-radius: 8px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                ">
                    <div class="regex-modal-header" style="
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <h3 style="margin: 0; color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));">
                            ğŸ”€ åˆå¹¶è§’è‰²
                        </h3>
                        <button data-action="close-merge" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-secondary, #999);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">Ã—</button>
                    </div>

                    <div class="regex-modal-body" style="
                        padding: 20px;
                        overflow-y: auto;
                        flex: 1;
                    ">
                        <div class="merge-info" style="
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            padding: 12px 16px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            border-left: 3px solid var(--theme-primary-color, #4CAF50);
                        ">
                            <div style="color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd)); margin-bottom: 8px;">
                                <strong>åˆå¹¶è¯´æ˜ï¼š</strong>
                            </div>
                            <div style="color: var(--theme-text-secondary, #999); font-size: 13px; line-height: 1.6;">
                                â€¢ æ­£åœ¨åˆå¹¶ï¼š<strong>${this.escapeHtml(npc1.name)}</strong> å’Œ <strong>${this.escapeHtml(npc2.name)}</strong><br>
                                â€¢ è¯·ä¸ºæ¯ä¸ªå­—æ®µé€‰æ‹©è¦ä¿ç•™çš„å€¼<br>
                                â€¢ åˆå¹¶åå°†ä¿ç•™ç¬¬ä¸€ä¸ªNPCï¼Œåˆ é™¤ç¬¬äºŒä¸ªNPC<br>
                                â€¢ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…é€‰æ‹©
                            </div>
                        </div>

                        <div class="merge-fields-container">
                            ${fieldsHtml}
                        </div>
                    </div>

                    <div class="regex-modal-footer" style="
                        padding: 16px 20px;
                        border-top: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                    ">
                        <button data-action="cancel-merge" class="regex-btn regex-btn-secondary" style="
                            padding: 8px 20px;
                            background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                            color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                            border: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #444));
                            border-radius: 4px;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                        <button data-action="confirm-merge" class="regex-btn regex-btn-primary" style="
                            padding: 8px 20px;
                            background: var(--theme-primary-color, #4CAF50);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">ç¡®è®¤åˆå¹¶</button>
                    </div>
                </div>
            </div>
        `;

        // ğŸ”§ æ ·å¼å•ç‹¬å®šä¹‰
        const styles = `
            /* ğŸ”§ åˆå¹¶å¯¹è¯æ¡† - å¡ç‰‡å¼æ¨ªå‘å¸ƒå±€ */
            .merge-field-row {
                display: flex;
                flex-direction: column;
                gap: 12px;
                padding: 16px 12px;
                border-bottom: 1px solid var(--theme-border-color, var(--SmartThemeBorderColor, #2a2a2a));
            }

            .merge-field-row:last-child {
                border-bottom: none;
            }

            .merge-field-label {
                font-weight: 600;
                font-size: 14px;
                color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                margin-bottom: 4px;
            }

            /* å¡ç‰‡å®¹å™¨ - æ¨ªå‘å¸ƒå±€ */
            .merge-field-cards {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            /* ç›¸åŒå€¼æ—¶åªæ˜¾ç¤ºä¸€ä¸ªå¡ç‰‡ */
            .merge-field-same {
                grid-template-columns: 1fr;
            }

            /* å¡ç‰‡æ ·å¼ */
            .merge-card {
                position: relative;
                display: flex;
                flex-direction: column;
                padding: 12px;
                background: var(--theme-bg-secondary, var(--SmartThemeSurfaceColor, #2a2a2a));
                border: 2px solid var(--theme-border-color, var(--SmartThemeBorderColor, #333));
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                min-height: 80px;
            }

            .merge-card input[type="radio"] {
                position: absolute;
                opacity: 0;
                pointer-events: none;
            }

            .merge-card:hover:not(.merge-card-empty) {
                border-color: var(--theme-primary-color, var(--SmartThemePrimaryColor, #4CAF50));
                background: var(--theme-bg-hover, var(--SmartThemeQuoteColor, #333));
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            /* é€‰ä¸­çŠ¶æ€ */
            .merge-card input[type="radio"]:checked ~ .merge-card-header .merge-card-badge {
                background: var(--theme-primary-color, var(--SmartThemePrimaryColor, #4CAF50));
                color: white;
            }

            .merge-card input[type="radio"]:checked ~ .merge-card-value {
                font-weight: 500;
                color: var(--theme-text-primary, var(--SmartThemeTextColor, #fff));
            }

            /* ç©ºæ•°æ®å¡ç‰‡ */
            .merge-card-empty {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .merge-card-empty:hover {
                transform: none;
                box-shadow: none;
            }

            /* ç›¸åŒå€¼å¡ç‰‡ */
            .merge-card-same {
                border-color: var(--theme-primary-color, var(--SmartThemePrimaryColor, #4CAF50));
                cursor: default;
            }

            .merge-card-same:hover {
                transform: none;
            }

            /* å¡ç‰‡å¤´éƒ¨ */
            .merge-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            /* å¡ç‰‡æ ‡ç­¾ */
            .merge-card-badge {
                padding: 4px 10px;
                background: var(--theme-bg-tertiary, var(--SmartThemeBlurTintColor, #444));
                color: var(--theme-text-secondary, var(--SmartThemeQuoteColor, #999));
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                transition: all 0.2s ease;
            }

            .merge-badge-same {
                background: var(--theme-primary-color, var(--SmartThemePrimaryColor, #4CAF50));
                color: white;
            }

            /* å¡ç‰‡å€¼ */
            .merge-card-value {
                flex: 1;
                color: var(--theme-text-primary, var(--SmartThemeTextColor, #ddd));
                word-break: break-word;
                line-height: 1.5;
                font-size: 13px;
            }

            /* ç©ºæ•°æ®æ–‡æœ¬ */
            .merge-empty-text {
                color: var(--theme-text-secondary, var(--SmartThemeQuoteColor, #999));
                font-style: italic;
            }

            /* ğŸ”§ ç§»åŠ¨ç«¯é€‚é… - å‚è€ƒNPCè¯¦æƒ…çª—å£ */
            @media (max-width: 768px) {
                /* ğŸ”§ ä¿®å¤ï¼šoverlayå…¨å±æ˜¾ç¤º */
                #merge-npc-overlay {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 1000000 !important;
                    display: flex !important;
                    align-items: flex-start !important;
                    justify-content: center !important;
                    padding: 5vh 10px 10px 10px !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šmodalå…¨å±æ˜¾ç¤º */
                .regex-modal {
                    width: 100% !important;
                    max-width: none !important;
                    max-height: 90vh !important;
                    border-radius: 12px !important;
                    overflow: hidden !important;
                    display: flex !important;
                    flex-direction: column !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šheaderç´§å‡‘å¸ƒå±€ */
                .regex-modal-header {
                    padding: 12px 16px !important;
                    position: sticky !important;
                    top: 0 !important;
                    z-index: 10 !important;
                    flex-shrink: 0 !important;
                }

                .regex-modal-header h3 {
                    font-size: 16px !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šå…³é—­æŒ‰é’®å¯ç‚¹å‡» */
                [data-action="close-merge"] {
                    width: 36px !important;
                    height: 36px !important;
                    font-size: 28px !important;
                    border-radius: 6px !important;
                    border: 1px solid var(--theme-border-color, #555) !important;
                    z-index: 100 !important;
                }

                [data-action="close-merge"]:active {
                    background: var(--theme-bg-danger, #dc3545) !important;
                    transform: scale(0.95) !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šbodyå¯æ»šåŠ¨ */
                .regex-modal-body {
                    flex: 1 !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                    padding: 12px 16px !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šfooterç´§å‡‘å¸ƒå±€ */
                .regex-modal-footer {
                    padding: 12px 16px !important;
                    position: sticky !important;
                    bottom: 0 !important;
                    z-index: 10 !important;
                    flex-shrink: 0 !important;
                    background: var(--theme-bg-primary, #1a1a1a) !important;
                }

                /* ğŸ”§ ä¿®å¤ï¼šæŒ‰é’®å…¨å®½ */
                .regex-modal-footer button {
                    flex: 1 !important;
                    padding: 12px 16px !important;
                    font-size: 14px !important;
                }

                /* ğŸ”§ åˆå¹¶è¯´æ˜ç´§å‡‘å¸ƒå±€ */
                .merge-info {
                    padding: 10px 12px !important;
                    margin-bottom: 16px !important;
                    font-size: 12px !important;
                }

                .merge-info strong {
                    font-size: 13px !important;
                }

                /* ğŸ”§ å­—æ®µè¡Œç´§å‡‘å¸ƒå±€ */
                .merge-field-row {
                    padding: 12px 8px !important;
                    gap: 10px !important;
                }

                .merge-field-label {
                    font-size: 13px !important;
                    font-weight: 600 !important;
                }

                /* ğŸ”§ å¡ç‰‡å®¹å™¨ï¼šä¿æŒæ¨ªå‘å¸ƒå±€ï¼ˆå·¦å³æ˜¾ç¤ºï¼‰ */
                .merge-field-cards {
                    grid-template-columns: 1fr 1fr !important; /* ä¿æŒä¸¤åˆ— */
                    gap: 8px !important;
                }

                /* ğŸ”§ å¡ç‰‡ç´§å‡‘å¸ƒå±€ */
                .merge-card {
                    min-height: 60px !important;
                    padding: 8px !important;
                }

                .merge-card-badge {
                    font-size: 10px !important;
                    padding: 2px 6px !important;
                }

                .merge-card-value {
                    font-size: 12px !important;
                    line-height: 1.4 !important;
                }

                .merge-empty-text {
                    font-size: 11px !important;
                }
            }
        `;

        return { html, styles };
    }

    /**
     * ğŸ†• å¤„ç†åˆå¹¶NPCç¡®è®¤
     */
    async handleMergeNPCConfirm(npc1, npc2, overlay) {
        try {
            console.log('[InfoBarSettings] ğŸ”€ å¼€å§‹åˆå¹¶NPC...');

            // æ”¶é›†ç”¨æˆ·é€‰æ‹©çš„å­—æ®µå€¼
            const mergedData = {
                name: npc1.name, // é»˜è®¤ä½¿ç”¨npc1çš„åç§°
                fields: {}
            };

            // è·å–åç§°é€‰æ‹©
            const nameChoice = overlay.querySelector('input[name="field_name"]:checked')?.value;
            if (nameChoice === 'npc2') {
                mergedData.name = npc2.name;
            }

            // è·å–æ‰€æœ‰å­—æ®µçš„å¹¶é›†
            const allFields = new Set([
                ...Object.keys(npc1.fields || {}),
                ...Object.keys(npc2.fields || {})
            ]);

            // æ”¶é›†æ¯ä¸ªå­—æ®µçš„é€‰æ‹©
            for (const fieldName of allFields) {
                const radioName = `field_${fieldName}`;
                const selectedRadio = overlay.querySelector(`input[name="${radioName}"]:checked`);

                if (selectedRadio) {
                    const choice = selectedRadio.value;

                    if (choice === 'same') {
                        // ç›¸åŒå€¼ï¼Œä½¿ç”¨ä»»æ„ä¸€ä¸ª
                        mergedData.fields[fieldName] = npc1.fields[fieldName];
                    } else if (choice === 'npc1') {
                        mergedData.fields[fieldName] = npc1.fields[fieldName];
                    } else if (choice === 'npc2') {
                        mergedData.fields[fieldName] = npc2.fields[fieldName];
                    }
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š åˆå¹¶åçš„æ•°æ®:', mergedData);

            // è°ƒç”¨NPCDatabaseManagerçš„åˆå¹¶æ–¹æ³•
            const npcDB = window.SillyTavernInfobar?.modules?.npcDatabaseManager;
            if (!npcDB) {
                throw new Error('NPCæ•°æ®åº“æ¨¡å—æœªæ‰¾åˆ°');
            }

            // æ‰§è¡Œåˆå¹¶
            const success = await npcDB.mergeNPCs(npc1.id, npc2.id, mergedData);

            if (success) {
                console.log('[InfoBarSettings] âœ… NPCåˆå¹¶æˆåŠŸ');
                this.showToast(`æˆåŠŸåˆå¹¶ "${npc1.name}" å’Œ "${npc2.name}"`, 'success');

                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                this.selectedNpcIds.clear();

                // åˆ·æ–°NPCåˆ—è¡¨
                await this.refreshNPCList();

                // å…³é—­å¯¹è¯æ¡†
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            } else {
                throw new Error('åˆå¹¶æ“ä½œå¤±è´¥');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå¹¶NPCå¤±è´¥:', error);
            this.showToast('åˆå¹¶NPCå¤±è´¥: ' + error.message, 'error');
        }
    }
}
