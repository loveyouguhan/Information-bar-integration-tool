/**
 * ä¿¡æ¯æ è®¾ç½®ç•Œé¢
 *
 * è´Ÿè´£ç®¡ç†ä¿¡æ¯æ çš„è®¾ç½®ç•Œé¢ï¼š
 * - åŸºç¡€è®¾ç½®é¢æ¿
 * - APIé…ç½®é¢æ¿
 * - ä¸»é¢˜è®¾ç½®é¢æ¿
 * - é¢æ¿ç®¡ç†ç•Œé¢
 * - è®¾ç½®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
 *
 * @class InfoBarSettings
 */

export class InfoBarSettings {
    constructor(configManager, apiIntegration, eventSystem) {
        console.log('[InfoBarSettings] ğŸ”§ ä¿¡æ¯æ è®¾ç½®ç•Œé¢åˆå§‹åŒ–å¼€å§‹');

        this.configManager = configManager;
        this.apiIntegration = apiIntegration;
        this.eventSystem = eventSystem;

        // ğŸ”§ æ³¨å…¥æ•°æ®æ ¸å¿ƒå¼•ç”¨ï¼Œä¾›æ•°æ®å¯¼å‡º/å¯¼å…¥ä½¿ç”¨
        this.unifiedDataCore = this.configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore || null;

        // ğŸ†• ä¸–ç•Œä¹¦ç®¡ç†å™¨å¼•ç”¨
        this.worldBookManager = null;
        this.worldBookConfigPanel = null;
        this.worldBookConfigPanelInitialized = false;

        // å…¨å±€å¹¶å‘/å»é‡æ§åˆ¶æ ‡è®°
        this._customAPIProcessing = false; // è‡ªå®šä¹‰APIå¤„ç†è¿›è¡Œä¸­
        this._boundHandlers = {}; // å­˜æ”¾å·²ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ï¼Œé¿å…é‡å¤ç»‘å®š

        // UIå…ƒç´ å¼•ç”¨
        this.container = null;
        this.modal = null;
        this.currentTab = 'basic';

        // è®¾ç½®é¢æ¿
        this.panels = {
            basic: null,
            api: null,
            theme: null,
            panels: null,
            advanced: null,
            personal: null,
            interaction: null,
            tasks: null,
            world: null,
            organization: null,
            news: null,
            inventory: null,
            abilities: null,
            plot: null,
            cultivation: null,
            fantasy: null,
            modern: null,
            historical: null,
            magic: null,
            training: null
        };

        // è¡¨å•æ•°æ®
        this.formData = {};

        // åˆå§‹åŒ–çŠ¶æ€
        this.initialized = false;
        this.visible = false;
        this.errorCount = 0;
        this.settingsLoaded = false;
        this.needsSettingsRefresh = false;

        // ç»‘å®šæ–¹æ³•
        this.init = this.init.bind(this);
        this.show = this.show.bind(this);
        this.hide = this.hide.bind(this);
        this.createUI = this.createUI.bind(this);
        this.loadSettings = this.loadSettings.bind(this);
        this.saveSettings = this.saveSettings.bind(this);

        // ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        this.bindChatSwitchListener();

        // ğŸ”§ æ–°å¢ï¼šç«‹å³åº”ç”¨ä¿å­˜çš„æ—¥å¿—çº§åˆ«è®¾ç½®ï¼Œæ— éœ€ç­‰å¾…UIç•Œé¢
        // å¼‚æ­¥è°ƒç”¨ï¼Œä¸é˜»å¡æ„é€ å‡½æ•°
        this.applyEarlyLogLevel().catch(error => {
            console.error('[InfoBarSettings] âŒ æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®å¼‚å¸¸:', error);
        });
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåœ¨æ‰©å±•åŠ è½½æ—©æœŸç«‹å³åº”ç”¨ä¿å­˜çš„æ—¥å¿—çº§åˆ«è®¾ç½®
     * æ— éœ€ç­‰å¾…UIç•Œé¢åŠ è½½ï¼Œç›´æ¥ä»é…ç½®ä¸­è¯»å–å¹¶åº”ç”¨
     */
    async applyEarlyLogLevel() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹åº”ç”¨æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®...');

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶è¯»å–é…ç½®
            const context = SillyTavern.getContext();
            if (!context || !context.extensionSettings) {
                console.log('[InfoBarSettings] âš ï¸ SillyTavernä¸Šä¸‹æ–‡æœªå°±ç»ªï¼Œè·³è¿‡æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®');
                return;
            }

            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            // è¯»å–è°ƒè¯•é…ç½®
            const debugEnabled = configs.debug?.enabled || false;
            const logLevel = configs.debug?.logLevel || 'info';

            console.log('[InfoBarSettings] ğŸ“Š ä»é…ç½®è¯»å–æ—¥å¿—è®¾ç½®:', {
                enabled: debugEnabled,
                level: logLevel
            });

            // ç«‹å³åº”ç”¨æ—¥å¿—çº§åˆ«
            const effectiveLevel = debugEnabled ? logLevel : 'none';
            this.applyConsoleLogLevel(effectiveLevel);

            console.log('[InfoBarSettings] âœ… æ—©æœŸæ—¥å¿—çº§åˆ«è®¾ç½®å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨æ—©æœŸæ—¥å¿—çº§åˆ«å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
     */
    bindChatSwitchListener() {
        try {
            if (this.eventSystem) {
                // ç›‘å¬èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œæ¸…ç†æ€»ç»“æ˜¾ç¤ºçŠ¶æ€å¹¶åˆ·æ–°å†å²åˆ—è¡¨
                this.eventSystem.on('summary:chat:changed', (data) => {
                    if (data.action === 'chat_switched') {
                        console.log('[InfoBarSettings] ğŸ”„ æ”¶åˆ°èŠå¤©åˆ‡æ¢äº‹ä»¶ï¼Œæ¸…ç†æ€»ç»“æ˜¾ç¤ºçŠ¶æ€å¹¶åˆ·æ–°å†å²åˆ—è¡¨');
                        this.hideSummaryContent();
                        this.refreshSummaryHistoryOnChatSwitch();
                    }
                });

                console.log('[InfoBarSettings] âœ… èŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šèŠå¤©åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
    }

    /**
     * èŠå¤©åˆ‡æ¢æ—¶åˆ·æ–°æ€»ç»“å†å²
     */
    async refreshSummaryHistoryOnChatSwitch() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ èŠå¤©åˆ‡æ¢ï¼Œåˆ·æ–°æ€»ç»“å†å²åˆ—è¡¨');

            // æ£€æŸ¥æ€»ç»“é¢æ¿æ˜¯å¦å­˜åœ¨
            const summaryHistorySelect = this.modal?.querySelector('#content-summary-history-select');
            if (!summaryHistorySelect) {
                console.log('[InfoBarSettings] â„¹ï¸ æ€»ç»“å†å²é€‰æ‹©æ¡†ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°');
                return;
            }

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            // è·å–å½“å‰èŠå¤©çš„æ€»ç»“å†å²
            const summaryHistory = await summaryManager.getSummaryHistory();

            // é‡æ–°æ¸²æŸ“æ€»ç»“å†å²é€‰æ‹©æ¡†
            this.renderSummaryHistory(summaryHistory);

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²åˆ—è¡¨å·²åˆ·æ–°ï¼Œå½“å‰èŠå¤©æ€»ç»“æ•°é‡:', summaryHistory.length);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ‰“å¼€é”™è¯¯æ—¥å¿—çª—å£ï¼ˆä»…ä¸´æ—¶æ˜¾ç¤ºï¼Œä¸æŒä¹…åŒ–ï¼‰
     */
    openErrorLogModal() {
        try {
            const modal = document.createElement('div');
            modal.className = 'error-log-modal';
            modal.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                width: 600px; max-height: 500px; background: #1a1a1a; border: 2px solid #333;
                border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 20000;
                color: #e0e0e0; font-family: monospace;
            `;

            modal.innerHTML = `
                <div class="error-log-header" style="padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin: 0; color: #ff6b6b;">ğŸ“‹ ç¨‹åºæ—¥å¿—</h4>
                        <div style="margin-top: 5px;">
                            <label style="margin-right: 10px; font-size: 12px;">è¿‡æ»¤çº§åˆ«:</label>
                            <select id="log-level-filter" style="background: #333; color: #e0e0e0; border: 1px solid #555; padding: 2px 5px;">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="error">é”™è¯¯</option>
                                <option value="warn">è­¦å‘Š</option>
                                <option value="info">ä¿¡æ¯</option>
                                <option value="debug">è°ƒè¯•</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-small" data-action="close-error-log" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">å…³é—­</button>
                </div>
                <div class="error-log-body" style="padding: 15px; max-height: 350px; overflow: auto;">
                    <pre id="error-log-content" style="white-space: pre-wrap; margin: 0; font-size: 12px; line-height: 1.4;"></pre>
                </div>
            `;
            document.body.appendChild(modal);

            const updateLogs = () => {
                const filter = modal.querySelector('#log-level-filter').value;
                const logs = (window.SillyTavernInfobar?.runtimeLogs || [])
                    .filter(item => filter === 'all' || item.level === filter)
                    .map(item => {
                        const time = new Date(item.time).toLocaleString();
                        const levelIcon = {
                            error: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸', debug: 'ğŸ”§'
                        }[item.level] || 'ğŸ“';
                        return `[${time}] ${levelIcon} ${item.message}`;
                    })
                    .join('\n');
                modal.querySelector('#error-log-content').textContent = logs || 'æš‚æ— æ—¥å¿—è®°å½•';
            };

            // åˆå§‹åŠ è½½
            updateLogs();

            // ç»‘å®šè¿‡æ»¤å™¨å˜åŒ–
            modal.querySelector('#log-level-filter').addEventListener('change', updateLogs);

            // ç»‘å®šå…³é—­äº‹ä»¶
            modal.querySelector('[data-action="close-error-log"]').onclick = () => {
                if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
            };
        } catch (error) {
            const original = window.__InfobarConsoleOriginal;
            if (original) {
                original.error('[InfoBarSettings] âŒ æ‰“å¼€é”™è¯¯æ—¥å¿—çª—å£å¤±è´¥:', error);
            }
        }
    }

    /**
     * æ‰“å¼€é¡¹ç›®åœ°å€
     */
    openProjectLink() {
        try {
            window.open('https://github.com/loveyouguhan/Information-bar-integration-tool.git', '_blank');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€é¡¹ç›®åœ°å€å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨æ§åˆ¶å°æ—¥å¿—çº§åˆ«è¿‡æ»¤
     * level: 'none' | 'error' | 'warn' | 'info' | 'debug'
     */
    applyConsoleLogLevel(level) {
        try {
            // ä½¿ç”¨å…¨å±€é—¨ç¦ç³»ç»Ÿ
            const original = window.__InfobarConsoleOriginal;
            if (!original) {
                console.warn('[InfoBarSettings] âš ï¸ æ§åˆ¶å°é—¨ç¦æœªåˆå§‹åŒ–');
                return;
            }

            const rt = window.SillyTavernInfobar.runtimeLogs;
            const push = (logLevel, args) => {
                try {
                    const message = Array.from(args).map(v =>
                        typeof v === 'string' ? v :
                        typeof v === 'object' ? JSON.stringify(v) : String(v)
                    ).join(' ');
                    rt.push({ level: logLevel, time: Date.now(), message });
                    if (rt.length > 500) rt.shift();
                } catch {}
            };

            // æ ¹æ®çº§åˆ«è®¾ç½®è¿‡æ»¤å™¨
            const allows = {
                none: { error: false, warn: false, info: false, debug: false },
                error: { error: true, warn: false, info: false, debug: false },
                warn: { error: true, warn: true, info: false, debug: false },
                info: { error: true, warn: true, info: true, debug: false },
                debug: { error: true, warn: true, info: true, debug: true }
            }[level] || { error: true, warn: true, info: true, debug: true };

            // é‡æ–°ç»‘å®šconsoleæ–¹æ³•ï¼šæ—¢æ”¶é›†åˆæŒ‰çº§åˆ«è¾“å‡º
            console.log = (...args) => {
                push('debug', args);
                if (allows.debug) original.log(...args);
            };
            console.info = (...args) => {
                push('info', args);
                if (allows.info) original.info(...args);
            };
            console.warn = (...args) => {
                push('warn', args);
                if (allows.warn) original.warn(...args);
            };
            console.error = (...args) => {
                push('error', args);
                if (allows.error) original.error(...args);
            };

            // ä½¿ç”¨åŸç”Ÿconsoleè¾“å‡ºè®¾ç½®ç¡®è®¤
            if (level !== 'none') {
                original.info('[InfoBarSettings] ğŸ“Š æ—¥å¿—çº§åˆ«å·²è®¾ç½®ä¸º:', level);
            }
        } catch (error) {
            const original = window.__InfobarConsoleOriginal;
            if (original) {
                original.error('[InfoBarSettings] âŒ è®¾ç½®æ—¥å¿—çº§åˆ«å¤±è´¥:', error);
            }
        }
    }

    /**
     * ä¿å­˜å½“å‰é…ç½®ä¸ºå‘½åé…ç½®
     */
    async saveSettingsProfile() {
        try {
            const nameInput = this.modal.querySelector('#config-profile-name');
            const name = (nameInput?.value || '').trim();
            if (!name) { this.showMessage('è¯·è¾“å…¥é…ç½®åç§°', 'error'); return; }
            const configs = await this.configManager.getAllConfigs();
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            profiles[name] = configs;
            await this.configManager.setConfig('profiles', profiles, false);
            this.showMessage(`å·²ä¿å­˜é…ç½®: ${name}`, 'success');
            this.refreshProfilesSelect();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
            this.showMessage('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async loadSettingsProfile() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            const name = select?.value;
            if (!name) { this.showMessage('è¯·é€‰æ‹©è¦åŠ è½½çš„é…ç½®', 'error'); return; }
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            const profile = profiles[name];
            if (!profile) { this.showMessage('æœªæ‰¾åˆ°é…ç½®: ' + name, 'error'); return; }
            await this.configManager.setConfigs(profile);
            await this.loadSettings();
            this.showMessage(`å·²åŠ è½½é…ç½®: ${name}`, 'success');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
            this.showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async deleteSettingsProfile() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            const name = select?.value;
            if (!name) { this.showMessage('è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®', 'error'); return; }
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            if (!profiles[name]) { this.showMessage('æœªæ‰¾åˆ°é…ç½®: ' + name, 'error'); return; }
            delete profiles[name];
            await this.configManager.setConfig('profiles', profiles, false);
            this.showMessage(`å·²åˆ é™¤é…ç½®: ${name}`, 'success');
            this.refreshProfilesSelect();
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤é…ç½®å¤±è´¥:', error);
            this.showMessage('åˆ é™¤é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    async refreshProfilesSelect() {
        try {
            const select = this.modal.querySelector('#config-profile-select');
            if (!select) return;
            const profiles = (await this.configManager.getConfig('profiles')) || {};
            const current = select.value;
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªé…ç½®</option>' + Object.keys(profiles).map(name => `<option value="${name}">${name}</option>`).join('');
            if (profiles[current]) select.value = current;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°é…ç½®åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    /**
     * åˆå§‹åŒ–è®¾ç½®ç•Œé¢
     */
    async init() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š å¼€å§‹åˆå§‹åŒ–è®¾ç½®ç•Œé¢...');

            if (!this.configManager) {
                throw new Error('é…ç½®ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—
            await this.initializeCustomAPITaskQueue();

            // åˆ›å»ºUI
            this.createUI();

            // ğŸ”§ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åIDï¼ˆç¡®ä¿è®¾è®¡ä¸€è‡´æ€§ï¼‰
            this.migrateTimestampIdPanels();

            // åŠ è½½å½“å‰è®¾ç½®
            await this.loadSettings();

            // æ³¨æ„ï¼šäº‹ä»¶ç»‘å®šå·²åœ¨createUI()ä¸­çš„bindNewEvents()å®Œæˆï¼Œé¿å…é‡å¤ç»‘å®š

            this.initialized = true;

            // ğŸ”§ æ–°å¢ï¼šé¢„ç”Ÿæˆå­—æ®µæ˜ å°„ç¼“å­˜ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤ç”Ÿæˆ
            this.preloadCompleteDisplayNameMapping();

            console.log('[InfoBarSettings] âœ… è®¾ç½®ç•Œé¢åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—
     */
    async initializeCustomAPITaskQueue() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—...');

            // åŠ¨æ€å¯¼å…¥ä»»åŠ¡é˜Ÿåˆ—æ¨¡å—
            const { CustomAPITaskQueue } = await import('../core/CustomAPITaskQueue.js');

            // åˆ›å»ºä»»åŠ¡é˜Ÿåˆ—å®ä¾‹
            this.customAPITaskQueue = new CustomAPITaskQueue({
                infoBarSettings: this,
                eventSystem: this.eventSystem
            });

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è‡ªå®šä¹‰APIä»»åŠ¡é˜Ÿåˆ—å¤±è´¥:', error);
            // å¦‚æœä»»åŠ¡é˜Ÿåˆ—åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸæœ‰é€»è¾‘
            this.customAPITaskQueue = null;
        }
    }

    /**
     * åˆ›å»ºUIç•Œé¢
     */
    createUI() {
        try {
            // åˆ›å»ºæ¨¡æ€æ¡†å®¹å™¨
            this.modal = document.createElement('div');
            this.modal.id = 'info-bar-settings-modal';
            this.modal.className = 'info-bar-settings-modal infobar-modal-new';
            this.modal.style.display = 'none';

            this.modal.innerHTML = `
                <div class="modal-overlay" onclick="this.closest('.info-bar-settings-modal').style.display='none'"></div>
                <div class="modal-container">
                    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
                    <div class="modal-header">
                        <div class="header-left">
                            <h2>ä¿¡æ¯æ è®¾ç½®</h2>
                        </div>
                        <div class="header-right">
                            <div class="success-notification" style="display: block;">
                                <span class="success-text">ä¿¡æ¯æ ç³»ç»Ÿå·²æˆåŠŸåŠ è½½ï¼</span>
                            </div>
                            <button class="modal-close" onclick="this.closest('.info-bar-settings-modal').style.display='none'">Ã—</button>
                        </div>
                    </div>

                    <!-- ä¸»ä½“å†…å®¹åŒºåŸŸ -->
                    <div class="modal-body">
                        <!-- å·¦ä¾§å¯¼èˆªæ  -->
                        <div class="sidebar-nav">
                            <div class="nav-item active" data-nav="basic">
                                åŸºç¡€è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="api">
                                è‡ªå®šä¹‰API
                            </div>
                            <div class="nav-item" data-nav="promptSettings">
                                æç¤ºè¯è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="memoryEnhancement">
                                è®°å¿†å¢å¼º
                            </div>
                            <div class="nav-item" data-nav="panelManagement">
                                é¢æ¿ç®¡ç†
                            </div>
                            <div class="nav-item" data-nav="summary">
                                æ€»ç»“é¢æ¿
                            </div>
                            <div class="nav-item" data-nav="personal">
                                ä¸ªäººä¿¡æ¯
                            </div>
                            <div class="nav-item" data-nav="interaction">
                                äº¤äº’å¯¹è±¡
                            </div>
                            <div class="nav-item" data-nav="tasks">
                                ä»»åŠ¡ç³»ç»Ÿ
                            </div>
                            <div class="nav-item" data-nav="world">
                                ä¸–ç•Œä¿¡æ¯
                            </div>
                            <div class="nav-item" data-nav="organization">
                                ç»„ç»‡ä¿¡æ¯
                            </div>
                            <div class="nav-item" data-nav="news">
                                èµ„è®¯å†…å®¹
                            </div>
                            <div class="nav-item" data-nav="inventory">
                                èƒŒåŒ…ä»“åº“
                            </div>
                            <div class="nav-item" data-nav="abilities">
                                èƒ½åŠ›ç³»ç»Ÿ
                            </div>
                            <div class="nav-item" data-nav="plot">
                                å‰§æƒ…é¢æ¿
                            </div>
                            <div class="nav-item" data-nav="cultivation">
                                ä¿®ä»™ä¸–ç•Œ
                            </div>
                            <div class="nav-item" data-nav="fantasy">
                                ç„å¹»ä¸–ç•Œ
                            </div>
                            <div class="nav-item" data-nav="modern">
                                éƒ½å¸‚ç°ä»£
                            </div>
                            <div class="nav-item" data-nav="historical">
                                å†å²å¤ä»£
                            </div>
                            <div class="nav-item" data-nav="magic">
                                é­”æ³•èƒ½åŠ›
                            </div>
                            <div class="nav-item" data-nav="training">
                                è°ƒæ•™ç³»ç»Ÿ
                            </div>
                            <div class="nav-item" data-nav="theme">
                                ä¸»é¢˜è®¾ç½®
                            </div>
                            <div class="nav-item" data-nav="frontend-display">
                                å‰ç«¯æ˜¾ç¤º
                            </div>
                            <div class="nav-item" data-nav="advanced">
                                é«˜çº§è®¾ç½®
                            </div>

                            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
                            <div class="nav-bottom">
                                <!-- å·²ç§»é™¤æ¢å¤æ‰€æœ‰è®¾ç½®æŒ‰é’® -->
                            </div>
                        </div>

                        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
                        <div class="content-area">
                            <div class="content-panel active" data-content="basic">
                                ${this.createBasicPanelNew()}
                            </div>
                            <div class="content-panel" data-content="api">
                                ${this.createAPIPanel()}
                            </div>
                            <div class="content-panel" data-content="promptSettings">
                                ${this.createPromptSettingsPanel()}
                            </div>
                            <div class="content-panel" data-content="memoryEnhancement">
                                ${this.createMemoryEnhancementPanel()}
                            </div>
                            <div class="content-panel" data-content="panelManagement">
                                ${this.createPanelManagementPanel()}
                            </div>
                            <div class="content-panel" data-content="summary">
                                ${this.createSummaryPanel()}
                            </div>
                            <div class="content-panel" data-content="personal">
                                ${this.createPersonalPanel()}
                            </div>
                            <div class="content-panel" data-content="interaction">
                                ${this.createInteractionPanel()}
                            </div>
                            <div class="content-panel" data-content="tasks">
                                ${this.createTasksPanel()}
                            </div>
                            <div class="content-panel" data-content="world">
                                ${this.createWorldPanel()}
                            </div>
                            <div class="content-panel" data-content="organization">
                                ${this.createOrganizationPanel()}
                            </div>
                            <div class="content-panel" data-content="news">
                                ${this.createNewsPanel()}
                            </div>
                            <div class="content-panel" data-content="inventory">
                                ${this.createInventoryPanel()}
                            </div>
                            <div class="content-panel" data-content="abilities">
                                ${this.createAbilitiesPanel()}
                            </div>
                            <div class="content-panel" data-content="plot">
                                ${this.createPlotPanel()}
                            </div>
                            <div class="content-panel" data-content="cultivation">
                                ${this.createCultivationPanel()}
                            </div>
                            <div class="content-panel" data-content="fantasy">
                                ${this.createFantasyPanel()}
                            </div>
                            <div class="content-panel" data-content="modern">
                                ${this.createModernPanel()}
                            </div>
                            <div class="content-panel" data-content="historical">
                                ${this.createHistoricalPanel()}
                            </div>
                            <div class="content-panel" data-content="magic">
                                ${this.createMagicPanel()}
                            </div>
                            <div class="content-panel" data-content="training">
                                ${this.createTrainingPanel()}
                            </div>
                            <div class="content-panel" data-content="theme">
                                ${this.createThemePanel()}
                            </div>
                            <div class="content-panel" data-content="frontend-display">
                                ${this.createFrontendDisplayPanel()}
                            </div>
                            <div class="content-panel" data-content="advanced">
                                ${this.createAdvancedPanel()}
                            </div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨æ“ä½œæ  -->
                    <div class="modal-footer">
                        <div class="footer-left">
                            <span class="status-text">å°±ç»ª</span>
                        </div>
                        <div class="footer-right">
                            <button class="btn-cancel" data-action="close">å–æ¶ˆ</button>
                            <button class="btn-save" data-action="save">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(this.modal);

            // ç»‘å®šæ–°çš„äº‹ä»¶
            this.bindNewEvents();

            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼
            this.addButtonClickFixStyles();

            console.log('[InfoBarSettings] ğŸ¨ æ–°UIç•Œé¢åˆ›å»ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºUIå¤±è´¥:', error);
            throw error;
        }
    }
    /**
     * åˆ›å»ºæ–°çš„åŸºç¡€è®¾ç½®é¢æ¿ - å‚ç›´å¸ƒå±€
     */
    createBasicPanelNew() {
        return `
            <div class="content-header">
                <h3>åŸºç¡€åŠŸèƒ½é…ç½®</h3>
            </div>

            <div class="content-body">


                <!-- å‚ç›´å¸ƒå±€çš„åŠŸèƒ½é…ç½® -->
                <div class="basic-settings-vertical">
                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="integration-system-checkbox" name="basic.integrationSystem.enabled" checked />
                            <label for="integration-system-checkbox" class="checkbox-label">å¯ç”¨æ’ä»¶</label>
                        </div>
                        <div class="setting-desc">å¯ç”¨ä¿¡æ¯æ æ’ä»¶çš„æ‰€æœ‰åŠŸèƒ½</div>
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="render-in-chat-checkbox" name="basic.renderInChat.enabled" checked />
                            <label for="render-in-chat-checkbox" class="checkbox-label">åœ¨èŠå¤©ä¸­æ¸²æŸ“ä¿¡æ¯æ </label>
                        </div>
                        <div class="setting-desc">åœ¨èŠå¤©ç•Œé¢ä¸­æ˜¾ç¤ºä¿¡æ¯æ å†…å®¹</div>
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="table-records-checkbox" name="basic.tableRecords.enabled" />
                            <label for="table-records-checkbox" class="checkbox-label">å¯ç”¨è¡¨æ ¼è®°å½•</label>
                        </div>
                        <div class="setting-desc">å¯ç”¨æ•°æ®è¡¨æ ¼è®°å½•å’Œç®¡ç†åŠŸèƒ½</div>
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="memory-assist-checkbox" name="basic.memoryAssist.enabled" checked />
                            <label for="memory-assist-checkbox" class="checkbox-label">å¯ç”¨è®°å¿†è¾…åŠ©</label>
                        </div>
                        <div class="setting-desc">AIè®°å¿†è¾…åŠ©å’Œä¸Šä¸‹æ–‡ç®¡ç†</div>
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="default-collapsed-checkbox" name="basic.defaultCollapsed.enabled" />
                            <label for="default-collapsed-checkbox" class="checkbox-label">ä¿¡æ¯æ é»˜è®¤æŠ˜å </label>
                        </div>
                        <div class="setting-desc">å¯åŠ¨æ—¶ä¿¡æ¯æ é»˜è®¤ä¸ºæŠ˜å çŠ¶æ€</div>
                    </div>

                    <div class="setting-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="error-logging-checkbox" name="basic.errorLogging.enabled" checked />
                            <label for="error-logging-checkbox" class="checkbox-label">é”™è¯¯æ—¥å¿—</label>
                        </div>
                        <div class="setting-desc">å¯ç”¨è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•</div>
                    </div>

                    <!-- æç¤ºè¯æ’å…¥ä½ç½®é…ç½® -->
                    <div class="setting-item">
                        <div class="setting-group">
                            <h4>ğŸ“ æç¤ºè¯æ’å…¥ä½ç½®</h4>
                            <div class="setting-desc" style="margin-bottom: 12px;">é€‰æ‹©ä¿¡æ¯æ æç¤ºè¯åœ¨å¯¹è¯ä¸­çš„æ’å…¥ä½ç½®ï¼Œä¸åŒä½ç½®å¯¹å¯¹è¯çš„å½±å“ç¨‹åº¦ä¸åŒã€‚</div>

                            <div class="prompt-position-config">
                                <div class="form-group">
                                    <label for="prompt-position-mode" class="control-label">æ’å…¥ä½ç½®</label>
                                    <select id="prompt-position-mode" name="basic.promptPosition.mode" class="form-control">
                                        <option value="afterCharacter">è§’è‰²å®šä¹‰ä¹‹å</option>
                                        <option value="beforeCharacter">è§’è‰²å®šä¹‰ä¹‹å‰</option>
                                        <option value="atDepthSystem">@ Dâš™ï¸ - ç³»ç»Ÿè§’è‰²æ¶ˆæ¯</option>
                                        <option value="atDepthUser">@ DğŸ‘¤ - ç”¨æˆ·è§’è‰²æ¶ˆæ¯</option>
                                        <option value="atDepthAssistant">@ DğŸ¤– - åŠ©æ‰‹è§’è‰²æ¶ˆæ¯</option>
                                    </select>
                                </div>

                                <div class="form-group depth-control" style="display: none;">
                                    <label for="prompt-position-depth" class="control-label">æ’å…¥æ·±åº¦</label>
                                    <input type="number" id="prompt-position-depth" name="basic.promptPosition.depth"
                                           class="form-control" min="0" max="10" value="0" step="1">
                                    <div class="setting-desc">æ·±åº¦ 0 ä¸ºæç¤ºè¯åº•éƒ¨ï¼Œæ•°å­—è¶Šå¤§è¶Šé å‰</div>
                                </div>

                                <div class="position-description">
                                    <div id="position-desc-afterCharacter" class="desc-item active">
                                        <span class="desc-impact">ğŸ”¸ è¾ƒå¤§å½±å“</span>
                                        åœ¨è§’è‰²æè¿°å’Œåœºæ™¯ä¹‹åæ’å…¥æ­¤æç¤ºè¯ã€‚å¯¹å¯¹è¯æœ‰æ›´å¤§å½±å“ã€‚
                                    </div>
                                    <div id="position-desc-beforeCharacter" class="desc-item">
                                        <span class="desc-impact">ğŸ”¹ ä¸­ç­‰å½±å“</span>
                                        åœ¨è§’è‰²æè¿°å’Œåœºæ™¯ä¹‹å‰æ’å…¥æ­¤æç¤ºè¯ã€‚å¯¹å¯¹è¯æœ‰ä¸­ç­‰å½±å“ã€‚
                                    </div>
                                    <div id="position-desc-atDepth" class="desc-item">
                                        <span class="desc-impact">ğŸ”§ ç²¾ç¡®æ§åˆ¶</span>
                                        å°†ä¿¡æ¯æ æç¤ºè¯æ’å…¥åˆ°èŠå¤©ä¸­çš„ç‰¹å®šæ·±åº¦å’Œè§’è‰²ç±»å‹ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†å·¥å…·åŒºåŸŸ -->
                <div class="settings-group">
                    <h4>ğŸ› ï¸ ç®¡ç†å·¥å…·</h4>
                    <div class="management-tools">
                        <button class="btn btn-primary" id="variable-manager-btn" data-action="open-variable-manager">
                            <i class="fa fa-code"></i>
                            å˜é‡ç®¡ç†å™¨
                        </button>
                        <button class="btn btn-secondary" id="npc-management-btn" data-action="open-npc-management" style="margin-left:8px;">
                            <i class="fa fa-users"></i>
                            NPCç®¡ç†
                        </button>
                        <div class="tool-desc">ç®¡ç†å…¨å±€å˜é‡ã€å®å®šä¹‰å’Œè‡ªå®šä¹‰å‡½æ•°ï¼›æ‰“å¼€NPCæ•°æ®åº“ç®¡ç†ç•Œé¢</div>
                    </div>
                </div>
            </div>
        `;
        // è¿½åŠ è½»é‡æ ·å¼ï¼Œç¡®ä¿é€‰æ‹©æ¡†ä¸åˆ é™¤æŒ‰é’®åŒæ’ä¸”ä¸é®æŒ¡
        const style = document.createElement('style');
        style.id = 'info-bar-settings-summary-inline-style';
        if (!document.getElementById(style.id)) {
            style.textContent = `
                .history-selector-group .history-select-row {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .history-selector-group .summary-history-select {
                    flex: 1 1 auto;
                    min-width: 0;
                    max-width: calc(100% - 90px);
                }
                #content-delete-summary-btn {
                    flex: 0 0 auto;
                    white-space: nowrap;
                }
                /* è°ƒè¯•ä¸é…ç½®è¡Œå¸ƒå±€ä¼˜åŒ– */
                .debug-actions-row { display: flex; gap: 8px; }
                .config-primary-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .config-row { display: flex; align-items: center; gap: 8px; }
                .config-row .setting-select { flex: 1 1 auto; min-width: 0; }
                .config-row-actions { display: flex; gap: 6px; }

                /* æ•°æ®ç®¡ç†åŠŸèƒ½åŒºåŸŸæ ·å¼ */
                .data-management-actions {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 12px !important;
                    margin-top: 8px !important;
                    width: 100% !important;
                }
                .data-export-btn, .data-import-btn {
                    flex: 1 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 6px !important;
                    padding: 10px 16px !important;
                    border: none !important;
                    border-radius: 6px !important;
                    font-size: 14px !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    min-height: 40px !important;
                    white-space: nowrap !important;
                }
                .data-export-btn {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    color: white !important;
                }
                .data-export-btn:hover {
                    background: var(--theme-primary-hover, #e55a2b) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3) !important;
                }
                .data-import-btn {
                    background: var(--theme-bg-secondary, #4a5568) !important;
                    color: white !important;
                    border: 1px solid var(--theme-border-color, #666) !important;
                }
                .data-import-btn:hover {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2) !important;
                }
                .data-management-hint {
                    color: var(--theme-text-secondary, #a0a0a0) !important;
                    font-size: 13px !important;
                    line-height: 1.4 !important;
                    margin-top: 8px !important;
                    padding: 8px 12px !important;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.1)) !important;
                    border-radius: 4px !important;
                    border-left: 3px solid var(--theme-primary-color, #ff6b35) !important;
                }

                /* æç¤ºè¯æ’å…¥ä½ç½®é…ç½®æ ·å¼ */
                .prompt-position-config {
                    margin-top: 12px;
                    padding: 16px;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.05));
                    border-radius: 8px;
                    border: 1px solid var(--theme-border-color, #e2e8f0);
                }
                .prompt-position-config .form-group {
                    margin-bottom: 16px;
                }
                .prompt-position-config .control-label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                    color: var(--theme-text-primary, #333);
                }
                .prompt-position-config .form-control {
                    width: 100%;
                    padding: 8px 12px;
                    border: 1px solid var(--theme-border-color, #d1d5db);
                    border-radius: 4px;
                    background: var(--theme-bg-primary, #fff);
                    color: var(--theme-text-primary, #333);
                }
                .position-description {
                    margin-top: 12px;
                    padding: 12px;
                    background: var(--theme-bg-primary, #fff);
                    border-radius: 6px;
                    border: 1px solid var(--theme-border-color, #e2e8f0);
                }
                .position-description .desc-item {
                    display: none;
                    line-height: 1.5;
                    color: var(--theme-text-primary, #333);
                }
                .position-description .desc-item.active {
                    display: block;
                }
                .desc-impact {
                    display: inline-block;
                    padding: 2px 8px;
                    margin-right: 8px;
                    font-size: 12px;
                    font-weight: 600;
                    border-radius: 12px;
                    background: var(--theme-primary-color, #ff6b35);
                    color: white;
                }
                .depth-control {
                    padding: 12px;
                    background: var(--theme-bg-accent, #f8fafc);
                    border-radius: 6px;
                    border-left: 4px solid var(--theme-primary-color, #ff6b35);
                }
            `;
            document.head.appendChild(style);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼
     */
    addButtonClickFixStyles() {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ ·å¼
            if (document.getElementById('infobar-button-click-fix-styles')) {
                return;
            }

            const style = document.createElement('style');
            style.id = 'infobar-button-click-fix-styles';
            style.textContent = `
                /* ğŸ”§ ä¿®å¤æŒ‰é’®ç‚¹å‡»åŒºåŸŸé—®é¢˜ */
                .info-bar-settings-modal button {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                }

                .info-bar-settings-modal button * {
                    pointer-events: none;
                    user-select: none;
                }

                .info-bar-settings-modal button:disabled {
                    pointer-events: none;
                    cursor: not-allowed;
                }

                .info-bar-settings-modal button:not(:disabled) {
                    pointer-events: auto;
                }

                /* ç¡®ä¿æŒ‰é’®å†…å®¹ä¸ä¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶ */
                .info-bar-settings-modal .btn-icon,
                .info-bar-settings-modal .btn-text {
                    pointer-events: none !important;
                    display: inline-block;
                }

                /* æ¨¡æ€æ¡†æŒ‰é’®æ ·å¼ä¿®å¤ */
                .delete-confirm-dialog button,
                .save-confirm-dialog button {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                    pointer-events: auto;
                }

                .delete-confirm-dialog button *,
                .save-confirm-dialog button * {
                    pointer-events: none;
                    user-select: none;
                }

                /* ğŸ”§ ä¿®å¤ï¼šè‡ªå®šä¹‰å­é¡¹åˆ é™¤æŒ‰é’®æ ·å¼ä¿®å¤ */
                .info-bar-settings-modal .btn-remove-sub-item {
                    position: relative;
                    cursor: pointer;
                    user-select: none;
                    pointer-events: auto !important;
                    background: none;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    transition: background-color 0.2s;
                }

                .info-bar-settings-modal .btn-remove-sub-item:hover {
                    background-color: rgba(255, 0, 0, 0.1);
                }

                .info-bar-settings-modal .btn-remove-sub-item * {
                    pointer-events: none !important;
                    user-select: none;
                }
            `;

            document.head.appendChild(style);
            console.log('[InfoBarSettings] âœ… æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼å·²æ·»åŠ ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ æŒ‰é’®ç‚¹å‡»åŒºåŸŸä¿®å¤æ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´
     */
    handlePromptPositionModeChange(mode) {
        try {
            const depthControl = this.modal.querySelector('.depth-control');
            const descriptions = this.modal.querySelectorAll('.position-description .desc-item');

            // æ˜¾ç¤º/éšè—æ·±åº¦æ§åˆ¶
            if (mode.startsWith('atDepth')) {
                depthControl.style.display = 'block';
            } else {
                depthControl.style.display = 'none';
            }

            // æ›´æ–°æè¿°æ–‡æœ¬
            descriptions.forEach(desc => desc.classList.remove('active'));

            if (mode === 'beforeCharacter') {
                this.modal.querySelector('#position-desc-beforeCharacter')?.classList.add('active');
            } else if (mode === 'afterCharacter') {
                this.modal.querySelector('#position-desc-afterCharacter')?.classList.add('active');
            } else if (mode.startsWith('atDepth')) {
                this.modal.querySelector('#position-desc-atDepth')?.classList.add('active');
            }

            console.log(`[InfoBarSettings] ğŸ“ æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´ä¸º: ${mode}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æç¤ºè¯ä½ç½®æ¨¡å¼å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šæ–°çš„äº‹ä»¶å¤„ç†
     */
    bindNewEvents() {
        try {
            // å¯¼èˆªåˆ‡æ¢äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                if (e.target.closest('.nav-item')) {
                    const navItem = e.target.closest('.nav-item');
                    const navType = navItem.dataset.nav;
                    this.switchToContent(navType);
                }
            });

            // æç¤ºè¯ä½ç½®é…ç½®äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.id === 'prompt-position-mode') {
                    this.handlePromptPositionModeChange(e.target.value);
                }
            });

            // ğŸ†• ç ´ç”²æç¤ºè¯æ–‡æœ¬æ¡†äº‹ä»¶
            this.modal.addEventListener('input', (e) => {
                if (e.target.id === 'armor-breaking-prompt') {
                    this.updateArmorBreakingStats();
                }
            });

            this.modal.addEventListener('keyup', (e) => {
                if (e.target.id === 'armor-breaking-prompt') {
                    this.updateArmorBreakingStats();
                }
            });

            // ğŸ§  æç¤ºè¯è®¾ç½®äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.name === 'promptSettings.mode') {
                    this.handlePromptModeChange(e.target.value);
                }
            });

            this.modal.addEventListener('input', (e) => {
                if (e.target.id === 'custom-prompt-content') {
                    this.updateCustomPromptStats();
                }
            });

            this.modal.addEventListener('keyup', (e) => {
                if (e.target.id === 'custom-prompt-content') {
                    this.updateCustomPromptStats();
                }
            });

            this.modal.addEventListener('click', (e) => {
                if (e.target.id === 'refresh-preview-btn') {
                    this.refreshPromptPreview();
                }
            });

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨closestæŸ¥æ‰¾å…·æœ‰data-actionå±æ€§çš„çˆ¶å…ƒç´ ï¼Œè§£å†³æŒ‰é’®å†…å­å…ƒç´ ç‚¹å‡»é—®é¢˜
                const actionElement = e.target.closest('[data-action]');
                const action = actionElement?.dataset?.action;

                // ğŸ”§ æ–°å¢ï¼šè¯¦ç»†çš„ç‚¹å‡»äº‹ä»¶è°ƒè¯•ä¿¡æ¯
                if (e.target.closest('button') || actionElement) {
                    console.log('[InfoBarSettings] ğŸ–±ï¸ æŒ‰é’®ç‚¹å‡»äº‹ä»¶:', {
                        target: e.target.tagName + (e.target.className ? '.' + e.target.className : ''),
                        actionElement: actionElement?.tagName + (actionElement?.className ? '.' + actionElement.className : ''),
                        action: action,
                        targetText: e.target.textContent?.trim(),
                        targetParent: e.target.parentElement?.tagName
                    });
                }

                if (action) {
                    // ğŸ”§ ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢é‡å¤è§¦å‘
                    e.preventDefault();
                    e.stopPropagation();
                    this.handleAction(action, e);
                }

                // APIé…ç½®ç›¸å…³æŒ‰é’®
                if (e.target.id === 'load-models-btn') {
                    this.loadModelList();
                }
                if (e.target.id === 'test-connection-btn') {
                    this.testConnection();
                }

            // ğŸ†• ç ´ç”²æç¤ºè¯æ–‡æœ¬æ¡†å­—ç¬¦ç»Ÿè®¡
            if (e.target.id === 'armor-breaking-prompt') {
                this.updateArmorBreakingStats();
            }

                // ä¸»é¢˜é¢„è§ˆå¡ç‰‡ç‚¹å‡»äº‹ä»¶
                const themeCard = e.target.closest('.theme-preview-card');
                if (themeCard) {
                    const themeId = themeCard.dataset.theme;
                    if (themeId) {
                        this.selectTheme(themeId);
                    }
                }

                // ä¿¡æ¯æ é£æ ¼é¢„è§ˆå¡ç‰‡ç‚¹å‡»äº‹ä»¶
                const styleCard = e.target.closest('.style-preview-card');
                if (styleCard) {
                    const styleId = styleCard.dataset.style;
                    if (styleId) {
                        this.selectStyle(styleId);
                    }
                }

                // é¢æ¿ç®¡ç†ç›¸å…³äº‹ä»¶
                this.handlePanelManagementEvents(e);

                // å‰ç«¯æ˜¾ç¤ºç›¸å…³äº‹ä»¶
                this.handleFrontendDisplayEvents(e);
            });

            // ä¸‹æ‹‰æ¡†å˜æ›´äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    this.handleCheckboxChange(e);
                }

                // å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´
                if (e.target.name && e.target.name.startsWith('frontendDisplay.')) {
                    this.handleFrontendDisplayChange(e);
                }

                // APIå¯ç”¨å¼€å…³å˜æ›´
                if (e.target.id === 'api-enabled') {
                    this.handleAPIEnabledChange(e.target.checked);
                }

                // APIæä¾›å•†å˜æ›´
                if (e.target.id === 'api-provider') {
                    this.handleProviderChange(e.target.value);
                }

                // æ¥å£ç±»å‹å˜æ›´
                if (e.target.id === 'interface-type') {
                    this.handleInterfaceTypeChange(e.target.value);
                }

                // å­—ä½“å¤§å°å’Œä¿¡æ¯æ é«˜åº¦å…³è”
                if (e.target.name === 'theme.fontSize') {
                    this.handleFontSizeChange(e.target.value);
                }
                if (e.target.name === 'infobar.height') {
                    this.handleInfobarHeightChange(e.target.value);
                }
            });

            // èŒƒå›´è¾“å…¥å®æ—¶æ›´æ–°
            this.modal.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan && valueSpan.classList.contains('range-value')) {
                        valueSpan.textContent = e.target.value;
                    }
                }
            });

            console.log('[InfoBarSettings] ğŸ”— æ–°äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šæ–°äº‹ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†é¢æ¿ç®¡ç†ç›¸å…³äº‹ä»¶
     */
    handlePanelManagementEvents(e) {
        try {
            // é¢æ¿åˆ†ç±»æ ‡ç­¾åˆ‡æ¢ï¼ˆç®€åŒ–ï¼šåªæœ‰å…¨éƒ¨é¢æ¿ï¼Œæ— éœ€åˆ‡æ¢ï¼‰
            const categoryTab = e.target.closest('.category-tab');
            if (categoryTab) {
                // åªæœ‰å…¨éƒ¨é¢æ¿åˆ†ç±»ï¼Œæ— éœ€åˆ‡æ¢é€»è¾‘
                return;
            }

            // é¢æ¿åˆ—è¡¨é¡¹é€‰æ‹©
            const panelListItem = e.target.closest('.panel-list-item');
            if (panelListItem) {
                const panelId = panelListItem.dataset.panelId;
                const panelType = panelListItem.dataset.panelType;

                console.log('[InfoBarSettings] ğŸ¯ é¢æ¿åˆ—è¡¨é¡¹ç‚¹å‡»:', { panelId, panelType });

                // ğŸ”§ ä¿®å¤ï¼šéªŒè¯é¢æ¿æ•°æ®æœ‰æ•ˆæ€§
                if (panelId && panelType) {
                    this.selectPanelForEdit(panelId, panelType);
                } else {
                    console.error('[InfoBarSettings] âŒ é¢æ¿åˆ—è¡¨é¡¹æ•°æ®æ— æ•ˆ:', { panelId, panelType });
                }
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šé¢æ¿ç®¡ç†æŒ‰é’®äº‹ä»¶ï¼Œä½¿ç”¨closestæŸ¥æ‰¾æŒ‰é’®å…ƒç´ 
            const actionButton = e.target.closest('[data-action]');
            const action = actionButton?.dataset?.action;
            const panelId = actionButton?.dataset?.panelId;

            switch (action) {
                case 'add-custom-panel':
                    this.addCustomPanel();
                    break;
                case 'refresh-panels':
                    this.refreshPanelList();
                    break;
                case 'edit-panel':
                    this.editPanel(panelId);
                    break;
                case 'view-panel':
                    this.viewPanel(panelId);
                    break;
                case 'open-html-editor':
                    this.openHTMLTemplateEditor();
                    break;
                case 'duplicate-panel':
                    this.duplicatePanel(panelId);
                    break;
                case 'toggle-panel':
                    this.togglePanel(panelId);
                    break;
                case 'save-panel-properties':
                    this.savePanelProperties();
                    break;
                case 'delete-panel':
                    this.deletePanel();
                    break;
                case 'add-sub-item':
                    this.addSubItem();
                    break;
                case 'remove-sub-item':
                    this.removeSubItem(e?.target?.closest('[data-action="remove-sub-item"]') || e?.target);
                    break;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é¢æ¿ç®¡ç†äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†å‰ç«¯æ˜¾ç¤ºç›¸å…³äº‹ä»¶
     */
    handleFrontendDisplayEvents(e) {
        try {
            const action = e.target.dataset.action;

            switch (action) {
                case 'test-panel-popup':
                    this.testPanelPopup();
                    break;
                case 'test-add-panel':
                    // ç§»é™¤é¢„è§ˆç¤ºä¾‹å…¥å£ï¼šè½¬ä¸ºçœŸæ­£è°ƒç”¨ FrontendDisplayManager çš„æ·»åŠ é€»è¾‘
                    try {
                        const infoBarTool = window.SillyTavernInfobar;
                        const fdm = infoBarTool?.modules?.frontendDisplayManager;
                        if (fdm) {
                            // æ¨¡æ‹Ÿåœ¨å½“å‰æœ€åä¸€æ¡AIæ¶ˆæ¯ä¸Šæ‰“å¼€æ·»åŠ èœå•
                            const lastAi = [...document.querySelectorAll('.mes[data-is-user="false"]')].pop();
                            if (lastAi) {
                                fdm.wrapAIMessage(lastAi);
                                const wrapper = fdm.wrappers.get(lastAi.id);
                                const anySlot = wrapper?.querySelector('.add-slot') || wrapper;
                                fdm.showAddPanelMenu('top-1', anySlot, lastAi);
                            }
                        }
                    } catch (_) {}
                    break;
                case 'clear-preview':
                    this.clearPreviewContent();
                    break;
            }

            // å¤„ç†æ·»åŠ æ§½ä½ç‚¹å‡»
            const addSlot = e.target.closest('.add-slot');
            if (addSlot) {
                const position = addSlot.dataset.position;
                this.showAddPanelMenu(position, addSlot);
                return;
            }

            // å¤„ç†æ¼”ç¤ºé¢æ¿æŒ‰é’®ç‚¹å‡»
            const panelButton = e.target.closest('.panel-button.demo');
            if (panelButton) {
                const panelType = panelButton.dataset.panel;
                this.showDemoPanelPopup(panelType);
                return;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰ç«¯æ˜¾ç¤ºäº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´
     */
    handleFrontendDisplayChange(e) {
        try {
            const name = e.target.name;
            const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

            console.log(`[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´: ${name} = ${value}`);

            // æ ¹æ®è®¾ç½®åç§°å¤„ç†ä¸åŒçš„å˜æ›´
            switch (name) {
                case 'frontendDisplay.enabled':
                    this.toggleFrontendDisplaySections(value);
                    this.enableFrontendDisplay(value);
                    break;
                case 'frontendDisplay.position':
                    this.updatePreviewPosition(value);
                    break;
                case 'frontendDisplay.style':
                    this.updatePreviewStyle(value);
                    break;
                case 'frontendDisplay.showAddButtons':
                    this.toggleAddButtons(value);
                    break;
                case 'frontendDisplay.animationEnabled':
                    this.toggleAnimations(value);
                    break;
                default:
                    console.log(`[InfoBarSettings] ğŸ“ ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®: ${name}`);
                    break;
            }

            // ä¿å­˜è®¾ç½®åˆ°é…ç½®ä¸­
            this.saveFrontendDisplaySetting(name, value);

            // æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨çš„è®¾ç½®
            this.updateFrontendDisplayManagerSettings();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®åˆ°é…ç½®ä¸­
     */
    async saveFrontendDisplaySetting(name, value) {
        try {
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è¯»å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();

            // æ›´æ–°å¯¹åº”çš„è®¾ç½®é¡¹
            const settingKey = name.replace('frontendDisplay.', '');
            currentConfig[settingKey] = value;

            // ä¿å­˜é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            console.log(`[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®: ${settingKey} = ${value}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜å‰ç«¯æ˜¾ç¤ºè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * å¯ç”¨/ç¦ç”¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½
     */
    enableFrontendDisplay(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ”„ ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½`);

            // è·å–å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const frontendDisplayManager = infoBarTool?.modules?.frontendDisplayManager;

            if (frontendDisplayManager) {
                frontendDisplayManager.setEnabled(enabled);
                console.log(`[InfoBarSettings] âœ… å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);

                // å¦‚æœç¦ç”¨ï¼Œè¿˜éœ€è¦æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
                if (!enabled) {
                    this.restoreOriginalInfoBarRendering();
                } else {
                    this.disableOriginalInfoBarRendering();
                }
            } else {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯ç”¨/ç¦ç”¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨è®¾ç½®
     */
    updateFrontendDisplayManagerSettings() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const frontendDisplayManager = infoBarTool?.modules?.frontendDisplayManager;

            if (frontendDisplayManager) {
                // æ”¶é›†å½“å‰è®¾ç½®
                const settings = this.collectFrontendDisplaySettings();
                frontendDisplayManager.updateSettings(settings);
                console.log('[InfoBarSettings] âš™ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®å·²æ›´æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ”¶é›†å‰ç«¯æ˜¾ç¤ºè®¾ç½®
     */
    collectFrontendDisplaySettings() {
        const settings = {};

        try {
            const modal = this.modal;
            if (modal) {
                const inputs = modal.querySelectorAll('[name^="frontendDisplay."]');
                inputs.forEach(input => {
                    const key = input.name.replace('frontendDisplay.', '');
                    settings[key] = input.type === 'checkbox' ? input.checked : input.value;
                });
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å‰ç«¯æ˜¾ç¤ºè®¾ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
     */
    disableOriginalInfoBarRendering() {
        try {
            console.log('[InfoBarSettings] ğŸš« ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“');

            const infoBarTool = window.SillyTavernInfobar;
            const messageInfoBarRenderer = infoBarTool?.modules?.messageInfoBarRenderer;

            if (messageInfoBarRenderer) {
                // ä¸´æ—¶ç¦ç”¨ä¿¡æ¯æ æ¸²æŸ“å™¨
                messageInfoBarRenderer.frontendDisplayMode = true;
                console.log('[InfoBarSettings] âœ… åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å·²ç¦ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¦ç”¨åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å¤±è´¥:', error);
        }
    }

    /**
     * æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“
     */
    restoreOriginalInfoBarRendering() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“');

            const infoBarTool = window.SillyTavernInfobar;
            const messageInfoBarRenderer = infoBarTool?.modules?.messageInfoBarRenderer;

            if (messageInfoBarRenderer) {
                messageInfoBarRenderer.frontendDisplayMode = false;
                console.log('[InfoBarSettings] âœ… åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å·²æ¢å¤');
            }

            // æ˜¾ç¤ºè¢«éšè—çš„ä¿¡æ¯æ 
            const hiddenInfoBars = document.querySelectorAll('.message-infobar[style*="display: none"], .infobar-panel[style*="display: none"]');
            hiddenInfoBars.forEach(infoBar => {
                infoBar.style.display = '';
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¢å¤åŸæœ‰ä¿¡æ¯æ æ¸²æŸ“å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢å‰ç«¯æ˜¾ç¤ºç›¸å…³è®¾ç½®åŒºåŸŸçš„æ˜¾ç¤ºçŠ¶æ€
     */
    toggleFrontendDisplaySections(enabled) {
        try {
            const configSection = this.modal.querySelector('.frontend-display-config');
            const previewSection = this.modal.querySelector('.frontend-display-preview');
            const advancedSection = this.modal.querySelector('.frontend-display-advanced');

            if (configSection) {
                configSection.style.display = enabled ? 'block' : 'none';
            }
            if (previewSection) {
                previewSection.style.display = enabled ? 'block' : 'none';
            }
            if (advancedSection) {
                advancedSection.style.display = enabled ? 'block' : 'none';
            }

            console.log(`[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºåŒºåŸŸåˆ‡æ¢: ${enabled ? 'æ˜¾ç¤º' : 'éšè—'}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢å‰ç«¯æ˜¾ç¤ºåŒºåŸŸå¤±è´¥:', error);
        }
    }

    /**
     * æµ‹è¯•é¢æ¿å¼¹çª—
     */
    testPanelPopup() {
        try {
            console.log('[InfoBarSettings] ğŸ§ª æµ‹è¯•é¢æ¿å¼¹çª—');

            // åˆ›å»ºæ¨¡æ‹Ÿçš„é¢æ¿å¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'demo-panel-popup';
            popup.style.setProperty('position', 'fixed', 'important');
            popup.style.setProperty('top', '0', 'important');
            popup.style.setProperty('left', '0', 'important');
            popup.style.setProperty('right', '0', 'important');
            popup.style.setProperty('bottom', '0', 'important');
            popup.style.setProperty('width', '100vw', 'important');
            popup.style.setProperty('height', '100vh', 'important');
            popup.style.setProperty('display', 'flex', 'important');
            popup.style.setProperty('align-items', 'center', 'important');
            popup.style.setProperty('justify-content', 'center', 'important');
            popup.style.setProperty('z-index', '10000', 'important');
            popup.style.setProperty('background', 'rgba(0,0,0,0.5)', 'important');

            popup.innerHTML = `
                <div class="demo-popup-content" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    min-width: 300px;
                    max-width: 90vw;
                    min-height: 200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    position: relative;
                    margin: 0;
                ">
                    <div class="demo-popup-header">
                        <h3>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                        <button class="demo-close-btn">Ã—</button>
                    </div>
                    <div class="demo-popup-body">
                        <div class="demo-field">
                            <span class="field-label">å§“å:</span>
                            <span class="field-value">å¼ ä¸‰</span>
                        </div>
                        <div class="demo-field">
                            <span class="field-label">å¹´é¾„:</span>
                            <span class="field-value">25</span>
                        </div>
                        <div class="demo-field">
                            <span class="field-label">èŒä¸š:</span>
                            <span class="field-value">ç¨‹åºå‘˜</span>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 3000);

            // ç‚¹å‡»å…³é—­æŒ‰é’®
            popup.querySelector('.demo-close-btn').addEventListener('click', () => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•é¢æ¿å¼¹çª—å¤±è´¥:', error);
        }
    }

    /**
     * æµ‹è¯•æ·»åŠ é¢æ¿
     */
    testAddPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ§ª æµ‹è¯•æ·»åŠ é¢æ¿');

            // åˆ›å»ºæ·»åŠ é¢æ¿çš„é€‰æ‹©èœå•
            const menu = document.createElement('div');
            menu.className = 'demo-add-panel-menu';
            menu.innerHTML = `
                <div class="demo-menu-content">
                    <div class="menu-header">
                        <h3>æ·»åŠ åˆ°${area === 'top' ? 'é¡¶éƒ¨' : 'åº•éƒ¨'}åŒºåŸŸ</h3>
                        <button class="menu-close-btn">&times;</button>
                    </div>
                    <div class="menu-body">
                        <div class="menu-layout">
                            <!-- å·¦ä¾§é¢æ¿å¯¼èˆª -->
                            <div class="panel-navigation">
                                <h4>ğŸ“‹ å¯ç”¨çš„é¢æ¿ (${Object.keys(enabledPanels).length})</h4>
                                <div class="panel-list">
                                    ${panelListHtml}
                                </div>
                            </div>

                            <!-- å³ä¾§å­é¡¹åˆ—è¡¨ -->
                            <div class="subitem-list">
                                ${subitemListHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // å®šä½èœå•ï¼ˆç§»åŠ¨ç«¯å…¨å±é®ç½©ï¼Œæ¡Œé¢ç«¯å±…ä¸­ï¼‰
            const isMobile = window.innerWidth <= 768;
            menu.style.position = 'fixed';
            menu.style.zIndex = '10000';
            if (isMobile) {
                // å…¨å±é®ç½©
                menu.style.left = '0';
                menu.style.top = '0';
                menu.style.width = '100vw';
                menu.style.height = '100vh';
                menu.style.background = 'rgba(0, 0, 0, 0.5)';
                menu.style.backdropFilter = 'blur(4px)';
                menu.style.display = 'flex';
                menu.style.alignItems = 'center';
                menu.style.justifyContent = 'center';

                // å†…å®¹å®¹å™¨é™åˆ¶å°ºå¯¸å¹¶å±…ä¸­
                const menuContent = menu.querySelector('.demo-menu-content');
                if (menuContent) {
                    menuContent.style.width = '90vw';
                    menuContent.style.maxWidth = '360px';
                    menuContent.style.maxHeight = '80vh';
                    menuContent.style.overflow = 'auto';
                    menuContent.style.borderRadius = '12px';
                }
            } else {
                // æ¡Œé¢å±…ä¸­
                menu.style.left = '50%';
                menu.style.top = '50%';
                menu.style.transform = 'translate(-50%, -50%)';
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);

            // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆä»…ç§»åŠ¨ç«¯å…¨å±æ—¶ï¼‰
            if (isMobile) {
                menu.addEventListener('click', (evt) => {
                    const content = menu.querySelector('.demo-menu-content');
                    if (content && !content.contains(evt.target)) {
                        menu.remove();
                    }
                });
            }

            // ç»‘å®šå…³é—­æŒ‰é’®
            const closeBtn = menu.querySelector('.menu-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    menu.remove();
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•æ·»åŠ é¢æ¿å¤±è´¥:', error);
        }
    }
    /**
     * åˆ‡æ¢é¢æ¿åˆ†ç±»ï¼ˆç®€åŒ–ç‰ˆï¼šåªæœ‰å…¨éƒ¨é¢æ¿ï¼‰
     */
    switchPanelCategory(category) {
        try {
            // ç®€åŒ–ï¼šåªæœ‰å…¨éƒ¨é¢æ¿åˆ†ç±»ï¼Œæ— éœ€åˆ‡æ¢é€»è¾‘
            console.log(`[InfoBarSettings] ğŸ“‘ é¢æ¿åˆ†ç±»å·²ç®€åŒ–ï¼Œåªæ˜¾ç¤ºå…¨éƒ¨é¢æ¿`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢é¢æ¿åˆ†ç±»å¤±è´¥:', error);
        }
    }

    /**
     * é€‰æ‹©é¢æ¿è¿›è¡Œç¼–è¾‘
     */
    async selectPanelForEdit(panelId, panelType) {
        try {
            console.log(`[InfoBarSettings] ğŸ¯ å¼€å§‹é€‰æ‹©é¢æ¿: ${panelId} (${panelType})`);

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯é¢æ¿IDå’Œç±»å‹çš„æœ‰æ•ˆæ€§
            if (!panelId || !panelType) {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæˆ–ç±»å‹æ— æ•ˆ:', { panelId, panelType });
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥é¢æ¿æ˜¯å¦çœŸå®å­˜åœ¨
            let panelExists = false;
            if (panelType === 'basic') {
                const basicPanelIds = ['personal', 'interaction', 'tasks', 'world', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];
                panelExists = basicPanelIds.includes(panelId);
            } else if (panelType === 'custom') {
                const customPanels = this.getCustomPanels();
                panelExists = customPanels.hasOwnProperty(panelId);
            }

            if (!panelExists) {
                console.error('[InfoBarSettings] âŒ é¢æ¿ä¸å­˜åœ¨:', panelId, panelType);
                this.showMessage(`é¢æ¿ ${panelId} ä¸å­˜åœ¨`, 'error');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šåˆ‡æ¢é¢æ¿å‰è‡ªåŠ¨ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œé¿å…å‹¾é€‰çŠ¶æ€ä¸¢å¤±ï¼ˆé™é»˜ä¿å­˜ï¼Œä¸å¼¹ç¡®è®¤æ¡†ï¼‰
            if (this.currentEditingPanel && this.modal?.querySelector('.panel-properties-form')) {
                try {
                    // ä»…åœ¨è¡¨å•å¯è§æ—¶å°è¯•ä¿å­˜ï¼Œä¸”ä¸æ‰“æ–­ç”¨æˆ·
                    const propertiesForm = this.modal.querySelector('.panel-properties-form');
                    if (propertiesForm && propertiesForm.style.display !== 'none') {
                        // ä½¿ç”¨é™é»˜ä¿å­˜ï¼Œä¸å¼¹ç¡®è®¤å¯¹è¯æ¡†
                        const { id, type } = this.currentEditingPanel;
                        await this.performSavePanelProperties(id, type);
                        console.log('[InfoBarSettings] ğŸ’¾ é™é»˜ä¿å­˜å½“å‰é¢æ¿:', id);
                    }
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ è‡ªåŠ¨ä¿å­˜å½“å‰é¢æ¿å¤±è´¥ï¼Œå°†ç»§ç»­åˆ‡æ¢:', e);
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°é¢æ¿åˆ—è¡¨é¡¹é€‰ä¸­çŠ¶æ€ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
            this.modal.querySelectorAll('.panel-list-item').forEach(item => {
                const itemPanelId = item.dataset.panelId;
                const itemPanelType = item.dataset.panelType;
                const shouldSelect = (itemPanelId === panelId && itemPanelType === panelType);

                if (shouldSelect) {
                    item.classList.add('selected');
                    console.log('[InfoBarSettings] âœ… é€‰ä¸­é¢æ¿é¡¹:', itemPanelId, itemPanelType);
                } else {
                    item.classList.remove('selected');
                }
            });

            // æ˜¾ç¤ºé¢æ¿å±æ€§è¡¨å•
            this.showPanelProperties(panelId, panelType);

            console.log(`[InfoBarSettings] âœ… é¢æ¿é€‰æ‹©å®Œæˆ: ${panelId} (${panelType})`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©é¢æ¿å¤±è´¥:', error);
            this.showMessage('é€‰æ‹©é¢æ¿å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ˜¾ç¤ºé¢æ¿å±æ€§
     */
    showPanelProperties(panelId, panelType) {
        try {
            const noSelectionMessage = this.modal.querySelector('.no-selection-message');
            const propertiesForm = this.modal.querySelector('.panel-properties-form');
            const saveBtn = this.modal.querySelector('[data-action="save-panel-properties"]');
            const deleteBtn = this.modal.querySelector('[data-action="delete-panel"]');

            // ğŸ”§ ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºé¢æ¿å±æ€§å‰ï¼Œé¢„é˜²æ€§æ¸…ç†å­é¡¹å®¹å™¨ï¼Œé˜²æ­¢UIæ±¡æŸ“
            const container = this.modal.querySelector('.sub-items-container');
            if (container) {
                container.querySelectorAll('.sub-item-form').forEach(item => item.remove());
                console.log(`[InfoBarSettings] ğŸ§¹ é¢„é˜²æ€§æ¸…ç†å­é¡¹å®¹å™¨ï¼Œå‡†å¤‡æ˜¾ç¤ºé¢æ¿: ${panelId} (${panelType})`);
            }

            // éšè—æ— é€‰æ‹©æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå±æ€§è¡¨å•
            noSelectionMessage.style.display = 'none';
            propertiesForm.style.display = 'block';

            // å¯ç”¨/ç¦ç”¨æŒ‰é’®
            saveBtn.disabled = false;
            deleteBtn.disabled = panelType === 'basic'; // åŸºç¡€é¢æ¿ä¸èƒ½åˆ é™¤

            // åŠ è½½é¢æ¿æ•°æ®åˆ°è¡¨å•
            this.loadPanelDataToForm(panelId, panelType);

            // å­˜å‚¨å½“å‰ç¼–è¾‘çš„é¢æ¿ä¿¡æ¯
            this.currentEditingPanel = { id: panelId, type: panelType };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºé¢æ¿å±æ€§å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿æ·»åŠ å¯¹è¯æ¡†
     */
    showCustomPanelDialog() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿æ·»åŠ å¯¹è¯æ¡†');

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'custom-panel-dialog-overlay';

            // ğŸ”§ è®¾ç½®å®Œç¾å±…ä¸­æ ·å¼ - å‚è€ƒé¢æ¿è§„åˆ™ç¼–è¾‘ç•Œé¢
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                visibility: visible;
                transition: opacity 0.3s ease;
            `;

            dialogOverlay.innerHTML = `
                <div class="custom-panel-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 500px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header" style="
                        padding: 20px 24px 16px;
                        border-bottom: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; color: var(--theme-text-primary, #ffffff); font-size: 18px;">æ·»åŠ è‡ªå®šä¹‰é¢æ¿</h3>
                        <button class="dialog-close-btn" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-secondary, #aaa);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                        ">Ã—</button>
                    </div>
                    <div class="dialog-content" style="padding: 20px 24px;">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="new-panel-name" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é¢æ¿åç§°:</label>
                            <input type="text" id="new-panel-name" placeholder="è¯·è¾“å…¥é¢æ¿åç§°" value="æ–°å»ºé¢æ¿" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                            ">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="new-panel-key" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é”®å:</label>
                            <input type="text" id="new-panel-key" placeholder="è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¿®æ”¹" value="" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                            ">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="new-panel-description" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">é¢æ¿è¯´æ˜:</label>
                            <textarea id="new-panel-description" placeholder="è¯·è¾“å…¥é¢æ¿è¯´æ˜" rows="3" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                resize: vertical;
                                min-height: 80px;
                                box-sizing: border-box;
                            ">è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰é¢æ¿</textarea>
                        </div>
                    </div>
                    <div class="dialog-footer" style="
                        padding: 16px 24px 20px;
                        border-top: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button class="btn-cancel" style="
                            padding: 10px 20px;
                            border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                            border-radius: 6px;
                            background: transparent;
                            color: var(--theme-text-secondary, #aaa);
                            cursor: pointer;
                            font-size: 14px;
                        ">å…³é—­</button>
                        <button class="btn-confirm" style="
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            background: var(--theme-primary-color, #4299e1);
                            color: var(--theme-text-primary, #ffffff);
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        ">ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ğŸ”§ æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                dialogOverlay.style.opacity = '1';
            }, 10);

            // ğŸ”§ è°ƒè¯•ï¼šæ£€æŸ¥å¯¹è¯æ¡†åˆå§‹å€¼
            console.log('[InfoBarSettings] ğŸ” å¯¹è¯æ¡†åˆå§‹å€¼æ£€æŸ¥:');
            console.log('  é¢æ¿åç§°é»˜è®¤å€¼:', document.getElementById('new-panel-name').value);
            console.log('  å½“å‰ç¼–è¾‘çš„é¢æ¿:', this.currentEditingPanel);

            // ç”Ÿæˆé»˜è®¤é”®å
            const customPanels = this.getCustomPanels();
            const defaultKey = this.generateKeyFromName('æ–°å»ºé¢æ¿');
            const uniqueKey = this.ensureUniqueKey(defaultKey, customPanels);
            document.getElementById('new-panel-key').value = uniqueKey;

            console.log('  ç”Ÿæˆçš„é»˜è®¤é”®å:', defaultKey, '->', uniqueKey);

            // ğŸ”§ é˜²æŠ¤ï¼šç¡®ä¿é»˜è®¤å€¼ä¸è¢«è¦†ç›–
            setTimeout(() => {
                const currentName = document.getElementById('new-panel-name').value;
                const currentKey = document.getElementById('new-panel-key').value;
                console.log('[InfoBarSettings] ğŸ” å¯¹è¯æ¡†å»¶è¿Ÿæ£€æŸ¥(500mså):');
                console.log('  é¢æ¿åç§°å½“å‰å€¼:', currentName);
                console.log('  é”®åå½“å‰å€¼:', currentKey);

                // å¦‚æœå€¼è¢«æ„å¤–ä¿®æ”¹ï¼Œæ¢å¤é»˜è®¤å€¼
                if (currentName !== 'æ–°å»ºé¢æ¿') {
                    console.warn('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°é¢æ¿åç§°è¢«å¼‚å¸¸ä¿®æ”¹ï¼Œæ¢å¤é»˜è®¤å€¼');
                    document.getElementById('new-panel-name').value = 'æ–°å»ºé¢æ¿';
                    document.getElementById('new-panel-key').value = uniqueKey;
                }
            }, 500);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const confirmBtn = dialogOverlay.querySelector('.btn-confirm');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // é¢æ¿åç§°å˜åŒ–æ—¶è‡ªåŠ¨ç”Ÿæˆé”®å
            const nameInput = document.getElementById('new-panel-name');
            const keyInput = document.getElementById('new-panel-key');

            nameInput.addEventListener('input', (e) => {
                const name = e.target.value.trim();
                console.log('[InfoBarSettings] ğŸ” é¢æ¿åç§°è¾“å…¥å˜åŒ–:', name);
                if (name) {
                    const newKey = this.generateKeyFromName(name);
                    const uniqueKey = this.ensureUniqueKey(newKey, customPanels);
                    console.log('  è‡ªåŠ¨ç”Ÿæˆé”®å:', newKey, '->', uniqueKey);
                    keyInput.value = uniqueKey;
                }
            });

            // ç¡®è®¤æ·»åŠ äº‹ä»¶
            confirmBtn.addEventListener('click', () => {
                const name = document.getElementById('new-panel-name').value.trim();
                const key = document.getElementById('new-panel-key').value.trim();
                const description = document.getElementById('new-panel-description').value.trim();

                // ğŸ”§ è°ƒè¯•ï¼šæ£€æŸ¥ç”¨æˆ·ç¡®è®¤æ—¶çš„å€¼
                console.log('[InfoBarSettings] ğŸ” ç”¨æˆ·ç¡®è®¤æ·»åŠ æ—¶çš„å€¼:');
                console.log('  é¢æ¿åç§°:', name);
                console.log('  é”®å:', key);
                console.log('  é¢æ¿è¯´æ˜:', description);
                console.log('  å½“å‰ç¼–è¾‘çš„é¢æ¿:', this.currentEditingPanel);

                // éªŒè¯è¾“å…¥
                if (!name) {
                    alert('è¯·è¾“å…¥é¢æ¿åç§°');
                    return;
                }

                if (!key) {
                    alert('è¯·è¾“å…¥é”®å');
                    return;
                }

                // éªŒè¯é”®åæ ¼å¼
                if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
                    alert('é”®ååªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´');
                    return;
                }

                // æ£€æŸ¥é”®åæ˜¯å¦å·²å­˜åœ¨
                if (customPanels[key]) {
                    alert('è¯¥é”®åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–é”®å');
                    return;
                }

                // åˆ›å»ºé¢æ¿æ•°æ®
                const panelData = {
                    name: name,
                    key: key,
                    description: description,
                    icon: 'ğŸ¨' // å›ºå®šä½¿ç”¨é»˜è®¤å›¾æ ‡
                };

                // å…³é—­å¯¹è¯æ¡†
                closeDialog();

                // æ‰§è¡Œæ·»åŠ é¢æ¿
                this.addCustomPanel(panelData);
            });

            // é”®åè¾“å…¥éªŒè¯
            keyInput.addEventListener('input', (e) => {
                let value = e.target.value;
                // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
                value = value.replace(/[^a-zA-Z0-9_]/g, '');
                // ä¸èƒ½ä»¥æ•°å­—å¼€å¤´
                if (/^[0-9]/.test(value)) {
                    value = '_' + value;
                }
                e.target.value = value;
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºè‡ªå®šä¹‰é¢æ¿å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ è‡ªå®šä¹‰é¢æ¿
     */
    async addCustomPanel(panelData = null) {
        try {
            // å¦‚æœæ²¡æœ‰æä¾›é¢æ¿æ•°æ®ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
            if (!panelData) {
                this.showCustomPanelDialog();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ·»åŠ è‡ªå®šä¹‰é¢æ¿:', panelData);

            // ğŸ”§ ä¿®å¤ï¼šåˆ›å»ºæ–°çš„è‡ªå®šä¹‰é¢æ¿ï¼Œä½¿ç”¨é”®åä½œä¸ºID
            const newPanel = {
                id: panelData.key,  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºIDï¼Œç¡®ä¿ä¸ä¿¡æ¯æ ç³»ç»Ÿè®¾è®¡ä¸€è‡´
                name: panelData.name,
                key: panelData.key,
                description: panelData.description,
                icon: panelData.icon,
                type: 'custom',
                enabled: true,
                required: false,
                memoryInject: false,

                prompts: {
                    init: '',
                    insert: '',
                    update: '',
                    delete: ''
                },
                subItems: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            // ä¿å­˜åˆ°è‡ªå®šä¹‰é¢æ¿é…ç½®
            await this.saveCustomPanel(newPanel);

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆæ·»åŠ è‡ªå®šä¹‰é¢æ¿åˆ°å¯¼èˆªï¼‰
            this.refreshNavigation();

            // è‡ªåŠ¨é€‰æ‹©æ–°å»ºçš„é¢æ¿
            this.selectPanelForEdit(newPanel.id, 'custom');

            console.log('[InfoBarSettings] âœ… æ·»åŠ è‡ªå®šä¹‰é¢æ¿æˆåŠŸ:', newPanel.id, 'é”®å:', newPanel.key);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ è‡ªå®šä¹‰é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°é¢æ¿åˆ—è¡¨
     */
    refreshPanelList() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°é¢æ¿åˆ—è¡¨');
                return;
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°é¢æ¿åˆ—è¡¨...');

            // ğŸ”§ ä¿®å¤ï¼šä¿å­˜å½“å‰é€‰ä¸­çš„é¢æ¿IDï¼Œåˆ·æ–°åæ¢å¤é€‰ä¸­çŠ¶æ€
            const currentSelectedPanel = this.modal.querySelector('.panel-list-item.selected');
            const currentSelectedPanelId = currentSelectedPanel?.dataset?.panelId;
            const currentSelectedPanelType = currentSelectedPanel?.dataset?.panelType;

            console.log('[InfoBarSettings] ğŸ“Š å½“å‰é€‰ä¸­é¢æ¿:', currentSelectedPanelId, currentSelectedPanelType);

            // é‡æ–°ç”Ÿæˆé¢æ¿åˆ—è¡¨
            const panelListContainers = this.modal.querySelectorAll('.panel-list');

            panelListContainers.forEach(container => {
                const category = container.dataset.category;
                const newContent = this.createPanelListItems(category);
                console.log(`[InfoBarSettings] ğŸ”„ åˆ·æ–°${category}åˆ†ç±»é¢æ¿åˆ—è¡¨`);
                container.innerHTML = newContent;
            });

            // ğŸ”§ ä¿®å¤ï¼šåˆ·æ–°åæ¢å¤é€‰ä¸­çŠ¶æ€
            if (currentSelectedPanelId) {
                setTimeout(() => {
                    const newSelectedPanel = this.modal.querySelector(`[data-panel-id="${currentSelectedPanelId}"]`);
                    if (newSelectedPanel) {
                        newSelectedPanel.classList.add('selected');
                        console.log('[InfoBarSettings] âœ… å·²æ¢å¤é¢æ¿é€‰ä¸­çŠ¶æ€:', currentSelectedPanelId);
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ åˆ·æ–°åæœªæ‰¾åˆ°ä¹‹å‰é€‰ä¸­çš„é¢æ¿:', currentSelectedPanelId);
                        // æ¸…ç©ºé¢æ¿å±æ€§è¡¨å•
                        this.clearPanelProperties();
                    }
                }, 100);
            }

            // æ›´æ–°é¢æ¿æ•°é‡
            this.updatePanelCountsDisplay();

            console.log('[InfoBarSettings] âœ… é¢æ¿åˆ—è¡¨åˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°é¢æ¿åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢æ¿æ•°é‡æ˜¾ç¤º
     */
    updatePanelCountsDisplay() {
        try {
            const totalCount = this.getTotalPanelCount();

            // åªæ›´æ–°å…¨éƒ¨é¢æ¿çš„è®¡æ•°
            const allCategoryCount = this.modal.querySelector('[data-category="all"] .category-count');
            if (allCategoryCount) {
                allCategoryCount.textContent = totalCount;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢æ¿æ•°é‡å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°æ˜¾ç¤º
     */
    updateBasicPanelCount() {
        try {
            const countElement = this.modal.querySelector('#basic-settings-count');
            if (!countElement) return;

            // è·å–åŸºç¡€è®¾ç½®é¢æ¿çš„å¤é€‰æ¡†
            const allCheckboxes = this.modal.querySelectorAll('.basic-settings-vertical input[type="checkbox"][name]');
            const enabledCheckboxes = this.modal.querySelectorAll('.basic-settings-vertical input[type="checkbox"][name]:checked');

            const totalCount = allCheckboxes.length;
            const enabledCount = enabledCheckboxes.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            console.log(`[InfoBarSettings] ğŸ“Š åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°æŒ‡å®šé¢æ¿çš„é…ç½®è®¡æ•°æ˜¾ç¤ºå’ŒçŠ¶æ€æ ‡ç­¾
     */
    updatePanelConfigCount(panelName) {
        try {
            const countElement = this.modal.querySelector(`[data-content="${panelName}"] .status-count`);
            const statusBadge = this.modal.querySelector(`[data-content="${panelName}"] .status-badge`);
            if (!countElement) return;

            // è·å–è¯¥é¢æ¿çš„å¤é€‰æ¡†
            const panelContainer = this.modal.querySelector(`[data-content="${panelName}"]`);
            if (!panelContainer) return;

            // ğŸ”§ ä¿®å¤ï¼šæ’é™¤é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†ï¼Œåªè®¡ç®—å­é¡¹å¤é€‰æ¡†
            // é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†çš„nameæ ¼å¼ä¸º "panelName.enabled"
            const allCheckboxes = panelContainer.querySelectorAll(`input[type="checkbox"][name]:not([name="${panelName}.enabled"])`);
            const enabledCheckboxes = panelContainer.querySelectorAll(`input[type="checkbox"][name]:checked:not([name="${panelName}.enabled"])`);

            const totalCount = allCheckboxes.length;
            const enabledCount = enabledCheckboxes.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            // ğŸ”§ ä¿®å¤ï¼šæ›´æ–°çŠ¶æ€æ ‡ç­¾ï¼Œæ ¹æ®é¢æ¿ä¸»å¯ç”¨å¤é€‰æ¡†çŠ¶æ€
            if (statusBadge) {
                const panelToggle = panelContainer.querySelector(`input[name="${panelName}.enabled"]`);
                if (panelToggle) {
                    const isEnabled = panelToggle.checked;
                    statusBadge.textContent = isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                    statusBadge.className = `status-badge ${isEnabled ? 'enabled' : 'disabled'}`;
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š ${panelName}é¢æ¿é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°${panelName}é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:`, error);
        }
    }

    /**
     * æ ¹æ®å¤é€‰æ¡†æ‰€åœ¨é¢æ¿æ›´æ–°å¯¹åº”çš„è®¡æ•°
     */
    updatePanelCounts(checkbox) {
        try {
            // æ‰¾åˆ°å¤é€‰æ¡†æ‰€åœ¨çš„é¢æ¿
            const panelContainer = checkbox.closest('[data-content]');
            if (!panelContainer) return;

            const panelName = panelContainer.getAttribute('data-content');

            // æ ¹æ®é¢æ¿ç±»å‹æ›´æ–°å¯¹åº”çš„è®¡æ•°
            if (panelName === 'basic') {
                this.updateBasicPanelCount();
            } else {
                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰é¢æ¿
                const customPanels = this.getCustomPanels();
                const customPanel = customPanels[panelName];

                if (customPanel) {
                    // è‡ªå®šä¹‰é¢æ¿
                    this.updateCustomPanelCount(panelName, customPanel);
                } else {
                    // åŸºç¡€é¢æ¿
                    this.updatePanelConfigCount(panelName);
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢æ¿è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰é¢æ¿çš„é…ç½®è®¡æ•°æ˜¾ç¤º
     */
    updateCustomPanelCount(panelId, panel) {
        try {
            const countElement = this.modal.querySelector(`#${panelId}-panel-count`);
            if (!countElement) {
                console.warn(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰é¢æ¿è®¡æ•°å…ƒç´ : ${panelId}-panel-count`);
                return;
            }

            // è·å–å½“å‰é¢æ¿çš„æ‰€æœ‰å¤é€‰æ¡†
            const subItems = panel.subItems || [];
            const enabledSubItems = subItems.filter(subItem => {
                const fieldName = subItem.name || subItem.key || subItem.id;
                const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);
                return checkbox && checkbox.checked;
            });

            const totalCount = subItems.length;
            const enabledCount = enabledSubItems.length;

            countElement.textContent = `${enabledCount}/${totalCount} é¡¹å·²é…ç½®`;

            console.log(`[InfoBarSettings] ğŸ“Š è‡ªå®šä¹‰é¢æ¿${panel.name}é…ç½®è®¡æ•°æ›´æ–°: ${enabledCount}/${totalCount}`);

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰é¢æ¿é…ç½®è®¡æ•°å¤±è´¥:`, error);
        }
    }

    /**
     * æ›´æ–°æ‰€æœ‰é¢æ¿çš„é…ç½®è®¡æ•°
     */
    updateAllPanelCounts() {
        try {
            // æ›´æ–°åŸºç¡€è®¾ç½®é¢æ¿è®¡æ•°
            this.updateBasicPanelCount();

            // æ›´æ–°æ‰€æœ‰åŸºç¡€é¢æ¿è®¡æ•°
            const basicPanels = ['personal', 'interaction', 'tasks', 'world', 'organization',
                               'news', 'inventory', 'abilities', 'plot', 'cultivation',
                               'fantasy', 'modern', 'historical', 'magic', 'training'];

            basicPanels.forEach(panelName => {
                this.updatePanelConfigCount(panelName);
            });

            // æ›´æ–°æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿è®¡æ•°
            const customPanels = this.getCustomPanels();
            for (const [panelId, panel] of Object.entries(customPanels)) {
                this.updateCustomPanelCount(panelId, panel);
            }

            console.log('[InfoBarSettings] ğŸ“Š æ‰€æœ‰é¢æ¿é…ç½®è®¡æ•°å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ‰€æœ‰é¢æ¿è®¡æ•°å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰é¢æ¿
     */
    async saveCustomPanel(panel) {
        try {
            // ğŸ”§ å‚æ•°éªŒè¯ï¼šç¡®ä¿é¢æ¿æ•°æ®å®Œæ•´æ€§
            if (!panel) {
                console.error('[InfoBarSettings] âŒ é¢æ¿æ•°æ®ä¸ºç©º');
                return false;
            }

            if (!panel.id || panel.id === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿IDæ— æ•ˆ:', panel.id);
                return false;
            }

            if (!panel.name || panel.name === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿åç§°æ— æ•ˆ:', panel.name);
                return false;
            }

            if (!panel.type || panel.type === 'undefined') {
                console.error('[InfoBarSettings] âŒ é¢æ¿ç±»å‹æ— æ•ˆ:', panel.type);
                return false;
            }

            console.log('[InfoBarSettings] ğŸ“Š ä¿å­˜é¢æ¿æ•°æ®éªŒè¯é€šè¿‡:', panel.id, panel.name);

            // è·å–ç°æœ‰è‡ªå®šä¹‰é¢æ¿
            const customPanels = this.getCustomPanels();

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºå­˜å‚¨é”®ï¼Œç¡®ä¿ä¸ä¿¡æ¯æ ç³»ç»Ÿè®¾è®¡ä¸€è‡´
            customPanels[panel.key] = panel;

            // ä¿å­˜åˆ°å…¨å±€é…ç½®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            window.InfoBarCustomPanels = customPanels;

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜è‡ªå®šä¹‰é¢æ¿æ•°æ®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ğŸ”§ ä¿®å¤ï¼šä¹Ÿå°†è‡ªå®šä¹‰é¢æ¿é…ç½®ä¿å­˜åˆ°æ ¹çº§åˆ«ï¼Œè®©mergeWithEnabledFieldsèƒ½å¤Ÿè¯»å–
            // è¿™æ ·è‡ªå®šä¹‰é¢æ¿çš„å­é¡¹é…ç½®å°±èƒ½è¢«æ­£ç¡®è¯†åˆ«ä¸ºå¯ç”¨å­—æ®µ
            extensionSettings['Information bar integration tool'][panel.key] = {
                enabled: panel.enabled !== false, // é»˜è®¤å¯ç”¨
                subItems: panel.subItems || [],
                description: panel.description || '',
                icon: panel.icon || '',
                type: 'custom',
                key: panel.key,
                name: panel.name
            };

            console.log(`[InfoBarSettings] ğŸ”§ è‡ªå®šä¹‰é¢æ¿é…ç½®å·²åŒæ­¥åˆ°æ ¹çº§åˆ«: ${panel.key}, å­é¡¹æ•°é‡: ${panel.subItems?.length || 0}`);

            // è§¦å‘ SillyTavern ä¿å­˜è®¾ç½®
            context.saveSettingsDebounced();

            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æ˜ å°„æ—¶é‡æ–°ç”Ÿæˆ
            this._cachedCompleteMapping = null;

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿å·²ä¿å­˜:', panel.id);
            return true;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è‡ªå®šä¹‰é¢æ¿å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * ç¼–è¾‘é¢æ¿
     */
    editPanel(panelId) {
        // é€‰æ‹©é¢æ¿è¿›è¡Œç¼–è¾‘ï¼ˆä¸ç‚¹å‡»é¢æ¿é¡¹ç›¸åŒï¼‰
        const panelItem = this.modal.querySelector(`[data-panel-id="${panelId}"]`);
        if (panelItem) {
            const panelType = panelItem.dataset.panelType;
            this.selectPanelForEdit(panelId, panelType);
        }
    }

    /**
     * æŸ¥çœ‹é¢æ¿
     */
    viewPanel(panelId) {
        // åŸºç¡€é¢æ¿åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ç¼–è¾‘
        this.editPanel(panelId);
    }

    /**
     * å¤åˆ¶é¢æ¿
     */
    async duplicatePanel(panelId) {
        try {
            const customPanels = this.getCustomPanels();
            const originalPanel = customPanels[panelId];

            if (!originalPanel) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°è¦å¤åˆ¶çš„é¢æ¿:', panelId);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šåˆ›å»ºå‰¯æœ¬ï¼Œä½¿ç”¨é”®åä½œä¸ºID
            const newKey = `${originalPanel.key}_copy_${Date.now()}`;
            const duplicatedPanel = {
                ...originalPanel,
                id: newKey,  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é”®åä½œä¸ºID
                name: `${originalPanel.name} - å‰¯æœ¬`,
                key: newKey,
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            // ä¿å­˜å‰¯æœ¬
            await this.saveCustomPanel(duplicatedPanel);

            // åˆ·æ–°åˆ—è¡¨
            this.refreshPanelList();

            console.log('[InfoBarSettings] ğŸ“‹ é¢æ¿å¤åˆ¶å®Œæˆ:', duplicatedPanel.id);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤åˆ¶é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢é¢æ¿å¯ç”¨çŠ¶æ€
     */
    async togglePanel(panelId) {
        try {
            // å¯¹äºåŸºç¡€é¢æ¿ï¼Œåˆ‡æ¢å¯¼èˆªæ˜¾ç¤ºçŠ¶æ€
            // å¯¹äºè‡ªå®šä¹‰é¢æ¿ï¼Œåˆ‡æ¢å¯ç”¨çŠ¶æ€
            const panelItem = this.modal.querySelector(`[data-panel-id="${panelId}"]`);
            const panelType = panelItem?.dataset.panelType;

            if (panelType === 'custom') {
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];

                if (panel) {
                    panel.enabled = !panel.enabled;
                    panel.updatedAt = Date.now();
                    await this.saveCustomPanel(panel);
                }
            }

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            console.log('[InfoBarSettings] ğŸ”„ åˆ‡æ¢é¢æ¿çŠ¶æ€:', panelId);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢é¢æ¿çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜é¢æ¿å±æ€§
     */
    async savePanelProperties() {
        try {
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿');
                return;
            }

            const { id, type } = this.currentEditingPanel;
            const panelName = this.currentEditingPanel.name || id;

            // æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†
            this.showSaveConfirmDialog(panelName, async () => {
                await this.performSavePanelProperties(id, type);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é¢æ¿å±æ€§å¤±è´¥:', error);
            this.showMessage('é¢æ¿ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ‰§è¡Œä¿å­˜é¢æ¿å±æ€§æ“ä½œ
     */
    async performSavePanelProperties(id, type) {
        try {

            if (type === 'basic') {
                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ä¹Ÿéœ€è¦ä¿å­˜åŠŸèƒ½
                console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜åŸºç¡€é¢æ¿å±æ€§:', id);

                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿å•ç‹¬æ”¶é›†è¡¨å•æ•°æ®ï¼Œä¸åŒ…å«å­é¡¹
            // è¯»å–å½“å‰å‹¾é€‰çŠ¶æ€ï¼Œé¿å…å› DOMé‡ç»˜é€ æˆçŠ¶æ€ä¸¢å¤±
            const form = this.modal.querySelector('.panel-properties-form');
            const memoryInjectChecked = !!form?.querySelector('#panel-memory-inject')?.checked;
            const requiredChecked = !!form?.querySelector('#panel-required')?.checked;

            const formData = this.collectBasicPanelFormData();
            // è¦†ç›–å…³é”®å¸ƒå°”ä½ï¼Œä»¥å½“å‰UIä¸ºå‡†
            formData.memoryInject = memoryInjectChecked;
            formData.required = requiredChecked;

                // ä¿å­˜åˆ°extensionSettings
                const context = SillyTavern.getContext();
                const extensionSettings = context.extensionSettings;

                if (!extensionSettings['Information bar integration tool']) {
                    extensionSettings['Information bar integration tool'] = {};
                }

                if (!extensionSettings['Information bar integration tool'][id]) {
                    extensionSettings['Information bar integration tool'][id] = {};
                }

                // æ›´æ–°åŸºç¡€é¢æ¿é…ç½®
                Object.assign(extensionSettings['Information bar integration tool'][id], formData);

                // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ç°åœ¨å…è®¸ä¿å­˜ç”¨æˆ·æ·»åŠ çš„å­é¡¹æ•°æ®
                // ä¸å†åˆ é™¤å­é¡¹æ•°æ®ï¼Œå…è®¸ç”¨æˆ·ä¸ºåŸºç¡€é¢æ¿æ·»åŠ è‡ªå®šä¹‰å­é¡¹
                console.log('[InfoBarSettings] ğŸ’¾ åŸºç¡€é¢æ¿å­é¡¹æ•°æ®å·²ä¿å­˜:', formData.subItems?.length || 0, 'ä¸ª');

                // ä¿å­˜è®¾ç½®
                context.saveSettingsDebounced();

                // ğŸ”§ ä¿®å¤ï¼šåˆ·æ–°å¯¹åº”çš„åŸºç¡€é¢æ¿å†…å®¹ï¼Œç¡®ä¿æ–°å¢çš„å­é¡¹åœ¨åŸºç¡€è®¾ç½®ä¸­æ˜¾ç¤º
                this.refreshBasicPanelContent(id);
                console.log(`[InfoBarSettings] ğŸ”„ å·²åˆ·æ–°åŸºç¡€é¢æ¿ ${id} çš„è®¾ç½®é¡µé¢å†…å®¹`);

                console.log('[InfoBarSettings] âœ… åŸºç¡€é¢æ¿å±æ€§ä¿å­˜æˆåŠŸ:', id);
                this.showMessage('åŸºç¡€é¢æ¿ä¿å­˜æˆåŠŸ', 'success');

                return;
            }

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = this.collectPanelFormData();

            // æ”¶é›†å­é¡¹æ•°æ®
            const subItemsData = this.collectSubItemsData();
            formData.subItems = subItemsData;

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', formData);
            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„å­é¡¹æ•°æ®:', subItemsData);

            // æ›´æ–°é¢æ¿é…ç½®
            const customPanels = this.getCustomPanels();
            const panel = customPanels[id];

            if (panel) {
                Object.assign(panel, formData, { updatedAt: Date.now() });
                await this.saveCustomPanel(panel);

                // åˆ·æ–°é¢æ¿åˆ—è¡¨
                this.refreshPanelList();

                // åˆ·æ–°å¯¼èˆªæ ï¼ˆæ›´æ–°è‡ªå®šä¹‰é¢æ¿å†…å®¹ï¼‰
                this.refreshNavigation();

                // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªé¢æ¿çš„å†…å®¹ï¼Œä¹Ÿéœ€è¦æ›´æ–°å³ä¾§å†…å®¹åŒºåŸŸ
                const activeNavItem = this.modal.querySelector('.nav-item.active');
                if (activeNavItem && activeNavItem.dataset.nav === id) {
                    // æ›´æ–°å³ä¾§å†…å®¹é¢æ¿
                    const contentPanel = this.modal.querySelector(`.content-panel[data-content="${id}"]`);
                    if (contentPanel) {
                        contentPanel.innerHTML = this.createCustomPanelContent(panel);
                        console.log('[InfoBarSettings] ğŸ”„ å·²æ›´æ–°å³ä¾§å†…å®¹é¢æ¿æ˜¾ç¤º');
                    }
                }

                console.log('[InfoBarSettings] âœ… é¢æ¿å±æ€§ä¿å­˜æˆåŠŸ:', id, 'åŒ…å«', subItemsData.length, 'ä¸ªå­é¡¹');

                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                this.showMessage('é¢æ¿ä¿å­˜æˆåŠŸ', 'success');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œä¿å­˜é¢æ¿å±æ€§æ“ä½œå¤±è´¥:', error);
            this.showMessage('é¢æ¿ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * åˆ é™¤é¢æ¿
     */
    async deletePanel() {
        try {
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿');
                return;
            }

            const { id, type } = this.currentEditingPanel;

            if (type === 'basic') {
                console.error('[InfoBarSettings] âŒ ä¸èƒ½åˆ é™¤åŸºç¡€é¢æ¿');
                return;
            }

            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('é¢æ¿', id, async () => {
                await this.performDeletePanel(id);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤é¢æ¿å¤±è´¥:', error);
            this.showMessage('é¢æ¿åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ‰§è¡Œåˆ é™¤é¢æ¿æ“ä½œ
     */
    async performDeletePanel(id) {
        try {
            // ä»è‡ªå®šä¹‰é¢æ¿ä¸­åˆ é™¤
            const customPanels = this.getCustomPanels();
            delete customPanels[id];

            // ä¿å­˜é…ç½®
            window.InfoBarCustomPanels = customPanels;

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜è‡ªå®šä¹‰é¢æ¿æ•°æ®
            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ğŸ”§ ä¿®å¤ï¼šä¹Ÿä»æ ¹çº§åˆ«åˆ é™¤è‡ªå®šä¹‰é¢æ¿é…ç½®
            delete extensionSettings['Information bar integration tool'][id];
            console.log(`[InfoBarSettings] ğŸ”§ å·²ä»æ ¹çº§åˆ«åˆ é™¤è‡ªå®šä¹‰é¢æ¿é…ç½®: ${id}`);

            // è§¦å‘ SillyTavern ä¿å­˜è®¾ç½®
            context.saveSettingsDebounced();

            // æ¸…ç©ºå±æ€§è¡¨å•
            this.clearPanelProperties();

            // åˆ·æ–°é¢æ¿åˆ—è¡¨
            this.refreshPanelList();

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆç§»é™¤è‡ªå®šä¹‰é¢æ¿ä»å¯¼èˆªï¼‰
            this.refreshNavigation();

            console.log('[InfoBarSettings] ğŸ—‘ï¸ é¢æ¿åˆ é™¤æˆåŠŸ:', id);

            // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
            this.showMessage('é¢æ¿åˆ é™¤æˆåŠŸ', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œåˆ é™¤é¢æ¿æ“ä½œå¤±è´¥:', error);
            this.showMessage('é¢æ¿åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }
    /**
     * æ˜¾ç¤ºå­é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showSubItemDialog() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºå­é¡¹æ·»åŠ å¯¹è¯æ¡†');

            // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œæ— æ³•æ·»åŠ å­é¡¹');
                alert('è¯·å…ˆé€‰æ‹©è¦æ·»åŠ å­é¡¹çš„é¢æ¿');
                return;
            }

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'sub-item-dialog-overlay';

            // ğŸ”§ è®¾ç½®å®Œç¾å±…ä¸­æ ·å¼ - å‚è€ƒé¢æ¿è§„åˆ™ç¼–è¾‘ç•Œé¢
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                visibility: visible;
                transition: opacity 0.3s ease;
            `;

            dialogOverlay.innerHTML = `
                <div class="sub-item-dialog" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    width: 450px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                ">
                    <div class="dialog-header" style="
                        padding: 20px 24px 16px;
                        border-bottom: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; color: var(--theme-text-primary, #ffffff); font-size: 18px;">æ·»åŠ å­é¡¹åˆ°é¢æ¿: ${this.currentEditingPanel.name}</h3>
                        <button class="dialog-close-btn" style="
                            background: none;
                            border: none;
                            color: var(--theme-text-secondary, #aaa);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                        ">Ã—</button>
                    </div>
                    <div class="dialog-content" style="padding: 20px 24px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="subitem-name" style="
                                display: block;
                                margin-bottom: 8px;
                                color: var(--theme-text-primary, #ffffff);
                                font-weight: 500;
                            ">å­é¡¹åç§°:</label>
                            <input type="text" id="subitem-name" placeholder="è¯·è¾“å…¥å­é¡¹åç§°" value="æ–°å»ºå­é¡¹" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                                border-radius: 6px;
                                background: var(--theme-bg-secondary, rgba(255,255,255,0.05));
                                color: var(--theme-text-primary, #ffffff);
                                font-size: 14px;
                                box-sizing: border-box;
                                margin-bottom: 8px;
                            ">
                            <small class="form-help" style="
                                color: var(--theme-text-secondary, #aaa);
                                font-size: 12px;
                                display: block;
                            ">æ³¨æ„ï¼šå­é¡¹åç§°å°†ç›´æ¥ä½œä¸ºé”®åä½¿ç”¨</small>
                        </div>
                    </div>
                    <div class="dialog-footer" style="
                        padding: 16px 24px 20px;
                        border-top: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button class="btn-cancel" style="
                            padding: 10px 20px;
                            border: 1px solid var(--theme-border-color, rgba(255,255,255,0.2));
                            border-radius: 6px;
                            background: transparent;
                            color: var(--theme-text-secondary, #aaa);
                            cursor: pointer;
                            font-size: 14px;
                        ">å…³é—­</button>
                        <button class="btn-confirm" style="
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            background: var(--theme-primary-color, #4299e1);
                            color: var(--theme-text-primary, #ffffff);
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        ">ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ğŸ”§ æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                dialogOverlay.style.opacity = '1';
            }, 10);

            // ä¸éœ€è¦ç”Ÿæˆé”®åï¼Œåç§°å°±æ˜¯é”®å

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const confirmBtn = dialogOverlay.querySelector('.btn-confirm');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤æ·»åŠ äº‹ä»¶
            confirmBtn.addEventListener('click', () => {
                const name = document.getElementById('subitem-name').value.trim();

                // éªŒè¯è¾“å…¥
                if (!name) {
                    alert('è¯·è¾“å…¥å­é¡¹åç§°');
                    return;
                }

                // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆåœ¨å½“å‰é¢æ¿çš„å­é¡¹ä¸­ï¼‰
                const existingSubItems = this.currentEditingPanel.subItems || [];
                if (existingSubItems.some(item => item.name === name || item.key === name)) {
                    alert('è¯¥å­é¡¹åç§°åœ¨å½“å‰é¢æ¿ä¸­å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                    return;
                }

                // åˆ›å»ºå­é¡¹æ•°æ®ï¼ˆåç§°å°±æ˜¯é”®åï¼‰
                const subItemData = {
                    name: name,
                    key: name,
                    description: ''
                };

                // å…³é—­å¯¹è¯æ¡†
                closeDialog();

                // æ‰§è¡Œæ·»åŠ å­é¡¹
                this.addSubItem(subItemData);
            });

            // å­é¡¹åç§°è¾“å…¥æ—¶è¿›è¡ŒåŸºç¡€éªŒè¯
            const nameInput = document.getElementById('subitem-name');
            nameInput.addEventListener('input', (e) => {
                // å¯ä»¥æ·»åŠ ä¸€äº›åŸºç¡€çš„åç§°éªŒè¯é€»è¾‘
                const value = e.target.value;
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ åç§°æ ¼å¼éªŒè¯
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå­é¡¹å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * ä»é¢æ¿åç§°ç”Ÿæˆè‹±æ–‡é”®å
     */
    generateKeyFromName(name) {
        // åŸºç¡€çš„ä¸­æ–‡åˆ°è‹±æ–‡æ˜ å°„
        const chineseToEnglish = {
            'æ–°å»º': 'new',
            'é¢æ¿': 'panel',
            'è‡ªå®šä¹‰': 'custom',
            'ç”¨æˆ·': 'user',
            'è®¾ç½®': 'settings',
            'é…ç½®': 'config',
            'ç®¡ç†': 'manage',
            'ç³»ç»Ÿ': 'system',
            'æ•°æ®': 'data',
            'ä¿¡æ¯': 'info',
            'äº¤äº’': 'interaction',
            'å¯¹è±¡': 'object',
            'ä¸ªäºº': 'personal',
            'ä»»åŠ¡': 'task',
            'ä¸–ç•Œ': 'world',
            'ç»„ç»‡': 'organization',
            'æ–°é—»': 'news',
            'åº“å­˜': 'inventory',
            'èƒ½åŠ›': 'ability',
            'å‰§æƒ…': 'plot',
            'ä¿®çœŸ': 'cultivation',
            'å¥‡å¹»': 'fantasy',
            'ç°ä»£': 'modern',
            'å†å²': 'historical',
            'é­”æ³•': 'magic',
            'è®­ç»ƒ': 'training'
        };

        let key = name.toLowerCase();

        // æ›¿æ¢ä¸­æ–‡å­—ç¬¦ä¸ºè‹±æ–‡ï¼ˆåœ¨æ›¿æ¢æ—¶æ·»åŠ åˆ†éš”ç¬¦ï¼‰
        for (const [chinese, english] of Object.entries(chineseToEnglish)) {
            key = key.replace(new RegExp(chinese, 'g'), `_${english}_`);
        }

        // ç§»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯æ•°å­—ä¸‹åˆ’çº¿
        key = key.replace(/[^a-zA-Z0-9]/g, '_');

        // ç§»é™¤è¿ç»­çš„ä¸‹åˆ’çº¿
        key = key.replace(/_+/g, '_');

        // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
        key = key.replace(/^_+|_+$/g, '');

        // å¦‚æœé”®åä¸ºç©ºæˆ–ä»¥æ•°å­—å¼€å¤´ï¼Œæ·»åŠ å‰ç¼€
        if (!key || /^[0-9]/.test(key)) {
            key = 'custom_' + key;
        }

        return key || 'custom_panel';
    }

    /**
     * ç¡®ä¿é”®åå”¯ä¸€æ€§
     */
    ensureUniqueKey(baseKey, existingPanels) {
        let uniqueKey = baseKey;
        let counter = 1;

        while (existingPanels[uniqueKey]) {
            uniqueKey = `${baseKey}_${counter}`;
            counter++;
        }

        return uniqueKey;
    }

    /**
     * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
     */
    showDeleteConfirmDialog(type, name, onConfirm) {
        try {
            console.log(`[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†: ${type} - ${name}`);

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'delete-confirm-dialog-overlay';
            dialogOverlay.innerHTML = `
                <div class="delete-confirm-dialog">
                    <div class="dialog-header">
                        <h3>ç¡®è®¤åˆ é™¤</h3>
                        <button class="dialog-close-btn">Ã—</button>
                    </div>
                    <div class="dialog-content">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-message">
                            <p>æ‚¨ç¡®å®šè¦åˆ é™¤${type}"<strong>${name}</strong>"å—ï¼Ÿ</p>
                            <p class="warning-text">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œåˆ é™¤åæ‰€æœ‰ç›¸å…³æ•°æ®å°†ä¸¢å¤±ã€‚</p>
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-delete">ç¡®è®¤åˆ é™¤</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const deleteBtn = dialogOverlay.querySelector('.btn-delete');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤åˆ é™¤äº‹ä»¶
            deleteBtn.addEventListener('click', () => {
                closeDialog();
                if (onConfirm) {
                    onConfirm();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†
     */
    showSaveConfirmDialog(panelName, onConfirm) {
        try {
            console.log(`[InfoBarSettings] ğŸ“‹ æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†: ${panelName}`);

            // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'save-confirm-dialog-overlay';
            dialogOverlay.innerHTML = `
                <div class="save-confirm-dialog">
                    <div class="dialog-header">
                        <h3>ç¡®è®¤ä¿å­˜</h3>
                        <button class="dialog-close-btn">Ã—</button>
                    </div>
                    <div class="dialog-content">
                        <div class="info-icon">ğŸ’¾</div>
                        <div class="info-message">
                            <p>æ‚¨ç¡®å®šè¦ä¿å­˜é¢æ¿"<strong>${panelName}</strong>"çš„é…ç½®å—ï¼Ÿ</p>
                            <p class="info-text">ä¿å­˜åæ–°çš„é…ç½®å°†ç”Ÿæ•ˆã€‚</p>
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button class="btn-cancel">å–æ¶ˆ</button>
                        <button class="btn-save">ç¡®è®¤ä¿å­˜</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialogOverlay);

            // ç»‘å®šäº‹ä»¶
            const closeBtn = dialogOverlay.querySelector('.dialog-close-btn');
            const cancelBtn = dialogOverlay.querySelector('.btn-cancel');
            const saveBtn = dialogOverlay.querySelector('.btn-save');

            // å…³é—­å¯¹è¯æ¡†å‡½æ•°
            const closeDialog = () => {
                dialogOverlay.remove();
            };

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDialog);
            cancelBtn.addEventListener('click', closeDialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            dialogOverlay.addEventListener('click', (e) => {
                if (e.target === dialogOverlay) {
                    closeDialog();
                }
            });

            // ç¡®è®¤ä¿å­˜äº‹ä»¶
            saveBtn.addEventListener('click', () => {
                closeDialog();
                if (onConfirm) {
                    onConfirm();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹
     */
    addSubItem(subItemData = null) {
        try {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿
            if (!this.currentEditingPanel) {
                console.error('[InfoBarSettings] âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿ï¼Œæ— æ³•æ·»åŠ å­é¡¹');
                return;
            }

            // å¦‚æœæ²¡æœ‰æä¾›å­é¡¹æ•°æ®ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
            if (!subItemData) {
                this.showSubItemDialog();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“ å½“å‰ç¼–è¾‘é¢æ¿:', this.currentEditingPanel);
            console.log('[InfoBarSettings] ğŸ“Š æ·»åŠ å­é¡¹:', subItemData);

            // åˆ›å»ºæ–°çš„å­é¡¹
            const newSubItem = {
                id: `sub_${Date.now()}`,
                name: subItemData.name,
                key: subItemData.key,
                description: subItemData.description || ''
            };

            // æ·»åŠ åˆ°å­é¡¹å®¹å™¨ï¼ˆUIæ˜¾ç¤ºï¼‰
            this.addSubItemToContainer(newSubItem);

            console.log('[InfoBarSettings] â• æ·»åŠ å­é¡¹åˆ°é¢æ¿:', this.currentEditingPanel.id, 'å­é¡¹:', newSubItem.id);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * åˆ é™¤å­é¡¹
     */
    removeSubItem(buttonElement) {
        try {
            // æ‰¾åˆ°å­é¡¹è¡¨å•å…ƒç´ 
            const subItemForm = buttonElement.closest('.sub-item-form');
            if (!subItemForm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å­é¡¹è¡¨å•');
                return;
            }

            const subItemId = subItemForm.dataset.subItemId;
            const subItemName = subItemForm.querySelector('.sub-item-name')?.value || subItemId;

            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            this.showDeleteConfirmDialog('å­é¡¹', subItemName, () => {
                this.performRemoveSubItem(subItemForm, subItemId);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ é™¤å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * æ‰§è¡Œåˆ é™¤å­é¡¹æ“ä½œ
     */
    performRemoveSubItem(subItemForm, subItemId) {
        try {
            // 1) å…ˆä»UIç§»é™¤
            subItemForm.remove();

            // 2) è¯»å–å½“å‰ç¼–è¾‘çš„é¢æ¿ä¿¡æ¯
            const current = this.currentEditingPanel || {};
            const panelId = current.id;
            const panelType = current.type;

            // 3) è·å–è¢«åˆ å­é¡¹çš„åç§°/é”®åï¼Œä¾¿äºå¤šæ¡ä»¶åŒ¹é…
            const nameInput = subItemForm.querySelector?.('.sub-item-name');
            const subItemName = (nameInput?.value || '').trim();
            const subItemKey = subItemName ? subItemName.toLowerCase().replace(/\s+/g, '_') : null;

            // 4) æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
            const container = this.modal.querySelector('.sub-items-container');
            const remainingSubItems = container.querySelectorAll('.sub-item-form');
            const emptyMessage = container.querySelector('.empty-sub-items');
            if (remainingSubItems.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }

            // 5) æŒä¹…åŒ–åˆ é™¤åˆ°é…ç½®ï¼ˆæ ¹å› ï¼šä¹‹å‰ä»…åˆ UIï¼Œæœªå†™å…¥é…ç½®ï¼Œåˆ‡æ¢ååˆè¢«é…ç½®æ¢å¤ï¼‰
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            if (!panelId) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ç¡®å®šå½“å‰é¢æ¿IDï¼Œè·³è¿‡æŒä¹…åŒ–åˆ é™¤');
            } else if (panelType === 'custom') {
                // è‡ªå®šä¹‰é¢æ¿ï¼šä» customPanels ä¸ æ ¹çº§é•œåƒé…ç½® åŒæ­¥åˆ é™¤
                const customPanels = this.getCustomPanels();
                const panel = customPanels[panelId];
                if (panel && Array.isArray(panel.subItems)) {
                    const before = panel.subItems.length;
                    panel.subItems = panel.subItems.filter(item =>
                        item.id !== subItemId && item.key !== subItemKey && item.name !== subItemName
                    );
                    const after = panel.subItems.length;
                    console.log(`[InfoBarSettings] ğŸ§¹ è‡ªå®šä¹‰é¢æ¿ ${panelId} å­é¡¹å·²ä»å†…å­˜åˆ é™¤: ${before} -> ${after}`);

                    // æ ¹çº§é•œåƒï¼ˆç”¨äºæ•°æ®è¡¨æ ¼/å…¶ä»–æ¨¡å—è¯»å–ï¼‰
                    const mirrorKey = panel.key || panelId;
                    if (!extensionSettings['Information bar integration tool'][mirrorKey]) {
                        extensionSettings['Information bar integration tool'][mirrorKey] = { enabled: panel.enabled !== false };
                    }
                    extensionSettings['Information bar integration tool'][mirrorKey].subItems = panel.subItems;
                }
            } else if (panelType === 'basic') {
                // åŸºç¡€é¢æ¿ï¼šå†™å…¥æ ¹çº§é…ç½®çš„ subItems
                const panelConfig = extensionSettings['Information bar integration tool'][panelId];
                if (panelConfig && Array.isArray(panelConfig.subItems)) {
                    const before = panelConfig.subItems.length;
                    panelConfig.subItems = panelConfig.subItems.filter(item =>
                        item.id !== subItemId && item.key !== subItemKey && item.name !== subItemName
                    );
                    const after = panelConfig.subItems.length;
                    console.log(`[InfoBarSettings] ğŸ§¹ åŸºç¡€é¢æ¿ ${panelId} å­é¡¹å·²ä»é…ç½®åˆ é™¤: ${before} -> ${after}`);
                }
            }

            // 6) ä¿å­˜å¹¶æ›´æ–°è®¡æ•°/é€šçŸ¥
            if (typeof context.saveSettingsDebounced === 'function') {
                context.saveSettingsDebounced();
            }

            if (panelId) {
                // æ›´æ–°é¢æ¿è®¡æ•°æ˜¾ç¤º
                this.updatePanelConfigCount(panelId);

                // ç«‹å³åˆ·æ–°ç›¸å…³UIï¼Œé¿å…â€œå½±å­å­—æ®µâ€ä»æ˜¾ç¤º
                if (panelType === 'basic') {
                    this.refreshBasicPanelContent(panelId);
                } else if (panelType === 'custom') {
                    // é‡æ–°æ¸²æŸ“è‡ªå®šä¹‰é¢æ¿åŒºå—ï¼ˆå¯¼èˆªä¸å†…å®¹ï¼‰
                    this.refreshNavigation();
                }

                // é€šçŸ¥å…¶ä»–æ¨¡å—ï¼ˆå¦‚æ•°æ®è¡¨æ ¼ï¼‰
                if (this.eventSystem) {
                    this.eventSystem.emit('panel:config:changed', {
                        panelId,
                        panelType: panelType || 'custom',
                        subItemRemoved: true,
                        removedId: subItemId,
                        timestamp: Date.now()
                    });
                }
            }

            console.log('[InfoBarSettings] ğŸ—‘ï¸ åˆ é™¤å­é¡¹æˆåŠŸï¼ˆå·²æŒä¹…åŒ–ï¼‰:', { panelId, panelType, subItemId, subItemName });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œåˆ é™¤å­é¡¹æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹ï¼Œæ˜¾ç¤ºç”¨æˆ·æ·»åŠ çš„å­é¡¹
     */
    refreshBasicPanelContent(panelId) {
        try {
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥modalæ˜¯å¦å·²ç»åœ¨DOMä¸­å¹¶ä¸”å¯è§
            if (!document.body.contains(this.modal) || this.modal.style.display === 'none') {
                console.log(`[InfoBarSettings] âš ï¸ Modalæœªæ˜¾ç¤ºæˆ–ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹`);
                return;
            }

            // è·å–å¯¹åº”çš„å†…å®¹é¢æ¿
            const contentPanel = this.modal.querySelector(`[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°åŸºç¡€é¢æ¿ ${panelId} çš„å†…å®¹é¢æ¿`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä»é…ç½®ä¸­è·å–è¯¥é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼Œé¿å…äº¤å‰æ±¡æŸ“
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const savedConfig = extensionSettings['Information bar integration tool']?.[panelId];

            // ğŸ”§ ä¿®å¤ï¼šåªè·å–å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹
            const customSubItems = savedConfig?.subItems || [];

            if (customSubItems.length === 0) {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰è‡ªå®šä¹‰å­é¡¹ï¼Œè·³è¿‡åˆ·æ–°`);
                // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const existingCustomArea = contentPanel.querySelector('.custom-sub-items-area');
                if (existingCustomArea) {
                    existingCustomArea.remove();
                    console.log(`[InfoBarSettings] ğŸ§¹ å·²æ¸…ç†åŸºç¡€é¢æ¿ ${panelId} çš„æ—§è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ`);
                }
                return;
            }

            // æŸ¥æ‰¾å­é¡¹å®¹å™¨
            let subItemsContainer = contentPanel.querySelector('.sub-items');
            if (!subItemsContainer) {
                console.log(`[InfoBarSettings] âš ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰å­é¡¹å®¹å™¨`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯è‡ªå®šä¹‰å­é¡¹æ˜¯å¦çœŸçš„å±äºå½“å‰é¢æ¿
            const validCustomSubItems = customSubItems.filter(subItem => {
                // æ£€æŸ¥å­é¡¹æ˜¯å¦æœ‰æ˜ç¡®çš„é¢æ¿å½’å±æ ‡è®°
                if (subItem.panelId && subItem.panelId !== panelId) {
                    console.warn(`[InfoBarSettings] âš ï¸ å‘ç°é”™è¯¯å½’å±çš„è‡ªå®šä¹‰å­é¡¹: ${subItem.name} å±äº ${subItem.panelId}ï¼Œä½†è¢«æ·»åŠ åˆ° ${panelId}`);
                    return false;
                }
                return true;
            });

            // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹çš„HTML
            let customSubItemsHTML = '';
            validCustomSubItems.forEach((subItem, index) => {
                const checkboxId = `${panelId}-custom-${index}`;
                const fieldName = `${panelId}.${subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_')}.enabled`;

                customSubItemsHTML += `
                    <div class="sub-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox"
                                   id="${checkboxId}"
                                   name="${fieldName}"
                                   ${subItem.enabled !== false ? 'checked' : ''} />
                            <label for="${checkboxId}" class="checkbox-label">${subItem.displayName || subItem.name}</label>
                        </div>
                    </div>
                `;
            });

            if (customSubItemsHTML) {
                // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰å­é¡¹åŒºåŸŸï¼Œé¿å…é‡å¤æ·»åŠ 
                const existingCustomAreas = contentPanel.querySelectorAll('.custom-sub-items-area');
                existingCustomAreas.forEach(area => area.remove());

                // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const customArea = document.createElement('div');
                customArea.className = 'custom-sub-items-area';
                customArea.setAttribute('data-panel-id', panelId); // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿IDæ ‡è®°
                customArea.innerHTML = `
                    <div class="sub-item-section">
                        <h4 class="section-title">ğŸ”§ è‡ªå®šä¹‰å­é¡¹</h4>
                        <div class="sub-item-row">
                            ${customSubItemsHTML}
                        </div>
                    </div>
                `;

                // æ’å…¥åˆ°å­é¡¹å®¹å™¨çš„æœ«å°¾
                subItemsContainer.appendChild(customArea);

                // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                this.applyThemeToCustomSubItems(customArea, panelId);

                console.log(`[InfoBarSettings] âœ… å·²ä¸ºåŸºç¡€é¢æ¿ ${panelId} æ·»åŠ  ${validCustomSubItems.length} ä¸ªè‡ªå®šä¹‰å­é¡¹`);

                // æ›´æ–°é¢æ¿è®¡æ•°
                this.updatePanelConfigCount(panelId);
            } else {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰æœ‰æ•ˆçš„è‡ªå®šä¹‰å­é¡¹`);
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹å¤±è´¥:`, error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ·æ–°æ‰€æœ‰åŸºç¡€é¢æ¿å†…å®¹ï¼Œç¡®ä¿æ–°å¢å­é¡¹ç«‹å³æ˜¾ç¤º
     */
    refreshAllBasicPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰åŸºç¡€é¢æ¿å†…å®¹...');

            const basicPanelIds = ['personal', 'interaction', 'tasks', 'world', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];

            let refreshedCount = 0;
            basicPanelIds.forEach(panelId => {
                const panelData = this.getBasicPanelData(panelId);
                if (panelData && panelData.subItems && panelData.subItems.length > 0) {
                    // ä¸´æ—¶ç§»é™¤modalå¯è§æ€§æ£€æŸ¥ï¼Œå¼ºåˆ¶åˆ·æ–°
                    this.forceRefreshBasicPanelContent(panelId);
                    refreshedCount++;
                }
            });

            console.log(`[InfoBarSettings] âœ… å·²åˆ·æ–° ${refreshedCount} ä¸ªåŸºç¡€é¢æ¿çš„å†…å®¹`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æ‰€æœ‰åŸºç¡€é¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹ï¼ˆå¿½ç•¥modalå¯è§æ€§æ£€æŸ¥ï¼‰
     */
    forceRefreshBasicPanelContent(panelId) {
        try {
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡å¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿å†…å®¹');
                return;
            }

            // è·å–å¯¹åº”çš„å†…å®¹é¢æ¿
            const contentPanel = this.modal.querySelector(`[data-content="${panelId}"]`);
            if (!contentPanel) {
                console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°åŸºç¡€é¢æ¿ ${panelId} çš„å†…å®¹é¢æ¿`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä»é…ç½®ä¸­è·å–è¯¥é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼Œé¿å…äº¤å‰æ±¡æŸ“
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const savedConfig = extensionSettings['Information bar integration tool']?.[panelId];

            // ğŸ”§ ä¿®å¤ï¼šåªè·å–å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹
            const customSubItems = savedConfig?.subItems || [];

            if (customSubItems.length === 0) {
                console.log(`[InfoBarSettings] â„¹ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰è‡ªå®šä¹‰å­é¡¹ï¼Œè·³è¿‡å¼ºåˆ¶åˆ·æ–°`);
                return;
            }

            // æŸ¥æ‰¾å­é¡¹å®¹å™¨
            let subItemsContainer = contentPanel.querySelector('.sub-items');
            if (!subItemsContainer) {
                console.log(`[InfoBarSettings] âš ï¸ åŸºç¡€é¢æ¿ ${panelId} æ²¡æœ‰å­é¡¹å®¹å™¨`);
                return;
            }

            // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹çš„HTML
            let customSubItemsHTML = '';
            panelData.subItems.forEach((subItem, index) => {
                const checkboxId = `${panelId}-custom-${index}`;
                const fieldName = `${panelId}.${subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_')}.enabled`;

                customSubItemsHTML += `
                    <div class="sub-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox"
                                   id="${checkboxId}"
                                   name="${fieldName}"
                                   ${subItem.enabled !== false ? 'checked' : ''} />
                            <label for="${checkboxId}" class="checkbox-label">${subItem.displayName || subItem.name}</label>
                        </div>
                    </div>
                `;
            });

            if (customSubItemsHTML) {
                // å¦‚æœå·²ç»å­˜åœ¨è‡ªå®šä¹‰å­é¡¹åŒºåŸŸï¼Œå…ˆåˆ é™¤
                const existingCustomArea = contentPanel.querySelector('.custom-sub-items-area');
                if (existingCustomArea) {
                    existingCustomArea.remove();
                }

                // åˆ›å»ºè‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                const customArea = document.createElement('div');
                customArea.className = 'custom-sub-items-area';
                customArea.innerHTML = `
                    <div class="sub-item-section">
                        <h4 class="section-title">ğŸ”§ è‡ªå®šä¹‰å­é¡¹</h4>
                        <div class="sub-item-row">
                            ${customSubItemsHTML}
                        </div>
                    </div>
                `;

                // æ’å…¥åˆ°å­é¡¹å®¹å™¨çš„æœ«å°¾
                subItemsContainer.appendChild(customArea);

                // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
                this.applyThemeToCustomSubItems(customArea, panelId);

                console.log(`[InfoBarSettings] âœ… å·²å¼ºåˆ¶ä¸ºåŸºç¡€é¢æ¿ ${panelId} æ·»åŠ  ${panelData.subItems.length} ä¸ªè‡ªå®šä¹‰å­é¡¹`);

                // æ›´æ–°é¢æ¿è®¡æ•°
                this.updatePanelConfigCount(panelId);
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ å¼ºåˆ¶åˆ·æ–°åŸºç¡€é¢æ¿ ${panelId} å†…å®¹å¤±è´¥:`, error);
        }
    }

    /**
     * åˆ·æ–°å¯¼èˆªæ ï¼ˆæ·»åŠ /ç§»é™¤è‡ªå®šä¹‰é¢æ¿ï¼‰
     */
    refreshNavigation() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°å¯¼èˆªæ ');
                return;
            }

            const sidebar = this.modal.querySelector('.sidebar-nav');
            const contentArea = this.modal.querySelector('.content-area');
            if (!sidebar || !contentArea) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å¯¼èˆªæ æˆ–å†…å®¹åŒºåŸŸ');
                console.log('[InfoBarSettings] ğŸ” æ¨¡æ€æ¡†ç»“æ„:', this.modal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                if (this.modal) {
                    console.log('[InfoBarSettings] ğŸ” æŸ¥æ‰¾ .sidebar-nav:', !!this.modal.querySelector('.sidebar-nav'));
                    console.log('[InfoBarSettings] ğŸ” æŸ¥æ‰¾ .content-area:', !!this.modal.querySelector('.content-area'));
                }
                return;
            }

            // è·å–è‡ªå®šä¹‰é¢æ¿
            const customPanels = this.getCustomPanels();
            const customPanelArray = Object.values(customPanels);

            // ğŸ”§ æ›´ç¨³å¥çš„å»é‡æ¸…ç†ï¼šæŒ‰IDé›†åˆå’Œæ ‡è®°æ¸…ç†ï¼Œé¿å…é‡å¤
            const customIds = new Set(customPanelArray.map(p => p.id));

            // 1) æ¸…ç†å¸¦æ ‡è®°çš„æ•°æ®
            sidebar.querySelectorAll('.nav-item[data-custom="true"]').forEach(nav => nav.remove());
            contentArea.querySelectorAll('.content-panel[data-custom="true"]').forEach(panel => panel.remove());

            // 2) å…¼å®¹æ—§å…ƒç´ ï¼šæŒ‰IDåŒ¹é…æ¸…ç†
            sidebar.querySelectorAll('.nav-item').forEach(nav => {
                const id = nav.dataset.nav;
                if (id && customIds.has(id)) {
                    nav.remove();
                }
            });
            contentArea.querySelectorAll('.content-panel').forEach(panel => {
                const id = panel.dataset.content;
                if (id && customIds.has(id)) {
                    panel.remove();
                }
            });

            console.log('[InfoBarSettings] ğŸ“Š è·å–åˆ°çš„è‡ªå®šä¹‰é¢æ¿æ•°æ®:', customPanels);
            console.log('[InfoBarSettings] ğŸ“Š è½¬æ¢åçš„æ•°ç»„é•¿åº¦:', customPanelArray.length);

            // æ‰¾åˆ°ä¸»é¢˜è®¾ç½®å¯¼èˆªé¡¹ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥è‡ªå®šä¹‰é¢æ¿
            const themeNavItem = sidebar.querySelector('.nav-item[data-nav="theme"]');

            // ä¸ºæ¯ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå¯¼èˆªé¡¹å’Œå†…å®¹é¢æ¿
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å¯¼èˆªï¼Œæ•°ç»„é•¿åº¦:', customPanelArray.length);

            customPanelArray.forEach((panel, index) => {
                console.log(`[InfoBarSettings] ğŸ”§ åˆ›å»ºç¬¬${index + 1}ä¸ªè‡ªå®šä¹‰é¢æ¿:`, panel.id, panel.name);

                // åˆ›å»ºå¯¼èˆªé¡¹
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.dataset.nav = panel.id;
                navItem.dataset.custom = 'true';
                navItem.innerHTML = `

                    <span class="nav-text">${panel.name}</span>
                `;

                // åœ¨ä¸»é¢˜è®¾ç½®ä¹‹å‰æ’å…¥å¯¼èˆªé¡¹
                if (themeNavItem) {
                    sidebar.insertBefore(navItem, themeNavItem);
                } else {
                    sidebar.appendChild(navItem);
                }

                // åˆ›å»ºå†…å®¹é¢æ¿
                const contentPanel = document.createElement('div');
                contentPanel.className = 'content-panel';
                contentPanel.dataset.content = panel.id;
                contentPanel.dataset.custom = 'true';
                contentPanel.innerHTML = this.createCustomPanelContent(panel);

                // æ·»åŠ åˆ°å†…å®¹åŒºåŸŸ
                contentArea.appendChild(contentPanel);

                // åº”ç”¨ä¸»é¢˜å¹¶ç»‘å®šè‡ªå®šä¹‰å­é¡¹äº¤äº’ï¼ˆç¡®ä¿å¤é€‰æ¡†äº‹ä»¶ä¸æ ·å¼ï¼‰
                this.applyThemeToCustomSubItems(contentPanel, panel.id);

                console.log(`[InfoBarSettings] âœ… ç¬¬${index + 1}ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå®Œæˆ`);
            });

            // åº”ç”¨å½“å‰ä¸»é¢˜åˆ°æ–°åˆ›å»ºçš„è‡ªå®šä¹‰é¢æ¿
            this.applyCurrentThemeToCustomPanels();

            console.log('[InfoBarSettings] ğŸ”„ å¯¼èˆªæ å·²åˆ·æ–°ï¼Œæ·»åŠ äº†', customPanelArray.length, 'ä¸ªè‡ªå®šä¹‰é¢æ¿');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°å¯¼èˆªæ å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
     */
    applyThemeToCustomSubItems(customArea, panelId) {
        try {
            if (!customArea) return;

            // è·å–å½“å‰ä¸»é¢˜é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const currentTheme = configs.theme?.current || 'neon-blue';

            // åº”ç”¨ä¸»é¢˜æ ·å¼åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ
            const subItemSection = customArea.querySelector('.sub-item-section');
            if (subItemSection) {
                subItemSection.setAttribute('data-theme', currentTheme);

                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰å¤é€‰æ¡†
                const checkboxes = customArea.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.setAttribute('data-theme', currentTheme);

                    // ğŸ”§ ä¿®å¤ï¼šä¸ºæ¯ä¸ªè‡ªå®šä¹‰å­é¡¹å¤é€‰æ¡†ç»‘å®šå˜æ›´äº‹ä»¶ï¼ŒåŒæ­¥æ•°æ®è¡¨æ ¼
                    checkbox.addEventListener('change', (e) => {
                        this.handleCustomSubItemChange(e, panelId);
                    });
                });

                // åº”ç”¨ä¸»é¢˜åˆ°æ ‡ç­¾
                const labels = customArea.querySelectorAll('.checkbox-label');
                labels.forEach(label => {
                    label.setAttribute('data-theme', currentTheme);
                });

                console.log(`[InfoBarSettings] ğŸ¨ å·²åº”ç”¨ä¸»é¢˜ ${currentTheme} åˆ°è‡ªå®šä¹‰å­é¡¹åŒºåŸŸ`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†è‡ªå®šä¹‰å­é¡¹å¤é€‰æ¡†å˜æ›´äº‹ä»¶ï¼ŒåŒæ­¥æ•°æ®è¡¨æ ¼
     */
    handleCustomSubItemChange(event, panelId) {
        try {
            const checkbox = event.target;
            const fieldName = checkbox.name;
            const isEnabled = checkbox.checked;

            console.log(`[InfoBarSettings] ğŸ”„ åŸºç¡€é¢æ¿ ${panelId} è‡ªå®šä¹‰å­é¡¹å˜æ›´: ${fieldName} = ${isEnabled}`);

            // è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°
            if (this.eventSystem) {
                this.eventSystem.emit('panel:config:changed', {
                    panelId: panelId,
                    panelType: 'basic',
                    subItemChanged: true,
                    fieldName: fieldName,
                    enabled: isEnabled,
                    timestamp: Date.now()
                });
                console.log('[InfoBarSettings] ğŸ“‹ å·²è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°');
            }

            // ç«‹å³ä¿å­˜å˜æ›´åˆ°é…ç½®ä¸­
            this.saveCustomSubItemState(panelId, fieldName, isEnabled);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªå®šä¹‰å­é¡¹å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€åˆ°é…ç½®
     */
    saveCustomSubItemState(panelId, fieldName, isEnabled) {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // è·å–åŸºç¡€é¢æ¿é…ç½®
            const panelConfig = extensionSettings['Information bar integration tool'][panelId];
            if (panelConfig && panelConfig.subItems) {
                // æŸ¥æ‰¾å¯¹åº”çš„å­é¡¹å¹¶æ›´æ–°çŠ¶æ€
                const subItemKey = fieldName.split('.')[1]; // ä» 'panelId.key.enabled' ä¸­æå– key
                const subItem = panelConfig.subItems.find(item =>
                    item.key === subItemKey ||
                    item.name.toLowerCase().replace(/\s+/g, '_') === subItemKey
                );

                if (subItem) {
                    subItem.enabled = isEnabled;
                    console.log(`[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€: ${subItem.name} = ${isEnabled}`);

                    // ä¿å­˜åˆ° SillyTavern
                    context.saveSettingsDebounced();
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è‡ªå®šä¹‰å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨å½“å‰ä¸»é¢˜åˆ°è‡ªå®šä¹‰é¢æ¿
     */
    applyCurrentThemeToCustomPanels() {
        try {
            // è·å–å½“å‰ä¸»é¢˜
            const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
            if (!activeThemeCard) {
                console.log('[InfoBarSettings] ğŸ¨ æœªæ‰¾åˆ°æ¿€æ´»çš„ä¸»é¢˜ï¼Œè·³è¿‡è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨');
                return;
            }

            const themeId = activeThemeCard.getAttribute('data-theme');
            const theme = this.getThemeById(themeId);
            if (!theme) {
                console.log('[InfoBarSettings] ğŸ¨ æœªæ‰¾åˆ°ä¸»é¢˜é…ç½®ï¼Œè·³è¿‡è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿å¯¼èˆªé¡¹ï¼ˆä½¿ç”¨é”®åIDæ ¼å¼ï¼‰
            const customNavItems = this.modal.querySelectorAll('.nav-item[data-nav^="Custom"]');
            const customContentPanels = this.modal.querySelectorAll('.content-panel[data-content^="Custom"]');

            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜åˆ°', customNavItems.length, 'ä¸ªè‡ªå®šä¹‰å¯¼èˆªé¡¹');

            // åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å¯¼èˆªé¡¹
            customNavItems.forEach(navItem => {
                navItem.style.backgroundColor = theme.colors.bg;
                navItem.style.color = theme.colors.text;
                navItem.style.borderColor = theme.colors.border;
            });

            // åº”ç”¨ä¸»é¢˜åˆ°è‡ªå®šä¹‰å†…å®¹é¢æ¿
            customContentPanels.forEach(contentPanel => {
                contentPanel.style.backgroundColor = theme.colors.bg;
                contentPanel.style.color = theme.colors.text;
                contentPanel.style.borderColor = theme.colors.border;
            });

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨è‡ªå®šä¹‰é¢æ¿ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å†…å®¹
     */
    createCustomPanelContent(panel) {
        // è®¡ç®—å­é¡¹é…ç½®çŠ¶æ€
        const subItems = panel.subItems || [];
        const enabledSubItems = subItems.filter(item => item.enabled !== false);
        const statusText = `${enabledSubItems.length}/${subItems.length} é¡¹å·²é…ç½®`;

        return `
            <div class="content-header">
                <h3>${panel.name}</h3>
            </div>

            <div class="content-body">
                <!-- è‡ªå®šä¹‰é¢æ¿å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“„</div>
                            <div class="card-text">
                                <div class="card-title">${panel.name}</div>
                                <div class="card-subtitle">${panel.description}</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" name="${panel.key}.enabled" id="${panel.id}-enabled" ${panel.enabled ? 'checked' : ''} />
                                <label for="${panel.id}-enabled" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge ${panel.enabled ? 'enabled' : 'disabled'}">${panel.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</span>
                            <span class="status-count" id="${panel.id}-panel-count">${statusText}</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    ${this.createCustomPanelSubItems(panel.subItems || [])}
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰é¢æ¿å­é¡¹ï¼ˆä¸åŸºç¡€é¢æ¿ä¸€è‡´çš„ä¸¤åˆ—å¸ƒå±€ï¼‰
     */
    createCustomPanelSubItems(subItems) {
        if (!subItems || subItems.length === 0) {
            return `
                <div class="empty-sub-items">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">æš‚æ— å­é¡¹é…ç½®</div>
                </div>
            `;
        }

        // å°†å­é¡¹æŒ‰ä¸¤ä¸ªä¸€ç»„åˆ†ç»„ï¼Œå®ç°ä¸¤åˆ—å¸ƒå±€
        const rows = [];
        for (let i = 0; i < subItems.length; i += 2) {
            const leftItem = subItems[i];
            const rightItem = subItems[i + 1];

            const leftItemHtml = this.createSubItemHtml(leftItem);
            const rightItemHtml = rightItem ? this.createSubItemHtml(rightItem) : '<div class="sub-item"></div>'; // ç©ºå ä½ç¬¦

            rows.push(`
                <div class="sub-item-row">
                    ${leftItemHtml}
                    ${rightItemHtml}
                </div>
            `);
        }

        return rows.join('');
    }

    /**
     * åˆ›å»ºå•ä¸ªå­é¡¹HTMLï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤šè¡Œæ•°æ®é…ç½®ï¼‰
     */
    createSubItemHtml(subItem) {
        if (!subItem) return '<div class="sub-item"></div>';

        // ç¡®ä¿å­é¡¹æœ‰enabledå±æ€§ï¼Œé»˜è®¤ä¸ºtrue
        const isEnabled = subItem.enabled !== false;
        // ä½¿ç”¨å­é¡¹çš„nameä½œä¸ºè¡¨å•å­—æ®µåï¼Œç¡®ä¿èƒ½è¢«collectFormDataæ”¶é›†
        const fieldName = subItem.name || subItem.key || subItem.id;

        return `
            <div class="sub-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox"
                           id="${subItem.id}"
                           name="${fieldName}"
                           ${isEnabled ? 'checked' : ''} />
                    <label for="${subItem.id}" class="checkbox-label">
                        ${subItem.name}
                    </label>
                </div>
            </div>
        `;
    }



    /**
     * æ”¶é›†åŸºç¡€é¢æ¿è¡¨å•æ•°æ®ï¼ˆä¸åŒ…å«å­é¡¹ï¼‰
     */
    collectBasicPanelFormData() {
        try {
            const form = this.modal.querySelector('.panel-properties-form');
            const formData = {};

            // åŸºæœ¬ä¿¡æ¯ï¼ˆåŸºç¡€é¢æ¿çš„nameå’Œkeyä¸ä¿å­˜ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
            // formData.name = form.querySelector('#panel-name')?.value || '';  // åŸºç¡€é¢æ¿åç§°ä¸å¯ä¿®æ”¹
            // formData.key = form.querySelector('#panel-key')?.value || '';    // åŸºç¡€é¢æ¿é”®åä¸å¯ä¿®æ”¹
            formData.description = form.querySelector('#panel-description')?.value || '';
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // formData.icon = form.querySelector('#panel-icon')?.value || 'ğŸ¨';

            // é…ç½®é€‰é¡¹
            formData.required = form.querySelector('#panel-required')?.checked || false;
            formData.memoryInject = form.querySelector('#panel-memory-inject')?.checked || false;


            // æç¤ºè¯é…ç½®
            formData.prompts = {
                init: form.querySelector('#panel-prompt-init')?.value || '',
                insert: form.querySelector('#panel-prompt-insert')?.value || '',
                update: form.querySelector('#panel-prompt-update')?.value || '',
                delete: form.querySelector('#panel-prompt-delete')?.value || ''
            };

            // ğŸ”§ ä¿®å¤ï¼šåŸºç¡€é¢æ¿ä¹Ÿéœ€è¦ä¿å­˜ç”¨æˆ·æ·»åŠ çš„å­é¡¹æ•°æ®
            formData.subItems = this.collectSubItemsData();

            console.log('[InfoBarSettings] ğŸ“Š åŸºç¡€é¢æ¿è¡¨å•æ•°æ®ï¼ˆå«å­é¡¹ï¼‰:', formData);
            return formData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†åŸºç¡€é¢æ¿è¡¨å•æ•°æ®å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ”¶é›†é¢æ¿è¡¨å•æ•°æ®
     */
    collectPanelFormData() {
        try {
            const form = this.modal.querySelector('.panel-properties-form');
            const formData = {};

            // åŸºæœ¬ä¿¡æ¯
            formData.name = form.querySelector('#panel-name')?.value || '';
            formData.key = form.querySelector('#panel-key')?.value || '';
            formData.description = form.querySelector('#panel-description')?.value || '';
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // formData.icon = form.querySelector('#panel-icon')?.value || 'ğŸ¨';

            // é…ç½®é€‰é¡¹
            formData.required = form.querySelector('#panel-required')?.checked || false;
            formData.memoryInject = form.querySelector('#panel-memory-inject')?.checked || false;


            // æç¤ºè¯é…ç½®
            formData.prompts = {
                init: form.querySelector('#panel-prompt-init')?.value || '',
                insert: form.querySelector('#panel-prompt-insert')?.value || '',
                update: form.querySelector('#panel-prompt-update')?.value || '',
                delete: form.querySelector('#panel-prompt-delete')?.value || ''
            };

            // å­é¡¹é…ç½®ï¼ˆä»å­é¡¹å®¹å™¨æ”¶é›†ï¼‰
            formData.subItems = this.collectSubItemsData();

            return formData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†é¢æ¿è¡¨å•æ•°æ®å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ”¶é›†å­é¡¹æ•°æ®ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤šè¡Œæ•°æ®é…ç½®ï¼‰
     */
    collectSubItemsData() {
        try {
            const subItems = [];

            // ğŸ”§ ä¿®å¤ï¼šè·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢æ¿IDï¼Œç¡®ä¿å­é¡¹å½’å±æ­£ç¡®
            const currentPanelId = this.currentEditingPanel?.id;
            if (!currentPanelId) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ç¡®å®šå½“å‰ç¼–è¾‘çš„é¢æ¿IDï¼Œè·³è¿‡å­é¡¹æ”¶é›†');
                return [];
            }

            const subItemElements = this.modal.querySelectorAll('.sub-item-form');

            subItemElements.forEach(element => {
                const name = element.querySelector('.sub-item-name')?.value || '';
                if (name.trim()) { // åªæœ‰åç§°ä¸ä¸ºç©ºæ‰æ·»åŠ 
                    const subItemId = element.dataset.subItemId;
                    const subItemName = name.trim();

                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è·å–è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å¯ç”¨çŠ¶æ€
                    // è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å¤é€‰æ¡†nameå°±æ˜¯å­é¡¹åç§°æœ¬èº«
                    const checkbox = this.modal.querySelector(`input[name="${subItemName}"]`);
                    const isEnabled = checkbox ? checkbox.checked : true; // å¦‚æœæ‰¾ä¸åˆ°å¤é€‰æ¡†ï¼Œé»˜è®¤å¯ç”¨

                    const subItem = {
                        id: subItemId,
                        name: subItemName,
                        key: subItemName.toLowerCase().replace(/\s+/g, '_'), // åç§°è½¬æ¢ä¸ºé”®å
                        displayName: subItemName, // ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æ˜¾ç¤ºåç§°
                        enabled: isEnabled, // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¤é€‰æ¡†çš„çœŸå®çŠ¶æ€
                        value: '', // æ·»åŠ é»˜è®¤å€¼å­—æ®µ
                        panelId: currentPanelId // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿å½’å±æ ‡è®°
                    };

                    console.log(`[InfoBarSettings] ğŸ“Š æ”¶é›†å­é¡¹: ${subItemName} enabled=${isEnabled} panelId=${currentPanelId}`);
                    subItems.push(subItem);
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šåªä»å½“å‰é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹åŒºåŸŸæ”¶é›†å­é¡¹è®¾ç½®
            const currentPanelContent = this.modal.querySelector(`[data-content="${currentPanelId}"]`);
            if (currentPanelContent) {
                const customSubItemsArea = currentPanelContent.querySelector('.custom-sub-items-area');
                if (customSubItemsArea) {
                    const existingSubItems = customSubItemsArea.querySelectorAll('.sub-item');
                    existingSubItems.forEach(subItemElement => {
                        const checkbox = subItemElement.querySelector('input[type="checkbox"]');

                        if (checkbox) {
                            const fieldName = checkbox.getAttribute('name');
                            const isEnabled = checkbox.checked;

                            // ğŸ”§ ä¿®å¤ï¼šæå–å­é¡¹åç§°ï¼Œå»é™¤é¢æ¿å‰ç¼€
                            const subItemName = fieldName.replace(`${currentPanelId}.`, '').replace('.enabled', '');

                            // æŸ¥æ‰¾æ˜¯å¦å·²åœ¨subItemsä¸­å­˜åœ¨
                            let existingSubItem = subItems.find(item =>
                                item.name === subItemName || item.key === subItemName
                            );

                            if (existingSubItem) {
                                // æ›´æ–°å·²å­˜åœ¨çš„å­é¡¹
                                existingSubItem.enabled = isEnabled;
                            } else {
                                // ğŸ”§ ä¿®å¤ï¼šåªæ·»åŠ å±äºå½“å‰é¢æ¿çš„å­é¡¹
                                if (fieldName.startsWith(`${currentPanelId}.`)) {
                                    const subItem = {
                                        id: `existing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                        name: subItemName,
                                        key: subItemName.toLowerCase().replace(/\s+/g, '_'),
                                        displayName: subItemName,
                                        enabled: isEnabled,
                                        value: '',
                                        panelId: currentPanelId // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ é¢æ¿å½’å±æ ‡è®°
                                    };
                                    subItems.push(subItem);
                                    console.log(`[InfoBarSettings] ğŸ“Š æ”¶é›†ç°æœ‰å­é¡¹é…ç½®: ${subItemName} enabled=${isEnabled} panelId=${currentPanelId}`);
                                }
                            }
                        }
                    });
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„å­é¡¹æ•°æ®è¯¦æƒ…:', subItems);
            return subItems;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å­é¡¹æ•°æ®å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * è·å–å­é¡¹é»˜è®¤å€¼
     */
    getSubItemDefaultValue(element) {
        const type = element.querySelector('.sub-item-type')?.value;
        const defaultInput = element.querySelector('.sub-item-default');

        switch (type) {
            case 'checkbox':
                return defaultInput?.checked || false;
            case 'number':
                return parseFloat(defaultInput?.value) || 0;
            default:
                return defaultInput?.value || '';
        }
    }
    /**
     * è·å–å­é¡¹é€‰é¡¹ï¼ˆç”¨äºselectç±»å‹ï¼‰
     */
    getSubItemOptions(element) {
        try {
            const optionsContainer = element.querySelector('.sub-item-options');
            const optionInputs = optionsContainer?.querySelectorAll('.option-input');
            const options = [];

            optionInputs?.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    options.push(value);
                }
            });

            return options;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å­é¡¹é€‰é¡¹å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * åŠ è½½é¢æ¿æ•°æ®åˆ°è¡¨å•
     */
    loadPanelDataToForm(panelId, panelType) {
        try {
            let panelData = null;

            if (panelType === 'basic') {
                // è·å–åŸºç¡€é¢æ¿æ•°æ®
                panelData = this.getBasicPanelData(panelId);
            } else {
                // è·å–è‡ªå®šä¹‰é¢æ¿æ•°æ®
                const customPanels = this.getCustomPanels();
                panelData = customPanels[panelId];
            }

            if (!panelData) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°é¢æ¿æ•°æ®:', panelId);
                return;
            }

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            this.fillBasicPanelInfo(panelData, panelType);

            // å¡«å……æç¤ºè¯é…ç½®
            this.fillPanelPrompts(panelData, panelType);

            // å¡«å……å­é¡¹é…ç½®
            this.fillSubItems(panelData.subItems || []);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é¢æ¿æ•°æ®å¤±è´¥:', error);
        }
    }

    /**
     * è·å–åŸºç¡€é¢æ¿æ•°æ®
     */
    getBasicPanelData(panelId) {
        // é»˜è®¤åŸºç¡€é¢æ¿æ•°æ®
        const defaultBasicPanelsData = {
            // ç§»é™¤åŸºç¡€è®¾ç½®é¢æ¿ï¼Œå®ƒæ˜¯ç³»ç»Ÿè®¾ç½®ï¼Œä¸æ˜¯é¢æ¿
            personal: { name: 'ä¸ªäººä¿¡æ¯', key: 'personal', description: 'ä¸ªäººç›¸å…³ä¿¡æ¯é…ç½®', icon: 'ğŸ‘¤', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            interaction: { name: 'äº¤äº’å¯¹è±¡', key: 'interaction', description: 'äº¤äº’å¯¹è±¡ç›¸å…³é…ç½®', icon: 'ğŸ‘¥', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            tasks: { name: 'ä»»åŠ¡ç³»ç»Ÿ', key: 'tasks', description: 'ä»»åŠ¡ç³»ç»Ÿç›¸å…³é…ç½®', icon: 'ğŸ“‹', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            world: { name: 'ä¸–ç•Œè®¾å®š', key: 'world', description: 'ä¸–ç•Œè®¾å®šç›¸å…³é…ç½®', icon: 'ğŸŒ', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            organization: { name: 'ç»„ç»‡æ¶æ„', key: 'organization', description: 'ç»„ç»‡æ¶æ„ç›¸å…³é…ç½®', icon: 'ğŸ¢', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            news: { name: 'æ–°é—»äº‹ä»¶', key: 'news', description: 'æ–°é—»äº‹ä»¶ç›¸å…³é…ç½®', icon: 'ğŸ“°', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            inventory: { name: 'ç‰©å“æ¸…å•', key: 'inventory', description: 'ç‰©å“æ¸…å•ç›¸å…³é…ç½®', icon: 'ğŸ’', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            abilities: { name: 'èƒ½åŠ›æŠ€èƒ½', key: 'abilities', description: 'èƒ½åŠ›æŠ€èƒ½ç›¸å…³é…ç½®', icon: 'âš¡', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            plot: { name: 'å‰§æƒ…å‘å±•', key: 'plot', description: 'å‰§æƒ…å‘å±•ç›¸å…³é…ç½®', icon: 'ğŸ“–', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            cultivation: { name: 'ä¿®ç‚¼ç³»ç»Ÿ', key: 'cultivation', description: 'ä¿®ç‚¼ç³»ç»Ÿç›¸å…³é…ç½®', icon: 'ğŸ§˜', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            fantasy: { name: 'ç„å¹»ä¸–ç•Œ', key: 'fantasy', description: 'ç„å¹»ä¸–ç•Œç›¸å…³é…ç½®', icon: 'ğŸ”®', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            modern: { name: 'ç°ä»£éƒ½å¸‚', key: 'modern', description: 'ç°ä»£éƒ½å¸‚ç›¸å…³é…ç½®', icon: 'ğŸ™ï¸', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            historical: { name: 'å†å²å¤ä»£', key: 'historical', description: 'å†å²å¤ä»£ç›¸å…³é…ç½®', icon: 'ğŸ›ï¸', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            magic: { name: 'é­”æ³•èƒ½åŠ›', key: 'magic', description: 'é­”æ³•èƒ½åŠ›ç›¸å…³é…ç½®', icon: 'ğŸª„', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] },
            training: { name: 'è°ƒæ•™ç³»ç»Ÿ', key: 'training', description: 'è°ƒæ•™ç³»ç»Ÿç›¸å…³é…ç½®', icon: 'ğŸ¯', prompts: { init: '', insert: '', update: '', delete: '' }, subItems: [] }
        };

        // ğŸ”§ ä¿®å¤ï¼šè·å–é»˜è®¤æ•°æ®
        const defaultPanelData = defaultBasicPanelsData[panelId];
        if (!defaultPanelData) {
            return null;
        }

        try {
            // ğŸ”§ ä¿®å¤ï¼šä» extensionSettings è¯»å–å·²ä¿å­˜çš„åŸºç¡€é¢æ¿é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const savedConfig = extensionSettings['Information bar integration tool']?.[panelId];

            if (savedConfig) {
                console.log('[InfoBarSettings] ğŸ“Š ä»é…ç½®è¯»å–åŸºç¡€é¢æ¿æ•°æ®:', panelId);

                // åˆå¹¶é»˜è®¤æ•°æ®å’Œå·²ä¿å­˜çš„é…ç½®ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
                const mergedData = {
                    ...defaultPanelData, // é»˜è®¤ç»“æ„
                    ...savedConfig, // ç”¨æˆ·ä¿å­˜çš„é…ç½®è¦†ç›–é»˜è®¤å€¼
                    name: defaultPanelData.name, // åŸºç¡€é¢æ¿åç§°ä¸èƒ½ä¿®æ”¹
                    key: defaultPanelData.key, // åŸºç¡€é¢æ¿é”®åä¸èƒ½ä¿®æ”¹
                    subItems: savedConfig.subItems || [], // ğŸ”§ ä¿®å¤ï¼šä»é…ç½®ä¸­è¯»å–ç”¨æˆ·æ·»åŠ çš„å­é¡¹
                    prompts: {
                        ...defaultPanelData.prompts, // é»˜è®¤æç¤ºè¯ç»“æ„
                        ...savedConfig.prompts // ç”¨æˆ·çš„æç¤ºè¯é…ç½®
                    }
                };

                return mergedData;
            } else {
                console.log('[InfoBarSettings] ğŸ“Š ä½¿ç”¨é»˜è®¤åŸºç¡€é¢æ¿æ•°æ®:', panelId);
                return defaultPanelData;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–åŸºç¡€é¢æ¿é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
            return defaultPanelData;
        }
    }

    /**
     * å¡«å……åŸºæœ¬é¢æ¿ä¿¡æ¯
     */
    fillBasicPanelInfo(panelData, panelType) {
        const form = this.modal.querySelector('.panel-properties-form');

        form.querySelector('#panel-name').value = panelData.name || '';
        form.querySelector('#panel-key').value = panelData.key || '';
        form.querySelector('#panel-description').value = panelData.description || '';
        // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
        // form.querySelector('#panel-icon').value = panelData.icon || 'ğŸ¨';

        form.querySelector('#panel-required').checked = !!panelData.required;
        form.querySelector('#panel-memory-inject').checked = !!panelData.memoryInject;


        // åŸºç¡€é¢æ¿åªé™åˆ¶åç§°å’Œé”®åä¸å¯ä¿®æ”¹
        const isBasicPanel = panelType === 'basic';
        if (isBasicPanel) {
            // åªé™åˆ¶åç§°å’Œé”®å
            form.querySelector('#panel-name').readOnly = true;
            form.querySelector('#panel-key').readOnly = true;

            // å…¶ä»–å­—æ®µå¯ä»¥ç¼–è¾‘
            form.querySelector('#panel-description').readOnly = false;
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // form.querySelector('#panel-icon').readOnly = false;
            form.querySelector('#panel-required').disabled = false;
            form.querySelector('#panel-memory-inject').disabled = false;

            // ä¸ºåªè¯»è¾“å…¥æ¡†æ·»åŠ æ ·å¼ç±»
            form.querySelector('#panel-name').classList.add('readonly-input');
            form.querySelector('#panel-key').classList.add('readonly-input');

            // ç§»é™¤å…¶ä»–å­—æ®µçš„åªè¯»æ ·å¼
            form.querySelector('#panel-description').classList.remove('readonly-input');
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // form.querySelector('#panel-icon').classList.remove('readonly-input');
        } else {
            // è‡ªå®šä¹‰é¢æ¿ç§»é™¤åªè¯»çŠ¶æ€
            form.querySelector('#panel-name').readOnly = false;
            form.querySelector('#panel-key').readOnly = false;
            form.querySelector('#panel-description').readOnly = false;
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // form.querySelector('#panel-icon').readOnly = false;
            form.querySelector('#panel-required').disabled = false;
            form.querySelector('#panel-memory-inject').disabled = false;

            // ç§»é™¤åªè¯»æ ·å¼ç±»
            form.querySelector('#panel-name').classList.remove('readonly-input');
            form.querySelector('#panel-key').classList.remove('readonly-input');
            form.querySelector('#panel-description').classList.remove('readonly-input');
            // ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å›¾æ ‡å­—æ®µå¼•ç”¨ï¼Œå› ä¸ºå·²ä»è¡¨å•ä¸­ç§»é™¤
            // form.querySelector('#panel-icon').classList.remove('readonly-input');
        }
    }

    /**
     * å¡«å……æç¤ºè¯é…ç½®
     */
    fillPanelPrompts(panelData, panelType) {
        const form = this.modal.querySelector('.panel-properties-form');
        const prompts = panelData.prompts || {};

        const initInput = form.querySelector('#panel-prompt-init');
        const insertInput = form.querySelector('#panel-prompt-insert');
        const updateInput = form.querySelector('#panel-prompt-update');
        const deleteInput = form.querySelector('#panel-prompt-delete');

        if (initInput) initInput.value = prompts.init || '';
        if (insertInput) insertInput.value = prompts.insert || '';
        if (updateInput) updateInput.value = prompts.update || '';
        if (deleteInput) deleteInput.value = prompts.delete || '';

        // åŸºç¡€é¢æ¿çš„æç¤ºè¯å¯ä»¥ç¼–è¾‘ï¼ˆç§»é™¤åªè¯»é™åˆ¶ï¼‰
        const isBasicPanel = panelType === 'basic';
        if (isBasicPanel) {
            // åŸºç¡€é¢æ¿çš„æç¤ºè¯ä¹Ÿå¯ä»¥ç¼–è¾‘
            if (initInput) {
                initInput.readOnly = false;
                initInput.classList.remove('readonly-input');
            }
            if (insertInput) {
                insertInput.readOnly = false;
                insertInput.classList.remove('readonly-input');
            }
            if (updateInput) {
                updateInput.readOnly = false;
                updateInput.classList.remove('readonly-input');
            }
            if (deleteInput) {
                deleteInput.readOnly = false;
                deleteInput.classList.remove('readonly-input');
            }
        } else {
            // è‡ªå®šä¹‰é¢æ¿ç§»é™¤åªè¯»çŠ¶æ€
            if (initInput) {
                initInput.readOnly = false;
                initInput.classList.remove('readonly-input');
            }
            if (insertInput) {
                insertInput.readOnly = false;
                insertInput.classList.remove('readonly-input');
            }
            if (updateInput) {
                updateInput.readOnly = false;
                updateInput.classList.remove('readonly-input');
            }
            if (deleteInput) {
                deleteInput.readOnly = false;
                deleteInput.classList.remove('readonly-input');
            }
        }
    }

    /**
     * å¡«å……å­é¡¹é…ç½®
     */
    fillSubItems(subItems) {
        try {
            const container = this.modal.querySelector('.sub-items-container');
            const emptyMessage = container.querySelector('.empty-sub-items');

            // ğŸ”§ ä¿®å¤ï¼šæ— è®ºæ˜¯å¦æœ‰å­é¡¹ï¼Œéƒ½å…ˆæ¸…ç©ºç°æœ‰å­é¡¹ï¼Œé˜²æ­¢UIæ±¡æŸ“
            container.querySelectorAll('.sub-item-form').forEach(item => item.remove());

            if (subItems.length === 0) {
                emptyMessage.style.display = 'block';
                console.log('[InfoBarSettings] ğŸ§¹ å­é¡¹å®¹å™¨å·²æ¸…ç†ï¼Œæ˜¾ç¤ºç©ºæ¶ˆæ¯');
                return;
            }

            emptyMessage.style.display = 'none';

            // æ·»åŠ å­é¡¹
            subItems.forEach(subItem => {
                this.addSubItemToContainer(subItem);
            });

            console.log(`[InfoBarSettings] ğŸ“Š å·²å¡«å…… ${subItems.length} ä¸ªå­é¡¹åˆ°å®¹å™¨`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¡«å……å­é¡¹é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹åˆ°å®¹å™¨
     */
    addSubItemToContainer(subItem) {
        try {
            const container = this.modal.querySelector('.sub-items-container');
            const emptyMessage = container.querySelector('.empty-sub-items');

            // éšè—ç©ºæ¶ˆæ¯
            emptyMessage.style.display = 'none';

            // åˆ›å»ºå­é¡¹è¡¨å•
            const subItemForm = this.createSubItemForm(subItem);
            container.appendChild(subItemForm);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹åˆ°å®¹å™¨å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºå­é¡¹è¡¨å•ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    createSubItemForm(subItem) {
        const formElement = document.createElement('div');
        formElement.className = 'sub-item-form simplified';
        formElement.dataset.subItemId = subItem.id;

        formElement.innerHTML = `
            <div class="sub-item-simple">
                <div class="sub-item-input-group">
                    <input type="text" class="sub-item-name" value="${subItem.name || ''}" placeholder="å­é¡¹åç§°" />
                </div>
                <button type="button" class="btn-icon btn-remove-sub-item" data-action="remove-sub-item" title="åˆ é™¤å­é¡¹">
                    <span style="pointer-events: none;">ğŸ—‘ï¸</span>
                </button>
            </div>
        `;

        return formElement;
    }

    /**
     * åˆ›å»ºå­é¡¹é»˜è®¤å€¼è¾“å…¥
     */
    createSubItemDefaultInput(subItem) {
        switch (subItem.type) {
            case 'checkbox':
                return `<input type="checkbox" class="sub-item-default" ${subItem.defaultValue ? 'checked' : ''} />`;
            case 'number':
                return `<input type="number" class="sub-item-default" value="${subItem.defaultValue || 0}" />`;
            case 'textarea':
                return `<textarea class="sub-item-default" rows="3">${subItem.defaultValue || ''}</textarea>`;
            default:
                return `<input type="text" class="sub-item-default" value="${subItem.defaultValue || ''}" />`;
        }
    }

    /**
     * åˆ›å»ºå­é¡¹é€‰é¡¹åŒºåŸŸï¼ˆç”¨äºselectç±»å‹ï¼‰
     */
    createSubItemOptionsSection(options) {
        const optionsHtml = options.map((option, index) => `
            <div class="option-item">
                <input type="text" class="option-input" value="${option}" placeholder="é€‰é¡¹${index + 1}" />
                <button type="button" class="btn-icon btn-remove-option">ğŸ—‘ï¸</button>
            </div>
        `).join('');

        return `
            <div class="form-group sub-item-options-section">
                <label>é€‰é¡¹é…ç½®</label>
                <div class="sub-item-options">
                    ${optionsHtml}
                </div>
                <button type="button" class="btn-small btn-add-option">æ·»åŠ é€‰é¡¹</button>
            </div>
        `;
    }

    /**
     * æ¸…ç©ºé¢æ¿å±æ€§
     */
    clearPanelProperties() {
        try {
            // æ£€æŸ¥modalæ˜¯å¦å­˜åœ¨
            if (!this.modal) {
                console.log('[InfoBarSettings] âš ï¸ Modalä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç©ºé¢æ¿å±æ€§');
                return;
            }

            const noSelectionMessage = this.modal.querySelector('.no-selection-message');
            const propertiesForm = this.modal.querySelector('.panel-properties-form');
            const saveBtn = this.modal.querySelector('[data-action="save-panel-properties"]');
            const deleteBtn = this.modal.querySelector('[data-action="delete-panel"]');

            // æ˜¾ç¤ºæ— é€‰æ‹©æ¶ˆæ¯ï¼Œéšè—å±æ€§è¡¨å•
            if (noSelectionMessage) noSelectionMessage.style.display = 'block';
            if (propertiesForm) propertiesForm.style.display = 'none';

            // ç¦ç”¨æŒ‰é’®
            if (saveBtn) saveBtn.disabled = true;
            if (deleteBtn) deleteBtn.disabled = true;

            // æ¸…ç©ºå½“å‰ç¼–è¾‘é¢æ¿ä¿¡æ¯
            this.currentEditingPanel = null;

            // æ¸…é™¤é¢æ¿åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            this.modal.querySelectorAll('.panel-list-item').forEach(item => {
                item.classList.remove('selected');
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢æ¿å±æ€§å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢å†…å®¹é¢æ¿
     */
    switchToContent(contentType) {
        try {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            this.modal.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            this.modal.querySelector(`[data-nav="${contentType}"]`).classList.add('active');

            // ğŸ”§ ä¿®å¤ï¼šé‡æ–°åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
            this.applyNavItemTheme();

            // æ›´æ–°å†…å®¹é¢æ¿
            this.modal.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            this.modal.querySelector(`[data-content="${contentType}"]`).classList.add('active');

            // ğŸ”§ æ–°å¢ï¼šæ€»ç»“é¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'summary') {
                this.initSummaryPanelContent();
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å¢å¼ºé¢æ¿ç‰¹æ®Šå¤„ç†
            if (contentType === 'memoryEnhancement') {
                this.initMemoryEnhancementPanelContent();
            }

            console.log(`[InfoBarSettings] ğŸ“‘ åˆ‡æ¢åˆ°å†…å®¹: ${contentType}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹
     */
    initSummaryPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹...');

            // è·å–æ€»ç»“ç®¡ç†å™¨å®ä¾‹
            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool || !infoBarTool.modules || !infoBarTool.modules.summaryManager) {
                console.error('[InfoBarSettings] âŒ æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                this.showMessage('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            const summaryManager = infoBarTool.modules.summaryManager;

            // åŠ è½½å½“å‰è®¾ç½®
            this.loadSummarySettings();

            // åŠ è½½æ€»ç»“å†å²
            this.loadSummaryHistory();

            // ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶
            this.bindSummaryPanelEvents();

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ€»ç»“é¢æ¿å†…å®¹å¤±è´¥:', error);
            this.showMessage('åˆå§‹åŒ–æ€»ç»“é¢æ¿å¤±è´¥', 'error');
        }
    }

    /**
     * å¤„ç†æ“ä½œæŒ‰é’®
     */
    handleAction(action, event = null) {
        try {
            switch (action) {
                case 'close':
                    this.hide();
                    break;
                case 'save':
                    this.saveSettings();
                    break;
                case 'clear-cache':
                    this.clearAllCaches();
                    break;
                case 'initialize-plugin':
                    this.initializePlugin();
                    break;
                case 'clear-panel-data':
                    this.clearPanelData();
                    break;
                case 'export':
                    this.exportSettings();
                    break;
                case 'export-custom':
                    this.exportCustomSettings();
                    break;
                case 'import':
                    this.importSettings();
                    break;
                case 'open-error-log':
                    this.openErrorLogModal();
                    break;
                case 'open-project-link':
                    this.openProjectLink();
                    break;
                case 'save-profile':
                    this.saveSettingsProfile();
                    break;
                case 'load-profile':
                    this.loadSettingsProfile();
                    break;
                case 'delete-profile':
                    this.deleteSettingsProfile();
                    break;
                case 'export-data':
                    console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å‡ºæ•°æ®...');
                    this.exportData().catch(error => {
                        console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                        this.showMessage('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
                    });
                    break;
                case 'import-data':
                    console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ•°æ®...');
                    this.importData().catch(error => {
                        console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                        this.showMessage('å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                    });
                    break;
                case 'open-variable-manager':
                    console.log('[InfoBarSettings] ğŸ”§ æ‰“å¼€å˜é‡ç®¡ç†å™¨...');
                    this.openVariableManager();
                    break;
                case 'open-status-bar-editor':
                    console.log('[InfoBarSettings] ğŸ¨ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨...');
                    this.openStatusBarEditor();
                    break;

                case 'show-data-info':
                    console.log('[InfoBarSettings] ğŸ“Š æ˜¾ç¤ºæ•°æ®ä¿¡æ¯...');
                    this.showDataInfoPanel();
                    break;
                case 'open-npc-management':
                    console.log('[InfoBarSettings] ğŸ§‘â€ğŸ¤â€ğŸ§‘ æ‰“å¼€NPCç®¡ç†é¢æ¿...');
                    try {
                        const panel = window.SillyTavernInfobar?.modules?.npcManagementPanel;
                        if (panel && typeof panel.show === 'function') {
                            panel.show();
                        } else {
                            console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°NPCç®¡ç†é¢æ¿å®ä¾‹');
                        }
                    } catch (e) {
                        console.error('[InfoBarSettings] âŒ æ‰“å¼€NPCç®¡ç†é¢æ¿å¤±è´¥:', e);
                    }
                    break;
                default:
                    console.log(`[InfoBarSettings] ğŸ”˜ å¤„ç†æ“ä½œ: ${action}`);
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†å¤é€‰æ¡†å˜æ›´
     */
    handleCheckboxChange(e) {
        try {
            const name = e.target.name;
            const checked = e.target.checked;

            console.log(`[InfoBarSettings] â˜‘ï¸ å¤é€‰æ¡†å˜æ›´: ${name} = ${checked}`);

            // ğŸ”§ ä¿®å¤ï¼šå¤„ç†è‡ªå®šä¹‰é¢æ¿å¯ç”¨/ç¦ç”¨çŠ¶æ€
            if (name && name.endsWith('.enabled')) {
                const panelId = name.replace('.enabled', '');

                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰é¢æ¿
                const customPanels = this.getCustomPanels();
                if (customPanels[panelId]) {
                    console.log(`[InfoBarSettings] ğŸ”§ æ›´æ–°è‡ªå®šä¹‰é¢æ¿çŠ¶æ€: ${panelId}.enabled = ${checked}`);
                    customPanels[panelId].enabled = checked;
                    customPanels[panelId].updatedAt = Date.now();

                    // ç«‹å³ä¿å­˜åˆ°é…ç½®
                    this.saveCustomPanel(customPanels[panelId]);
                    console.log(`[InfoBarSettings] âœ… è‡ªå®šä¹‰é¢æ¿ ${panelId} çŠ¶æ€å·²ä¿å­˜: ${checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®æ›´æ–°çŠ¶æ€å¾½ç« ï¼ˆä½¿ç”¨å½“å‰é¢æ¿çš„çŠ¶æ€å¾½ç« ï¼‰
                    const activeContentPanel = this.modal.querySelector(`.content-panel[data-content="${panelId}"]`);
                    if (activeContentPanel) {
                        const statusBadge = activeContentPanel.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                            statusBadge.className = `status-badge ${checked ? 'enabled' : 'disabled'}`;
                            console.log(`[InfoBarSettings] ğŸ¨ æ›´æ–°çŠ¶æ€å¾½ç« : ${panelId} -> ${checked ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}`);
                        } else {
                            console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°çŠ¶æ€å¾½ç« : ${panelId}`);
                        }

                        // å­é¡¹åŒºåŸŸå§‹ç»ˆä¿æŒå¯è§ï¼Œä¸æ ¹æ®å¯ç”¨çŠ¶æ€éšè—
                        console.log(`[InfoBarSettings] ğŸ“‹ å­é¡¹åŒºåŸŸä¿æŒå¯è§ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯é…ç½®é¡¹`);
                    } else {
                        console.log(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å½“å‰é¢æ¿å®¹å™¨: ${panelId}`);
                    }
                }
            }

            // ç‰¹æ®Šå¤„ç†APIé…ç½®å¼€å…³
            if (name === 'apiConfig.enabled') {
                const apiConfigContent = this.modal.querySelector('.api-config-content');
                if (apiConfigContent) {
                    apiConfigContent.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] ğŸ”Œ APIé…ç½®åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                }
            }

            // ğŸ†• ç‰¹æ®Šå¤„ç†ç ´ç”²æç¤ºè¯å¼€å…³
            if (name === 'apiConfig.enableArmorBreaking') {
                const armorBreakingSection = this.modal.querySelector('.armor-breaking-config-section');
                if (armorBreakingSection) {
                    armorBreakingSection.style.display = checked ? 'block' : 'none';
                    console.log(`[InfoBarSettings] ğŸ›¡ï¸ ç ´ç”²æç¤ºè¯é…ç½®åŒºåŸŸ${checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                }
            }

            // å¦‚æœæ˜¯ä¸»å¼€å…³ï¼Œæ§åˆ¶ç›¸å…³å­é¡¹
            if (name && name.includes('.enabled')) {
                const baseName = name.replace('.enabled', '');
                const relatedInputs = this.modal.querySelectorAll(`[name^="${baseName}."]`);
                relatedInputs.forEach(input => {
                    if (input !== e.target) {
                        input.disabled = !checked;
                    }
                });
            }

            // æ›´æ–°å¯¹åº”é¢æ¿çš„é…ç½®è®¡æ•°
            this.updatePanelCounts(e.target);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å¤é€‰æ¡†å˜æ›´å¤±è´¥:', error);
        }
    }
    /**
     * åˆ›å»ºAPIé…ç½®é¢æ¿
     */
    createAPIPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ”Œ è‡ªå®šä¹‰APIé…ç½®</h3>
                <div class="toggle-switch">
                    <input type="checkbox" id="api-enabled" name="apiConfig.enabled" />
                    <label for="api-enabled" class="switch-slider"></label>
                </div>
            </div>

            <div class="content-body">


                <!-- APIæä¾›å•†é€‰æ‹© -->
                <div class="settings-group">
                    <h4>1. é€‰æ‹©APIæä¾›å•†</h4>
                    <div class="form-group">
                        <label>APIæä¾›å•†</label>
                        <select id="api-provider" name="apiConfig.provider">
                            <option value="">è¯·é€‰æ‹©æä¾›å•†</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="localproxy">cil/æœ¬åœ°åä»£ (SillyTavernåç«¯)</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                        <small>é€‰æ‹©æ‚¨è¦ä½¿ç”¨çš„AIæ¨¡å‹æä¾›å•†</small>
                    </div>
                </div>

                <!-- æ¥å£ç±»å‹é€‰æ‹© -->
                <div class="settings-group">
                    <h4>2. é€‰æ‹©æ¥å£ç±»å‹</h4>
                    <div class="form-group">
                        <label>æ¥å£ç±»å‹</label>
                        <select id="interface-type" name="apiConfig.format">
                            <option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†</option>
                        </select>
                        <small>é€‰æ‹©APIæ¥å£çš„è°ƒç”¨æ–¹å¼</small>
                    </div>
                </div>

                <!-- åŸºç¡€URLé…ç½® -->
                <div class="settings-group">
                    <h4>3. åŸºç¡€URL</h4>
                    <div class="form-group">
                        <label>APIåŸºç¡€URL</label>
                        <input type="url" id="api-base-url" name="apiConfig.baseUrl" placeholder="https://api.example.com" />
                        <small>APIæœåŠ¡çš„åŸºç¡€åœ°å€</small>
                    </div>
                </div>

                <!-- APIå¯†é’¥é…ç½® -->
                <div class="settings-group">
                    <h4>4. APIå¯†é’¥</h4>
                    <div class="form-group">
                        <label>APIå¯†é’¥</label>
                        <input type="password" id="api-key" name="apiConfig.apiKey" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥" />
                        <small>ä»APIæä¾›å•†è·å–çš„è®¿é—®å¯†é’¥</small>
                    </div>
                </div>

                <!-- æ¨¡å‹é€‰æ‹© -->
                <div class="settings-group">
                    <h4>5. æ¨¡å‹é€‰æ‹©</h4>
                    <div class="form-group">
                        <label>AIæ¨¡å‹</label>
                        <select id="api-model" name="apiConfig.model">
                            <option value="">è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨</option>
                        </select>
                        <small>é€‰æ‹©è¦ä½¿ç”¨çš„AIæ¨¡å‹</small>
                    </div>
                </div>

                <!-- åŠ è½½æ¨¡å‹åˆ—è¡¨æŒ‰é’® -->
                <div class="settings-group">
                    <h4>6. åŠ è½½æ¨¡å‹åˆ—è¡¨</h4>
                    <div class="form-group">
                        <button type="button" id="load-models-btn" class="btn btn-primary">ğŸ“‹ åŠ è½½æ¨¡å‹åˆ—è¡¨</button>
                        <small>ç‚¹å‡»åŠ è½½å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨</small>
                    </div>
                </div>

                <!-- æµ‹è¯•è¿æ¥æŒ‰é’® -->
                <div class="settings-group">
                    <h4>7. æµ‹è¯•è¿æ¥</h4>
                    <div class="form-group">
                        <button type="button" id="test-connection-btn" class="btn btn-secondary">ğŸ” æµ‹è¯•è¿æ¥</button>
                        <small>æµ‹è¯•APIè¿æ¥æ˜¯å¦æ­£å¸¸</small>
                    </div>
                </div>

                <!-- æ¨¡å‹å‚æ•°é…ç½® -->
                <div class="settings-group">
                    <h4>8. æ¨¡å‹å‚æ•°</h4>
                    <div class="form-group">
                        <label>æ¸©åº¦ (0-2)</label>
                        <input type="range" name="apiConfig.temperature" min="0" max="2" step="0.1" value="0.7" />
                        <span class="range-value">0.7</span>
                        <small>æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ï¼Œå€¼è¶Šé«˜è¶Šéšæœº</small>
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§ä»¤ç‰Œæ•°</label>
                        <input type="number" name="apiConfig.maxTokens" min="1" max="100000" step="100" value="2048" />
                        <small>ç”Ÿæˆæ–‡æœ¬çš„æœ€å¤§é•¿åº¦</small>
                    </div>
                </div>

                <!-- è¿æ¥è®¾ç½® -->
                <div class="settings-group">
                    <h4>9. è¿æ¥è®¾ç½®</h4>
                    <div class="form-group">
                        <label>è¯·æ±‚è¶…æ—¶ (ç§’)</label>
                        <input type="number" name="apiConfig.timeout" min="5" max="300" step="5" value="30" />
                        <small>APIè¯·æ±‚çš„è¶…æ—¶æ—¶é—´</small>
                    </div>
                    <div class="form-group">
                        <label>é‡è¯•æ¬¡æ•°</label>
                        <input type="number" name="apiConfig.retryCount" min="0" max="10" step="1" value="3" />
                        <small>è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°</small>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-merge-messages" name="apiConfig.mergeMessages" checked />
                            <label for="api-merge-messages" class="checkbox-label">åˆå¹¶æ¶ˆæ¯</label>
                        </div>
                        <small>å¯ç”¨æ—¶å°†APIè¿”å›æ•°æ®åˆå¹¶åˆ°AIæ¶ˆæ¯ä¸­å†è§£æï¼Œç¦ç”¨æ—¶ç›´æ¥è§£æAPIè¿”å›æ•°æ®</small>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-include-worldbook" name="apiConfig.includeWorldBook" />
                            <label for="api-include-worldbook" class="checkbox-label">è¯»å–ä¸–ç•Œä¹¦</label>
                        </div>
                        <small>å¯ç”¨æ—¶å°†SillyTavernä¸–ç•Œä¹¦å†…å®¹æ³¨å…¥åˆ°è‡ªå®šä¹‰APIè¯·æ±‚ä¸­</small>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="api-enable-armor-breaking" name="apiConfig.enableArmorBreaking" />
                            <label for="api-enable-armor-breaking" class="checkbox-label">å¯ç”¨ç ´ç”²æç¤ºè¯</label>
                        </div>
                        <small>å¯ç”¨ååœ¨æ™ºèƒ½æç¤ºè¯é¡¶éƒ¨æ˜¾ç¤ºç ´ç”²æç¤ºè¯ï¼Œç”¨äºçªç ´AIé™åˆ¶</small>
                    </div>
                </div>

                <!-- ğŸ†• ç ´ç”²æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group armor-breaking-config-section" style="display: none;">
                    <h4>ğŸ›¡ï¸ ç ´ç”²æç¤ºè¯é…ç½®</h4>
                    <div class="form-group">
                        <label>ç ´ç”²æç¤ºè¯å†…å®¹</label>
                        <textarea id="armor-breaking-prompt" name="apiConfig.armorBreakingPrompt"
                                  rows="6"
                                  placeholder="è¯·è¾“å…¥ç ´ç”²æç¤ºè¯å†…å®¹ï¼Œå°†åœ¨æ™ºèƒ½æç¤ºè¯é¡¶éƒ¨æ˜¾ç¤º..."
                                  style="width: 100%; min-height: 120px; resize: vertical; font-family: monospace; font-size: 13px;"></textarea>
                        <small>æ­¤æç¤ºè¯å°†åœ¨æ™ºèƒ½æç¤ºè¯çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºï¼Œç”¨äºçªç ´AIçš„æŸäº›é™åˆ¶ã€‚è¯·è°¨æ…ä½¿ç”¨ã€‚</small>
                    </div>
                    <div class="form-group">
                        <div class="armor-breaking-stats">
                            <span class="char-count">å­—ç¬¦æ•°: <span id="armor-breaking-char-count">0</span></span>
                            <span class="word-count">å•è¯æ•°: <span id="armor-breaking-word-count">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• ä¸–ç•Œä¹¦é…ç½®é¢æ¿ -->
                <div class="settings-group worldbook-config-section" style="display: none;">
                    <h4>ğŸ“š ä¸–ç•Œä¹¦ç®¡ç†é…ç½®</h4>
                    <div id="worldbook-config-container">
                        <!-- ä¸–ç•Œä¹¦é…ç½®é¢æ¿å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        <div style="padding: 20px; text-align: center; color: var(--theme-text-secondary, #aaa);">
                            æ­£åœ¨åŠ è½½ä¸–ç•Œä¹¦é…ç½®...
                        </div>
                    </div>
                </div>

                <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                <div class="settings-group">
                    <h4>10. è¿æ¥çŠ¶æ€</h4>
                    <div class="form-group">
                        <div id="connection-status" class="connection-status">
                            â³ æœªæµ‹è¯•è¿æ¥
                        </div>
                        <small>æ˜¾ç¤ºAPIè¿æ¥å’Œæ¨¡å‹åŠ è½½çŠ¶æ€</small>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºè®°å¿†å¢å¼ºé¢æ¿
     */
    createMemoryEnhancementPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ§  è®°å¿†å¢å¼º</h3>
                <div class="header-description">
                    <p>é…ç½®å››å±‚è®°å¿†æ¶æ„ï¼šAIè®°å¿†æ€»ç»“ã€è¯­ä¹‰æœç´¢ã€æ·±åº¦è®°å¿†ç®¡ç†ã€æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</p>
                </div>
            </div>

            <div class="content-body">
                <!-- ğŸ¯ è®°å¿†ç³»ç»ŸçŠ¶æ€å¯è§†åŒ– -->
                <div class="memory-status-visualization" id="memory-status-visualization">
                    <div class="status-header">
                        <h4>ğŸ“Š è®°å¿†çŠ¶æ€æ˜¾ç¤º</h4>
                        <button class="refresh-status-btn" id="refresh-memory-status" title="åˆ·æ–°çŠ¶æ€">ğŸ”„</button>
                    </div>

                    <!-- å››å±‚è®°å¿†çŠ¶æ€å¡ç‰‡ -->
                    <div class="memory-layers-status">
                        <div class="memory-layer-card" data-layer="sensory">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ‘ï¸</span>
                                <span class="layer-name">æ„ŸçŸ¥è®°å¿†å±‚</span>
                                <span class="layer-status" id="sensory-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="sensory-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å®¹é‡:</span>
                                    <span class="stat-value" id="sensory-capacity">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="shortTerm">
                            <div class="layer-header">
                                <span class="layer-icon">âš¡</span>
                                <span class="layer-name">çŸ­æœŸè®°å¿†å±‚</span>
                                <span class="layer-status" id="shortterm-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="shortterm-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é‡è¦æ€§:</span>
                                    <span class="stat-value" id="shortterm-importance">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="longTerm">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ§ </span>
                                <span class="layer-name">é•¿æœŸè®°å¿†å±‚</span>
                                <span class="layer-status" id="longterm-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="longterm-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è¿ç§»:</span>
                                    <span class="stat-value" id="longterm-migrations">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="memory-layer-card" data-layer="deepArchive">
                            <div class="layer-header">
                                <span class="layer-icon">ğŸ“š</span>
                                <span class="layer-name">æ·±åº¦å½’æ¡£å±‚</span>
                                <span class="layer-status" id="archive-status">â—</span>
                            </div>
                            <div class="layer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ•°é‡:</span>
                                    <span class="stat-value" id="archive-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‹ç¼©:</span>
                                    <span class="stat-value" id="archive-compression">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¨¡å—çŠ¶æ€æ¦‚è§ˆ -->
                    <div class="modules-status">
                        <div class="module-status-card" data-module="aiSummarizer">
                            <div class="module-header">
                                <span class="module-icon">ğŸ¤–</span>
                                <span class="module-name">AIè®°å¿†æ€»ç»“</span>
                                <span class="module-status" id="ai-summarizer-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">é˜Ÿåˆ—:</span>
                                    <span class="stat-value" id="ai-summarizer-queue">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç¼“å­˜:</span>
                                    <span class="stat-value" id="ai-summarizer-cache">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="vectorSearch">
                            <div class="module-header">
                                <span class="module-icon">ğŸ”</span>
                                <span class="module-name">è¯­ä¹‰æœç´¢</span>
                                <span class="module-status" id="vector-search-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ç´¢å¼•:</span>
                                    <span class="stat-value" id="vector-search-index">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å‘½ä¸­ç‡:</span>
                                    <span class="stat-value" id="vector-search-hitrate">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="classifier">
                            <div class="module-header">
                                <span class="module-icon">ğŸ¯</span>
                                <span class="module-name">æ™ºèƒ½åˆ†ç±»</span>
                                <span class="module-status" id="classifier-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">åˆ†ç±»:</span>
                                    <span class="stat-value" id="classifier-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ç½®ä¿¡åº¦:</span>
                                    <span class="stat-value" id="classifier-confidence">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="module-status-card" data-module="injector">
                            <div class="module-header">
                                <span class="module-icon">ğŸ’‰</span>
                                <span class="module-name">è®°å¿†æ³¨å…¥</span>
                                <span class="module-status" id="injector-status">â—</span>
                            </div>
                            <div class="module-stats">
                                <div class="stat-item">
                                    <span class="stat-label">æ³¨å…¥:</span>
                                    <span class="stat-value" id="injector-count">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é”™è¯¯:</span>
                                    <span class="stat-value" id="injector-errors">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸš€ AIè®°å¿†æ€»ç»“è®¾ç½® -->
                <div class="setting-row ai-memory-section">
                    <h5 style="color: #4CAF50; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ§  AIè®°å¿†æ€»ç»“</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-memory-enabled" />
                            <span class="checkbox-text">å¯ç”¨AIè®°å¿†æ€»ç»“</span>
                        </label>
                        <div class="setting-hint">ä½¿ç”¨AIæ™ºèƒ½åˆ†æå’Œæ€»ç»“æ¶ˆæ¯å†…å®¹</div>
                    </div>
                </div>

                <div class="setting-row ai-memory-options" id="memory-ai-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #4CAF50; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-ai-message-level-summary" />
                            <span class="checkbox-text">æ¶ˆæ¯çº§åˆ«æ€»ç»“</span>
                        </label>
                        <div class="setting-hint">ä¸ºæ¯æ¡é‡è¦æ¶ˆæ¯ç”Ÿæˆæ™ºèƒ½æ€»ç»“</div>
                    </div>
                </div>

                <div class="setting-row ai-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #4CAF50; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-ai-importance-threshold">é‡è¦æ€§é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-ai-importance-threshold" min="0.1" max="1.0" step="0.1" value="0.6" />
                            <span class="input-unit" id="memory-ai-importance-value">60%</span>
                        </div>
                        <div class="setting-hint">åªæ€»ç»“é‡è¦æ€§è¶…è¿‡æ­¤é˜ˆå€¼çš„æ¶ˆæ¯</div>
                    </div>
                </div>

                <!-- ğŸ” è¯­ä¹‰æœç´¢è®¾ç½® -->
                <div class="setting-row vectorized-memory-section">
                    <h5 style="color: #2196F3; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ” è¯­ä¹‰æœç´¢</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-vectorized-memory-enabled" />
                            <span class="checkbox-text">å¯ç”¨è¯­ä¹‰æœç´¢</span>
                        </label>
                        <div class="setting-hint">ä½¿ç”¨å‘é‡åŒ–æŠ€æœ¯è¿›è¡Œæ™ºèƒ½è¯­ä¹‰æœç´¢</div>
                    </div>
                </div>

                <div class="setting-row vectorized-memory-options" id="memory-vectorized-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #2196F3; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-vector-engine">å‘é‡åŒ–å¼•æ“</label>
                        <select id="memory-vector-engine" class="setting-select">
                            <option value="transformers">Transformers.js (æœ¬åœ°)</option>
                            <option value="openai">OpenAI (åœ¨çº¿)</option>
                        </select>
                        <div class="setting-hint">é€‰æ‹©å‘é‡åŒ–å¼•æ“ç±»å‹</div>
                    </div>
                </div>

                <div class="setting-row vectorized-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #2196F3; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-similarity-threshold">ç›¸ä¼¼åº¦é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-similarity-threshold" min="0.1" max="1.0" step="0.05" value="0.7" />
                            <span class="input-unit" id="memory-similarity-value">70%</span>
                        </div>
                        <div class="setting-hint">è¯­ä¹‰æœç´¢çš„æœ€ä½ç›¸ä¼¼åº¦è¦æ±‚</div>
                    </div>
                </div>

                <div class="setting-row vectorized-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #2196F3; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-max-search-results">æœ€å¤§æœç´¢ç»“æœ</label>
                        <div class="input-group">
                            <input type="number" id="memory-max-search-results" min="5" max="50" value="10" />
                            <span class="input-unit">ä¸ªç»“æœ</span>
                        </div>
                        <div class="setting-hint">è¯­ä¹‰æœç´¢è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡</div>
                    </div>
                </div>

                <!-- ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†è®¾ç½® -->
                <div class="setting-row deep-memory-section">
                    <h5 style="color: #9C27B0; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-deep-memory-enabled" />
                            <span class="checkbox-text">å¯ç”¨æ·±åº¦è®°å¿†ç®¡ç†</span>
                        </label>
                        <div class="setting-hint">åŸºäºè®¤çŸ¥å¿ƒç†å­¦çš„å››å±‚è®°å¿†æ¶æ„ç®¡ç†</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" id="memory-deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-auto-memory-migration" />
                            <span class="checkbox-text">è‡ªåŠ¨è®°å¿†è¿ç§»</span>
                        </label>
                        <div class="setting-hint">æ ¹æ®é‡è¦æ€§è‡ªåŠ¨åœ¨è®°å¿†å±‚çº§é—´è¿ç§»</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-memory-importance-threshold">è®°å¿†é‡è¦æ€§é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-memory-importance-threshold" min="0.1" max="1.0" step="0.05" value="0.6" />
                            <span class="input-unit" id="memory-memory-importance-value">60%</span>
                        </div>
                        <div class="setting-hint">çŸ­æœŸè®°å¿†å‡çº§ä¸ºé•¿æœŸè®°å¿†çš„é‡è¦æ€§é˜ˆå€¼</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-memory-conflict-resolution" />
                            <span class="checkbox-text">è®°å¿†å†²çªè§£å†³</span>
                        </label>
                        <div class="setting-hint">è‡ªåŠ¨æ£€æµ‹å’Œè§£å†³çŸ›ç›¾çš„è®°å¿†å†…å®¹</div>
                    </div>
                </div>

                <div class="setting-row deep-memory-options" style="display: none; margin-left: 20px; border-left: 2px solid #9C27B0; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-memory-capacity">è®°å¿†å®¹é‡è®¾ç½®</label>
                        <div class="memory-capacity-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">æ„ŸçŸ¥è®°å¿†</label>
                                <input type="number" id="memory-sensory-capacity" min="50" max="500" value="100" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">çŸ­æœŸè®°å¿†</label>
                                <input type="number" id="memory-short-term-capacity" min="200" max="2000" value="500" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">é•¿æœŸè®°å¿†</label>
                                <input type="number" id="memory-long-term-capacity" min="1000" max="10000" value="5000" style="width: 100%;" />
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--SmartThemeQuoteColor, #888);">æ·±åº¦å½’æ¡£</label>
                                <input type="number" id="memory-deep-archive-capacity" min="10000" max="100000" value="50000" style="width: 100%;" />
                            </div>
                        </div>
                        <div class="setting-hint">å„è®°å¿†å±‚çº§çš„æœ€å¤§å®¹é‡è®¾ç½®</div>
                    </div>
                </div>

                <!-- ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½® -->
                <div class="setting-row intelligent-classifier-section">
                    <h5 style="color: #FF5722; margin: 15px 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</h5>
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-intelligent-classifier-enabled" />
                            <span class="checkbox-text">å¯ç”¨æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨</span>
                        </label>
                        <div class="setting-hint">AIé©±åŠ¨çš„æ™ºèƒ½è®°å¿†åˆ†ç±»ç³»ç»Ÿ</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" id="memory-intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-semantic-clustering" />
                            <span class="checkbox-text">è¯­ä¹‰èšç±»åˆ†æ</span>
                        </label>
                        <div class="setting-hint">åŸºäºå‘é‡ç©ºé—´çš„è¯­ä¹‰èšç±»</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-temporal-pattern-recognition" />
                            <span class="checkbox-text">æ—¶åºæ¨¡å¼è¯†åˆ«</span>
                        </label>
                        <div class="setting-hint">è¯†åˆ«è®°å¿†çš„æ—¶é—´æ¨¡å¼å’Œå‘¨æœŸæ€§</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-importance-prediction" />
                            <span class="checkbox-text">é‡è¦æ€§é¢„æµ‹</span>
                        </label>
                        <div class="setting-hint">é¢„æµ‹è®°å¿†çš„æœªæ¥é‡è¦æ€§</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label" for="memory-classification-confidence-threshold">åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼</label>
                        <div class="input-group">
                            <input type="range" id="memory-classification-confidence-threshold" min="0.5" max="1.0" step="0.05" value="0.7" />
                            <span class="input-unit" id="memory-classification-confidence-value">70%</span>
                        </div>
                        <div class="setting-hint">åˆ†ç±»å†³ç­–çš„æœ€ä½ç½®ä¿¡åº¦è¦æ±‚</div>
                    </div>
                </div>

                <div class="setting-row intelligent-classifier-options" style="display: none; margin-left: 20px; border-left: 2px solid #FF5722; padding-left: 15px;">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="memory-adaptive-learning" />
                            <span class="checkbox-text">è‡ªé€‚åº”å­¦ä¹ </span>
                        </label>
                        <div class="setting-hint">ä»ç”¨æˆ·åé¦ˆä¸­å­¦ä¹ å’Œæ”¹è¿›</div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæç¤ºè¯è®¾ç½®é¢æ¿
     */
    createPromptSettingsPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ§  æç¤ºè¯è®¾ç½®</h3>
                <div class="header-description">
                    <p>é…ç½®AIæç¤ºè¯çš„ç”Ÿæˆæ–¹å¼ï¼šæ™ºèƒ½æç¤ºè¯æˆ–è‡ªå®šä¹‰æç¤ºè¯</p>
                </div>
            </div>

            <div class="content-body">
                <!-- æç¤ºè¯æ¨¡å¼é€‰æ‹© -->
                <div class="settings-group">
                    <h4>ğŸ“‹ æç¤ºè¯æ¨¡å¼</h4>
                    <div class="prompt-mode-selector">
                        <div class="mode-option">
                            <input type="radio" id="smart-prompt-mode" name="promptSettings.mode" value="smart" checked />
                            <label for="smart-prompt-mode" class="mode-label">
                                <div class="mode-icon">ğŸ§ </div>
                                <div class="mode-content">
                                    <h5>æ™ºèƒ½æç¤ºè¯</h5>
                                    <p>ä½¿ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–çš„æç¤ºè¯å†…å®¹</p>
                                </div>
                            </label>
                        </div>
                        <div class="mode-option">
                            <input type="radio" id="custom-prompt-mode" name="promptSettings.mode" value="custom" />
                            <label for="custom-prompt-mode" class="mode-label">
                                <div class="mode-icon">âœï¸</div>
                                <div class="mode-content">
                                    <h5>è‡ªå®šä¹‰æç¤ºè¯</h5>
                                    <p>ä½¿ç”¨æ‚¨è‡ªå®šä¹‰çš„æç¤ºè¯å†…å®¹ï¼Œå…³é—­æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- æ™ºèƒ½æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group smart-prompt-config" id="smart-prompt-config">
                    <h4>ğŸ§  æ™ºèƒ½æç¤ºè¯é…ç½®</h4>
                    <div class="smart-prompt-info">
                        <div class="info-card">
                            <div class="info-icon">âœ…</div>
                            <div class="info-content">
                                <h5>æ™ºèƒ½æç¤ºè¯å·²å¯ç”¨</h5>
                                <p>ç³»ç»Ÿå°†æ ¹æ®å½“å‰é¢æ¿é…ç½®å’Œæ•°æ®çŠ¶æ€è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–çš„æç¤ºè¯</p>
                                <ul>
                                    <li>è‡ªåŠ¨åˆ†ææ•°æ®å®Œæ•´æ€§</li>
                                    <li>æ™ºèƒ½é€‰æ‹©æ›´æ–°ç­–ç•¥</li>
                                    <li>åŠ¨æ€ç”Ÿæˆæ ¼å¼çº¦æŸ</li>
                                    <li>ä¼˜åŒ–AIå“åº”è´¨é‡</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰æç¤ºè¯é…ç½®åŒºåŸŸ -->
                <div class="settings-group custom-prompt-config" id="custom-prompt-config" style="display: none;">
                    <h4>âœï¸ è‡ªå®šä¹‰æç¤ºè¯é…ç½®</h4>
                    <div class="form-group">
                        <label>è‡ªå®šä¹‰æç¤ºè¯å†…å®¹</label>
                        <textarea id="custom-prompt-content" name="promptSettings.customContent"
                                  rows="12"
                                  placeholder="è¯·è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯å†…å®¹...

ç¤ºä¾‹ï¼š
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®æ•´ç†å‘˜ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„å¯¹è¯å†…å®¹ï¼Œæå–å¹¶æ•´ç†ç›¸å…³ä¿¡æ¯ã€‚

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
1. ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼šadd é¢æ¿å(è¡Œå· {&quot;åˆ—å·&quot;,&quot;å€¼&quot;})
2. ç¡®ä¿æ•°æ®å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
3. ä¿æŒæ ¼å¼çš„ä¸€è‡´æ€§

è¯·å¼€å§‹å¤„ç†..."
                                  style="width: 100%; min-height: 300px; resize: vertical; font-family: monospace; font-size: 13px;"></textarea>
                        <small>è‡ªå®šä¹‰æç¤ºè¯å°†å®Œå…¨æ›¿ä»£æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿã€‚è¯·ç¡®ä¿åŒ…å«å¿…è¦çš„æ ¼å¼è¦æ±‚å’ŒæŒ‡å¯¼è¯´æ˜ã€‚</small>
                    </div>
                    <div class="form-group">
                        <div class="custom-prompt-stats">
                            <span class="char-count">å­—ç¬¦æ•°: <span id="custom-prompt-char-count">0</span></span>
                            <span class="word-count">å•è¯æ•°: <span id="custom-prompt-word-count">0</span></span>
                            <span class="line-count">è¡Œæ•°: <span id="custom-prompt-line-count">0</span></span>
                        </div>
                    </div>
                    <div class="custom-prompt-warning">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-content">
                            <h5>æ³¨æ„äº‹é¡¹</h5>
                            <p>å¯ç”¨è‡ªå®šä¹‰æç¤ºè¯åï¼Œæ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå°†è¢«å®Œå…¨å…³é—­ã€‚è¯·ç¡®ä¿æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯åŒ…å«ï¼š</p>
                            <ul>
                                <li>æ˜ç¡®çš„æ•°æ®æå–æŒ‡å¯¼</li>
                                <li>æ­£ç¡®çš„è¾“å‡ºæ ¼å¼è¦æ±‚</li>
                                <li>å¿…è¦çš„çº¦æŸå’Œé™åˆ¶è¯´æ˜</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯é¢„è§ˆåŒºåŸŸ -->
                <div class="settings-group">
                    <h4>ğŸ‘ï¸ æç¤ºè¯é¢„è§ˆ</h4>
                    <div class="prompt-preview-container">
                        <div class="preview-toolbar">
                            <button class="btn btn-secondary" id="refresh-preview-btn">
                                <i class="fas fa-refresh"></i> åˆ·æ–°é¢„è§ˆ
                            </button>
                            <span class="preview-status" id="preview-status">å‡†å¤‡å°±ç»ª</span>
                        </div>
                        <div class="prompt-preview" id="prompt-preview">
                            <div class="preview-placeholder">
                                ç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"æŸ¥çœ‹å½“å‰æç¤ºè¯å†…å®¹
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºä¸»é¢˜è®¾ç½®é¢æ¿
     */
    createThemePanel() {
        return `
            <div class="settings-group">
                <div class="theme-header-controls" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div class="theme-header-left">
                        <h3>ğŸ¨ ä¸»é¢˜é¢„è§ˆé€‰æ‹©</h3>
                        <p class="theme-description">é€‰æ‹©æ‚¨å–œæ¬¢çš„ä¸»é¢˜é£æ ¼ï¼Œç‚¹å‡»é¢„è§ˆå›¾å³å¯åº”ç”¨</p>
                    </div>
                    <div class="theme-header-right">
                        <button class="btn btn-primary status-bar-editor-btn" data-action="open-status-bar-editor" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                            <i class="fas fa-edit"></i> çŠ¶æ€æ ç¼–è¾‘
                        </button>
                    </div>
                </div>

                <div class="theme-gallery">
                    ${this.createThemePreviewGrid()}
                </div>
            </div>

            <div class="settings-group">
                <h3>ğŸ­ ä¿¡æ¯æ é£æ ¼é€‰æ‹©</h3>
                <p class="style-description">é€‰æ‹©ä¿¡æ¯æ çš„æ˜¾ç¤ºæ–¹å¼å’Œå¸ƒå±€é£æ ¼</p>

                <div class="style-gallery">
                    ${this.createStylePreviewGrid()}
                </div>
            </div>



            <div class="settings-group custom-theme-group" style="display: none;">
                <h3>è‡ªå®šä¹‰ä¸»é¢˜</h3>
                <div class="color-picker-group">
                    <div class="form-group">
                        <label>ä¸»è‰²è°ƒ</label>
                        <input type="color" name="theme.custom.primary" value="#007bff" />
                    </div>
                    <div class="form-group">
                        <label>èƒŒæ™¯è‰²</label>
                        <input type="color" name="theme.custom.background" value="#1a1a1a" />
                    </div>
                    <div class="form-group">
                        <label>æ–‡å­—è‰²</label>
                        <input type="color" name="theme.custom.text" value="#ffffff" />
                    </div>
                    <div class="form-group">
                        <label>è¾¹æ¡†è‰²</label>
                        <input type="color" name="theme.custom.border" value="#333333" />
                    </div>
                </div>

                <div class="theme-preview">
                    <h4>å®æ—¶é¢„è§ˆ</h4>
                    <div class="preview-box custom-preview">
                        <div class="preview-header">ç¤ºä¾‹æ ‡é¢˜</div>
                        <div class="preview-content">ç¤ºä¾‹å†…å®¹æ–‡å­—</div>
                        <div class="preview-button">ç¤ºä¾‹æŒ‰é’®</div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3>å­—ä½“è®¾ç½®</h3>
                <div class="form-group">
                    <label>å­—ä½“å¤§å°</label>
                    <select name="theme.fontSize" data-linked="infobar.height">
                        <option value="small">å° (12px)</option>
                        <option value="medium" selected>ä¸­ (14px)</option>
                        <option value="large">å¤§ (16px)</option>
                        <option value="xlarge">ç‰¹å¤§ (18px)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ä¿¡æ¯æ é«˜åº¦</label>
                    <select name="infobar.height" data-linked="theme.fontSize">
                        <option value="auto">è‡ªåŠ¨ (æ ¹æ®å­—ä½“)</option>
                        <option value="compact">ç´§å‡‘ (24px)</option>
                        <option value="normal" selected>æ ‡å‡† (32px)</option>
                        <option value="comfortable">èˆ’é€‚ (40px)</option>
                        <option value="spacious">å®½æ¾ (48px)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å­—ä½“æ—</label>
                    <select name="theme.fontFamily">
                        <option value="system" selected>ç³»ç»Ÿé»˜è®¤</option>
                        <option value="serif">è¡¬çº¿å­—ä½“</option>
                        <option value="sans-serif">æ— è¡¬çº¿å­—ä½“</option>
                        <option value="monospace">ç­‰å®½å­—ä½“</option>
                        <option value="custom">è‡ªå®šä¹‰å­—ä½“</option>
                    </select>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºé¢æ¿ç®¡ç†é¢æ¿
     */
    createPanelManagementPanel() {
        return `
            <div class="content-header">
                <h3>é¢æ¿ç®¡ç†</h3>
                <div class="header-actions">
                    <button class="btn-action btn-add" data-action="add-custom-panel">
                        æ·»åŠ è‡ªå®šä¹‰é¢æ¿
                    </button>
                    <button class="btn-action btn-refresh" data-action="refresh-panels">
                        åˆ·æ–°
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- é¢æ¿ç®¡ç†ä¸»ä½“ -->
                <div class="panel-management-container">
                    <!-- å·¦ä¾§é¢æ¿åˆ—è¡¨ -->
                    <div class="panel-list-section">
                        <!-- é¢æ¿åˆ†ç±»æ ‡ç­¾ -->
                        <div class="panel-categories">
                            <div class="category-tab active" data-category="all">
                                <span class="category-text">å…¨éƒ¨é¢æ¿</span>
                                <span class="category-count">${this.getTotalPanelCount()}</span>
                            </div>
                        </div>

                        <!-- é¢æ¿åˆ—è¡¨ -->
                        <div class="panel-list-container">
                            <div class="panel-list" data-category="all">
                                ${this.createPanelListItems('all')}
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§é¢æ¿å±æ€§ -->
                    <div class="panel-properties-section">
                        <div class="properties-header">
                            <h4>é¢æ¿å±æ€§</h4>
                            <div class="properties-actions">
                                <button class="btn-small btn-save" data-action="save-panel-properties" disabled style="pointer-events: auto;">
                                    <span class="btn-icon" style="pointer-events: none;">ğŸ’¾</span>
                                    <span class="btn-text" style="pointer-events: none;">ä¿å­˜</span>
                                </button>
                                <button class="btn-small btn-delete" data-action="delete-panel" disabled style="pointer-events: auto;">
                                    <span class="btn-icon" style="pointer-events: none;">ğŸ—‘ï¸</span>
                                    <span class="btn-text" style="pointer-events: none;">åˆ é™¤</span>
                                </button>
                            </div>
                        </div>

                        <div class="properties-content">
                            <div class="no-selection-message">
                                <div class="message-icon">ğŸ›ï¸</div>
                                <div class="message-text">è¯·é€‰æ‹©ä¸€ä¸ªé¢æ¿æ¥æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</div>
                            </div>

                            <!-- é¢æ¿å±æ€§è¡¨å•ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
                            <div class="panel-properties-form" style="display: none;">
                                ${this.createPanelPropertiesForm()}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæ€»ç»“é¢æ¿
     */
    createSummaryPanel() {
        return `
            <div class="content-header">
                <h3>ğŸ“Š æ€»ç»“é¢æ¿</h3>
                <div class="header-actions">
                    <button class="btn-action btn-manual-summary" id="header-manual-summary-btn">
                        <span class="btn-icon">ğŸ–Šï¸</span>
                        <span class="btn-text">æ‰‹åŠ¨æ€»ç»“</span>
                    </button>
                    <button class="btn-action btn-refresh" id="header-refresh-summary-btn">
                        <span class="btn-icon">ğŸ”„</span>
                        <span class="btn-text">åˆ·æ–°</span>
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- æ€»ç»“è®¾ç½®åŒºåŸŸ -->
                <div class="summary-settings-container">
                    <div class="settings-section">
                        <h4>âš™ï¸ æ€»ç»“è®¾ç½®</h4>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-auto-summary-enabled" />
                                    <span class="checkbox-text">å¯ç”¨è‡ªåŠ¨æ€»ç»“</span>
                                </label>
                                <div class="setting-hint">è¾¾åˆ°è®¾å®šæ¥¼å±‚æ•°åè‡ªåŠ¨ç”Ÿæˆæ€»ç»“</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-inject-summary-enabled" />
                                    <span class="checkbox-text">å¯ç”¨æ€»ç»“æ³¨å…¥</span>
                                </label>
                                <div class="setting-hint">å°†æ€»ç»“å†…å®¹ä½œä¸ºè®°å¿†æ³¨å…¥ç»™ä¸»APIï¼Œå¸®åŠ©AIä¿æŒå‰§æƒ…è¿è´¯æ€§</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-floor-count">æ€»ç»“æ¥¼å±‚æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-summary-floor-count" min="5" max="100" value="20" />
                                    <span class="input-unit">æ¡æ¶ˆæ¯</span>
                                </div>
                                <div class="setting-hint">æ¯éš”å¤šå°‘æ¡æ¶ˆæ¯è¿›è¡Œä¸€æ¬¡æ€»ç»“</div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-type">æ€»ç»“ç±»å‹</label>
                                <select id="content-summary-type" class="setting-select">
                                    <option value="small">å°æ€»ç»“ (çº¦150å­—)</option>
                                    <option value="large">å¤§æ€»ç»“ (çº¦400å­—)</option>
                                    <option value="custom">è‡ªå®šä¹‰å­—æ•°</option>
                                </select>
                            </div>
                        </div>

                        <div class="setting-row" id="content-custom-word-count-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label" for="content-summary-word-count">æ€»ç»“å­—æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-summary-word-count" min="50" max="1000" value="300" />
                                    <span class="input-unit">å­—</span>
                                </div>
                                <div class="setting-hint">è‡ªå®šä¹‰æ€»ç»“çš„å­—æ•°èŒƒå›´</div>
                            </div>
                        </div>



                        <!-- ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½® -->
                        <div class="setting-row">
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="content-auto-hide-enabled" />
                                    <span class="checkbox-text">å¯ç”¨è‡ªåŠ¨éšè—å·²æ€»ç»“æ¥¼å±‚</span>
                                </label>
                                <div class="setting-hint">è‡ªåŠ¨éšè—å·²ç»æ€»ç»“è¿‡çš„æ¥¼å±‚å†…å®¹ï¼Œå‡å°‘ç•Œé¢æ··ä¹±</div>
                            </div>
                        </div>

                        <div class="setting-row" id="content-auto-hide-threshold-row" style="display: none;">
                            <div class="setting-group">
                                <label class="setting-label" for="content-auto-hide-threshold">ä¿ç•™æœ€æ–°æ¥¼å±‚æ•°</label>
                                <div class="input-group">
                                    <input type="number" id="content-auto-hide-threshold" min="10" max="200" value="30" />
                                    <span class="input-unit">ä¸ªæ¥¼å±‚</span>
                                </div>
                                <div class="setting-hint">ä¿ç•™æœ€æ–°çš„Nä¸ªæ¥¼å±‚ä¸éšè—</div>
                            </div>
                        </div>

                        <div class="setting-actions">
                            <button class="btn-primary" id="content-save-settings-btn">
                                <span class="btn-icon">ğŸ’¾</span>
                                <span class="btn-text">ä¿å­˜è®¾ç½®</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ€»ç»“å†å²åŒºåŸŸ -->
                <div class="summary-history-container">
                    <div class="history-section">
                        <h4>ğŸ“š æ€»ç»“å†å²</h4>

                        <!-- ğŸš€ æ–°å¢ï¼šæ€»ç»“ç±»å‹ç­›é€‰ -->
                        <div class="summary-filter-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--SmartThemeBorderColor, #333);">
                            <button class="filter-tab active" data-filter="all" style="background: none; border: none; padding: 8px 16px; color: var(--SmartThemeQuoteColor, #888); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">å…¨éƒ¨</button>
                            <button class="filter-tab" data-filter="traditional" style="background: none; border: none; padding: 8px 16px; color: var(--SmartThemeQuoteColor, #888); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">ä¼ ç»Ÿæ€»ç»“</button>
                            <button class="filter-tab" data-filter="ai_memory" style="background: none; border: none; padding: 8px 16px; color: var(--SmartThemeQuoteColor, #888); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">AIè®°å¿†</button>
                        </div>

                        <div class="history-selector-group">
                            <label class="setting-label" for="content-summary-history-select">é€‰æ‹©æ€»ç»“è®°å½•</label>
                            <div class="history-select-row">
                                <select id="content-summary-history-select" class="setting-select summary-history-select">
                                    <option value="">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ€»ç»“è®°å½•</option>
                                </select>
                                <button id="content-upload-to-worldbook-btn" class="btn btn-small" title="ä¸Šä¼ å½“å‰æ€»ç»“åˆ°ä¸–ç•Œä¹¦" style="background: var(--SmartThemeAccentColor, #4a9eff); margin-right: 4px;">ğŸ“š ä¸Šä¼ </button>
                                <button id="content-delete-summary-btn" class="btn btn-small" title="åˆ é™¤å½“å‰é€‰æ‹©çš„æ€»ç»“">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                            <div class="setting-hint">é€‰æ‹©æ€»ç»“è®°å½•åï¼Œä¸‹æ–¹å°†æ˜¾ç¤ºè¯¦ç»†å†…å®¹ã€‚å¯ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦ä½œä¸ºå‰§æƒ…è®°å¿†</div>
                        </div>

                        <!-- ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½® -->
                        <div class="worldbook-upload-config" style="margin-top: 15px; padding: 12px; background: var(--SmartThemeSurfaceColor, #1a1a1a); border: 1px solid var(--SmartThemeBorderColor, #333); border-radius: 6px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--SmartThemeAccentColor, #4a9eff);">ğŸ“š ä¸–ç•Œä¹¦ä¸Šä¼ è®¾ç½®</h5>

                            <div class="setting-row">
                                <label class="setting-label" for="worldbook-auto-upload">è‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“</label>
                                <input type="checkbox" id="worldbook-auto-upload" class="setting-checkbox">
                                <div class="setting-hint">å¯ç”¨åï¼Œæ–°ç”Ÿæˆçš„æ€»ç»“å°†è‡ªåŠ¨ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦</div>
                            </div>

                            <div class="setting-row">
                                <label class="setting-label" for="worldbook-entry-format">æ¡ç›®å‘½åæ ¼å¼</label>
                                <select id="worldbook-entry-format" class="setting-select">
                                    <option value="auto">è‡ªåŠ¨å‘½åï¼ˆå‰§æƒ…æ€»ç»“ #1ã€AIè®°å¿† #1ï¼‰</option>
                                    <option value="floor_range">æ¥¼å±‚èŒƒå›´ï¼ˆæ¥¼å±‚ #1-10ï¼‰</option>
                                    <option value="custom">è‡ªå®šä¹‰åç§°</option>
                                </select>
                            </div>

                            <div class="setting-row" id="worldbook-custom-name-row" style="display: none;">
                                <label class="setting-label" for="worldbook-custom-name">è‡ªå®šä¹‰æ¡ç›®åç§°</label>
                                <input type="text" id="worldbook-custom-name" class="setting-input" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¡ç›®åç§°">
                            </div>

                            <div class="setting-row">
                                <label class="setting-label" for="worldbook-add-timestamp">æ·»åŠ æ—¶é—´æˆ³</label>
                                <input type="checkbox" id="worldbook-add-timestamp" class="setting-checkbox" checked>
                                <div class="setting-hint">åœ¨æ¡ç›®å†…å®¹ä¸­æ·»åŠ ç”Ÿæˆæ—¶é—´ä¿¡æ¯</div>
                            </div>

                            <div class="setting-row">
                                <label class="setting-label" for="worldbook-use-tags">ä½¿ç”¨å†…å®¹æ ‡ç­¾</label>
                                <input type="checkbox" id="worldbook-use-tags" class="setting-checkbox" checked>
                                <div class="setting-hint">ä¸ºæ€»ç»“å†…å®¹æ·»åŠ XMLæ ‡ç­¾ä»¥ä¾¿è¯†åˆ«ç±»å‹</div>
                            </div>

                            <div class="worldbook-batch-actions" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--SmartThemeBorderColor, #333);">
                                <button id="worldbook-batch-upload-btn" class="btn btn-small" style="background: var(--SmartThemeAccentColor, #4a9eff);">ğŸ“¤ æ‰¹é‡ä¸Šä¼ æ‰€æœ‰æ€»ç»“</button>
                                <span class="setting-hint" style="margin-left: 8px;">å°†å½“å‰èŠå¤©çš„æ‰€æœ‰æ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ€»ç»“å†…å®¹æŸ¥çœ‹åŒºåŸŸ -->
                <div class="summary-content-container" id="content-summary-content-section" style="display: none;">
                    <div class="content-section">
                        <div class="content-header-info">
                            <h4>ğŸ“„ æ€»ç»“å†…å®¹</h4>
                            <div class="content-meta">
                                <span class="content-title" id="content-summary-title"></span>
                                <span class="content-date" id="content-summary-date"></span>
                            </div>
                        </div>
                        <div class="content-body-text" id="content-summary-content-body"></div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * è·å–é¢æ¿æ€»æ•°
     */
    getTotalPanelCount() {
        return this.getBasicPanelCount() + this.getCustomPanelCount();
    }

    /**
     * è·å–åŸºç¡€é¢æ¿æ•°é‡
     */
    getBasicPanelCount() {
        const basicPanels = [
            // ç§»é™¤åŸºç¡€è®¾ç½®é¢æ¿ï¼Œå®ƒæ˜¯ç³»ç»Ÿè®¾ç½®ï¼Œä¸æ˜¯é¢æ¿
            'personal', 'interaction', 'tasks', 'world', 'organization',
            'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy',
            'modern', 'historical', 'magic', 'training'
        ];
        return basicPanels.length;
    }

    /**
     * è·å–è‡ªå®šä¹‰é¢æ¿æ•°é‡
     */
    getCustomPanelCount() {
        // ä»é…ç½®ä¸­è·å–è‡ªå®šä¹‰é¢æ¿æ•°é‡
        const customPanels = this.getCustomPanels();
        return Object.keys(customPanels).length;
    }

    /**
     * è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®
     */
    getCustomPanels() {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // è·å–è‡ªå®šä¹‰é¢æ¿æ•°æ®
            const customPanels = extensionSettings['Information bar integration tool'].customPanels || {};

            // åŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            window.InfoBarCustomPanels = customPanels;

            console.log('[InfoBarSettings] ğŸ“Š è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®:', customPanels);
            return customPanels;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–è‡ªå®šä¹‰é¢æ¿é…ç½®å¤±è´¥:', error);
            return window.InfoBarCustomPanels || {};
        }
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„é¢æ¿é”®å
     */
    generateUniqueKey(customPanels) {
        try {
            // è·å–æ‰€æœ‰ç°æœ‰çš„é”®å
            const existingKeys = Object.values(customPanels).map(panel => panel.key).filter(key => key);

            console.log('[InfoBarSettings] ğŸ” ç°æœ‰é”®å:', existingKeys);

            // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰é¢æ¿ï¼Œè¿”å› 'Custom'
            if (existingKeys.length === 0) {
                return 'Custom';
            }

            // æ£€æŸ¥ 'Custom' æ˜¯å¦å·²å­˜åœ¨
            if (!existingKeys.includes('Custom')) {
                return 'Custom';
            }

            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ•°å­—åç¼€
            let counter = 1;
            let newKey;
            do {
                newKey = `Custom${counter}`;
                counter++;
            } while (existingKeys.includes(newKey));

            console.log('[InfoBarSettings] âœ… ç”Ÿæˆå”¯ä¸€é”®å:', newKey);
            return newKey;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆå”¯ä¸€é”®åå¤±è´¥:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³
            return `Custom_${Date.now()}`;
        }
    }

    /**
     * ğŸ”§ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åID
     */
    migrateTimestampIdPanels() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const customPanels = configs.customPanels || {};

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹è¿ç§»æ—¶é—´æˆ³IDé¢æ¿åˆ°é”®åID');

            const migratedPanels = {};
            let migratedCount = 0;

            Object.entries(customPanels).forEach(([panelId, panel]) => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¶é—´æˆ³IDæ ¼å¼ï¼ˆcustom_æ•°å­—ï¼‰
                if (panelId.startsWith('custom_') && /^custom_\d+$/.test(panelId)) {
                    console.log(`[InfoBarSettings] ğŸ”„ è¿ç§»é¢æ¿: ${panelId} -> ${panel.key}`);

                    // æ›´æ–°é¢æ¿çš„IDä¸ºé”®å
                    panel.id = panel.key;

                    // ä½¿ç”¨é”®åä½œä¸ºå­˜å‚¨é”®
                    migratedPanels[panel.key] = panel;
                    migratedCount++;
                } else {
                    // ä¿æŒç°æœ‰çš„é¢æ¿
                    migratedPanels[panelId] = panel;
                }
            });

            if (migratedCount > 0) {
                // æ›´æ–°é…ç½®
                extensionSettings['Information bar integration tool'].customPanels = migratedPanels;

                // ä¿å­˜é…ç½®
                context.saveSettingsDebounced();

                console.log(`[InfoBarSettings] âœ… æˆåŠŸè¿ç§» ${migratedCount} ä¸ªé¢æ¿åˆ°é”®åID`);
                return migratedCount;
            } else {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰éœ€è¦è¿ç§»çš„æ—¶é—´æˆ³IDé¢æ¿');
                return 0;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿ç§»æ—¶é—´æˆ³IDé¢æ¿å¤±è´¥:', error);
            return 0;
        }
    }

    /**
     * ä¿®å¤é‡å¤é”®åé—®é¢˜
     */
    async fixDuplicateKeys() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ å¼€å§‹ä¿®å¤é‡å¤é”®åé—®é¢˜...');

            const customPanels = this.getCustomPanels();
            const keyCount = {};
            const duplicateKeys = [];

            // ç»Ÿè®¡é”®åä½¿ç”¨æ¬¡æ•°
            for (const [panelId, panel] of Object.entries(customPanels)) {
                const key = panel.key;
                if (key) {
                    keyCount[key] = (keyCount[key] || 0) + 1;
                    if (keyCount[key] > 1) {
                        duplicateKeys.push(key);
                    }
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š é”®åç»Ÿè®¡:', keyCount);
            console.log('[InfoBarSettings] âš ï¸ é‡å¤é”®å:', duplicateKeys);

            if (duplicateKeys.length === 0) {
                console.log('[InfoBarSettings] âœ… æ²¡æœ‰å‘ç°é‡å¤é”®å');
                return;
            }

            // ä¿®å¤é‡å¤é”®å
            let fixedCount = 0;
            for (const [panelId, panel] of Object.entries(customPanels)) {
                const key = panel.key;
                if (duplicateKeys.includes(key)) {
                    // ä¸ºé‡å¤çš„é”®åç”Ÿæˆæ–°çš„å”¯ä¸€é”®å
                    const newKey = this.generateUniqueKey(customPanels);
                    panel.key = newKey;
                    customPanels[panelId] = panel;
                    fixedCount++;

                    console.log(`[InfoBarSettings] ğŸ”§ ä¿®å¤é¢æ¿ ${panelId}: ${key} -> ${newKey}`);

                    // æ›´æ–°customPanelsä»¥é¿å…åç»­å†²çª
                    break; // ä¸€æ¬¡åªä¿®å¤ä¸€ä¸ªï¼Œç„¶åé‡æ–°æ£€æŸ¥
                }
            }

            if (fixedCount > 0) {
                // ä¿å­˜ä¿®å¤åçš„é…ç½®
                await this.saveAllCustomPanels(customPanels);
                console.log(`[InfoBarSettings] âœ… å·²ä¿®å¤ ${fixedCount} ä¸ªé‡å¤é”®å`);

                // é€’å½’ä¿®å¤å‰©ä½™çš„é‡å¤é”®å
                await this.fixDuplicateKeys();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿®å¤é‡å¤é”®åå¤±è´¥:', error);
        }
    }
    /**
     * ä¿å­˜æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®
     */
    async saveAllCustomPanels(customPanels) {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            extensionSettings['Information bar integration tool'].customPanels = customPanels;

            // ä¿å­˜åˆ°SillyTavern
            await context.saveSettingsDebounced();

            // åŒæ­¥åˆ°å…¨å±€å˜é‡
            window.InfoBarCustomPanels = customPanels;

            // ğŸ”§ æ–°å¢ï¼šæ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è·å–æ˜ å°„æ—¶é‡æ–°ç”Ÿæˆ
            this._cachedCompleteMapping = null;

            console.log('[InfoBarSettings] âœ… æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®å·²ä¿å­˜');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ›å»ºé¢æ¿åˆ—è¡¨é¡¹
     */
    createPanelListItems(category) {
        let panels = [];

        if (category === 'all' || category === 'basic') {
            panels = panels.concat(this.getBasicPanelItems());
        }

        if (category === 'all' || category === 'custom') {
            panels = panels.concat(this.getCustomPanelItems());
        }

        if (panels.length === 0) {
            return `
                <div class="empty-panel-list">
                    <div class="empty-icon">ğŸ“­</div>
                    <div class="empty-text">æš‚æ— ${category === 'custom' ? 'è‡ªå®šä¹‰' : ''}é¢æ¿</div>
                </div>
            `;
        }

        return panels.map(panel => this.createPanelListItem(panel)).join('');
    }

    /**
     * è·å–åŸºç¡€é¢æ¿é¡¹
     */
    getBasicPanelItems() {
        const basicPanels = [
            // ç§»é™¤åŸºç¡€è®¾ç½®é¢æ¿ï¼Œå®ƒæ˜¯ç³»ç»Ÿè®¾ç½®ï¼Œä¸æ˜¯é¢æ¿
                    { id: 'personal', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤', type: 'basic' },
        { id: 'interaction', name: 'äº¤äº’å¯¹è±¡', icon: 'ğŸ‘¥', type: 'basic' },
        { id: 'tasks', name: 'ä»»åŠ¡ç³»ç»Ÿ', icon: 'ğŸ“‹', type: 'basic' },
        { id: 'world', name: 'ä¸–ç•Œè®¾å®š', icon: 'ğŸŒ', type: 'basic' },
        { id: 'organization', name: 'ç»„ç»‡æ¶æ„', icon: 'ğŸ¢', type: 'basic' },
        { id: 'news', name: 'æ–°é—»äº‹ä»¶', icon: 'ğŸ“°', type: 'basic' },
        { id: 'inventory', name: 'ç‰©å“æ¸…å•', icon: 'ğŸ’', type: 'basic' },
        { id: 'abilities', name: 'èƒ½åŠ›æŠ€èƒ½', icon: 'âš¡', type: 'basic' },
        { id: 'plot', name: 'å‰§æƒ…å‘å±•', icon: 'ğŸ“–', type: 'basic' },
        { id: 'cultivation', name: 'ä¿®ç‚¼ç³»ç»Ÿ', icon: 'ğŸ§˜', type: 'basic' },
        { id: 'fantasy', name: 'ç„å¹»ä¸–ç•Œ', icon: 'ğŸ”®', type: 'basic' },
        { id: 'modern', name: 'ç°ä»£éƒ½å¸‚', icon: 'ğŸ™ï¸', type: 'basic' },
        { id: 'historical', name: 'å†å²å¤ä»£', icon: 'ğŸ›ï¸', type: 'basic' },
        { id: 'magic', name: 'é­”æ³•èƒ½åŠ›', icon: 'ğŸª„', type: 'basic' },
        { id: 'training', name: 'è°ƒæ•™ç³»ç»Ÿ', icon: 'ğŸ¯', type: 'basic' }
        ];

        return basicPanels;
    }

    /**
     * è·å–è‡ªå®šä¹‰é¢æ¿é¡¹
     */
    getCustomPanelItems() {
        const customPanels = this.getCustomPanels();
        return Object.values(customPanels).map(panel => ({
            ...panel,
            type: 'custom'
        }));
    }

    /**
     * åˆ›å»ºå•ä¸ªé¢æ¿åˆ—è¡¨é¡¹
     */
    createPanelListItem(panel) {
        const typeClass = panel.type === 'custom' ? 'custom-panel' : 'basic-panel';

        return `
            <div class="panel-list-item ${typeClass}" data-panel-id="${panel.id}" data-panel-type="${panel.type}">
                <div class="panel-item-info">
                    <div class="panel-item-name">${panel.name}</div>
                    <div class="panel-item-meta">
                        <span class="panel-type">ï¼ˆ${panel.type === 'custom' ? 'è‡ªå®šä¹‰' : 'åŸºç¡€'}ï¼‰</span>
                    </div>
                </div>
                <div class="panel-item-actions">
                    ${panel.type === 'custom' ? `
                        <button class="btn-icon" data-action="edit-panel" data-panel-id="${panel.id}" title="ç¼–è¾‘">
                            ç¼–è¾‘
                        </button>
                        <button class="btn-icon" data-action="duplicate-panel" data-panel-id="${panel.id}" title="å¤åˆ¶">
                            å¤åˆ¶
                        </button>
                    ` : `
                        <button class="btn-icon" data-action="view-panel" data-panel-id="${panel.id}" title="æŸ¥çœ‹">
                            æŸ¥çœ‹
                        </button>
                    `}
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºé¢æ¿å±æ€§è¡¨å•
     */
    createPanelPropertiesForm() {
        return `
            <div class="properties-form">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-section">
                    <h5>åŸºæœ¬ä¿¡æ¯</h5>
                    <div class="form-group">
                        <label for="panel-name">é¢æ¿åç§°</label>
                        <input type="text" id="panel-name" name="panel.name" placeholder="è¯·è¾“å…¥é¢æ¿åç§°" />
                    </div>
                    <div class="form-group">
                        <label for="panel-key">é”®å</label>
                        <input type="text" id="panel-key" name="panel.key" placeholder="è¯·è¾“å…¥é”®åï¼ˆç”¨äºé…ç½®å­˜å‚¨ï¼‰" />
                        <div class="form-hint">é”®åç”¨äºé…ç½®å­˜å‚¨ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡å’Œä¸‹åˆ’çº¿</div>
                    </div>
                    <div class="form-group">
                        <label for="panel-description">é¢æ¿è¯´æ˜</label>
                        <textarea id="panel-description" name="panel.description" rows="3" placeholder="è¯·è¾“å…¥é¢æ¿è¯´æ˜"></textarea>
                    </div>
                </div>

                <!-- é…ç½®é€‰é¡¹ -->
                <div class="form-section">
                    <h5>é…ç½®é€‰é¡¹</h5>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="panel-required" name="panel.required" />
                            <span>æ˜¯å¦å¿…å¡«</span>
                        </label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="panel-memory-inject" name="panel.memoryInject" />
                            <span>æ˜¯å¦æ³¨å…¥è®°å¿†</span>
                        </label>
                    </div>

                </div>



                <!-- å­é¡¹é…ç½® -->
                <div class="form-section">
                    <h5>å­é¡¹é…ç½®</h5>
                    <div class="sub-items-header">
                        <span>å­é¡¹åˆ—è¡¨</span>
                        <button type="button" class="btn-small btn-add-sub-item" data-action="add-sub-item">
                            <span class="btn-icon" style="pointer-events: none;">â•</span>
                            <span class="btn-text" style="pointer-events: none;">æ–°å¢å­é¡¹</span>
                        </button>
                    </div>
                    <div class="sub-items-container">
                        <div class="empty-sub-items">
                            <div class="empty-icon">ğŸ“</div>
                            <div class="empty-text">æš‚æ— å­é¡¹ï¼Œç‚¹å‡»"æ–°å¢å­é¡¹"æ·»åŠ </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå‰ç«¯æ˜¾ç¤ºé¢æ¿
     */
    createFrontendDisplayPanel() {
        return `
            <div class="settings-group">
                <h3>ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºè®¾ç½®</h3>
                <p class="frontend-description">å¯ç”¨å‰ç«¯æ˜¾ç¤ºåï¼ŒAIæ¶ˆæ¯å°†åŒ…è£¹åœ¨ä¿¡æ¯æ æ¡†æ¶ä¸­ï¼Œæä¾›äº¤äº’å¼çš„é¢æ¿å’Œå­é¡¹æ˜¾ç¤º</p>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.enabled" />
                        <span>å¯ç”¨å‰ç«¯æ˜¾ç¤º</span>
                    </label>
                    <p class="help-text">å¯ç”¨åï¼ŒAIæ¶ˆæ¯åŒºåŸŸå°†æ˜¾ç¤ºäº¤äº’å¼çš„ä¿¡æ¯æ é¢„è§ˆç•Œé¢</p>
                </div>
            </div>

            <div class="settings-group frontend-display-config" style="display: none;">
                <h3>ğŸ“Š æ˜¾ç¤ºé…ç½®</h3>

                <div class="form-group">
                    <label>æ˜¾ç¤ºæ ·å¼</label>
                    <select name="frontendDisplay.style">
                        <option value="left">å·¦å¯¹é½</option>
                        <option value="center">å±…ä¸­æ˜¾ç¤º</option>
                        <option value="right">å³å¯¹é½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.showAddButtons" checked />
                        <span>æ˜¾ç¤ºæ·»åŠ æŒ‰é’®</span>
                    </label>
                    <p class="help-text">åœ¨é¢„è§ˆçª—å£ä¸Šä¸‹æ–¹æ˜¾ç¤ºå¯ç‚¹å‡»çš„æ·»åŠ æ¡†æ¡†</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="frontendDisplay.animationEnabled" checked />
                        <span>å¯ç”¨åŠ¨ç”»æ•ˆæœ</span>
                    </label>
                </div>
            </div>

            <div class="settings-group frontend-display-preview" style="display: none;">
                <h3>ğŸ® äº¤äº’é¢„è§ˆ</h3>
                <p class="preview-description">é¢„è§ˆå‰ç«¯æ˜¾ç¤ºçš„äº¤äº’æ•ˆæœ</p>

                <div class="frontend-preview-container">
                    <!-- é¡¶éƒ¨é¢„è§ˆåŒºåŸŸ -->
                    <div class="preview-section">
                        <h4>ğŸ” é¡¶éƒ¨é¢„è§ˆå†…å®¹</h4>
                        <div class="ai-message-wrapper top-preview">
                            <div class="add-panel-slots top-slots">
                                <div class="add-slot" data-position="top-1" data-area="top">+</div>
                                <div class="add-slot" data-position="top-2" data-area="top">+</div>
                                <div class="add-slot" data-position="top-3" data-area="top">+</div>
                            </div>

                            <div class="embedded-panels top-embedded-panels">
                                <!-- ç”¨æˆ·æ·»åŠ çš„é¡¶éƒ¨é¢æ¿å’Œå­é¡¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>

                    <!-- AIæ¶ˆæ¯å†…å®¹ -->
                    <div class="ai-message-preview">
                        <div class="message-content">
                            <p>è¿™æ˜¯AIæ¶ˆæ¯çš„é¢„è§ˆå†…å®¹...</p>
                        </div>
                    </div>

                    <!-- åº•éƒ¨é¢„è§ˆåŒºåŸŸ -->
                    <div class="preview-section">
                        <h4>ğŸ”½ åº•éƒ¨é¢„è§ˆå†…å®¹</h4>
                        <div class="ai-message-wrapper bottom-preview">
                            <div class="embedded-panels bottom-embedded-panels">
                                <!-- ç”¨æˆ·æ·»åŠ çš„åº•éƒ¨é¢æ¿å’Œå­é¡¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>

                            <div class="add-panel-slots bottom-slots">
                                <div class="add-slot" data-position="bottom-1" data-area="bottom">+</div>
                                <div class="add-slot" data-position="bottom-2" data-area="bottom">+</div>
                                <div class="add-slot" data-position="bottom-3" data-area="bottom">+</div>
                            </div>
                        </div>
                    </div>
                </div>

                                    <div class="preview-actions">
                        <button class="btn" data-action="test-panel-popup">æµ‹è¯•é¢æ¿å¼¹çª—</button>
                        <button class="btn" data-action="test-add-panel">æµ‹è¯•æ·»åŠ é¢æ¿</button>
                        <button class="btn" data-action="clear-preview">æ¸…ç©ºé¢„è§ˆ</button>
                    </div>
            </div>


        `;
    }

    /**
     * åˆ›å»ºé«˜çº§è®¾ç½®é¢æ¿
     */
    createAdvancedPanel() {
        return `
            <div class="settings-group">
                <h3>è°ƒè¯•è®¾ç½®</h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="debug.enabled" />
                        <span>å¯ç”¨è°ƒè¯•æ¨¡å¼</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>æ—¥å¿—çº§åˆ«</label>
                    <select name="debug.logLevel">
                        <option value="error">é”™è¯¯</option>
                        <option value="warn">è­¦å‘Š</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="debug">è°ƒè¯•</option>
                    </select>
                </div>
                <div class="form-group debug-actions-row">
                    <button class="btn" data-action="open-error-log">é”™è¯¯æ—¥å¿—</button>
                    <button class="btn" data-action="open-project-link">é¡¹ç›®åœ°å€</button>
                </div>
            </div>

            <div class="settings-group">
                <h3>é…ç½®ç®¡ç†</h3>

                <!-- å¯¼å‡ºé…ç½®é€‰é¡¹ -->
                <div class="form-group">
                    <label>å¯¼å‡ºé…ç½®é€‰é¡¹</label>
                    <div class="export-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-panel-configs" checked />
                            <span>é¢æ¿é…ç½®ï¼ˆå¯ç”¨çŠ¶æ€ã€è‡ªå®šä¹‰å­é¡¹ã€è‡ªå®šä¹‰é¢æ¿ï¼‰</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-panel-rules" checked />
                            <span>é¢æ¿è§„åˆ™</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-field-rules" checked />
                            <span>å­—æ®µè§„åˆ™</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-theme-settings" />
                            <span>ä¸»é¢˜è®¾ç½®</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-api-settings" />
                            <span>APIè®¾ç½®</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-all-settings" />
                            <span>æ‰€æœ‰è®¾ç½®ï¼ˆåŒ…å«è°ƒè¯•ã€å‰ç«¯æ˜¾ç¤ºç­‰ï¼‰</span>
                        </label>
                    </div>
                </div>

                <!-- é…ç½®æ–‡ä»¶æ“ä½œ -->
                <div class="form-group">
                    <label>ä¿å­˜ä¸ºé…ç½®åç§°</label>
                    <input type="text" id="config-profile-name" placeholder="è¾“å…¥é…ç½®åç§°" />
                </div>
                <div class="form-group config-primary-actions">
                    <button class="btn" data-action="save-profile">ä¿å­˜é…ç½®</button>
                    <button class="btn btn-primary" data-action="export-custom">ğŸ“¤ å¯¼å‡ºé€‰å®šé…ç½®</button>
                    <button class="btn" data-action="export">å¯¼å‡ºå…¨éƒ¨é…ç½®</button>
                    <button class="btn" data-action="import">å¯¼å…¥é…ç½®</button>
                </div>

                <!-- å·²ä¿å­˜çš„é…ç½® -->
                <div class="form-group">
                    <label>å·²ä¿å­˜çš„é…ç½®</label>
                    <div class="config-row">
                        <select id="config-profile-select" class="setting-select">
                            <option value="">è¯·é€‰æ‹©ä¸€ä¸ªé…ç½®</option>
                        </select>
                        <div class="config-row-actions">
                            <button class="btn btn-small" data-action="load-profile">åŠ è½½é…ç½®</button>
                            <button class="btn btn-small" data-action="delete-profile">åˆ é™¤é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3>æ•°æ®ç®¡ç†</h3>
                <div class="form-group">
                    <label>æ•°æ®èŒƒå›´</label>
                    <select id="data-scope-select" name="dataManagement.scope">
                        <option value="current">å½“å‰èŠå¤©</option>
                        <option value="all">æ‰€æœ‰èŠå¤©</option>
                    </select>
                    <small>é€‰æ‹©è¦å¯¼å‡ºæˆ–å¯¼å…¥çš„æ•°æ®èŒƒå›´</small>
                </div>
                <div class="form-group">
                    <label>æ•°æ®æ ¼å¼</label>
                    <select id="data-format-select" name="dataManagement.format">
                        <option value="json">JSONæ ¼å¼</option>
                        <option value="csv">CSVæ ¼å¼</option>
                        <option value="xml">XMLæ ¼å¼</option>
                    </select>
                    <small>é€‰æ‹©å¯¼å‡ºæˆ–å¯¼å…¥çš„æ•°æ®æ ¼å¼</small>
                </div>
                <div class="form-group">
                    <div class="data-management-actions">
                        <button class="btn btn-primary data-export-btn" data-action="export-data">
                            ğŸ“¤ å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="btn btn-secondary data-import-btn" data-action="import-data">
                            ğŸ“¥ å¯¼å…¥æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <small class="data-management-hint">
                        ğŸ’¡ å¯¼å‡ºåŠŸèƒ½å°†åŒ…å«èŠå¤©ä¿¡æ¯ã€æ¶ˆæ¯è®°å½•å’Œä¿¡æ¯æ æ•°æ®ã€‚å¯¼å…¥å‰è¯·ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ã€‚
                    </small>
                </div>
            </div>

            <div class="settings-group danger-zone">
                <h3>å±é™©æ“ä½œ</h3>
                <div class="form-group">
                    <button class="btn btn-danger" data-action="clear-cache">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
                    <button class="btn btn-danger" data-action="initialize-plugin">åˆå§‹åŒ–æ’ä»¶</button>
                    <button class="btn btn-danger" data-action="clear-panel-data">æ¸…ç©ºé¢æ¿æ•°æ®</button>
                </div>
                <div class="form-group">
                    <small class="text-muted">
                        âš ï¸ å±é™©æ“ä½œè¯´æ˜ï¼š<br>
                        â€¢ åˆå§‹åŒ–æ’ä»¶ï¼šå°†æ’ä»¶æ¢å¤åˆ°åˆšå®‰è£…çš„çŠ¶æ€ï¼Œæ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®ã€è‡ªå®šä¹‰å†…å®¹å’Œè§„åˆ™<br>
                        â€¢ æ¸…ç©ºé¢æ¿æ•°æ®ï¼šæ¸…ç©ºæ‰€æœ‰èŠå¤©ä¸­çš„é¢æ¿æ•°æ®ï¼Œä½†ä¿ç•™é…ç½®å’Œè§„åˆ™
                    </small>
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    bindEvents() {
        try {
            // æ¨¡æ€æ¡†äº‹ä»¶
            this.modal.addEventListener('click', (e) => {
                const actionEl = e.target.closest('[data-action]');
                const action = actionEl?.dataset?.action;

                if (action) {
                    console.log('[InfoBarSettings] ğŸ”˜ å¤„ç†æ“ä½œ:', action, 'å…ƒç´ :', actionEl);
                    console.log('[InfoBarSettings] ğŸ” Switchè¯­å¥å³å°†å¤„ç†action:', action);
                }

                switch (action) {
                    case 'close':
                    case 'cancel':
                        this.hide();
                        break;
                    case 'save':
                        this.saveSettings();
                        break;
                    // resetäº‹ä»¶å·²ç§»é™¤
                    case 'export':
                        this.exportSettings();
                        break;
                    case 'import':
                        this.importSettings();
                        break;
                    case 'test-api':
                        this.testAPIConnection();
                        break;
                    case 'load-models':
                        this.loadAPIModels();
                        break;
                    case 'open-error-log':
                        this.openErrorLogModal();
                        break;
                    case 'open-project-link':
                        this.openProjectLink();
                        break;
                    case 'save-profile':
                        this.saveSettingsProfile();
                        break;
                    case 'load-profile':
                        this.loadSettingsProfile();
                        break;
                    case 'delete-profile':
                        this.deleteSettingsProfile();
                        break;
                    case 'export-data':
                        console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å‡ºæ•°æ®...');
                        this.exportData().catch(error => {
                            console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                            this.showMessage('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
                        });
                        break;
                    case 'import-data':
                        console.log('[InfoBarSettings] ğŸš€ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ•°æ®...');
                        this.importData().catch(error => {
                            console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                            this.showMessage('å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                        });
                        break;
                    default:
                        if (action) {
                            console.log('[InfoBarSettings] âš ï¸ æœªå¤„ç†çš„æ“ä½œ:', action);
                        }
                        break;
                }
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢
            this.modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    this.switchTab(e.target.dataset.tab);
                }
            });

            // è¡¨å•å˜æ›´äº‹ä»¶
            this.modal.addEventListener('change', (e) => {
                this.handleFormChange(e);
            });

            // èŒƒå›´è¾“å…¥å®æ—¶æ›´æ–°
            this.modal.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan && valueSpan.classList.contains('range-value')) {
                        valueSpan.textContent = e.target.value;
                    }
                }
            });

            console.log('[InfoBarSettings] ğŸ”— äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šäº‹ä»¶å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆå§‹åŒ–æ‰€æœ‰åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹æ˜¾ç¤º
     */
    initAllBasicPanelCustomSubItems() {
        try {
            const basicPanelIds = ['personal', 'interaction', 'tasks', 'world', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];

            basicPanelIds.forEach(panelId => {
                const panelData = this.getBasicPanelData(panelId);
                if (panelData && panelData.subItems && panelData.subItems.length > 0) {
                    this.refreshBasicPanelContent(panelId);
                    console.log(`[InfoBarSettings] ğŸ”„ å·²åˆå§‹åŒ–åŸºç¡€é¢æ¿ ${panelId} çš„è‡ªå®šä¹‰å­é¡¹æ˜¾ç¤º`);
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­é¡¹å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºè®¾ç½®ç•Œé¢
     */
    async show() {
        try {
            if (!this.initialized) {
                await this.init();
            }

            // åªåœ¨é¦–æ¬¡æ˜¾ç¤ºæˆ–æ˜ç¡®éœ€è¦åˆ·æ–°æ—¶åŠ è½½è®¾ç½®
            if (!this.settingsLoaded || this.needsSettingsRefresh) {
                console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½æœ€æ–°è®¾ç½®...');
                await this.loadSettings();
                this.settingsLoaded = true;
                this.needsSettingsRefresh = false;
            } else {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨å·²ç¼“å­˜çš„è®¾ç½®');
            }

            // ç¡®ä¿æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½
            this.ensureDataManagementStyles();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            this.modal.style.display = 'flex';
            this.visible = true;

            // ğŸ”§ ä¿®å¤ï¼šå»¶è¿Ÿåˆå§‹åŒ–åŸºç¡€é¢æ¿è‡ªå®šä¹‰å­é¡¹ï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½
            setTimeout(() => {
                this.initAllBasicPanelCustomSubItems();
                // åˆ·æ–°å·²ä¿å­˜é…ç½®ä¸‹æ‹‰
                this.refreshProfilesSelect();
                // ğŸ†• åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿
                this.initWorldBookConfigPanel();
                // åº”ç”¨è°ƒè¯•çº§åˆ«åˆ°æ§åˆ¶å°
                const enabled = this.modal.querySelector('[name="debug.enabled"]')?.checked;
                const level = this.modal.querySelector('[name="debug.logLevel"]').value || 'info';
                this.applyConsoleLogLevel(enabled ? level : 'none');
            }, 100); // 100mså»¶è¿Ÿç¡®ä¿DOMæ¸²æŸ“å®Œæˆ

            // è§¦å‘æ˜¾ç¤ºäº‹ä»¶
            if (this.eventSystem) {
                this.eventSystem.emit('ui:show', {
                    component: 'InfoBarSettings',
                    timestamp: Date.now()
                });
            }

            console.log('[InfoBarSettings] ğŸ‘ï¸ è®¾ç½®ç•Œé¢å·²æ˜¾ç¤º');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºç•Œé¢å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * éšè—è®¾ç½®ç•Œé¢
     */
    hide() {
        try {
            this.modal.style.display = 'none';
            this.visible = false;

            // è§¦å‘éšè—äº‹ä»¶
            if (this.eventSystem) {
                this.eventSystem.emit('ui:hide', {
                    component: 'InfoBarSettings',
                    timestamp: Date.now()
                });
            }

            console.log('[InfoBarSettings] ğŸ‘ï¸ è®¾ç½®ç•Œé¢å·²éšè—');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éšè—ç•Œé¢å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * åˆ‡æ¢æ ‡ç­¾é¡µ
     */
    switchTab(tabName) {
        try {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            this.modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // æ›´æ–°é¢æ¿æ˜¾ç¤ºçŠ¶æ€
            this.modal.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.panel === tabName);
            });

            this.currentTab = tabName;

            console.log(`[InfoBarSettings] ğŸ“‘ åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥:', error);
            this.handleError(error);
        }
    }
    /**
     * åŠ è½½è®¾ç½®åˆ°è¡¨å•
     */
    async loadSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ å¼€å§‹åŠ è½½è®¾ç½®...');

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            const configs = extensionSettings['Information bar integration tool'];

            // ç‰¹åˆ«å¤„ç†å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼Œç¡®ä¿ä»FrontendDisplayManagerè¯»å–æœ€æ–°çŠ¶æ€
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
                            if (fdm) {
                const frontendDisplayConfig = await fdm.getSavedFrontendDisplayConfig();
                if (frontendDisplayConfig) {
                    configs.frontendDisplay = frontendDisplayConfig;
                    console.log('[InfoBarSettings] ğŸ“± å·²åŠ è½½å‰ç«¯æ˜¾ç¤ºé…ç½®:', frontendDisplayConfig);

                    // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“é¢„è§ˆå†…å®¹
                    this.renderFrontendDisplayPreview(frontendDisplayConfig);
                }
            }

            // å¡«å……è¡¨å• - é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
            this.loadNestedConfigs(configs);

            // æ ¹æ®åŠ è½½çš„å‰ç«¯æ˜¾ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè®¾ç½®UIåŒºåŸŸçš„æ˜¾ç¤º/éšè—
            if (configs.frontendDisplay && typeof configs.frontendDisplay.enabled === 'boolean') {
                this.toggleFrontendDisplaySections(configs.frontendDisplay.enabled);
                console.log('[InfoBarSettings] ğŸ–¥ï¸ å‰ç«¯æ˜¾ç¤ºåŒºåŸŸçŠ¶æ€å·²è®¾ç½®:', configs.frontendDisplay.enabled);
            }

            // ç‰¹åˆ«å¤„ç†è‡ªå®šä¹‰é¢æ¿é…ç½®ï¼Œç¡®ä¿è®¾ç½®åˆ°å…¨å±€å˜é‡
            if (configs.customPanels && typeof configs.customPanels === 'object') {
                window.InfoBarCustomPanels = configs.customPanels;
                console.log('[InfoBarSettings] ğŸ“Š å·²åŠ è½½è‡ªå®šä¹‰é¢æ¿é…ç½®:', Object.keys(configs.customPanels).length, 'ä¸ªé¢æ¿');

                // æ‰“å°è¯¦ç»†çš„é¢æ¿ä¿¡æ¯ç”¨äºè°ƒè¯•
                for (const [panelId, panel] of Object.entries(configs.customPanels)) {
                    console.log(`[InfoBarSettings] ğŸ“‹ é¢æ¿ ${panelId}:`, panel.name, panel.enabled ? '(å¯ç”¨)' : '(ç¦ç”¨)');
                }

                // è®¾ç½®è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
                this.loadCustomPanelSubItemStates(configs.customPanels);
            } else {
                // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰é¢æ¿é…ç½®ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡
                window.InfoBarCustomPanels = {};
                console.log('[InfoBarSettings] ğŸ“Š åˆå§‹åŒ–ç©ºçš„è‡ªå®šä¹‰é¢æ¿é…ç½®');
            }

            // ğŸ”§ æ–°å¢ï¼šåŠ è½½åŸºç¡€é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
            this.loadBasicPanelSubItemStates(configs);

            // ç‰¹åˆ«å¤„ç†ä¸»é¢˜é…ç½®
            if (configs.theme && configs.theme.current) {
                const themeId = configs.theme.current;
                console.log('[InfoBarSettings] ğŸ¨ åŠ è½½ä¸»é¢˜é…ç½®:', themeId);

                // æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
                this.updateThemeCardStates(themeId);

                // åº”ç”¨ä¸»é¢˜
                const theme = this.getThemeById(themeId);
                if (theme) {
                    this.applyTheme(theme);
                    this.updateCurrentThemeInfo(theme);
                }
            }

            // ç‰¹åˆ«å¤„ç†é£æ ¼é…ç½®
            if (configs.style && configs.style.current) {
                const styleId = configs.style.current;
                console.log('[InfoBarSettings] ğŸ­ åŠ è½½é£æ ¼é…ç½®:', styleId);

                // æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
                this.updateStyleCardStates(styleId);

                // åº”ç”¨é£æ ¼
                const style = this.getStyleById(styleId);
                if (style) {
                    this.applyStyle(style);
                    this.updateCurrentStyleInfo(style);
                }
            }

            // æ›´æ–°APIçŠ¶æ€
            if (this.apiIntegration) {
                this.updateAPIStatus();
            }

            // ç‰¹åˆ«å¤„ç†APIæ¨¡å‹é…ç½® - å¦‚æœæœ‰ä¿å­˜çš„æ¨¡å‹é…ç½®ï¼Œè‡ªåŠ¨åŠ è½½æ¨¡å‹åˆ—è¡¨
            if (configs.apiConfig && configs.apiConfig.model && configs.apiConfig.provider && configs.apiConfig.apiKey) {
                console.log('[InfoBarSettings] ğŸ”„ æ£€æµ‹åˆ°ä¿å­˜çš„æ¨¡å‹é…ç½®ï¼Œè‡ªåŠ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...');
                console.log('[InfoBarSettings] ğŸ“‹ ä¿å­˜çš„æ¨¡å‹:', configs.apiConfig.model);
                console.log('[InfoBarSettings] ğŸ¢ æä¾›å•†:', configs.apiConfig.provider);

                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIå·²å®Œå…¨æ¸²æŸ“
                setTimeout(async () => {
                    try {
                        await this.loadModelList();
                        // åŠ è½½å®Œæˆåï¼Œæ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©
                        const modelSelect = this.modal.querySelector('#api-model');
                        if (modelSelect && configs.apiConfig.model) {
                            modelSelect.value = configs.apiConfig.model;
                            console.log('[InfoBarSettings] âœ… å·²æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©:', configs.apiConfig.model);
                        }
                    } catch (error) {
                        console.error('[InfoBarSettings] âŒ è‡ªåŠ¨åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    }
                }, 500);
            }

            // åˆ·æ–°å¯¼èˆªæ ï¼ˆåŠ è½½è‡ªå®šä¹‰é¢æ¿ï¼‰
            this.refreshNavigation();

            // æ›´æ–°æ‰€æœ‰é¢æ¿çš„é…ç½®è®¡æ•°
            this.updateAllPanelCounts();

            // ğŸ”§ ä¿®å¤ï¼šæ¢å¤æç¤ºè¯æ’å…¥ä½ç½®UIçŠ¶æ€
            const promptPositionMode = configs.basic?.promptPosition?.mode || 'afterCharacter';
            console.log('[InfoBarSettings] ğŸ“ æ¢å¤æç¤ºè¯ä½ç½®UIçŠ¶æ€:', promptPositionMode);
            this.handlePromptPositionModeChange(promptPositionMode);

            // ğŸ§  åŠ è½½æç¤ºè¯è®¾ç½®
            await this.loadPromptSettings();

            console.log('[InfoBarSettings] âœ… è®¾ç½®åŠ è½½å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è®¾ç½®å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * é€’å½’åŠ è½½åµŒå¥—é…ç½®
     */
    loadNestedConfigs(configs, prefix = '') {
        try {
            for (const [key, value] of Object.entries(configs)) {
                const fullKey = prefix ? `${prefix}.${key}` : key;

                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
                    this.loadNestedConfigs(value, fullKey);
                } else {
                    // è®¾ç½®è¡¨å•å€¼
                    this.setFormValue(fullKey, value);
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½åµŒå¥—é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * è®¾ç½®è¡¨å•å€¼
     */
    setFormValue(name, value) {
        try {
            const element = this.modal.querySelector(`[name="${name}"]`);

            if (!element) {
                return;
            }

            if (element.type === 'checkbox') {
                element.checked = Boolean(value);
            } else if (element.type === 'radio') {
                // ğŸ”§ ä¿®å¤ï¼šå•é€‰æ¡†ç‰¹æ®Šå¤„ç†ï¼Œåªè®¾ç½®checkedçŠ¶æ€ï¼Œä¸ä¿®æ”¹valueå±æ€§
                if (element.value === value) {
                    element.checked = true;
                } else {
                    element.checked = false;
                }
            } else if (element.type === 'range') {
                element.value = value;
                const valueSpan = element.nextElementSibling;
                if (valueSpan && valueSpan.classList.contains('range-value')) {
                    valueSpan.textContent = value;
                }
            } else {
                // ç‰¹æ®Šå¤„ç†æ¥å£ç±»å‹é€‰æ‹©å™¨
                if (name === 'apiConfig.format' && element.id === 'interface-type') {
                    // å¦‚æœæ˜¯æ¥å£ç±»å‹é€‰æ‹©å™¨ï¼Œéœ€è¦å…ˆè§¦å‘æä¾›å•†å˜æ›´æ¥ç”Ÿæˆé€‰é¡¹
                    const providerElement = this.modal.querySelector('[name="apiConfig.provider"]');
                    if (providerElement && providerElement.value) {
                        this.handleProviderChange(providerElement.value);
                        // å»¶è¿Ÿè®¾ç½®å€¼ï¼Œç­‰å¾…é€‰é¡¹ç”Ÿæˆ
                        setTimeout(() => {
                            element.value = value || '';
                        }, 100);
                    } else {
                        element.value = value || '';
                    }
                } else {
                    element.value = value || '';
                }
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ è®¾ç½®è¡¨å•å€¼å¤±è´¥ (${name}):`, error);
        }
    }

    /**
     * ä¿å­˜è®¾ç½®
     */
    async saveSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ å¼€å§‹ä¿å­˜è®¾ç½®...');

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = this.collectFormData();

            // ç¡®ä¿è‡ªå®šä¹‰é¢æ¿æ•°æ®åŒ…å«åœ¨ä¿å­˜çš„é…ç½®ä¸­ï¼Œå¹¶æ›´æ–°å­é¡¹å‹¾é€‰çŠ¶æ€
            const customPanels = this.getCustomPanels();
            if (customPanels && Object.keys(customPanels).length > 0) {
                // æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
                this.updateCustomPanelSubItemStates(customPanels, formData);
                formData.customPanels = customPanels;
                console.log('[InfoBarSettings] ğŸ“Š åŒ…å«è‡ªå®šä¹‰é¢æ¿æ•°æ®:', Object.keys(customPanels).length, 'ä¸ªé¢æ¿');
            }

            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ğŸ”§ ä¿®å¤ï¼šå®Œå…¨ä¿æŠ¤åŸºç¡€é¢æ¿å±æ€§é…ç½®ï¼Œé¿å…è¢«åŸºç¡€è®¾ç½®é¡µé¢è¦†ç›–
            // åŸºç¡€é¢æ¿çš„å±æ€§é…ç½®ï¼ˆdescriptionã€iconã€requiredã€memoryInjectã€promptsç­‰ï¼‰
            // åº”è¯¥åªé€šè¿‡é¢æ¿ç®¡ç†é¡µé¢ä¿®æ”¹ï¼Œä¸åº”è¯¥è¢«åŸºç¡€è®¾ç½®é¡µé¢çš„è¡¨å•æ•°æ®è¦†ç›–
            const basicPanelIds = ['personal', 'interaction', 'tasks', 'world', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];
            const preservedBasicPanelConfigs = {};

            // å®Œæ•´å¤‡ä»½æ‰€æœ‰åŸºç¡€é¢æ¿é…ç½®
            basicPanelIds.forEach(panelId => {
                const existingConfig = extensionSettings['Information bar integration tool'][panelId];
                if (existingConfig) {
                    preservedBasicPanelConfigs[panelId] = { ...existingConfig };
                    console.log(`[InfoBarSettings] ğŸ›¡ï¸ ä¿æŠ¤åŸºç¡€é¢æ¿ ${panelId} çš„å®Œæ•´å±æ€§é…ç½®`);
                }
            });

            // ä¿å­˜åŸºç¡€è®¾ç½®è¡¨å•æ•°æ®ï¼ˆä¸åŒ…å«åŸºç¡€é¢æ¿å±æ€§ï¼‰
            Object.assign(extensionSettings['Information bar integration tool'], formData);

            // é¢å¤–æ”¶é›†è®°å¿†å¢å¼ºé¢æ¿çš„è®¾ç½®ï¼ˆè¿™äº›æ§ä»¶å¤§å¤šæ²¡æœ‰ nameï¼Œéœ€è¦å•ç‹¬å¤„ç†ï¼‰
            if (typeof this.collectMemoryEnhancementFormData === 'function') {
                const memoryEnhancementData = this.collectMemoryEnhancementFormData();
                if (memoryEnhancementData && typeof memoryEnhancementData === 'object') {
                    extensionSettings['Information bar integration tool'].memoryEnhancement = memoryEnhancementData;
                    console.log('[InfoBarSettings] ğŸ§  å·²æ”¶é›†è®°å¿†å¢å¼ºè®¾ç½®å¹¶å†™å…¥é…ç½®');
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½æ¢å¤åŸºç¡€é¢æ¿å±æ€§é…ç½®ï¼Œä¿ç•™å­é¡¹å¯ç”¨çŠ¶æ€
            Object.keys(preservedBasicPanelConfigs).forEach(panelId => {
                const currentConfig = extensionSettings['Information bar integration tool'][panelId];
                const preservedConfig = preservedBasicPanelConfigs[panelId];

                // åˆå¹¶é…ç½®ï¼šä¿ç•™æ–°çš„å­é¡¹å¯ç”¨çŠ¶æ€å’Œé¢æ¿å¯ç”¨çŠ¶æ€ï¼Œæ¢å¤å…¶ä»–å±æ€§
                if (currentConfig && preservedConfig) {
                    // å¤‡ä»½å½“å‰çš„å­é¡¹å¯ç”¨çŠ¶æ€å’Œé¢æ¿å¯ç”¨çŠ¶æ€ï¼ˆæ¥è‡ªformDataï¼‰
                    const currentSubItemStates = {};
                    const currentPanelEnabled = currentConfig.enabled; // ä¿ç•™é¢æ¿çš„enabledçŠ¶æ€

                    if (currentConfig && typeof currentConfig === 'object') {
                        Object.keys(currentConfig).forEach(key => {
                            if (key !== 'enabled' && typeof currentConfig[key] === 'object' &&
                                currentConfig[key] && typeof currentConfig[key].enabled === 'boolean') {
                                currentSubItemStates[key] = currentConfig[key];
                            }
                        });
                    }

                    // æ¢å¤åŸºç¡€é¢æ¿å±æ€§é…ç½®
                    extensionSettings['Information bar integration tool'][panelId] = { ...preservedConfig };

                    // ğŸ”§ ä¿®å¤ï¼šé‡æ–°åº”ç”¨é¢æ¿çš„enabledçŠ¶æ€
                    if (typeof currentPanelEnabled === 'boolean') {
                        extensionSettings['Information bar integration tool'][panelId].enabled = currentPanelEnabled;
                    }

                    // é‡æ–°åº”ç”¨å­é¡¹å¯ç”¨çŠ¶æ€
                    Object.keys(currentSubItemStates).forEach(subItemKey => {
                        const existingSubItem = extensionSettings['Information bar integration tool'][panelId][subItemKey];
                        if (!existingSubItem || typeof existingSubItem !== 'object' || Array.isArray(existingSubItem)) {
                            extensionSettings['Information bar integration tool'][panelId][subItemKey] = {};
                        }
                        extensionSettings['Information bar integration tool'][panelId][subItemKey].enabled = currentSubItemStates[subItemKey].enabled;
                    });

                    console.log(`[InfoBarSettings] ğŸ”„ æ™ºèƒ½æ¢å¤åŸºç¡€é¢æ¿ ${panelId} çš„å±æ€§é…ç½®ï¼Œä¿ç•™é¢æ¿å¯ç”¨çŠ¶æ€: ${currentPanelEnabled}ï¼Œä¿ç•™ ${Object.keys(currentSubItemStates).length} ä¸ªå­é¡¹çŠ¶æ€`);
                } else {
                    // å¦‚æœæ²¡æœ‰å½“å‰é…ç½®ï¼Œç›´æ¥æ¢å¤æ—§é…ç½®
                    extensionSettings['Information bar integration tool'][panelId] = preservedBasicPanelConfigs[panelId];
                    console.log(`[InfoBarSettings] ğŸ”„ å®Œå…¨æ¢å¤åŸºç¡€é¢æ¿ ${panelId} çš„å±æ€§é…ç½®`);
                }
            });

            // è§¦å‘ SillyTavern ä¿å­˜è®¾ç½®
            context.saveSettingsDebounced();

            // ğŸ”§ ä¿®å¤ï¼šåœ¨éšè—ç•Œé¢å‰å…ˆåˆ·æ–°é¢æ¿å†…å®¹ï¼Œç¡®ä¿æ–°å¢å­é¡¹ç«‹å³æ˜¾ç¤º
            this.refreshAllBasicPanelContent();

            // è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°
            if (this.eventSystem) {
                this.eventSystem.emit('panel:config:changed', {
                    timestamp: Date.now(),
                    formData: formData
                });
                console.log('[InfoBarSettings] ğŸ“‹ å·²è§¦å‘é¢æ¿é…ç½®å˜æ›´äº‹ä»¶');
            }

            // å¦‚æœAPIé…ç½®æœ‰å˜åŒ–ï¼Œæ›´æ–°APIé›†æˆ
            if (this.hasAPIConfigChanged(formData)) {
                await this.apiIntegration.updateConfig(formData.apiConfig || {});
            }

            // æ ‡è®°éœ€è¦åˆ·æ–°è®¾ç½®
            this.needsSettingsRefresh = true;

            // ç«‹å³éšè—ç•Œé¢
            this.hide();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            this.showMessage('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');

            // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å¯ç”¨æ—¶æ‰æ£€æŸ¥å¹¶é‡æ–°åŒ…è£…AIæ¶ˆæ¯
            setTimeout(() => {
                // æ£€æŸ¥å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½æ˜¯å¦å¯ç”¨
                const configManager = window.SillyTavernInfobar?.modules?.configManager;
                if (configManager) {
                    const frontendConfig = configManager.getFrontendDisplayConfig();
                    if (frontendConfig && frontendConfig.enabled) {
                        console.log('[InfoBarSettings] ğŸ”„ å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å·²å¯ç”¨ï¼Œæ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…çŠ¶æ€');
                        this.ensureAIMessagesWrapped();
                    } else {
                        console.log('[InfoBarSettings] â¹ï¸ å‰ç«¯æ˜¾ç¤ºåŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡AIæ¶ˆæ¯åŒ…è£…æ£€æŸ¥');
                    }
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é…ç½®ç®¡ç†å™¨ï¼Œè·³è¿‡AIæ¶ˆæ¯åŒ…è£…æ£€æŸ¥');
                }
            }, 500);

            console.log('[InfoBarSettings] âœ… è®¾ç½®ä¿å­˜å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜è®¾ç½®å¤±è´¥:', error);
            this.showMessage('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            this.handleError(error);
        }
    }

    /**
     * æ”¶é›†è¡¨å•æ•°æ®
     */
    collectFormData() {
        const formData = {};

        // è·å–æ‰€æœ‰è¡¨å•å…ƒç´ 
        const elements = this.modal.querySelectorAll('input, select, textarea');

        elements.forEach(element => {
            const name = element.name;
            if (!name) return;

            let value;
            if (element.type === 'checkbox') {
                value = element.checked;
            } else if (element.type === 'radio') {
                // ä»…é‡‡é›†è¢«é€‰ä¸­çš„å•é€‰é¡¹ï¼Œé¿å…æœªé€‰é¡¹è¦†ç›–
                if (!element.checked) return;
                value = element.value;
            } else if (element.type === 'number' || element.type === 'range') {
                value = parseFloat(element.value) || 0;
            } else {
                value = element.value;
            }

            // å¤„ç†åµŒå¥—å±æ€§
            if (name.includes('.')) {
                this.setNestedProperty(formData, name, value);
            } else {
                formData[name] = value;
            }
        });

        // æ”¶é›†å½“å‰é€‰ä¸­çš„ä¸»é¢˜
        const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
        if (activeThemeCard) {
            const themeId = activeThemeCard.getAttribute('data-theme');
            if (themeId) {
                formData.theme = {
                    current: themeId,
                    lastUpdated: new Date().toISOString()
                };
                console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°ä¸»é¢˜æ•°æ®:', themeId);
            }
        }

        // æ”¶é›†å½“å‰é€‰ä¸­çš„é£æ ¼
        const activeStyleCard = this.modal.querySelector('.style-preview-card.active');
        if (activeStyleCard) {
            const styleId = activeStyleCard.getAttribute('data-style');
            if (styleId) {
                formData.style = {
                    current: styleId,
                    lastUpdated: new Date().toISOString()
                };
                console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°é£æ ¼æ•°æ®:', styleId);
            }
        }

        // å¤„ç†åŸºç¡€é¢æ¿é…ç½®ï¼Œè½¬æ¢ä¸ºDataTableæœŸæœ›çš„æ ¼å¼
        this.processBasicPanelsConfig(formData);

        console.log('[InfoBarSettings] ğŸ“Š è¡¨å•æ•°æ®æ”¶é›†å®Œæˆï¼ŒåŒ…å«', Object.keys(formData).length, 'ä¸ªé…ç½®é¡¹');
        return formData;
    }

    /**
     * æ”¶é›†è®°å¿†å¢å¼ºé¢æ¿çš„è®¾ç½®ï¼ˆä½¿ç”¨å…ƒç´ IDï¼‰
     */
    collectMemoryEnhancementFormData() {
        try {
            const getBool = (id) => !!this.modal.querySelector(`#${id}`)?.checked;
            const getNum = (id) => {
                const el = this.modal.querySelector(`#${id}`);
                if (!el) return undefined;
                const v = el.type === 'number' ? parseInt(el.value, 10) : parseFloat(el.value);
                return isNaN(v) ? undefined : v;
            };
            const getVal = (id) => this.modal.querySelector(`#${id}`)?.value;

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿AIè®°å¿†æ€»ç»“è®¾ç½®ä¸åç«¯æ¨¡å—åŒæ­¥
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            const aiMemorySummarizer = summaryManager?.aiMemorySummarizer;

            // ä¼˜å…ˆä½¿ç”¨åç«¯æ¨¡å—çš„å½“å‰è®¾ç½®ï¼Œç¡®ä¿ä¸å®é™…çŠ¶æ€åŒæ­¥
            const aiSettings = aiMemorySummarizer?.settings || {};

            const data = {
                ai: {
                    enabled: aiSettings.enabled !== undefined ? aiSettings.enabled : getBool('memory-ai-memory-enabled'),
                    messageLevelSummary: aiSettings.messageLevelSummary !== undefined ? aiSettings.messageLevelSummary : getBool('memory-ai-message-level-summary'),
                    importanceThreshold: aiSettings.importanceThreshold !== undefined ? aiSettings.importanceThreshold : getNum('memory-ai-importance-threshold')
                },
                vector: {
                    enabled: getBool('memory-vectorized-memory-enabled'),
                    vectorEngine: getVal('memory-vector-engine'),
                    similarityThreshold: getNum('memory-similarity-threshold'),
                    maxResults: getNum('memory-max-search-results')
                },
                deep: {
                    enabled: getBool('memory-deep-memory-enabled'),
                    autoMemoryMigration: getBool('memory-auto-memory-migration'),
                    memoryImportanceThreshold: getNum('memory-memory-importance-threshold'),
                    conflictResolution: getBool('memory-memory-conflict-resolution'),
                    capacities: {
                        sensory: getNum('memory-sensory-capacity'),
                        shortTerm: getNum('memory-short-term-capacity'),
                        longTerm: getNum('memory-long-term-capacity'),
                        deepArchive: getNum('memory-deep-archive-capacity')
                    }
                },
                classifier: {
                    enabled: getBool('memory-intelligent-classifier-enabled'),
                    semanticClustering: getBool('memory-semantic-clustering'),
                    temporalPatternRecognition: getBool('memory-temporal-pattern-recognition'),
                    importancePrediction: getBool('memory-importance-prediction'),
                    classificationConfidenceThreshold: getNum('memory-classification-confidence-threshold'),
                    adaptiveLearning: getBool('memory-adaptive-learning')
                }
            };

            return data;
        } catch (err) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†è®°å¿†å¢å¼ºè¡¨å•å¤±è´¥:', err);
            return undefined;
        }
    }


    /**
     * åŠ è½½è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€åˆ°è¡¨å•
     */
    loadCustomPanelSubItemStates(customPanels) {
        try {
            // éå†æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿
            for (const [panelId, panel] of Object.entries(customPanels)) {
                if (panel.subItems && Array.isArray(panel.subItems)) {
                    // è®¾ç½®æ¯ä¸ªå­é¡¹çš„å‹¾é€‰çŠ¶æ€
                    panel.subItems.forEach(subItem => {
                        const fieldName = subItem.name || subItem.key || subItem.id;
                        const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);
                        if (checkbox && checkbox.type === 'checkbox') {
                            checkbox.checked = subItem.enabled !== false;
                            console.log(`[InfoBarSettings] ğŸ“Š è®¾ç½®å­é¡¹å‹¾é€‰çŠ¶æ€: ${fieldName} = ${checkbox.checked}`);
                        }
                    });
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½åŸºç¡€é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€åˆ°è¡¨å•
     */
    loadBasicPanelSubItemStates(configs) {
        try {
            const basicPanelIds = ['personal', 'interaction', 'tasks', 'world', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];

            // éå†æ‰€æœ‰åŸºç¡€é¢æ¿
            basicPanelIds.forEach(panelId => {
                const panelConfig = configs[panelId];
                if (panelConfig && typeof panelConfig === 'object') {
                    console.log(`[InfoBarSettings] ğŸ“Š åŠ è½½åŸºç¡€é¢æ¿ ${panelId} çš„å­é¡¹çŠ¶æ€`);

                    // éå†é¢æ¿çš„æ‰€æœ‰å­é¡¹
                    Object.keys(panelConfig).forEach(subItemKey => {
                        if (subItemKey !== 'enabled' && typeof panelConfig[subItemKey] === 'object' &&
                            panelConfig[subItemKey] && typeof panelConfig[subItemKey].enabled === 'boolean') {

                            const fieldName = `${panelId}.${subItemKey}.enabled`;
                            const checkbox = this.modal.querySelector(`input[name="${fieldName}"]`);

                            if (checkbox && checkbox.type === 'checkbox') {
                                checkbox.checked = panelConfig[subItemKey].enabled;
                                console.log(`[InfoBarSettings] ğŸ“Š è®¾ç½®åŸºç¡€é¢æ¿å­é¡¹å‹¾é€‰çŠ¶æ€: ${fieldName} = ${checkbox.checked}`);
                            }
                        }
                    });
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½åŸºç¡€é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çš„å‹¾é€‰çŠ¶æ€
     */
    updateCustomPanelSubItemStates(customPanels, formData) {
        try {
            // éå†æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿
            for (const [panelId, panel] of Object.entries(customPanels)) {
                if (panel.subItems && Array.isArray(panel.subItems)) {
                    // æ›´æ–°æ¯ä¸ªå­é¡¹çš„enabledçŠ¶æ€
                    panel.subItems.forEach(subItem => {
                        // ä½¿ç”¨å­é¡¹çš„nameä½œä¸ºå­—æ®µåæŸ¥æ‰¾å‹¾é€‰çŠ¶æ€
                        const fieldName = subItem.name || subItem.key || subItem.id;
                        if (formData.hasOwnProperty(fieldName)) {
                            subItem.enabled = formData[fieldName];
                            console.log(`[InfoBarSettings] ğŸ“Š æ›´æ–°å­é¡¹çŠ¶æ€: ${fieldName} = ${subItem.enabled}`);
                        }
                    });
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰é¢æ¿å­é¡¹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†åŸºç¡€é¢æ¿é…ç½®ï¼Œè½¬æ¢ä¸ºDataTableæœŸæœ›çš„æ ¼å¼
     */
    processBasicPanelsConfig(formData) {
        try {
            // åˆå§‹åŒ–basicPanelså¯¹è±¡
            if (!formData.basicPanels) {
                formData.basicPanels = {};
            }

            // å®šä¹‰æ‰€æœ‰åŸºç¡€é¢æ¿IDåˆ—è¡¨
            const basicPanelIds = ['personal', 'world', 'interaction', 'tasks', 'organization', 'news', 'inventory', 'abilities', 'plot', 'cultivation', 'fantasy', 'modern', 'historical', 'magic', 'training'];

            // å¾ªç¯å¤„ç†æ‰€æœ‰åŸºç¡€é¢æ¿
            basicPanelIds.forEach(panelId => {
                if (formData[panelId]) {
                    formData.basicPanels[panelId] = {
                        enabled: formData[panelId].enabled !== false,
                        subItems: []
                    };

                    // è½¬æ¢å­é¡¹é…ç½®
                    Object.keys(formData[panelId]).forEach(key => {
                        if (key !== 'enabled' && typeof formData[panelId][key] === 'object' && formData[panelId][key].enabled !== undefined) {
                            formData.basicPanels[panelId].subItems.push({
                                name: this.getSubItemDisplayName(panelId, key),
                                key: key,
                                enabled: formData[panelId][key].enabled,
                                value: this.getDefaultSubItemValue(panelId, key)
                            });
                        }
                    });

                    console.log(`[InfoBarSettings] ğŸ“Š å¤„ç†${panelId}é¢æ¿é…ç½®:`, formData.basicPanels[panelId].subItems.length, 'ä¸ªå­é¡¹');
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†åŸºç¡€é¢æ¿é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å­é¡¹æ˜¾ç¤ºåç§°
     */
    getSubItemDisplayName(panelType, key) {
        const displayNames = {
            personal: {
                name: 'å§“å', age: 'å¹´é¾„', gender: 'æ€§åˆ«', occupation: 'èŒä¸š',
                personality: 'æ€§æ ¼', hobbies: 'çˆ±å¥½', height: 'èº«é«˜', weight: 'ä½“é‡',
                bloodType: 'è¡€å‹', birthplace: 'å‡ºç”Ÿåœ°', nationality: 'å›½ç±',
                religion: 'å®—æ•™ä¿¡ä»°', politicalViews: 'æ”¿æ²»è§‚ç‚¹', values: 'ä»·å€¼è§‚',
                goals: 'äººç”Ÿç›®æ ‡', fears: 'ææƒ§', strengths: 'ä¼˜ç‚¹', weaknesses: 'ç¼ºç‚¹',
                mentalHealth: 'å¿ƒç†å¥åº·', physicalHealth: 'èº«ä½“å¥åº·', appearance: 'å¤–è²Œ',
                clothing: 'ç©¿ç€é£æ ¼', accessories: 'é…é¥°', tattoos: 'çº¹èº«',
                scars: 'ç–¤ç—•', voice: 'å£°éŸ³', mannerisms: 'ä¹ æƒ¯åŠ¨ä½œ',
                familyBackground: 'å®¶åº­èƒŒæ™¯', education: 'æ•™è‚²ç»å†', workExperience: 'å·¥ä½œç»å†',
                income: 'æ”¶å…¥', socialStatus: 'ç¤¾ä¼šåœ°ä½', relationships: 'äººé™…å…³ç³»',
                loveStatus: 'æ‹çˆ±çŠ¶æ€', maritalStatus: 'å©šå§»çŠ¶æ€', sports: 'è¿åŠ¨',
                music: 'éŸ³ä¹', art: 'è‰ºæœ¯', reading: 'é˜…è¯»', gaming: 'æ¸¸æˆ',
                travel: 'æ—…è¡Œ', cooking: 'çƒ¹é¥ª', skills: 'æŠ€èƒ½ç‰¹é•¿',
                languages: 'è¯­è¨€èƒ½åŠ›', habits: 'ç”Ÿæ´»ä¹ æƒ¯', healthStatus: 'å¥åº·çŠ¶æ€'
            },
            world: {
                name: 'ä¸–ç•Œåç§°', type: 'ä¸–ç•Œç±»å‹', genre: 'ä¸–ç•Œé£æ ¼',
                description: 'ä¸–ç•Œæè¿°', geography: 'åœ°ç†ç¯å¢ƒ', locations: 'é‡è¦åœ°ç‚¹',
                time: 'æ—¶é—´è®¾å®š'
            },
            interaction: {
                name: 'å¯¹è±¡åç§°', type: 'å¯¹è±¡ç±»å‹', status: 'å½“å‰çŠ¶æ€',
                location: 'æ‰€åœ¨ä½ç½®', activity: 'å½“å‰æ´»åŠ¨', relationship: 'å…³ç³»ç±»å‹',
                intimacy: 'äº²å¯†åº¦', history: 'å†å²è®°å½•', autoRecord: 'è‡ªåŠ¨è®°å½•'
            },
            tasks: {
                title: 'ä»»åŠ¡æ ‡é¢˜', description: 'ä»»åŠ¡æè¿°', priority: 'ä¼˜å…ˆçº§',
                status: 'ä»»åŠ¡çŠ¶æ€', deadline: 'æˆªæ­¢æ—¥æœŸ', assignee: 'è´Ÿè´£äºº',
                progress: 'å®Œæˆè¿›åº¦', category: 'ä»»åŠ¡åˆ†ç±»'
            },
            organization: {
                name: 'ç»„ç»‡åç§°', type: 'ç»„ç»‡ç±»å‹', leader: 'é¢†å¯¼è€…',
                members: 'æˆå‘˜æ•°é‡', purpose: 'ç»„ç»‡ç›®æ ‡', location: 'æ€»éƒ¨ä½ç½®',
                influence: 'å½±å“åŠ›', resources: 'èµ„æºçŠ¶å†µ'
            },
            news: {
                title: 'æ–°é—»æ ‡é¢˜', content: 'æ–°é—»å†…å®¹', source: 'æ¶ˆæ¯æ¥æº',
                date: 'å‘å¸ƒæ—¥æœŸ', importance: 'é‡è¦ç¨‹åº¦', category: 'æ–°é—»åˆ†ç±»',
                impact: 'å½±å“èŒƒå›´'
            },
            inventory: {
                name: 'ç‰©å“åç§°', type: 'ç‰©å“ç±»å‹', quantity: 'æ•°é‡',
                condition: 'ç‰©å“çŠ¶æ€', value: 'ä»·å€¼', location: 'å­˜æ”¾ä½ç½®',
                description: 'ç‰©å“æè¿°'
            },
            abilities: {
                name: 'èƒ½åŠ›åç§°', type: 'èƒ½åŠ›ç±»å‹', level: 'èƒ½åŠ›ç­‰çº§',
                description: 'èƒ½åŠ›æè¿°', cooldown: 'å†·å´æ—¶é—´', cost: 'æ¶ˆè€—',
                effect: 'æ•ˆæœæè¿°'
            },
            plot: {
                title: 'å‰§æƒ…æ ‡é¢˜', description: 'å‰§æƒ…æè¿°', stage: 'å½“å‰é˜¶æ®µ',
                characters: 'ç›¸å…³è§’è‰²', location: 'å‘ç”Ÿåœ°ç‚¹', importance: 'é‡è¦ç¨‹åº¦',
                outcome: 'ç»“æœå½±å“'
            },
            cultivation: {
                realm: 'ä¿®ç‚¼å¢ƒç•Œ', technique: 'ä¿®ç‚¼åŠŸæ³•', progress: 'ä¿®ç‚¼è¿›åº¦',
                qi: 'çµæ°”å€¼', foundation: 'æ ¹åŸº', breakthrough: 'çªç ´æ¡ä»¶',
                resources: 'ä¿®ç‚¼èµ„æº'
            },
            fantasy: {
                race: 'ç§æ—', class: 'èŒä¸š', level: 'ç­‰çº§',
                hp: 'ç”Ÿå‘½å€¼', mp: 'é­”æ³•å€¼', strength: 'åŠ›é‡',
                agility: 'æ•æ·', intelligence: 'æ™ºåŠ›', equipment: 'è£…å¤‡'
            },
            modern: {
                job: 'å·¥ä½œ', income: 'æ”¶å…¥', education: 'å­¦å†',
                skills: 'æŠ€èƒ½', social: 'ç¤¾äº¤åœˆ', lifestyle: 'ç”Ÿæ´»æ–¹å¼',
                goals: 'äººç”Ÿç›®æ ‡'
            },
            historical: {
                era: 'å†å²æ—¶æœŸ', position: 'ç¤¾ä¼šåœ°ä½', family: 'å®¶æ—èƒŒæ™¯',
                achievements: 'æˆå°±', reputation: 'å£°æœ›', allies: 'ç›Ÿå‹',
                enemies: 'æ•Œäºº'
            },
            magic: {
                school: 'é­”æ³•å­¦æ´¾', spells: 'æ³•æœ¯åˆ—è¡¨', mana: 'é­”åŠ›å€¼',
                focus: 'æ–½æ³•ç„¦ç‚¹', components: 'æ³•æœ¯ææ–™', familiar: 'é­”å® ',
                research: 'ç ”ç©¶é¡¹ç›®'
            },
            training: {
                skill: 'è®­ç»ƒæŠ€èƒ½', instructor: 'æŒ‡å¯¼è€…', progress: 'è®­ç»ƒè¿›åº¦',
                schedule: 'è®­ç»ƒè®¡åˆ’', equipment: 'è®­ç»ƒå™¨æ', goals: 'è®­ç»ƒç›®æ ‡',
                achievements: 'è®­ç»ƒæˆæœ'
            }
        };

        return displayNames[panelType]?.[key] || key;
    }

    /**
     * è·å–å­é¡¹é»˜è®¤å€¼
     */
    getDefaultSubItemValue(panelType, key) {
        const defaultValues = {
            personal: {
                name: 'æ—å¤©', age: '25', gender: 'ç”·', occupation: 'è½¯ä»¶å·¥ç¨‹å¸ˆ',
                personality: 'å¼€æœ—ã€å‹å–„', hobbies: 'ç¼–ç¨‹ã€é˜…è¯»ã€éŸ³ä¹', height: '175cm',
                weight: '70kg', bloodType: 'Oå‹'
            },
            world: {
                name: 'ç°ä»£éƒ½å¸‚', type: 'ç°å®ä¸–ç•Œ', genre: 'éƒ½å¸‚ç”Ÿæ´»',
                description: 'ç¹åçš„ç°ä»£éƒ½å¸‚ç¯å¢ƒ', geography: 'æ²¿æµ·åŸå¸‚', locations: 'å¸‚ä¸­å¿ƒã€å•†ä¸šåŒº',
                time: '2024å¹´ç°ä»£'
            },
            interaction: {
                name: 'å°é›…', type: 'æœ‹å‹', status: 'åœ¨çº¿',
                location: 'å’–å•¡å…', activity: 'èŠå¤©', relationship: 'å¥½å‹',
                intimacy: 'å‹å¥½', history: 'è®¤è¯†3å¹´', autoRecord: 'å¼€å¯'
            }
        };

        return defaultValues[panelType]?.[key] || '';
    }

    /**
     * è®¾ç½®åµŒå¥—å±æ€§
     */
    setNestedProperty(obj, path, value) {
        const keys = path.split('.');
        let current = obj;

        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) {
                current[keys[i]] = {};
            }
            current = current[keys[i]];
        }

        current[keys[keys.length - 1]] = value;
    }

    /**
     * ğŸ†• æ›´æ–°ç ´ç”²æç¤ºè¯ç»Ÿè®¡ä¿¡æ¯
     */
    updateArmorBreakingStats() {
        try {
            const textarea = this.modal.querySelector('#armor-breaking-prompt');
            const charCountSpan = this.modal.querySelector('#armor-breaking-char-count');
            const wordCountSpan = this.modal.querySelector('#armor-breaking-word-count');

            if (!textarea || !charCountSpan || !wordCountSpan) return;

            const text = textarea.value || '';
            const charCount = text.length;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;

            charCountSpan.textContent = charCount;
            wordCountSpan.textContent = wordCount;

            // æ ¹æ®å­—ç¬¦æ•°é‡è®¾ç½®é¢œè‰²æç¤º
            if (charCount > 1000) {
                charCountSpan.style.color = '#ff6b6b'; // çº¢è‰²è­¦å‘Š
            } else if (charCount > 500) {
                charCountSpan.style.color = '#ffa726'; // æ©™è‰²æé†’
            } else {
                charCountSpan.style.color = ''; // é»˜è®¤é¢œè‰²
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ç ´ç”²æç¤ºè¯ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    /**
     * æ£€æŸ¥APIé…ç½®æ˜¯å¦æœ‰å˜åŒ–
     */
    hasAPIConfigChanged(formData) {
        return Object.keys(formData).some(key => key.startsWith('apiConfig.'));
    }

    /**
     * æµ‹è¯•APIè¿æ¥
     */
    async testAPIConnection() {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹æµ‹è¯•APIè¿æ¥...');

            // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
            this.updateConnectionStatus('testing', 'æµ‹è¯•ä¸­...');

            const result = await this.apiIntegration.testConnection();

            if (result.success) {
                this.updateConnectionStatus('success', 'è¿æ¥æˆåŠŸ');
                this.showMessage('APIè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
            } else {
                this.updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
                this.showMessage('APIè¿æ¥æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æµ‹è¯•APIè¿æ¥å¤±è´¥:', error);
            this.updateConnectionStatus('error', 'æµ‹è¯•å¼‚å¸¸');
            this.showMessage('APIè¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error.message, 'error');
        }
    }

    /**
     * åŠ è½½APIæ¨¡å‹
     */
    async loadAPIModels() {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ å¼€å§‹åŠ è½½APIæ¨¡å‹...');

            const models = await this.apiIntegration.loadModels();
            const modelSelect = this.modal.querySelector('[name="apiConfig.model"]');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';

            // æ·»åŠ æ¨¡å‹é€‰é¡¹
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                option.title = model.description;
                modelSelect.appendChild(option);
            });

            this.showMessage(`æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½APIæ¨¡å‹å¤±è´¥:', error);
            this.showMessage('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
     */
    updateConnectionStatus(status, message) {
        const statusElement = this.modal.querySelector('[data-status="connection"]');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `status-value status-${status}`;
        }
    }

    /**
     * æ›´æ–°APIçŠ¶æ€
     */
    updateAPIStatus() {
        if (!this.apiIntegration) return;

        const stats = this.apiIntegration.getStats();
        const statsElement = this.modal.querySelector('[data-status="stats"]');

        if (statsElement) {
            statsElement.textContent = `${stats.success}/${stats.total} (${stats.successRate})`;
        }
    }
    /**
     * æ˜¾ç¤ºé¡¶éƒ¨æç¤ºæ¶ˆæ¯
     */
    showMessage(message, type = 'info') {
        try {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºé¡¶éƒ¨æç¤º
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;

            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            let bgColor = 'var(--theme-bg-secondary, #2d3748)';
            let borderColor = 'var(--theme-border-color, #4a5568)';
            let textColor = 'var(--theme-text-primary, #ffffff)';
            let icon = 'â„¹ï¸';

            if (type === 'success') {
                bgColor = 'var(--theme-primary-color, #4299e1)';
                borderColor = 'var(--theme-primary-color, #4299e1)';
                textColor = '#ffffff';
                icon = 'âœ…';
            } else if (type === 'error') {
                bgColor = '#f56565';
                borderColor = '#f56565';
                textColor = '#ffffff';
                icon = 'âŒ';
            } else if (type === 'warning') {
                bgColor = '#ed8936';
                borderColor = '#ed8936';
                textColor = '#ffffff';
                icon = 'âš ï¸';
            }

            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(-100%);
                background: ${bgColor};
                color: ${textColor};
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                font-weight: 500;
                min-width: 200px;
                max-width: 400px;
                transition: transform 0.3s ease;
                border: 1px solid ${borderColor};
            `;

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-text">${message}</span>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // è§¦å‘è¿›å…¥åŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.transform = 'translateX(-50%) translateY(-100%)';
                    setTimeout(() => {
                        if (toast && toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 3000);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥:', error);
            // é™çº§åˆ°æµè§ˆå™¨åŸç”Ÿæç¤º
            alert(message);
        }
    }

    /**
     * åˆå§‹åŒ–æ’ä»¶ - æ¢å¤åˆ°åˆšå®‰è£…çš„çŠ¶æ€
     * @param {boolean} skipConfirmation - æ˜¯å¦è·³è¿‡ç¡®è®¤å¯¹è¯æ¡†ï¼ˆç”¨äºç¨‹åºåŒ–è°ƒç”¨ï¼‰
     */
    async initializePlugin(skipConfirmation = false) {
        try {
            // åªæœ‰åœ¨éè·³è¿‡ç¡®è®¤æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (!skipConfirmation) {
                const confirmMessage = 'âš ï¸ å±é™©æ“ä½œç¡®è®¤\n\n' +
                    'æ­¤æ“ä½œå°†ï¼š\n' +
                    'â€¢ å®Œå…¨æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®å’ŒèŠå¤©è®°å½•ä¸­çš„é¢æ¿æ•°æ®\n' +
                    'â€¢ åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰é¢æ¿å’Œå­é¡¹\n' +
                    'â€¢ é‡ç½®æ‰€æœ‰é…ç½®åˆ°é»˜è®¤å€¼\n' +
                    'â€¢ æ¸…é™¤æ‰€æœ‰å­—æ®µè§„åˆ™å’Œé¢æ¿è§„åˆ™\n' +
                    'â€¢ æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å’Œæ‰©å±•è®¾ç½®\n' +
                    'â€¢ æ¸…é™¤æ‰€æœ‰localStorageæ•°æ®\n' +
                    'â€¢ è‡ªåŠ¨åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½æ’ä»¶\n\n' +
                    'æ’ä»¶å°†å®Œå…¨æ¢å¤åˆ°åˆšå®‰è£…æ—¶çš„çŠ¶æ€ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\n' +
                    'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';

                if (!confirm(confirmMessage)) {
                    return;
                }

                // äºŒæ¬¡ç¡®è®¤
                if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦å®Œå…¨åˆå§‹åŒ–æ’ä»¶å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ï¼')) {
                    return;
                }
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹å®Œå…¨åˆå§‹åŒ–æ’ä»¶...');

            // === ç¬¬1æ­¥ï¼šè·å–å¿…è¦çš„å¼•ç”¨ ===
            const configManager = this.configManager || window.SillyTavernInfobar?.modules?.configManager;
            const dataCore = configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore;
            const context = window.SillyTavern?.getContext?.();

            // === ç¬¬2æ­¥ï¼šæ¸…ç©ºæ•°æ®æ ¸å¿ƒçš„æ‰€æœ‰æ•°æ® ===
            if (dataCore) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®æ ¸å¿ƒæ‰€æœ‰æ•°æ®...');
                await dataCore.clearAllData('all');

                // æ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„
                if (dataCore.cache) dataCore.cache.clear();
                if (dataCore.data) dataCore.data.clear();
                if (dataCore.recentEntries) dataCore.recentEntries.length = 0;
                if (dataCore.chatDataCache) dataCore.chatDataCache.clear();
            }

            // === ç¬¬3æ­¥ï¼šæ¸…ç©ºé…ç½®ç®¡ç†å™¨æ‰€æœ‰æ•°æ® ===
            if (configManager) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºé…ç½®ç®¡ç†å™¨æ‰€æœ‰æ•°æ®...');
                if (configManager.configCache) configManager.configCache.clear();

                // è°ƒç”¨é…ç½®ç®¡ç†å™¨çš„æ¸…ç©ºæ–¹æ³•
                if (typeof configManager.clearAllData === 'function') {
                    await configManager.clearAllData();
                }
            }

            // === ç¬¬4æ­¥ï¼šå®Œå…¨æ¸…ç©º SillyTavern extensionSettings ===
            if (context && context.extensionSettings) {
                console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºSillyTavernæ‰©å±•è®¾ç½®...');

                let clearedConfigs = 0;

                // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„æ‰©å±•é…ç½®é”®åå˜ä½“
                const configKeysToDelete = [
                    'Information bar integration tool',
                    'information_bar_integration_tool',
                    'Information Integration Tool',
                    'advanced-infobar-system',
                    'infobar',
                    'InfoBar',
                    'information-bar',
                    'sillyTavernInfobar'
                ];

                configKeysToDelete.forEach(key => {
                    if (context.extensionSettings[key]) {
                        delete context.extensionSettings[key];
                        clearedConfigs++;
                        console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤æ‰©å±•é…ç½®: ${key}`);
                    }
                });

                // æ‰«ææ‰€æœ‰æ‰©å±•é…ç½®ï¼ŒæŸ¥æ‰¾å¯èƒ½é—æ¼çš„ä¿¡æ¯æ ç›¸å…³é…ç½®
                const allExtensionKeys = Object.keys(context.extensionSettings);
                const suspiciousKeys = allExtensionKeys.filter(key =>
                    key.toLowerCase().includes('infobar') ||
                    key.toLowerCase().includes('information') ||
                    key.toLowerCase().includes('bar') ||
                    key.toLowerCase().includes('integration')
                );

                suspiciousKeys.forEach(key => {
                    if (!configKeysToDelete.includes(key)) {
                        const config = context.extensionSettings[key];
                        if (config && typeof config === 'object') {
                            // æ£€æŸ¥é…ç½®å†…å®¹æ˜¯å¦åŒ…å«ä¿¡æ¯æ ç›¸å…³æ•°æ®
                            const configStr = JSON.stringify(config).toLowerCase();
                            if (configStr.includes('infobar') || configStr.includes('panel') || configStr.includes('field')) {
                                delete context.extensionSettings[key];
                                clearedConfigs++;
                                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤å¯ç–‘æ‰©å±•é…ç½®: ${key}`);
                            }
                        }
                    }
                });

                console.log(`[InfoBarSettings] ğŸ“Š æ€»å…±æ¸…ç†äº† ${clearedConfigs} ä¸ªæ‰©å±•é…ç½®`);

                // ä¿å­˜æ¸…ç©ºçš„è®¾ç½®
                if (typeof context.saveSettings === 'function') {
                    await context.saveSettings();
                }
            }

            // === ç¬¬5æ­¥ï¼šæ¸…ç©ºlocalStorageä¸­çš„æ‰€æœ‰ç›¸å…³æ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç©ºlocalStorageç›¸å…³æ•°æ®...');
            const keysToRemove = [];

            // å¢å¼ºçš„æ¨¡å¼åŒ¹é…åˆ—è¡¨
            const patterns = [
                'Information bar integration tool',
                'information_bar_integration_tool',
                'Information_bar_integration_tool',
                'infobar',
                'InfoBar',
                'SillyTavernInfobar',
                'information',
                'panel',
                'field',
                'integration',
                'backup_'
            ];

            // æ‰«ææ‰€æœ‰localStorageé”®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    const keyLower = key.toLowerCase();

                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ¨¡å¼
                    const shouldRemove = patterns.some(pattern => {
                        const patternLower = pattern.toLowerCase();
                        return keyLower.includes(patternLower);
                    });

                    if (shouldRemove) {
                        keysToRemove.push(key);
                    }
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š æ‰¾åˆ° ${keysToRemove.length} ä¸ªè¦åˆ é™¤çš„localStorageé”®`);

            // åˆ é™¤æ‰¾åˆ°çš„æ‰€æœ‰ç›¸å…³é”®
            keysToRemove.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    localStorage.removeItem(key);
                    console.log(`[InfoBarSettings] ğŸ—‘ï¸ å·²åˆ é™¤localStorageé”®: ${key} (å€¼é•¿åº¦: ${value ? value.length : 0})`);
                } catch (e) {
                    console.warn(`[InfoBarSettings] âš ï¸ åˆ é™¤localStorageé”®å¤±è´¥: ${key}`, e);
                }
            });

            // === ç¬¬6æ­¥ï¼šé‡ç½®å…¨å±€å˜é‡å’Œæ¨¡å—çŠ¶æ€ ===
            console.log('[InfoBarSettings] ğŸ”„ é‡ç½®å…¨å±€å˜é‡å’Œæ¨¡å—çŠ¶æ€...');

            let destroyedModules = 0;
            let clearedGlobals = 0;

            // æ¸…ç†å…¨å±€å¯¹è±¡
            if (window.SillyTavernInfobar) {
                console.log('[InfoBarSettings] ğŸ” å‘ç° window.SillyTavernInfobarï¼Œå¼€å§‹æ·±åº¦æ¸…ç†...');

                // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨å’Œæ¸…ç†æ¨¡å—çŠ¶æ€
                if (window.SillyTavernInfobar.modules) {
                    const moduleNames = Object.keys(window.SillyTavernInfobar.modules);
                    console.log('[InfoBarSettings] ğŸ“Š å‘ç°æ¨¡å—:', moduleNames);

                    Object.entries(window.SillyTavernInfobar.modules).forEach(([name, module]) => {
                        try {
                            if (module) {
                                // æ¸…ç†æ¨¡å—å†…éƒ¨çŠ¶æ€
                                if (module.eventSystem && typeof module.eventSystem.removeAllListeners === 'function') {
                                    module.eventSystem.removeAllListeners();
                                }

                                // æ¸…ç†å®šæ—¶å™¨
                                if (module.syncTimer) {
                                    clearInterval(module.syncTimer);
                                    module.syncTimer = null;
                                }
                                if (module.backupTimer) {
                                    clearInterval(module.backupTimer);
                                    module.backupTimer = null;
                                }

                                // æ¸…ç†ç¼“å­˜
                                if (module.cache && typeof module.cache.clear === 'function') {
                                    module.cache.clear();
                                }

                                // è°ƒç”¨æ¨¡å—é”€æ¯æ–¹æ³•
                                if (typeof module.destroy === 'function') {
                                    module.destroy();
                                }

                                destroyedModules++;
                                console.log(`[InfoBarSettings] âœ… æ¨¡å— ${name} å·²é”€æ¯`);
                            }
                        } catch (e) {
                            console.warn(`[InfoBarSettings] âš ï¸ æ¨¡å— ${name} é”€æ¯å¤±è´¥:`, e);
                        }
                    });
                }

                // æ¸…ç†äº‹ä»¶ç³»ç»Ÿ
                if (window.SillyTavernInfobar.eventSource) {
                    try {
                        window.SillyTavernInfobar.eventSource.removeAllListeners?.();
                        delete window.SillyTavernInfobar.eventSource;
                        console.log('[InfoBarSettings] âœ… äº‹ä»¶ç³»ç»Ÿå·²æ¸…ç†');
                    } catch (e) {
                        console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†äº‹ä»¶ç³»ç»Ÿå¤±è´¥:', e);
                    }
                }

                // å®Œå…¨æ¸…ç©ºå…¨å±€å¯¹è±¡
                delete window.SillyTavernInfobar;
                clearedGlobals++;
                console.log('[InfoBarSettings] âœ… window.SillyTavernInfobar å·²å®Œå…¨åˆ é™¤');
            }

            // æ¸…ç†å…¶ä»–å¯èƒ½çš„å…¨å±€å¼•ç”¨
            const globalReferencesToClear = [
                'InfoBarData',
                'informationBarTool',
                'infoBarTool',
                'InfoBarTool',
                'SillyTavernInfoBarData',
                'InfoBarIntegrationTool'
            ];

            globalReferencesToClear.forEach(refName => {
                if (window[refName]) {
                    delete window[refName];
                    clearedGlobals++;
                    console.log(`[InfoBarSettings] âœ… å·²æ¸…ç†å…¨å±€å¼•ç”¨: window.${refName}`);
                }
            });

            console.log(`[InfoBarSettings] ğŸ“Š å…¨å±€æ¸…ç†ç»Ÿè®¡: é”€æ¯æ¨¡å— ${destroyedModules} ä¸ªï¼Œæ¸…ç†å…¨å±€å¼•ç”¨ ${clearedGlobals} ä¸ª`);

            // === ç¬¬7æ­¥ï¼šæ¸…ç†chatMetadataä¸­çš„æ®‹ç•™æ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†chatMetadataä¸­çš„æ®‹ç•™æ•°æ®...');
            await this.clearChatMetadataInfobarData();

            // === ç¬¬8æ­¥ï¼šæ¸…ç†STScriptå˜é‡ç³»ç»Ÿæ•°æ® ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†STScriptå˜é‡ç³»ç»Ÿæ•°æ®...');
            await this.clearSTScriptVariables();

            // === ç¬¬9æ­¥ï¼šæ¸…ç†äº‹ä»¶ç›‘å¬å™¨ ===
            console.log('[InfoBarSettings] ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨...');

            // ç§»é™¤DOMäº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('input', this.handleInput);
            document.removeEventListener('change', this.handleChange);
            document.removeEventListener('click', this.handleClick);

            // === ç¬¬10æ­¥ï¼šå…³é—­è®¾ç½®çª—å£ ===
            if (this.modal) {
                this.modal.style.display = 'none';
            }

            console.log('[InfoBarSettings] âœ… æ’ä»¶å®Œå…¨åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡åˆ·æ–°é¡µé¢...');

            // === ç¬¬11æ­¥ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è‡ªåŠ¨åˆ·æ–°é¡µé¢ ===
            const successMessage = 'âœ… æ’ä»¶å·²å®Œå…¨åˆå§‹åŒ–åˆ°åˆšå®‰è£…çš„çŠ¶æ€ï¼\n\né¡µé¢å°†åœ¨3ç§’åè‡ªåŠ¨åˆ·æ–°ä»¥é‡æ–°åŠ è½½æ’ä»¶...';

            // ä½¿ç”¨åŸç”Ÿalertç¡®ä¿æ¶ˆæ¯æ˜¾ç¤º
            alert(successMessage);

            // å»¶è¿Ÿåˆ·æ–°ç»™ç”¨æˆ·æ—¶é—´çœ‹åˆ°æ¶ˆæ¯
            setTimeout(() => {
                console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨åˆ·æ–°é¡µé¢...');
                window.location.reload();
            }, 3000);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–æ’ä»¶å¤±è´¥:', error);

            // ç¡®ä¿é”™è¯¯æ¶ˆæ¯èƒ½æ˜¾ç¤º
            const errorMessage = 'âŒ æ’ä»¶åˆå§‹åŒ–å¤±è´¥: ' + error.message + '\n\nå»ºè®®æ‰‹åŠ¨åˆ·æ–°é¡µé¢åé‡è¯•ã€‚';
            alert(errorMessage);
        }
    }

    /**
     * æ¸…ç†chatMetadataä¸­çš„ä¿¡æ¯æ æ•°æ®
     */
    async clearChatMetadataInfobarData() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†chatMetadataä¸­çš„ä¿¡æ¯æ æ•°æ®...');

            const context = SillyTavern?.getContext?.();
            if (!context) {
                console.warn('[InfoBarSettings] âš ï¸ SillyTavernä¸Šä¸‹æ–‡ä¸å¯ç”¨ï¼Œè·³è¿‡chatMetadataæ¸…ç†');
                return;
            }

            const chatMetadata = context.chat_metadata || context.chatMetadata;
            if (!chatMetadata) {
                console.warn('[InfoBarSettings] âš ï¸ chatMetadataä¸å¯ç”¨ï¼Œè·³è¿‡æ¸…ç†');
                return;
            }

            let clearedCount = 0;

            // === 1. æ¸…ç†ç‰¹å®šçš„ä¿¡æ¯æ é”® ===
            const specificInfobarKeys = [
                'information_bar_integration_tool',
                'Information_bar_integration_tool',
                'infobar_data',
                'panels',
                'panel_data',
                'field_data'
            ];

            specificInfobarKeys.forEach(key => {
                if (chatMetadata.hasOwnProperty(key)) {
                    delete chatMetadata[key];
                    clearedCount++;
                    console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤chatMetadataé”®: ${key}`);
                }
            });

            // === 2. æ‰«æå¹¶æ¸…ç†æ‰€æœ‰chat_*æ ¼å¼çš„æ•°æ® ===
            const allKeys = Object.keys(chatMetadata);
            const chatKeys = allKeys.filter(key =>
                key.startsWith('chat_') &&
                (key.includes('infobar') || key.includes('information') || key.includes('panel'))
            );

            chatKeys.forEach(key => {
                delete chatMetadata[key];
                clearedCount++;
                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤chatMetadataé”®: ${key}`);
            });

            // === 3. æ¸…ç†panels.*æ ¼å¼çš„é¢æ¿æ•°æ®ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰ ===
            const panelsKeys = allKeys.filter(key => key.startsWith('panels.'));
            console.log(`[InfoBarSettings] ğŸ” å‘ç° ${panelsKeys.length} ä¸ªpanels.*é”®:`, panelsKeys);

            panelsKeys.forEach(key => {
                delete chatMetadata[key];
                clearedCount++;
                console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤é¢æ¿æ•°æ®é”®: ${key}`);
            });

            // === 4. æ¸…ç†æ‰€æœ‰åŒ…å«ä¿¡æ¯æ ç›¸å…³çš„é”® ===
            const infobarRelatedKeys = allKeys.filter(key =>
                !key.startsWith('panels.') && // æ’é™¤å·²å¤„ç†çš„panels.*é”®
                !specificInfobarKeys.includes(key) &&
                !chatKeys.includes(key) && (
                    key.toLowerCase().includes('infobar') ||
                    key.toLowerCase().includes('information') ||
                    key.toLowerCase().includes('panel') ||
                    key.toLowerCase().includes('field')
                )
            );

            infobarRelatedKeys.forEach(key => {
                const value = chatMetadata[key];
                // æ£€æŸ¥å€¼æ˜¯å¦åŒ…å«ä¿¡æ¯æ ç›¸å…³æ•°æ®
                if (value && typeof value === 'object') {
                    const valueStr = JSON.stringify(value).toLowerCase();
                    if (valueStr.includes('infobar') || valueStr.includes('panel') || valueStr.includes('field')) {
                        delete chatMetadata[key];
                        clearedCount++;
                        console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤åŒ…å«ä¿¡æ¯æ æ•°æ®çš„chatMetadataé”®: ${key}`);
                    }
                } else {
                    // å¯¹äºéå¯¹è±¡å€¼ï¼Œä¹Ÿæ£€æŸ¥é”®å
                    delete chatMetadata[key];
                    clearedCount++;
                    console.log(`[InfoBarSettings] âœ… å·²åˆ é™¤ä¿¡æ¯æ ç›¸å…³é”®: ${key}`);
                }
            });

            // === 5. ä¿å­˜æ¸…ç†åçš„chatMetadata ===
            if (clearedCount > 0) {
                if (typeof context.saveChatMetadata === 'function') {
                    await context.saveChatMetadata();
                    console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜æ¸…ç†åçš„chatMetadata');
                } else if (typeof context.saveMetadata === 'function') {
                    await context.saveMetadata();
                    console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜æ¸…ç†åçš„metadata');
                }
            }

            console.log(`[InfoBarSettings] âœ… chatMetadataæ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${clearedCount} ä¸ªé”®`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†chatMetadataå¤±è´¥:', error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åˆå§‹åŒ–è¿‡ç¨‹ç»§ç»­
        }
    }

    /**
     * æ¸…ç†STScriptå˜é‡ç³»ç»Ÿä¸­çš„æ‰€æœ‰ä¿¡æ¯æ æ•°æ®
     */
    async clearSTScriptVariables() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ å¼€å§‹æ¸…ç†STScriptå˜é‡...');

            const context = SillyTavern?.getContext?.();
            if (!context || typeof context.executeSlashCommands !== 'function') {
                console.warn('[InfoBarSettings] âš ï¸ STScriptåŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡å˜é‡æ¸…ç†');
                return;
            }

            let clearedCount = 0;

            // === 1. æ¸…ç†ä¸»è¦çš„infobaråµŒå¥—ç»“æ„å˜é‡ ===
            try {
                // å…ˆæ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨
                const currentValue = context.substituteParams('{{getvar::infobar}}');
                if (currentValue && currentValue.trim() && !currentValue.includes('{{getvar::')) {
                    console.log('[InfoBarSettings] ğŸ” å‘ç°ä¸»infobarå˜é‡ï¼Œå†…å®¹é•¿åº¦:', currentValue.length);

                    // å¼ºåˆ¶æ¸…ç†ä¸»infobarå˜é‡ - ä½¿ç”¨ç©ºå€¼è¦†ç›–
                    await context.executeSlashCommands('/setvar key=infobar value=""');

                    // éªŒè¯æ¸…ç†ç»“æœ
                    const afterClear = context.substituteParams('{{getvar::infobar}}');
                    if (!afterClear || afterClear.trim() === '' || afterClear.includes('{{getvar::')) {
                        console.log('[InfoBarSettings] âœ… ä¸»infobarå˜é‡å·²æˆåŠŸæ¸…ç†');
                        clearedCount++;
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ ä¸»infobarå˜é‡æ¸…ç†å¯èƒ½ä¸å®Œå…¨ï¼Œå‰©ä½™:', afterClear.substring(0, 100));
                        // å°è¯•ç¬¬äºŒæ¬¡æ¸…ç†
                        await context.executeSlashCommands('/setvar key=infobar ');
                        clearedCount++;
                    }
                } else {
                    console.log('[InfoBarSettings] â„¹ï¸ ä¸»infobarå˜é‡ä¸å­˜åœ¨æˆ–å·²ä¸ºç©º');
                }
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†ä¸»infobarå˜é‡å¤±è´¥:', e);
            }

            // === 2. æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡ ===
            try {
                await context.executeSlashCommands('/setvar key=infobar_sync_rules ');
                clearedCount++;
                console.log('[InfoBarSettings] âœ… å·²æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡');
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†è§„åˆ™åŒæ­¥æ§åˆ¶å˜é‡å¤±è´¥:', e);
            }

            // === 3. æ¸…ç†æ‰€æœ‰é¢æ¿ç›¸å…³çš„åˆ†æ•£å˜é‡ ===
            const panelNames = [
                'personal', 'world', 'interaction', 'tasks', 'inventory', 'abilities',
                'organization', 'news', 'plot', 'cultivation', 'fantasy', 'modern',
                'historical', 'magic', 'training'
            ];

            const commonFieldNames = [
                'name', 'age', 'gender', 'appearance', 'posture', 'mood', 'location', 'room',
                'environment', 'object', 'health', 'energy', 'consciousness', 'type', 'genre',
                'description', 'status', 'priority', 'deadline', 'progress', 'category',
                'weapons', 'armor', 'items', 'storage', 'capacity', 'strength', 'agility',
                'intelligence', 'skills', 'leadership', 'influence', 'reputation', 'lastUpdated'
            ];

            // æ¸…ç†é¢æ¿æ•´ä½“å˜é‡
            for (const panelName of panelNames) {
                try {
                    await context.executeSlashCommands(`/setvar key=infobar_${panelName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            // æ¸…ç†é¢æ¿å­—æ®µå˜é‡
            for (const panelName of panelNames) {
                for (const fieldName of commonFieldNames) {
                    try {
                        await context.executeSlashCommands(`/setvar key=infobar_${panelName}_${fieldName} `);
                        clearedCount++;
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                    }
                }
            }

            // === 4. æ¸…ç†æ€»ç»“ç›¸å…³å˜é‡ ===
            const summaryVars = [
                'summary_count', 'summary_latest', 'summary_latest_timestamp', 'summary_latest_type',
                'summary_all', 'summary_timeline',
                'summary_1', 'summary_1_timestamp', 'summary_1_type',
                'summary_2', 'summary_2_timestamp', 'summary_2_type',
                'summary_3', 'summary_3_timestamp', 'summary_3_type'
            ];

            for (const varName of summaryVars) {
                try {
                    await context.executeSlashCommands(`/setvar key=${varName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            // === 5. æ¸…ç†å…¶ä»–å¯èƒ½çš„æ’ä»¶ç›¸å…³å˜é‡ ===
            const otherVars = [
                'infobar_enabled', 'infobar_version', 'infobar_config', 'infobar_theme',
                'infobar_auto_sync', 'infobar_debug', 'infobar_status'
            ];

            for (const varName of otherVars) {
                try {
                    await context.executeSlashCommands(`/setvar key=${varName} `);
                    clearedCount++;
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
                }
            }

            console.log(`[InfoBarSettings] âœ… STScriptå˜é‡æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${clearedCount} ä¸ªå˜é‡`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†STScriptå˜é‡å¤±è´¥:', error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åˆå§‹åŒ–è¿‡ç¨‹ç»§ç»­
        }
    }

    /**
     * æ¸…ç©ºé¢æ¿æ•°æ® - åªæ¸…ç©ºæ•°æ®ï¼Œä¿ç•™é…ç½®
     */
    async clearPanelData() {
        try {
            const confirmMessage = 'âš ï¸ ç¡®è®¤æ¸…ç©ºé¢æ¿æ•°æ®\n\n' +
                'æ­¤æ“ä½œå°†ï¼š\n' +
                'â€¢ æ¸…ç©ºæ‰€æœ‰èŠå¤©ä¸­çš„é¢æ¿æ•°æ®\n' +
                'â€¢ ä¿ç•™é¢æ¿é…ç½®å’Œè§„åˆ™è®¾ç½®\n' +
                'â€¢ ä¿ç•™è‡ªå®šä¹‰é¢æ¿å’Œå­é¡¹å®šä¹‰\n\n' +
                'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';

            if (!confirm(confirmMessage)) {
                return;
            }

            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ¸…ç©ºé¢æ¿æ•°æ®...');

            const dataCore = this.configManager?.dataCore || window.SillyTavernInfobar?.modules?.dataCore;

            if (dataCore) {
                // åªæ¸…ç©ºèŠå¤©æ•°æ®ï¼Œä¿ç•™é…ç½®
                await dataCore.clearAllData('chat');

                console.log('[InfoBarSettings] âœ… é¢æ¿æ•°æ®æ¸…ç©ºå®Œæˆ');
                this.showMessage('æ‰€æœ‰é¢æ¿æ•°æ®å·²æ¸…ç©º', 'success');
            } else {
                throw new Error('æ— æ³•è·å–æ•°æ®æ ¸å¿ƒ');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢æ¿æ•°æ®å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºé¢æ¿æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆå…¨å±€ä¸èŠå¤©èŒƒå›´ï¼‰
     */
    async clearAllCaches() {
        try {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†åˆ é™¤å…¨å±€ä¸èŠå¤©èŒƒå›´çš„ç¼“å­˜ã€‚')) {
                return;
            }

            const configManager = this.configManager || window.SillyTavernInfobar?.modules?.configManager;
            if (configManager && configManager.dataCore) {
                // æ¸…ç©ºå…¨å±€ä¸èŠå¤©æ•°æ®
                await configManager.dataCore.clearAllData('all');
                // é‡æ–°åŠ è½½é…ç½®ç¼“å­˜
                await configManager.loadAllConfigs?.();
            }

            this.showMessage('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤', 'success');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
            this.showMessage('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    // resetAllSettingsæ–¹æ³•å·²åˆ é™¤ï¼Œæ›¿æ¢ä¸ºinitializePluginå’ŒclearPanelDataæ–¹æ³•

    /**
     * å¯¼å‡ºè®¾ç½®
     */
    async exportSettings() {
        try {
            // ä¼˜å…ˆä½¿ç”¨é…ç½®ç®¡ç†å™¨å¯¼å‡º
            const exportData = await this.configManager.exportConfigs();

            // å…œåº•å¢å¼ºï¼šç¡®ä¿åŒ…å«åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ã€è‡ªå®šä¹‰é¢æ¿å®šä¹‰ï¼Œä»¥åŠå‰ç«¯æ˜¾ç¤ºé…ç½®
            try {
                const context = SillyTavern.getContext();
                const extensionSettings = context?.extensionSettings?.['Information bar integration tool'] || {};

                // è‡ªå®šä¹‰é¢æ¿ï¼ˆå«å­é¡¹ï¼‰
                if (extensionSettings.customPanels && !exportData.configs.customPanels) {
                    exportData.configs.customPanels = extensionSettings.customPanels;
                }

                // åŸºç¡€é¢æ¿é…ç½®ï¼ˆå«subItems/promptsç­‰ï¼‰
                const basicPanelIds = ['personal','world','interaction','tasks','organization','news','inventory','abilities','plot','cultivation','fantasy','modern','historical','magic','training'];
                basicPanelIds.forEach(id => {
                    if (extensionSettings[id] && !exportData.configs[id]) {
                        exportData.configs[id] = extensionSettings[id];
                    }
                });

                // å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼ˆå¦‚æœæœªè¢«æ”¶é›†ï¼‰
                if (!exportData.configs.frontendDisplay) {
                    const fd = await this.configManager.getFrontendDisplayConfig();
                    exportData.configs.frontendDisplay = fd;
                }
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ å¯¼å‡ºå¢å¼ºåˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°éè‡´å‘½é”™è¯¯:', e);
            }

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `info-bar-settings-${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage('è®¾ç½®å¯¼å‡ºæˆåŠŸ', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºè®¾ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºè®¾ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å‡ºè‡ªå®šä¹‰é…ç½®
     */
    async exportCustomSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¯¼å‡ºè‡ªå®šä¹‰é…ç½®...');

            // è·å–ç”¨æˆ·é€‰æ‹©çš„å¯¼å‡ºé€‰é¡¹
            const exportOptions = this.getExportOptions();
            console.log('[InfoBarSettings] ğŸ“‹ å¯¼å‡ºé€‰é¡¹:', exportOptions);

            if (!exportOptions.hasAnySelection) {
                this.showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯¼å‡ºé€‰é¡¹', 'warning');
                return;
            }

            // æ„å»ºå¯¼å‡ºæ•°æ®
            const exportData = {
                metadata: {
                    version: '1.0.0',
                    exportTime: new Date().toISOString(),
                    exportOptions: exportOptions
                },
                configs: {}
            };

            // å¯¼å‡ºé¢æ¿é…ç½®
            if (exportOptions.panelConfigs) {
                console.log('[InfoBarSettings] ğŸ“Š å¯¼å‡ºé¢æ¿é…ç½®...');
                await this.addPanelConfigsToExport(exportData);
            }

            // å¯¼å‡ºé¢æ¿è§„åˆ™
            if (exportOptions.panelRules) {
                console.log('[InfoBarSettings] ğŸ“‹ å¯¼å‡ºé¢æ¿è§„åˆ™...');
                await this.addPanelRulesToExport(exportData);
            }

            // å¯¼å‡ºå­—æ®µè§„åˆ™
            if (exportOptions.fieldRules) {
                console.log('[InfoBarSettings] ğŸ”§ å¯¼å‡ºå­—æ®µè§„åˆ™...');
                await this.addFieldRulesToExport(exportData);
            }

            // å¯¼å‡ºä¸»é¢˜è®¾ç½®
            if (exportOptions.themeSettings) {
                console.log('[InfoBarSettings] ğŸ¨ å¯¼å‡ºä¸»é¢˜è®¾ç½®...');
                await this.addThemeSettingsToExport(exportData);
            }

            // å¯¼å‡ºAPIè®¾ç½®
            if (exportOptions.apiSettings) {
                console.log('[InfoBarSettings] ğŸ”Œ å¯¼å‡ºAPIè®¾ç½®...');
                await this.addApiSettingsToExport(exportData);
            }

            // å¯¼å‡ºæ‰€æœ‰è®¾ç½®
            if (exportOptions.allSettings) {
                console.log('[InfoBarSettings] ğŸŒ å¯¼å‡ºæ‰€æœ‰è®¾ç½®...');
                await this.addAllSettingsToExport(exportData);
            }

            // ç”Ÿæˆæ–‡ä»¶å
            const selectedTypes = [];
            if (exportOptions.panelConfigs) selectedTypes.push('panels');
            if (exportOptions.panelRules) selectedTypes.push('panel-rules');
            if (exportOptions.fieldRules) selectedTypes.push('field-rules');
            if (exportOptions.themeSettings) selectedTypes.push('theme');
            if (exportOptions.apiSettings) selectedTypes.push('api');
            if (exportOptions.allSettings) selectedTypes.push('all');

            const fileName = `info-bar-${selectedTypes.join('-')}-${Date.now()}.json`;

            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage(`é…ç½®å¯¼å‡ºæˆåŠŸ: ${fileName}`, 'success');
            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰é…ç½®å¯¼å‡ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºè‡ªå®šä¹‰é…ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å…¥è®¾ç½®
     */
    async importSettings() {
        try {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);

                    await this.configManager.importConfigs(importData);
                    await this.loadSettings();

                    this.showMessage('è®¾ç½®å¯¼å…¥æˆåŠŸ', 'success');

                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å¯¼å…¥è®¾ç½®å¤±è´¥:', error);
                    this.showMessage('å¯¼å…¥è®¾ç½®å¤±è´¥: ' + error.message, 'error');
                }
            };

            input.click();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å…¥è®¾ç½®å¤±è´¥:', error);
            this.showMessage('å¯¼å…¥è®¾ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†è¡¨å•å˜æ›´
     */
    handleFormChange(e) {
        try {
            // è°ƒè¯•è®¾ç½®å˜æ›´ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«åŠ¨æ€è®¾ç½®æ§åˆ¶å°è¿‡æ»¤
            if (e.target.name === 'debug.enabled' || e.target.name === 'debug.logLevel') {
                const enabled = this.modal.querySelector('[name="debug.enabled"]')?.checked;
                const level = this.modal.querySelector('[name="debug.logLevel"]').value || 'info';
                this.applyConsoleLogLevel(enabled ? level : 'none');
            }
            // ä¸»é¢˜åˆ‡æ¢ç‰¹æ®Šå¤„ç†
            if (e.target.name === 'theme.current') {
                const customGroup = this.modal.querySelector('.custom-theme-group');
                if (customGroup) {
                    customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
                }
            }

            // å®æ—¶é¢„è§ˆä¸»é¢˜å˜åŒ–
            if (e.target.name && e.target.name.startsWith('theme.custom.')) {
                this.updateThemePreview();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è¡¨å•å˜æ›´å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°ä¸»é¢˜é¢„è§ˆ
     */
    updateThemePreview() {
        try {
            const previewBox = this.modal.querySelector('.preview-box');
            if (!previewBox) return;

            const customColors = {
                primary: this.modal.querySelector('[name="theme.custom.primary"]')?.value,
                background: this.modal.querySelector('[name="theme.custom.background"]')?.value,
                text: this.modal.querySelector('[name="theme.custom.text"]')?.value,
                border: this.modal.querySelector('[name="theme.custom.border"]')?.value
            };

            // åº”ç”¨é¢„è§ˆæ ·å¼
            previewBox.style.backgroundColor = customColors.background;
            previewBox.style.color = customColors.text;
            previewBox.style.borderColor = customColors.border;

            const previewButton = previewBox.querySelector('.preview-button');
            if (previewButton) {
                previewButton.style.backgroundColor = customColors.primary;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸»é¢˜é¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºä¸ªäººä¿¡æ¯é¢æ¿
     */
    createPersonalPanel() {
        return `
            <div class="content-header">
                <h3>ä¸ªäººä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‘¤</div>
                            <div class="card-text">
                                <div class="card-title">ä¸ªäººä¿¡æ¯</div>
                                <div class="card-subtitle">è§’è‰²è‡ªèº«çš„åŸºç¡€ä¿¡æ¯</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="personal-info-toggle" name="personal.enabled" checked />
                                <label for="personal-info-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count" id="personal-panel-count">0/0 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="name-checkbox" name="personal.name.enabled" checked />
                                <label for="name-checkbox" class="checkbox-label">å§“å</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="age-checkbox" name="personal.age.enabled" checked />
                                <label for="age-checkbox" class="checkbox-label">å¹´é¾„</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="gender-checkbox" name="personal.gender.enabled" checked />
                                <label for="gender-checkbox" class="checkbox-label">æ€§åˆ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="occupation-checkbox" name="personal.occupation.enabled" checked />
                                <label for="occupation-checkbox" class="checkbox-label">èŒä¸š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="height-checkbox" name="personal.height.enabled" />
                                <label for="height-checkbox" class="checkbox-label">èº«é«˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="weight-checkbox" name="personal.weight.enabled" />
                                <label for="weight-checkbox" class="checkbox-label">ä½“é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="blood-type-checkbox" name="personal.bloodType.enabled" />
                                <label for="blood-type-checkbox" class="checkbox-label">è¡€å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="zodiac-checkbox" name="personal.zodiac.enabled" />
                                <label for="zodiac-checkbox" class="checkbox-label">æ˜Ÿåº§</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="birthday-checkbox" name="personal.birthday.enabled" />
                                <label for="birthday-checkbox" class="checkbox-label">ç”Ÿæ—¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="birthplace-checkbox" name="personal.birthplace.enabled" />
                                <label for="birthplace-checkbox" class="checkbox-label">å‡ºç”Ÿåœ°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="nationality-checkbox" name="personal.nationality.enabled" />
                                <label for="nationality-checkbox" class="checkbox-label">å›½ç±</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="ethnicity-checkbox" name="personal.ethnicity.enabled" />
                                <label for="ethnicity-checkbox" class="checkbox-label">æ°‘æ—</label>
                            </div>
                        </div>
                    </div>

                    <!-- å¤–è§‚ç‰¹å¾ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hair-color-checkbox" name="personal.hairColor.enabled" />
                                <label for="hair-color-checkbox" class="checkbox-label">å‘è‰²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hair-style-checkbox" name="personal.hairStyle.enabled" />
                                <label for="hair-style-checkbox" class="checkbox-label">å‘å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="eye-color-checkbox" name="personal.eyeColor.enabled" />
                                <label for="eye-color-checkbox" class="checkbox-label">çœ¼è‰²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="skin-color-checkbox" name="personal.skinColor.enabled" />
                                <label for="skin-color-checkbox" class="checkbox-label">è‚¤è‰²</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="body-type-checkbox" name="personal.bodyType.enabled" />
                                <label for="body-type-checkbox" class="checkbox-label">ä½“å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="facial-features-checkbox" name="personal.facialFeatures.enabled" />
                                <label for="facial-features-checkbox" class="checkbox-label">é¢éƒ¨ç‰¹å¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="scars-checkbox" name="personal.scars.enabled" />
                                <label for="scars-checkbox" class="checkbox-label">ç–¤ç—•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tattoos-checkbox" name="personal.tattoos.enabled" />
                                <label for="tattoos-checkbox" class="checkbox-label">çº¹èº«</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="accessories-checkbox" name="personal.accessories.enabled" />
                                <label for="accessories-checkbox" class="checkbox-label">é¥°å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="clothing-style-checkbox" name="personal.clothingStyle.enabled" />
                                <label for="clothing-style-checkbox" class="checkbox-label">æœè£…é£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="appearance-checkbox" name="personal.appearance.enabled" checked />
                                <label for="appearance-checkbox" class="checkbox-label">å¤–è§‚æè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="voice-checkbox" name="personal.voice.enabled" />
                                <label for="voice-checkbox" class="checkbox-label">å£°éŸ³ç‰¹å¾</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ€§æ ¼ç‰¹è´¨ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="personality-checkbox" name="personal.personality.enabled" checked />
                                <label for="personality-checkbox" class="checkbox-label">æ€§æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="temperament-checkbox" name="personal.temperament.enabled" />
                                <label for="temperament-checkbox" class="checkbox-label">æ°”è´¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="attitude-checkbox" name="personal.attitude.enabled" />
                                <label for="attitude-checkbox" class="checkbox-label">æ€åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="values-checkbox" name="personal.values.enabled" />
                                <label for="values-checkbox" class="checkbox-label">ä»·å€¼è§‚</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="beliefs-checkbox" name="personal.beliefs.enabled" />
                                <label for="beliefs-checkbox" class="checkbox-label">ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fears-checkbox" name="personal.fears.enabled" />
                                <label for="fears-checkbox" class="checkbox-label">ææƒ§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="dreams-checkbox" name="personal.dreams.enabled" />
                                <label for="dreams-checkbox" class="checkbox-label">æ¢¦æƒ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="goals-checkbox" name="personal.goals.enabled" />
                                <label for="goals-checkbox" class="checkbox-label">ç›®æ ‡</label>
                            </div>
                        </div>
                    </div>

                    <!-- èƒ½åŠ›å±æ€§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="intelligence-checkbox" name="personal.intelligence.enabled" />
                                <label for="intelligence-checkbox" class="checkbox-label">æ™ºåŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="strength-checkbox" name="personal.strength.enabled" />
                                <label for="strength-checkbox" class="checkbox-label">ä½“åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="charisma-checkbox" name="personal.charisma.enabled" />
                                <label for="charisma-checkbox" class="checkbox-label">é­…åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="luck-checkbox" name="personal.luck.enabled" />
                                <label for="luck-checkbox" class="checkbox-label">è¿æ°”</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="perception-checkbox" name="personal.perception.enabled" />
                                <label for="perception-checkbox" class="checkbox-label">æ„ŸçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="willpower-checkbox" name="personal.willpower.enabled" />
                                <label for="willpower-checkbox" class="checkbox-label">æ„å¿—åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="reaction-speed-checkbox" name="personal.reactionSpeed.enabled" />
                                <label for="reaction-speed-checkbox" class="checkbox-label">ååº”é€Ÿåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="learning-ability-checkbox" name="personal.learningAbility.enabled" />
                                <label for="learning-ability-checkbox" class="checkbox-label">å­¦ä¹ èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾ä¼šå…³ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="family-background-checkbox" name="personal.familyBackground.enabled" />
                                <label for="family-background-checkbox" class="checkbox-label">å®¶åº­èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="education-checkbox" name="personal.education.enabled" />
                                <label for="education-checkbox" class="checkbox-label">æ•™è‚²ç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="work-experience-checkbox" name="personal.workExperience.enabled" />
                                <label for="work-experience-checkbox" class="checkbox-label">å·¥ä½œç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="income-checkbox" name="personal.income.enabled" />
                                <label for="income-checkbox" class="checkbox-label">æ”¶å…¥</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="social-status-checkbox" name="personal.socialStatus.enabled" />
                                <label for="social-status-checkbox" class="checkbox-label">ç¤¾ä¼šåœ°ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="relationships-checkbox" name="personal.relationships.enabled" />
                                <label for="relationships-checkbox" class="checkbox-label">äººé™…å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="love-status-checkbox" name="personal.loveStatus.enabled" />
                                <label for="love-status-checkbox" class="checkbox-label">æ‹çˆ±çŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="marital-status-checkbox" name="personal.maritalStatus.enabled" />
                                <label for="marital-status-checkbox" class="checkbox-label">å©šå§»çŠ¶æ€</label>
                            </div>
                        </div>
                    </div>
                    <!-- å…´è¶£çˆ±å¥½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="hobbies-checkbox" name="personal.hobbies.enabled" />
                                <label for="hobbies-checkbox" class="checkbox-label">å…´è¶£çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="sports-checkbox" name="personal.sports.enabled" />
                                <label for="sports-checkbox" class="checkbox-label">è¿åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="music-checkbox" name="personal.music.enabled" />
                                <label for="music-checkbox" class="checkbox-label">éŸ³ä¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="art-checkbox" name="personal.art.enabled" />
                                <label for="art-checkbox" class="checkbox-label">è‰ºæœ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="reading-checkbox" name="personal.reading.enabled" />
                                <label for="reading-checkbox" class="checkbox-label">é˜…è¯»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="gaming-checkbox" name="personal.gaming.enabled" />
                                <label for="gaming-checkbox" class="checkbox-label">æ¸¸æˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="travel-checkbox" name="personal.travel.enabled" />
                                <label for="travel-checkbox" class="checkbox-label">æ—…è¡Œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cooking-checkbox" name="personal.cooking.enabled" />
                                <label for="cooking-checkbox" class="checkbox-label">çƒ¹é¥ª</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="skills-checkbox" name="personal.skills.enabled" />
                                <label for="skills-checkbox" class="checkbox-label">æŠ€èƒ½ç‰¹é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="languages-checkbox" name="personal.languages.enabled" />
                                <label for="languages-checkbox" class="checkbox-label">è¯­è¨€èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="habits-checkbox" name="personal.habits.enabled" />
                                <label for="habits-checkbox" class="checkbox-label">ç”Ÿæ´»ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="health-status-checkbox" name="personal.healthStatus.enabled" />
                                <label for="health-status-checkbox" class="checkbox-label">å¥åº·çŠ¶æ€</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="action-buttons">
                    <button class="btn-action btn-all">å…¨é€‰</button>
                    <button class="btn-action btn-none">å…¨ä¸é€‰</button>
                    <button class="btn-action btn-basic">åŸºç¡€ä¿¡æ¯</button>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºäº¤äº’å¯¹è±¡é¢æ¿
     */
    createInteractionPanel() {
        return `
            <div class="content-header">
                <h3>äº¤äº’å¯¹è±¡é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- äº¤äº’å¯¹è±¡å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‘¥</div>
                            <div class="card-text">
                                <div class="card-title">äº¤äº’å¯¹è±¡</div>
                                <div class="card-subtitle">è§’è‰²äº¤äº’å’Œå…³ç³»ç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="interaction-toggle" name="interaction.enabled" checked />
                                <label for="interaction-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count" id="interaction-panel-count">0/0 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-name-checkbox" name="interaction.name.enabled" checked />
                                <label for="interaction-name-checkbox" class="checkbox-label">å¯¹è±¡åç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-type-checkbox" name="interaction.type.enabled" checked />
                                <label for="interaction-type-checkbox" class="checkbox-label">å¯¹è±¡ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-status-checkbox" name="interaction.status.enabled" checked />
                                <label for="interaction-status-checkbox" class="checkbox-label">åœ¨çº¿çŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-location-checkbox" name="interaction.location.enabled" />
                                <label for="interaction-location-checkbox" class="checkbox-label">æ‰€åœ¨ä½ç½®</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-mood-checkbox" name="interaction.mood.enabled" />
                                <label for="interaction-mood-checkbox" class="checkbox-label">æƒ…ç»ªçŠ¶æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-activity-checkbox" name="interaction.activity.enabled" />
                                <label for="interaction-activity-checkbox" class="checkbox-label">å½“å‰æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-availability-checkbox" name="interaction.availability.enabled" />
                                <label for="interaction-availability-checkbox" class="checkbox-label">å¯ç”¨æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-priority-checkbox" name="interaction.priority.enabled" />
                                <label for="interaction-priority-checkbox" class="checkbox-label">ä¼˜å…ˆçº§</label>
                            </div>
                        </div>
                    </div>

                    <!-- å…³ç³»ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-relationship-checkbox" name="interaction.relationship.enabled" checked />
                                <label for="interaction-relationship-checkbox" class="checkbox-label">å…³ç³»ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-intimacy-checkbox" name="interaction.intimacy.enabled" checked />
                                <label for="interaction-intimacy-checkbox" class="checkbox-label">äº²å¯†åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-trust-checkbox" name="interaction.trust.enabled" />
                                <label for="interaction-trust-checkbox" class="checkbox-label">ä¿¡ä»»åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-friendship-checkbox" name="interaction.friendship.enabled" />
                                <label for="interaction-friendship-checkbox" class="checkbox-label">å‹å¥½åº¦</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-romance-checkbox" name="interaction.romance.enabled" />
                                <label for="interaction-romance-checkbox" class="checkbox-label">æµªæ¼«åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-respect-checkbox" name="interaction.respect.enabled" />
                                <label for="interaction-respect-checkbox" class="checkbox-label">å°Šé‡åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-dependency-checkbox" name="interaction.dependency.enabled" />
                                <label for="interaction-dependency-checkbox" class="checkbox-label">ä¾èµ–åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-conflict-checkbox" name="interaction.conflict.enabled" />
                                <label for="interaction-conflict-checkbox" class="checkbox-label">å†²çªåº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’å†å² -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-history-checkbox" name="interaction.history.enabled" checked />
                                <label for="interaction-history-checkbox" class="checkbox-label">äº¤äº’å†å²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-frequency-checkbox" name="interaction.frequency.enabled" />
                                <label for="interaction-frequency-checkbox" class="checkbox-label">äº¤äº’é¢‘ç‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-duration-checkbox" name="interaction.duration.enabled" />
                                <label for="interaction-duration-checkbox" class="checkbox-label">äº¤äº’æ—¶é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-quality-checkbox" name="interaction.quality.enabled" />
                                <label for="interaction-quality-checkbox" class="checkbox-label">äº¤äº’è´¨é‡</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-topics-checkbox" name="interaction.topics.enabled" />
                                <label for="interaction-topics-checkbox" class="checkbox-label">è¯é¢˜è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-emotions-checkbox" name="interaction.emotions.enabled" />
                                <label for="interaction-emotions-checkbox" class="checkbox-label">æƒ…æ„Ÿå˜åŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-milestones-checkbox" name="interaction.milestones.enabled" />
                                <label for="interaction-milestones-checkbox" class="checkbox-label">é‡è¦èŠ‚ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-memories-checkbox" name="interaction.memories.enabled" />
                                <label for="interaction-memories-checkbox" class="checkbox-label">å…±åŒå›å¿†</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’è®¾ç½® -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-auto-record-checkbox" name="interaction.autoRecord.enabled" checked />
                                <label for="interaction-auto-record-checkbox" class="checkbox-label">è‡ªåŠ¨è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-notifications-checkbox" name="interaction.notifications.enabled" />
                                <label for="interaction-notifications-checkbox" class="checkbox-label">äº¤äº’é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-analysis-checkbox" name="interaction.analysis.enabled" />
                                <label for="interaction-analysis-checkbox" class="checkbox-label">è¡Œä¸ºåˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-suggestions-checkbox" name="interaction.suggestions.enabled" />
                                <label for="interaction-suggestions-checkbox" class="checkbox-label">å»ºè®®æç¤º</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾äº¤ç½‘ç»œ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-network-checkbox" name="interaction.network.enabled" />
                                <label for="interaction-network-checkbox" class="checkbox-label">ç¤¾äº¤ç½‘ç»œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-groups-checkbox" name="interaction.groups.enabled" />
                                <label for="interaction-groups-checkbox" class="checkbox-label">ç¾¤ç»„å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-influence-checkbox" name="interaction.influence.enabled" />
                                <label for="interaction-influence-checkbox" class="checkbox-label">å½±å“åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-reputation-checkbox" name="interaction.reputation.enabled" />
                                <label for="interaction-reputation-checkbox" class="checkbox-label">å£°èª‰</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-alliances-checkbox" name="interaction.alliances.enabled" />
                                <label for="interaction-alliances-checkbox" class="checkbox-label">è”ç›Ÿå…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-rivalries-checkbox" name="interaction.rivalries.enabled" />
                                <label for="interaction-rivalries-checkbox" class="checkbox-label">ç«äº‰å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-mentorship-checkbox" name="interaction.mentorship.enabled" />
                                <label for="interaction-mentorship-checkbox" class="checkbox-label">å¸ˆå¾’å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-hierarchy-checkbox" name="interaction.hierarchy.enabled" />
                                <label for="interaction-hierarchy-checkbox" class="checkbox-label">ç­‰çº§å…³ç³»</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤äº’åå¥½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-communication-style-checkbox" name="interaction.communicationStyle.enabled" />
                                <label for="interaction-communication-style-checkbox" class="checkbox-label">æ²Ÿé€šé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-preferred-topics-checkbox" name="interaction.preferredTopics.enabled" />
                                <label for="interaction-preferred-topics-checkbox" class="checkbox-label">åå¥½è¯é¢˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-avoided-topics-checkbox" name="interaction.avoidedTopics.enabled" />
                                <label for="interaction-avoided-topics-checkbox" class="checkbox-label">é¿å…è¯é¢˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-boundaries-checkbox" name="interaction.boundaries.enabled" />
                                <label for="interaction-boundaries-checkbox" class="checkbox-label">äº¤äº’è¾¹ç•Œ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-comfort-level-checkbox" name="interaction.comfortLevel.enabled" />
                                <label for="interaction-comfort-level-checkbox" class="checkbox-label">èˆ’é€‚åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-energy-level-checkbox" name="interaction.energyLevel.enabled" />
                                <label for="interaction-energy-level-checkbox" class="checkbox-label">æ´»è·ƒåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-response-time-checkbox" name="interaction.responseTime.enabled" />
                                <label for="interaction-response-time-checkbox" class="checkbox-label">å“åº”æ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-engagement-checkbox" name="interaction.engagement.enabled" />
                                <label for="interaction-engagement-checkbox" class="checkbox-label">å‚ä¸åº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰¹æ®ŠçŠ¶æ€ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-special-events-checkbox" name="interaction.specialEvents.enabled" />
                                <label for="interaction-special-events-checkbox" class="checkbox-label">ç‰¹æ®Šäº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-achievements-checkbox" name="interaction.achievements.enabled" />
                                <label for="interaction-achievements-checkbox" class="checkbox-label">æˆå°±è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-challenges-checkbox" name="interaction.challenges.enabled" />
                                <label for="interaction-challenges-checkbox" class="checkbox-label">æŒ‘æˆ˜è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="interaction-growth-checkbox" name="interaction.growth.enabled" />
                                <label for="interaction-growth-checkbox" class="checkbox-label">æˆé•¿è½¨è¿¹</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºä»»åŠ¡ç³»ç»Ÿé¢æ¿
     */
    createTasksPanel() {
        return `
            <div class="content-header">
                <h3>ä»»åŠ¡ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä»»åŠ¡ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“‹</div>
                            <div class="card-text">
                                <div class="card-title">ä»»åŠ¡ç³»ç»Ÿ</div>
                                <div class="card-subtitle">ä»»åŠ¡ç®¡ç†å’Œè¿›åº¦è·Ÿè¸ª</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="tasks-toggle" name="tasks.enabled" checked />
                                <label for="tasks-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">15/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ä»»åŠ¡åŸºç¡€ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-creation-checkbox" name="tasks.creation.enabled" checked />
                                <label for="tasks-creation-checkbox" class="checkbox-label">ä»»åŠ¡åˆ›å»º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-editing-checkbox" name="tasks.editing.enabled" checked />
                                <label for="tasks-editing-checkbox" class="checkbox-label">ä»»åŠ¡ç¼–è¾‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-deletion-checkbox" name="tasks.deletion.enabled" checked />
                                <label for="tasks-deletion-checkbox" class="checkbox-label">ä»»åŠ¡åˆ é™¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-completion-checkbox" name="tasks.completion.enabled" checked />
                                <label for="tasks-completion-checkbox" class="checkbox-label">ä»»åŠ¡å®Œæˆ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-priority-checkbox" name="tasks.priority.enabled" />
                                <label for="tasks-priority-checkbox" class="checkbox-label">ä¼˜å…ˆçº§è®¾ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-deadline-checkbox" name="tasks.deadline.enabled" />
                                <label for="tasks-deadline-checkbox" class="checkbox-label">æˆªæ­¢æ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-progress-checkbox" name="tasks.progress.enabled" />
                                <label for="tasks-progress-checkbox" class="checkbox-label">è¿›åº¦è·Ÿè¸ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-status-checkbox" name="tasks.status.enabled" />
                                <label for="tasks-status-checkbox" class="checkbox-label">çŠ¶æ€ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡åˆ†ç±» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-categories-checkbox" name="tasks.categories.enabled" />
                                <label for="tasks-categories-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†ç±»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-tags-checkbox" name="tasks.tags.enabled" />
                                <label for="tasks-tags-checkbox" class="checkbox-label">æ ‡ç­¾ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-projects-checkbox" name="tasks.projects.enabled" />
                                <label for="tasks-projects-checkbox" class="checkbox-label">é¡¹ç›®åˆ†ç»„</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-milestones-checkbox" name="tasks.milestones.enabled" />
                                <label for="tasks-milestones-checkbox" class="checkbox-label">é‡Œç¨‹ç¢‘</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-subtasks-checkbox" name="tasks.subtasks.enabled" />
                                <label for="tasks-subtasks-checkbox" class="checkbox-label">å­ä»»åŠ¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-dependencies-checkbox" name="tasks.dependencies.enabled" />
                                <label for="tasks-dependencies-checkbox" class="checkbox-label">ä»»åŠ¡ä¾èµ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-templates-checkbox" name="tasks.templates.enabled" />
                                <label for="tasks-templates-checkbox" class="checkbox-label">ä»»åŠ¡æ¨¡æ¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-recurring-checkbox" name="tasks.recurring.enabled" />
                                <label for="tasks-recurring-checkbox" class="checkbox-label">é‡å¤ä»»åŠ¡</label>
                            </div>
                        </div>
                    </div>

                    <!-- é€šçŸ¥æé†’ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-notifications-checkbox" name="tasks.notifications.enabled" checked />
                                <label for="tasks-notifications-checkbox" class="checkbox-label">ä»»åŠ¡é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-reminders-checkbox" name="tasks.reminders.enabled" />
                                <label for="tasks-reminders-checkbox" class="checkbox-label">æé†’è®¾ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-alerts-checkbox" name="tasks.alerts.enabled" />
                                <label for="tasks-alerts-checkbox" class="checkbox-label">é€¾æœŸè­¦å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-daily-summary-checkbox" name="tasks.dailySummary.enabled" />
                                <label for="tasks-daily-summary-checkbox" class="checkbox-label">æ¯æ—¥æ€»ç»“</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-weekly-review-checkbox" name="tasks.weeklyReview.enabled" />
                                <label for="tasks-weekly-review-checkbox" class="checkbox-label">å‘¨åº¦å›é¡¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-achievement-badges-checkbox" name="tasks.achievementBadges.enabled" />
                                <label for="tasks-achievement-badges-checkbox" class="checkbox-label">æˆå°±å¾½ç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-productivity-stats-checkbox" name="tasks.productivityStats.enabled" />
                                <label for="tasks-productivity-stats-checkbox" class="checkbox-label">æ•ˆç‡ç»Ÿè®¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-time-tracking-checkbox" name="tasks.timeTracking.enabled" />
                                <label for="tasks-time-tracking-checkbox" class="checkbox-label">æ—¶é—´è·Ÿè¸ª</label>
                            </div>
                        </div>
                    </div>

                    <!-- åä½œåŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-assignment-checkbox" name="tasks.assignment.enabled" />
                                <label for="tasks-assignment-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†é…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-collaboration-checkbox" name="tasks.collaboration.enabled" />
                                <label for="tasks-collaboration-checkbox" class="checkbox-label">åä½œåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-comments-checkbox" name="tasks.comments.enabled" />
                                <label for="tasks-comments-checkbox" class="checkbox-label">ä»»åŠ¡è¯„è®º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-attachments-checkbox" name="tasks.attachments.enabled" />
                                <label for="tasks-attachments-checkbox" class="checkbox-label">æ–‡ä»¶é™„ä»¶</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sharing-checkbox" name="tasks.sharing.enabled" />
                                <label for="tasks-sharing-checkbox" class="checkbox-label">ä»»åŠ¡åˆ†äº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-permissions-checkbox" name="tasks.permissions.enabled" />
                                <label for="tasks-permissions-checkbox" class="checkbox-label">æƒé™ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-approval-checkbox" name="tasks.approval.enabled" />
                                <label for="tasks-approval-checkbox" class="checkbox-label">å®¡æ‰¹æµç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-delegation-checkbox" name="tasks.delegation.enabled" />
                                <label for="tasks-delegation-checkbox" class="checkbox-label">ä»»åŠ¡å§”æ´¾</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§†å›¾å’Œæ’åº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-list-view-checkbox" name="tasks.listView.enabled" checked />
                                <label for="tasks-list-view-checkbox" class="checkbox-label">åˆ—è¡¨è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-kanban-view-checkbox" name="tasks.kanbanView.enabled" />
                                <label for="tasks-kanban-view-checkbox" class="checkbox-label">çœ‹æ¿è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-calendar-view-checkbox" name="tasks.calendarView.enabled" />
                                <label for="tasks-calendar-view-checkbox" class="checkbox-label">æ—¥å†è§†å›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-gantt-view-checkbox" name="tasks.ganttView.enabled" />
                                <label for="tasks-gantt-view-checkbox" class="checkbox-label">ç”˜ç‰¹å›¾</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sorting-checkbox" name="tasks.sorting.enabled" checked />
                                <label for="tasks-sorting-checkbox" class="checkbox-label">æ’åºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-filtering-checkbox" name="tasks.filtering.enabled" />
                                <label for="tasks-filtering-checkbox" class="checkbox-label">ç­›é€‰åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-search-checkbox" name="tasks.search.enabled" />
                                <label for="tasks-search-checkbox" class="checkbox-label">æœç´¢åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-grouping-checkbox" name="tasks.grouping.enabled" />
                                <label for="tasks-grouping-checkbox" class="checkbox-label">åˆ†ç»„æ˜¾ç¤º</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-backup-checkbox" name="tasks.backup.enabled" />
                                <label for="tasks-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-export-checkbox" name="tasks.export.enabled" />
                                <label for="tasks-export-checkbox" class="checkbox-label">æ•°æ®å¯¼å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-import-checkbox" name="tasks.import.enabled" />
                                <label for="tasks-import-checkbox" class="checkbox-label">æ•°æ®å¯¼å…¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-sync-checkbox" name="tasks.sync.enabled" />
                                <label for="tasks-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-archive-checkbox" name="tasks.archive.enabled" />
                                <label for="tasks-archive-checkbox" class="checkbox-label">ä»»åŠ¡å½’æ¡£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-history-checkbox" name="tasks.history.enabled" />
                                <label for="tasks-history-checkbox" class="checkbox-label">å†å²è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-versioning-checkbox" name="tasks.versioning.enabled" />
                                <label for="tasks-versioning-checkbox" class="checkbox-label">ç‰ˆæœ¬æ§åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="tasks-recovery-checkbox" name="tasks.recovery.enabled" />
                                <label for="tasks-recovery-checkbox" class="checkbox-label">æ•°æ®æ¢å¤</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºä¸–ç•Œä¿¡æ¯é¢æ¿
     */
    createWorldPanel() {
        return `
            <div class="content-header">
                <h3>ä¸–ç•Œä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¸–ç•Œä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸŒ</div>
                            <div class="card-text">
                                <div class="card-title">ä¸–ç•Œä¿¡æ¯</div>
                                <div class="card-subtitle">ä¸–ç•Œè®¾å®šå’Œç¯å¢ƒç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="world-toggle" name="world.enabled" checked />
                                <label for="world-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">18/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€è®¾å®š -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-name-checkbox" name="world.name.enabled" checked />
                                <label for="world-name-checkbox" class="checkbox-label">ä¸–ç•Œåç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-type-checkbox" name="world.type.enabled" checked />
                                <label for="world-type-checkbox" class="checkbox-label">ä¸–ç•Œç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-genre-checkbox" name="world.genre.enabled" checked />
                                <label for="world-genre-checkbox" class="checkbox-label">ä¸–ç•Œé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-theme-checkbox" name="world.theme.enabled" />
                                <label for="world-theme-checkbox" class="checkbox-label">ä¸»é¢˜è®¾å®š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-description-checkbox" name="world.description.enabled" checked />
                                <label for="world-description-checkbox" class="checkbox-label">ä¸–ç•Œæè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-history-checkbox" name="world.history.enabled" />
                                <label for="world-history-checkbox" class="checkbox-label">å†å²èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-mythology-checkbox" name="world.mythology.enabled" />
                                <label for="world-mythology-checkbox" class="checkbox-label">ç¥è¯ä¼ è¯´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-lore-checkbox" name="world.lore.enabled" />
                                <label for="world-lore-checkbox" class="checkbox-label">ä¸–ç•Œè§‚è®¾å®š</label>
                            </div>
                        </div>
                    </div>

                    <!-- åœ°ç†ç¯å¢ƒ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-geography-checkbox" name="world.geography.enabled" checked />
                                <label for="world-geography-checkbox" class="checkbox-label">åœ°ç†ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-climate-checkbox" name="world.climate.enabled" />
                                <label for="world-climate-checkbox" class="checkbox-label">æ°”å€™æ¡ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-terrain-checkbox" name="world.terrain.enabled" />
                                <label for="world-terrain-checkbox" class="checkbox-label">åœ°å½¢åœ°è²Œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-biomes-checkbox" name="world.biomes.enabled" />
                                <label for="world-biomes-checkbox" class="checkbox-label">ç”Ÿæ€ç¾¤è½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-locations-checkbox" name="world.locations.enabled" checked />
                                <label for="world-locations-checkbox" class="checkbox-label">é‡è¦åœ°ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-landmarks-checkbox" name="world.landmarks.enabled" />
                                <label for="world-landmarks-checkbox" class="checkbox-label">åœ°æ ‡å»ºç­‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-cities-checkbox" name="world.cities.enabled" />
                                <label for="world-cities-checkbox" class="checkbox-label">åŸå¸‚èšè½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-dungeons-checkbox" name="world.dungeons.enabled" />
                                <label for="world-dungeons-checkbox" class="checkbox-label">åœ°ä¸‹åŸ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¶é—´ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-time-checkbox" name="world.time.enabled" checked />
                                <label for="world-time-checkbox" class="checkbox-label">æ—¶é—´ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-calendar-checkbox" name="world.calendar.enabled" />
                                <label for="world-calendar-checkbox" class="checkbox-label">å†æ³•ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-seasons-checkbox" name="world.seasons.enabled" />
                                <label for="world-seasons-checkbox" class="checkbox-label">å­£èŠ‚å˜åŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-day-night-checkbox" name="world.dayNight.enabled" />
                                <label for="world-day-night-checkbox" class="checkbox-label">æ˜¼å¤œå¾ªç¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-weather-checkbox" name="world.weather.enabled" />
                                <label for="world-weather-checkbox" class="checkbox-label">å¤©æ°”ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-events-checkbox" name="world.events.enabled" />
                                <label for="world-events-checkbox" class="checkbox-label">ä¸–ç•Œäº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-festivals-checkbox" name="world.festivals.enabled" />
                                <label for="world-festivals-checkbox" class="checkbox-label">èŠ‚æ—¥åº†å…¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-disasters-checkbox" name="world.disasters.enabled" />
                                <label for="world-disasters-checkbox" class="checkbox-label">è‡ªç„¶ç¾å®³</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾ä¼šæ–‡åŒ– -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-cultures-checkbox" name="world.cultures.enabled" />
                                <label for="world-cultures-checkbox" class="checkbox-label">æ–‡åŒ–ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-languages-checkbox" name="world.languages.enabled" />
                                <label for="world-languages-checkbox" class="checkbox-label">è¯­è¨€ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-religions-checkbox" name="world.religions.enabled" />
                                <label for="world-religions-checkbox" class="checkbox-label">å®—æ•™ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-customs-checkbox" name="world.customs.enabled" />
                                <label for="world-customs-checkbox" class="checkbox-label">é£ä¿—ä¹ æƒ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-politics-checkbox" name="world.politics.enabled" />
                                <label for="world-politics-checkbox" class="checkbox-label">æ”¿æ²»åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-economy-checkbox" name="world.economy.enabled" />
                                <label for="world-economy-checkbox" class="checkbox-label">ç»æµä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-technology-checkbox" name="world.technology.enabled" />
                                <label for="world-technology-checkbox" class="checkbox-label">ç§‘æŠ€æ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-magic-checkbox" name="world.magic.enabled" />
                                <label for="world-magic-checkbox" class="checkbox-label">é­”æ³•ä½“ç³»</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿç‰©ç§æ— -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-races-checkbox" name="world.races.enabled" />
                                <label for="world-races-checkbox" class="checkbox-label">ç§æ—è®¾å®š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-creatures-checkbox" name="world.creatures.enabled" />
                                <label for="world-creatures-checkbox" class="checkbox-label">ç”Ÿç‰©ç¾¤ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-monsters-checkbox" name="world.monsters.enabled" />
                                <label for="world-monsters-checkbox" class="checkbox-label">æ€ªç‰©è®¾å®š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-npcs-checkbox" name="world.npcs.enabled" />
                                <label for="world-npcs-checkbox" class="checkbox-label">NPCç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-factions-checkbox" name="world.factions.enabled" />
                                <label for="world-factions-checkbox" class="checkbox-label">åŠ¿åŠ›é˜µè¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-conflicts-checkbox" name="world.conflicts.enabled" />
                                <label for="world-conflicts-checkbox" class="checkbox-label">å†²çªçŸ›ç›¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-alliances-checkbox" name="world.alliances.enabled" />
                                <label for="world-alliances-checkbox" class="checkbox-label">è”ç›Ÿå…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-wars-checkbox" name="world.wars.enabled" />
                                <label for="world-wars-checkbox" class="checkbox-label">æˆ˜äº‰å†å²</label>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„æºç‰©å“ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-resources-checkbox" name="world.resources.enabled" />
                                <label for="world-resources-checkbox" class="checkbox-label">è‡ªç„¶èµ„æº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-materials-checkbox" name="world.materials.enabled" />
                                <label for="world-materials-checkbox" class="checkbox-label">ææ–™ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-artifacts-checkbox" name="world.artifacts.enabled" />
                                <label for="world-artifacts-checkbox" class="checkbox-label">ç¥å™¨å®ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-currency-checkbox" name="world.currency.enabled" />
                                <label for="world-currency-checkbox" class="checkbox-label">è´§å¸ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-trade-checkbox" name="world.trade.enabled" />
                                <label for="world-trade-checkbox" class="checkbox-label">è´¸æ˜“ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-markets-checkbox" name="world.markets.enabled" />
                                <label for="world-markets-checkbox" class="checkbox-label">å¸‚åœºå•†åº—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-guilds-checkbox" name="world.guilds.enabled" />
                                <label for="world-guilds-checkbox" class="checkbox-label">å…¬ä¼šç»„ç»‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="world-transportation-checkbox" name="world.transportation.enabled" />
                                <label for="world-transportation-checkbox" class="checkbox-label">äº¤é€šè¿è¾“</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºç»„ç»‡ä¿¡æ¯é¢æ¿
     */
    createOrganizationPanel() {
        return `
            <div class="content-header">
                <h3>ç»„ç»‡ä¿¡æ¯é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ç»„ç»‡ä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ›ï¸</div>
                            <div class="card-text">
                                <div class="card-title">ç»„ç»‡ä¿¡æ¯</div>
                                <div class="card-subtitle">ç»„ç»‡ç®¡ç†å’Œæˆå‘˜å…³ç³»</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="organization-toggle" name="organization.enabled" checked />
                                <label for="organization-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">16/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-name-checkbox" name="organization.name.enabled" checked />
                                <label for="org-name-checkbox" class="checkbox-label">ç»„ç»‡åç§°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-type-checkbox" name="organization.type.enabled" checked />
                                <label for="org-type-checkbox" class="checkbox-label">ç»„ç»‡ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-description-checkbox" name="organization.description.enabled" checked />
                                <label for="org-description-checkbox" class="checkbox-label">ç»„ç»‡æè¿°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-purpose-checkbox" name="organization.purpose.enabled" />
                                <label for="org-purpose-checkbox" class="checkbox-label">ç»„ç»‡ç›®æ ‡</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-history-checkbox" name="organization.history.enabled" />
                                <label for="org-history-checkbox" class="checkbox-label">ç»„ç»‡å†å²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-founding-checkbox" name="organization.founding.enabled" />
                                <label for="org-founding-checkbox" class="checkbox-label">æˆç«‹èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-motto-checkbox" name="organization.motto.enabled" />
                                <label for="org-motto-checkbox" class="checkbox-label">ç»„ç»‡æ ¼è¨€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-values-checkbox" name="organization.values.enabled" />
                                <label for="org-values-checkbox" class="checkbox-label">æ ¸å¿ƒä»·å€¼</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç»„ç»‡ç»“æ„ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-hierarchy-checkbox" name="organization.hierarchy.enabled" checked />
                                <label for="org-hierarchy-checkbox" class="checkbox-label">ç­‰çº§åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-departments-checkbox" name="organization.departments.enabled" />
                                <label for="org-departments-checkbox" class="checkbox-label">éƒ¨é—¨åˆ†å·¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-leadership-checkbox" name="organization.leadership.enabled" />
                                <label for="org-leadership-checkbox" class="checkbox-label">é¢†å¯¼å±‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-council-checkbox" name="organization.council.enabled" />
                                <label for="org-council-checkbox" class="checkbox-label">è®®äº‹ä¼š</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-positions-checkbox" name="organization.positions.enabled" checked />
                                <label for="org-positions-checkbox" class="checkbox-label">èŒä½ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-ranks-checkbox" name="organization.ranks.enabled" />
                                <label for="org-ranks-checkbox" class="checkbox-label">ç­‰çº§åˆ’åˆ†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-promotion-checkbox" name="organization.promotion.enabled" />
                                <label for="org-promotion-checkbox" class="checkbox-label">æ™‹å‡åˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-authority-checkbox" name="organization.authority.enabled" />
                                <label for="org-authority-checkbox" class="checkbox-label">æƒé™ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <!-- æˆå‘˜ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-members-checkbox" name="organization.members.enabled" checked />
                                <label for="org-members-checkbox" class="checkbox-label">æˆå‘˜åå•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-recruitment-checkbox" name="organization.recruitment.enabled" />
                                <label for="org-recruitment-checkbox" class="checkbox-label">æ‹›å‹Ÿåˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-training-checkbox" name="organization.training.enabled" />
                                <label for="org-training-checkbox" class="checkbox-label">åŸ¹è®­ä½“ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-evaluation-checkbox" name="organization.evaluation.enabled" />
                                <label for="org-evaluation-checkbox" class="checkbox-label">è€ƒæ ¸è¯„ä¼°</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-rewards-checkbox" name="organization.rewards.enabled" />
                                <label for="org-rewards-checkbox" class="checkbox-label">å¥–åŠ±æœºåˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-punishment-checkbox" name="organization.punishment.enabled" />
                                <label for="org-punishment-checkbox" class="checkbox-label">æƒ©ç½šåˆ¶åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-benefits-checkbox" name="organization.benefits.enabled" />
                                <label for="org-benefits-checkbox" class="checkbox-label">ç¦åˆ©å¾…é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-retirement-checkbox" name="organization.retirement.enabled" />
                                <label for="org-retirement-checkbox" class="checkbox-label">é€€ä¼‘åˆ¶åº¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§„ç« åˆ¶åº¦ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-rules-checkbox" name="organization.rules.enabled" />
                                <label for="org-rules-checkbox" class="checkbox-label">ç»„ç»‡è§„ç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-code-checkbox" name="organization.code.enabled" />
                                <label for="org-code-checkbox" class="checkbox-label">è¡Œä¸ºå‡†åˆ™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-ethics-checkbox" name="organization.ethics.enabled" />
                                <label for="org-ethics-checkbox" class="checkbox-label">é“å¾·æ ‡å‡†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-discipline-checkbox" name="organization.discipline.enabled" />
                                <label for="org-discipline-checkbox" class="checkbox-label">çºªå¾‹è¦æ±‚</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-procedures-checkbox" name="organization.procedures.enabled" />
                                <label for="org-procedures-checkbox" class="checkbox-label">å·¥ä½œæµç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-protocols-checkbox" name="organization.protocols.enabled" />
                                <label for="org-protocols-checkbox" class="checkbox-label">æ“ä½œè§„ç¨‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-standards-checkbox" name="organization.standards.enabled" />
                                <label for="org-standards-checkbox" class="checkbox-label">è´¨é‡æ ‡å‡†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-compliance-checkbox" name="organization.compliance.enabled" />
                                <label for="org-compliance-checkbox" class="checkbox-label">åˆè§„è¦æ±‚</label>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¹å¤–å…³ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-allies-checkbox" name="organization.allies.enabled" />
                                <label for="org-allies-checkbox" class="checkbox-label">ç›Ÿå‹ç»„ç»‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-enemies-checkbox" name="organization.enemies.enabled" />
                                <label for="org-enemies-checkbox" class="checkbox-label">æ•Œå¯¹åŠ¿åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-neutral-checkbox" name="organization.neutral.enabled" />
                                <label for="org-neutral-checkbox" class="checkbox-label">ä¸­ç«‹å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-partnerships-checkbox" name="organization.partnerships.enabled" />
                                <label for="org-partnerships-checkbox" class="checkbox-label">åˆä½œä¼™ä¼´</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-reputation-checkbox" name="organization.reputation.enabled" />
                                <label for="org-reputation-checkbox" class="checkbox-label">å£°èª‰å½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-influence-checkbox" name="organization.influence.enabled" />
                                <label for="org-influence-checkbox" class="checkbox-label">åŠ¿åŠ›èŒƒå›´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-diplomacy-checkbox" name="organization.diplomacy.enabled" />
                                <label for="org-diplomacy-checkbox" class="checkbox-label">å¤–äº¤æ”¿ç­–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-treaties-checkbox" name="organization.treaties.enabled" />
                                <label for="org-treaties-checkbox" class="checkbox-label">æ¡çº¦åè®®</label>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„æºç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-finances-checkbox" name="organization.finances.enabled" />
                                <label for="org-finances-checkbox" class="checkbox-label">è´¢åŠ¡ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-assets-checkbox" name="organization.assets.enabled" />
                                <label for="org-assets-checkbox" class="checkbox-label">èµ„äº§æ¸…å•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-facilities-checkbox" name="organization.facilities.enabled" />
                                <label for="org-facilities-checkbox" class="checkbox-label">è®¾æ–½åœºæ‰€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-equipment-checkbox" name="organization.equipment.enabled" />
                                <label for="org-equipment-checkbox" class="checkbox-label">è£…å¤‡å™¨æ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-technology-checkbox" name="organization.technology.enabled" />
                                <label for="org-technology-checkbox" class="checkbox-label">æŠ€æœ¯èµ„æº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-knowledge-checkbox" name="organization.knowledge.enabled" />
                                <label for="org-knowledge-checkbox" class="checkbox-label">çŸ¥è¯†åº“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-archives-checkbox" name="organization.archives.enabled" />
                                <label for="org-archives-checkbox" class="checkbox-label">æ¡£æ¡ˆè®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="org-secrets-checkbox" name="organization.secrets.enabled" />
                                <label for="org-secrets-checkbox" class="checkbox-label">æœºå¯†ä¿¡æ¯</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèµ„è®¯å†…å®¹é¢æ¿
     */
    createNewsPanel() {
        return `
            <div class="content-header">
                <h3>èµ„è®¯å†…å®¹é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èµ„è®¯å†…å®¹å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“°</div>
                            <div class="card-text">
                                <div class="card-title">èµ„è®¯å†…å®¹</div>
                                <div class="card-subtitle">ä¿¡æ¯ç®¡ç†å’Œå†…å®¹åˆ†å‘</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="news-toggle" name="news.enabled" checked />
                                <label for="news-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">20/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- å†…å®¹ç±»å‹ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-breaking-checkbox" name="news.breaking.enabled" checked />
                                <label for="news-breaking-checkbox" class="checkbox-label">çªå‘æ–°é—»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-politics-checkbox" name="news.politics.enabled" checked />
                                <label for="news-politics-checkbox" class="checkbox-label">æ”¿æ²»æ–°é—»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-economy-checkbox" name="news.economy.enabled" checked />
                                <label for="news-economy-checkbox" class="checkbox-label">ç»æµèµ„è®¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-social-checkbox" name="news.social.enabled" />
                                <label for="news-social-checkbox" class="checkbox-label">ç¤¾ä¼šæ–°é—»</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-military-checkbox" name="news.military.enabled" />
                                <label for="news-military-checkbox" class="checkbox-label">å†›äº‹åŠ¨æ€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-technology-checkbox" name="news.technology.enabled" />
                                <label for="news-technology-checkbox" class="checkbox-label">ç§‘æŠ€èµ„è®¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-culture-checkbox" name="news.culture.enabled" />
                                <label for="news-culture-checkbox" class="checkbox-label">æ–‡åŒ–è‰ºæœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-sports-checkbox" name="news.sports.enabled" />
                                <label for="news-sports-checkbox" class="checkbox-label">ä½“è‚²èµ›äº‹</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯æ¥æº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-official-checkbox" name="news.official.enabled" checked />
                                <label for="news-official-checkbox" class="checkbox-label">å®˜æ–¹æ¶ˆæ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-media-checkbox" name="news.media.enabled" />
                                <label for="news-media-checkbox" class="checkbox-label">åª’ä½“æŠ¥é“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-rumors-checkbox" name="news.rumors.enabled" />
                                <label for="news-rumors-checkbox" class="checkbox-label">ä¼ è¨€æ¶ˆæ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-insider-checkbox" name="news.insider.enabled" />
                                <label for="news-insider-checkbox" class="checkbox-label">å†…éƒ¨æ¶ˆæ¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-witness-checkbox" name="news.witness.enabled" />
                                <label for="news-witness-checkbox" class="checkbox-label">ç›®å‡»æŠ¥å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-intelligence-checkbox" name="news.intelligence.enabled" />
                                <label for="news-intelligence-checkbox" class="checkbox-label">æƒ…æŠ¥ä¿¡æ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-leaked-checkbox" name="news.leaked.enabled" />
                                <label for="news-leaked-checkbox" class="checkbox-label">æ³„éœ²æ–‡ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-anonymous-checkbox" name="news.anonymous.enabled" />
                                <label for="news-anonymous-checkbox" class="checkbox-label">åŒ¿åçˆ†æ–™</label>
                            </div>
                        </div>
                    </div>

                    <!-- å†…å®¹ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-creation-checkbox" name="news.creation.enabled" checked />
                                <label for="news-creation-checkbox" class="checkbox-label">å†…å®¹åˆ›å»º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-editing-checkbox" name="news.editing.enabled" />
                                <label for="news-editing-checkbox" class="checkbox-label">å†…å®¹ç¼–è¾‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-review-checkbox" name="news.review.enabled" />
                                <label for="news-review-checkbox" class="checkbox-label">å†…å®¹å®¡æ ¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-publishing-checkbox" name="news.publishing.enabled" />
                                <label for="news-publishing-checkbox" class="checkbox-label">å†…å®¹å‘å¸ƒ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-archiving-checkbox" name="news.archiving.enabled" />
                                <label for="news-archiving-checkbox" class="checkbox-label">å†…å®¹å½’æ¡£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-deletion-checkbox" name="news.deletion.enabled" />
                                <label for="news-deletion-checkbox" class="checkbox-label">å†…å®¹åˆ é™¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-backup-checkbox" name="news.backup.enabled" />
                                <label for="news-backup-checkbox" class="checkbox-label">å†…å®¹å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-versioning-checkbox" name="news.versioning.enabled" />
                                <label for="news-versioning-checkbox" class="checkbox-label">ç‰ˆæœ¬æ§åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†å‘æ¸ é“ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-broadcast-checkbox" name="news.broadcast.enabled" />
                                <label for="news-broadcast-checkbox" class="checkbox-label">å¹¿æ’­å‘å¸ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-newsletter-checkbox" name="news.newsletter.enabled" />
                                <label for="news-newsletter-checkbox" class="checkbox-label">æ–°é—»ç®€æŠ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-alerts-checkbox" name="news.alerts.enabled" />
                                <label for="news-alerts-checkbox" class="checkbox-label">ç´§æ€¥é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-digest-checkbox" name="news.digest.enabled" />
                                <label for="news-digest-checkbox" class="checkbox-label">æ–°é—»æ‘˜è¦</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-social-media-checkbox" name="news.socialMedia.enabled" />
                                <label for="news-social-media-checkbox" class="checkbox-label">ç¤¾äº¤åª’ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-forums-checkbox" name="news.forums.enabled" />
                                <label for="news-forums-checkbox" class="checkbox-label">è®ºå›å‘å¸ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-messaging-checkbox" name="news.messaging.enabled" />
                                <label for="news-messaging-checkbox" class="checkbox-label">æ¶ˆæ¯æ¨é€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-email-checkbox" name="news.email.enabled" />
                                <label for="news-email-checkbox" class="checkbox-label">é‚®ä»¶é€šçŸ¥</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº’åŠ¨åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-comments-checkbox" name="news.comments.enabled" />
                                <label for="news-comments-checkbox" class="checkbox-label">è¯„è®ºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-likes-checkbox" name="news.likes.enabled" />
                                <label for="news-likes-checkbox" class="checkbox-label">ç‚¹èµåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-sharing-checkbox" name="news.sharing.enabled" />
                                <label for="news-sharing-checkbox" class="checkbox-label">åˆ†äº«åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-bookmarks-checkbox" name="news.bookmarks.enabled" />
                                <label for="news-bookmarks-checkbox" class="checkbox-label">æ”¶è—åŠŸèƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-ratings-checkbox" name="news.ratings.enabled" />
                                <label for="news-ratings-checkbox" class="checkbox-label">è¯„åˆ†ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-polls-checkbox" name="news.polls.enabled" />
                                <label for="news-polls-checkbox" class="checkbox-label">æŠ•ç¥¨è°ƒæŸ¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-discussions-checkbox" name="news.discussions.enabled" />
                                <label for="news-discussions-checkbox" class="checkbox-label">è®¨è®ºåŒº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-feedback-checkbox" name="news.feedback.enabled" />
                                <label for="news-feedback-checkbox" class="checkbox-label">åé¦ˆç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®åˆ†æ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-analytics-checkbox" name="news.analytics.enabled" />
                                <label for="news-analytics-checkbox" class="checkbox-label">æ•°æ®åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-metrics-checkbox" name="news.metrics.enabled" />
                                <label for="news-metrics-checkbox" class="checkbox-label">æŒ‡æ ‡ç»Ÿè®¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-trends-checkbox" name="news.trends.enabled" />
                                <label for="news-trends-checkbox" class="checkbox-label">è¶‹åŠ¿åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-reports-checkbox" name="news.reports.enabled" />
                                <label for="news-reports-checkbox" class="checkbox-label">æŠ¥å‘Šç”Ÿæˆ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-monitoring-checkbox" name="news.monitoring.enabled" />
                                <label for="news-monitoring-checkbox" class="checkbox-label">ç›‘æ§ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-alerts-system-checkbox" name="news.alertsSystem.enabled" />
                                <label for="news-alerts-system-checkbox" class="checkbox-label">é¢„è­¦ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-automation-checkbox" name="news.automation.enabled" />
                                <label for="news-automation-checkbox" class="checkbox-label">è‡ªåŠ¨åŒ–å¤„ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="news-ai-analysis-checkbox" name="news.aiAnalysis.enabled" />
                                <label for="news-ai-analysis-checkbox" class="checkbox-label">AIåˆ†æ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèƒŒåŒ…ä»“åº“é¢æ¿
     */
    createInventoryPanel() {
        return `
            <div class="content-header">
                <h3>èƒŒåŒ…ä»“åº“é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èƒŒåŒ…ä»“åº“å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ’</div>
                            <div class="card-text">
                                <div class="card-title">èƒŒåŒ…ä»“åº“</div>
                                <div class="card-subtitle">ç‰©å“ç®¡ç†å’Œå­˜å‚¨ç³»ç»Ÿ</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="inventory-toggle" name="inventory.enabled" checked />
                                <label for="inventory-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">22/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-storage-checkbox" name="inventory.storage.enabled" checked />
                                <label for="inventory-storage-checkbox" class="checkbox-label">ç‰©å“å­˜å‚¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-retrieval-checkbox" name="inventory.retrieval.enabled" checked />
                                <label for="inventory-retrieval-checkbox" class="checkbox-label">ç‰©å“å–å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-organization-checkbox" name="inventory.organization.enabled" checked />
                                <label for="inventory-organization-checkbox" class="checkbox-label">ç‰©å“æ•´ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-search-checkbox" name="inventory.search.enabled" />
                                <label for="inventory-search-checkbox" class="checkbox-label">ç‰©å“æœç´¢</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sorting-checkbox" name="inventory.sorting.enabled" />
                                <label for="inventory-sorting-checkbox" class="checkbox-label">è‡ªåŠ¨æ’åº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-filtering-checkbox" name="inventory.filtering.enabled" />
                                <label for="inventory-filtering-checkbox" class="checkbox-label">ç‰©å“ç­›é€‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-categories-checkbox" name="inventory.categories.enabled" />
                                <label for="inventory-categories-checkbox" class="checkbox-label">åˆ†ç±»ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-tags-checkbox" name="inventory.tags.enabled" />
                                <label for="inventory-tags-checkbox" class="checkbox-label">æ ‡ç­¾ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰©å“ç±»å‹ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-weapons-checkbox" name="inventory.weapons.enabled" checked />
                                <label for="inventory-weapons-checkbox" class="checkbox-label">æ­¦å™¨è£…å¤‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-armor-checkbox" name="inventory.armor.enabled" checked />
                                <label for="inventory-armor-checkbox" class="checkbox-label">é˜²å…·æŠ¤ç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-accessories-checkbox" name="inventory.accessories.enabled" />
                                <label for="inventory-accessories-checkbox" class="checkbox-label">é¥°å“é…ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-consumables-checkbox" name="inventory.consumables.enabled" />
                                <label for="inventory-consumables-checkbox" class="checkbox-label">æ¶ˆè€—å“</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-materials-checkbox" name="inventory.materials.enabled" />
                                <label for="inventory-materials-checkbox" class="checkbox-label">ææ–™ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-tools-checkbox" name="inventory.tools.enabled" />
                                <label for="inventory-tools-checkbox" class="checkbox-label">å·¥å…·å™¨æ¢°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-books-checkbox" name="inventory.books.enabled" />
                                <label for="inventory-books-checkbox" class="checkbox-label">ä¹¦ç±æ–‡çŒ®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-treasures-checkbox" name="inventory.treasures.enabled" />
                                <label for="inventory-treasures-checkbox" class="checkbox-label">çå®æ”¶è—</label>
                            </div>
                        </div>
                    </div>

                    <!-- å­˜å‚¨ç®¡ç† -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-capacity-checkbox" name="inventory.capacity.enabled" checked />
                                <label for="inventory-capacity-checkbox" class="checkbox-label">å®¹é‡ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-weight-checkbox" name="inventory.weight.enabled" />
                                <label for="inventory-weight-checkbox" class="checkbox-label">é‡é‡é™åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-stacking-checkbox" name="inventory.stacking.enabled" />
                                <label for="inventory-stacking-checkbox" class="checkbox-label">ç‰©å“å †å </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-expansion-checkbox" name="inventory.expansion.enabled" />
                                <label for="inventory-expansion-checkbox" class="checkbox-label">å®¹é‡æ‰©å±•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-compartments-checkbox" name="inventory.compartments.enabled" />
                                <label for="inventory-compartments-checkbox" class="checkbox-label">åˆ†éš”åŒºåŸŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-protection-checkbox" name="inventory.protection.enabled" />
                                <label for="inventory-protection-checkbox" class="checkbox-label">ç‰©å“ä¿æŠ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-durability-checkbox" name="inventory.durability.enabled" />
                                <label for="inventory-durability-checkbox" class="checkbox-label">è€ä¹…åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-repair-checkbox" name="inventory.repair.enabled" />
                                <label for="inventory-repair-checkbox" class="checkbox-label">ä¿®ç†ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤æ˜“åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-trading-checkbox" name="inventory.trading.enabled" />
                                <label for="inventory-trading-checkbox" class="checkbox-label">ç‰©å“äº¤æ˜“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-selling-checkbox" name="inventory.selling.enabled" />
                                <label for="inventory-selling-checkbox" class="checkbox-label">ç‰©å“å‡ºå”®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-buying-checkbox" name="inventory.buying.enabled" />
                                <label for="inventory-buying-checkbox" class="checkbox-label">ç‰©å“è´­ä¹°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-auction-checkbox" name="inventory.auction.enabled" />
                                <label for="inventory-auction-checkbox" class="checkbox-label">æ‹å–ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-gifting-checkbox" name="inventory.gifting.enabled" />
                                <label for="inventory-gifting-checkbox" class="checkbox-label">ç‰©å“èµ é€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-lending-checkbox" name="inventory.lending.enabled" />
                                <label for="inventory-lending-checkbox" class="checkbox-label">ç‰©å“å€Ÿè´·</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sharing-checkbox" name="inventory.sharing.enabled" />
                                <label for="inventory-sharing-checkbox" class="checkbox-label">ç‰©å“å…±äº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-banking-checkbox" name="inventory.banking.enabled" />
                                <label for="inventory-banking-checkbox" class="checkbox-label">é“¶è¡Œå­˜å‚¨</label>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ¶ä½œç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-crafting-checkbox" name="inventory.crafting.enabled" />
                                <label for="inventory-crafting-checkbox" class="checkbox-label">ç‰©å“åˆ¶ä½œ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recipes-checkbox" name="inventory.recipes.enabled" />
                                <label for="inventory-recipes-checkbox" class="checkbox-label">é…æ–¹ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-enhancement-checkbox" name="inventory.enhancement.enabled" />
                                <label for="inventory-enhancement-checkbox" class="checkbox-label">ç‰©å“å¼ºåŒ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-enchanting-checkbox" name="inventory.enchanting.enabled" />
                                <label for="inventory-enchanting-checkbox" class="checkbox-label">é™„é­”ç³»ç»Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-upgrading-checkbox" name="inventory.upgrading.enabled" />
                                <label for="inventory-upgrading-checkbox" class="checkbox-label">ç‰©å“å‡çº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-combining-checkbox" name="inventory.combining.enabled" />
                                <label for="inventory-combining-checkbox" class="checkbox-label">ç‰©å“åˆæˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-dismantling-checkbox" name="inventory.dismantling.enabled" />
                                <label for="inventory-dismantling-checkbox" class="checkbox-label">ç‰©å“åˆ†è§£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recycling-checkbox" name="inventory.recycling.enabled" />
                                <label for="inventory-recycling-checkbox" class="checkbox-label">å›æ”¶åˆ©ç”¨</label>
                            </div>
                        </div>
                    </div>

                    <!-- é«˜çº§åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-automation-checkbox" name="inventory.automation.enabled" />
                                <label for="inventory-automation-checkbox" class="checkbox-label">è‡ªåŠ¨åŒ–ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-ai-sorting-checkbox" name="inventory.aiSorting.enabled" />
                                <label for="inventory-ai-sorting-checkbox" class="checkbox-label">æ™ºèƒ½æ’åº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-recommendations-checkbox" name="inventory.recommendations.enabled" />
                                <label for="inventory-recommendations-checkbox" class="checkbox-label">æ¨èç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-analytics-checkbox" name="inventory.analytics.enabled" />
                                <label for="inventory-analytics-checkbox" class="checkbox-label">ä½¿ç”¨åˆ†æ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-backup-checkbox" name="inventory.backup.enabled" />
                                <label for="inventory-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-sync-checkbox" name="inventory.sync.enabled" />
                                <label for="inventory-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-security-checkbox" name="inventory.security.enabled" />
                                <label for="inventory-security-checkbox" class="checkbox-label">å®‰å…¨ä¿æŠ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="inventory-history-checkbox" name="inventory.history.enabled" />
                                <label for="inventory-history-checkbox" class="checkbox-label">æ“ä½œå†å²</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºèƒ½åŠ›ç³»ç»Ÿé¢æ¿
     */
    createAbilitiesPanel() {
        return `
            <div class="content-header">
                <h3>èƒ½åŠ›ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- èƒ½åŠ›ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">âš¡</div>
                            <div class="card-text">
                                <div class="card-title">èƒ½åŠ›ç³»ç»Ÿ</div>
                                <div class="card-subtitle">æŠ€èƒ½å’Œå±æ€§ç®¡ç†ç³»ç»Ÿ</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="abilities-toggle" name="abilities.enabled" checked />
                                <label for="abilities-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">25/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- åŸºç¡€å±æ€§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-strength-checkbox" name="abilities.strength.enabled" checked />
                                <label for="abilities-strength-checkbox" class="checkbox-label">åŠ›é‡å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-agility-checkbox" name="abilities.agility.enabled" checked />
                                <label for="abilities-agility-checkbox" class="checkbox-label">æ•æ·å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-intelligence-checkbox" name="abilities.intelligence.enabled" checked />
                                <label for="abilities-intelligence-checkbox" class="checkbox-label">æ™ºåŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-constitution-checkbox" name="abilities.constitution.enabled" />
                                <label for="abilities-constitution-checkbox" class="checkbox-label">ä½“è´¨å±æ€§</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-wisdom-checkbox" name="abilities.wisdom.enabled" />
                                <label for="abilities-wisdom-checkbox" class="checkbox-label">æ™ºæ…§å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-charisma-checkbox" name="abilities.charisma.enabled" />
                                <label for="abilities-charisma-checkbox" class="checkbox-label">é­…åŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-luck-checkbox" name="abilities.luck.enabled" />
                                <label for="abilities-luck-checkbox" class="checkbox-label">å¹¸è¿å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-perception-checkbox" name="abilities.perception.enabled" />
                                <label for="abilities-perception-checkbox" class="checkbox-label">æ„ŸçŸ¥å±æ€§</label>
                            </div>
                        </div>
                    </div>

                    <!-- æˆ˜æ–—æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-swordsmanship-checkbox" name="abilities.swordsmanship.enabled" checked />
                                <label for="abilities-swordsmanship-checkbox" class="checkbox-label">å‰‘æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-archery-checkbox" name="abilities.archery.enabled" />
                                <label for="abilities-archery-checkbox" class="checkbox-label">å¼“ç®­æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-magic-checkbox" name="abilities.magic.enabled" checked />
                                <label for="abilities-magic-checkbox" class="checkbox-label">é­”æ³•æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-defense-checkbox" name="abilities.defense.enabled" />
                                <label for="abilities-defense-checkbox" class="checkbox-label">é˜²å¾¡æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-martial-arts-checkbox" name="abilities.martialArts.enabled" />
                                <label for="abilities-martial-arts-checkbox" class="checkbox-label">æ­¦æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-stealth-checkbox" name="abilities.stealth.enabled" />
                                <label for="abilities-stealth-checkbox" class="checkbox-label">æ½œè¡ŒæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-tactics-checkbox" name="abilities.tactics.enabled" />
                                <label for="abilities-tactics-checkbox" class="checkbox-label">æˆ˜æœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-healing-checkbox" name="abilities.healing.enabled" />
                                <label for="abilities-healing-checkbox" class="checkbox-label">æ²»ç–—æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿæ´»æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-crafting-checkbox" name="abilities.crafting.enabled" />
                                <label for="abilities-crafting-checkbox" class="checkbox-label">åˆ¶ä½œæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-cooking-checkbox" name="abilities.cooking.enabled" />
                                <label for="abilities-cooking-checkbox" class="checkbox-label">çƒ¹é¥ªæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-farming-checkbox" name="abilities.farming.enabled" />
                                <label for="abilities-farming-checkbox" class="checkbox-label">å†œä¸šæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-mining-checkbox" name="abilities.mining.enabled" />
                                <label for="abilities-mining-checkbox" class="checkbox-label">é‡‡çŸ¿æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-fishing-checkbox" name="abilities.fishing.enabled" />
                                <label for="abilities-fishing-checkbox" class="checkbox-label">é’“é±¼æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-hunting-checkbox" name="abilities.hunting.enabled" />
                                <label for="abilities-hunting-checkbox" class="checkbox-label">ç‹©çŒæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-trading-checkbox" name="abilities.trading.enabled" />
                                <label for="abilities-trading-checkbox" class="checkbox-label">äº¤æ˜“æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-negotiation-checkbox" name="abilities.negotiation.enabled" />
                                <label for="abilities-negotiation-checkbox" class="checkbox-label">è°ˆåˆ¤æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- çŸ¥è¯†æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-research-checkbox" name="abilities.research.enabled" />
                                <label for="abilities-research-checkbox" class="checkbox-label">ç ”ç©¶æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-investigation-checkbox" name="abilities.investigation.enabled" />
                                <label for="abilities-investigation-checkbox" class="checkbox-label">è°ƒæŸ¥æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-languages-checkbox" name="abilities.languages.enabled" />
                                <label for="abilities-languages-checkbox" class="checkbox-label">è¯­è¨€æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-history-checkbox" name="abilities.history.enabled" />
                                <label for="abilities-history-checkbox" class="checkbox-label">å†å²çŸ¥è¯†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-medicine-checkbox" name="abilities.medicine.enabled" />
                                <label for="abilities-medicine-checkbox" class="checkbox-label">åŒ»å­¦çŸ¥è¯†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-alchemy-checkbox" name="abilities.alchemy.enabled" />
                                <label for="abilities-alchemy-checkbox" class="checkbox-label">ç‚¼é‡‘æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-engineering-checkbox" name="abilities.engineering.enabled" />
                                <label for="abilities-engineering-checkbox" class="checkbox-label">å·¥ç¨‹å­¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-astronomy-checkbox" name="abilities.astronomy.enabled" />
                                <label for="abilities-astronomy-checkbox" class="checkbox-label">å¤©æ–‡å­¦</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¤¾äº¤æŠ€èƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-persuasion-checkbox" name="abilities.persuasion.enabled" />
                                <label for="abilities-persuasion-checkbox" class="checkbox-label">è¯´æœæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-deception-checkbox" name="abilities.deception.enabled" />
                                <label for="abilities-deception-checkbox" class="checkbox-label">æ¬ºéª—æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-intimidation-checkbox" name="abilities.intimidation.enabled" />
                                <label for="abilities-intimidation-checkbox" class="checkbox-label">å¨å“æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-performance-checkbox" name="abilities.performance.enabled" />
                                <label for="abilities-performance-checkbox" class="checkbox-label">è¡¨æ¼”æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-leadership-checkbox" name="abilities.leadership.enabled" />
                                <label for="abilities-leadership-checkbox" class="checkbox-label">é¢†å¯¼æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-empathy-checkbox" name="abilities.empathy.enabled" />
                                <label for="abilities-empathy-checkbox" class="checkbox-label">å…±æƒ…æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-insight-checkbox" name="abilities.insight.enabled" />
                                <label for="abilities-insight-checkbox" class="checkbox-label">æ´å¯ŸæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-networking-checkbox" name="abilities.networking.enabled" />
                                <label for="abilities-networking-checkbox" class="checkbox-label">äººè„‰æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç‰¹æ®Šèƒ½åŠ› -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-telepathy-checkbox" name="abilities.telepathy.enabled" />
                                <label for="abilities-telepathy-checkbox" class="checkbox-label">å¿ƒçµæ„Ÿåº”</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-telekinesis-checkbox" name="abilities.telekinesis.enabled" />
                                <label for="abilities-telekinesis-checkbox" class="checkbox-label">å¿µåŠ›ç§»ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-precognition-checkbox" name="abilities.precognition.enabled" />
                                <label for="abilities-precognition-checkbox" class="checkbox-label">é¢„çŸ¥èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-shapeshifting-checkbox" name="abilities.shapeshifting.enabled" />
                                <label for="abilities-shapeshifting-checkbox" class="checkbox-label">å˜å½¢èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-invisibility-checkbox" name="abilities.invisibility.enabled" />
                                <label for="abilities-invisibility-checkbox" class="checkbox-label">éšèº«èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-flight-checkbox" name="abilities.flight.enabled" />
                                <label for="abilities-flight-checkbox" class="checkbox-label">é£è¡Œèƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-regeneration-checkbox" name="abilities.regeneration.enabled" />
                                <label for="abilities-regeneration-checkbox" class="checkbox-label">å†ç”Ÿèƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="abilities-immortality-checkbox" name="abilities.immortality.enabled" />
                                <label for="abilities-immortality-checkbox" class="checkbox-label">ä¸æœ½èƒ½åŠ›</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºå‰§æƒ…é¢æ¿
     */
    createPlotPanel() {
        return `
            <div class="content-header">
                <h3>å‰§æƒ…é¢æ¿é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- å‰§æƒ…é¢æ¿å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ“–</div>
                            <div class="card-text">
                                <div class="card-title">å‰§æƒ…é¢æ¿</div>
                                <div class="card-subtitle">æ•…äº‹æƒ…èŠ‚å’Œå™äº‹ç®¡ç†</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="plot-toggle" name="plot.enabled" checked />
                                <label for="plot-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">18/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- å‰§æƒ…ç»“æ„ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-main-story-checkbox" name="plot.mainStory.enabled" checked />
                                <label for="plot-main-story-checkbox" class="checkbox-label">ä¸»çº¿å‰§æƒ…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-side-quests-checkbox" name="plot.sideQuests.enabled" checked />
                                <label for="plot-side-quests-checkbox" class="checkbox-label">æ”¯çº¿ä»»åŠ¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-subplots-checkbox" name="plot.subplots.enabled" checked />
                                <label for="plot-subplots-checkbox" class="checkbox-label">å­æƒ…èŠ‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-backstory-checkbox" name="plot.backstory.enabled" />
                                <label for="plot-backstory-checkbox" class="checkbox-label">èƒŒæ™¯æ•…äº‹</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-prologue-checkbox" name="plot.prologue.enabled" />
                                <label for="plot-prologue-checkbox" class="checkbox-label">åºç« </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-epilogue-checkbox" name="plot.epilogue.enabled" />
                                <label for="plot-epilogue-checkbox" class="checkbox-label">å°¾å£°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-flashbacks-checkbox" name="plot.flashbacks.enabled" />
                                <label for="plot-flashbacks-checkbox" class="checkbox-label">å›å¿†ç‰‡æ®µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-foreshadowing-checkbox" name="plot.foreshadowing.enabled" />
                                <label for="plot-foreshadowing-checkbox" class="checkbox-label">ä¼ç¬”é“ºå«</label>
                            </div>
                        </div>
                    </div>

                    <!-- å‰§æƒ…é˜¶æ®µ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-exposition-checkbox" name="plot.exposition.enabled" checked />
                                <label for="plot-exposition-checkbox" class="checkbox-label">å¼€ç«¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-rising-action-checkbox" name="plot.risingAction.enabled" />
                                <label for="plot-rising-action-checkbox" class="checkbox-label">å‘å±•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-climax-checkbox" name="plot.climax.enabled" />
                                <label for="plot-climax-checkbox" class="checkbox-label">é«˜æ½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-falling-action-checkbox" name="plot.fallingAction.enabled" />
                                <label for="plot-falling-action-checkbox" class="checkbox-label">ä¸‹é™</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-resolution-checkbox" name="plot.resolution.enabled" />
                                <label for="plot-resolution-checkbox" class="checkbox-label">ç»“å±€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-denouement-checkbox" name="plot.denouement.enabled" />
                                <label for="plot-denouement-checkbox" class="checkbox-label">æ”¶å°¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-cliffhanger-checkbox" name="plot.cliffhanger.enabled" />
                                <label for="plot-cliffhanger-checkbox" class="checkbox-label">æ‚¬å¿µç»“å°¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-twist-checkbox" name="plot.twist.enabled" />
                                <label for="plot-twist-checkbox" class="checkbox-label">å‰§æƒ…è½¬æŠ˜</label>
                            </div>
                        </div>
                    </div>

                    <!-- è§’è‰²å‘å±• -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-character-arc-checkbox" name="plot.characterArc.enabled" />
                                <label for="plot-character-arc-checkbox" class="checkbox-label">è§’è‰²æˆé•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-relationships-checkbox" name="plot.relationships.enabled" />
                                <label for="plot-relationships-checkbox" class="checkbox-label">å…³ç³»å‘å±•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-motivations-checkbox" name="plot.motivations.enabled" />
                                <label for="plot-motivations-checkbox" class="checkbox-label">åŠ¨æœºé©±åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-conflicts-checkbox" name="plot.conflicts.enabled" />
                                <label for="plot-conflicts-checkbox" class="checkbox-label">å†²çªçŸ›ç›¾</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-internal-conflicts-checkbox" name="plot.internalConflicts.enabled" />
                                <label for="plot-internal-conflicts-checkbox" class="checkbox-label">å†…å¿ƒå†²çª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-external-conflicts-checkbox" name="plot.externalConflicts.enabled" />
                                <label for="plot-external-conflicts-checkbox" class="checkbox-label">å¤–éƒ¨å†²çª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-moral-dilemmas-checkbox" name="plot.moralDilemmas.enabled" />
                                <label for="plot-moral-dilemmas-checkbox" class="checkbox-label">é“å¾·å›°å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-sacrifices-checkbox" name="plot.sacrifices.enabled" />
                                <label for="plot-sacrifices-checkbox" class="checkbox-label">ç‰ºç‰²é€‰æ‹©</label>
                            </div>
                        </div>
                    </div>

                    <!-- å™äº‹æŠ€å·§ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-dialogue-checkbox" name="plot.dialogue.enabled" />
                                <label for="plot-dialogue-checkbox" class="checkbox-label">å¯¹è¯ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-narration-checkbox" name="plot.narration.enabled" />
                                <label for="plot-narration-checkbox" class="checkbox-label">å™è¿°æå†™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-monologue-checkbox" name="plot.monologue.enabled" />
                                <label for="plot-monologue-checkbox" class="checkbox-label">å†…å¿ƒç‹¬ç™½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-symbolism-checkbox" name="plot.symbolism.enabled" />
                                <label for="plot-symbolism-checkbox" class="checkbox-label">è±¡å¾éšå–»</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-themes-checkbox" name="plot.themes.enabled" />
                                <label for="plot-themes-checkbox" class="checkbox-label">ä¸»é¢˜è¡¨è¾¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-mood-checkbox" name="plot.mood.enabled" />
                                <label for="plot-mood-checkbox" class="checkbox-label">æ°›å›´è¥é€ </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-tone-checkbox" name="plot.tone.enabled" />
                                <label for="plot-tone-checkbox" class="checkbox-label">è¯­è°ƒé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-pacing-checkbox" name="plot.pacing.enabled" />
                                <label for="plot-pacing-checkbox" class="checkbox-label">èŠ‚å¥æ§åˆ¶</label>
                            </div>
                        </div>
                    </div>

                    <!-- äº’åŠ¨å…ƒç´  -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-choices-checkbox" name="plot.choices.enabled" />
                                <label for="plot-choices-checkbox" class="checkbox-label">é€‰æ‹©åˆ†æ”¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-consequences-checkbox" name="plot.consequences.enabled" />
                                <label for="plot-consequences-checkbox" class="checkbox-label">åæœå½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-branching-checkbox" name="plot.branching.enabled" />
                                <label for="plot-branching-checkbox" class="checkbox-label">åˆ†æ”¯å‰§æƒ…</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-multiple-endings-checkbox" name="plot.multipleEndings.enabled" />
                                <label for="plot-multiple-endings-checkbox" class="checkbox-label">å¤šé‡ç»“å±€</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-player-agency-checkbox" name="plot.playerAgency.enabled" />
                                <label for="plot-player-agency-checkbox" class="checkbox-label">ç©å®¶ä¸»å¯¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-emergent-narrative-checkbox" name="plot.emergentNarrative.enabled" />
                                <label for="plot-emergent-narrative-checkbox" class="checkbox-label">æ¶Œç°å™äº‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-procedural-generation-checkbox" name="plot.proceduralGeneration.enabled" />
                                <label for="plot-procedural-generation-checkbox" class="checkbox-label">ç¨‹åºç”Ÿæˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-adaptive-storytelling-checkbox" name="plot.adaptiveStorytelling.enabled" />
                                <label for="plot-adaptive-storytelling-checkbox" class="checkbox-label">è‡ªé€‚åº”å™äº‹</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç®¡ç†åŠŸèƒ½ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-timeline-checkbox" name="plot.timeline.enabled" />
                                <label for="plot-timeline-checkbox" class="checkbox-label">æ—¶é—´çº¿ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-notes-checkbox" name="plot.notes.enabled" />
                                <label for="plot-notes-checkbox" class="checkbox-label">å‰§æƒ…ç¬”è®°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-bookmarks-checkbox" name="plot.bookmarks.enabled" />
                                <label for="plot-bookmarks-checkbox" class="checkbox-label">é‡è¦èŠ‚ç‚¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-save-states-checkbox" name="plot.saveStates.enabled" />
                                <label for="plot-save-states-checkbox" class="checkbox-label">å­˜æ¡£ç®¡ç†</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-auto-save-checkbox" name="plot.autoSave.enabled" />
                                <label for="plot-auto-save-checkbox" class="checkbox-label">è‡ªåŠ¨ä¿å­˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-export-checkbox" name="plot.export.enabled" />
                                <label for="plot-export-checkbox" class="checkbox-label">å¯¼å‡ºåŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-import-checkbox" name="plot.import.enabled" />
                                <label for="plot-import-checkbox" class="checkbox-label">å¯¼å…¥åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="plot-analytics-checkbox" name="plot.analytics.enabled" />
                                <label for="plot-analytics-checkbox" class="checkbox-label">å‰§æƒ…åˆ†æ</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºä¿®ä»™ä¸–ç•Œé¢æ¿
     */
    createCultivationPanel() {
        return `
            <div class="content-header">
                <h3>ä¿®ä»™ä¸–ç•Œé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ä¿®ä»™ä¸–ç•Œå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">âš¡</div>
                            <div class="card-text">
                                <div class="card-title">ä¿®ä»™ä¸–ç•Œ</div>
                                <div class="card-subtitle">ä»™ä¾ ä¿®ç‚¼ä½“ç³»è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="cultivation-toggle" name="cultivation.enabled" checked />
                                <label for="cultivation-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">22/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ä¿®ç‚¼å¢ƒç•Œ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-qi-refining-checkbox" name="cultivation.qiRefining.enabled" checked />
                                <label for="cultivation-qi-refining-checkbox" class="checkbox-label">ç‚¼æ°”æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-foundation-checkbox" name="cultivation.foundation.enabled" checked />
                                <label for="cultivation-foundation-checkbox" class="checkbox-label">ç­‘åŸºæœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-golden-core-checkbox" name="cultivation.goldenCore.enabled" checked />
                                <label for="cultivation-golden-core-checkbox" class="checkbox-label">é‡‘ä¸¹æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-nascent-soul-checkbox" name="cultivation.nascentSoul.enabled" />
                                <label for="cultivation-nascent-soul-checkbox" class="checkbox-label">å…ƒå©´æœŸ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-soul-transformation-checkbox" name="cultivation.soulTransformation.enabled" />
                                <label for="cultivation-soul-transformation-checkbox" class="checkbox-label">åŒ–ç¥æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-void-refinement-checkbox" name="cultivation.voidRefinement.enabled" />
                                <label for="cultivation-void-refinement-checkbox" class="checkbox-label">ç‚¼è™šæœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-body-integration-checkbox" name="cultivation.bodyIntegration.enabled" />
                                <label for="cultivation-body-integration-checkbox" class="checkbox-label">åˆä½“æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-mahayana-checkbox" name="cultivation.mahayana.enabled" />
                                <label for="cultivation-mahayana-checkbox" class="checkbox-label">å¤§ä¹˜æœŸ</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-tribulation-checkbox" name="cultivation.tribulation.enabled" />
                                <label for="cultivation-tribulation-checkbox" class="checkbox-label">æ¸¡åŠ«æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-immortal-checkbox" name="cultivation.immortal.enabled" />
                                <label for="cultivation-immortal-checkbox" class="checkbox-label">ä»™äººå¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-true-immortal-checkbox" name="cultivation.trueImmortal.enabled" />
                                <label for="cultivation-true-immortal-checkbox" class="checkbox-label">çœŸä»™å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-golden-immortal-checkbox" name="cultivation.goldenImmortal.enabled" />
                                <label for="cultivation-golden-immortal-checkbox" class="checkbox-label">é‡‘ä»™å¢ƒ</label>
                            </div>
                        </div>
                    </div>

                    <!-- åŠŸæ³•ä½“ç³» -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-breathing-technique-checkbox" name="cultivation.breathingTechnique.enabled" checked />
                                <label for="cultivation-breathing-technique-checkbox" class="checkbox-label">åçº³åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-body-refining-checkbox" name="cultivation.bodyRefining.enabled" />
                                <label for="cultivation-body-refining-checkbox" class="checkbox-label">ç‚¼ä½“åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-soul-cultivation-checkbox" name="cultivation.soulCultivation.enabled" />
                                <label for="cultivation-soul-cultivation-checkbox" class="checkbox-label">ç¥é­‚åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dual-cultivation-checkbox" name="cultivation.dualCultivation.enabled" />
                                <label for="cultivation-dual-cultivation-checkbox" class="checkbox-label">åŒä¿®åŠŸæ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-sword-cultivation-checkbox" name="cultivation.swordCultivation.enabled" />
                                <label for="cultivation-sword-cultivation-checkbox" class="checkbox-label">å‰‘ä¿®åŠŸæ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-alchemy-checkbox" name="cultivation.alchemy.enabled" />
                                <label for="cultivation-alchemy-checkbox" class="checkbox-label">ç‚¼ä¸¹æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-formation-checkbox" name="cultivation.formation.enabled" />
                                <label for="cultivation-formation-checkbox" class="checkbox-label">é˜µæ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-talisman-checkbox" name="cultivation.talisman.enabled" />
                                <label for="cultivation-talisman-checkbox" class="checkbox-label">ç¬¦ç®“æœ¯</label>
                            </div>
                        </div>
                    </div>

                    <!-- çµåŠ›ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-power-checkbox" name="cultivation.spiritualPower.enabled" checked />
                                <label for="cultivation-spiritual-power-checkbox" class="checkbox-label">çµåŠ›å€¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-root-checkbox" name="cultivation.spiritualRoot.enabled" />
                                <label for="cultivation-spiritual-root-checkbox" class="checkbox-label">çµæ ¹èµ„è´¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-meridians-checkbox" name="cultivation.meridians.enabled" />
                                <label for="cultivation-meridians-checkbox" class="checkbox-label">ç»è„‰ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dantian-checkbox" name="cultivation.dantian.enabled" />
                                <label for="cultivation-dantian-checkbox" class="checkbox-label">ä¸¹ç”°æ°”æµ·</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-divine-sense-checkbox" name="cultivation.divineSense.enabled" />
                                <label for="cultivation-divine-sense-checkbox" class="checkbox-label">ç¥è¯†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-life-span-checkbox" name="cultivation.lifeSpan.enabled" />
                                <label for="cultivation-life-span-checkbox" class="checkbox-label">å¯¿å…ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-karma-checkbox" name="cultivation.karma.enabled" />
                                <label for="cultivation-karma-checkbox" class="checkbox-label">å› æœä¸šåŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-heavenly-dao-checkbox" name="cultivation.heavenlyDao.enabled" />
                                <label for="cultivation-heavenly-dao-checkbox" class="checkbox-label">å¤©é“æ„Ÿæ‚Ÿ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ³•å®è£…å¤‡ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-flying-sword-checkbox" name="cultivation.flyingSword.enabled" />
                                <label for="cultivation-flying-sword-checkbox" class="checkbox-label">é£å‰‘</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-magic-treasure-checkbox" name="cultivation.magicTreasure.enabled" />
                                <label for="cultivation-magic-treasure-checkbox" class="checkbox-label">æ³•å®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spiritual-armor-checkbox" name="cultivation.spiritualArmor.enabled" />
                                <label for="cultivation-spiritual-armor-checkbox" class="checkbox-label">çµç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-storage-ring-checkbox" name="cultivation.storageRing.enabled" />
                                <label for="cultivation-storage-ring-checkbox" class="checkbox-label">å‚¨ç‰©æˆ’</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-beast-checkbox" name="cultivation.spiritBeast.enabled" />
                                <label for="cultivation-spirit-beast-checkbox" class="checkbox-label">çµå…½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-puppet-checkbox" name="cultivation.puppet.enabled" />
                                <label for="cultivation-puppet-checkbox" class="checkbox-label">å‚€å„¡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-avatar-checkbox" name="cultivation.avatar.enabled" />
                                <label for="cultivation-avatar-checkbox" class="checkbox-label">åŒ–èº«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-clone-checkbox" name="cultivation.clone.enabled" />
                                <label for="cultivation-clone-checkbox" class="checkbox-label">åˆ†èº«</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®ç‚¼èµ„æº -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-stone-checkbox" name="cultivation.spiritStone.enabled" />
                                <label for="cultivation-spirit-stone-checkbox" class="checkbox-label">çµçŸ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-herb-checkbox" name="cultivation.spiritHerb.enabled" />
                                <label for="cultivation-spirit-herb-checkbox" class="checkbox-label">çµè‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-pill-checkbox" name="cultivation.pill.enabled" />
                                <label for="cultivation-pill-checkbox" class="checkbox-label">ä¸¹è¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-spirit-vein-checkbox" name="cultivation.spiritVein.enabled" />
                                <label for="cultivation-spirit-vein-checkbox" class="checkbox-label">çµè„‰</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-cave-mansion-checkbox" name="cultivation.caveMansion.enabled" />
                                <label for="cultivation-cave-mansion-checkbox" class="checkbox-label">æ´åºœ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-secret-realm-checkbox" name="cultivation.secretRealm.enabled" />
                                <label for="cultivation-secret-realm-checkbox" class="checkbox-label">ç§˜å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-inheritance-checkbox" name="cultivation.inheritance.enabled" />
                                <label for="cultivation-inheritance-checkbox" class="checkbox-label">ä¼ æ‰¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-opportunity-checkbox" name="cultivation.opportunity.enabled" />
                                <label for="cultivation-opportunity-checkbox" class="checkbox-label">æœºç¼˜</label>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®ç‚¼æ´»åŠ¨ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-meditation-checkbox" name="cultivation.meditation.enabled" />
                                <label for="cultivation-meditation-checkbox" class="checkbox-label">æ‰“åä¿®ç‚¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-tribulation-crossing-checkbox" name="cultivation.tribulationCrossing.enabled" />
                                <label for="cultivation-tribulation-crossing-checkbox" class="checkbox-label">æ¸¡åŠ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-enlightenment-checkbox" name="cultivation.enlightenment.enabled" />
                                <label for="cultivation-enlightenment-checkbox" class="checkbox-label">é¡¿æ‚Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-breakthrough-checkbox" name="cultivation.breakthrough.enabled" />
                                <label for="cultivation-breakthrough-checkbox" class="checkbox-label">çªç ´</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-sect-checkbox" name="cultivation.sect.enabled" />
                                <label for="cultivation-sect-checkbox" class="checkbox-label">å®—é—¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-master-disciple-checkbox" name="cultivation.masterDisciple.enabled" />
                                <label for="cultivation-master-disciple-checkbox" class="checkbox-label">å¸ˆå¾’å…³ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-dao-companion-checkbox" name="cultivation.daoCompanion.enabled" />
                                <label for="cultivation-dao-companion-checkbox" class="checkbox-label">é“ä¾£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="cultivation-immortal-ascension-checkbox" name="cultivation.immortalAscension.enabled" />
                                <label for="cultivation-immortal-ascension-checkbox" class="checkbox-label">é£å‡</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºç„å¹»ä¸–ç•Œé¢æ¿
     */
    createFantasyPanel() {
        return `
            <div class="content-header">
                <h3>ç„å¹»ä¸–ç•Œé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- ç„å¹»ä¸–ç•Œå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ‰</div>
                            <div class="card-text">
                                <div class="card-title">ç„å¹»ä¸–ç•Œ</div>
                                <div class="card-subtitle">å¥‡å¹»é­”æ³•ä¸–ç•Œè®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="fantasy-toggle" name="fantasy.enabled" checked />
                                <label for="fantasy-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">19/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <!-- å­é¡¹é…ç½® -->
                <div class="sub-items">
                    <!-- ç§æ—ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-human-checkbox" name="fantasy.human.enabled" checked />
                                <label for="fantasy-human-checkbox" class="checkbox-label">äººç±»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-elf-checkbox" name="fantasy.elf.enabled" checked />
                                <label for="fantasy-elf-checkbox" class="checkbox-label">ç²¾çµ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dwarf-checkbox" name="fantasy.dwarf.enabled" checked />
                                <label for="fantasy-dwarf-checkbox" class="checkbox-label">çŸ®äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-orc-checkbox" name="fantasy.orc.enabled" />
                                <label for="fantasy-orc-checkbox" class="checkbox-label">å…½äºº</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dragon-checkbox" name="fantasy.dragon.enabled" />
                                <label for="fantasy-dragon-checkbox" class="checkbox-label">é¾™æ—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-demon-checkbox" name="fantasy.demon.enabled" />
                                <label for="fantasy-demon-checkbox" class="checkbox-label">é­”æ—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-angel-checkbox" name="fantasy.angel.enabled" />
                                <label for="fantasy-angel-checkbox" class="checkbox-label">å¤©ä½¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-undead-checkbox" name="fantasy.undead.enabled" />
                                <label for="fantasy-undead-checkbox" class="checkbox-label">ä¸æ­»æ—</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-halfling-checkbox" name="fantasy.halfling.enabled" />
                                <label for="fantasy-halfling-checkbox" class="checkbox-label">åŠèº«äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-giant-checkbox" name="fantasy.giant.enabled" />
                                <label for="fantasy-giant-checkbox" class="checkbox-label">å·¨äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-fairy-checkbox" name="fantasy.fairy.enabled" />
                                <label for="fantasy-fairy-checkbox" class="checkbox-label">å¦–ç²¾</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-vampire-checkbox" name="fantasy.vampire.enabled" />
                                <label for="fantasy-vampire-checkbox" class="checkbox-label">å¸è¡€é¬¼</label>
                            </div>
                        </div>
                    </div>

                    <!-- é­”æ³•ç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-fire-magic-checkbox" name="fantasy.fireMagic.enabled" checked />
                                <label for="fantasy-fire-magic-checkbox" class="checkbox-label">ç«ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-water-magic-checkbox" name="fantasy.waterMagic.enabled" />
                                <label for="fantasy-water-magic-checkbox" class="checkbox-label">æ°´ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-earth-magic-checkbox" name="fantasy.earthMagic.enabled" />
                                <label for="fantasy-earth-magic-checkbox" class="checkbox-label">åœŸç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-air-magic-checkbox" name="fantasy.airMagic.enabled" />
                                <label for="fantasy-air-magic-checkbox" class="checkbox-label">é£ç³»é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-light-magic-checkbox" name="fantasy.lightMagic.enabled" />
                                <label for="fantasy-light-magic-checkbox" class="checkbox-label">å…‰ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-dark-magic-checkbox" name="fantasy.darkMagic.enabled" />
                                <label for="fantasy-dark-magic-checkbox" class="checkbox-label">æš—ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-nature-magic-checkbox" name="fantasy.natureMagic.enabled" />
                                <label for="fantasy-nature-magic-checkbox" class="checkbox-label">è‡ªç„¶é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-space-magic-checkbox" name="fantasy.spaceMagic.enabled" />
                                <label for="fantasy-space-magic-checkbox" class="checkbox-label">ç©ºé—´é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-time-magic-checkbox" name="fantasy.timeMagic.enabled" />
                                <label for="fantasy-time-magic-checkbox" class="checkbox-label">æ—¶é—´é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-necromancy-checkbox" name="fantasy.necromancy.enabled" />
                                <label for="fantasy-necromancy-checkbox" class="checkbox-label">æ­»çµé­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-illusion-magic-checkbox" name="fantasy.illusionMagic.enabled" />
                                <label for="fantasy-illusion-magic-checkbox" class="checkbox-label">å¹»æœ¯é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-enchantment-checkbox" name="fantasy.enchantment.enabled" />
                                <label for="fantasy-enchantment-checkbox" class="checkbox-label">é™„é­”é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <!-- èŒä¸šç³»ç»Ÿ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-warrior-checkbox" name="fantasy.warrior.enabled" />
                                <label for="fantasy-warrior-checkbox" class="checkbox-label">æˆ˜å£«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-mage-checkbox" name="fantasy.mage.enabled" />
                                <label for="fantasy-mage-checkbox" class="checkbox-label">æ³•å¸ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-archer-checkbox" name="fantasy.archer.enabled" />
                                <label for="fantasy-archer-checkbox" class="checkbox-label">å¼“ç®­æ‰‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-rogue-checkbox" name="fantasy.rogue.enabled" />
                                <label for="fantasy-rogue-checkbox" class="checkbox-label">ç›—è´¼</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-priest-checkbox" name="fantasy.priest.enabled" />
                                <label for="fantasy-priest-checkbox" class="checkbox-label">ç‰§å¸ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-paladin-checkbox" name="fantasy.paladin.enabled" />
                                <label for="fantasy-paladin-checkbox" class="checkbox-label">åœ£éª‘å£«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-druid-checkbox" name="fantasy.druid.enabled" />
                                <label for="fantasy-druid-checkbox" class="checkbox-label">å¾·é²ä¼Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-warlock-checkbox" name="fantasy.warlock.enabled" />
                                <label for="fantasy-warlock-checkbox" class="checkbox-label">æœ¯å£«</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-bard-checkbox" name="fantasy.bard.enabled" />
                                <label for="fantasy-bard-checkbox" class="checkbox-label">åŸæ¸¸è¯—äºº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-monk-checkbox" name="fantasy.monk.enabled" />
                                <label for="fantasy-monk-checkbox" class="checkbox-label">æ­¦åƒ§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-ranger-checkbox" name="fantasy.ranger.enabled" />
                                <label for="fantasy-ranger-checkbox" class="checkbox-label">æ¸¸ä¾ </label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-assassin-checkbox" name="fantasy.assassin.enabled" />
                                <label for="fantasy-assassin-checkbox" class="checkbox-label">åˆºå®¢</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¥è¯ç”Ÿç‰© -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-phoenix-checkbox" name="fantasy.phoenix.enabled" />
                                <label for="fantasy-phoenix-checkbox" class="checkbox-label">å‡¤å‡°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-unicorn-checkbox" name="fantasy.unicorn.enabled" />
                                <label for="fantasy-unicorn-checkbox" class="checkbox-label">ç‹¬è§’å…½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-griffin-checkbox" name="fantasy.griffin.enabled" />
                                <label for="fantasy-griffin-checkbox" class="checkbox-label">ç‹®é¹«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-pegasus-checkbox" name="fantasy.pegasus.enabled" />
                                <label for="fantasy-pegasus-checkbox" class="checkbox-label">é£é©¬</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-kraken-checkbox" name="fantasy.kraken.enabled" />
                                <label for="fantasy-kraken-checkbox" class="checkbox-label">æµ·å¦–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-chimera-checkbox" name="fantasy.chimera.enabled" />
                                <label for="fantasy-chimera-checkbox" class="checkbox-label">å¥‡ç¾æ‹‰</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-basilisk-checkbox" name="fantasy.basilisk.enabled" />
                                <label for="fantasy-basilisk-checkbox" class="checkbox-label">è›‡æ€ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-hydra-checkbox" name="fantasy.hydra.enabled" />
                                <label for="fantasy-hydra-checkbox" class="checkbox-label">ä¹å¤´è›‡</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç¥å™¨è£…å¤‡ -->
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-legendary-weapon-checkbox" name="fantasy.legendaryWeapon.enabled" />
                                <label for="fantasy-legendary-weapon-checkbox" class="checkbox-label">ä¼ è¯´æ­¦å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-magic-armor-checkbox" name="fantasy.magicArmor.enabled" />
                                <label for="fantasy-magic-armor-checkbox" class="checkbox-label">é­”æ³•æŠ¤ç”²</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-artifact-checkbox" name="fantasy.artifact.enabled" />
                                <label for="fantasy-artifact-checkbox" class="checkbox-label">ç¥å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-relic-checkbox" name="fantasy.relic.enabled" />
                                <label for="fantasy-relic-checkbox" class="checkbox-label">åœ£é—ç‰©</label>
                            </div>
                        </div>
                    </div>

                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-magic-crystal-checkbox" name="fantasy.magicCrystal.enabled" />
                                <label for="fantasy-magic-crystal-checkbox" class="checkbox-label">é­”æ³•æ°´æ™¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-enchanted-item-checkbox" name="fantasy.enchantedItem.enabled" />
                                <label for="fantasy-enchanted-item-checkbox" class="checkbox-label">é™„é­”ç‰©å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-potion-checkbox" name="fantasy.potion.enabled" />
                                <label for="fantasy-potion-checkbox" class="checkbox-label">é­”æ³•è¯å‰‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="fantasy-scroll-checkbox" name="fantasy.scroll.enabled" />
                                <label for="fantasy-scroll-checkbox" class="checkbox-label">é­”æ³•å·è½´</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºéƒ½å¸‚ç°ä»£é¢æ¿
     */
    createModernPanel() {
        return `
            <div class="content-header">
                <h3>éƒ½å¸‚ç°ä»£é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- éƒ½å¸‚ç°ä»£å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ™ï¸</div>
                            <div class="card-text">
                                <div class="card-title">éƒ½å¸‚ç°ä»£</div>
                                <div class="card-subtitle">ç°ä»£éƒ½å¸‚ç”Ÿæ´»è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="modern-toggle" name="modern.enabled" checked />
                                <label for="modern-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">8/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ™ï¸ åŸå¸‚ç”Ÿæ´»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-city-checkbox" name="modern.city.enabled" checked />
                                <label for="modern-city-checkbox" class="checkbox-label">å±…ä½åŸå¸‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-district-checkbox" name="modern.district.enabled" checked />
                                <label for="modern-district-checkbox" class="checkbox-label">æ‰€åœ¨åŒºåŸŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-housing-checkbox" name="modern.housing.enabled" />
                                <label for="modern-housing-checkbox" class="checkbox-label">ä½æˆ¿ç±»å‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-transport-checkbox" name="modern.transport.enabled" checked />
                                <label for="modern-transport-checkbox" class="checkbox-label">äº¤é€šæ–¹å¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-neighborhood-checkbox" name="modern.neighborhood.enabled" />
                                <label for="modern-neighborhood-checkbox" class="checkbox-label">ç¤¾åŒºç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-facilities-checkbox" name="modern.facilities.enabled" />
                                <label for="modern-facilities-checkbox" class="checkbox-label">å‘¨è¾¹è®¾æ–½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-cost-checkbox" name="modern.cost.enabled" />
                                <label for="modern-cost-checkbox" class="checkbox-label">ç”Ÿæ´»æˆæœ¬</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-safety-checkbox" name="modern.safety.enabled" />
                                <label for="modern-safety-checkbox" class="checkbox-label">å®‰å…¨æŒ‡æ•°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-pollution-checkbox" name="modern.pollution.enabled" />
                                <label for="modern-pollution-checkbox" class="checkbox-label">ç¯å¢ƒè´¨é‡</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’¼ èŒä¸šå‘å±•</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-job-checkbox" name="modern.job.enabled" checked />
                                <label for="modern-job-checkbox" class="checkbox-label">å½“å‰èŒä¸š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-company-checkbox" name="modern.company.enabled" />
                                <label for="modern-company-checkbox" class="checkbox-label">å·¥ä½œå•ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-position-checkbox" name="modern.position.enabled" />
                                <label for="modern-position-checkbox" class="checkbox-label">èŒä½çº§åˆ«</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-income-checkbox" name="modern.income.enabled" checked />
                                <label for="modern-income-checkbox" class="checkbox-label">æ”¶å…¥æ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-worktime-checkbox" name="modern.worktime.enabled" />
                                <label for="modern-worktime-checkbox" class="checkbox-label">å·¥ä½œæ—¶é—´</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-benefits-checkbox" name="modern.benefits.enabled" />
                                <label for="modern-benefits-checkbox" class="checkbox-label">ç¦åˆ©å¾…é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-career-checkbox" name="modern.career.enabled" />
                                <label for="modern-career-checkbox" class="checkbox-label">èŒä¸šè§„åˆ’</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-skills-checkbox" name="modern.skills.enabled" />
                                <label for="modern-skills-checkbox" class="checkbox-label">ä¸“ä¸šæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-education-checkbox" name="modern.education.enabled" />
                                <label for="modern-education-checkbox" class="checkbox-label">æ•™è‚²èƒŒæ™¯</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“± ç§‘æŠ€ç”Ÿæ´»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-smartphone-checkbox" name="modern.smartphone.enabled" checked />
                                <label for="modern-smartphone-checkbox" class="checkbox-label">æ™ºèƒ½æ‰‹æœº</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-computer-checkbox" name="modern.computer.enabled" />
                                <label for="modern-computer-checkbox" class="checkbox-label">ç”µè„‘è®¾å¤‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-internet-checkbox" name="modern.internet.enabled" />
                                <label for="modern-internet-checkbox" class="checkbox-label">ç½‘ç»œä½¿ç”¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-social-checkbox" name="modern.social.enabled" checked />
                                <label for="modern-social-checkbox" class="checkbox-label">ç¤¾äº¤åª’ä½“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-gaming-checkbox" name="modern.gaming.enabled" />
                                <label for="modern-gaming-checkbox" class="checkbox-label">æ¸¸æˆå¨±ä¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-streaming-checkbox" name="modern.streaming.enabled" />
                                <label for="modern-streaming-checkbox" class="checkbox-label">è§†é¢‘å¹³å°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-shopping-checkbox" name="modern.shopping.enabled" />
                                <label for="modern-shopping-checkbox" class="checkbox-label">åœ¨çº¿è´­ç‰©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-payment-checkbox" name="modern.payment.enabled" />
                                <label for="modern-payment-checkbox" class="checkbox-label">ç§»åŠ¨æ”¯ä»˜</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-ai-checkbox" name="modern.ai.enabled" />
                                <label for="modern-ai-checkbox" class="checkbox-label">AIåŠ©æ‰‹</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ¥ å¥åº·ç®¡ç†</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-health-checkbox" name="modern.health.enabled" />
                                <label for="modern-health-checkbox" class="checkbox-label">å¥åº·çŠ¶å†µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-fitness-checkbox" name="modern.fitness.enabled" />
                                <label for="modern-fitness-checkbox" class="checkbox-label">å¥èº«ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-diet-checkbox" name="modern.diet.enabled" />
                                <label for="modern-diet-checkbox" class="checkbox-label">é¥®é£Ÿä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-sleep-checkbox" name="modern.sleep.enabled" />
                                <label for="modern-sleep-checkbox" class="checkbox-label">ç¡çœ è´¨é‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-medical-checkbox" name="modern.medical.enabled" />
                                <label for="modern-medical-checkbox" class="checkbox-label">åŒ»ç–—ä¿é™©</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-stress-checkbox" name="modern.stress.enabled" />
                                <label for="modern-stress-checkbox" class="checkbox-label">å‹åŠ›ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-mental-checkbox" name="modern.mental.enabled" />
                                <label for="modern-mental-checkbox" class="checkbox-label">å¿ƒç†å¥åº·</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-checkup-checkbox" name="modern.checkup.enabled" />
                                <label for="modern-checkup-checkbox" class="checkbox-label">å®šæœŸä½“æ£€</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ›ï¸ æ¶ˆè´¹ä¹ æƒ¯</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-budget-checkbox" name="modern.budget.enabled" />
                                <label for="modern-budget-checkbox" class="checkbox-label">æ¶ˆè´¹é¢„ç®—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-brands-checkbox" name="modern.brands.enabled" />
                                <label for="modern-brands-checkbox" class="checkbox-label">å“ç‰Œåå¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-fashion-checkbox" name="modern.fashion.enabled" />
                                <label for="modern-fashion-checkbox" class="checkbox-label">æ—¶å°šé£æ ¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-luxury-checkbox" name="modern.luxury.enabled" />
                                <label for="modern-luxury-checkbox" class="checkbox-label">å¥¢ä¾ˆå“æ¶ˆè´¹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-investment-checkbox" name="modern.investment.enabled" />
                                <label for="modern-investment-checkbox" class="checkbox-label">æŠ•èµ„ç†è´¢</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-saving-checkbox" name="modern.saving.enabled" />
                                <label for="modern-saving-checkbox" class="checkbox-label">å‚¨è“„ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-credit-checkbox" name="modern.credit.enabled" />
                                <label for="modern-credit-checkbox" class="checkbox-label">ä¿¡ç”¨è®°å½•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-insurance-checkbox" name="modern.insurance.enabled" />
                                <label for="modern-insurance-checkbox" class="checkbox-label">ä¿é™©é…ç½®</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ­ å¨±ä¹ä¼‘é—²</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-movies-checkbox" name="modern.movies.enabled" />
                                <label for="modern-movies-checkbox" class="checkbox-label">ç”µå½±åå¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-music-checkbox" name="modern.music.enabled" />
                                <label for="modern-music-checkbox" class="checkbox-label">éŸ³ä¹å“å‘³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-books-checkbox" name="modern.books.enabled" />
                                <label for="modern-books-checkbox" class="checkbox-label">é˜…è¯»ä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-travel-checkbox" name="modern.travel.enabled" />
                                <label for="modern-travel-checkbox" class="checkbox-label">æ—…è¡Œç»å†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-sports-checkbox" name="modern.sports.enabled" />
                                <label for="modern-sports-checkbox" class="checkbox-label">è¿åŠ¨çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-hobbies-checkbox" name="modern.hobbies.enabled" />
                                <label for="modern-hobbies-checkbox" class="checkbox-label">å…´è¶£çˆ±å¥½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-clubs-checkbox" name="modern.clubs.enabled" />
                                <label for="modern-clubs-checkbox" class="checkbox-label">ç¤¾å›¢æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="modern-events-checkbox" name="modern.events.enabled" />
                                <label for="modern-events-checkbox" class="checkbox-label">æ´»åŠ¨å‚ä¸</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºå†å²å¤ä»£é¢æ¿
     */
    createHistoricalPanel() {
        return `
            <div class="content-header">
                <h3>å†å²å¤ä»£é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- å†å²å¤ä»£å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ›ï¸</div>
                            <div class="card-text">
                                <div class="card-title">å†å²å¤ä»£</div>
                                <div class="card-subtitle">å¤ä»£å†å²èƒŒæ™¯è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="historical-toggle" name="historical.enabled" checked />
                                <label for="historical-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">7/52 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ›ï¸ æœä»£èƒŒæ™¯</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-dynasty-checkbox" name="historical.dynasty.enabled" checked />
                                <label for="historical-dynasty-checkbox" class="checkbox-label">å†å²æœä»£</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-period-checkbox" name="historical.period.enabled" checked />
                                <label for="historical-period-checkbox" class="checkbox-label">å†å²æ—¶æœŸ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-emperor-checkbox" name="historical.emperor.enabled" />
                                <label for="historical-emperor-checkbox" class="checkbox-label">åœ¨ä½çš‡å¸</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-capital-checkbox" name="historical.capital.enabled" />
                                <label for="historical-capital-checkbox" class="checkbox-label">éƒ½åŸä½ç½®</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-region-checkbox" name="historical.region.enabled" />
                                <label for="historical-region-checkbox" class="checkbox-label">æ‰€åœ¨å·åºœ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-events-checkbox" name="historical.events.enabled" />
                                <label for="historical-events-checkbox" class="checkbox-label">é‡å¤§äº‹ä»¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-wars-checkbox" name="historical.wars.enabled" />
                                <label for="historical-wars-checkbox" class="checkbox-label">æˆ˜äº‰èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-politics-checkbox" name="historical.politics.enabled" />
                                <label for="historical-politics-checkbox" class="checkbox-label">æ”¿æ²»ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-economy-checkbox" name="historical.economy.enabled" />
                                <label for="historical-economy-checkbox" class="checkbox-label">ç»æµçŠ¶å†µ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ‘‘ ç¤¾ä¼šåœ°ä½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-class-checkbox" name="historical.class.enabled" checked />
                                <label for="historical-class-checkbox" class="checkbox-label">ç¤¾ä¼šé˜¶å±‚</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-title-checkbox" name="historical.title.enabled" />
                                <label for="historical-title-checkbox" class="checkbox-label">å®˜èŒçˆµä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-family-checkbox" name="historical.family.enabled" checked />
                                <label for="historical-family-checkbox" class="checkbox-label">å®¶æ—èƒŒæ™¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-wealth-checkbox" name="historical.wealth.enabled" />
                                <label for="historical-wealth-checkbox" class="checkbox-label">è´¢å¯ŒçŠ¶å†µ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-land-checkbox" name="historical.land.enabled" />
                                <label for="historical-land-checkbox" class="checkbox-label">åœŸåœ°è´¢äº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-servants-checkbox" name="historical.servants.enabled" />
                                <label for="historical-servants-checkbox" class="checkbox-label">ä»†ä»éšä»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-influence-checkbox" name="historical.influence.enabled" />
                                <label for="historical-influence-checkbox" class="checkbox-label">æ”¿æ²»å½±å“</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-reputation-checkbox" name="historical.reputation.enabled" />
                                <label for="historical-reputation-checkbox" class="checkbox-label">ç¤¾ä¼šå£°æœ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-connections-checkbox" name="historical.connections.enabled" />
                                <label for="historical-connections-checkbox" class="checkbox-label">äººè„‰å…³ç³»</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“š æ–‡åŒ–ä¿®å…»</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-education-checkbox" name="historical.education.enabled" checked />
                                <label for="historical-education-checkbox" class="checkbox-label">æ•™è‚²ç¨‹åº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-poetry-checkbox" name="historical.poetry.enabled" />
                                <label for="historical-poetry-checkbox" class="checkbox-label">è¯—è¯æ­Œèµ‹</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-calligraphy-checkbox" name="historical.calligraphy.enabled" />
                                <label for="historical-calligraphy-checkbox" class="checkbox-label">ä¹¦æ³•ç»˜ç”»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-music-checkbox" name="historical.music.enabled" />
                                <label for="historical-music-checkbox" class="checkbox-label">éŸ³å¾‹ä¹å™¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-chess-checkbox" name="historical.chess.enabled" />
                                <label for="historical-chess-checkbox" class="checkbox-label">æ£‹è‰ºåšå¼ˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-classics-checkbox" name="historical.classics.enabled" />
                                <label for="historical-classics-checkbox" class="checkbox-label">ç»å²å­é›†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-philosophy-checkbox" name="historical.philosophy.enabled" />
                                <label for="historical-philosophy-checkbox" class="checkbox-label">å“²å­¦æ€æƒ³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-etiquette-checkbox" name="historical.etiquette.enabled" />
                                <label for="historical-etiquette-checkbox" class="checkbox-label">ç¤¼ä»ªè§„èŒƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-language-checkbox" name="historical.language.enabled" />
                                <label for="historical-language-checkbox" class="checkbox-label">è¯­è¨€æ–‡å­—</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš”ï¸ æ­¦è‰ºæŠ€èƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-martial-checkbox" name="historical.martial.enabled" checked />
                                <label for="historical-martial-checkbox" class="checkbox-label">æ­¦è‰ºæ°´å¹³</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-weapons-checkbox" name="historical.weapons.enabled" />
                                <label for="historical-weapons-checkbox" class="checkbox-label">å…µå™¨ä½¿ç”¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-archery-checkbox" name="historical.archery.enabled" />
                                <label for="historical-archery-checkbox" class="checkbox-label">å¼“ç®­å°„æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-horsemanship-checkbox" name="historical.horsemanship.enabled" />
                                <label for="historical-horsemanship-checkbox" class="checkbox-label">éª‘æœ¯é©¬æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-strategy-checkbox" name="historical.strategy.enabled" />
                                <label for="historical-strategy-checkbox" class="checkbox-label">å…µæ³•æˆ˜ç•¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-bodyguard-checkbox" name="historical.bodyguard.enabled" />
                                <label for="historical-bodyguard-checkbox" class="checkbox-label">æŠ¤å«æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-hunting-checkbox" name="historical.hunting.enabled" />
                                <label for="historical-hunting-checkbox" class="checkbox-label">ç‹©çŒæŠ€å·§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-survival-checkbox" name="historical.survival.enabled" />
                                <label for="historical-survival-checkbox" class="checkbox-label">é‡å¤–ç”Ÿå­˜</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ  ç”Ÿæ´»æ–¹å¼</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-residence-checkbox" name="historical.residence.enabled" />
                                <label for="historical-residence-checkbox" class="checkbox-label">å±…ä½ç¯å¢ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-clothing-checkbox" name="historical.clothing.enabled" checked />
                                <label for="historical-clothing-checkbox" class="checkbox-label">æœé¥°ç©¿ç€</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-food-checkbox" name="historical.food.enabled" />
                                <label for="historical-food-checkbox" class="checkbox-label">é¥®é£Ÿä¹ æƒ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-transport-checkbox" name="historical.transport.enabled" />
                                <label for="historical-transport-checkbox" class="checkbox-label">å‡ºè¡Œæ–¹å¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-entertainment-checkbox" name="historical.entertainment.enabled" />
                                <label for="historical-entertainment-checkbox" class="checkbox-label">å¨±ä¹æ´»åŠ¨</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-festivals-checkbox" name="historical.festivals.enabled" />
                                <label for="historical-festivals-checkbox" class="checkbox-label">èŠ‚åº†ä¹ ä¿—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-religion-checkbox" name="historical.religion.enabled" />
                                <label for="historical-religion-checkbox" class="checkbox-label">å®—æ•™ä¿¡ä»°</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-medicine-checkbox" name="historical.medicine.enabled" />
                                <label for="historical-medicine-checkbox" class="checkbox-label">åŒ»è¯çŸ¥è¯†</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’¼ èŒä¸šæŠ€èƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-profession-checkbox" name="historical.profession.enabled" checked />
                                <label for="historical-profession-checkbox" class="checkbox-label">èŒä¸šèº«ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-crafts-checkbox" name="historical.crafts.enabled" />
                                <label for="historical-crafts-checkbox" class="checkbox-label">æ‰‹å·¥æŠ€è‰º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-trade-checkbox" name="historical.trade.enabled" />
                                <label for="historical-trade-checkbox" class="checkbox-label">å•†è´¸ç»è¥</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-farming-checkbox" name="historical.farming.enabled" />
                                <label for="historical-farming-checkbox" class="checkbox-label">å†œä¸šç§æ¤</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-administration-checkbox" name="historical.administration.enabled" />
                                <label for="historical-administration-checkbox" class="checkbox-label">è¡Œæ”¿ç®¡ç†</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-teaching-checkbox" name="historical.teaching.enabled" />
                                <label for="historical-teaching-checkbox" class="checkbox-label">æ•™å­¦ä¼ æˆ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-healing-checkbox" name="historical.healing.enabled" />
                                <label for="historical-healing-checkbox" class="checkbox-label">åŒ»æœ¯æ²»ç–—</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="historical-construction-checkbox" name="historical.construction.enabled" />
                                <label for="historical-construction-checkbox" class="checkbox-label">å»ºç­‘è¥é€ </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºé­”æ³•èƒ½åŠ›é¢æ¿
     */
    createMagicPanel() {
        return `
            <div class="content-header">
                <h3>é­”æ³•èƒ½åŠ›é…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- é­”æ³•èƒ½åŠ›å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ”®</div>
                            <div class="card-text">
                                <div class="card-title">é­”æ³•èƒ½åŠ›</div>
                                <div class="card-subtitle">é­”æ³•ç³»ç»Ÿèƒ½åŠ›è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="magic-toggle" name="magic.enabled" checked />
                                <label for="magic-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">9/53 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ”® é­”æ³•å­¦æ´¾</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-evocation-checkbox" name="magic.evocation.enabled" checked />
                                <label for="magic-evocation-checkbox" class="checkbox-label">å¡‘èƒ½ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-illusion-checkbox" name="magic.illusion.enabled" checked />
                                <label for="magic-illusion-checkbox" class="checkbox-label">å¹»æœ¯ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-enchantment-checkbox" name="magic.enchantment.enabled" />
                                <label for="magic-enchantment-checkbox" class="checkbox-label">æƒ‘æ§ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-necromancy-checkbox" name="magic.necromancy.enabled" />
                                <label for="magic-necromancy-checkbox" class="checkbox-label">æ­»çµç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-divination-checkbox" name="magic.divination.enabled" />
                                <label for="magic-divination-checkbox" class="checkbox-label">é¢„è¨€ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-transmutation-checkbox" name="magic.transmutation.enabled" />
                                <label for="magic-transmutation-checkbox" class="checkbox-label">å˜åŒ–ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-conjuration-checkbox" name="magic.conjuration.enabled" />
                                <label for="magic-conjuration-checkbox" class="checkbox-label">å’’æ³•ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-abjuration-checkbox" name="magic.abjuration.enabled" />
                                <label for="magic-abjuration-checkbox" class="checkbox-label">é˜²æŠ¤ç³»</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-elemental-checkbox" name="magic.elemental.enabled" />
                                <label for="magic-elemental-checkbox" class="checkbox-label">å…ƒç´ ç³»</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš¡ æ³•æœ¯ç­‰çº§</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-cantrip-checkbox" name="magic.cantrip.enabled" checked />
                                <label for="magic-cantrip-checkbox" class="checkbox-label">æˆæ³•(0ç¯)</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level1-checkbox" name="magic.level1.enabled" checked />
                                <label for="magic-level1-checkbox" class="checkbox-label">1ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level2-checkbox" name="magic.level2.enabled" />
                                <label for="magic-level2-checkbox" class="checkbox-label">2ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level3-checkbox" name="magic.level3.enabled" />
                                <label for="magic-level3-checkbox" class="checkbox-label">3ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level4-checkbox" name="magic.level4.enabled" />
                                <label for="magic-level4-checkbox" class="checkbox-label">4ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level5-checkbox" name="magic.level5.enabled" />
                                <label for="magic-level5-checkbox" class="checkbox-label">5ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level6-checkbox" name="magic.level6.enabled" />
                                <label for="magic-level6-checkbox" class="checkbox-label">6ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level7-checkbox" name="magic.level7.enabled" />
                                <label for="magic-level7-checkbox" class="checkbox-label">7ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level8-checkbox" name="magic.level8.enabled" />
                                <label for="magic-level8-checkbox" class="checkbox-label">8ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level9-checkbox" name="magic.level9.enabled" />
                                <label for="magic-level9-checkbox" class="checkbox-label">9ç¯æ³•æœ¯</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ§™ æ³•å¸ˆå±æ€§</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-level-checkbox" name="magic.level.enabled" checked />
                                <label for="magic-level-checkbox" class="checkbox-label">æ³•å¸ˆç­‰çº§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-mana-checkbox" name="magic.mana.enabled" checked />
                                <label for="magic-mana-checkbox" class="checkbox-label">æ³•åŠ›å€¼</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-intelligence-checkbox" name="magic.intelligence.enabled" />
                                <label for="magic-intelligence-checkbox" class="checkbox-label">æ™ºåŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-wisdom-checkbox" name="magic.wisdom.enabled" />
                                <label for="magic-wisdom-checkbox" class="checkbox-label">æ„ŸçŸ¥å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-charisma-checkbox" name="magic.charisma.enabled" />
                                <label for="magic-charisma-checkbox" class="checkbox-label">é­…åŠ›å±æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-concentration-checkbox" name="magic.concentration.enabled" />
                                <label for="magic-concentration-checkbox" class="checkbox-label">ä¸“æ³¨èƒ½åŠ›</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-spellpower-checkbox" name="magic.spellpower.enabled" />
                                <label for="magic-spellpower-checkbox" class="checkbox-label">æ³•æœ¯å¼ºåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-resistance-checkbox" name="magic.resistance.enabled" />
                                <label for="magic-resistance-checkbox" class="checkbox-label">é­”æ³•æŠ—æ€§</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-regeneration-checkbox" name="magic.regeneration.enabled" />
                                <label for="magic-regeneration-checkbox" class="checkbox-label">æ³•åŠ›å›å¤</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“š æ³•æœ¯ä¹¦åº“</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-spellbook-checkbox" name="magic.spellbook.enabled" checked />
                                <label for="magic-spellbook-checkbox" class="checkbox-label">æ³•æœ¯ä¹¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-known-checkbox" name="magic.known.enabled" />
                                <label for="magic-known-checkbox" class="checkbox-label">å·²çŸ¥æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-prepared-checkbox" name="magic.prepared.enabled" />
                                <label for="magic-prepared-checkbox" class="checkbox-label">å‡†å¤‡æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-slots-checkbox" name="magic.slots.enabled" />
                                <label for="magic-slots-checkbox" class="checkbox-label">æ³•æœ¯ä½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-components-checkbox" name="magic.components.enabled" />
                                <label for="magic-components-checkbox" class="checkbox-label">æ³•æœ¯ææ–™</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-rituals-checkbox" name="magic.rituals.enabled" />
                                <label for="magic-rituals-checkbox" class="checkbox-label">ä»ªå¼æ³•æœ¯</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-metamagic-checkbox" name="magic.metamagic.enabled" />
                                <label for="magic-metamagic-checkbox" class="checkbox-label">è¶…é­”ä¸“é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-scrolls-checkbox" name="magic.scrolls.enabled" />
                                <label for="magic-scrolls-checkbox" class="checkbox-label">æ³•æœ¯å·è½´</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ”¥ å…ƒç´ é­”æ³•</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-fire-checkbox" name="magic.fire.enabled" checked />
                                <label for="magic-fire-checkbox" class="checkbox-label">ç«ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-water-checkbox" name="magic.water.enabled" />
                                <label for="magic-water-checkbox" class="checkbox-label">æ°´ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-earth-checkbox" name="magic.earth.enabled" />
                                <label for="magic-earth-checkbox" class="checkbox-label">åœŸç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-air-checkbox" name="magic.air.enabled" />
                                <label for="magic-air-checkbox" class="checkbox-label">é£ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-lightning-checkbox" name="magic.lightning.enabled" />
                                <label for="magic-lightning-checkbox" class="checkbox-label">é›·ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-ice-checkbox" name="magic.ice.enabled" />
                                <label for="magic-ice-checkbox" class="checkbox-label">å†°ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-light-checkbox" name="magic.light.enabled" />
                                <label for="magic-light-checkbox" class="checkbox-label">å…‰ç³»é­”æ³•</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-dark-checkbox" name="magic.dark.enabled" />
                                <label for="magic-dark-checkbox" class="checkbox-label">æš—ç³»é­”æ³•</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ›¡ï¸ é­”æ³•è£…å¤‡</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-staff-checkbox" name="magic.staff.enabled" />
                                <label for="magic-staff-checkbox" class="checkbox-label">æ³•æ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-wand-checkbox" name="magic.wand.enabled" />
                                <label for="magic-wand-checkbox" class="checkbox-label">é­”æ–</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-orb-checkbox" name="magic.orb.enabled" />
                                <label for="magic-orb-checkbox" class="checkbox-label">æ³•çƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-robe-checkbox" name="magic.robe.enabled" />
                                <label for="magic-robe-checkbox" class="checkbox-label">æ³•è¢</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-amulet-checkbox" name="magic.amulet.enabled" />
                                <label for="magic-amulet-checkbox" class="checkbox-label">æŠ¤èº«ç¬¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-ring-checkbox" name="magic.ring.enabled" />
                                <label for="magic-ring-checkbox" class="checkbox-label">é­”æ³•æˆ’æŒ‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-crystal-checkbox" name="magic.crystal.enabled" />
                                <label for="magic-crystal-checkbox" class="checkbox-label">é­”æ³•æ°´æ™¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="magic-tome-checkbox" name="magic.tome.enabled" />
                                <label for="magic-tome-checkbox" class="checkbox-label">é­”æ³•å…¸ç±</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    /**
     * åˆ›å»ºè°ƒæ•™ç³»ç»Ÿé¢æ¿
     */
    createTrainingPanel() {
        return `
            <div class="content-header">
                <h3>è°ƒæ•™ç³»ç»Ÿé…ç½®</h3>
            </div>

            <div class="content-body">
                <!-- è°ƒæ•™ç³»ç»Ÿå¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <div class="card-info-left">
                            <div class="card-icon">ğŸ¯</div>
                            <div class="card-text">
                                <div class="card-title">è°ƒæ•™ç³»ç»Ÿ</div>
                                <div class="card-subtitle">è®­ç»ƒç³»ç»ŸåŠŸèƒ½è®¾å®š</div>
                            </div>
                        </div>
                        <div class="card-toggle">
                            <div class="toggle-switch">
                                <input type="checkbox" id="training-toggle" name="training.enabled" checked />
                                <label for="training-toggle" class="switch-slider"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-status">
                            <span class="status-badge enabled">å·²å¯ç”¨</span>
                            <span class="status-count">6/51 é¡¹å·²é…ç½®</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ğŸ“š åŸºç¡€è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-obedience-checkbox" name="training.obedience.enabled" checked />
                                <label for="training-obedience-checkbox" class="checkbox-label">æœä»è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-discipline-checkbox" name="training.discipline.enabled" checked />
                                <label for="training-discipline-checkbox" class="checkbox-label">çºªå¾‹è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-etiquette-checkbox" name="training.etiquette.enabled" />
                                <label for="training-etiquette-checkbox" class="checkbox-label">ç¤¼ä»ªè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-posture-checkbox" name="training.posture.enabled" />
                                <label for="training-posture-checkbox" class="checkbox-label">å§¿æ€è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-speech-checkbox" name="training.speech.enabled" />
                                <label for="training-speech-checkbox" class="checkbox-label">è¨€è¯­è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-behavior-checkbox" name="training.behavior.enabled" />
                                <label for="training-behavior-checkbox" class="checkbox-label">è¡Œä¸ºè§„èŒƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-attention-checkbox" name="training.attention.enabled" />
                                <label for="training-attention-checkbox" class="checkbox-label">æ³¨æ„åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-patience-checkbox" name="training.patience.enabled" />
                                <label for="training-patience-checkbox" class="checkbox-label">è€å¿ƒè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-focus-checkbox" name="training.focus.enabled" />
                                <label for="training-focus-checkbox" class="checkbox-label">ä¸“æ³¨è®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ¯ æŠ€èƒ½è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-service-checkbox" name="training.service.enabled" checked />
                                <label for="training-service-checkbox" class="checkbox-label">æœåŠ¡æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-cooking-checkbox" name="training.cooking.enabled" />
                                <label for="training-cooking-checkbox" class="checkbox-label">çƒ¹é¥ªæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-cleaning-checkbox" name="training.cleaning.enabled" />
                                <label for="training-cleaning-checkbox" class="checkbox-label">æ¸…æ´æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-massage-checkbox" name="training.massage.enabled" />
                                <label for="training-massage-checkbox" class="checkbox-label">æŒ‰æ‘©æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-entertainment-checkbox" name="training.entertainment.enabled" />
                                <label for="training-entertainment-checkbox" class="checkbox-label">å¨±ä¹æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-music-checkbox" name="training.music.enabled" />
                                <label for="training-music-checkbox" class="checkbox-label">éŸ³ä¹æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-dance-checkbox" name="training.dance.enabled" />
                                <label for="training-dance-checkbox" class="checkbox-label">èˆè¹ˆæŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-art-checkbox" name="training.art.enabled" />
                                <label for="training-art-checkbox" class="checkbox-label">è‰ºæœ¯æŠ€èƒ½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-language-checkbox" name="training.language.enabled" />
                                <label for="training-language-checkbox" class="checkbox-label">è¯­è¨€æŠ€èƒ½</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ’ª ä½“èƒ½è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-strength-checkbox" name="training.strength.enabled" />
                                <label for="training-strength-checkbox" class="checkbox-label">åŠ›é‡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-endurance-checkbox" name="training.endurance.enabled" />
                                <label for="training-endurance-checkbox" class="checkbox-label">è€åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-flexibility-checkbox" name="training.flexibility.enabled" />
                                <label for="training-flexibility-checkbox" class="checkbox-label">æŸ”éŸ§è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-balance-checkbox" name="training.balance.enabled" />
                                <label for="training-balance-checkbox" class="checkbox-label">å¹³è¡¡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-coordination-checkbox" name="training.coordination.enabled" />
                                <label for="training-coordination-checkbox" class="checkbox-label">åè°ƒè®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-agility-checkbox" name="training.agility.enabled" />
                                <label for="training-agility-checkbox" class="checkbox-label">æ•æ·è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-stamina-checkbox" name="training.stamina.enabled" />
                                <label for="training-stamina-checkbox" class="checkbox-label">ä½“åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-recovery-checkbox" name="training.recovery.enabled" />
                                <label for="training-recovery-checkbox" class="checkbox-label">æ¢å¤è®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ§  å¿ƒç†è®­ç»ƒ</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-confidence-checkbox" name="training.confidence.enabled" checked />
                                <label for="training-confidence-checkbox" class="checkbox-label">è‡ªä¿¡è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-stress-checkbox" name="training.stress.enabled" />
                                <label for="training-stress-checkbox" class="checkbox-label">æŠ—å‹è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-emotion-checkbox" name="training.emotion.enabled" />
                                <label for="training-emotion-checkbox" class="checkbox-label">æƒ…ç»ªæ§åˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-memory-checkbox" name="training.memory.enabled" />
                                <label for="training-memory-checkbox" class="checkbox-label">è®°å¿†è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-logic-checkbox" name="training.logic.enabled" />
                                <label for="training-logic-checkbox" class="checkbox-label">é€»è¾‘è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-creativity-checkbox" name="training.creativity.enabled" />
                                <label for="training-creativity-checkbox" class="checkbox-label">åˆ›é€ åŠ›è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-meditation-checkbox" name="training.meditation.enabled" />
                                <label for="training-meditation-checkbox" class="checkbox-label">å†¥æƒ³è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-mindfulness-checkbox" name="training.mindfulness.enabled" />
                                <label for="training-mindfulness-checkbox" class="checkbox-label">æ­£å¿µè®­ç»ƒ</label>
                            </div>
                        </div>
                    </div>

                    <h4>âš™ï¸ è®­ç»ƒè®¾ç½®</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-intensity-checkbox" name="training.intensity.enabled" checked />
                                <label for="training-intensity-checkbox" class="checkbox-label">è®­ç»ƒå¼ºåº¦</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-duration-checkbox" name="training.duration.enabled" />
                                <label for="training-duration-checkbox" class="checkbox-label">è®­ç»ƒæ—¶é•¿</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-frequency-checkbox" name="training.frequency.enabled" />
                                <label for="training-frequency-checkbox" class="checkbox-label">è®­ç»ƒé¢‘ç‡</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-progress-checkbox" name="training.progress.enabled" />
                                <label for="training-progress-checkbox" class="checkbox-label">è¿›åº¦è·Ÿè¸ª</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-rewards-checkbox" name="training.rewards.enabled" />
                                <label for="training-rewards-checkbox" class="checkbox-label">å¥–åŠ±ç³»ç»Ÿ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-punishment-checkbox" name="training.punishment.enabled" />
                                <label for="training-punishment-checkbox" class="checkbox-label">æƒ©ç½šæœºåˆ¶</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-schedule-checkbox" name="training.schedule.enabled" />
                                <label for="training-schedule-checkbox" class="checkbox-label">è®­ç»ƒè®¡åˆ’</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-evaluation-checkbox" name="training.evaluation.enabled" />
                                <label for="training-evaluation-checkbox" class="checkbox-label">æ•ˆæœè¯„ä¼°</label>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ“Š é«˜çº§åŠŸèƒ½</h4>
                    <div class="sub-item-row">
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-auto-checkbox" name="training.auto.enabled" checked />
                                <label for="training-auto-checkbox" class="checkbox-label">è‡ªåŠ¨è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-adaptive-checkbox" name="training.adaptive.enabled" />
                                <label for="training-adaptive-checkbox" class="checkbox-label">è‡ªé€‚åº”è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-ai-checkbox" name="training.ai.enabled" />
                                <label for="training-ai-checkbox" class="checkbox-label">AIè¾…åŠ©è®­ç»ƒ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-analytics-checkbox" name="training.analytics.enabled" />
                                <label for="training-analytics-checkbox" class="checkbox-label">æ•°æ®åˆ†æ</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-reports-checkbox" name="training.reports.enabled" />
                                <label for="training-reports-checkbox" class="checkbox-label">è®­ç»ƒæŠ¥å‘Š</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-export-checkbox" name="training.export.enabled" />
                                <label for="training-export-checkbox" class="checkbox-label">æ•°æ®å¯¼å‡º</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-backup-checkbox" name="training.backup.enabled" />
                                <label for="training-backup-checkbox" class="checkbox-label">æ•°æ®å¤‡ä»½</label>
                            </div>
                        </div>
                        <div class="sub-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="training-sync-checkbox" name="training.sync.enabled" />
                                <label for="training-sync-checkbox" class="checkbox-label">äº‘ç«¯åŒæ­¥</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * é”™è¯¯å¤„ç†
     */
    handleError(error) {
        this.errorCount++;
        console.error(`[InfoBarSettings] âŒ é”™è¯¯ #${this.errorCount}:`, error);
    }

    /**
     * åˆ›å»ºä¸»é¢˜é¢„è§ˆç½‘æ ¼
     */
    createThemePreviewGrid() {
        const themes = [
            {
                id: 'default-dark',
                name: 'é»˜è®¤æ·±è‰²',
                description: 'ç»å…¸æ·±è‰²ä¸»é¢˜ï¼ŒæŠ¤çœ¼èˆ’é€‚',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            },
            {
                id: 'default-light',
                name: 'é»˜è®¤æµ…è‰²',
                description: 'æ¸…æ–°æµ…è‰²ä¸»é¢˜ï¼Œç®€æ´æ˜äº®',
                colors: { bg: '#ffffff', text: '#333333', primary: '#007bff', border: '#dee2e6' }
            },
            {
                id: 'ocean-blue',
                name: 'æµ·æ´‹è“',
                description: 'æ·±é‚ƒæµ·æ´‹é£æ ¼ï¼Œå®é™ä¸“æ³¨',
                colors: { bg: '#0f1419', text: '#e6fffa', primary: '#00d4aa', border: '#1e3a8a' }
            },
            {
                id: 'forest-green',
                name: 'æ£®æ—ç»¿',
                description: 'è‡ªç„¶æ£®æ—é£æ ¼ï¼Œæ¸…æ–°æŠ¤çœ¼',
                colors: { bg: '#0d1b0d', text: '#e8f5e8', primary: '#22c55e', border: '#166534' }
            },
            {
                id: 'sunset-orange',
                name: 'å¤•é˜³æ©™',
                description: 'æ¸©æš–å¤•é˜³é£æ ¼ï¼Œæ´»åŠ›å››å°„',
                colors: { bg: '#1a0f0a', text: '#fff7ed', primary: '#f97316', border: '#c2410c' }
            },
            {
                id: 'purple-night',
                name: 'ç´«å¤œ',
                description: 'ç¥ç§˜ç´«è‰²é£æ ¼ï¼Œä¼˜é›…é«˜è´µ',
                colors: { bg: '#1a0f1a', text: '#f3e8ff', primary: '#a855f7', border: '#7c3aed' }
            },
            {
                id: 'cherry-blossom',
                name: 'æ¨±èŠ±ç²‰',
                description: 'æµªæ¼«æ¨±èŠ±é£æ ¼ï¼Œæ¸©æŸ”ç”œç¾',
                colors: { bg: '#fdf2f8', text: '#831843', primary: '#ec4899', border: '#f9a8d4' }
            },
            {
                id: 'golden-sand',
                name: 'é‡‘æ²™',
                description: 'å¥¢åé‡‘è‰²é£æ ¼ï¼Œå…¸é›…å¤§æ°”',
                colors: { bg: '#1a1611', text: '#fef3c7', primary: '#f59e0b', border: '#d97706' }
            },
            {
                id: 'ice-blue',
                name: 'å†°è“',
                description: 'æ¸…å†·å†°è“é£æ ¼ï¼Œå†·é™ç†æ€§',
                colors: { bg: '#0f1419', text: '#e0f2fe', primary: '#0ea5e9', border: '#0284c7' }
            },
            {
                id: 'rose-red',
                name: 'ç«ç‘°çº¢',
                description: 'çƒ­æƒ…ç«ç‘°é£æ ¼ï¼Œæµªæ¼«æ¿€æƒ…',
                colors: { bg: '#1a0a0a', text: '#ffe4e6', primary: '#e11d48', border: '#be123c' }
            },
            {
                id: 'mint-green',
                name: 'è–„è·ç»¿',
                description: 'æ¸…æ–°è–„è·é£æ ¼ï¼Œèˆ’ç¼“æ”¾æ¾',
                colors: { bg: '#f0fdf4', text: '#14532d', primary: '#10b981', border: '#a7f3d0' }
            },
            {
                id: 'lavender',
                name: 'è–°è¡£è‰',
                description: 'æ·¡é›…è–°è¡£è‰é£æ ¼ï¼Œå®é™å®‰è¯¦',
                colors: { bg: '#faf5ff', text: '#581c87', primary: '#8b5cf6', border: '#c4b5fd' }
            },
            {
                id: 'coffee-brown',
                name: 'å’–å•¡æ£•',
                description: 'æ¸©æš–å’–å•¡é£æ ¼ï¼Œæ²‰ç¨³å†…æ•›',
                colors: { bg: '#1c1917', text: '#fef7ed', primary: '#a16207', border: '#78716c' }
            },
            {
                id: 'slate-gray',
                name: 'çŸ³æ¿ç°',
                description: 'ç°ä»£çŸ³æ¿é£æ ¼ï¼Œç®€çº¦ä¸“ä¸š',
                colors: { bg: '#0f172a', text: '#f1f5f9', primary: '#64748b', border: '#475569' }
            },
            {
                id: 'custom',
                name: 'è‡ªå®šä¹‰',
                description: 'åˆ›å»ºæ‚¨çš„ä¸“å±ä¸»é¢˜',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            }
        ];

        return themes.map(theme => {
            const isActive = theme.id === 'default-dark' ? 'active' : '';
            const isCustom = theme.id === 'custom';
            const currentBadge = theme.id === 'default-dark' ? '<div class="current-badge">å½“å‰</div>' : '';

            return `
                <div class="theme-preview-card ${isActive}"
                     data-theme="${theme.id}"
                     data-custom="${isCustom}">
                    <div class="theme-preview-mini" style="background: ${theme.colors.bg}; border: 1px solid ${theme.colors.border};">
                        <div class="preview-header-mini" style="background: ${theme.colors.primary}; color: ${theme.colors.bg};">æ ‡é¢˜</div>
                        <div class="preview-content-mini" style="color: ${theme.colors.text};">å†…å®¹</div>
                        <div class="preview-button-mini" style="background: ${theme.colors.primary}; color: ${theme.colors.bg};">æŒ‰é’®</div>
                    </div>
                    <div class="theme-info">
                        <h4>${theme.name}</h4>
                        <p>${theme.description}</p>
                    </div>
                    ${currentBadge}
                </div>
            `;
        }).join('');
    }

    /**
     * åˆ›å»ºä¿¡æ¯æ é£æ ¼é¢„è§ˆç½‘æ ¼
     */
    createStylePreviewGrid() {
        const styles = [
            {
                id: 'end-generated',
                name: 'ç»“å°¾ç”Ÿæˆå¼',
                description: 'åœ¨å¯¹è¯ç»“å°¾æ˜¾ç¤ºä¿¡æ¯æ ï¼Œä¸å¹²æ‰°å¯¹è¯æµç¨‹',
                icon: 'ğŸ“',
                preview: {
                    layout: 'end',
                    position: 'bottom',
                    integration: 'separate'
                }
            },
            {
                id: 'flat',
                name: 'æ‰å¹³å¼',
                description: 'ç®€æ´æ‰å¹³çš„é¡¶éƒ¨æ ï¼Œæ”¯æŒä¸€é”®å±•å¼€/æ”¶èµ·',
                icon: 'ğŸ“‹',
                preview: {
                    layout: 'flat',
                    position: 'bottom',
                    integration: 'separate'
                }
            },
            {
                id: 'conversation-wrapped',
                name: 'å¯¹è¯åŒ…è£¹å¼',
                description: 'å°†æ•´ä¸ªå¯¹è¯å†…å®¹åŒ…è£¹åœ¨ä¿¡æ¯æ æ¡†æ¶ä¸­',
                icon: 'ğŸ',
                preview: {
                    layout: 'wrapped',
                    position: 'around',
                    integration: 'integrated'
                }
            },
            {
                id: 'sidebar',
                name: 'ä¾§è¾¹æ å¼',
                description: 'åœ¨å¯¹è¯ä¾§è¾¹æ˜¾ç¤ºå›ºå®šçš„ä¿¡æ¯æ ',
                icon: 'ğŸ“‹',
                preview: {
                    layout: 'sidebar',
                    position: 'side',
                    integration: 'parallel'
                }
            },
            {
                id: 'floating',
                name: 'æµ®åŠ¨å¼',
                description: 'æ‚¬æµ®æ˜¾ç¤ºçš„å¯æ‹–æ‹½ä¿¡æ¯æ ',
                icon: 'ğŸˆ',
                preview: {
                    layout: 'floating',
                    position: 'overlay',
                    integration: 'independent'
                }
            },
            {
                id: 'embedded',
                name: 'å†…åµŒå¼',
                description: 'åµŒå…¥åˆ°å¯¹è¯å†…å®¹ä¸­çš„ä¿¡æ¯æ ',
                icon: 'ğŸ”—',
                preview: {
                    layout: 'embedded',
                    position: 'inline',
                    integration: 'merged'
                }
            },
            {
                id: 'interactive',
                name: 'å‰ç«¯äº¤äº’å¼',
                description: 'åŠŸèƒ½ä¸°å¯Œçš„äº¤äº’å¼ä¿¡æ¯æ ç•Œé¢ï¼ŒåŒ…å«æŒ‰é’®ã€è¾“å…¥æ¡†ã€æ ‡ç­¾é¡µç­‰',
                icon: 'ğŸ›ï¸',
                preview: {
                    layout: 'interactive',
                    position: 'overlay',
                    integration: 'advanced'
                }
            },
            {
                id: 'custom-html',
                name: 'HTMLå¼',
                description: 'ä½¿ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿æ¸²æŸ“ä¿¡æ¯æ ï¼Œæ”¯æŒå®Œå…¨è‡ªå®šä¹‰çš„æ ·å¼å’Œå¸ƒå±€',
                icon: 'ğŸ¨',
                preview: {
                    layout: 'custom',
                    position: 'template',
                    integration: 'html'
                }
            }
        ];

        return styles.map(style => {
            const isActive = style.id === 'end-generated' ? 'active' : '';
            const currentBadge = style.id === 'end-generated' ? '<div class="current-badge">å½“å‰</div>' : '';

            return `
                <div class="style-preview-card ${isActive}"
                     data-style="${style.id}">
                    <div class="style-preview-mini">
                        <div class="style-icon">${style.icon}</div>
                        <div class="style-layout-demo">
                            ${this.createStyleLayoutDemo(style.preview)}
                        </div>
                    </div>
                    <div class="style-info">
                        <h4>${style.name}</h4>
                        <p>${style.description}</p>
                    </div>
                    ${currentBadge}
                </div>
            `;
        }).join('');
    }

    /**
     * åˆ›å»ºé£æ ¼å¸ƒå±€æ¼”ç¤º
     * @param {Object} preview - é¢„è§ˆé…ç½®
     */
    createStyleLayoutDemo(preview) {
        switch (preview.layout) {
            case 'end':
                return `
                    <div class="demo-chat">ğŸ’¬</div>
                    <div class="demo-infobar">ğŸ“Š</div>
                `;
            case 'flat':
                return `
                    <div class="demo-chat">ğŸ’¬</div>
                    <div class="demo-infobar">â€”ğŸ“Šâ€”</div>
                `;
            case 'wrapped':
                return `
                    <div class="demo-wrapper">
                        <div class="demo-chat">ğŸ’¬</div>
                        <div class="demo-frame">ğŸ“Š</div>
                    </div>
                `;
            case 'sidebar':
                return `
                    <div class="demo-layout">
                        <div class="demo-chat">ğŸ’¬</div>
                        <div class="demo-sidebar">ğŸ“Š</div>
                    </div>
                `;
            case 'floating':
                return `
                    <div class="demo-base">ğŸ’¬</div>
                    <div class="demo-float">ğŸ“Š</div>
                `;
            case 'embedded':
                return `
                    <div class="demo-merged">
                        ğŸ’¬ğŸ“Š
                    </div>
                `;
            case 'custom':
                return `
                    <div class="demo-custom">
                        <div class="demo-chat">ğŸ’¬</div>
                        <div class="demo-html">ğŸ¨</div>
                    </div>
                `;
            default:
                return `<div class="demo-default">ğŸ“Š</div>`;
        }
    }
    /**
     * é€‰æ‹©ä¸»é¢˜
     * @param {string} themeId - ä¸»é¢˜ID
     */
    async selectTheme(themeId) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ é€‰æ‹©ä¸»é¢˜:', themeId);

            // è·å–ä¸»é¢˜é…ç½®
            const theme = this.getThemeById(themeId);
            if (!theme) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°ä¸»é¢˜:', themeId);
                return;
            }

            // åº”ç”¨ä¸»é¢˜
            this.applyTheme(theme);

            // æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
            this.updateThemeCardStates(themeId);

            // æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯
            this.updateCurrentThemeInfo(theme);

            // ä¿å­˜ä¸»é¢˜é…ç½®
            await this.saveThemeConfig(themeId);

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜åˆ‡æ¢å®Œæˆ:', theme.name);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * é€‰æ‹©ä¿¡æ¯æ é£æ ¼
     * @param {string} styleId - é£æ ¼ID
     */
    async selectStyle(styleId) {
        try {
            console.log('[InfoBarSettings] ğŸ­ é€‰æ‹©ä¿¡æ¯æ é£æ ¼:', styleId);

            // è·å–é£æ ¼é…ç½®
            const style = this.getStyleById(styleId);
            if (!style) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°é£æ ¼:', styleId);
                return;
            }

            // åº”ç”¨é£æ ¼
            this.applyStyle(style);

            // æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
            this.updateStyleCardStates(styleId);

            // æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯
            this.updateCurrentStyleInfo(style);

            // ä¿å­˜é£æ ¼é…ç½®
            await this.saveStyleConfig(styleId);

            // åˆ·æ–°æ‰€æœ‰å·²æ¸²æŸ“çš„ä¿¡æ¯æ 
            await this.refreshAllInfoBars();

            console.log('[InfoBarSettings] âœ… é£æ ¼åˆ‡æ¢å®Œæˆ:', style.name);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ é€‰æ‹©é£æ ¼å¤±è´¥:', error);
        }
    }

    /**
     * åˆ·æ–°æ‰€æœ‰å·²æ¸²æŸ“çš„ä¿¡æ¯æ 
     */
    async refreshAllInfoBars() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰ä¿¡æ¯æ ');

            // è·å–MessageInfoBarRendererå®ä¾‹
            const renderer = window.SillyTavernInfobar?.modules?.messageInfoBarRenderer;
            if (renderer && typeof renderer.refreshAllInfoBars === 'function') {
                await renderer.refreshAllInfoBars();
                console.log('[InfoBarSettings] âœ… ä¿¡æ¯æ åˆ·æ–°å®Œæˆ');
            } else {
                console.log('[InfoBarSettings] âš ï¸ MessageInfoBarRendereræœªæ‰¾åˆ°æˆ–ä¸æ”¯æŒåˆ·æ–°');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°ä¿¡æ¯æ å¤±è´¥:', error);
        }
    }

    /**
     * æ ¹æ®IDè·å–é£æ ¼é…ç½®
     * @param {string} styleId - é£æ ¼ID
     * @returns {Object|null} é£æ ¼é…ç½®å¯¹è±¡
     */
    getStyleById(styleId) {
        const styles = [
            {
                id: 'end-generated',
                name: 'ç»“å°¾ç”Ÿæˆå¼',
                description: 'åœ¨å¯¹è¯ç»“å°¾æ˜¾ç¤ºä¿¡æ¯æ ï¼Œä¸å¹²æ‰°å¯¹è¯æµç¨‹',
                config: {
                    position: 'end',
                    layout: 'bottom',
                    integration: 'separate',
                    animation: 'slideUp',
                    autoHide: false,
                    collapsible: true
                }
            },
            {
                id: 'flat',
                name: 'æ‰å¹³å¼',
                description: 'ç®€æ´æ‰å¹³çš„é¡¶éƒ¨æ ï¼Œæ”¯æŒä¸€é”®å±•å¼€/æ”¶èµ·',
                config: {
                    position: 'end',
                    layout: 'flat',
                    integration: 'separate',
                    animation: 'none',
                    autoHide: false,
                    collapsible: true
                }
            },
            {
                id: 'conversation-wrapped',
                name: 'å¯¹è¯åŒ…è£¹å¼',
                description: 'å°†æ•´ä¸ªå¯¹è¯å†…å®¹åŒ…è£¹åœ¨ä¿¡æ¯æ æ¡†æ¶ä¸­',
                config: {
                    position: 'wrapper',
                    layout: 'frame',
                    integration: 'integrated',
                    animation: 'fadeIn',
                    autoHide: false,
                    collapsible: false
                }
            },
            {
                id: 'sidebar',
                name: 'ä¾§è¾¹æ å¼',
                description: 'åœ¨å¯¹è¯ä¾§è¾¹æ˜¾ç¤ºå›ºå®šçš„ä¿¡æ¯æ ',
                config: {
                    position: 'side',
                    layout: 'vertical',
                    integration: 'parallel',
                    animation: 'slideLeft',
                    autoHide: false,
                    collapsible: true
                }
            },
            {
                id: 'floating',
                name: 'æµ®åŠ¨å¼',
                description: 'æ‚¬æµ®æ˜¾ç¤ºçš„å¯æ‹–æ‹½ä¿¡æ¯æ ',
                config: {
                    position: 'overlay',
                    layout: 'floating',
                    integration: 'independent',
                    animation: 'bounce',
                    autoHide: true,
                    collapsible: true,
                    draggable: true
                }
            },
            {
                id: 'embedded',
                name: 'å†…åµŒå¼',
                description: 'åµŒå…¥åˆ°å¯¹è¯å†…å®¹ä¸­çš„ä¿¡æ¯æ ',
                config: {
                    position: 'inline',
                    layout: 'embedded',
                    integration: 'merged',
                    animation: 'expand',
                    autoHide: false,
                    collapsible: false
                }
            },
            {
                id: 'interactive',
                name: 'å‰ç«¯äº¤äº’å¼',
                description: 'åŠŸèƒ½ä¸°å¯Œçš„äº¤äº’å¼ä¿¡æ¯æ ç•Œé¢ï¼ŒåŒ…å«æŒ‰é’®ã€è¾“å…¥æ¡†ã€æ ‡ç­¾é¡µç­‰',
                config: {
                    position: 'overlay',
                    layout: 'interactive',
                    integration: 'advanced',
                    animation: 'slideIn',
                    autoHide: false,
                    collapsible: true,
                    draggable: true,
                    resizable: true,
                    tabbed: true,
                    interactive: true
                }
            },
            {
                id: 'custom-html',
                name: 'HTMLå¼',
                description: 'ä½¿ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿æ¸²æŸ“ä¿¡æ¯æ ï¼Œæ”¯æŒå®Œå…¨è‡ªå®šä¹‰çš„æ ·å¼å’Œå¸ƒå±€',
                config: {
                    position: 'end',
                    layout: 'custom',
                    integration: 'template',
                    animation: 'fadeIn',
                    autoHide: false,
                    collapsible: true,
                    customTemplate: true,
                    htmlSupport: true,
                    dataBinding: true
                }
            }
        ];

        return styles.find(style => style.id === styleId) || null;
    }

    /**
     * åº”ç”¨ä¿¡æ¯æ é£æ ¼
     * @param {Object} style - é£æ ¼é…ç½®å¯¹è±¡
     */
    applyStyle(style) {
        try {
            console.log('[InfoBarSettings] ğŸ­ åº”ç”¨ä¿¡æ¯æ é£æ ¼:', style.name);

            // æ›´æ–°å…¨å±€é£æ ¼é…ç½®
            window.InfoBarStyleConfig = {
                currentStyle: style.id,
                config: style.config,
                timestamp: Date.now()
            };

            // é€šè¿‡äº‹ä»¶ç³»ç»Ÿé€šçŸ¥å…¶ä»–æ¨¡å—é£æ ¼å˜æ›´
            if (this.eventSystem) {
                this.eventSystem.emit('style:changed', {
                    styleId: style.id,
                    config: style.config,
                    name: style.name
                });
            }

            console.log('[InfoBarSettings] âœ… ä¿¡æ¯æ é£æ ¼åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¿¡æ¯æ é£æ ¼å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€
     * @param {string} activeStyleId - æ¿€æ´»çš„é£æ ¼ID
     */
    updateStyleCardStates(activeStyleId) {
        try {
            const styleCards = this.modal.querySelectorAll('.style-preview-card');
            styleCards.forEach(card => {
                const styleId = card.dataset.style;
                const isActive = styleId === activeStyleId;

                // æ›´æ–°æ¿€æ´»çŠ¶æ€
                card.classList.toggle('active', isActive);

                // æ›´æ–°å½“å‰æ ‡ç­¾
                const currentBadge = card.querySelector('.current-badge');
                if (isActive && !currentBadge) {
                    card.insertAdjacentHTML('beforeend', '<div class="current-badge">å½“å‰</div>');
                } else if (!isActive && currentBadge) {
                    currentBadge.remove();
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é£æ ¼å¡ç‰‡çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯
     * @param {Object} style - é£æ ¼é…ç½®å¯¹è±¡
     */
    updateCurrentStyleInfo(style) {
        try {
            const currentStyleInput = this.modal.querySelector('input[name="style.current"]');
            const styleDescTextarea = this.modal.querySelector('textarea[name="style.description"]');

            if (currentStyleInput) {
                currentStyleInput.value = style.name;
            }

            if (styleDescTextarea) {
                styleDescTextarea.value = style.description;
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å½“å‰é£æ ¼ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜é£æ ¼é…ç½®
     * @param {string} styleId - é£æ ¼ID
     */
    async saveStyleConfig(styleId) {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜é£æ ¼é…ç½®
            extensionSettings['Information bar integration tool'].style = {
                current: styleId,
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨ SillyTavern çš„æŒä¹…åŒ–æ–¹æ³•
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] ğŸ’¾ é£æ ¼é…ç½®å·²ä¿å­˜åˆ° extensionSettings:', styleId);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜é£æ ¼é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ ¹æ®IDè·å–ä¸»é¢˜é…ç½®
     * @param {string} themeId - ä¸»é¢˜ID
     * @returns {Object|null} ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    getThemeById(themeId) {
        const themes = [
            {
                id: 'default-dark',
                name: 'é»˜è®¤æ·±è‰²',
                description: 'ç»å…¸æ·±è‰²ä¸»é¢˜ï¼ŒæŠ¤çœ¼èˆ’é€‚',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            },
            {
                id: 'default-light',
                name: 'é»˜è®¤æµ…è‰²',
                description: 'æ¸…æ–°æµ…è‰²ä¸»é¢˜ï¼Œç®€æ´æ˜äº®',
                colors: { bg: '#ffffff', text: '#333333', primary: '#007bff', border: '#dee2e6' }
            },
            {
                id: 'ocean-blue',
                name: 'æµ·æ´‹è“',
                description: 'æ·±é‚ƒæµ·æ´‹é£æ ¼ï¼Œå®é™ä¸“æ³¨',
                colors: { bg: '#0f1419', text: '#e6fffa', primary: '#00d4aa', border: '#1e3a8a' }
            },
            {
                id: 'forest-green',
                name: 'æ£®æ—ç»¿',
                description: 'è‡ªç„¶æ£®æ—é£æ ¼ï¼Œæ¸…æ–°æŠ¤çœ¼',
                colors: { bg: '#0d1b0d', text: '#e8f5e8', primary: '#22c55e', border: '#166534' }
            },
            {
                id: 'sunset-orange',
                name: 'å¤•é˜³æ©™',
                description: 'æ¸©æš–å¤•é˜³é£æ ¼ï¼Œæ´»åŠ›å››å°„',
                colors: { bg: '#1a0f0a', text: '#fff4e6', primary: '#ff8c00', border: '#cc4400' }
            },
            {
                id: 'purple-night',
                name: 'ç´«å¤œ',
                description: 'ç¥ç§˜ç´«è‰²é£æ ¼ï¼Œä¼˜é›…é«˜è´µ',
                colors: { bg: '#1a0d1a', text: '#f0e6ff', primary: '#9d4edd', border: '#6a1b9a' }
            },
            {
                id: 'cherry-blossom',
                name: 'æ¨±èŠ±ç²‰',
                description: 'æµªæ¼«æ¨±èŠ±é£æ ¼ï¼Œæ¸©æŸ”ç”œç¾',
                colors: { bg: '#1a1014', text: '#ffe6f0', primary: '#ff69b4', border: '#d1477a' }
            },
            {
                id: 'golden-sand',
                name: 'é‡‘æ²™',
                description: 'å¥¢åé‡‘è‰²é£æ ¼ï¼Œå°Šè´µå…¸é›…',
                colors: { bg: '#1a1610', text: '#fff8dc', primary: '#ffd700', border: '#b8860b' }
            },
            {
                id: 'ice-blue',
                name: 'å†°è“',
                description: 'æ¸…å†·å†°è“é£æ ¼ï¼Œçº¯å‡€æ¸…æ–°',
                colors: { bg: '#0a1419', text: '#e6f7ff', primary: '#00bfff', border: '#0080cc' }
            },
            {
                id: 'rose-red',
                name: 'ç«ç‘°çº¢',
                description: 'çƒ­æƒ…ç«ç‘°é£æ ¼ï¼Œæµªæ¼«æ¿€æƒ…',
                colors: { bg: '#1a0a0f', text: '#ffe6eb', primary: '#dc143c', border: '#a0102a' }
            },
            {
                id: 'mint-green',
                name: 'è–„è·ç»¿',
                description: 'æ¸…æ–°è–„è·é£æ ¼ï¼Œè‡ªç„¶èˆ’ç¼“',
                colors: { bg: '#0a1a14', text: '#e6fff2', primary: '#00fa9a', border: '#00cc7a' }
            },
            {
                id: 'lavender',
                name: 'è–°è¡£è‰',
                description: 'æ·¡é›…è–°è¡£è‰é£æ ¼ï¼Œå®é™å®‰è¯¦',
                colors: { bg: '#14141a', text: '#f0f0ff', primary: '#9370db', border: '#7b68ee' }
            },
            {
                id: 'coffee-brown',
                name: 'å’–å•¡æ£•',
                description: 'æ¸©æš–å’–å•¡é£æ ¼ï¼Œæ²‰ç¨³å†…æ•›',
                colors: { bg: '#1a1410', text: '#f5f0e6', primary: '#8b4513', border: '#654321' }
            },
            {
                id: 'slate-gray',
                name: 'çŸ³æ¿ç°',
                description: 'ç°ä»£çŸ³æ¿é£æ ¼ï¼Œç®€çº¦ä¸“ä¸š',
                colors: { bg: '#1a1a1a', text: '#e6e6e6', primary: '#708090', border: '#556b7d' }
            },
            {
                id: 'custom',
                name: 'è‡ªå®šä¹‰',
                description: 'åˆ›å»ºæ‚¨çš„ä¸“å±ä¸»é¢˜',
                colors: { bg: '#1a1a1a', text: '#ffffff', primary: '#007bff', border: '#333' }
            }
        ];

        return themes.find(theme => theme.id === themeId) || null;
    }

    /**
     * åº”ç”¨ä¸»é¢˜
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyTheme(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜:', theme.name);

            // è®¡ç®—è¡ç”Ÿé¢œè‰²
            const bgSecondary = this.adjustColor(theme.colors.bg, 10);
            const textSecondary = this.adjustColor(theme.colors.text, -20);
            const primaryHover = this.adjustColor(theme.colors.primary, -10);

            // æ›´æ–°CSSå˜é‡
            const root = document.documentElement;
            root.style.setProperty('--theme-bg-primary', theme.colors.bg);
            root.style.setProperty('--theme-bg-secondary', bgSecondary);
            root.style.setProperty('--theme-text-primary', theme.colors.text);
            root.style.setProperty('--theme-text-secondary', textSecondary);
            root.style.setProperty('--theme-primary-color', theme.colors.primary);
            root.style.setProperty('--theme-primary-hover', primaryHover);
            root.style.setProperty('--theme-border-color', theme.colors.border);

            // åº”ç”¨åˆ°ä¿¡æ¯æ è®¾ç½®ç•Œé¢
            this.applyThemeToInfoBarSettings(theme);

            // åº”ç”¨åˆ°æ•°æ®è¡¨æ ¼ç•Œé¢
            this.applyThemeToDataTable(theme);

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€
     * @param {string} activeThemeId - æ¿€æ´»çš„ä¸»é¢˜ID
     */
    updateThemeCardStates(activeThemeId) {
        try {
            const themeCards = this.modal.querySelectorAll('.theme-preview-card');
            themeCards.forEach(card => {
                const themeId = card.dataset.theme;
                const currentBadge = card.querySelector('.current-badge');

                if (themeId === activeThemeId) {
                    card.classList.add('active');
                    if (!currentBadge) {
                        const badge = document.createElement('div');
                        badge.className = 'current-badge';
                        badge.textContent = 'å½“å‰';
                        card.appendChild(badge);
                    }
                } else {
                    card.classList.remove('active');
                    if (currentBadge) {
                        currentBadge.remove();
                    }
                }
            });
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸»é¢˜å¡ç‰‡çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    updateCurrentThemeInfo(theme) {
        try {
            const currentThemeInput = this.modal.querySelector('[name="theme.current"]');
            const themeDescriptionTextarea = this.modal.querySelector('[name="theme.description"]');

            if (currentThemeInput) {
                currentThemeInput.value = theme.name;
            }

            if (themeDescriptionTextarea) {
                themeDescriptionTextarea.value = theme.description;
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å½“å‰ä¸»é¢˜ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ä¿å­˜ä¸»é¢˜é…ç½®
     * @param {string} themeId - ä¸»é¢˜ID
     */
    async saveThemeConfig(themeId) {
        try {
            // ä½¿ç”¨ SillyTavern æ ‡å‡†å­˜å‚¨æœºåˆ¶
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;

            // ç¡®ä¿æ‰©å±•è®¾ç½®å¯¹è±¡å­˜åœ¨
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // ä¿å­˜ä¸»é¢˜é…ç½®
            extensionSettings['Information bar integration tool'].theme = {
                current: themeId,
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨ SillyTavern çš„æŒä¹…åŒ–æ–¹æ³•
            context.saveSettingsDebounced();

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜é…ç½®å·²ä¿å­˜åˆ° extensionSettings:', themeId);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜ä¸»é¢˜é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°ä¿¡æ¯æ è®¾ç½®ç•Œé¢
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyThemeToInfoBarSettings(theme) {
        try {
            if (!this.modal) return;

            // åº”ç”¨åˆ°æ¨¡æ€æ¡†
            this.modal.style.backgroundColor = theme.colors.bg;
            this.modal.style.color = theme.colors.text;
            this.modal.style.borderColor = theme.colors.border;

            // åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³å…ƒç´ ï¼Œä½†æ’é™¤å¯¼èˆªé¡¹
            const elements = this.modal.querySelectorAll('.modal-header, .modal-body, .modal-footer, .content-panel');
            elements.forEach(element => {
                element.style.backgroundColor = theme.colors.bg;
                element.style.color = theme.colors.text;
                element.style.borderColor = theme.colors.border;
            });

            // ğŸ”§ ä¿®å¤ï¼šå•ç‹¬å¤„ç†å¯¼èˆªé¡¹ï¼Œä¿æŒæ¿€æ´»çŠ¶æ€çš„æ­£ç¡®æ ·å¼
            const navItems = this.modal.querySelectorAll('.nav-item');
            navItems.forEach(navItem => {
                if (navItem.classList.contains('active')) {
                    // æ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨ä¸»é¢˜è‰²
                    navItem.style.backgroundColor = theme.colors.primary;
                    navItem.style.color = theme.colors.text;
                    navItem.style.borderLeftColor = theme.colors.primary;
                } else {
                    // éæ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨èƒŒæ™¯è‰²
                    navItem.style.backgroundColor = theme.colors.bg;
                    navItem.style.color = theme.colors.text;
                    navItem.style.borderColor = theme.colors.border;
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°æ€»ç»“é¢æ¿ç‰¹å®šå…ƒç´ 
            this.applySummaryPanelTheme(theme);

            // ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°å˜é‡ç®¡ç†å™¨ç‰¹å®šå…ƒç´ 
            this.applyVariableManagerTheme(theme);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°ä¿¡æ¯æ è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå•ç‹¬åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
     */
    applyNavItemTheme() {
        try {
            if (!this.modal) return;

            // è·å–å½“å‰æ¿€æ´»çš„ä¸»é¢˜
            const activeThemeCard = this.modal.querySelector('.theme-preview-card.active');
            if (!activeThemeCard) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ¿€æ´»çš„ä¸»é¢˜å¡ç‰‡');
                return;
            }

            const themeId = activeThemeCard.getAttribute('data-theme');
            const currentTheme = this.getThemeById(themeId);
            if (!currentTheme || !currentTheme.colors) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°ä¸»é¢˜é…ç½®:', themeId);
                return;
            }

            // åº”ç”¨å¯¼èˆªé¡¹ä¸»é¢˜æ ·å¼
            const navItems = this.modal.querySelectorAll('.nav-item');
            navItems.forEach(navItem => {
                if (navItem.classList.contains('active')) {
                    // æ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨ä¸»é¢˜è‰²
                    navItem.style.backgroundColor = currentTheme.colors.primary;
                    navItem.style.color = currentTheme.colors.text;
                    navItem.style.borderLeftColor = currentTheme.colors.primary;
                } else {
                    // éæ¿€æ´»çŠ¶æ€çš„å¯¼èˆªé¡¹ä½¿ç”¨èƒŒæ™¯è‰²
                    navItem.style.backgroundColor = currentTheme.colors.bg;
                    navItem.style.color = currentTheme.colors.text;
                    navItem.style.borderColor = currentTheme.colors.border;
                }
            });

            console.log('[InfoBarSettings] âœ… å¯¼èˆªé¡¹ä¸»é¢˜åº”ç”¨å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼èˆªé¡¹ä¸»é¢˜åº”ç”¨å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°æ€»ç»“é¢æ¿å…ƒç´ 
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applySummaryPanelTheme(theme) {
        try {
            if (!this.modal) return;

            // æ€»ç»“é¢æ¿å®¹å™¨
            const summaryContainers = this.modal.querySelectorAll('.summary-settings-container, .summary-history-container, .summary-content-container');
            summaryContainers.forEach(container => {
                container.style.backgroundColor = theme.colors.bg;
                container.style.color = theme.colors.text;
                container.style.borderColor = theme.colors.border;
            });

            // è®¾ç½®åŒºåŸŸ
            const settingSections = this.modal.querySelectorAll('.settings-section, .history-section, .content-section');
            settingSections.forEach(section => {
                section.style.backgroundColor = this.adjustColor(theme.colors.bg, 5);
                section.style.color = theme.colors.text;
                section.style.borderColor = theme.colors.border;
            });

            // è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†
            const inputs = this.modal.querySelectorAll('#content-auto-summary-enabled, #content-summary-floor-count, #content-summary-type, #content-summary-word-count, #content-summary-history-select');
            inputs.forEach(input => {
                input.style.backgroundColor = theme.colors.bg;
                input.style.color = theme.colors.text;
                input.style.borderColor = theme.colors.border;
            });

            // åˆ é™¤æŒ‰é’®
            const deleteBtn = this.modal.querySelector('#content-delete-summary-btn');
            if (deleteBtn) {
                deleteBtn.style.backgroundColor = theme.colors.primary;
                deleteBtn.style.color = theme.colors.bg;
                deleteBtn.style.borderColor = theme.colors.primary;
            }

            // æŒ‰é’®
            const buttons = this.modal.querySelectorAll('#header-manual-summary-btn, #header-refresh-summary-btn, #content-save-settings-btn, #content-delete-summary-btn, [data-action="open-error-log"], [data-action="open-project-link"], [data-action="save-profile"], [data-action="load-profile"], [data-action="delete-profile"], [data-action="export"], [data-action="import"]');
            buttons.forEach(button => {
                button.style.backgroundColor = theme.colors.primary;
                button.style.color = theme.colors.bg;
                button.style.borderColor = theme.colors.primary;
            });

            // æ ‡ç­¾å’Œæç¤ºæ–‡æœ¬
            const labels = this.modal.querySelectorAll('.setting-label, .setting-hint, .content-meta');
            labels.forEach(label => {
                label.style.color = this.adjustColor(theme.colors.text, -20);
            });

            // å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
            const contentBody = this.modal.querySelector('#content-summary-content-body');
            if (contentBody) {
                contentBody.style.backgroundColor = this.adjustColor(theme.colors.bg, 3);
                contentBody.style.color = theme.colors.text;
                contentBody.style.borderColor = theme.colors.border;
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨æ€»ç»“é¢æ¿ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šåº”ç”¨ä¸»é¢˜åˆ°å˜é‡ç®¡ç†å™¨
     */
    applyVariableManagerTheme(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜...');

            // å˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
            const variableModal = document.querySelector('#variable-manager-modal');
            if (!variableModal) {
                console.log('[InfoBarSettings] â„¹ï¸ å˜é‡ç®¡ç†å™¨æœªæ‰“å¼€ï¼Œè·³è¿‡ä¸»é¢˜åº”ç”¨');
                return;
            }

            // åº”ç”¨ä¸»é¢˜åˆ°æ¨¡æ€æ¡†å®¹å™¨
            const modalContainer = variableModal.querySelector('.modal-container');
            if (modalContainer) {
                modalContainer.style.backgroundColor = theme.colors.bg;
                modalContainer.style.color = theme.colors.text;
                modalContainer.style.borderColor = theme.colors.border;
            }

            // åº”ç”¨ä¸»é¢˜åˆ°å˜é‡é¡¹
            const variableItems = variableModal.querySelectorAll('.variable-item');
            variableItems.forEach(item => {
                item.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 3), 'important');
                item.style.setProperty('color', theme.colors.text, 'important');
                item.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // ğŸ”§ ä¿®å¤ï¼šå¼ºåˆ¶åº”ç”¨ä¸»é¢˜åˆ°object-propertyå’Œnested-arrayå…ƒç´ 
            const objectProperties = variableModal.querySelectorAll('.object-property, .nested-array, .nested-object');
            objectProperties.forEach(element => {
                element.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 5), 'important');
                element.style.setProperty('color', theme.colors.text, 'important');
                element.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°åµŒå¥—é¡¹å®¹å™¨
            const nestedItems = variableModal.querySelectorAll('.nested-items');
            nestedItems.forEach(container => {
                container.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 2), 'important');
                container.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†
            const inputs = variableModal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.style.setProperty('background-color', theme.colors.bg, 'important');
                input.style.setProperty('color', theme.colors.text, 'important');
                input.style.setProperty('border-color', theme.colors.border, 'important');
            });

            // åº”ç”¨ä¸»é¢˜åˆ°æŒ‰é’®
            const buttons = variableModal.querySelectorAll('.btn, .btn-icon, .btn-icon-small');
            buttons.forEach(button => {
                if (button.classList.contains('btn-primary') || button.classList.contains('btn-success')) {
                    button.style.setProperty('background-color', theme.colors.primary, 'important');
                    button.style.setProperty('color', theme.colors.bg, 'important');
                } else if (button.classList.contains('btn-danger')) {
                    button.style.setProperty('background-color', '#dc3545', 'important');
                    button.style.setProperty('color', 'white', 'important');
                } else {
                    button.style.setProperty('background-color', this.adjustColor(theme.colors.bg, 10), 'important');
                    button.style.setProperty('color', theme.colors.text, 'important');
                }
                button.style.setProperty('border-color', theme.colors.border, 'important');
            });

            console.log('[InfoBarSettings] âœ… å˜é‡ç®¡ç†å™¨ä¸»é¢˜åº”ç”¨å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼ç•Œé¢
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    applyThemeToDataTable(theme) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼:', theme.name || theme.id);

            // é€šè¿‡äº‹ä»¶ç³»ç»Ÿé€šçŸ¥æ•°æ®è¡¨æ ¼æ›´æ–°ä¸»é¢˜
            if (this.eventSystem) {
                this.eventSystem.emit('theme:changed', {
                    themeId: theme.id,
                    colors: theme.colors
                });
            }

            // ğŸ”§ æ–°å¢ï¼šç›´æ¥æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜çš„ä¸»é¢˜æ ·å¼
            this.updateDataTableHeaderTheme(theme);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨ä¸»é¢˜åˆ°æ•°æ®è¡¨æ ¼å¤±è´¥:', error);
        }
    }
    /**
     * æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜çš„ä¸»é¢˜æ ·å¼
     * @param {Object} theme - ä¸»é¢˜é…ç½®å¯¹è±¡
     */
    updateDataTableHeaderTheme(theme) {
        try {
            // æŸ¥æ‰¾æ•°æ®è¡¨æ ¼æ¨¡æ€æ¡†
            const dataTableModal = document.querySelector('.data-table-modal, .datatable-modal-new');
            if (!dataTableModal) {
                console.log('[InfoBarSettings] â„¹ï¸ æ•°æ®è¡¨æ ¼ç•Œé¢æœªæ‰“å¼€ï¼Œè·³è¿‡æ ‡é¢˜ä¸»é¢˜æ›´æ–°');
                return;
            }

            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const modalHeader = dataTableModal.querySelector('.modal-header');
            const modalTitle = dataTableModal.querySelector('.modal-title, h2');

            if (modalHeader && theme.colors) {
                // åº”ç”¨ä¸»é¢˜èƒŒæ™¯è‰²
                if (theme.colors.headerBg) {
                    modalHeader.style.background = theme.colors.headerBg;
                }
                if (theme.colors.headerBorder) {
                    modalHeader.style.borderBottomColor = theme.colors.headerBorder;
                }
            }

            if (modalTitle && theme.colors) {
                // åº”ç”¨ä¸»é¢˜æ–‡å­—è‰²
                if (theme.colors.headerText) {
                    modalTitle.style.color = theme.colors.headerText;
                }
            }

            // æ›´æ–°è¡¨æ ¼æ ‡é¢˜è¡Œ
            const tableHeader = dataTableModal.querySelector('.table-header');
            if (tableHeader && theme.colors) {
                if (theme.colors.tableBg) {
                    tableHeader.style.backgroundColor = theme.colors.tableBg;
                }
                if (theme.colors.tableText) {
                    tableHeader.style.color = theme.colors.tableText;
                }
                if (theme.colors.tableBorder) {
                    tableHeader.style.borderBottomColor = theme.colors.tableBorder;
                }
            }

            console.log('[InfoBarSettings] âœ… æ•°æ®è¡¨æ ¼æ ‡é¢˜ä¸»é¢˜å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ•°æ®è¡¨æ ¼æ ‡é¢˜ä¸»é¢˜å¤±è´¥:', error);
        }
    }

    /**
     * è°ƒæ•´é¢œè‰²äº®åº¦
     * @param {string} color - åå…­è¿›åˆ¶é¢œè‰²å€¼
     * @param {number} amount - è°ƒæ•´é‡ï¼ˆ-100åˆ°100ï¼‰
     * @returns {string} è°ƒæ•´åçš„é¢œè‰²å€¼
     */
    adjustColor(color, amount) {
        try {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è°ƒæ•´é¢œè‰²å¤±è´¥:', error);
            return color;
        }
    }

    /**
     * è·å–çŠ¶æ€ä¿¡æ¯
     */
    getStatus() {
        return {
            initialized: this.initialized,
            visible: this.visible,
            currentTab: this.currentTab,
            errorCount: this.errorCount
        };
    }

    /**
     * é”€æ¯ç»„ä»¶
     */
    destroy() {
        if (this.modal) {
            this.modal.remove();
            this.modal = null;
        }

        this.initialized = false;
        console.log('[InfoBarSettings] ğŸ’¥ è®¾ç½®ç•Œé¢å·²é”€æ¯');
    }

    /**
     * åŠ è½½æ¨¡å‹åˆ—è¡¨
     */
    async loadModelList() {
        console.log('[InfoBarSettings] å¼€å§‹åŠ è½½æ¨¡å‹åˆ—è¡¨');
        const loadModelsBtn = document.getElementById('load-models-btn');
        const modelSelect = document.getElementById('api-model');
        const connectionStatus = document.getElementById('connection-status');

        if (loadModelsBtn) {
            loadModelsBtn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
            loadModelsBtn.disabled = true;
        }

        try {
            // è·å–å½“å‰é…ç½®
            const provider = document.getElementById('api-provider')?.value;
            const interfaceType = document.getElementById('interface-type')?.value;
            const baseUrl = document.getElementById('api-base-url')?.value;
            const apiKey = document.getElementById('api-key')?.value;

            if (!provider || !interfaceType || !baseUrl || !apiKey) {
                throw new Error('è¯·å…ˆå®ŒæˆAPIé…ç½®ï¼ˆæä¾›å•†ã€æ¥å£ç±»å‹ã€åŸºç¡€URLã€APIå¯†é’¥ï¼‰');
            }

            let models = [];

            if (provider === 'gemini' && interfaceType === 'native') {
                // GeminiåŸç”Ÿæ¥å£
                models = await this.loadGeminiNativeModels(baseUrl, apiKey);
            } else if ((provider === 'gemini' && interfaceType === 'openai-compatible') ||
                       (provider === 'localproxy' && interfaceType === 'openai-compatible') ||
                       (provider === 'custom' && interfaceType === 'openai-compatible')) {
                // OpenAIå…¼å®¹æ¥å£
                models = await this.loadOpenAICompatibleModels(baseUrl, apiKey, provider);
            }

            // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
            if (modelSelect) {
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    option.title = model.description || model.name;
                    modelSelect.appendChild(option);
                });
            }

            if (connectionStatus) {
                connectionStatus.textContent = `âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹`;
                connectionStatus.style.color = '#10b981';
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹:`, models);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                connectionStatus.style.color = '#ef4444';
            }

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            this.showNotification('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
        } finally {
            if (loadModelsBtn) {
                loadModelsBtn.textContent = 'ğŸ“‹ åŠ è½½æ¨¡å‹åˆ—è¡¨';
                loadModelsBtn.disabled = false;
            }
        }
    }

    /**
     * åŠ è½½GeminiåŸç”Ÿæ¥å£æ¨¡å‹
     */
    async loadGeminiNativeModels(baseUrl, apiKey) {
        console.log('[InfoBarSettings] ğŸ”„ åŠ è½½GeminiåŸç”Ÿæ¨¡å‹...');

        // ä½¿ç”¨æ­£ç¡®çš„Gemini APIç«¯ç‚¹
        const modelsUrl = `${baseUrl}/v1beta/models?key=${apiKey}`;

        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', modelsUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    }
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    }
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ Geminiè¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®Geminiæ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Gemini APIé”™è¯¯ (${response.status}): ${errorText}`);
        }

        const data = await response.json();

        // è§£æGemini APIå“åº”æ ¼å¼
        const models = data.models?.map(model => ({
            id: model.name.replace('models/', ''), // ç§»é™¤ "models/" å‰ç¼€
            name: model.displayName || model.name.replace('models/', ''),
            description: model.description || `Geminiæ¨¡å‹: ${model.name}`
        })) || [];

        // è¿‡æ»¤å‡ºæ”¯æŒgenerateContentçš„æ¨¡å‹
        const supportedModels = models.filter(model =>
            model.id.includes('gemini') &&
            !model.id.includes('embedding')
        );

        console.log(`[InfoBarSettings] GeminiåŸç”Ÿæ¥å£åŠ è½½äº† ${supportedModels.length} ä¸ªæ¨¡å‹`);
        return supportedModels;
    }

    /**
     * åŠ è½½æœ¬åœ°åä»£æ¨¡å‹ (é€šè¿‡SillyTavernåç«¯)
     */
    async loadLocalProxyModels(baseUrl, apiKey) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ é€šè¿‡SillyTavernåç«¯åŠ è½½æœ¬åœ°åä»£æ¨¡å‹...');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // æ„å»ºçŠ¶æ€æ£€æŸ¥è¯·æ±‚
            const statusUrl = `${window.location.origin}/api/backends/chat-completions/status`;
            const requestBody = {
                reverse_proxy: baseUrl,
                proxy_password: apiKey,
                chat_completion_source: "custom",
                custom_url: baseUrl,
                custom_include_headers: ""
            };

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£çŠ¶æ€æ£€æŸ¥:', {
                statusUrl,
                reverseProxy: baseUrl,
                hasPassword: !!apiKey
            });

            const response = await fetch(statusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`æœ¬åœ°åä»£çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£çŠ¶æ€å“åº”:', data);

            // è§£ææ¨¡å‹åˆ—è¡¨
            let models = [];
            if (data.data && Array.isArray(data.data)) {
                models = data.data.map(model => ({
                    id: model.id || model.model || 'unknown',
                    name: model.id || model.model || model.name || 'Unknown Model',
                    description: model.description || `æœ¬åœ°åä»£æ¨¡å‹: ${model.id || model.model}`
                }));
            } else if (data.models && Array.isArray(data.models)) {
                models = data.models.map(model => ({
                    id: model.id || model.model || model.name || 'unknown',
                    name: model.name || model.id || model.model || 'Unknown Model',
                    description: model.description || `æœ¬åœ°åä»£æ¨¡å‹: ${model.id}`
                }));
            } else {
                // æä¾›é»˜è®¤æ¨¡å‹åˆ—è¡¨
                console.log('[InfoBarSettings] âš ï¸ æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹');
                models = [
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'æœ¬åœ°åä»£é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4', name: 'GPT-4', description: 'æœ¬åœ°åä»£é«˜çº§æ¨¡å‹' },
                    { id: 'claude-3-sonnet', name: 'Claude 3 Sonnet', description: 'æœ¬åœ°åä»£Claudeæ¨¡å‹' }
                ];
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸåŠ è½½ ${models.length} ä¸ªæœ¬åœ°åä»£æ¨¡å‹`);
            return models;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æœ¬åœ°åä»£æ¨¡å‹å¤±è´¥:', error);

            // æä¾›é™çº§æ¨¡å‹åˆ—è¡¨
            const fallbackModels = [
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' },
                { id: 'gpt-4', name: 'GPT-4 (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' },
                { id: 'claude-3-sonnet', name: 'Claude 3 Sonnet (é™çº§)', description: 'è¿æ¥å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹' }
            ];

            const enhancedError = new Error(`${error.message} - å·²æä¾›é™çº§æ¨¡å‹åˆ—è¡¨`);
            enhancedError.fallbackModels = fallbackModels;
            enhancedError.originalError = error;
            throw enhancedError;
        }
    }

    /**
     * åŠ è½½OpenAIå…¼å®¹æ¥å£æ¨¡å‹
     */
    async loadOpenAICompatibleModels(baseUrl, apiKey, provider) {
        console.log('[InfoBarSettings] ğŸ”„ åŠ è½½OpenAIå…¼å®¹æ¨¡å‹...');

        let modelsUrl;
        let headers;

        if (provider === 'gemini') {
            // Gemini OpenAIå…¼å®¹æ¥å£
            modelsUrl = `https://generativelanguage.googleapis.com/v1beta/openai/models`;
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'User-Agent': 'SillyTavern-InfoBar/1.0'
            };
        } else if (provider === 'localproxy') {
            // æœ¬åœ°åä»£æ¥å£ - ä½¿ç”¨SillyTavernåç«¯ä»£ç†
            console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨æœ¬åœ°åä»£æ¨¡å¼åŠ è½½æ¨¡å‹...');
            return await this.loadLocalProxyModels(baseUrl, apiKey);
        } else {
            // è‡ªå®šä¹‰OpenAIå…¼å®¹æ¥å£
            modelsUrl = `${baseUrl}/models`;
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'User-Agent': 'SillyTavern-InfoBar/1.0'
            };
        }

        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', modelsUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(modelsUrl, {
                    method: 'GET',
                    headers: headers
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: headers
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ è¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥åä»£æœåŠ¡å™¨çš„CORSé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            let errorText = '';
            try {
                errorText = await response.text();
            } catch (e) {
                errorText = 'æ— æ³•è¯»å–é”™è¯¯å“åº”';
            }

            console.error('[InfoBarSettings] ğŸ”¥ APIå“åº”é”™è¯¯:', {
                status: response.status,
                statusText: response.statusText,
                url: modelsUrl,
                errorText: errorText.substring(0, 200)
            });

            throw new Error(`APIé”™è¯¯ (${response.status}): ${errorText}`);
        }

        let data;
        try {
            data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š APIå“åº”æ•°æ®ç»“æ„:', Object.keys(data));
        } catch (parseError) {
            console.error('[InfoBarSettings] âŒ å“åº”è§£æå¤±è´¥:', parseError);
            throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šæ— æ³•è§£æJSONæ•°æ®');
        }

        // ğŸ”§ å¢å¼ºçš„å“åº”æ ¼å¼å…¼å®¹æ€§å¤„ç†
        let models = [];

        if (data.data && Array.isArray(data.data)) {
            // æ ‡å‡†OpenAIæ ¼å¼: { "data": [...] }
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°æ ‡å‡†OpenAIæ ¼å¼');
            models = data.data.map(model => ({
                id: model.id || model.model || 'unknown',
                name: model.id || model.model || model.name || 'Unknown Model',
                description: model.description || `æ¨¡å‹: ${model.id || model.model || 'unknown'}`
            }));
        } else if (data.models && Array.isArray(data.models)) {
            // æŸäº›åä»£ä½¿ç”¨çš„æ ¼å¼: { "models": [...] }
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°è‡ªå®šä¹‰modelsæ ¼å¼');
            models = data.models.map(model => ({
                id: model.id || model.model || model.name || 'unknown',
                name: model.name || model.id || model.model || 'Unknown Model',
                description: model.description || `æ¨¡å‹: ${model.id || model.name || 'unknown'}`
            }));
        } else if (Array.isArray(data)) {
            // ç›´æ¥æ•°ç»„æ ¼å¼: [...]
            console.log('[InfoBarSettings] ğŸ“‹ æ£€æµ‹åˆ°ç›´æ¥æ•°ç»„æ ¼å¼');
            models = data.map(model => {
                if (typeof model === 'string') {
                    return { id: model, name: model, description: `æ¨¡å‹: ${model}` };
                } else {
                    return {
                        id: model.id || model.model || model.name || 'unknown',
                        name: model.name || model.id || model.model || 'Unknown Model',
                        description: model.description || `æ¨¡å‹: ${model.id || model.name || 'unknown'}`
                    };
                }
            });
        } else {
            console.warn('[InfoBarSettings] âš ï¸ æœªè¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œæä¾›é™çº§æ¨¡å‹åˆ—è¡¨');
            console.log('[InfoBarSettings] ğŸ” åŸå§‹å“åº”:', JSON.stringify(data, null, 2));

            // æä¾›é™çº§æ¨¡å‹åˆ—è¡¨
            if (provider === 'gemini') {
                models = [
                    { id: 'gemini-pro', name: 'Gemini Pro (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤Geminiæ¨¡å‹' },
                    { id: 'gemini-pro-vision', name: 'Gemini Pro Vision (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤Geminiè§†è§‰æ¨¡å‹' }
                ];
            } else {
                models = [
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4', name: 'GPT-4 (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' },
                    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo (é™çº§)', description: 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨æ—¶çš„é»˜è®¤æ¨¡å‹' }
                ];
            }
        }

        // è¿‡æ»¤å’ŒéªŒè¯æ¨¡å‹åˆ—è¡¨
        models = models.filter(model =>
            model &&
            typeof model === 'object' &&
            model.id &&
            typeof model.id === 'string' &&
            model.id.trim() !== ''
        );

        console.log(`[InfoBarSettings] âœ… OpenAIå…¼å®¹æ¥å£æˆåŠŸåŠ è½½äº† ${models.length} ä¸ªæ¨¡å‹`);
        models.forEach((model, index) => {
            console.log(`[InfoBarSettings] ğŸ“‹ æ¨¡å‹ ${index + 1}: ${model.id} (${model.name})`);
        });

        return models;
    }

    /**
     * å¤„ç†APIå¯ç”¨çŠ¶æ€å˜æ›´
     */
    async handleAPIEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ APIå¯ç”¨çŠ¶æ€å˜æ›´:', enabled);

            if (enabled) {
                // å¯ç”¨è‡ªå®šä¹‰API
                console.log('[InfoBarSettings] âœ… å¯ç”¨è‡ªå®šä¹‰APIæ¨¡å¼');

                // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºå†²çªæ ‡ç­¾
                await this.setupMainAPIRestrictions();

                // åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†
                await this.initCustomAPIHandling();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('âœ… è‡ªå®šä¹‰APIå·²å¯ç”¨ï¼Œä¸»API Hookå·²æ¸…ç†', 'success');

            } else {
                // ç¦ç”¨è‡ªå®šä¹‰API
                console.log('[InfoBarSettings] â¸ï¸ ç¦ç”¨è‡ªå®šä¹‰APIæ¨¡å¼');

                // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™
                await this.removeMainAPIRestrictions();

                // æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†
                await this.clearCustomAPIHandling();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('â¸ï¸ è‡ªå®šä¹‰APIå·²ç¦ç”¨ï¼Œä¸»API Hookå·²æ¢å¤', 'info');
            }

            // æ›´æ–°é…ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }
            if (!extensionSettings['Information bar integration tool'].apiConfig) {
                extensionSettings['Information bar integration tool'].apiConfig = {};
            }

            extensionSettings['Information bar integration tool'].apiConfig.enabled = enabled;
            context.saveSettingsDebounced();

            // ğŸ”§ æ–°å¢ï¼šé€šçŸ¥å˜é‡ç³»ç»Ÿæç¤ºè¯æ¨¡å—APIçŠ¶æ€å˜æ›´
            const variableSystemPrompt = window.SillyTavernInfobar?.modules?.variableSystemPrompt;
            if (variableSystemPrompt) {
                try {
                    if (enabled) {
                        // å¯ç”¨è‡ªå®šä¹‰APIæ—¶ï¼Œæ¸…é™¤å˜é‡æç¤ºè¯é¿å…å†²çª
                        if (variableSystemPrompt.context?.setExtensionPrompt) {
                            variableSystemPrompt.context.setExtensionPrompt('information_bar_variable_reader', '', 1, 0);
                            console.log('[InfoBarSettings] ğŸ§¹ å·²æ¸…é™¤ä¸»APIå˜é‡æç¤ºè¯ï¼Œé¿å…ä¸è‡ªå®šä¹‰APIå†²çª');
                        }
                    } else {
                        // ç¦ç”¨è‡ªå®šä¹‰APIæ—¶ï¼Œé‡æ–°å¯ç”¨å˜é‡æç¤ºè¯
                        console.log('[InfoBarSettings] ğŸ”„ é‡æ–°å¯ç”¨ä¸»APIå˜é‡æç¤ºè¯...');
                        // è®¾ç½®æ ‡è®°ä»¥ä¾¿ä¸‹æ¬¡ç”Ÿæˆæ—¶é‡æ–°æ³¨å…¥
                        variableSystemPrompt.injectionActive = false;
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ æ›´æ–°å˜é‡ç³»ç»Ÿæç¤ºè¯çŠ¶æ€å¤±è´¥:', error);
                }
            }

            console.log('[InfoBarSettings] âœ… APIå¯ç”¨çŠ¶æ€å·²æ›´æ–°');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†APIå¯ç”¨çŠ¶æ€å˜æ›´å¤±è´¥:', error);
            this.showNotification('âŒ APIçŠ¶æ€å˜æ›´å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¤„ç†APIæä¾›å•†å˜æ›´
     */
    handleProviderChange(provider) {
        console.log('[InfoBarSettings] APIæä¾›å•†å˜æ›´:', provider);

        const interfaceTypeSelect = document.getElementById('interface-type');
        const baseUrlInput = document.getElementById('api-base-url');

        if (!interfaceTypeSelect || !baseUrlInput) return;

        // ç¡®ä¿nameå±æ€§æ­£ç¡®
        interfaceTypeSelect.name = 'apiConfig.format';

        // æ¸…ç©ºæ¥å£ç±»å‹é€‰é¡¹
        interfaceTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¥å£ç±»å‹</option>';
        baseUrlInput.value = '';

        if (provider === 'gemini') {
            // Geminiæä¾›å•†çš„æ¥å£ç±»å‹
            interfaceTypeSelect.innerHTML = `
                <option value="">è¯·é€‰æ‹©æ¥å£ç±»å‹</option>
                <option value="native">GeminiåŸç”Ÿæ¥å£</option>
                <option value="openai-compatible">OpenAIå…¼å®¹æ¥å£</option>
            `;
        } else if (provider === 'localproxy') {
            // æœ¬åœ°åä»£æä¾›å•†çš„æ¥å£ç±»å‹
            interfaceTypeSelect.innerHTML = `
                <option value="">è¯·é€‰æ‹©æ¥å£ç±»å‹</option>
                <option value="openai-compatible">OpenAIå…¼å®¹æ¥å£</option>
            `;
            // è®¾ç½®é»˜è®¤ç«¯ç‚¹
            baseUrlInput.value = 'http://127.0.0.1:7861/v1';
            baseUrlInput.placeholder = 'http://127.0.0.1:7861/v1';
        } else if (provider === 'custom') {
            // è‡ªå®šä¹‰æä¾›å•†çš„æ¥å£ç±»å‹
            interfaceTypeSelect.innerHTML = `
                <option value="">è¯·é€‰æ‹©æ¥å£ç±»å‹</option>
                <option value="openai-compatible">OpenAIå…¼å®¹æ¥å£</option>
            `;
        }
    }

    /**
     * å¤„ç†æ¥å£ç±»å‹å˜æ›´
     */
    handleInterfaceTypeChange(interfaceType) {
        console.log('[InfoBarSettings] æ¥å£ç±»å‹å˜æ›´:', interfaceType);

        const provider = document.getElementById('api-provider')?.value;
        const baseUrlInput = document.getElementById('api-base-url');

        if (!baseUrlInput) return;

        // æ ¹æ®æä¾›å•†å’Œæ¥å£ç±»å‹è®¾ç½®é»˜è®¤URL
        if (provider === 'gemini') {
            if (interfaceType === 'native') {
                baseUrlInput.value = 'https://generativelanguage.googleapis.com';
            } else if (interfaceType === 'openai-compatible') {
                baseUrlInput.value = 'https://generativelanguage.googleapis.com/v1beta/openai';
            }
        } else if (provider === 'localproxy') {
            if (interfaceType === 'openai-compatible') {
                baseUrlInput.value = 'http://127.0.0.1:7861/v1';
                baseUrlInput.placeholder = 'http://127.0.0.1:7861/v1';
            }
        } else if (provider === 'custom') {
            if (interfaceType === 'openai-compatible') {
                baseUrlInput.value = '';
                baseUrlInput.placeholder = 'https://your-api.com/v1';
            }
        }
    }

    /**
     * æµ‹è¯•æœ¬åœ°åä»£è¿æ¥ (é€šè¿‡SillyTavernåç«¯)
     */
    async testLocalProxyConnection(baseUrl, apiKey, connectionStatus) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æµ‹è¯•æœ¬åœ°åä»£è¿æ¥...');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // æ„å»ºçŠ¶æ€æ£€æŸ¥è¯·æ±‚
            const statusUrl = `${window.location.origin}/api/backends/chat-completions/status`;
            const requestBody = {
                reverse_proxy: baseUrl,
                proxy_password: apiKey,
                chat_completion_source: "custom",
                custom_url: baseUrl,
                custom_include_headers: ""
            };

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£è¿æ¥æµ‹è¯•:', {
                statusUrl,
                reverseProxy: baseUrl,
                hasPassword: !!apiKey
            });

            const response = await fetch(statusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å“åº”:', data);

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (data.error) {
                throw new Error(`æœ¬åœ°åä»£é”™è¯¯: ${data.error.message || data.error}`);
            }

            // è¿æ¥æˆåŠŸ
            if (connectionStatus) {
                connectionStatus.textContent = 'âœ… æœ¬åœ°åä»£è¿æ¥æˆåŠŸ';
                connectionStatus.style.color = '#10b981';
            }

            let modelCount = 0;
            if (data.data && Array.isArray(data.data)) {
                modelCount = data.data.length;
            } else if (data.models && Array.isArray(data.models)) {
                modelCount = data.models.length;
            }

            this.showNotification(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•æˆåŠŸï¼æ£€æµ‹åˆ° ${modelCount} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = 'âŒ æœ¬åœ°åä»£è¿æ¥å¤±è´¥';
                connectionStatus.style.color = '#ef4444';
            }

            throw new Error(`æœ¬åœ°åä»£è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * æµ‹è¯•APIè¿æ¥
     */
    async testConnection() {
        console.log('[InfoBarSettings] å¼€å§‹æµ‹è¯•APIè¿æ¥');

        const testBtn = document.getElementById('test-connection-btn');
        const connectionStatus = document.getElementById('connection-status');

        if (testBtn) {
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
        }

        try {
            // è·å–é…ç½®
            const provider = document.getElementById('api-provider')?.value;
            const interfaceType = document.getElementById('interface-type')?.value;
            const baseUrl = document.getElementById('api-base-url')?.value;
            const apiKey = document.getElementById('api-key')?.value;

            if (!provider || !interfaceType || !baseUrl || !apiKey) {
                throw new Error('è¯·å®Œæˆæ‰€æœ‰å¿…å¡«é…ç½®é¡¹');
            }

            // æ‰§è¡Œè¿æ¥æµ‹è¯•
            if (provider === 'localproxy') {
                // æœ¬åœ°åä»£ä½¿ç”¨ä¸“ç”¨çš„æµ‹è¯•é€»è¾‘
                console.log('[InfoBarSettings] ğŸ”„ ä½¿ç”¨æœ¬åœ°åä»£ä¸“ç”¨æµ‹è¯•é€»è¾‘...');
                await this.testLocalProxyConnection(baseUrl, apiKey, connectionStatus);
                return;
            }

            let testUrl;
            let headers;

            if (provider === 'gemini' && interfaceType === 'native') {
                testUrl = `${baseUrl}/v1beta/models?key=${apiKey}`;
                headers = {
                    'Content-Type': 'application/json',
                    'User-Agent': 'SillyTavern-InfoBar/1.0'
                };
            } else {
                testUrl = `${baseUrl}/models`;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'User-Agent': 'SillyTavern-InfoBar/1.0'
                };
            }

            console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¿æ¥æµ‹è¯•:', testUrl);

            let response;
            try {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
                if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                    response = await this.apiIntegration.proxyCompatibleFetch(testUrl, {
                        method: 'GET',
                        headers: headers,
                        timeout: 10000
                    });
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                    response = await fetch(testUrl, {
                        method: 'GET',
                        headers: headers,
                        timeout: 10000
                    });
                }
            } catch (fetchError) {
                console.error('[InfoBarSettings] âŒ è¿æ¥æµ‹è¯•è¯·æ±‚å¤±è´¥:', fetchError);

                // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
                if (fetchError.message.includes('CORS_BLOCKED') ||
                    fetchError.message.includes('CORS') ||
                    (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                    throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®APIæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åä»£é…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
                }

                throw fetchError;
            }

            if (response.ok) {
                if (connectionStatus) {
                    connectionStatus.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    connectionStatus.style.color = '#10b981';
                }
                this.showNotification('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                throw new Error(`è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);

            if (connectionStatus) {
                connectionStatus.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
                connectionStatus.style.color = '#ef4444';
            }

            this.showNotification('APIè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        } finally {
            if (testBtn) {
                testBtn.textContent = 'ğŸ” æµ‹è¯•è¿æ¥';
                testBtn.disabled = false;
            }
        }
    }

    /**
     * è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºç‰¹å®šæ ‡ç­¾
     */
    async setupMainAPIRestrictions() {
        try {
            console.log('[InfoBarSettings] ğŸš« è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™ï¼Œç¦æ­¢è¾“å‡ºå†²çªæ ‡ç­¾...');

            // ğŸ”§ ä¿®å¤ï¼šå‘é€é™åˆ¶è§„åˆ™æç¤ºè¯ç»™ä¸»APIï¼Œè€Œä¸æ˜¯æ‹¦æˆª
            await this.injectRestrictionPromptToMainAPI();

            // ğŸ”§ ä¿ç•™ï¼šæ‹¦æˆªä¸»APIå¯¹æ¶ˆæ¯å†…å®¹çš„è®¿é—®ï¼Œéšè—infobar_data
            await this.setupMessageContentFilter();

            console.log('[InfoBarSettings] âœ… ä¸»APIé™åˆ¶è§„åˆ™è®¾ç½®å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è®¾ç½®ä¸»APIé™åˆ¶è§„åˆ™å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å‘ä¸»APIæ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯
     */
    async injectRestrictionPromptToMainAPI() {
        try {
            console.log('[InfoBarSettings] ğŸ“ å‘ä¸»APIæ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯...');

            // åˆ›å»ºé™åˆ¶è§„åˆ™æç¤ºè¯
            const restrictionPrompt = this.createRestrictionPrompt();

            // ä½¿ç”¨SillyTavernçš„æ‰©å±•æç¤ºè¯æœºåˆ¶
            const context = SillyTavern.getContext();
            if (context && context.setExtensionPrompt) {
                context.setExtensionPrompt(
                    'Information bar integration tool - Restrictions',
                    restrictionPrompt,
                    1, // é«˜ä¼˜å…ˆçº§
                    false // ä¸ç¦ç”¨
                );
                console.log('[InfoBarSettings] âœ… é™åˆ¶è§„åˆ™æç¤ºè¯å·²æ³¨å…¥åˆ°ä¸»API');
                console.log('[InfoBarSettings] ğŸ“ æç¤ºè¯é•¿åº¦:', restrictionPrompt.length);
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä½¿ç”¨SillyTavernæ‰©å±•æç¤ºè¯æœºåˆ¶');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ³¨å…¥é™åˆ¶è§„åˆ™æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºé™åˆ¶è§„åˆ™æç¤ºè¯
     */
    createRestrictionPrompt() {
        return `ã€é‡è¦æŠ€æœ¯æ€§é™åˆ¶ - ç¦æ­¢è¾“å‡ºç‰¹å®šæ ‡ç­¾ã€‘
âš ï¸ ä¸¥æ ¼ç¦æ­¢åœ¨å›å¤ä¸­åŒ…å«ä»¥ä¸‹æŠ€æœ¯æ€§æ ‡ç­¾ï¼š

ğŸš« ç¦æ­¢è¾“å‡ºçš„XMLæ ‡ç­¾ï¼š
- <aiThinkProcess>...</aiThinkProcess>
- <infobar_data>...</infobar_data>



ğŸ“‹ è¯´æ˜ï¼š
è¿™äº›æ˜¯çº¯æŠ€æœ¯æ€§é™åˆ¶ï¼Œç”¨äºé¿å…ä¸ä¸“ç”¨ä¿¡æ¯æ ç³»ç»Ÿäº§ç”Ÿå†²çªã€‚
è¿™äº›é™åˆ¶ä¸å½±å“ä½ çš„æ­£å¸¸åˆ›ä½œå’Œè¡¨è¾¾èƒ½åŠ›ã€‚

---`;
    }

    /**
     * åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†
     */
    async initCustomAPIHandling() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†...');

            // æ³¨å†Œæ¶ˆæ¯æ¥æ”¶äº‹ä»¶ç›‘å¬å™¨
            const context = SillyTavern.getContext();
            if (context && context.eventSource) {
                // ä½¿ç”¨ç¨³å®šçš„ç»‘å®šå¼•ç”¨ï¼Œç¡®ä¿removeListenerç”Ÿæ•ˆ
                if (!this._boundHandlers.handleGenerationEnded) {
                    this._boundHandlers.handleGenerationEnded = this.handleGenerationEnded.bind(this);
                }
                if (!this._boundHandlers.handleMessageReceived) {
                    this._boundHandlers.handleMessageReceived = this.handleMessageReceived.bind(this);
                }

                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨ï¼ˆä½¿ç”¨ç›¸åŒå¼•ç”¨ï¼‰
                context.eventSource.removeListener('message_received', this._boundHandlers.handleMessageReceived);
                context.eventSource.removeListener('generation_ended', this._boundHandlers.handleGenerationEnded);

                // æ·»åŠ ç›‘å¬å™¨ï¼ˆä»…æ·»åŠ ä¸€æ¬¡ï¼‰
                context.eventSource.on('generation_ended', this._boundHandlers.handleGenerationEnded);
                // æŒ‰éœ€ï¼šå¦‚æœä¹Ÿéœ€è¦åœ¨message_receivedæ—¶è§¦å‘ï¼Œåˆ™æ‰“å¼€ä¸‹ä¸€è¡Œ
                // context.eventSource.on('message_received', this._boundHandlers.handleMessageReceived);

                console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIäº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ');
            }

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIå¤„ç†åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†ç”Ÿæˆç»“æŸäº‹ä»¶ï¼ˆç¡®ä¿ä¸»APIå®Œæˆåæ‰å¤„ç†ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ AIæ¶ˆæ¯éªŒè¯ï¼Œé¿å…å¤„ç†æ—§æ¶ˆæ¯
     */
    async handleGenerationEnded() {
        try {
            console.log('[InfoBarSettings] ğŸ æ”¶åˆ°ç”Ÿæˆç»“æŸäº‹ä»¶...');

            // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            if (!configs.apiConfig || !configs.apiConfig.enabled) {
                console.log('[InfoBarSettings] â„¹ï¸ è‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const latestAIMessage = this.getLatestAIMessage();
            if (!latestAIMessage) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
            const isValidMessage = this.validateAIMessageIsNew(latestAIMessage);
            if (!isValidMessage) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°çš„AIæ¶ˆæ¯ä¸æ˜¯æ–°ç”Ÿæˆçš„æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯AIç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡å¤„ç†');
                console.log('[InfoBarSettings] ğŸ“ è¿™é¿å…äº†ä½¿ç”¨ä¸Šä¸€æ¡AIæ¶ˆæ¯çš„å‰§æƒ…å†…å®¹è°ƒç”¨è‡ªå®šä¹‰APIçš„é”™è¯¯');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure('AIæ¶ˆæ¯éªŒè¯å¤±è´¥ï¼šè·å–åˆ°çš„æ˜¯æ—§æ¶ˆæ¯ï¼Œå¯èƒ½AIç”ŸæˆæœªæˆåŠŸ');
                return;
            }

            console.log('[InfoBarSettings] âœ… éªŒè¯é€šè¿‡ï¼šè¿™æ˜¯ä¸€æ¡æ–°ç”Ÿæˆçš„AIæ¶ˆæ¯');

            // ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
            const lengthValidation = this.validateAIMessageLength(latestAIMessage, 100);
            if (!lengthValidation.isValid) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼Œè·³è¿‡ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                console.log('[InfoBarSettings] ğŸ“ è¿™é€šå¸¸è¡¨ç¤ºAIè¾“å‡ºè¢«æˆªæ–­æˆ–å†…å®¹è¿‡äºç®€çŸ­');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure(`AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼š${lengthValidation.reason}`);
                return;
            }

            console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯é•¿åº¦éªŒè¯é€šè¿‡ï¼Œå†…å®¹é•¿åº¦å……è¶³');

            // åœ¨åŒAPIåä½œæ¨¡å¼ä¸‹ï¼Œä¸»APIä¸åº”è¯¥åŒ…å«infobar_data
            // å¦‚æœåŒ…å«äº†ï¼Œè¯´æ˜ä¸»API Hookæ²¡æœ‰ç”Ÿæ•ˆï¼Œéœ€è¦æ¸…ç†
            if (latestAIMessage.mes && latestAIMessage.mes.includes('<infobar_data>')) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°ä¸»APIè¿”å›äº†infobar_dataï¼Œæ¸…ç†å¹¶é‡æ–°å¤„ç†...');

                // æ¸…ç†ä¸»APIè¿”å›çš„infobar_data
                const cleanedMessage = latestAIMessage.mes.replace(/<infobar_data>[\s\S]*?<\/infobar_data>/g, '').trim();
                latestAIMessage.mes = cleanedMessage;

                console.log('[InfoBarSettings] ğŸ§¹ å·²æ¸…ç†ä¸»APIè¿”å›çš„infobar_data');
            }

            console.log('[InfoBarSettings] ğŸ¤– ä¸»APIç”Ÿæˆå®Œæˆï¼Œå¼€å§‹å¤„ç†ä¿¡æ¯æ æ•°æ®...');

            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ï¼Œé¿å…é¢‘ç¹å¹¶å‘è°ƒç”¨
            if (this.customAPITaskQueue) {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                this.customAPITaskQueue.addTask({
                    type: 'INFOBAR_DATA',
                    data: { content: latestAIMessage.mes },
                    source: 'generation_ended'
                });
            } else {
                // å›é€€åˆ°åŸæœ‰é€»è¾‘
                console.log('[InfoBarSettings] âš ï¸ ä»»åŠ¡é˜Ÿåˆ—ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘');
                await this.processWithCustomAPI(latestAIMessage.mes);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç”Ÿæˆç»“æŸäº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨ï¼Œåœ¨è‡ªå®šä¹‰APIæ¨¡å¼ä¸‹éšè—infobar_data
     */
    async setupMessageContentFilter() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨...');

            const context = SillyTavern.getContext();
            if (!context || !context.chat) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–èŠå¤©ä¸Šä¸‹æ–‡');
                return;
            }

            // ä¿å­˜åŸå§‹çš„chatæ•°ç»„ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ä¿å­˜ï¼‰
            if (!context._originalChat) {
                // åˆ›å»ºåŸå§‹æ•°ç»„çš„å‰¯æœ¬ï¼Œé¿å…å¾ªç¯å¼•ç”¨
                context._originalChat = [...context.chat];
                console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜åŸå§‹èŠå¤©æ•°ç»„å¼•ç”¨ï¼Œé•¿åº¦:', context._originalChat.length);
            }

            // åˆ›å»ºä¸€ä¸ªä»£ç†æ•°ç»„ï¼ŒåŠ¨æ€è¿‡æ»¤infobar_dataå†…å®¹
            const filteredChat = new Proxy(context._originalChat, {
                get: (target, prop) => {
                    // å¦‚æœè®¿é—®çš„æ˜¯æ•°ç»„ç´¢å¼•
                    if (typeof prop === 'string' && /^\d+$/.test(prop)) {
                        const index = parseInt(prop);
                        const message = target[index];

                        if (message && message.mes && typeof message.mes === 'string') {
                            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªå®šä¹‰APIæ¨¡å¼
                            const currentContext = SillyTavern.getContext();
                            const extensionSettings = currentContext.extensionSettings['Information bar integration tool'] || {};
                            const apiConfig = extensionSettings.apiConfig || {};

                            if (apiConfig.enabled && apiConfig.apiKey && apiConfig.model) {
                                // åœ¨è‡ªå®šä¹‰APIæ¨¡å¼ä¸‹ï¼Œè¿‡æ»¤æ‰infobar_dataå†…å®¹
                                const filteredMessage = { ...message };
                                const originalMes = message.mes;
                                filteredMessage.mes = originalMes.replace(/<infobar_data>[\s\S]*?<\/infobar_data>/gi, '').trim();

                                // å¦‚æœè¿‡æ»¤åå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œè®°å½•æ—¥å¿—
                                if (filteredMessage.mes !== originalMes) {
                                    console.log('[InfoBarSettings] ğŸ” å·²è¿‡æ»¤æ¶ˆæ¯ä¸­çš„infobar_dataå†…å®¹ï¼Œæ¶ˆæ¯ç´¢å¼•:', index);
                                    console.log('[InfoBarSettings] ğŸ“ åŸå§‹é•¿åº¦:', originalMes.length, 'è¿‡æ»¤åé•¿åº¦:', filteredMessage.mes.length);
                                }

                                return filteredMessage;
                            }
                        }

                        return message;
                    }

                    // å¯¹äºå…¶ä»–å±æ€§ï¼ˆå¦‚length, push, popç­‰ï¼‰ï¼Œç›´æ¥è¿”å›åŸå§‹å€¼
                    const value = target[prop];
                    if (typeof value === 'function') {
                        return value.bind(target);
                    }
                    return value;
                }
            });

            // æ›¿æ¢context.chatä¸ºè¿‡æ»¤åçš„ä»£ç†æ•°ç»„
            context.chat = filteredChat;
            console.log('[InfoBarSettings] âœ… æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨å·²è®¾ç½®');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è®¾ç½®æ¶ˆæ¯å†…å®¹è¿‡æ»¤å™¨å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™
     */
    async removeMainAPIRestrictions() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™...');

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯
            await this.removeRestrictionPromptFromMainAPI();

            // ğŸ”§ ä¿ç•™ï¼šæ¢å¤åŸå§‹çš„èŠå¤©æ•°ç»„
            const context = SillyTavern.getContext();
            if (context && context._originalChat) {
                context.chat = context._originalChat;
                delete context._originalChat;
                console.log('[InfoBarSettings] âœ… åŸå§‹èŠå¤©æ•°ç»„å·²æ¢å¤');
            }

            console.log('[InfoBarSettings] âœ… ä¸»APIé™åˆ¶è§„åˆ™ç§»é™¤å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤ä¸»APIé™åˆ¶è§„åˆ™å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä»ä¸»APIç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯
     */
    async removeRestrictionPromptFromMainAPI() {
        try {
            console.log('[InfoBarSettings] ğŸ—‘ï¸ ä»ä¸»APIç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯...');

            // ä½¿ç”¨SillyTavernçš„æ‰©å±•æç¤ºè¯æœºåˆ¶ç§»é™¤é™åˆ¶è§„åˆ™
            const context = SillyTavern.getContext();
            if (context && context.setExtensionPrompt) {
                context.setExtensionPrompt(
                    'Information bar integration tool - Restrictions',
                    '', // ç©ºæç¤ºè¯è¡¨ç¤ºç§»é™¤
                    1,
                    true // ç¦ç”¨
                );
                console.log('[InfoBarSettings] âœ… é™åˆ¶è§„åˆ™æç¤ºè¯å·²ä»ä¸»APIç§»é™¤');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä½¿ç”¨SillyTavernæ‰©å±•æç¤ºè¯æœºåˆ¶ç§»é™¤é™åˆ¶è§„åˆ™');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤é™åˆ¶è§„åˆ™æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†
     */
    async clearCustomAPIHandling() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†...');

            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            const context = SillyTavern.getContext();
            if (context && context.eventSource) {
                context.eventSource.removeListener('message_received', this.handleMessageReceived);
                context.eventSource.removeListener('generation_ended', this.handleGenerationEnded);
                console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIäº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤');
            }

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIå¤„ç†æ¸…ç†å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼ˆè‡ªå®šä¹‰APIæ¨¡å¼ï¼‰
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ AIæ¶ˆæ¯éªŒè¯ï¼Œé¿å…å¤„ç†æ—§æ¶ˆæ¯
     */
    async handleMessageReceived() {
        try {
            console.log('[InfoBarSettings] ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯æ¥æ”¶äº‹ä»¶...');

            // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            if (!configs.apiConfig || !configs.apiConfig.enabled) {
                console.log('[InfoBarSettings] â„¹ï¸ è‡ªå®šä¹‰APIæœªå¯ç”¨ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const latestAIMessage = this.getLatestAIMessage();
            if (!latestAIMessage) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
            const isValidMessage = this.validateAIMessageIsNew(latestAIMessage);
            if (!isValidMessage) {
                console.log('[InfoBarSettings] âš ï¸ æ£€æµ‹åˆ°çš„AIæ¶ˆæ¯ä¸æ˜¯æ–°ç”Ÿæˆçš„æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            // ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
            const lengthValidation = this.validateAIMessageLength(latestAIMessage, 100);
            if (!lengthValidation.isValid) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼Œè·³è¿‡ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                console.log('[InfoBarSettings] ğŸ“ è¿™é€šå¸¸è¡¨ç¤ºAIè¾“å‡ºè¢«æˆªæ–­æˆ–å†…å®¹è¿‡äºç®€çŸ­');

                // è°ƒç”¨å¤±è´¥å¤„ç†å‡½æ•°
                this.handleAIGenerationFailure(`AIæ¶ˆæ¯é•¿åº¦ä¸è¶³ï¼š${lengthValidation.reason}`);
                return;
            }

            console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯é•¿åº¦éªŒè¯é€šè¿‡ï¼Œå†…å®¹é•¿åº¦å……è¶³');

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ç»åŒ…å«infobar_data
            if (latestAIMessage.mes && latestAIMessage.mes.includes('<infobar_data>')) {
                console.log('[InfoBarSettings] â„¹ï¸ æ¶ˆæ¯å·²åŒ…å«infobar_dataï¼Œè·³è¿‡å¤„ç†');
                return;
            }

            console.log('[InfoBarSettings] ğŸ¤– æ£€æµ‹åˆ°æ–°çš„AIæ¶ˆæ¯ï¼Œå‡†å¤‡å¤„ç†...');

            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ï¼Œé¿å…é¢‘ç¹å¹¶å‘è°ƒç”¨
            if (this.customAPITaskQueue) {
                console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ä¿¡æ¯æ æ•°æ®ç”Ÿæˆ');
                this.customAPITaskQueue.addTask({
                    type: 'INFOBAR_DATA',
                    data: { content: latestAIMessage.mes },
                    source: 'message_received'
                });
            } else {
                // å›é€€åˆ°åŸæœ‰é€»è¾‘
                console.log('[InfoBarSettings] âš ï¸ ä»»åŠ¡é˜Ÿåˆ—ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘');
                await this.processWithCustomAPI(latestAIMessage.mes);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * è·å–æœ€æ–°çš„AIæ¶ˆæ¯
     * ğŸ”§ ä¿®å¤ï¼šå¢åŠ æ¶ˆæ¯éªŒè¯ï¼Œç¡®ä¿è·å–çš„æ˜¯çœŸæ­£æ–°ç”Ÿæˆçš„AIæ¶ˆæ¯
     */
    getLatestAIMessage() {
        try {
            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                return null;
            }

            // ä»åå¾€å‰æŸ¥æ‰¾æœ€æ–°çš„AIæ¶ˆæ¯
            for (let i = context.chat.length - 1; i >= 0; i--) {
                const message = context.chat[i];
                if (message && !message.is_user) {
                    console.log('[InfoBarSettings] ğŸ” æ‰¾åˆ°AIæ¶ˆæ¯:', {
                        index: i,
                        messageId: message.mes_id || 'unknown',
                        sendDate: message.send_date || 'unknown',
                        contentLength: message.mes ? message.mes.length : 0,
                        hasInfobarData: message.mes ? message.mes.includes('<infobar_data>') : false
                    });
                    return message;
                }
            }

            return null;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æœ€æ–°AIæ¶ˆæ¯å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯æ˜¯å¦ä¸ºçœŸæ­£æ–°ç”Ÿæˆçš„æ¶ˆæ¯
     */
    validateAIMessageIsNew(aiMessage) {
        try {
            if (!aiMessage) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯ä¸ºç©ºï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                console.log('[InfoBarSettings] âš ï¸ èŠå¤©ä¸Šä¸‹æ–‡æ— æ•ˆï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ç´¢å¼•
            let lastUserMessageIndex = -1;
            for (let i = context.chat.length - 1; i >= 0; i--) {
                const message = context.chat[i];
                if (message && message.is_user) {
                    lastUserMessageIndex = i;
                    break;
                }
            }

            if (lastUserMessageIndex === -1) {
                console.log('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼Œè·³è¿‡éªŒè¯');
                return true; // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œå…è®¸å¤„ç†
            }

            // è·å–AIæ¶ˆæ¯åœ¨èŠå¤©è®°å½•ä¸­çš„ç´¢å¼•
            let aiMessageIndex = -1;
            for (let i = 0; i < context.chat.length; i++) {
                const message = context.chat[i];
                if (message === aiMessage) {
                    aiMessageIndex = i;
                    break;
                }
            }

            if (aiMessageIndex === -1) {
                console.log('[InfoBarSettings] âš ï¸ æ— æ³•åœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°AIæ¶ˆæ¯ï¼ŒéªŒè¯å¤±è´¥');
                return false;
            }

            // AIæ¶ˆæ¯åº”è¯¥åœ¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹å
            const isAfterLastUser = aiMessageIndex > lastUserMessageIndex;

            console.log('[InfoBarSettings] ğŸ” AIæ¶ˆæ¯éªŒè¯ç»“æœ:', {
                aiMessageIndex: aiMessageIndex,
                lastUserMessageIndex: lastUserMessageIndex,
                isAfterLastUser: isAfterLastUser,
                aiMessageTime: aiMessage.send_date || 'unknown'
            });

            return isAfterLastUser;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯AIæ¶ˆæ¯å¤±è´¥:', error);
            return false; // éªŒè¯å¤±è´¥æ—¶é»˜è®¤ä¸å¤„ç†ï¼Œé¿å…é”™è¯¯
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†AIç”Ÿæˆå¤±è´¥çš„æƒ…å†µ
     */
    handleAIGenerationFailure(reason = 'unknown') {
        try {
            console.log('[InfoBarSettings] âš ï¸ å¤„ç†AIç”Ÿæˆå¤±è´¥:', reason);

            // è®°å½•å¤±è´¥ç»Ÿè®¡
            if (!window.InfoBarGenerationStats) {
                window.InfoBarGenerationStats = {
                    failures: 0,
                    lastFailureTime: null,
                    lastFailureReason: null
                };
            }

            window.InfoBarGenerationStats.failures++;
            window.InfoBarGenerationStats.lastFailureTime = new Date().toISOString();
            window.InfoBarGenerationStats.lastFailureReason = reason;

            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå¤±è´¥ç»Ÿè®¡å·²æ›´æ–°:', {
                totalFailures: window.InfoBarGenerationStats.failures,
                lastFailure: window.InfoBarGenerationStats.lastFailureTime,
                reason: reason
            });

            // é€šçŸ¥äº‹ä»¶ç³»ç»ŸAIç”Ÿæˆå¤±è´¥
            if (this.eventSystem) {
                this.eventSystem.emit('ai:generation:failed', {
                    reason: reason,
                    timestamp: Date.now(),
                    context: 'custom_api_processing'
                });
            }

            // å¦‚æœè®¾ç½®ç•Œé¢å¯è§ï¼Œæ˜¾ç¤ºçŠ¶æ€æç¤º
            if (this.visible && this.modal) {
                this.showMessage(`AIç”Ÿæˆå¤±è´¥: ${reason}`, 'warning');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIç”Ÿæˆå¤±è´¥é€»è¾‘å‡ºé”™:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šéªŒè¯AIæ¶ˆæ¯é•¿åº¦æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¿¡æ¯æ æ•°æ®
     */
    validateAIMessageLength(aiMessage, minLength = 100) {
        try {
            if (!aiMessage || !aiMessage.mes) {
                console.log('[InfoBarSettings] âš ï¸ AIæ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œé•¿åº¦éªŒè¯å¤±è´¥');
                return { isValid: false, actualLength: 0, reason: 'æ¶ˆæ¯å†…å®¹ä¸ºç©º' };
            }

            // è·å–æ¶ˆæ¯å†…å®¹å¹¶æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ ‡ç­¾
            let messageContent = aiMessage.mes;

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„XMLæ ‡ç­¾å’Œå¤šä½™ç©ºç™½
            messageContent = messageContent
                .replace(/<[^>]+>/g, '') // ç§»é™¤æ‰€æœ‰XML/HTMLæ ‡ç­¾
                .replace(/\s+/g, ' ')    // å°†å¤šä¸ªç©ºç™½å­—ç¬¦æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
                .trim();

            const actualLength = messageContent.length;
            const isValid = actualLength >= minLength;

            console.log('[InfoBarSettings] ğŸ“ AIæ¶ˆæ¯é•¿åº¦éªŒè¯:', {
                minRequired: minLength,
                actualLength: actualLength,
                isValid: isValid,
                contentPreview: messageContent.substring(0, 50) + (messageContent.length > 50 ? '...' : '')
            });

            return {
                isValid: isValid,
                actualLength: actualLength,
                reason: isValid ? 'é•¿åº¦å……è¶³' : `å†…å®¹è¿‡çŸ­ï¼Œå®é™…é•¿åº¦${actualLength}å­—ï¼Œè¦æ±‚è‡³å°‘${minLength}å­—`
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯AIæ¶ˆæ¯é•¿åº¦å¤±è´¥:', error);
            return { isValid: false, actualLength: 0, reason: 'é•¿åº¦éªŒè¯å‡ºé”™: ' + error.message };
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç›´æ¥å¤„ç†è‡ªå®šä¹‰APIè°ƒç”¨ï¼ˆä¾›ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨ï¼‰
     * é¿å…ä»»åŠ¡é˜Ÿåˆ—çš„å¾ªç¯è°ƒç”¨
     */
    async processWithCustomAPIDirectly(plotContent) {
        return await this.processWithCustomAPIInternal(plotContent);
    }

    /**
     * ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å‰§æƒ…å†…å®¹
     */
    async processWithCustomAPI(plotContent) {
        // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†
        if (this.customAPITaskQueue) {
            console.log('[InfoBarSettings] ğŸ“‹ ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†è‡ªå®šä¹‰APIè°ƒç”¨');
            this.customAPITaskQueue.addTask({
                type: 'INFOBAR_DATA',
                data: { content: plotContent },
                source: 'direct_call'
            });
            return;
        }

        // å¦åˆ™ç›´æ¥å¤„ç†
        return await this.processWithCustomAPIInternal(plotContent);
    }

    /**
     * ğŸ”§ å†…éƒ¨æ–¹æ³•ï¼šå®é™…çš„è‡ªå®šä¹‰APIå¤„ç†é€»è¾‘
     */
    async processWithCustomAPIInternal(plotContent) {
        try {
            // å¹¶å‘ä¿æŠ¤ï¼šé˜²æ­¢é‡å¤è§¦å‘
            if (this._customAPIProcessing) {
                console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰APIå¤„ç†å·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                this.showNotification('â³ è‡ªå®šä¹‰APIå¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤è§¦å‘', 'warning');
                return;
            }
            this._customAPIProcessing = true;

            console.log('[InfoBarSettings] ğŸš€ å¼€å§‹ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å‰§æƒ…å†…å®¹...');

            // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIç”Ÿæˆä¸­æç¤º
            this.showCustomAPIStatus('generating');

            // éªŒè¯å‰§æƒ…å†…å®¹
            if (!plotContent || typeof plotContent !== 'string') {
                console.warn('[InfoBarSettings] âš ï¸ å‰§æƒ…å†…å®¹æ— æ•ˆ:', typeof plotContent);
                this.showCustomAPIStatus('error', 'å‰§æƒ…å†…å®¹æ— æ•ˆ');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“ å‰§æƒ…å†…å®¹é•¿åº¦:', plotContent.length);

            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤é‡å¤çš„æ™ºèƒ½æç¤ºè¯å¤„ç†
            // æ™ºèƒ½æç¤ºè¯ä¼šåœ¨enhanceMessagesWithSystemPrompt()ä¸­ç»Ÿä¸€å¤„ç†
            console.log('[InfoBarSettings] âœ… æ™ºèƒ½æç¤ºè¯å°†åœ¨æ¶ˆæ¯å¢å¼ºé˜¶æ®µç»Ÿä¸€å¤„ç†');

            // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è°ƒç”¨å˜é‡ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆæ–¹æ³•
            let variablePrompt = '';
            try {
                const variableSystemPrompt = window.SillyTavernInfobar?.modules?.variableSystemPrompt;
                if (variableSystemPrompt && typeof variableSystemPrompt.generatePromptTemplate === 'function') {
                    variablePrompt = await variableSystemPrompt.generatePromptTemplate();
                    console.log('[InfoBarSettings] âœ… è·å–åˆ°å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯ï¼Œé•¿åº¦:', variablePrompt.length);
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ å˜é‡ç³»ç»Ÿæç¤ºè¯æ¨¡å—ä¸å¯ç”¨æˆ–ç¼ºå°‘generatePromptTemplateæ–¹æ³•');
                }
            } catch (error) {
                console.error('[InfoBarSettings] âŒ è·å–å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯å¤±è´¥:', error);
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–ä¸–ç•Œä¹¦å†…å®¹
            let worldBookContent = '';
            const context = SillyTavern.getContext();
            const apiConfig = context.extensionSettings['Information bar integration tool']?.apiConfig || {};
            if (apiConfig.includeWorldBook) {
                try {
                    worldBookContent = await this.getWorldBookContent();
                    if (worldBookContent) {
                        console.log('[InfoBarSettings] ğŸ“š è·å–åˆ°ä¸–ç•Œä¹¦å†…å®¹ï¼Œé•¿åº¦:', worldBookContent.length);
                    } else {
                        console.log('[InfoBarSettings] ğŸ“š ä¸–ç•Œä¹¦å†…å®¹ä¸ºç©ºæˆ–æœªæ¿€æ´»');
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½æç¤ºè¯ç°åœ¨åœ¨æ¶ˆæ¯å¢å¼ºé˜¶æ®µå¤„ç†ï¼Œè¿™é‡Œä¸å†éœ€è¦
            let fullSystemPrompt = '';

            // ğŸ”§ ä¿®å¤ï¼šæ‰‹åŠ¨å¤„ç†å˜é‡æ›¿æ¢ï¼Œç„¶åæ·»åŠ å˜é‡ç³»ç»Ÿè¯»å–æç¤ºè¯
            if (variablePrompt) {
                try {
                    // æ‰‹åŠ¨è°ƒç”¨SillyTavernçš„å˜é‡æ›¿æ¢åŠŸèƒ½
                    if (typeof context.substituteParams === 'function') {
                        variablePrompt = context.substituteParams(variablePrompt);
                        console.log('[InfoBarSettings] âœ… å˜é‡æ›¿æ¢å®Œæˆï¼Œå¤„ç†åé•¿åº¦:', variablePrompt.length);
                    } else {
                        console.warn('[InfoBarSettings] âš ï¸ SillyTavernå˜é‡æ›¿æ¢åŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡å˜é‡å¤„ç†');
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å˜é‡æ›¿æ¢å¤±è´¥:', error);
                }
                fullSystemPrompt = variablePrompt + '\n\n' + fullSystemPrompt;
            }

            // æ·»åŠ ä¸–ç•Œä¹¦å†…å®¹
            if (worldBookContent) {
                fullSystemPrompt = fullSystemPrompt + '\n\n## ğŸ“š ä¸–ç•Œä¹¦ä¿¡æ¯\n\n' + worldBookContent;
            }

            // å‡†å¤‡APIè¯·æ±‚
            console.log('[InfoBarSettings] ğŸ“¡ å‡†å¤‡å‘é€è‡ªå®šä¹‰APIè¯·æ±‚...');
            const messages = [
                {
                    role: 'system',
                    content: fullSystemPrompt
                },
                {
                    role: 'user',
                    content: `è¯·æ ¹æ®ä»¥ä¸‹å‰§æƒ…å†…å®¹ç”Ÿæˆä¿¡æ¯æ æ•°æ®ï¼š\n\n${plotContent}`
                }
            ];

            console.log('[InfoBarSettings] ğŸ“Š è¯·æ±‚è¯¦æƒ…:', {
                messagesCount: messages.length,
                systemPromptLength: fullSystemPrompt.length,

                variablePromptLength: variablePrompt.length,
                worldBookLength: worldBookContent.length,
                userPromptLength: plotContent.length,
                apiProvider: this.getAPIProvider(),
                apiModel: this.getAPIModel(),
                includeWorldBook: apiConfig.includeWorldBook
            });

            // å‘é€è‡ªå®šä¹‰APIè¯·æ±‚ï¼ˆå¢å¼ºé‡è¯•é€»è¾‘ï¼‰
            const cfg = context.extensionSettings['Information bar integration tool']?.apiConfig || {};
            const maxRetry = Number(cfg.retryCount ?? 5); // å¢åŠ é»˜è®¤é‡è¯•æ¬¡æ•°
            const baseRetryDelayMs = 2000; // å¢åŠ åŸºç¡€å»¶è¿Ÿæ—¶é—´

            let attempt = 0;
            let lastError = null;
            while (attempt <= maxRetry) {
                attempt++;
                const result = await this.sendCustomAPIRequest(messages, { skipSystemPrompt: false });
                if (result && result.success && typeof result.text === 'string' && result.text.trim().length > 0) {
                    console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIè¿”å›ç»“æœï¼Œé•¿åº¦:', result.text.length, ' å°è¯•æ¬¡æ•°:', attempt);
                    await this.processAPIResult(result.text);
                    // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIç”Ÿæˆå®Œæˆæç¤º
                    this.showCustomAPIStatus('success');
                    break;
                } else {
                    lastError = result?.error || 'ç©ºå“åº”æˆ–æ ¼å¼æ— æ•ˆ';
                    console.warn(`[InfoBarSettings] âš ï¸ APIç»“æœä¸ºç©ºæˆ–æ— æ•ˆï¼Œå‡†å¤‡é‡è¯• (${attempt}/${maxRetry}) ...`);
                    if (attempt > maxRetry) {
                        console.error('[InfoBarSettings] âŒ é‡è¯•è¾¾ä¸Šé™ï¼Œæ”¾å¼ƒã€‚æœ¬æ¬¡é”™è¯¯:', lastError);
                        this.showCustomAPIStatus('error', 'é‡è¯•å¤±è´¥: ' + lastError);
                        break;
                    }
                    // ğŸ”§ æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ï¼šæ¯æ¬¡é‡è¯•å»¶è¿Ÿæ—¶é—´é€’å¢
                    const retryDelayMs = baseRetryDelayMs * Math.pow(1.5, attempt - 1);
                    console.log(`[InfoBarSettings] â³ ç­‰å¾… ${retryDelayMs}ms åé‡è¯•...`);
                    await new Promise(r=>setTimeout(r, retryDelayMs));
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä½¿ç”¨è‡ªå®šä¹‰APIå¤„ç†å¤±è´¥:', error);
            // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰APIé”™è¯¯æç¤º
            this.showCustomAPIStatus('error', error.message);
        } finally {
            // å¤ä½å¹¶å‘æ ‡è®°
            this._customAPIProcessing = false;
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰APIçŠ¶æ€æç¤º
     */
    showCustomAPIStatus(status, message = '') {
        try {
            // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æç¤º
            const existingToast = document.querySelector('.custom-api-status-toast');
            if (existingToast) {
                existingToast.remove();
            }

            let toastContent = '';
            let toastClass = 'custom-api-status-toast';
            let autoHide = false;

            switch (status) {
                case 'generating':
                    toastContent = 'ğŸ¤– è‡ªå®šä¹‰APIç”Ÿæˆä¸­...';
                    toastClass += ' generating';
                    break;
                case 'success':
                    toastContent = 'âœ… è‡ªå®šä¹‰APIå·²ç”Ÿæˆ';
                    toastClass += ' success';
                    autoHide = true;
                    break;
                case 'error':
                    toastContent = `âŒ è‡ªå®šä¹‰APIç”Ÿæˆå¤±è´¥${message ? ': ' + message : ''}`;
                    toastClass += ' error';
                    autoHide = true;
                    break;
            }

            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = toastClass;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-text">${toastContent}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                </div>
            `;

            // æ·»åŠ æ ·å¼
            if (!document.getElementById('custom-api-status-styles')) {
                const style = document.createElement('style');
                style.id = 'custom-api-status-styles';
                style.textContent = `
                    .custom-api-status-toast {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        padding: 0;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        animation: slideInRight 0.3s ease-out;
                    }
                    .custom-api-status-toast.generating {
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        color: white;
                    }
                    .custom-api-status-toast.success {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                    }
                    .custom-api-status-toast.error {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                    }
                    .toast-content {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 12px 16px;
                    }
                    .toast-text {
                        flex: 1;
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .toast-close {
                        background: none;
                        border: none;
                        color: inherit;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        padding: 0;
                        margin-left: 12px;
                        opacity: 0.8;
                        transition: opacity 0.2s;
                    }
                    .toast-close:hover {
                        opacity: 1;
                    }
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // è‡ªåŠ¨éšè—
            if (autoHide) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 300);
                    }
                }, 3000);
            }

            console.log('[InfoBarSettings] ğŸ“¢ è‡ªå®šä¹‰APIçŠ¶æ€æç¤ºå·²æ˜¾ç¤º:', status, message);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºè‡ªå®šä¹‰APIçŠ¶æ€æç¤ºå¤±è´¥:', error);
        }
    }

    /**
     * å¯¼å‡ºæ•°æ®åŠŸèƒ½
     */
    async exportData() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¼€å§‹å¯¼å‡ºæ•°æ®...');

            // è·å–ç”¨æˆ·é€‰æ‹©çš„èŒƒå›´å’Œæ ¼å¼
            const scopeSelect = this.modal.querySelector('#data-scope-select');
            const formatSelect = this.modal.querySelector('#data-format-select');

            if (!scopeSelect || !formatSelect) {
                this.showMessage('âŒ æ— æ³•è·å–å¯¼å‡ºè®¾ç½®', 'error');
                return;
            }

            const scope = scopeSelect.value; // 'current' æˆ– 'all'
            const format = formatSelect.value; // 'json', 'csv', æˆ– 'xml'

            console.log('[InfoBarSettings] ğŸ“Š å¯¼å‡ºè®¾ç½®:', { scope, format });

            // æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦æç¤º
            this.showMessage('ğŸ”„ æ­£åœ¨æ”¶é›†æ•°æ®...', 'info');

            // æ”¶é›†æ•°æ®
            const exportData = await this.collectExportData(scope);

            if (!exportData || Object.keys(exportData).length === 0) {
                this.showMessage('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
                return;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ”¶é›†åˆ°çš„æ•°æ®:', {
                chats: exportData.chats?.length || 0,
                totalMessages: exportData.chats?.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0) || 0,
                infobarDataEntries: Object.keys(exportData.infobarData || {}).length
            });

            // è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼
            let exportContent;
            let fileName;
            let mimeType;

            switch (format) {
                case 'json':
                    exportContent = JSON.stringify(exportData, null, 2);
                    fileName = `infobar_data_${this.getTimestamp()}.json`;
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    exportContent = this.convertToCSV(exportData);
                    fileName = `infobar_data_${this.getTimestamp()}.csv`;
                    mimeType = 'text/csv';
                    break;
                case 'xml':
                    exportContent = this.convertToXML(exportData);
                    fileName = `infobar_data_${this.getTimestamp()}.xml`;
                    mimeType = 'application/xml';
                    break;
                default:
                    throw new Error('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼: ' + format);
            }

            // è§¦å‘ä¸‹è½½
            this.downloadFile(exportContent, fileName, mimeType);

            this.showMessage(`âœ… æ•°æ®å·²å¯¼å‡ºä¸º ${fileName}`, 'success');
            console.log('[InfoBarSettings] âœ… æ•°æ®å¯¼å‡ºå®Œæˆ:', fileName);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
            this.showMessage('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ”¶é›†å¯¼å‡ºæ•°æ®
     */
    async collectExportData(scope) {
        try {
            const exportData = {
                metadata: {
                    exportTime: new Date().toISOString(),
                    scope: scope,
                    version: '1.0.0',
                    source: 'Information bar integration tool'
                },
                chats: [],
                infobarData: {},
                settings: {}
            };

            // è·å–SillyTavernä¸Šä¸‹æ–‡
            const context = SillyTavern.getContext();
            if (!context) {
                throw new Error('æ— æ³•è·å–SillyTavernä¸Šä¸‹æ–‡');
            }

            // æ”¶é›†èŠå¤©æ•°æ®
            if (scope === 'current') {
                // å½“å‰èŠå¤©
                const currentChatId = context.chatId;
                if (currentChatId && context.chat) {
                    const chatData = {
                        chatId: currentChatId,
                        chatName: context.name2 || 'Unknown',
                        character: context.name2 || 'Unknown',
                        messages: context.chat || [],
                        timestamp: new Date().toISOString()
                    };
                    exportData.chats.push(chatData);

                    // æ”¶é›†å½“å‰èŠå¤©çš„ä¿¡æ¯æ æ•°æ®
                    if (this.unifiedDataCore?.getChatData) {
                        const chatInfobarData = await this.unifiedDataCore.getChatData(currentChatId);
                        if (chatInfobarData && Object.keys(chatInfobarData).length > 0) {
                            exportData.infobarData[currentChatId] = chatInfobarData;
                        }
                    }
                }
            } else {
                // æ‰€æœ‰èŠå¤©
                const allChats = context.characters || [];
                for (const character of allChats) {
                    if (character) {
                        const chatData = {
                            chatId: character.filename || character.name,
                            chatName: character.name,
                            character: character.name,
                            // æ³¨æ„ï¼šéå½“å‰èŠå¤©çš„æ¶ˆæ¯æ­£æ–‡é€šå¸¸æœªé¢„åŠ è½½ï¼Œé¿å…å¯¼å‡ºé”™è¯¯ç»“æ„
                            messages: Array.isArray(character.chat) ? character.chat : [],
                            timestamp: new Date().toISOString()
                        };
                        exportData.chats.push(chatData);

                        // æ”¶é›†è¯¥èŠå¤©çš„ä¿¡æ¯æ æ•°æ®
                        if (this.unifiedDataCore?.getChatData) {
                            const cid = character.filename || character.name;
                            const chatInfobarData = await this.unifiedDataCore.getChatData(cid);
                            if (chatInfobarData && Object.keys(chatInfobarData).length > 0) {
                                exportData.infobarData[cid] = chatInfobarData;
                            }
                        }
                    }
                }
            }

            // æ”¶é›†æ‰©å±•è®¾ç½®ï¼ˆè„±æ•apiKeyï¼‰
            const extensionSettings = context.extensionSettings;
            if (extensionSettings && extensionSettings['Information bar integration tool']) {
                const safeSettings = JSON.parse(JSON.stringify(extensionSettings['Information bar integration tool']));
                if (safeSettings?.apiConfig?.apiKey) {
                    safeSettings.apiConfig.apiKey = '***REMOVED***';
                }
                exportData.settings = safeSettings;
            }

            console.log('[InfoBarSettings] ğŸ“Š æ•°æ®æ”¶é›†å®Œæˆ:', {
                chats: exportData.chats.length,
                infobarDataKeys: Object.keys(exportData.infobarData).length,
                hasSettings: !!exportData.settings
            });

            return exportData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ”¶é›†å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è½¬æ¢æ•°æ®ä¸ºCSVæ ¼å¼
     */
    convertToCSV(data) {
        try {
            let csvContent = '';

            // CSVå¤´éƒ¨ä¿¡æ¯
            csvContent += '# Information Bar Integration Tool Data Export\n';
            csvContent += `# Export Time: ${data.metadata.exportTime}\n`;
            csvContent += `# Scope: ${data.metadata.scope}\n`;
            csvContent += '\n';

            // èŠå¤©æ•°æ®è¡¨
            if (data.chats && data.chats.length > 0) {
                csvContent += 'Chat Data\n';
                csvContent += 'Chat ID,Chat Name,Character,Message Count,Last Message Time\n';

                data.chats.forEach(chat => {
                    const messageCount = chat.messages ? chat.messages.length : 0;
                    const lastMessageTime = chat.messages && chat.messages.length > 0
                        ? (chat.messages[chat.messages.length - 1].send_date || 'Unknown')
                        : 'No messages';

                    csvContent += `"${chat.chatId}","${chat.chatName}","${chat.character}",${messageCount},"${lastMessageTime}"\n`;
                });
                csvContent += '\n';
            }

            // ä¿¡æ¯æ æ•°æ®è¡¨
            if (data.infobarData && Object.keys(data.infobarData).length > 0) {
                csvContent += 'InfoBar Data\n';
                csvContent += 'Chat ID,Message ID,Panel Type,Data Key,Data Value\n';

                Object.entries(data.infobarData).forEach(([chatId, chatData]) => {
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        Object.entries(messageData).forEach(([panelType, panelData]) => {
                            if (typeof panelData === 'object') {
                                Object.entries(panelData).forEach(([key, value]) => {
                                    const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
                                    csvContent += `"${chatId}","${messageId}","${panelType}","${key}","${valueStr}"\n`;
                                });
                            }
                        });
                    });
                });
            }

            return csvContent;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è½¬æ¢CSVæ ¼å¼å¤±è´¥:', error);
            throw new Error('CSVæ ¼å¼è½¬æ¢å¤±è´¥: ' + error.message);
        }
    }

    /**
     * è½¬æ¢æ•°æ®ä¸ºXMLæ ¼å¼
     */
    convertToXML(data) {
        try {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlContent += '<InfoBarExport>\n';

            // å…ƒæ•°æ®
            xmlContent += '  <Metadata>\n';
            xmlContent += `    <ExportTime>${this.escapeXML(data.metadata.exportTime)}</ExportTime>\n`;
            xmlContent += `    <Scope>${this.escapeXML(data.metadata.scope)}</Scope>\n`;
            xmlContent += `    <Version>${this.escapeXML(data.metadata.version)}</Version>\n`;
            xmlContent += `    <Source>${this.escapeXML(data.metadata.source)}</Source>\n`;
            xmlContent += '  </Metadata>\n';

            // èŠå¤©æ•°æ®
            if (data.chats && data.chats.length > 0) {
                xmlContent += '  <Chats>\n';
                data.chats.forEach(chat => {
                    xmlContent += '    <Chat>\n';
                    xmlContent += `      <ChatId>${this.escapeXML(chat.chatId)}</ChatId>\n`;
                    xmlContent += `      <ChatName>${this.escapeXML(chat.chatName)}</ChatName>\n`;
                    xmlContent += `      <Character>${this.escapeXML(chat.character)}</Character>\n`;
                    xmlContent += `      <MessageCount>${chat.messages ? chat.messages.length : 0}</MessageCount>\n`;
                    xmlContent += `      <Timestamp>${this.escapeXML(chat.timestamp)}</Timestamp>\n`;
                    xmlContent += '    </Chat>\n';
                });
                xmlContent += '  </Chats>\n';
            }

            // ä¿¡æ¯æ æ•°æ®
            if (data.infobarData && Object.keys(data.infobarData).length > 0) {
                xmlContent += '  <InfoBarData>\n';
                Object.entries(data.infobarData).forEach(([chatId, chatData]) => {
                    xmlContent += `    <ChatData chatId="${this.escapeXML(chatId)}">\n`;
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        xmlContent += `      <MessageData messageId="${this.escapeXML(messageId)}">\n`;
                        Object.entries(messageData).forEach(([panelType, panelData]) => {
                            xmlContent += `        <Panel type="${this.escapeXML(panelType)}">\n`;
                            if (typeof panelData === 'object') {
                                Object.entries(panelData).forEach(([key, value]) => {
                                    const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
                                    xmlContent += `          <Data key="${this.escapeXML(key)}">${this.escapeXML(valueStr)}</Data>\n`;
                                });
                            }
                            xmlContent += '        </Panel>\n';
                        });
                        xmlContent += '      </MessageData>\n';
                    });
                    xmlContent += '    </ChatData>\n';
                });
                xmlContent += '  </InfoBarData>\n';
            }

            xmlContent += '</InfoBarExport>';
            return xmlContent;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è½¬æ¢XMLæ ¼å¼å¤±è´¥:', error);
            throw new Error('XMLæ ¼å¼è½¬æ¢å¤±è´¥: ' + error.message);
        }
    }

    /**
     * XMLè½¬ä¹‰å‡½æ•°
     */
    escapeXML(str) {
        if (typeof str !== 'string') {
            str = String(str);
        }
        return str.replace(/[<>&'"]/g, (char) => {
            switch (char) {
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '&': return '&amp;';
                case "'": return '&apos;';
                case '"': return '&quot;';
                default: return char;
            }
        });
    }

    /**
     * è·å–æ—¶é—´æˆ³å­—ç¬¦ä¸²
     */
    getTimestamp() {
        const now = new Date();
        return now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
    }

    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    downloadFile(content, fileName, mimeType) {
        try {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ¸…ç†URLå¯¹è±¡
            setTimeout(() => URL.revokeObjectURL(url), 1000);

            console.log('[InfoBarSettings] ğŸ“ æ–‡ä»¶ä¸‹è½½è§¦å‘:', fileName);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
            throw new Error('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
        }
    }

    /**
     * å¯¼å…¥æ•°æ®åŠŸèƒ½
     */
    async importData() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ å¼€å§‹å¯¼å…¥æ•°æ®...');

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,.csv,.xml';
            fileInput.style.display = 'none';

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                try {
                    this.showMessage('ğŸ”„ æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');

                    // è¯»å–æ–‡ä»¶å†…å®¹
                    const content = await this.readFileContent(file);

                    // è§£ææ•°æ®
                    const importData = await this.parseImportData(content, file.name);

                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    const confirmed = await this.showImportConfirmDialog(importData);

                    if (confirmed) {
                        // æ‰§è¡Œå¯¼å…¥
                        await this.executeImport(importData);
                        this.showMessage('âœ… æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                    } else {
                        this.showMessage('â„¹ï¸ å¯¼å…¥å·²å–æ¶ˆ', 'info');
                    }

                } catch (error) {
                    console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    this.showMessage('âŒ å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
                } finally {
                    // æ¸…ç†æ–‡ä»¶è¾“å…¥
                    if (fileInput.parentNode) {
                        fileInput.parentNode.removeChild(fileInput);
                    }
                }
            });

            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            document.body.appendChild(fileInput);
            fileInput.click();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
            this.showMessage('âŒ å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * è¯»å–æ–‡ä»¶å†…å®¹
     */
    readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
            reader.readAsText(file, 'UTF-8');
        });
    }

    /**
     * è§£æå¯¼å…¥æ•°æ®
     */
    async parseImportData(content, fileName) {
        try {
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let parsedData;

            switch (fileExtension) {
                case 'json':
                    parsedData = JSON.parse(content);
                    break;
                case 'csv':
                    parsedData = this.parseCSVData(content);
                    break;
                case 'xml':
                    parsedData = this.parseXMLData(content);
                    break;
                default:
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ' + fileExtension);
            }

            // éªŒè¯æ•°æ®ç»“æ„
            this.validateImportData(parsedData);

            return parsedData;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è§£æå¯¼å…¥æ•°æ®å¤±è´¥:', error);
            throw new Error('æ•°æ®è§£æå¤±è´¥: ' + error.message);
        }
    }

    /**
     * è§£æCSVæ•°æ®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    parseCSVData(content) {
        // è¿™é‡Œå®ç°ä¸€ä¸ªç®€åŒ–çš„CSVè§£æ
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„CSVè§£æé€»è¾‘
        throw new Error('CSVå¯¼å…¥åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨JSONæ ¼å¼');
    }

    /**
     * è§£æXMLæ•°æ®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    parseXMLData(content) {
        // è¿™é‡Œå®ç°ä¸€ä¸ªç®€åŒ–çš„XMLè§£æ
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„XMLè§£æé€»è¾‘
        throw new Error('XMLå¯¼å…¥åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨JSONæ ¼å¼');
    }

    /**
     * éªŒè¯å¯¼å…¥æ•°æ®ç»“æ„
     */
    validateImportData(data) {
        if (!data || typeof data !== 'object') {
            throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
        }

        if (!data.metadata) {
            throw new Error('ç¼ºå°‘å…ƒæ•°æ®ä¿¡æ¯');
        }

        if (!data.metadata.source || data.metadata.source !== 'Information bar integration tool') {
            throw new Error('æ•°æ®æ¥æºä¸åŒ¹é…ï¼Œè¯·ç¡®ä¿æ˜¯æœ¬å·¥å…·å¯¼å‡ºçš„æ•°æ®');
        }

        console.log('[InfoBarSettings] âœ… æ•°æ®éªŒè¯é€šè¿‡');
    }

    /**
     * æ˜¾ç¤ºå¯¼å…¥ç¡®è®¤å¯¹è¯æ¡†
     */
    showImportConfirmDialog(importData) {
        return new Promise((resolve) => {
            try {
                // ç»Ÿè®¡å¯¼å…¥æ•°æ®
                const stats = {
                    chats: importData.chats ? importData.chats.length : 0,
                    totalMessages: importData.chats ? importData.chats.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0) : 0,
                    infobarDataEntries: importData.infobarData ? Object.keys(importData.infobarData).length : 0,
                    hasSettings: !!importData.settings
                };

                // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
                const dialog = document.createElement('div');
                dialog.className = 'import-confirm-dialog';
                dialog.innerHTML = `
                    <div class="dialog-overlay">
                        <div class="dialog-content">
                            <h3>ç¡®è®¤å¯¼å…¥æ•°æ®</h3>
                            <div class="import-stats">
                                <p><strong>å¯¼å…¥æ•°æ®ç»Ÿè®¡ï¼š</strong></p>
                                <ul>
                                    <li>èŠå¤©æ•°é‡: ${stats.chats}</li>
                                    <li>æ¶ˆæ¯æ€»æ•°: ${stats.totalMessages}</li>
                                    <li>ä¿¡æ¯æ æ•°æ®æ¡ç›®: ${stats.infobarDataEntries}</li>
                                    <li>åŒ…å«è®¾ç½®: ${stats.hasSettings ? 'æ˜¯' : 'å¦'}</li>
                                </ul>
                                <p><strong>å¯¼å‡ºæ—¶é—´:</strong> ${importData.metadata.exportTime}</p>
                                <p><strong>æ•°æ®èŒƒå›´:</strong> ${importData.metadata.scope === 'current' ? 'å½“å‰èŠå¤©' : 'æ‰€æœ‰èŠå¤©'}</p>
                            </div>
                            <div class="import-warning">
                                <p>âš ï¸ <strong>æ³¨æ„ï¼š</strong></p>
                                <ul>
                                    <li>å¯¼å…¥æ“ä½œå°†è¦†ç›–ç°æœ‰çš„ä¿¡æ¯æ æ•°æ®</li>
                                    <li>å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</li>
                                    <li>æ­¤æ“ä½œæ— æ³•æ’¤é”€</li>
                                </ul>
                            </div>
                            <div class="dialog-actions">
                                <button class="btn btn-danger" data-action="confirm">ç¡®è®¤å¯¼å…¥</button>
                                <button class="btn btn-secondary" data-action="cancel">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ æ ·å¼
                if (!document.getElementById('import-dialog-styles')) {
                    const style = document.createElement('style');
                    style.id = 'import-dialog-styles';
                    style.textContent = `
                        .import-confirm-dialog {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10001;
                        }
                        .dialog-overlay {
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .dialog-content {
                            background: white;
                            border-radius: 8px;
                            padding: 24px;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                        }
                        .dialog-content h3 {
                            margin: 0 0 16px 0;
                            color: #333;
                        }
                        .import-stats {
                            background: #f8f9fa;
                            padding: 16px;
                            border-radius: 6px;
                            margin: 16px 0;
                        }
                        .import-stats ul {
                            margin: 8px 0;
                            padding-left: 20px;
                        }
                        .import-warning {
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            padding: 16px;
                            border-radius: 6px;
                            margin: 16px 0;
                        }
                        .import-warning ul {
                            margin: 8px 0;
                            padding-left: 20px;
                        }
                        .dialog-actions {
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                            margin-top: 24px;
                        }
                        .dialog-actions .btn {
                            padding: 8px 16px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        }
                        .dialog-actions .btn-danger {
                            background: #dc3545;
                            color: white;
                        }
                        .dialog-actions .btn-secondary {
                            background: #6c757d;
                            color: white;
                        }
                    `;
                    document.head.appendChild(style);
                }

                // äº‹ä»¶å¤„ç†
                dialog.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'confirm') {
                        dialog.remove();
                        resolve(true);
                    } else if (action === 'cancel' || e.target === dialog.querySelector('.dialog-overlay')) {
                        dialog.remove();
                        resolve(false);
                    }
                });

                // æ˜¾ç¤ºå¯¹è¯æ¡†
                document.body.appendChild(dialog);

            } catch (error) {
                console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºå¯¼å…¥ç¡®è®¤å¯¹è¯æ¡†å¤±è´¥:', error);
                resolve(false);
            }
        });
    }

    /**
     * æ‰§è¡Œå¯¼å…¥æ“ä½œ
     */
    async executeImport(importData) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ å¼€å§‹æ‰§è¡Œå¯¼å…¥æ“ä½œ...');

            let importedCount = 0;

            // å¯¼å…¥ä¿¡æ¯æ æ•°æ®åˆ°ç»Ÿä¸€æ•°æ®æ ¸å¿ƒ
            if (importData.infobarData && this.unifiedDataCore) {
                Object.entries(importData.infobarData).forEach(([chatId, chatData]) => {
                    Object.entries(chatData).forEach(([messageId, messageData]) => {
                        // å°†æ•°æ®å†™å…¥ç»Ÿä¸€æ•°æ®æ ¸å¿ƒ
                        this.unifiedDataCore.setMessageData(chatId, messageId, messageData);
                        importedCount++;
                    });
                });
                console.log('[InfoBarSettings] ğŸ“Š å·²å¯¼å…¥ä¿¡æ¯æ æ•°æ®æ¡ç›®:', importedCount);
            }

            // å¯¼å…¥è®¾ç½®ï¼ˆå¯é€‰ï¼‰
            if (importData.settings) {
                const context = SillyTavern.getContext();
                if (context && context.extensionSettings) {
                    // å¤‡ä»½å½“å‰è®¾ç½®
                    const currentSettings = context.extensionSettings['Information bar integration tool'] || {};

                    // åˆå¹¶è®¾ç½®ï¼ˆä¿ç•™å½“å‰çš„APIé…ç½®ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰
                    const mergedSettings = {
                        ...importData.settings,
                        // ä¿ç•™å½“å‰çš„APIé…ç½®
                        apiConfig: currentSettings.apiConfig || importData.settings.apiConfig
                    };

                    context.extensionSettings['Information bar integration tool'] = mergedSettings;

                    // ä¿å­˜è®¾ç½®
                    await this.saveExtensionSettings();
                    console.log('[InfoBarSettings] âš™ï¸ å·²å¯¼å…¥æ‰©å±•è®¾ç½®');
                }
            }

            // è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶
            if (this.eventSource) {
                this.eventSource.emit('dataImported', {
                    importedCount,
                    source: importData.metadata.source,
                    timestamp: new Date().toISOString()
                });
            }

            console.log('[InfoBarSettings] âœ… å¯¼å…¥æ“ä½œå®Œæˆï¼Œå…±å¯¼å…¥', importedCount, 'æ¡æ•°æ®');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œå¯¼å…¥æ“ä½œå¤±è´¥:', error);
            throw new Error('å¯¼å…¥æ‰§è¡Œå¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜æ‰©å±•è®¾ç½®åˆ°SillyTavern
     */
    async saveExtensionSettings() {
        try {
            const context = SillyTavern.getContext();
            if (context && context.saveSettingsDebounced) {
                await context.saveSettingsDebounced();
                console.log('[InfoBarSettings] ğŸ’¾ æ‰©å±•è®¾ç½®å·²ä¿å­˜');
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ‰©å±•è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ç¡®ä¿æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½
     */
    ensureDataManagementStyles() {
        try {
            if (document.getElementById('data-management-styles')) {
                return; // æ ·å¼å·²å­˜åœ¨
            }

            const style = document.createElement('style');
            style.id = 'data-management-styles';
            style.textContent = `
                /* æ•°æ®ç®¡ç†åŠŸèƒ½åŒºåŸŸæ ·å¼ */
                .data-management-actions {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 12px !important;
                    margin-top: 8px !important;
                    width: 100% !important;
                }
                .data-export-btn, .data-import-btn {
                    flex: 1 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 6px !important;
                    padding: 10px 16px !important;
                    border: none !important;
                    border-radius: 6px !important;
                    font-size: 14px !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    min-height: 40px !important;
                    white-space: nowrap !important;
                }
                .data-export-btn {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    color: white !important;
                }
                .data-export-btn:hover {
                    background: var(--theme-primary-hover, #e55a2b) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3) !important;
                }
                .data-import-btn {
                    background: var(--theme-bg-secondary, #4a5568) !important;
                    color: white !important;
                    border: 1px solid var(--theme-border-color, #666) !important;
                }
                .data-import-btn:hover {
                    background: var(--theme-primary-color, #ff6b35) !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2) !important;
                }
                .data-management-hint {
                    color: var(--theme-text-secondary, #a0a0a0) !important;
                    font-size: 13px !important;
                    line-height: 1.4 !important;
                    margin-top: 8px !important;
                    padding: 8px 12px !important;
                    background: var(--theme-bg-secondary, rgba(107, 114, 128, 0.1)) !important;
                    border-radius: 4px !important;
                    border-left: 3px solid var(--theme-primary-color, #ff6b35) !important;
                }
            `;
            document.head.appendChild(style);
            console.log('[InfoBarSettings] âœ… æ•°æ®ç®¡ç†æ ·å¼å·²åŠ è½½');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®ç®¡ç†æ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * è·å–ä¸–ç•Œä¹¦å†…å®¹
     */
    async getWorldBookContent() {
        try {
            console.log('[InfoBarSettings] ğŸ“š å¼€å§‹è·å–ä¸–ç•Œä¹¦å†…å®¹...');

            const context = SillyTavern.getContext();
            if (!context) {
                console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è·å–SillyTavernä¸Šä¸‹æ–‡');
                return '';
            }

            // æ–¹æ³•1ï¼šå°è¯•ä» context.worldInfoData è·å–
            if (context.worldInfoData && Array.isArray(context.worldInfoData) && context.worldInfoData.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»worldInfoDataè·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = context.worldInfoData.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            // æ–¹æ³•2ï¼šå°è¯•ä» context.world_info è·å–
            if (context.world_info && Array.isArray(context.world_info) && context.world_info.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»world_infoè·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = context.world_info.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            // æ–¹æ³•3ï¼šå°è¯•é€šè¿‡ SillyTavern API è·å–
            if (typeof context.getWorldInfoSettings === 'function') {
                console.log('[InfoBarSettings] ğŸ“– é€šè¿‡APIè·å–ä¸–ç•Œä¹¦è®¾ç½®');
                const worldInfo = context.getWorldInfoSettings();
                if (worldInfo && worldInfo.length > 0) {
                    const activeEntries = worldInfo.filter(entry =>
                        entry && !entry.disable && entry.content && entry.content.trim()
                    );

                    if (activeEntries.length > 0) {
                        const worldBookText = activeEntries.map(entry => {
                            const title = entry.key || entry.keys || 'Unknown';
                            const content = entry.content || '';
                            return `**${title}**: ${content}`;
                        }).join('\n\n');

                        console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                        return worldBookText;
                    }
                }
            }

            // æ–¹æ³•4ï¼šå°è¯•ç›´æ¥ä»å…¨å±€å˜é‡è·å–
            if (window.world_info && Array.isArray(window.world_info) && window.world_info.length > 0) {
                console.log('[InfoBarSettings] ğŸ“– ä»å…¨å±€å˜é‡è·å–ä¸–ç•Œä¹¦å†…å®¹');
                const activeEntries = window.world_info.filter(entry =>
                    entry && !entry.disable && entry.content && entry.content.trim()
                );

                if (activeEntries.length > 0) {
                    const worldBookText = activeEntries.map(entry => {
                        const title = entry.key || entry.keys || 'Unknown';
                        const content = entry.content || '';
                        return `**${title}**: ${content}`;
                    }).join('\n\n');

                    console.log('[InfoBarSettings] âœ… è·å–åˆ°ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', activeEntries.length);
                    return worldBookText;
                }
            }

            console.log('[InfoBarSettings] ğŸ“š æ²¡æœ‰æ‰¾åˆ°æ¿€æ´»çš„ä¸–ç•Œä¹¦å†…å®¹');
            return '';

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * è·å–å¤‡ç”¨ç³»ç»Ÿæç¤ºè¯
     */
    getBackupSystemPrompt() {
        return `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ **CRITICAL: ç»å¯¹ç¦æ­¢è¡¨æ ¼æ ¼å¼ï¼** ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

âŒâŒâŒ **SYSTEM WILL CRASH IF YOU USE TABLE FORMAT** âŒâŒâŒ
âŒ **ç»å¯¹ç¦æ­¢**: | ç±»åˆ« | å†…å®¹ | â† TABLE = CRASH!
âŒ **ç»å¯¹ç¦æ­¢**: ### **åœºæ™¯ä¿¡æ¯æ ** â† MARKDOWN = CRASH!
âŒ **ç»å¯¹ç¦æ­¢**: | :--- | :--- | â† ANY TABLE SYMBOL = CRASH!

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡æ¯æ æ•°æ®ç”ŸæˆåŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„å‰§æƒ…å†…å®¹ï¼Œç”Ÿæˆç»“æ„åŒ–çš„ä¿¡æ¯æ æ•°æ®ã€‚

ğŸš¨ğŸš¨ğŸš¨ **MANDATORY OUTPUT FORMAT - å¼ºåˆ¶è¾“å‡ºæ ¼å¼** ğŸš¨ğŸš¨ğŸš¨

**å¿…é¡»æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¾“å‡ºä¸¤ä¸ªæ ‡ç­¾ï¼š**

1. **FIRST**: <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. **SECOND**: <infobar_data><!--æ“ä½œæŒ‡ä»¤æ ¼å¼æ•°æ®--></infobar_data>

âœ… **æ“ä½œæŒ‡ä»¤æ ¼å¼ç¤ºä¾‹ï¼ˆå”¯ä¸€æ­£ç¡®æ ¼å¼ï¼‰**ï¼š
<infobar_data>
<!--
add personal(1 {"1","å¼ å‡¡","2","25","3","ç”·","4","å·¥ç¨‹å¸ˆ","5","ä¸“æ³¨å·¥ä½œ"})
add world(1 {"1","ç°ä»£éƒ½å¸‚","2","ç°å®ä¸–ç•Œ","3","2024å¹´ä¸‹åˆ","4","åŠå…¬å®¤","5","ç¹å¿™"})
add interaction(1 {"1","å°é›¨","2","åŒäº‹","3","å‹å¥½","4","è®¨è®ºé¡¹ç›®","5","åˆä½œ"})
-->
</infobar_data>

ğŸš¨ **ä¸¥æ ¼è¦æ±‚**ï¼š
1. å¿…é¡»å…ˆè¾“å‡ºaiThinkProcessï¼Œå†è¾“å‡ºinfobar_data
2. å†…å®¹å¿…é¡»åœ¨ <!-- --> æ³¨é‡Šä¸­
3. å¿…é¡»ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼šadd/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
4. ç»å¯¹ç¦æ­¢ä½¿ç”¨è¡¨æ ¼æ ¼å¼ | ç¬¦å·
5. ç»å¯¹ç¦æ­¢ä½¿ç”¨### æ ‡é¢˜æ ¼å¼
6. interactioné¢æ¿å¿…é¡»ä½¿ç”¨npc0.å‰ç¼€æ ¼å¼`;
    }

    /**
     * å‘é€è‡ªå®šä¹‰APIè¯·æ±‚
     * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
     * @param {Object} options - é€‰é¡¹é…ç½®
     * @param {boolean} options.skipSystemPrompt - æ˜¯å¦è·³è¿‡ç³»ç»Ÿæç¤ºè¯æ·»åŠ ï¼ˆç”¨äºæ€»ç»“ç­‰åœºæ™¯ï¼‰
     */
    async sendCustomAPIRequest(messages, options = {}) {
        try {
            console.log('[InfoBarSettings] ğŸ“¡ å‘é€è‡ªå®šä¹‰APIè¯·æ±‚...');

            // ğŸ”§ è·å–APIé…ç½®ï¼šä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„é…ç½®ï¼Œå¦åˆ™ä»æ‰©å±•è®¾ç½®è·å–
            let apiConfig;
            if (options.apiConfig) {
                console.log('[InfoBarSettings] ğŸ”§ ä½¿ç”¨ä¼ é€’çš„APIé…ç½®ï¼ˆæ€»ç»“æ¨¡å¼ï¼‰');
                apiConfig = options.apiConfig;
                console.log('[InfoBarSettings] ğŸ“Š ä¼ é€’çš„APIé…ç½®è¯¦æƒ…:', {
                    provider: apiConfig.provider,
                    model: apiConfig.model,
                    baseUrl: apiConfig.baseUrl,
                    endpoint: apiConfig.endpoint,
                    format: apiConfig.format,
                    maxTokens: apiConfig.maxTokens,
                    temperature: apiConfig.temperature,
                    hasApiKey: !!apiConfig.apiKey
                });
            } else {
                console.log('[InfoBarSettings] ğŸ“Š ä½¿ç”¨æ‰©å±•è®¾ç½®çš„APIé…ç½®');
                const context = SillyTavern.getContext();
                const extensionSettings = context.extensionSettings;
                apiConfig = extensionSettings['Information bar integration tool']?.apiConfig || {};
            }

            if (!apiConfig.provider || !apiConfig.model || !apiConfig.apiKey) {
                throw new Error('APIé…ç½®ä¸å®Œæ•´');
            }

            let enhancedMessages;
            if (options.skipSystemPrompt) {
                console.log('[InfoBarSettings] â­ï¸ è·³è¿‡ç³»ç»Ÿæç¤ºè¯æ·»åŠ ï¼ˆæ€»ç»“æ¨¡å¼ï¼‰');
                enhancedMessages = messages;
            } else {
                // ğŸ”§ ä¿®å¤ï¼šä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯ï¼Œç¡®ä¿è¾“å‡ºæ­£ç¡®çš„ä¸­æ–‡æ ¼å¼å’Œäº”æ­¥åˆ†æ
                console.log('[InfoBarSettings] ğŸ”§ ä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯...');
                enhancedMessages = await this.enhanceMessagesWithSystemPrompt(messages);
            }

            // æ ¹æ®æä¾›å•†å’Œæ¥å£ç±»å‹å‘é€è¯·æ±‚
            if (apiConfig.provider === 'gemini' && apiConfig.format === 'native') {
                return await this.sendGeminiNativeRequest(enhancedMessages, apiConfig, options);
            } else if (apiConfig.provider === 'localproxy') {
                return await this.sendLocalProxyRequest(enhancedMessages, apiConfig);
            } else {
                return await this.sendOpenAICompatibleRequest(enhancedMessages, apiConfig);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å‘é€è‡ªå®šä¹‰APIè¯·æ±‚å¤±è´¥:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šä¸ºè‡ªå®šä¹‰APIæ¶ˆæ¯æ·»åŠ ç³»ç»Ÿæç¤ºè¯
     * ç¡®ä¿è‡ªå®šä¹‰APIèƒ½å¤Ÿè¾“å‡ºæ­£ç¡®çš„ä¸­æ–‡æ ¼å¼å’Œäº”æ­¥åˆ†æ
     */
    async enhanceMessagesWithSystemPrompt(messages) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ ä¸ºè‡ªå®šä¹‰APIæ·»åŠ ç³»ç»Ÿæç¤ºè¯...');

            // ç”Ÿæˆè‡ªå®šä¹‰APIä¸“ç”¨çš„ç³»ç»Ÿæç¤ºè¯
            const systemPrompt = await this.generateCustomAPISystemPrompt();

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç³»ç»Ÿæ¶ˆæ¯
            const hasSystemMessage = messages.some(msg => msg.role === 'system');

            if (hasSystemMessage) {
                // å¦‚æœå·²æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œå°†æ–°çš„ç³»ç»Ÿæç¤ºè¯åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯ä¸­
                const systemMessageIndex = messages.findIndex(msg => msg.role === 'system');
                const existingSystemContent = messages[systemMessageIndex].content;
                messages[systemMessageIndex].content = systemPrompt + '\n\n' + existingSystemContent;
                console.log('[InfoBarSettings] ğŸ”§ å·²åˆå¹¶ç³»ç»Ÿæç¤ºè¯åˆ°ç°æœ‰ç³»ç»Ÿæ¶ˆæ¯');
            } else {
                // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œåœ¨å¼€å¤´æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                messages.unshift({
                    role: 'system',
                    content: systemPrompt
                });
                console.log('[InfoBarSettings] ğŸ”§ å·²æ·»åŠ æ–°çš„ç³»ç»Ÿæ¶ˆæ¯');
            }

            // ğŸ”§ æ–°å¢ï¼šåœ¨ç”¨æˆ·æ¶ˆæ¯æœ«å°¾æ·»åŠ æ ¼å¼æé†’ï¼Œç¡®ä¿è¾“å‡ºæ­£ç¡®æ ¼å¼
            const lastUserMessageIndex = messages.map(msg => msg.role).lastIndexOf('user');
            if (lastUserMessageIndex !== -1) {
                const formatReminder = `

ğŸš¨ğŸš¨ğŸš¨ **CRITICAL REMINDER: å¿…é¡»è¾“å‡ºä»¥ä¸‹ä¸¤ä¸ªæ ‡ç­¾** ğŸš¨ğŸš¨ğŸš¨
1. <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. <infobar_data><!--é¢æ¿æ•°æ®--></infobar_data>
âš ï¸ **ä¸¥ç¦é¢ å€’é¡ºåºï¼ä¸¥ç¦å†…å®¹ä¸è¢«æ³¨é‡Šç¬¦å·åŒ…è£¹ï¼**`;

                messages[lastUserMessageIndex].content += formatReminder;
                console.log('[InfoBarSettings] ğŸ”¥ å·²åœ¨ç”¨æˆ·æ¶ˆæ¯æœ«å°¾æ·»åŠ æ ¼å¼æé†’');
            }

            console.log('[InfoBarSettings] âœ… ç³»ç»Ÿæç¤ºè¯å¢å¼ºå®Œæˆï¼Œæ¶ˆæ¯æ•°é‡:', messages.length);
            return messages;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¢å¼ºæ¶ˆæ¯å¤±è´¥:', error);
            // å¦‚æœå¢å¼ºå¤±è´¥ï¼Œè¿”å›åŸå§‹æ¶ˆæ¯
            return messages;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç”Ÿæˆè‡ªå®šä¹‰APIä¸“ç”¨çš„ç³»ç»Ÿæç¤ºè¯
     * åŒ…å«äº”æ­¥åˆ†æã€ä¸­æ–‡æ ¼å¼ã€å¢é‡æ›´æ–°ç­‰å®Œæ•´è¦æ±‚
     */
    async generateCustomAPISystemPrompt() {
        try {
            console.log('[InfoBarSettings] ğŸ“ ç”Ÿæˆè‡ªå®šä¹‰APIç³»ç»Ÿæç¤ºè¯...');

            // è·å–å½“å‰å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanelsInfo = await this.getEnabledPanelsInfo();

            // è·å–å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç”¨äºå¢é‡æ›´æ–°åˆ¤æ–­ï¼‰
            const currentDataInfo = await this.getCurrentDataInfo();

            // ğŸ”§ é‡è¦ä¿®å¤ï¼šç¡®ä¿æ™ºèƒ½æç¤ºè¯è¢«å¼ºåŒ–ç½®äºç³»ç»Ÿæ¶ˆæ¯æœ€å‰é¢
            console.log('[InfoBarSettings] ğŸ”¥ å·²å°†å¼ºåŒ–æ ¼å¼çº¦æŸç½®äºç³»ç»Ÿæ¶ˆæ¯æœ€å‰é¢');
            console.log('[InfoBarSettings] ğŸ§  æ™ºèƒ½æç¤ºè¯å³å°†æ³¨å…¥ï¼Œé•¿åº¦:', enabledPanelsInfo.length);

            // æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ï¼Œæ™ºèƒ½æç¤ºè¯æ”¾åœ¨æœ€å‰é¢
            const systemPrompt = `${enabledPanelsInfo}

ğŸš¨ã€ä¿¡æ¯æ æ•°æ®æ ¼å¼è§„èŒƒ - è‡ªå®šä¹‰APIä¸“ç”¨ã€‘ğŸš¨

ğŸŒŸ **é‡è¦è¯´æ˜ï¼šæ‚¨æ­£åœ¨ä½¿ç”¨è‡ªå®šä¹‰APIæ¨¡å¼å¤„ç†ä¿¡æ¯æ æ•°æ®** ğŸŒŸ

ğŸš¨ **ä¸¥ç¦ç”Ÿæˆå‰§æƒ…å†…å®¹ï¼åªèƒ½è¾“å‡ºæ•°æ®åˆ†æå’Œé¢æ¿æ•°æ®ï¼** ğŸš¨

ğŸ“‹ **æ ¸å¿ƒè¾“å‡ºè¦æ±‚**ï¼š
**ğŸš¨ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¾“å‡ºï¼Œä¸¥ç¦é¢ å€’ ğŸš¨**

**ç¬¬ä¸€æ­¥ï¼šå¿…é¡»å…ˆè¾“å‡ºäº”æ­¥åˆ†ææ€è€ƒ**
<aiThinkProcess>
<!--
[è¾“å‡ºæ¨¡å¼: è‡ªå®šä¹‰API]

äº”æ­¥åˆ†æè¿‡ç¨‹ï¼š
0. æ›´æ–°ç­–ç•¥: æ ¹æ®ç°æœ‰æ•°æ®åˆ¤æ–­æ˜¯å…¨é‡æ›´æ–°è¿˜æ˜¯å¢é‡æ›´æ–°
1. å‰§æƒ…åˆ†æï¼šå½“å‰å‘ç”Ÿä»€ä¹ˆäº‹ä»¶ï¼Ÿè§’è‰²åœ¨å“ªé‡Œï¼Ÿåœ¨åšä»€ä¹ˆï¼Ÿ
2. æ•°æ®å˜åŒ–è¯†åˆ«ï¼šå“ªäº›ä¿¡æ¯å‘ç”Ÿäº†å˜åŒ–ï¼Ÿå“ªäº›æ˜¯æ–°ä¿¡æ¯ï¼Ÿ
3. æ›´æ–°ç­–ç•¥åˆ¤æ–­ï¼šéœ€è¦æ–°å¢å“ªäº›å­—æ®µï¼Ÿéœ€è¦æ›´æ–°å“ªäº›å­—æ®µï¼Ÿå“ªäº›ä¿æŒä¸å˜ï¼Ÿ
4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰å¯ç”¨é¢æ¿éƒ½æœ‰å®Œæ•´æ•°æ®
5. è´¨é‡éªŒè¯ï¼šç¡®è®¤æ•°æ®é€»è¾‘ä¸€è‡´æ€§å’Œåˆç†æ€§
-->
</aiThinkProcess>

**ç¬¬äºŒæ­¥ï¼šå¿…é¡»åè¾“å‡ºé¢æ¿æ•°æ®**
<infobar_data>
<!--
[æ ¹æ®ä¸Šè¿°äº”æ­¥åˆ†æï¼Œè¾“å‡ºå…·ä½“çš„é¢æ¿æ•°æ®ï¼Œä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼]
[é¢æ¿æ•°æ®åŸºäºä¸Šæ–¹çš„æ™ºèƒ½æç¤ºè¯æ¨¡æ¿ç”Ÿæˆ]
-->
</infobar_data>

ğŸš¨ **å¼ºåˆ¶æ ¼å¼è¦æ±‚** ğŸš¨ï¼š
1. **è¾“å‡ºé¡ºåº**ï¼šå¿…é¡»å…ˆè¾“å‡º <aiThinkProcess>ï¼Œå†è¾“å‡º <infobar_data>
2. **æ³¨é‡ŠåŒ…è£¹**ï¼šæ‰€æœ‰å†…å®¹å¿…é¡»è¢« <!--  --> åŒ…è£¹
3. **ä¸­æ–‡è¾“å‡º**ï¼šæ‰€æœ‰å†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼ŒåŒ…æ‹¬åˆ†æè¿‡ç¨‹å’Œæ•°æ®å€¼
4. **æ“ä½œæŒ‡ä»¤æ ¼å¼**ï¼šé¢æ¿æ•°æ®ä½¿ç”¨æ ¼å¼ add/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
5. **å…·ä½“æ•°æ®**ï¼šé¿å…ä½¿ç”¨"æœªçŸ¥"ã€"N/A"ç­‰å ä½ç¬¦ï¼Œç”Ÿæˆå…·ä½“å†…å®¹

${currentDataInfo}

ğŸ“‹ **æ•°æ®æ ¼å¼ç¤ºä¾‹**ï¼š
<aiThinkProcess>
<!--
[è¾“å‡ºæ¨¡å¼: è‡ªå®šä¹‰API]

äº”æ­¥åˆ†æè¿‡ç¨‹ï¼š
0. æ›´æ–°ç­–ç•¥: å¢é‡æ›´æ–°
1. å‰§æƒ…åˆ†æï¼šå¼ ä¸‰æ­£åœ¨ç°ä»£éƒ½å¸‚çš„åŠå…¬å®¤é‡Œå·¥ä½œï¼Œå¤„ç†ç¼–ç¨‹ä»»åŠ¡
2. æ•°æ®å˜åŒ–è¯†åˆ«ï¼šä½ç½®ä»å®¶é‡Œå˜ä¸ºåŠå…¬å®¤ï¼ŒçŠ¶æ€ä»ä¼‘æ¯å˜ä¸ºå·¥ä½œï¼Œæ–°å¢äº†ä»»åŠ¡ä¿¡æ¯
3. æ›´æ–°ç­–ç•¥åˆ¤æ–­ï¼šéœ€è¦æ›´æ–°locationä¸º"åŠå…¬å®¤"ï¼Œoccupationä¿æŒ"ç¨‹åºå‘˜"ï¼Œæ–°å¢tasksç›¸å…³å­—æ®µ
4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼špersonalã€worldã€tasksé¢æ¿éƒ½æœ‰å®Œæ•´æ•°æ®
5. è´¨é‡éªŒè¯ï¼šæ•°æ®ä¸å½“å‰å‰§æƒ…ä¸€è‡´ï¼Œå¼ ä¸‰ä½œä¸ºç¨‹åºå‘˜åœ¨åŠå…¬å®¤å·¥ä½œç¬¦åˆé€»è¾‘
-->
</aiThinkProcess>

<infobar_data>
<!--
add personal(1 {"1","å¼ ä¸‰","2","25","3","ç¨‹åºå‘˜","4","åŠå…¬å®¤","5","å·¥ä½œä¸­"})
add world(1 {"1","ç°ä»£éƒ½å¸‚","2","éƒ½å¸‚","3","2024å¹´","4","åŠå…¬å¤§æ¥¼"})
add interaction(1 {"1","ææ–‡é™","2","åŒäº‹","3","å‹å¥½","4","åˆä½œä¼™ä¼´","5","è®¨è®ºé¡¹ç›®"})
add tasks(1 {"1","æ–°ä»»åŠ¡åˆ›å»º","2","ä»»åŠ¡ç¼–è¾‘ä¸­","3","è¿›è¡Œä¸­"})
-->
</infobar_data>

ğŸš¨ğŸš¨ğŸš¨ **CRITICAL: æ“ä½œæŒ‡ä»¤æ ¼å¼å¼ºåˆ¶è¦æ±‚** ğŸš¨ğŸš¨ğŸš¨
ğŸ”´ **æ‰€æœ‰é¢æ¿å¿…é¡»ä½¿ç”¨æ“ä½œæŒ‡ä»¤æ ¼å¼ï¼**
ğŸ”´ **é”™è¯¯æ ¼å¼å°†å¯¼è‡´ç³»ç»Ÿå®Œå…¨æ‹’ç»ï¼Œä¸ä¼šæœ‰ä»»ä½•å…¼å®¹æ€§å¤„ç†ï¼**
ğŸ”´ **æ­£ç¡®: add interaction(1 {"1","æ±Ÿç³","2","æœ‹å‹","3","å‹å¥½"})**
ğŸ”´ **é”™è¯¯: interaction: npc0.name="æ±Ÿç³", npc0.type="æœ‹å‹" â† æ—§æ ¼å¼ï¼Œç³»ç»Ÿæ‹’ç»ï¼**

âš ï¸ **ä¸¥ç¦æ ¼å¼é”™è¯¯**ï¼š
âŒ é”™è¯¯ï¼š<aiThinkProcess>å†…å®¹ä¸è¢«æ³¨é‡ŠåŒ…è£¹</aiThinkProcess>
âŒ é”™è¯¯ï¼šå…ˆè¾“å‡ºinfobar_dataå†è¾“å‡ºaiThinkProcess
âŒ é”™è¯¯ï¼šä½¿ç”¨è‹±æ–‡å†…å®¹æˆ–å ä½ç¬¦
âŒ é”™è¯¯ï¼šinteractioné¢æ¿ä¸ä½¿ç”¨npcå‰ç¼€ â† ç³»ç»Ÿå´©æºƒï¼

ğŸš¨ğŸš¨ğŸš¨ **ä¸¥ç¦ç”Ÿæˆä»»ä½•å‰§æƒ…å†…å®¹ï¼** ğŸš¨ğŸš¨ğŸš¨
âŒ **ä¸¥ç¦è¾“å‡ºä»»ä½•æ•…äº‹æƒ…èŠ‚ã€å¯¹è¯ã€åœºæ™¯æè¿°**
âŒ **ä¸¥ç¦è¾“å‡ºä»»ä½•å™è¿°æ€§æ–‡å­—**
âŒ **åªèƒ½è¾“å‡ºæ•°æ®åˆ†æå’ŒXMLæ ¼å¼çš„é¢æ¿æ•°æ®**
âŒ **ä¸è¦å†™"å¼ å‡¡ç”¨æ‰‹æŠ¹å»èº«ä¸Šçš„æ°´ç "è¿™ç±»å‰§æƒ…å†…å®¹**

âœ… **å¿…é¡»ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ€è€ƒå’Œæ•°æ®ç”Ÿæˆ**
âœ… **å¿…é¡»åŸºäºå…·ä½“å‰§æƒ…ç”ŸæˆçœŸå®æ•°æ®**
âœ… **å¿…é¡»éµå¾ªä¸Šè¿°è¾“å‡ºé¡ºåºå’Œæ ¼å¼è¦æ±‚**
âœ… **interactioné¢æ¿å¿…é¡»ä½¿ç”¨npc0.å‰ç¼€æ ¼å¼**
âœ… **åªè¾“å‡ºæ•°æ®åˆ†æå’Œé¢æ¿æ•°æ®ï¼Œç»ä¸è¾“å‡ºå‰§æƒ…å†…å®¹**`;

            console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰APIç³»ç»Ÿæç¤ºè¯ç”Ÿæˆå®Œæˆ');
            return systemPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆç³»ç»Ÿæç¤ºè¯å¤±è´¥:', error);
            // è¿”å›åŸºç¡€ç³»ç»Ÿæç¤ºè¯
            return this.getBasicCustomAPISystemPrompt();
        }
    }

    /**
     * ğŸ”§ ä¿®å¤ï¼šè·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯ï¼ˆç”¨äºç³»ç»Ÿæç¤ºè¯ï¼‰
     */
    async getEnabledPanelsInfo() {
        try {
            console.log('[InfoBarSettings] ğŸ§  è·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯...');

            // ğŸš¨ å…³é”®ä¿®å¤ï¼šç›´æ¥è°ƒç”¨SmartPromptSystemçš„generateSmartPromptæ–¹æ³•
            // è¿™æ ·å¯ä»¥è·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯ï¼Œè€Œä¸æ˜¯ç®€çŸ­çš„é¢æ¿æ¦‚è¿°
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemä¸å¯ç”¨');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            // æ£€æŸ¥SmartPromptSystemæ˜¯å¦å·²åˆå§‹åŒ–
            if (!smartPromptSystem.initialized) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªåˆå§‹åŒ–');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            // ğŸš€ å…³é”®ï¼šè°ƒç”¨generateSmartPromptè·å–å®Œæ•´çš„æ™ºèƒ½æç¤ºè¯
            const fullSmartPrompt = await smartPromptSystem.generateSmartPrompt();
            if (!fullSmartPrompt || fullSmartPrompt.length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemè¿”å›ç©ºçš„æ™ºèƒ½æç¤ºè¯');
                return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
            }

            console.log(`[InfoBarSettings] âœ… æˆåŠŸè·å–å®Œæ•´æ™ºèƒ½æç¤ºè¯ï¼Œé•¿åº¦: ${fullSmartPrompt.length} å­—ç¬¦`);

            // ğŸ”§ æ–°å¢ï¼šå¼ºåŒ–æ™ºèƒ½æç¤ºè¯æ—¥å¿—ï¼Œç¡®ä¿å¯ä»¥çœ‹åˆ°æ™ºèƒ½æç¤ºè¯æ˜¯å¦æ­£ç¡®è·å–
            console.log('[InfoBarSettings] ğŸ§  è·å–åˆ°æ™ºèƒ½æç¤ºè¯ï¼Œé•¿åº¦:', fullSmartPrompt.length);
            console.log('[InfoBarSettings] ğŸ§  æ™ºèƒ½æç¤ºè¯å‰200å­—ç¬¦é¢„è§ˆ:', fullSmartPrompt.substring(0, 200));

            return fullSmartPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å®Œæ•´æ™ºèƒ½æç¤ºè¯å¤±è´¥:', error);
            return 'è¯·æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢æ¿ç”Ÿæˆå¯¹åº”æ•°æ®';
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–å½“å‰æ•°æ®ä¿¡æ¯ï¼ˆç”¨äºå¢é‡æ›´æ–°åˆ¤æ–­ï¼‰
     */
    async getCurrentDataInfo() {
        try {
            // è·å–SmartPromptSystemæ¥è·å–å½“å‰æ•°æ®çŠ¶æ€
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                return '';
            }

            const enabledPanels = await smartPromptSystem.getEnabledPanels();
            if (!enabledPanels || enabledPanels.length === 0) {
                return '';
            }

            const currentPanelData = await smartPromptSystem.getCurrentPanelData(enabledPanels);
            const updateStrategy = await smartPromptSystem.analyzeUpdateStrategy(enabledPanels, currentPanelData);

            let dataInfo = `\nğŸ“Š **å½“å‰æ•°æ®çŠ¶æ€**ï¼š\n`;
            dataInfo += `- æ•°æ®è¦†ç›–ç‡: ${updateStrategy.dataPercentage}%\n`;
            dataInfo += `- å»ºè®®ç­–ç•¥: ${updateStrategy.type === 'full' ? 'å…¨é‡æ›´æ–°' : 'å¢é‡æ›´æ–°'}\n`;
            dataInfo += `- å¯ç”¨é¢æ¿: ${enabledPanels.length}ä¸ª\n\n`;

            if (Object.keys(currentPanelData).length > 0) {
                dataInfo += `**ç°æœ‰æ•°æ®æ¦‚è§ˆ**ï¼š\n`;
                for (const [panelKey, panelData] of Object.entries(currentPanelData)) {
                    const fieldCount = Object.keys(panelData).length;
                    dataInfo += `- ${panelKey}: ${fieldCount}ä¸ªå­—æ®µå·²æœ‰æ•°æ®\n`;
                }
                dataInfo += '\n**å¢é‡æ›´æ–°æŒ‡å¯¼**ï¼šåªè¾“å‡ºå‘ç”Ÿå˜åŒ–æˆ–æ–°å¢çš„å­—æ®µæ•°æ®\n';
            } else {
                dataInfo += `**å…¨é‡æ›´æ–°æŒ‡å¯¼**ï¼šç”Ÿæˆæ‰€æœ‰å¯ç”¨é¢æ¿çš„å®Œæ•´æ•°æ®\n`;
            }

            return dataInfo;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–åŸºç¡€ç³»ç»Ÿæç¤ºè¯ï¼ˆå¤‡ç”¨ï¼‰
     */
    getBasicCustomAPISystemPrompt() {
        return `ğŸš¨ã€ä¿¡æ¯æ æ•°æ®æ ¼å¼è§„èŒƒ - è‡ªå®šä¹‰APIã€‘ğŸš¨

**å¿…é¡»è¾“å‡ºæ ¼å¼**ï¼š
1. å…ˆè¾“å‡º: <aiThinkProcess><!--äº”æ­¥åˆ†ææ€è€ƒ--></aiThinkProcess>
2. å†è¾“å‡º: <infobar_data><!--é¢æ¿æ•°æ®--></infobar_data>

**æ ¼å¼è¦æ±‚**ï¼š
- ä½¿ç”¨ä¸­æ–‡è¿›è¡Œåˆ†æå’Œæ•°æ®ç”Ÿæˆ
- å†…å®¹å¿…é¡»è¢« <!--  --> åŒ…è£¹
- æ•°æ®æ ¼å¼: add/update é¢æ¿å(è¡Œå· {"åˆ—å·","å€¼",...})
- é¿å…ä½¿ç”¨å ä½ç¬¦ï¼Œç”Ÿæˆå…·ä½“å†…å®¹

**ä¸¥ç¦é¢ å€’è¾“å‡ºé¡ºåºæˆ–çœç•¥ä»»ä½•æ ‡ç­¾**`;
    }

    /**
     * è·å–SmartPromptSystemçš„æ™ºèƒ½æç¤ºè¯
     */
    async getSmartPromptSystemPrompt() {
        try {
            console.log('[InfoBarSettings] ğŸ§  è·å–SmartPromptSystemæ™ºèƒ½æç¤ºè¯...');

            // è·å–SmartPromptSystemå®ä¾‹
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (!smartPromptSystem) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªæ‰¾åˆ°');
                return '';
            }

            // æ£€æŸ¥SmartPromptSystemæ˜¯å¦å·²åˆå§‹åŒ–
            if (!smartPromptSystem.initialized) {
                console.warn('[InfoBarSettings] âš ï¸ SmartPromptSystemæœªåˆå§‹åŒ–');
                return '';
            }

            // ç”Ÿæˆæ™ºèƒ½æç¤ºè¯
            const smartPrompt = await smartPromptSystem.generateSmartPrompt();
            if (!smartPrompt || smartPrompt.length === 0) {
                console.log('[InfoBarSettings] ğŸ“ SmartPromptSystemè¿”å›ç©ºæç¤ºè¯');
                return '';
            }

            console.log('[InfoBarSettings] âœ… æˆåŠŸè·å–æ™ºèƒ½æç¤ºè¯ï¼Œé•¿åº¦:', smartPrompt.length);
            return smartPrompt;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–æ™ºèƒ½æç¤ºè¯å¤±è´¥:', error);
            return '';
        }
    }

    /**
     * å‘é€æœ¬åœ°åä»£è¯·æ±‚ (é€šè¿‡SillyTavernåç«¯)
     */
    async sendLocalProxyRequest(messages, apiConfig) {
        try {
            console.log('[InfoBarSettings] ğŸš€ å‘é€æœ¬åœ°åä»£è¯·æ±‚...');

            // ğŸš¨ é‡è¦ä¿®å¤ï¼šæœ¬åœ°åä»£ä¸éœ€è¦é‡å¤æ·»åŠ æ™ºèƒ½æç¤ºè¯ï¼
            // å› ä¸ºæ¶ˆæ¯å·²ç»é€šè¿‡enhanceMessagesWithSystemPromptæ–¹æ³•æ·»åŠ äº†æ­£ç¡®çš„ç³»ç»Ÿæç¤ºè¯
            console.log('[InfoBarSettings] â„¹ï¸ æœ¬åœ°åä»£ä½¿ç”¨å·²å¢å¼ºçš„æ¶ˆæ¯ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºè¯ï¼‰');

            // è·å–CSRFä»¤ç‰Œ
            const csrfResponse = await fetch('/csrf-token');
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // æ„å»ºç”Ÿæˆè¯·æ±‚
            const generateUrl = `${window.location.origin}/api/backends/chat-completions/generate`;
            const requestBody = {
                messages: messages,
                model: apiConfig.model,
                temperature: apiConfig.temperature || 0.7,
                frequency_penalty: 0,
                presence_penalty: 0.12,
                top_p: 1.0,
                max_tokens: apiConfig.maxTokens || 2000,
                stream: false,
                chat_completion_source: "custom",
                custom_url: apiConfig.endpoint || apiConfig.baseUrl,
                custom_include_headers: "",
                group_names: [],
                include_reasoning: false,
                reasoning_effort: "medium",
                enable_web_search: false,
                request_images: false,
                custom_prompt_post_processing: "strict",
                reverse_proxy: apiConfig.endpoint || apiConfig.baseUrl,
                proxy_password: apiConfig.apiKey
            };

            console.log('[InfoBarSettings] ğŸ“ æœ¬åœ°åä»£è¯·æ±‚å‚æ•°:', {
                endpoint: generateUrl,
                model: requestBody.model,
                temperature: requestBody.temperature,
                max_tokens: requestBody.max_tokens,
                reverse_proxy: requestBody.reverse_proxy,
                hasPassword: !!requestBody.proxy_password,
                messagesCount: messages.length
            });

            const response = await fetch(generateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            });

            console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£å“åº”çŠ¶æ€:', response.status);

            // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥å“åº”å¤´ä¿¡æ¯ï¼Œå¸®åŠ©è¯Šæ–­é•¿åº¦é—®é¢˜
            const contentLength = response.headers.get('content-length');
            const contentType = response.headers.get('content-type');
            console.log('[InfoBarSettings] ğŸ“Š å“åº”å¤´ä¿¡æ¯:', {
                contentLength: contentLength,
                contentType: contentType,
                status: response.status,
                statusText: response.statusText
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¯·æ±‚å¤±è´¥:', response.status, errorText);
                throw new Error(`æœ¬åœ°åä»£APIé”™è¯¯: ${response.status} ${response.statusText} - ${errorText}`);
            }

            // ğŸ”§ å¢å¼ºå“åº”å¤„ç†ï¼šå…ˆè·å–åŸå§‹æ–‡æœ¬ï¼Œç„¶åè§£æJSON
            const rawResponseText = await response.text();
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”æ–‡æœ¬é•¿åº¦:', rawResponseText.length);
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”å‰500å­—ç¬¦:', rawResponseText.substring(0, 500));
            console.log('[InfoBarSettings] ğŸ“Š åŸå§‹å“åº”å500å­—ç¬¦:', rawResponseText.substring(Math.max(0, rawResponseText.length - 500)));

            let data;
            try {
                data = JSON.parse(rawResponseText);
                console.log('[InfoBarSettings] ğŸ“Š æœ¬åœ°åä»£å“åº”æ•°æ®è§£ææˆåŠŸ');
            } catch (parseError) {
                console.error('[InfoBarSettings] âŒ JSONè§£æå¤±è´¥:', parseError);
                console.error('[InfoBarSettings] âŒ åŸå§‹å“åº”å†…å®¹:', rawResponseText);
                throw new Error(`æœ¬åœ°åä»£å“åº”JSONè§£æå¤±è´¥: ${parseError.message}`);
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (data.error) {
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£APIé”™è¯¯:', data.error);
                const errorMessage = data.error.message || data.error.toString() || 'æœªçŸ¥é”™è¯¯';
                throw new Error(`æœ¬åœ°åä»£APIé”™è¯¯: ${errorMessage}`);
            }

            // ğŸ”§ å¢å¼ºå“åº”è§£æï¼šæ›´è¯¦ç»†çš„å†…å®¹æå–å’ŒéªŒè¯
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹è§£æç”Ÿæˆå†…å®¹...');
            console.log('[InfoBarSettings] ğŸ“Š å“åº”æ•°æ®ç»“æ„:', {
                hasChoices: !!data.choices,
                choicesLength: data.choices?.length || 0,
                firstChoice: data.choices?.[0] ? Object.keys(data.choices[0]) : 'none',
                hasMessage: !!(data.choices?.[0]?.message),
                messageKeys: data.choices?.[0]?.message ? Object.keys(data.choices[0].message) : 'none'
            });

            // è§£æå“åº” - å¤šç§æ ¼å¼å…¼å®¹
            let generatedText = '';

            if (data.choices && Array.isArray(data.choices) && data.choices.length > 0) {
                const choice = data.choices[0];

                if (choice.message && choice.message.content) {
                    generatedText = choice.message.content;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨message.contentæ ¼å¼æå–å†…å®¹');
                } else if (choice.text) {
                    generatedText = choice.text;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨textæ ¼å¼æå–å†…å®¹');
                } else if (choice.content) {
                    generatedText = choice.content;
                    console.log('[InfoBarSettings] âœ… ä½¿ç”¨contentæ ¼å¼æå–å†…å®¹');
                }
            } else if (data.content) {
                generatedText = data.content;
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨ç›´æ¥contentæ ¼å¼æå–å†…å®¹');
            } else if (data.text) {
                generatedText = data.text;
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨ç›´æ¥textæ ¼å¼æå–å†…å®¹');
            }

            if (!generatedText || generatedText.trim().length === 0) {
                console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¿”å›ç©ºå†…å®¹');
                console.error('[InfoBarSettings] âŒ å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
                throw new Error('æœ¬åœ°åä»£APIè¿”å›ç©ºå†…å®¹ï¼Œå¯èƒ½æ˜¯æ¨¡å‹ä¸å¯ç”¨æˆ–é…ç½®é”™è¯¯');
            }

            console.log(`[InfoBarSettings] âœ… æœ¬åœ°åä»£è¯·æ±‚æˆåŠŸï¼Œç”Ÿæˆå†…å®¹é•¿åº¦: ${generatedText.length} å­—ç¬¦`);
            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå†…å®¹å‰200å­—ç¬¦é¢„è§ˆ:', generatedText.substring(0, 200));
            console.log('[InfoBarSettings] ğŸ“Š ç”Ÿæˆå†…å®¹å200å­—ç¬¦é¢„è§ˆ:', generatedText.substring(Math.max(0, generatedText.length - 200)));

            return {
                success: true,
                text: generatedText,
                usage: data.usage
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æœ¬åœ°åä»£è¯·æ±‚å¼‚å¸¸:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * å‘é€GeminiåŸç”ŸAPIè¯·æ±‚
     */
    async sendGeminiNativeRequest(messages, apiConfig, options = {}) {
        console.log('[InfoBarSettings] ğŸ”„ å‘é€GeminiåŸç”Ÿè¯·æ±‚...');

        const systemMessage = messages.find(m => m.role === 'system');
        const userMessage = messages.find(m => m.role === 'user');

        const prompt = systemMessage ? `${systemMessage.content}\n\n${userMessage.content}` : userMessage.content;

        // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®ä½¿ç”¨åœºæ™¯åŠ¨æ€è®¾ç½®maxOutputTokens
        // æ€»ç»“åŠŸèƒ½éœ€è¦æ›´å¤§çš„è¾“å‡ºä»¤ç‰Œæ•°ï¼Œæ™®é€šä¿¡æ¯æ è¯·æ±‚ä½¿ç”¨è¾ƒå°å€¼
        const isSummaryRequest = options?.skipSystemPrompt === true;
        const defaultMaxTokens = isSummaryRequest ? 8000 : 2000;  // æ€»ç»“è¯·æ±‚ä½¿ç”¨8000ï¼Œæ™®é€šè¯·æ±‚ä½¿ç”¨2000

        const requestBody = {
            contents: [{
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                temperature: apiConfig.temperature || 0.7,
                maxOutputTokens: apiConfig.maxTokens || defaultMaxTokens
            }
        };

        console.log('[InfoBarSettings] ğŸ”§ APIè¯·æ±‚é…ç½®:', {
            isSummaryRequest,
            maxOutputTokens: requestBody.generationConfig.maxOutputTokens,
            temperature: requestBody.generationConfig.temperature,
            promptLength: prompt.length
        });

        const requestUrl = `${apiConfig.baseUrl}/v1beta/models/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`;
        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', requestUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ GeminiåŸç”Ÿè¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®Gemini APIï¼Œè¯·æ£€æŸ¥åä»£é…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            // ğŸ”§ ç‰¹æ®Šå¤„ç†429å’Œ500é”™è¯¯
            if (response.status === 429) {
                // è·å–é‡è¯•å»ºè®®æ—¶é—´
                const retryAfter = response.headers.get('Retry-After') || 60;
                console.warn(`[InfoBarSettings] âš ï¸ 429é¢‘ç‡é™åˆ¶ï¼Œå»ºè®®${retryAfter}ç§’åé‡è¯•`);

                throw new Error(`APIè¯·æ±‚é¢‘ç‡è¿‡é«˜(429)ï¼Œè¯·ç­‰å¾…${retryAfter}ç§’åé‡è¯•ã€‚å»ºè®®è°ƒæ•´è¯·æ±‚é—´éš”æˆ–ç¨åå†è¯•ã€‚`);
            } else if (response.status === 500) {
                console.error('[InfoBarSettings] âŒ 500æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');

                // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                let errorDetail = '';
                try {
                    const errorData = await response.text();
                    errorDetail = errorData.substring(0, 200);
                    console.error('[InfoBarSettings] ğŸ“Š 500é”™è¯¯è¯¦æƒ…:', errorDetail);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–500é”™è¯¯è¯¦æƒ…');
                }

                throw new Error(`GeminiæœåŠ¡å™¨å†…éƒ¨é”™è¯¯(500)ï¼Œè¿™å¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ã€‚å»ºè®®ç¨åé‡è¯•ã€‚${errorDetail ? 'é”™è¯¯è¯¦æƒ…: ' + errorDetail : ''}`);
            } else {
                throw new Error(`Gemini APIé”™è¯¯: ${response.status} ${response.statusText}`);
            }
        }

        const data = await response.json();

        console.log('[InfoBarSettings] ğŸ” Gemini APIå“åº”æ•°æ®ç»“æ„:', JSON.stringify(data, null, 2));

        // ğŸ”§ æ”¹è¿›çš„å“åº”è§£æé€»è¾‘ï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„æ ¼å¼
        let extractedText = '';

        // å°è¯•æ ‡å‡†çš„Geminiå“åº”æ ¼å¼
        if (data.candidates && data.candidates[0]) {
            const candidate = data.candidates[0];
            console.log('[InfoBarSettings] ğŸ“Š å€™é€‰å“åº”ç»“æ„:', {
                hasContent: !!candidate.content,
                hasParts: !!(candidate.content?.parts),
                partsLength: candidate.content?.parts?.length || 0,
                hasText: !!candidate.text,
                hasOutput: !!candidate.output
            });

            if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                extractedText = candidate.content.parts[0].text || '';
                console.log('[InfoBarSettings] âœ… ä»æ ‡å‡†è·¯å¾„æå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            } else if (candidate.text) {
                extractedText = candidate.text;
                console.log('[InfoBarSettings] âœ… ä»candidate.textæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            } else if (candidate.output) {
                extractedText = candidate.output;
                console.log('[InfoBarSettings] âœ… ä»candidate.outputæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
            }
        }

        // å¦‚æœæ ‡å‡†è·¯å¾„å¤±è´¥ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„æ ¼å¼
        if (!extractedText && data.text) {
            extractedText = data.text;
            console.log('[InfoBarSettings] âœ… ä»data.textæå–æ–‡æœ¬ï¼Œé•¿åº¦:', extractedText.length);
        }

        // æœ€åå°è¯•ä»æ•´ä¸ªå“åº”ä¸­æŸ¥æ‰¾æ–‡æœ¬å†…å®¹
        if (!extractedText) {
            console.warn('[InfoBarSettings] âš ï¸ æ— æ³•ä»æ ‡å‡†è·¯å¾„æå–æ–‡æœ¬ï¼Œå°è¯•æ·±åº¦æœç´¢...');

            // é€’å½’æœç´¢æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬å†…å®¹çš„å­—æ®µ
            const searchForText = (obj, path = '') => {
                if (typeof obj === 'string' && obj.trim() && obj.length > 20) {
                    console.log(`[InfoBarSettings] ğŸ” æ‰¾åˆ°å¯èƒ½çš„æ–‡æœ¬å†…å®¹: ${path} (é•¿åº¦: ${obj.length})`);
                    return obj;
                }
                if (typeof obj === 'object' && obj !== null) {
                    for (const [key, value] of Object.entries(obj)) {
                        if (key !== 'usage' && key !== 'usageMetadata') { // è·³è¿‡ä½¿ç”¨ç»Ÿè®¡
                            const result = searchForText(value, `${path}.${key}`);
                            if (result) return result;
                        }
                    }
                }
                return null;
            };

            extractedText = searchForText(data, 'data') || '';
        }

        if (!extractedText) {
            console.error('[InfoBarSettings] âŒ æ— æ³•ä»Geminiå“åº”ä¸­æå–ä»»ä½•æ–‡æœ¬å†…å®¹');
            console.error('[InfoBarSettings] ğŸ“Š å®Œæ•´å“åº”ç»“æ„keys:', Object.keys(data));
            console.error('[InfoBarSettings] ğŸ“Š å€™é€‰è€…è¯¦æƒ…:', data.candidates);

            // å¦‚æœå®Œå…¨æ²¡æœ‰æ–‡æœ¬å†…å®¹ï¼Œè¿”å›é”™è¯¯è€Œä¸æ˜¯ç©ºæ–‡æœ¬
            throw new Error('Gemini APIè¿”å›äº†ç©ºçš„æ–‡æœ¬å†…å®¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–æ¨¡å‹å“åº”');
        }

        return {
            success: true,
            text: extractedText.trim(),
            usage: data.usageMetadata || data.usage
        };
    }

    /**
     * å‘é€OpenAIå…¼å®¹APIè¯·æ±‚
     */
    async sendOpenAICompatibleRequest(messages, apiConfig) {
        console.log('[InfoBarSettings] ğŸ”„ å‘é€OpenAIå…¼å®¹è¯·æ±‚...');

        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿baseUrlå­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨fallback
        let baseUrl = apiConfig.baseUrl || apiConfig.endpoint;
        if (!baseUrl) {
            console.error('[InfoBarSettings] âŒ baseUrlå’Œendpointéƒ½æœªé…ç½®');
            throw new Error('APIåŸºç¡€URLæœªé…ç½®ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®');
        }

        // ğŸ”§ ç§»é™¤æœ«å°¾å¯èƒ½çš„è·¯å¾„éƒ¨åˆ†ï¼Œç¡®ä¿åªæœ‰åŸºç¡€URL
        if (baseUrl.endsWith('/chat/completions')) {
            baseUrl = baseUrl.replace('/chat/completions', '');
        }
        if (baseUrl.endsWith('/v1')) {
            baseUrl = baseUrl.replace('/v1', '');
        }

        const requestBody = {
            model: apiConfig.model,
            messages: messages,
            temperature: apiConfig.temperature || 0.7,
            max_tokens: apiConfig.maxTokens || 4000 // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ç¡¬ç¼–ç é™åˆ¶ï¼Œå®Œå…¨ä½¿ç”¨ç”¨æˆ·è®¾ç½®
        };

        console.log('[InfoBarSettings] ğŸ”§ APIè¯·æ±‚å‚æ•°:', {
            model: requestBody.model,
            temperature: requestBody.temperature,
            max_tokens: requestBody.max_tokens, // ğŸ”§ æ˜¾ç¤ºå®é™…ä½¿ç”¨çš„æœ€å¤§ä»¤ç‰Œæ•°
            messagesCount: messages.length,
            userConfiguredMaxTokens: apiConfig.maxTokens // ğŸ”§ æ˜¾ç¤ºç”¨æˆ·é…ç½®çš„ä»¤ç‰Œæ•°
        });

        const requestUrl = `${baseUrl}/v1/chat/completions`;
        console.log('[InfoBarSettings] ğŸŒ ä½¿ç”¨CORSå…¼å®¹è¯·æ±‚:', requestUrl);

        let response;
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨APIIntegrationçš„CORSå…¼å®¹fetchæ–¹æ³•
            if (this.apiIntegration && typeof this.apiIntegration.proxyCompatibleFetch === 'function') {
                console.log('[InfoBarSettings] âœ… ä½¿ç”¨CORSå…¼å®¹çš„fetchæ–¹æ³•');
                response = await this.apiIntegration.proxyCompatibleFetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIIntegrationä¸å¯ç”¨ï¼Œä½¿ç”¨åŸç”Ÿfetch');
                response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'User-Agent': 'SillyTavern-InfoBar/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
            }
        } catch (fetchError) {
            console.error('[InfoBarSettings] âŒ OpenAIå…¼å®¹è¯·æ±‚å¤±è´¥:', fetchError);

            // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯
            if (fetchError.message.includes('CORS_BLOCKED') ||
                fetchError.message.includes('CORS') ||
                (fetchError.name === 'TypeError' && fetchError.message.includes('fetch'))) {

                throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šæ— æ³•è®¿é—®åä»£APIï¼Œè¯·æ£€æŸ¥åä»£æœåŠ¡å™¨çš„CORSé…ç½®æˆ–ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†');
            }

            throw fetchError;
        }

        if (!response.ok) {
            // ğŸ”§ ä¸“é—¨å¤„ç†500æœåŠ¡å™¨é”™è¯¯
            if (response.status === 500) {
                let errorDetail = '';
                try {
                    const errorText = await response.text();
                    errorDetail = errorText.substring(0, 300);
                    console.error('[InfoBarSettings] âŒ 500æœåŠ¡å™¨é”™è¯¯è¯¦æƒ…:', errorDetail);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•è¯»å–500é”™è¯¯è¯¦æƒ…');
                }

                throw new Error(`åä»£æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500): å¯èƒ½æ˜¯ä»¥ä¸‹é—®é¢˜ä¹‹ä¸€ï¼š
1. åä»£é…ç½®é—®é¢˜ï¼š/v1/chat/completionsç«¯ç‚¹é…ç½®é”™è¯¯
2. åç«¯APIé—®é¢˜ï¼šä¸Šæ¸¸APIæœåŠ¡å¼‚å¸¸æˆ–é…é¢ä¸è¶³
3. è¯·æ±‚æ ¼å¼é—®é¢˜ï¼šåä»£æœåŠ¡å™¨ä¸æ”¯æŒå½“å‰è¯·æ±‚æ ¼å¼
4. è®¤è¯é—®é¢˜ï¼šåç«¯API Keyæ— æ•ˆæˆ–è¿‡æœŸ

æŠ€æœ¯è¯¦æƒ…: ${response.status} ${response.statusText}${errorDetail ? ' - ' + errorDetail : ''}

å»ºè®®æ£€æŸ¥åä»£æœåŠ¡å™¨æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚`);
            }

            throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        return {
            success: true,
            text: data.choices?.[0]?.message?.content || '',
            usage: data.usage
        };
    }

    /**
     * å¤„ç†APIç»“æœ
     */
    async processAPIResult(resultText) {
        try {
            console.log('[InfoBarSettings] ğŸ” å¼€å§‹å¤„ç†APIç»“æœ...');
            console.log('[InfoBarSettings] ğŸ“ ç»“æœå‰500å­—ç¬¦:', resultText.substring(0, 500));

            // è·å–APIé…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦å¯ç”¨åˆå¹¶æ¶ˆæ¯
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const apiConfig = extensionSettings['Information bar integration tool']?.apiConfig || {};
            const mergeMessages = apiConfig.mergeMessages !== undefined ? apiConfig.mergeMessages : true; // é»˜è®¤ä¸ºtrue

            if (mergeMessages) {
                console.log('[InfoBarSettings] ğŸ”„ åˆå¹¶æ¶ˆæ¯æ¨¡å¼ï¼šå°†APIæ•°æ®åˆå¹¶åˆ°AIæ¶ˆæ¯ä¸­');

                // ç¬¬ä¸€æ­¥ï¼šå°†infobar_dataåˆå¹¶åˆ°æœ€æ–°çš„AIæ¶ˆæ¯ä¸­
                const success = await this.appendInfobarDataToLatestMessage(resultText);
                if (!success) {
                    console.warn('[InfoBarSettings] âš ï¸ æ— æ³•å°†infobar_dataåˆå¹¶åˆ°æ¶ˆæ¯ä¸­');
                    return;
                }

                // ç¬¬äºŒæ­¥ï¼šè§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼Œè®©EventSystemå¤„ç†
                if (context && context.eventSource && context.chat && context.chat.length > 0) {
                    const lastMessage = context.chat[context.chat.length - 1];
                    if (lastMessage && !lastMessage.is_user) {
                        console.log('[InfoBarSettings] ğŸ“¡ è§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶è¿›è¡Œæ•°æ®è§£æ...');

                        // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿æ¶ˆæ¯å†…å®¹å·²ç»è¢«æ­£ç¡®æ›´æ–°
                        setTimeout(() => {
                            // é‡æ–°è·å–æœ€æ–°æ¶ˆæ¯ï¼Œç¡®ä¿è·å–åˆ°æ›´æ–°åçš„å†…å®¹
                            const updatedMessage = context.chat[context.chat.length - 1];
                            if (updatedMessage && !updatedMessage.is_user) {
                                console.log('[InfoBarSettings] ğŸ”„ å»¶è¿Ÿè§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ï¼Œç¡®ä¿æ•°æ®å·²æ›´æ–°');
                                console.log('[InfoBarSettings] ğŸ“Š æ¶ˆæ¯å†…å®¹é•¿åº¦:', updatedMessage.mes?.length || 0);
                                console.log('[InfoBarSettings] ğŸ” åŒ…å«infobar_data:', updatedMessage.mes?.includes('<infobar_data>') || false);
                                context.eventSource.emit('message_received', updatedMessage);
                            }
                        }, 100); // 100mså»¶è¿Ÿ
                    }
                }
            } else {
                console.log('[InfoBarSettings] ğŸš€ ç›´æ¥è§£ææ¨¡å¼ï¼šç›´æ¥å¤„ç†APIè¿”å›æ•°æ®');

                // ç›´æ¥è§£æAPIè¿”å›çš„æ•°æ®ï¼Œä¸åˆå¹¶åˆ°AIæ¶ˆæ¯
                await this.directParseAPIResult(resultText);
            }

            console.log('[InfoBarSettings] âœ… APIç»“æœå¤„ç†å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†APIç»“æœå¤±è´¥:', error);
        }
    }

    /**
     * ç›´æ¥è§£æAPIç»“æœï¼ˆä¸åˆå¹¶åˆ°AIæ¶ˆæ¯ï¼‰
     */
    async directParseAPIResult(resultText) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç›´æ¥è§£æAPIç»“æœ...');

            // è·å–æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (!smartPromptSystem || !smartPromptSystem.dataParser) {
                console.error('[InfoBarSettings] âŒ æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿæˆ–æ•°æ®è§£æå™¨æœªæ‰¾åˆ°');
                return;
            }

            // ç›´æ¥ä½¿ç”¨æ•°æ®è§£æå™¨è§£æAPIè¿”å›çš„æ•°æ®
            const parsedData = smartPromptSystem.dataParser.parseAIResponse(resultText);

            if (parsedData) {
                console.log('[InfoBarSettings] âœ… ç›´æ¥è§£ææˆåŠŸï¼Œæ•°æ®é¡¹æ•°é‡:', Object.keys(parsedData).length);

                // æ›´æ–°æ•°æ®åˆ°æ•°æ®æ ¸å¿ƒ
                await smartPromptSystem.updateDataCore(parsedData);

                // è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶
                if (smartPromptSystem.eventSystem) {
                    console.log('[InfoBarSettings] ğŸ“¡ è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶...');

                    // è§¦å‘æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿçš„æ•°æ®æ›´æ–°äº‹ä»¶
                    smartPromptSystem.eventSystem.emit('smart-prompt:data-updated', {
                        data: parsedData,
                        timestamp: Date.now(),
                        source: 'direct-api-parse' // æ ‡è®°æ•°æ®æ¥æº
                    });

                    // è§¦å‘ä¿¡æ¯æ æ¸²æŸ“å™¨çš„æ•°æ®æ›´æ–°äº‹ä»¶
                    smartPromptSystem.eventSystem.emit('data:updated', {
                        data: parsedData,
                        timestamp: Date.now(),
                        source: 'direct-api-parse' // æ ‡è®°æ•°æ®æ¥æº
                    });

                    console.log('[InfoBarSettings] âœ… æ•°æ®æ›´æ–°äº‹ä»¶å·²è§¦å‘');
                } else {
                    console.warn('[InfoBarSettings] âš ï¸ äº‹ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œæ— æ³•è§¦å‘æ•°æ®æ›´æ–°äº‹ä»¶');
                }

                console.log('[InfoBarSettings] âœ… ç›´æ¥è§£æå’Œæ•°æ®æ›´æ–°å®Œæˆ');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ ç›´æ¥è§£ææœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç›´æ¥è§£æAPIç»“æœå¤±è´¥:', error);
        }
    }

    /**
     * å°†infobar_dataè¿½åŠ åˆ°æœ€æ–°çš„AIæ¶ˆæ¯ä¸­
     */
    async appendInfobarDataToLatestMessage(infobarData) {
        try {
            console.log('[InfoBarSettings] ğŸ“ å°†infobar_dataè¿½åŠ åˆ°æœ€æ–°æ¶ˆæ¯...');

            const context = SillyTavern.getContext();
            if (!context || !context.chat || context.chat.length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ¶ˆæ¯');
                return false;
            }

            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const lastMessage = context.chat[context.chat.length - 1];
            if (!lastMessage || lastMessage.is_user) {
                console.warn('[InfoBarSettings] âš ï¸ æœ€æ–°æ¶ˆæ¯ä¸æ˜¯AIæ¶ˆæ¯');
                return false;
            }

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ç»åŒ…å«è‡ªå®šä¹‰APIæ•°æ®æ ‡ç­¾ï¼Œå¦‚æœæœ‰åˆ™æ›¿æ¢
            if (lastMessage.mes && (lastMessage.mes.includes('<infobar_data>') || lastMessage.mes.includes('<aiThinkProcess>'))) {
                console.log('[InfoBarSettings] â„¹ï¸ æ¶ˆæ¯å·²åŒ…å«APIæ•°æ®æ ‡ç­¾ï¼Œæ›¿æ¢ç°æœ‰å†…å®¹');
                // ç§»é™¤ç°æœ‰çš„APIæ•°æ®æ ‡ç­¾å†…å®¹
                lastMessage.mes = lastMessage.mes
                    .replace(/<infobar_data>[\s\S]*?<\/infobar_data>/gi, '')
                    .replace(/<aiThinkProcess>[\s\S]*?<\/aiThinkProcess>/gi, '')
                    .trim();
            }

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥å°†å®Œæ•´çš„APIè¿”å›æ•°æ®è¿½åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œä¸è¿›è¡Œæ‹†åˆ†
            // è‡ªå®šä¹‰APIè¿”å›çš„æ˜¯ä¸€æ¡å®Œæ•´çš„å“åº”ï¼ŒåŒ…å« <aiThinkProcess> å’Œ <infobar_data>
            // åº”è¯¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œè¯­ä¹‰è¿è´¯æ€§
            if (infobarData && infobarData.trim()) {
                console.log('[InfoBarSettings] ğŸ“ è¿½åŠ å®Œæ•´çš„APIè¿”å›æ•°æ®åˆ°æ¶ˆæ¯');
                lastMessage.mes = lastMessage.mes.trim() + '\n\n' + infobarData.trim();
            } else {
                console.warn('[InfoBarSettings] âš ï¸ APIè¿”å›æ•°æ®ä¸ºç©º');
                return false;
            }

            // ä¿å­˜èŠå¤©æ•°æ®
            if (context.saveChat) {
                await context.saveChat();
                console.log('[InfoBarSettings] ğŸ’¾ èŠå¤©æ•°æ®å·²ä¿å­˜');
            }

            console.log('[InfoBarSettings] âœ… infobar_dataå·²æˆåŠŸè¿½åŠ åˆ°æ¶ˆæ¯');
            return true;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿½åŠ infobar_dataåˆ°æ¶ˆæ¯å¤±è´¥:', error);
            return false;
        }
    }

    // æ³¨é‡Šï¼šextractAndMergeAPIResult å‡½æ•°å·²ç§»é™¤
    // åŸå› ï¼šè‡ªå®šä¹‰APIè¿”å›çš„æ˜¯å®Œæ•´å“åº”æ•°æ®ï¼Œä¸åº”è¯¥äººä¸ºæ‹†åˆ† <aiThinkProcess> å’Œ <infobar_data>
    // æ–°çš„å¤„ç†é€»è¾‘ç›´æ¥å°†å®Œæ•´æ•°æ®è¿½åŠ åˆ°æ¶ˆæ¯ä¸­ï¼Œä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œè¯­ä¹‰è¿è´¯æ€§

    /**
     * è·å–APIæä¾›å•†
     */
    getAPIProvider() {
        const context = SillyTavern.getContext();
        const extensionSettings = context.extensionSettings;
        return extensionSettings['Information bar integration tool']?.apiConfig?.provider || 'unknown';
    }

    /**
     * è·å–APIæ¨¡å‹
     */
    getAPIModel() {
        const context = SillyTavern.getContext();
        const extensionSettings = context.extensionSettings;
        return extensionSettings['Information bar integration tool']?.apiConfig?.model || 'unknown';
    }

    /**
     * æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
     */
    showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span class="notification-icon">${type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸'}</span>
            <span class="notification-text">${message}</span>
        `;

        // æ·»åŠ æ ·å¼
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#fee2e2' : type === 'success' ? '#dcfce7' : '#dbeafe'};
            color: ${type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#2563eb'};
            border: 1px solid ${type === 'error' ? '#fecaca' : type === 'success' ? '#bbf7d0' : '#bfdbfe'};
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            max-width: 400px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    /**
     * åŠ è½½æ€»ç»“è®¾ç½®
     */
    async loadSummarySettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½æ€»ç»“è®¾ç½®...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            const settings = summaryManager.settings;

            // åº”ç”¨è®¾ç½®åˆ°UI
            const autoSummaryEnabled = this.modal.querySelector('#content-auto-summary-enabled');
            if (autoSummaryEnabled) {
                autoSummaryEnabled.checked = settings.autoSummaryEnabled || false;
            }

            // ğŸ”§ æ–°å¢ï¼šæ³¨å…¥æ€»ç»“è®¾ç½®
            const injectSummaryEnabled = this.modal.querySelector('#content-inject-summary-enabled');
            if (injectSummaryEnabled) {
                injectSummaryEnabled.checked = settings.injectSummaryEnabled || false;
            }

            const summaryFloorCount = this.modal.querySelector('#content-summary-floor-count');
            if (summaryFloorCount) {
                summaryFloorCount.value = settings.summaryFloorCount || 20;
            }

            const summaryType = this.modal.querySelector('#content-summary-type');
            if (summaryType) {
                summaryType.value = settings.summaryType || 'small';
                this.handleSummaryTypeChange(summaryType.value);
            }

            const summaryWordCount = this.modal.querySelector('#content-summary-word-count');
            if (summaryWordCount) {
                summaryWordCount.value = settings.summaryWordCount || 300;
            }

            // ğŸš€ æ–°å¢ï¼šAIè®°å¿†æ€»ç»“è®¾ç½®
            const aiMemoryEnabled = this.modal.querySelector('#content-ai-memory-enabled');
            if (aiMemoryEnabled && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiMemoryEnabled.checked = aiSettings.enabled || false;
                this.handleAIMemoryEnabledChange(aiMemoryEnabled.checked);
            }

            const aiMessageLevelSummary = this.modal.querySelector('#content-ai-message-level-summary');
            if (aiMessageLevelSummary && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiMessageLevelSummary.checked = aiSettings.messageLevelSummary || false;
            }

            const aiImportanceThreshold = this.modal.querySelector('#content-ai-importance-threshold');
            const aiImportanceValue = this.modal.querySelector('#content-ai-importance-value');
            if (aiImportanceThreshold && aiImportanceValue && summaryManager.aiMemorySummarizer) {
                const aiSettings = summaryManager.aiMemorySummarizer.settings;
                aiImportanceThreshold.value = aiSettings.importanceThreshold || 0.6;
                aiImportanceValue.textContent = `${Math.round((aiSettings.importanceThreshold || 0.6) * 100)}%`;
            }

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–è®°å¿†æ£€ç´¢è®¾ç½®
            const vectorizedMemoryEnabled = this.modal.querySelector('#content-vectorized-memory-enabled');
            if (vectorizedMemoryEnabled && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                vectorizedMemoryEnabled.checked = vectorSettings.enabled || false;
                this.handleVectorizedMemoryEnabledChange(vectorizedMemoryEnabled.checked);
            }

            const vectorEngineSelect = this.modal.querySelector('#content-vector-engine');
            if (vectorEngineSelect && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                vectorEngineSelect.value = vectorSettings.vectorEngine || 'transformers';
            }

            const similarityThreshold = this.modal.querySelector('#content-similarity-threshold');
            const similarityValue = this.modal.querySelector('#content-similarity-value');
            if (similarityThreshold && similarityValue && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                similarityThreshold.value = vectorSettings.similarityThreshold || 0.7;
                similarityValue.textContent = `${Math.round((vectorSettings.similarityThreshold || 0.7) * 100)}%`;
            }

            const maxSearchResults = this.modal.querySelector('#content-max-search-results');
            if (maxSearchResults && summaryManager.vectorizedMemoryRetrieval) {
                const vectorSettings = summaryManager.vectorizedMemoryRetrieval.settings;
                maxSearchResults.value = vectorSettings.maxResults || 10;
            }

            // ğŸ§  æ–°å¢ï¼šæ·±åº¦è®°å¿†ç®¡ç†è®¾ç½®
            const deepMemoryEnabled = this.modal.querySelector('#content-deep-memory-enabled');
            if (deepMemoryEnabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    deepMemoryEnabled.checked = deepMemorySettings.enabled || false;
                    this.handleDeepMemoryEnabledChange(deepMemoryEnabled.checked);
                }
            }

            const autoMemoryMigration = this.modal.querySelector('#content-auto-memory-migration');
            if (autoMemoryMigration) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    autoMemoryMigration.checked = deepMemorySettings.autoMemoryMigration || false;
                }
            }

            const memoryImportanceThreshold = this.modal.querySelector('#content-memory-importance-threshold');
            const memoryImportanceValue = this.modal.querySelector('#content-memory-importance-value');
            if (memoryImportanceThreshold && memoryImportanceValue) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    memoryImportanceThreshold.value = deepMemorySettings.shortTermToLongTermThreshold || 0.6;
                    memoryImportanceValue.textContent = `${Math.round((deepMemorySettings.shortTermToLongTermThreshold || 0.6) * 100)}%`;
                }
            }

            const memoryConflictResolution = this.modal.querySelector('#content-memory-conflict-resolution');
            if (memoryConflictResolution) {
                const infoBarTool = window.SillyTavernInfobar;
                const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                if (deepMemoryManager) {
                    const deepMemorySettings = deepMemoryManager.settings;
                    memoryConflictResolution.checked = deepMemorySettings.memoryConflictResolution || false;
                }
            }

            // è®°å¿†å®¹é‡è®¾ç½®
            const capacityInputs = {
                'content-sensory-capacity': 'sensoryMemoryCapacity',
                'content-short-term-capacity': 'shortTermMemoryCapacity',
                'content-long-term-capacity': 'longTermMemoryCapacity',
                'content-deep-archive-capacity': 'deepArchiveCapacity'
            };

            Object.entries(capacityInputs).forEach(([inputId, settingKey]) => {
                const input = this.modal.querySelector(`#${inputId}`);
                if (input) {
                    const infoBarTool = window.SillyTavernInfobar;
                    const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
                    if (deepMemoryManager) {
                        const deepMemorySettings = deepMemoryManager.settings;
                        input.value = deepMemorySettings[settingKey] || input.defaultValue;
                    }
                }
            });

            // ğŸ¤– æ–°å¢ï¼šæ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const intelligentClassifierEnabled = this.modal.querySelector('#content-intelligent-classifier-enabled');
            if (intelligentClassifierEnabled) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    intelligentClassifierEnabled.checked = classifierSettings.enabled || false;
                    this.handleIntelligentClassifierEnabledChange(intelligentClassifierEnabled.checked);
                }
            }

            const semanticClustering = this.modal.querySelector('#content-semantic-clustering');
            if (semanticClustering) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    semanticClustering.checked = classifierSettings.semanticClustering || false;
                }
            }

            const temporalPatternRecognition = this.modal.querySelector('#content-temporal-pattern-recognition');
            if (temporalPatternRecognition) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    temporalPatternRecognition.checked = classifierSettings.temporalPatternRecognition || false;
                }
            }

            const importancePrediction = this.modal.querySelector('#content-importance-prediction');
            if (importancePrediction) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    importancePrediction.checked = classifierSettings.importancePrediction || false;
                }
            }

            const classificationConfidenceThreshold = this.modal.querySelector('#content-classification-confidence-threshold');
            const classificationConfidenceValue = this.modal.querySelector('#content-classification-confidence-value');
            if (classificationConfidenceThreshold && classificationConfidenceValue) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    classificationConfidenceThreshold.value = classifierSettings.classificationConfidenceThreshold || 0.7;
                    classificationConfidenceValue.textContent = `${Math.round((classifierSettings.classificationConfidenceThreshold || 0.7) * 100)}%`;
                }
            }

            const adaptiveLearning = this.modal.querySelector('#content-adaptive-learning');
            if (adaptiveLearning) {
                const infoBarTool = window.SillyTavernInfobar;
                const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
                if (intelligentMemoryClassifier) {
                    const classifierSettings = intelligentMemoryClassifier.settings;
                    adaptiveLearning.checked = classifierSettings.adaptationEnabled || false;
                }
            }

            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            const autoHideEnabled = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabled) {
                autoHideEnabled.checked = settings.autoHideEnabled || false;
                this.handleAutoHideEnabledChange(autoHideEnabled.checked);
            }

            const autoHideThreshold = this.modal.querySelector('#content-auto-hide-threshold');
            if (autoHideThreshold) {
                autoHideThreshold.value = settings.autoHideThreshold || 30;
            }

            // ğŸ“š æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ æŒä¹…åŒ–è®¾ç½®å›å¡«
            const wbAutoEl = this.modal.querySelector('#worldbook-auto-upload');
            if (wbAutoEl) {
                wbAutoEl.checked = settings.autoUploadNewSummary || false;
            }

            const entryFormatEl = this.modal.querySelector('#worldbook-entry-format');
            const customRow = this.modal.querySelector('#worldbook-custom-name-row');
            if (entryFormatEl) {
                entryFormatEl.value = settings.worldBookEntryFormat || 'auto';
                if (customRow) customRow.style.display = (entryFormatEl.value === 'custom') ? 'block' : 'none';
            }

            const customNameEl = this.modal.querySelector('#worldbook-custom-name');
            if (customNameEl) {
                customNameEl.value = settings.worldBookCustomEntryName || '';
            }

            const addTsEl = this.modal.querySelector('#worldbook-add-timestamp');
            if (addTsEl) {
                addTsEl.checked = settings.worldBookAddTimestamp !== false;
            }

            const useTagsEl = this.modal.querySelector('#worldbook-use-tags');
            if (useTagsEl) {
                useTagsEl.checked = settings.worldBookUseContentTags !== false;
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“è®¾ç½®åŠ è½½å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ€»ç»“è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½æ€»ç»“å†å²
     */
    async loadSummaryHistory() {
        try {
            console.log('[InfoBarSettings] ğŸ“š åŠ è½½æ€»ç»“å†å²...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            const summaryHistory = await summaryManager.getSummaryHistory();
            this.renderSummaryHistory(summaryHistory);

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²åŠ è½½å®Œæˆï¼Œå…±', summaryHistory.length, 'æ¡è®°å½•');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ¸²æŸ“æ€»ç»“å†å²
     */
    renderSummaryHistory(summaryHistory) {
        try {
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            if (!historySelect) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
            historySelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ€»ç»“è®°å½•</option>';

            if (!summaryHistory || summaryHistory.length === 0) {
                // æ·»åŠ ç©ºçŠ¶æ€é€‰é¡¹
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'æš‚æ— æ€»ç»“è®°å½•ï¼Œè¯·å…ˆç”Ÿæˆæ€»ç»“';
                emptyOption.disabled = true;
                historySelect.appendChild(emptyOption);
                return;
            }

            // æ·»åŠ æ€»ç»“è®°å½•é€‰é¡¹
            summaryHistory.forEach(summary => {
                const option = document.createElement('option');
                option.value = summary.id;
                option.textContent = this.formatSummarySelectOption(summary);
                historySelect.appendChild(option);
            });

            console.log('[InfoBarSettings] âœ… æ€»ç»“å†å²é€‰æ‹©æ¡†æ¸²æŸ“å®Œæˆï¼Œå…±', summaryHistory.length, 'æ¡è®°å½•');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸²æŸ“æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“æ ‡é¢˜
     */
    formatSummaryTitle(summary) {
        const typeMap = {
            'small': 'å°æ€»ç»“',
            'large': 'å¤§æ€»ç»“',
            'manual': 'æ‰‹åŠ¨æ€»ç»“',
            'auto': 'è‡ªåŠ¨æ€»ç»“'
        };

        const typeText = typeMap[summary.type] || 'æ€»ç»“';
        const messageRange = summary.messageRange ?
            ` (${summary.messageRange.start}-${summary.messageRange.end})` : '';

        return `${typeText}${messageRange}`;
    }

    /**
     * ğŸš€ æ ¼å¼åŒ–å¢å¼ºçš„æ€»ç»“æ ‡é¢˜ï¼ˆæ”¯æŒAIè®°å¿†æ€»ç»“ï¼‰
     */
    formatEnhancedSummaryTitle(summary) {
        // å¦‚æœæ˜¯AIè®°å¿†æ€»ç»“
        if (summary.source === 'ai_memory_summarizer' || summary.type === 'ai_memory') {
            return summary.title || `AIè®°å¿†æ€»ç»“ (${summary.messageCount || 0}æ¡æ¶ˆæ¯)`;
        }

        // ä¼ ç»Ÿæ€»ç»“
        const typeMap = {
            'small': 'å°æ€»ç»“',
            'large': 'å¤§æ€»ç»“',
            'manual': 'æ‰‹åŠ¨æ€»ç»“',
            'auto': 'è‡ªåŠ¨æ€»ç»“'
        };

        const typeText = typeMap[summary.type] || 'æ€»ç»“';
        const messageRange = summary.messageRange ?
            ` (${summary.messageRange.start}-${summary.messageRange.end})` : '';

        return `${typeText}${messageRange}`;
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“é€‰æ‹©æ¡†é€‰é¡¹
     * æ ¼å¼ï¼š[æ€»ç»“ç±»å‹] æ€»ç»“æ ‡é¢˜ (æ¥¼å±‚X-Y) - æ—¶é—´
     */
    formatSummarySelectOption(summary) {
        try {
            // æ€»ç»“ç±»å‹
            const typeMap = {
                'small': 'å°æ€»ç»“',
                'large': 'å¤§æ€»ç»“',
                'manual': 'æ‰‹åŠ¨æ€»ç»“',
                'auto': 'è‡ªåŠ¨æ€»ç»“'
            };
            const typeText = typeMap[summary.type] || 'æ€»ç»“';

            // æ€»ç»“æ ‡é¢˜ï¼ˆä½¿ç”¨å†…å®¹çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼‰
            let title = 'æ— æ ‡é¢˜';
            if (summary.content && summary.content.trim()) {
                title = summary.content.trim().substring(0, 20);
                if (summary.content.length > 20) {
                    title += '...';
                }
            }

            // æ¥¼å±‚ä¿¡æ¯
            let floorInfo = '';
            if (summary.messageRange) {
                const start = summary.messageRange.start + 1; // è½¬æ¢ä¸º1åŸºç´¢å¼•
                const end = summary.messageRange.end + 1;
                floorInfo = ` (æ¥¼å±‚${start}-${end})`;
            }

            // æ—¶é—´ä¿¡æ¯
            const timeText = this.formatShortDate(summary.timestamp);

            // ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ çŠ¶æ€
            let uploadStatus = '';
            if (summary.worldBookUpload) {
                uploadStatus = ' ğŸ“š';
            }

            // ç»„åˆæ ¼å¼ï¼š[æ€»ç»“ç±»å‹] æ€»ç»“æ ‡é¢˜ (æ¥¼å±‚X-Y) - æ—¶é—´ [ä¸Šä¼ çŠ¶æ€]
            return `[${typeText}] ${title}${floorInfo} - ${timeText}${uploadStatus}`;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ ¼å¼åŒ–æ€»ç»“é€‰æ‹©æ¡†é€‰é¡¹å¤±è´¥:', error);
            return 'æ€»ç»“è®°å½•';
        }
    }

    /**
     * æ ¼å¼åŒ–æ€»ç»“é¢„è§ˆ
     */
    formatSummaryPreview(content) {
        if (!content) return 'æš‚æ— å†…å®¹';
        return content.length > 100 ? content.substring(0, 100) + '...' : content;
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    /**
     * æ ¼å¼åŒ–çŸ­æ—¥æœŸï¼ˆç”¨äºé€‰æ‹©æ¡†ï¼‰
     */
    formatShortDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        if (targetDate.getTime() === today.getTime()) {
            // ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            return date.toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        } else {
            // å…¶ä»–æ—¥æœŸï¼Œæ˜¾ç¤ºæœˆæ—¥å’Œæ—¶é—´
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }

    /**
     * æ˜¾ç¤ºæ€»ç»“å†…å®¹
     */
    async showSummaryContent(summaryId) {
        try {
            console.log('[InfoBarSettings] ğŸ“„ æ˜¾ç¤ºæ€»ç»“å†…å®¹:', summaryId);

            if (!summaryId) {
                // éšè—å†…å®¹åŒºåŸŸ
                this.hideSummaryContent();
                return;
            }

            // è·å–æ€»ç»“å†å²
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“ç®¡ç†å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¢å¼ºçš„æ€»ç»“å†å²è·å–æ–¹æ³•ï¼Œæ”¯æŒAIè®°å¿†æ€»ç»“
            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            const summary = allSummaries.find(s => s.id === summaryId);

            if (!summary) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°æ€»ç»“è®°å½•:', summaryId, 'æ€»ç»“æ•°é‡:', allSummaries.length);
                // éšè—å†…å®¹åŒºåŸŸï¼Œå› ä¸ºè¯¥æ€»ç»“ä¸å­˜åœ¨
                this.hideSummaryContent();
                return;
            }

            console.log('[InfoBarSettings] ğŸ“‹ æ‰¾åˆ°æ€»ç»“è®°å½•:', {
                id: summary.id,
                type: summary.type,
                source: summary.source,
                hasContent: !!summary.content
            });

            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            const contentSection = this.modal.querySelector('#content-summary-content-section');
            const titleElement = this.modal.querySelector('#content-summary-title');
            const dateElement = this.modal.querySelector('#content-summary-date');
            const bodyElement = this.modal.querySelector('#content-summary-content-body');

            if (contentSection && titleElement && dateElement && bodyElement) {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¢å¼ºçš„æ ‡é¢˜æ ¼å¼åŒ–æ–¹æ³•
                titleElement.textContent = this.formatEnhancedSummaryTitle(summary);
                dateElement.textContent = this.formatDate(summary.timestamp);
                bodyElement.textContent = summary.content || 'æš‚æ— å†…å®¹';

                contentSection.style.display = 'block';

                console.log('[InfoBarSettings] âœ… æ€»ç»“å†…å®¹å·²æ˜¾ç¤º');
            } else {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å†…å®¹æ˜¾ç¤ºå…ƒç´ ');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ€»ç»“å†…å®¹å¤±è´¥:', error);
        }
    }
    /**
     * ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶
     */
    bindSummaryPanelEvents() {
        try {
            console.log('[InfoBarSettings] ğŸ”— ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶...');

            // ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (this._summaryEventsbound) {
                console.log('[InfoBarSettings] âš ï¸ æ€»ç»“é¢æ¿äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }

            // æ€»ç»“ç±»å‹å˜åŒ–äº‹ä»¶
            const summaryTypeSelect = this.modal.querySelector('#content-summary-type');
            if (summaryTypeSelect) {
                summaryTypeSelect.addEventListener('change', (e) => {
                    this.handleSummaryTypeChange(e.target.value);
                });
            }

            // æ‰‹åŠ¨æ€»ç»“æŒ‰é’®äº‹ä»¶
            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.addEventListener('click', () => {
                    this.triggerManualSummary();
                });
            }

            // ä¿å­˜è®¾ç½®æŒ‰é’®äº‹ä»¶
            const saveSettingsBtn = this.modal.querySelector('#content-save-settings-btn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    this.saveSummarySettings();
                });
            }

            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshBtn = this.modal.querySelector('#header-refresh-summary-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadSummaryHistory();
                });
            }

            // æ€»ç»“å†å²é€‰æ‹©æ¡†äº‹ä»¶
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            if (historySelect) {
                historySelect.addEventListener('change', (e) => {
                    const summaryId = e.target.value;
                    this.showSummaryContent(summaryId);
                });
            }

            // ğŸš€ æ–°å¢ï¼šä¸Šä¼ åˆ°ä¸–ç•Œä¹¦æŒ‰é’®äº‹ä»¶
            const uploadToWorldBookBtn = this.modal.querySelector('#content-upload-to-worldbook-btn');
            if (uploadToWorldBookBtn && historySelect) {
                uploadToWorldBookBtn.addEventListener('click', async () => {
                    await this.handleUploadSummaryToWorldBook();
                });
            }

            // åˆ é™¤å½“å‰é€‰æ‹©çš„æ€»ç»“
            const deleteBtn = this.modal.querySelector('#content-delete-summary-btn');
            if (deleteBtn && historySelect) {
                deleteBtn.addEventListener('click', async () => {
                    try {
                        const summaryId = historySelect.value;
                        if (!summaryId) {
                            this.showNotification('è¯·å…ˆåœ¨é€‰æ‹©æ¡†ä¸­é€‰æ‹©ä¸€æ¡æ€»ç»“è®°å½•', 'info');
                            return;
                        }
                        const infoBarTool = window.SillyTavernInfobar;
                        const summaryManager = infoBarTool?.modules?.summaryManager;
                        if (!summaryManager) return;
                        const ok = await summaryManager.deleteSummaryRecord(summaryId);
                        if (ok) {
                            this.showNotification('âœ… å·²åˆ é™¤è¯¥æ€»ç»“', 'success');
                            // åˆ·æ–°å†å²
                            await this.loadSummaryHistory();
                            // æ¸…ç©ºé€‰æ‹©ä¸å†…å®¹
                            historySelect.value = '';
                            this.hideSummaryContent();
                        } else {
                            this.showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
                        }
                    } catch (err) {
                        console.error('[InfoBarSettings] âŒ åˆ é™¤æ€»ç»“å¤±è´¥:', err);
                        this.showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
                    }
                });
            }

            // ğŸš€ æ–°å¢ï¼šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶
            this.bindWorldBookUploadEvents();

            // ğŸ§  è®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶å¤„ç†å™¨
            this.bindMemoryEnhancementEvents();

            // ğŸš€ æ–°å¢ï¼šAIè®°å¿†æ€»ç»“å¤é€‰æ¡†äº‹ä»¶ï¼ˆæ€»ç»“é¢æ¿ä¸­çš„æ—§ç‰ˆæœ¬ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
            const aiMemoryEnabledCheckbox = this.modal.querySelector('#content-ai-memory-enabled');
            if (aiMemoryEnabledCheckbox) {
                aiMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleAIMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸš€ æ–°å¢ï¼šæ¶ˆæ¯çº§åˆ«æ€»ç»“å¤é€‰æ¡†äº‹ä»¶
            const aiMessageLevelCheckbox = this.modal.querySelector('#content-ai-message-level-summary');
            if (aiMessageLevelCheckbox) {
                aiMessageLevelCheckbox.addEventListener('change', (e) => {
                    this.handleAIMessageLevelChange(e.target.checked);
                });
            }

            // ğŸš€ æ–°å¢ï¼šé‡è¦æ€§é˜ˆå€¼æ»‘å—äº‹ä»¶
            const aiImportanceThreshold = this.modal.querySelector('#content-ai-importance-threshold');
            if (aiImportanceThreshold) {
                aiImportanceThreshold.addEventListener('input', (e) => {
                    this.handleAIImportanceThresholdChange(e.target.value);
                });
            }

            // ğŸš€ æ–°å¢ï¼šæ€»ç»“ç­›é€‰æ ‡ç­¾äº‹ä»¶
            const filterTabs = this.modal.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.handleFilterTabClick(e.target.dataset.filter);
                });
            });

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–è®°å¿†æ£€ç´¢å¤é€‰æ¡†äº‹ä»¶
            const vectorizedMemoryEnabledCheckbox = this.modal.querySelector('#content-vectorized-memory-enabled');
            if (vectorizedMemoryEnabledCheckbox) {
                vectorizedMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleVectorizedMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸ” æ–°å¢ï¼šå‘é‡åŒ–å¼•æ“é€‰æ‹©äº‹ä»¶
            const vectorEngineSelect = this.modal.querySelector('#content-vector-engine');
            if (vectorEngineSelect) {
                vectorEngineSelect.addEventListener('change', (e) => {
                    this.handleVectorEngineChange(e.target.value);
                });
            }

            // ğŸ” æ–°å¢ï¼šç›¸ä¼¼åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
            const similarityThreshold = this.modal.querySelector('#content-similarity-threshold');
            if (similarityThreshold) {
                similarityThreshold.addEventListener('input', (e) => {
                    this.handleSimilarityThresholdChange(e.target.value);
                });
            }

            // ğŸ” æ–°å¢ï¼šæœ€å¤§æœç´¢ç»“æœæ•°é‡äº‹ä»¶
            const maxSearchResults = this.modal.querySelector('#content-max-search-results');
            if (maxSearchResults) {
                maxSearchResults.addEventListener('input', (e) => {
                    this.handleMaxSearchResultsChange(e.target.value);
                });
            }

            // ğŸ§  æ–°å¢ï¼šæ·±åº¦è®°å¿†ç®¡ç†å¤é€‰æ¡†äº‹ä»¶
            const deepMemoryEnabledCheckbox = this.modal.querySelector('#content-deep-memory-enabled');
            if (deepMemoryEnabledCheckbox) {
                deepMemoryEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleDeepMemoryEnabledChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè‡ªåŠ¨è®°å¿†è¿ç§»å¤é€‰æ¡†äº‹ä»¶
            const autoMemoryMigrationCheckbox = this.modal.querySelector('#content-auto-memory-migration');
            if (autoMemoryMigrationCheckbox) {
                autoMemoryMigrationCheckbox.addEventListener('change', (e) => {
                    this.handleAutoMemoryMigrationChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†é‡è¦æ€§é˜ˆå€¼æ»‘å—äº‹ä»¶
            const memoryImportanceThreshold = this.modal.querySelector('#content-memory-importance-threshold');
            if (memoryImportanceThreshold) {
                memoryImportanceThreshold.addEventListener('input', (e) => {
                    this.handleMemoryImportanceThresholdChange(e.target.value);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å†²çªè§£å†³å¤é€‰æ¡†äº‹ä»¶
            const memoryConflictResolutionCheckbox = this.modal.querySelector('#content-memory-conflict-resolution');
            if (memoryConflictResolutionCheckbox) {
                memoryConflictResolutionCheckbox.addEventListener('change', (e) => {
                    this.handleMemoryConflictResolutionChange(e.target.checked);
                });
            }

            // ğŸ§  æ–°å¢ï¼šè®°å¿†å®¹é‡è®¾ç½®äº‹ä»¶
            const capacityInputs = [
                'content-sensory-capacity',
                'content-short-term-capacity',
                'content-long-term-capacity',
                'content-deep-archive-capacity'
            ];

            capacityInputs.forEach(inputId => {
                const input = this.modal.querySelector(`#${inputId}`);
                if (input) {
                    input.addEventListener('input', (e) => {
                        this.handleMemoryCapacityChange(inputId, e.target.value);
                    });
                }
            });

            // ğŸ¤– æ–°å¢ï¼šæ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¤é€‰æ¡†äº‹ä»¶
            const intelligentClassifierEnabledCheckbox = this.modal.querySelector('#content-intelligent-classifier-enabled');
            if (intelligentClassifierEnabledCheckbox) {
                intelligentClassifierEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleIntelligentClassifierEnabledChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šè¯­ä¹‰èšç±»åˆ†æå¤é€‰æ¡†äº‹ä»¶
            const semanticClusteringCheckbox = this.modal.querySelector('#content-semantic-clustering');
            if (semanticClusteringCheckbox) {
                semanticClusteringCheckbox.addEventListener('change', (e) => {
                    this.handleSemanticClusteringChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šæ—¶åºæ¨¡å¼è¯†åˆ«å¤é€‰æ¡†äº‹ä»¶
            const temporalPatternRecognitionCheckbox = this.modal.querySelector('#content-temporal-pattern-recognition');
            if (temporalPatternRecognitionCheckbox) {
                temporalPatternRecognitionCheckbox.addEventListener('change', (e) => {
                    this.handleTemporalPatternRecognitionChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šé‡è¦æ€§é¢„æµ‹å¤é€‰æ¡†äº‹ä»¶
            const importancePredictionCheckbox = this.modal.querySelector('#content-importance-prediction');
            if (importancePredictionCheckbox) {
                importancePredictionCheckbox.addEventListener('change', (e) => {
                    this.handleImportancePredictionChange(e.target.checked);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šåˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
            const classificationConfidenceThreshold = this.modal.querySelector('#content-classification-confidence-threshold');
            if (classificationConfidenceThreshold) {
                classificationConfidenceThreshold.addEventListener('input', (e) => {
                    this.handleClassificationConfidenceThresholdChange(e.target.value);
                });
            }

            // ğŸ¤– æ–°å¢ï¼šè‡ªé€‚åº”å­¦ä¹ å¤é€‰æ¡†äº‹ä»¶
            const adaptiveLearningCheckbox = this.modal.querySelector('#content-adaptive-learning');
            if (adaptiveLearningCheckbox) {
                adaptiveLearningCheckbox.addEventListener('change', (e) => {
                    this.handleAdaptiveLearningChange(e.target.checked);
                });
            }

            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚å¤é€‰æ¡†äº‹ä»¶
            const autoHideEnabledCheckbox = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabledCheckbox) {
                autoHideEnabledCheckbox.addEventListener('change', (e) => {
                    this.handleAutoHideEnabledChange(e.target.checked);
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®äº‹ä»¶ç»‘å®šæ ‡å¿—ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            this._summaryEventsbound = true;

            console.log('[InfoBarSettings] âœ… æ€»ç»“é¢æ¿äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šæ€»ç»“é¢æ¿äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†æ€»ç»“ç±»å‹å˜åŒ–
     */
    handleSummaryTypeChange(summaryType) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ æ€»ç»“ç±»å‹å˜åŒ–:', summaryType);

            const customWordCountRow = this.modal.querySelector('#content-custom-word-count-row');
            if (customWordCountRow) {
                if (summaryType === 'custom') {
                    customWordCountRow.style.display = 'block';
                } else {
                    customWordCountRow.style.display = 'none';
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ€»ç»“ç±»å‹å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šå¤„ç†è‡ªåŠ¨éšè—å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleAutoHideEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨éšè—æ¥¼å±‚å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—é˜ˆå€¼è®¾ç½®
            const thresholdRow = this.modal.querySelector('#content-auto-hide-threshold-row');
            if (thresholdRow) {
                thresholdRow.style.display = enabled ? 'block' : 'none';
            }

            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨éšè—ï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦éšè—æ¥¼å±‚
            if (enabled) {
                this.checkAndExecuteAutoHide();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªåŠ¨éšè—çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥å¹¶æ‰§è¡Œè‡ªåŠ¨éšè—æ¥¼å±‚
     */
    async checkAndExecuteAutoHide() {
        try {
            // è·å–è®¾ç½®
            const autoHideEnabled = this.modal?.querySelector('#content-auto-hide-enabled')?.checked || false;
            const autoHideThreshold = parseInt(this.modal?.querySelector('#content-auto-hide-threshold')?.value) || 30;

            if (!autoHideEnabled) {
                console.log('[InfoBarSettings] â¸ï¸ è‡ªåŠ¨éšè—æœªå¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥');
                return;
            }

            // è·å–å½“å‰èŠå¤©æ¶ˆæ¯æ•°é‡
            const chatLength = this.getChatLength();
            if (chatLength <= autoHideThreshold) {
                console.log('[InfoBarSettings] â„¹ï¸ èŠå¤©é•¿åº¦ä¸è¶³ï¼Œæ— éœ€éšè—æ¥¼å±‚');
                return;
            }

            // è®¡ç®—éœ€è¦éšè—çš„èŒƒå›´ï¼š0åˆ°(æ€»é•¿åº¦-é˜ˆå€¼-1)
            const hideUntilIndex = chatLength - autoHideThreshold - 1;

            if (hideUntilIndex > 0) {
                console.log(`[InfoBarSettings] ğŸ”„ æ‰§è¡Œè‡ªåŠ¨éšè—ï¼šéšè—æ¥¼å±‚ 0-${hideUntilIndex}`);
                await this.executeHideCommand(`/hide 0-${hideUntilIndex}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è‡ªåŠ¨éšè—æ¥¼å±‚å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å½“å‰èŠå¤©çš„æ¶ˆæ¯æ•°é‡
     */
    getChatLength() {
        try {
            // ä½¿ç”¨SillyTavernçš„getContextè·å–èŠå¤©æ•°æ®
            if (typeof getContext === 'function') {
                const context = getContext();
                return context?.chat?.length || 0;
            }

            // å¤‡ç”¨æ–¹æ³•ï¼šé€šè¿‡DOMæŸ¥è¯¢æ¶ˆæ¯æ•°é‡
            const messages = document.querySelectorAll('#chat .mes');
            return messages.length;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–èŠå¤©é•¿åº¦å¤±è´¥:', error);
            return 0;
        }
    }

    /**
     * æ‰§è¡Œéšè—å‘½ä»¤
     */
    async executeHideCommand(command) {
        try {
            console.log('[InfoBarSettings] ğŸ“‹ æ‰§è¡Œéšè—å‘½ä»¤:', command);

            // æ–¹æ³•1: å°è¯•ä½¿ç”¨SillyTavernçš„æ–œæ å‘½ä»¤è§£æå™¨
            if (typeof window.SlashCommandParser !== 'undefined') {
                const parser = new window.SlashCommandParser();
                const result = parser.parse(command, false);

                if (result && typeof result.execute === 'function') {
                    await result.execute();
                    console.log('[InfoBarSettings] âœ… éšè—å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (æ–¹æ³•1)');
                    return;
                }
            }

            // æ–¹æ³•2: å°è¯•ç›´æ¥åœ¨èŠå¤©è¾“å…¥æ¡†æ‰§è¡Œå‘½ä»¤
            const chatTextarea = document.getElementById('send_textarea');
            if (chatTextarea) {
                console.log('[InfoBarSettings] ğŸ”„ å°è¯•é€šè¿‡èŠå¤©è¾“å…¥æ¡†æ‰§è¡Œå‘½ä»¤');
                const originalValue = chatTextarea.value;
                chatTextarea.value = command;

                // è§¦å‘è¾“å…¥äº‹ä»¶
                chatTextarea.dispatchEvent(new Event('input', { bubbles: true }));

                // ç­‰å¾…çŸ­æš‚æ—¶é—´åæŒ‰å›è½¦
                setTimeout(() => {
                    chatTextarea.dispatchEvent(new KeyboardEvent('keydown', {
                        key: 'Enter',
                        bubbles: true
                    }));

                    // æ¢å¤åŸå§‹å€¼
                    setTimeout(() => {
                        chatTextarea.value = originalValue;
                    }, 100);
                }, 100);

                console.log('[InfoBarSettings] âœ… éšè—å‘½ä»¤å·²é€šè¿‡èŠå¤©è¾“å…¥æ¡†å‘é€');
                return;
            }

            // æ–¹æ³•3: å°è¯•ä½¿ç”¨SillyTavernçš„å…¨å±€å‘½ä»¤æ‰§è¡Œå™¨
            if (typeof window.executeSlashCommand === 'function') {
                await window.executeSlashCommand(command);
                console.log('[InfoBarSettings] âœ… éšè—å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (æ–¹æ³•3)');
                return;
            }

            console.warn('[InfoBarSettings] âš ï¸ æ‰€æœ‰éšè—å‘½ä»¤æ‰§è¡Œæ–¹æ³•éƒ½å¤±è´¥');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰§è¡Œéšè—å‘½ä»¤å¤±è´¥:', error);
        }
    }

    /**
     * è§¦å‘æ‰‹åŠ¨æ€»ç»“
     */
    async triggerManualSummary() {
        // ğŸ”§ é˜²æ­¢é‡å¤ç‚¹å‡» - æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿›è¡Œä¸­
        if (this._summaryInProgress) {
            console.warn('[InfoBarSettings] âš ï¸ æ€»ç»“å·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
            this.showMessage('â³ æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...', 'warning');
            return;
        }

        try {
            console.log('[InfoBarSettings] ğŸ–Šï¸ è§¦å‘æ‰‹åŠ¨æ€»ç»“...');

            // è®¾ç½®è¿›è¡Œä¸­æ ‡å¿—
            this._summaryInProgress = true;

            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.disabled = true;
                manualSummaryBtn.innerHTML = `
                    <span class="btn-icon">â³</span>
                    <span class="btn-text">æ€»ç»“ä¸­...</span>
                `;
            }

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // è·å–å½“å‰è®¾ç½®
            const settings = this.getCurrentSummarySettings();

            // è°ƒç”¨æ€»ç»“ç®¡ç†å™¨è¿›è¡Œæ€»ç»“
            const result = await summaryManager.generateSummary({
                type: 'manual',
                ...settings
            });

            if (result.success) {
                console.log('[InfoBarSettings] âœ… æ‰‹åŠ¨æ€»ç»“å®Œæˆ');
                this.showMessage('âœ… æ€»ç»“ç”ŸæˆæˆåŠŸ', 'success');

                // åˆ·æ–°æ€»ç»“å†å²
                this.loadSummaryHistory();
            } else {
                console.error('[InfoBarSettings] âŒ æ‰‹åŠ¨æ€»ç»“å¤±è´¥:', result.error);
                this.showMessage('âŒ æ€»ç»“ç”Ÿæˆå¤±è´¥: ' + result.error, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è§¦å‘æ‰‹åŠ¨æ€»ç»“å¤±è´¥:', error);

            // ğŸ”§ æ”¹è¿›çš„é”™è¯¯æ¶ˆæ¯å¤„ç†
            let errorMessage = 'âŒ æ€»ç»“ç”Ÿæˆå¤±è´¥';

            if (error.message?.includes('429')) {
                errorMessage = 'âŒ APIè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯• (429é”™è¯¯)';
            } else if (error.message?.includes('500')) {
                errorMessage = 'âŒ GeminiæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯• (500é”™è¯¯)';
            } else if (error.message?.includes('ç©ºçš„æ–‡æœ¬å†…å®¹')) {
                errorMessage = 'âŒ æ¨¡å‹æ²¡æœ‰è¿”å›å†…å®¹ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–é‡è¯•';
            } else if (error.message?.includes('æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­')) {
                errorMessage = 'â³ æ€»ç»“æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…';
            } else if (error.message) {
                errorMessage += ': ' + error.message;
            }

            this.showMessage(errorMessage, 'error');
        } finally {
            // ğŸ”§ æ¸…é™¤è¿›è¡Œä¸­æ ‡å¿—
            this._summaryInProgress = false;

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const manualSummaryBtn = this.modal.querySelector('#header-manual-summary-btn');
            if (manualSummaryBtn) {
                manualSummaryBtn.disabled = false;
                manualSummaryBtn.innerHTML = `
                    <span class="btn-icon">ğŸ–Šï¸</span>
                    <span class="btn-text">æ‰‹åŠ¨æ€»ç»“</span>
                `;
            }
        }
    }

    /**
     * ä¿å­˜æ€»ç»“è®¾ç½®
     */
    async saveSummarySettings() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜æ€»ç»“è®¾ç½®...');

            const settings = this.getCurrentSummarySettings();

            // è·å–æ€»ç»“ç®¡ç†å™¨
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('æ€»ç»“ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°è®¾ç½®
            summaryManager.updateSettings(settings);

            // ä¿å­˜åˆ°æ•°æ®æ ¸å¿ƒ
            const unifiedDataCore = infoBarTool?.modules?.dataCore;
            if (unifiedDataCore) {
                await unifiedDataCore.setData('summary_settings', settings);
            }

            // ğŸ”§ æ–°å¢ï¼šä¿å­˜åˆ°SillyTavernæ‰©å±•è®¾ç½®
            const context = SillyTavern.getContext();
            if (context && context.extensionSettings) {
                const extensionSettings = context.extensionSettings;
                if (!extensionSettings['Information bar integration tool']) {
                    extensionSettings['Information bar integration tool'] = {};
                }

                // ä¿å­˜æ€»ç»“è®¾ç½®åˆ°æ‰©å±•è®¾ç½®
                Object.assign(extensionSettings['Information bar integration tool'], settings);

                // è§¦å‘SillyTavernä¿å­˜
                if (context.saveSettingsDebounced) {
                    context.saveSettingsDebounced();
                }

                console.log('[InfoBarSettings] ğŸ’¾ æ€»ç»“è®¾ç½®å·²ä¿å­˜åˆ°æ‰©å±•è®¾ç½®');
            }

            console.log('[InfoBarSettings] âœ… æ€»ç»“è®¾ç½®å·²ä¿å­˜');
            this.showMessage('âœ… è®¾ç½®å·²ä¿å­˜', 'success');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æ€»ç»“è®¾ç½®å¤±è´¥:', error);
            this.showMessage('âŒ ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
        }
    }

    /**
     * è·å–å½“å‰æ€»ç»“è®¾ç½®
     */
    getCurrentSummarySettings() {
        const settings = {
            autoSummaryEnabled: false,
            summaryFloorCount: 20,
            summaryType: 'small',
            summaryWordCount: 300,
            injectSummaryEnabled: false,  // ğŸ”§ æ–°å¢ï¼šæ³¨å…¥æ€»ç»“è®¾ç½®
            // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            autoHideEnabled: false,
            autoHideThreshold: 30,
            // ğŸ“š ä¸–ç•Œä¹¦ä¸Šä¼ ç›¸å…³ï¼ˆç”¨äºæŒä¹…åŒ–ä¿å­˜ï¼‰
            autoUploadNewSummary: false,
            worldBookEntryFormat: 'auto',
            worldBookCustomEntryName: '',
            worldBookAddTimestamp: true,
            worldBookUseContentTags: true
        };

        try {
            const autoSummaryEnabled = this.modal.querySelector('#content-auto-summary-enabled');
            if (autoSummaryEnabled) {
                settings.autoSummaryEnabled = autoSummaryEnabled.checked;
            }

            const summaryFloorCount = this.modal.querySelector('#content-summary-floor-count');
            if (summaryFloorCount) {
                settings.summaryFloorCount = parseInt(summaryFloorCount.value) || 20;
            }

            const summaryType = this.modal.querySelector('#content-summary-type');
            if (summaryType) {
                settings.summaryType = summaryType.value;
            }

            const summaryWordCount = this.modal.querySelector('#content-summary-word-count');
            if (summaryWordCount) {
                settings.summaryWordCount = parseInt(summaryWordCount.value) || 300;
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–æ³¨å…¥æ€»ç»“è®¾ç½®
            const injectSummaryEnabled = this.modal.querySelector('#content-inject-summary-enabled');
            if (injectSummaryEnabled) {
                settings.injectSummaryEnabled = injectSummaryEnabled.checked;
            }

            // ğŸ”§ æ–°å¢ï¼šè·å–è‡ªåŠ¨éšè—æ¥¼å±‚è®¾ç½®
            const autoHideEnabled = this.modal.querySelector('#content-auto-hide-enabled');
            if (autoHideEnabled) {
                settings.autoHideEnabled = autoHideEnabled.checked;
            }

            const autoHideThreshold = this.modal.querySelector('#content-auto-hide-threshold');
            if (autoHideThreshold) {
                settings.autoHideThreshold = parseInt(autoHideThreshold.value) || 30;
            }

            // ğŸ“š æ–°å¢ï¼šè·å–â€œè‡ªåŠ¨ä¸Šä¼ æ–°æ€»ç»“â€ä¸â€œæ¡ç›®å‘½åæ ¼å¼â€ç­‰ä¸–ç•Œä¹¦ä¸Šä¼ è®¾ç½®
            const wbAuto = this.modal.querySelector('#worldbook-auto-upload');
            if (wbAuto) {
                settings.autoUploadNewSummary = wbAuto.checked;
            }

            const entryFormatEl = this.modal.querySelector('#worldbook-entry-format');
            if (entryFormatEl) {
                settings.worldBookEntryFormat = entryFormatEl.value || 'auto';
            }

            const customNameEl = this.modal.querySelector('#worldbook-custom-name');
            if (customNameEl) {
                settings.worldBookCustomEntryName = customNameEl.value || '';
            }

            const addTsEl = this.modal.querySelector('#worldbook-add-timestamp');
            if (addTsEl) {
                settings.worldBookAddTimestamp = addTsEl.checked !== false;
            }

            const useTagsEl = this.modal.querySelector('#worldbook-use-tags');
            if (useTagsEl) {
                settings.worldBookUseContentTags = useTagsEl.checked !== false;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ€»ç»“è®¾ç½®å¤±è´¥:', error);
        }

        return settings;
    }

    /**
     * éšè—æ€»ç»“å†…å®¹
     */
    hideSummaryContent() {
        // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥modalæ˜¯å¦å­˜åœ¨ï¼Œé¿å…åœ¨æœªåˆå§‹åŒ–æ—¶è°ƒç”¨
        if (!this.modal) {
            console.log('[InfoBarSettings] âš ï¸ è®¾ç½®ç•Œé¢æœªåˆå§‹åŒ–ï¼Œè·³è¿‡éšè—æ€»ç»“å†…å®¹');
            return;
        }

        const contentSection = this.modal.querySelector('#content-summary-content-section');
        if (contentSection) {
            contentSection.style.display = 'none';
        }
    }

    /**
     * å¤„ç†å­—ä½“å¤§å°å˜æ›´
     */
    handleFontSizeChange(fontSize) {
        const heightSelect = this.modal.querySelector('select[name="infobar.height"]');
        if (!heightSelect) return;

        // å­—ä½“å¤§å°ä¸é«˜åº¦çš„æ¨èå…³è”
        const fontHeightMap = {
            'small': 'compact',     // 12px -> 24px
            'medium': 'normal',     // 14px -> 32px
            'large': 'comfortable', // 16px -> 40px
            'xlarge': 'spacious'    // 18px -> 48px
        };

        const recommendedHeight = fontHeightMap[fontSize];
        if (recommendedHeight && heightSelect.value === 'auto') {
            heightSelect.value = recommendedHeight;
            console.log(`[InfoBarSettings] ğŸ”— å­—ä½“å¤§å° ${fontSize} è‡ªåŠ¨å…³è”é«˜åº¦ ${recommendedHeight}`);
        }

        // è§¦å‘é«˜åº¦å˜æ›´äº‹ä»¶
        this.handleInfobarHeightChange(heightSelect.value);
    }

    /**
     * å¤„ç†ä¿¡æ¯æ é«˜åº¦å˜æ›´
     */
    handleInfobarHeightChange(height) {
        // åº”ç”¨CSSå˜é‡åˆ°ä¿¡æ¯æ 
        const heightMap = {
            'auto': 'auto',
            'compact': '24px',
            'normal': '32px',
            'comfortable': '40px',
            'spacious': '48px'
        };

        const heightValue = heightMap[height] || '32px';

        // åº”ç”¨åˆ°CSSå˜é‡ï¼ˆå¦‚æœå­˜åœ¨ä¿¡æ¯æ å…ƒç´ ï¼‰
        const infobarElements = document.querySelectorAll('.info-bar, .infobar-container');
        infobarElements.forEach(element => {
            element.style.setProperty('--infobar-height', heightValue);
            if (heightValue !== 'auto') {
                element.style.minHeight = heightValue;
            }
        });

        console.log(`[InfoBarSettings] ğŸ“ ä¿¡æ¯æ é«˜åº¦è®¾ç½®ä¸º ${heightValue}`);

        // ä¿å­˜è®¾ç½®
        this.saveThemeSettings();
    }

    /**
     * ä¿å­˜ä¸»é¢˜è®¾ç½®
     */
    saveThemeSettings() {
        try {
            const settings = {
                fontSize: this.modal.querySelector('select[name="theme.fontSize"]')?.value || 'medium',
                fontFamily: this.modal.querySelector('select[name="theme.fontFamily"]')?.value || 'system',
                infobarHeight: this.modal.querySelector('select[name="infobar.height"]')?.value || 'normal'
            };

            // ä¿å­˜åˆ°æ‰©å±•è®¾ç½®
            const extensionSettings = window.SillyTavernInfobar?.config || {};
            extensionSettings.theme = extensionSettings.theme || {};
            Object.assign(extensionSettings.theme, settings);

            console.log('[InfoBarSettings] ğŸ’¾ ä¸»é¢˜è®¾ç½®å·²ä¿å­˜:', settings);
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•
     */
    showAddPanelMenu(position, slotElement) {
        try {
            console.log('[InfoBarSettings] ğŸ­ æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•');

            // ç§»é™¤ç°æœ‰èœå•
            const existingMenu = document.querySelector('.demo-add-panel-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // è·å–åŒºåŸŸä¿¡æ¯
            const area = slotElement.dataset.area || 'top';
            console.log(`[InfoBarSettings] ğŸ“ æ·»åŠ åˆ°åŒºåŸŸ: ${area}, ä½ç½®: ${position}`);

            // åŠ¨æ€è·å–ç”¨æˆ·å¯ç”¨çš„é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            console.log('[InfoBarSettings] ğŸ“Š è·å–åˆ°ç”¨æˆ·å¯ç”¨çš„é¢æ¿:', Object.keys(enabledPanels));

            if (Object.keys(enabledPanels).length === 0) {
                console.warn('[InfoBarSettings] âš ï¸ æ²¡æœ‰å¯ç”¨çš„é¢æ¿ï¼Œæ— æ³•æ˜¾ç¤ºæ·»åŠ èœå•');
                return;
            }

            // åˆ›å»ºæ¼”ç¤ºèœå•
            const menu = document.createElement('div');
            menu.className = 'demo-add-panel-menu';
            // ç”Ÿæˆé¢æ¿åˆ—è¡¨HTML
            const panelListHtml = this.generatePanelListHtml(enabledPanels);

            // è·å–ç¬¬ä¸€ä¸ªé¢æ¿ç”¨äºåˆå§‹åŒ–å³ä¾§å­é¡¹åˆ—è¡¨
            const firstPanelId = Object.keys(enabledPanels)[0];
            const firstPanelConfig = enabledPanels[firstPanelId];
            const subitemListHtml = this.generateSubitemListHtml(firstPanelId, firstPanelConfig);

            menu.innerHTML = `
                <div class="demo-menu-content">
                    <div class="menu-header">
                        <h3>æ·»åŠ åˆ°${area === 'top' ? 'é¡¶éƒ¨' : 'åº•éƒ¨'}åŒºåŸŸ</h3>
                        <button class="menu-close-btn">&times;</button>
                    </div>
                    <div class="menu-body">
                        <div class="menu-layout">
                            <!-- å·¦ä¾§é¢æ¿å¯¼èˆª -->
                            <div class="panel-navigation">
                                <h4>ğŸ“‹ å¯ç”¨çš„é¢æ¿ (${Object.keys(enabledPanels).length})</h4>
                                <div class="panel-list">
                                    ${panelListHtml}
                                </div>
                            </div>

                            <!-- å³ä¾§å­é¡¹åˆ—è¡¨ -->
                            <div class="subitem-list">
                                ${subitemListHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // å®šä½èœå•ï¼ˆç§»åŠ¨ç«¯å…¨å±é®ç½©ï¼Œæ¡Œé¢ç«¯å±…ä¸­ï¼‰
            const isMobile = window.innerWidth <= 768;
            menu.style.position = 'fixed';
            menu.style.zIndex = '10000';
            if (isMobile) {
                // å…¨å±é®ç½©
                menu.style.left = '0';
                menu.style.top = '0';
                menu.style.width = '100vw';
                menu.style.height = '100vh';
                menu.style.background = 'rgba(0, 0, 0, 0.5)';
                menu.style.backdropFilter = 'blur(4px)';
                menu.style.display = 'flex';
                menu.style.alignItems = 'center';
                menu.style.justifyContent = 'center';

                // å†…å®¹å®¹å™¨é™åˆ¶å°ºå¯¸å¹¶å±…ä¸­
                const menuContent = menu.querySelector('.demo-menu-content');
                if (menuContent) {
                    menuContent.style.width = '90vw';
                    menuContent.style.maxWidth = '360px';
                    menuContent.style.maxHeight = '80vh';
                    menuContent.style.overflow = 'auto';
                    menuContent.style.borderRadius = '12px';
                }
            } else {
                // æ¡Œé¢å±…ä¸­
                menu.style.left = '50%';
                menu.style.top = '50%';
                menu.style.transform = 'translate(-50%, -50%)';
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(menu);

            // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆä»…ç§»åŠ¨ç«¯å…¨å±æ—¶ï¼‰
            if (isMobile) {
                menu.addEventListener('click', (evt) => {
                    const content = menu.querySelector('.demo-menu-content');
                    if (content && !content.contains(evt.target)) {
                        menu.remove();
                    }
                });
            }

            // ç»‘å®šå…³é—­æŒ‰é’®
            const closeBtn = menu.querySelector('.menu-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    menu.remove();
                });
            }

            // ç»‘å®šé¢æ¿å¯¼èˆªäº‹ä»¶
            const panelNavItems = menu.querySelectorAll('.panel-nav-item');
            panelNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-panel-btn')) return; // å¿½ç•¥æ·»åŠ æŒ‰é’®ç‚¹å‡»

                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    panelNavItems.forEach(navItem => navItem.classList.remove('active'));
                    item.classList.add('active');

                    // æ›´æ–°å³ä¾§å­é¡¹åˆ—è¡¨
                    const panelType = item.dataset.panel;
                    this.updateSubitemList(menu, panelType);
                });
            });

            // ç»‘å®šæ·»åŠ é¢æ¿æŒ‰é’®äº‹ä»¶
            const addPanelBtns = menu.querySelectorAll('.add-panel-btn');
            addPanelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const panelType = btn.closest('.panel-nav-item').dataset.panel;
                    console.log(`[InfoBarSettings] ğŸ­ æ·»åŠ é¢æ¿: ${panelType} åˆ° ${area}`);
                    this.addPanelToPreview(panelType, area, position);
                    menu.remove();
                });
            });

            // ç»‘å®šæ·»åŠ å­é¡¹æŒ‰é’®äº‹ä»¶
            const addSubitemBtns = menu.querySelectorAll('.add-subitem-btn');
            addSubitemBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fieldType = btn.closest('.subitem-item').dataset.field;
                    console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹: ${fieldType} åˆ° ${area}`);
                    this.addSubitemToPreview(fieldType, area, position);
                    menu.remove();
                });
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const clickOutside = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', clickOutside);
                    }
                };
                document.addEventListener('click', clickOutside);
            }, 100);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¼”ç¤ºæ·»åŠ é¢æ¿èœå•å¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—
     */
    showDemoPanelPopup(panelType, panelData = {}) {
        try {
            console.log('[InfoBarSettings] ğŸ­ æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—:', panelType);

            // ç§»é™¤ç°æœ‰å¼¹çª—
            const existingPopup = document.querySelector('.demo-panel-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // æ¼”ç¤ºæ•°æ®
            const demoData = {
                personal: {
                    'å§“å': 'å¼ ä¸‰',
                    'å¹´é¾„': '25å²',
                    'æ€§åˆ«': 'ç”·',
                    'èŒä¸š': 'å†’é™©è€…',
                    'ç­‰çº§': 'Lv.15',
                    'ç»éªŒå€¼': '2847/3000'
                },
                inventory: {
                    'é‡‘å¸': '1,247æš',
                    'é“¶å‰‘': '1æŠŠ (è£…å¤‡ä¸­)',
                    'ç”Ÿå‘½è¯æ°´': '3ç“¶',
                    'é­”æ³•çŸ³': '5é¢—',
                    'é¢åŒ…': '7ä¸ª',
                    'é’¥åŒ™': 'ç¥ç§˜é’¥åŒ™ x1'
                }
            };

            const data = demoData[panelType] || panelData;

            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'demo-panel-popup';
            popup.style.setProperty('position', 'fixed', 'important');
            popup.style.setProperty('top', '0', 'important');
            popup.style.setProperty('left', '0', 'important');
            popup.style.setProperty('right', '0', 'important');
            popup.style.setProperty('bottom', '0', 'important');
            popup.style.setProperty('width', '100vw', 'important');
            popup.style.setProperty('height', '100vh', 'important');
            popup.style.setProperty('display', 'flex', 'important');
            popup.style.setProperty('align-items', 'center', 'important');
            popup.style.setProperty('justify-content', 'center', 'important');
            popup.style.setProperty('z-index', '10000', 'important');
            popup.style.setProperty('background', 'rgba(0,0,0,0.5)', 'important');

            const dataHtml = Object.entries(data)
                .map(([key, value]) => `
                    <div class="data-field">
                        <span class="field-name">${key}:</span>
                        <span class="field-value">${value}</span>
                    </div>
                `).join('');

            popup.innerHTML = `
                <div class="demo-popup-content" style="
                    background: var(--theme-bg-primary, #2a2a2a);
                    color: var(--theme-text-primary, #ffffff);
                    border: 1px solid var(--theme-border-color, rgba(255,255,255,0.1));
                    border-radius: 12px;
                    padding: 0;
                    min-width: 300px;
                    max-width: 90vw;
                    min-height: 200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    position: relative;
                    margin: 0;
                ">
                    <div class="popup-header">
                        <h3>${panelType === 'personal' ? 'ğŸ‘¤ ä¸ªäººä¿¡æ¯' :
                             panelType === 'inventory' ? 'ğŸ’ èƒŒåŒ…ä¿¡æ¯' : 'ğŸ“Š é¢æ¿ä¿¡æ¯'}</h3>
                        <button class="popup-close-btn">&times;</button>
                    </div>
                    <div class="popup-body">
                        ${dataHtml}
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const closeBtn = popup.querySelector('.popup-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    popup.remove();
                });
            }

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ¼”ç¤ºé¢æ¿å¼¹çª—å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢„è§ˆä½ç½®
     */
    updatePreviewPosition(position) {
        try {
            console.log(`[InfoBarSettings] ğŸ“ æ›´æ–°é¢„è§ˆä½ç½®: ${position}`);

            const previewContainer = this.modal?.querySelector('.frontend-preview-container');
            if (previewContainer) {
                previewContainer.setAttribute('data-position', position);
                console.log(`[InfoBarSettings] âœ… é¢„è§ˆä½ç½®å·²æ›´æ–°ä¸º: ${position}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢„è§ˆä½ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ›´æ–°é¢„è§ˆæ ·å¼
     */
    updatePreviewStyle(style) {
        try {
            console.log(`[InfoBarSettings] ğŸ¨ æ›´æ–°é¢„è§ˆæ ·å¼: ${style}`);

            const messageWrapper = this.modal?.querySelector('.ai-message-wrapper');
            if (messageWrapper) {
                // ç§»é™¤ç°æœ‰æ ·å¼ç±»
                messageWrapper.classList.remove('compact', 'comfortable', 'spacious');
                // æ·»åŠ æ–°æ ·å¼ç±»
                messageWrapper.classList.add(style);
                console.log(`[InfoBarSettings] âœ… é¢„è§ˆæ ·å¼å·²æ›´æ–°ä¸º: ${style}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°é¢„è§ˆæ ·å¼å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢æ·»åŠ æŒ‰é’®æ˜¾ç¤º
     */
    toggleAddButtons(show) {
        try {
            console.log(`[InfoBarSettings] â• åˆ‡æ¢æ·»åŠ æŒ‰é’®: ${show ? 'æ˜¾ç¤º' : 'éšè—'}`);

            const addSlots = this.modal?.querySelectorAll('.add-panel-slots');
            if (addSlots) {
                addSlots.forEach(slot => {
                    slot.style.display = show ? 'flex' : 'none';
                });
                console.log(`[InfoBarSettings] âœ… æ·»åŠ æŒ‰é’®å·²${show ? 'æ˜¾ç¤º' : 'éšè—'}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢æ·»åŠ æŒ‰é’®å¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
     */
    toggleAnimations(enabled) {
        try {
            console.log(`[InfoBarSettings] ğŸ¬ åˆ‡æ¢åŠ¨ç”»æ•ˆæœ: ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

            const previewContainer = this.modal?.querySelector('.frontend-preview-container');
            if (previewContainer) {
                previewContainer.setAttribute('data-animations', enabled);
                console.log(`[InfoBarSettings] âœ… åŠ¨ç”»æ•ˆæœå·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢åŠ¨ç”»æ•ˆæœå¤±è´¥:', error);
        }
    }
    /**
     * è·å–å¯ç”¨çš„é¢æ¿é…ç½®
     */
    getEnabledPanels() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            const enabledPanels = {};

            // åŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            basicPanelIds.forEach(panelId => {
                if (configs[panelId]) {
                    const panel = configs[panelId];
                    // é»˜è®¤ä¸ºtrueï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse
                    const isEnabled = panel.enabled !== false;

                    if (isEnabled) {
                        enabledPanels[panelId] = panel;
                    }
                }
            });

            // è‡ªå®šä¹‰é¢æ¿
            if (configs.customPanels) {
                Object.entries(configs.customPanels).forEach(([panelId, panelConfig]) => {
                    if (panelConfig && panelConfig.enabled) {
                        enabledPanels[panelId] = panelConfig;
                    }
                });
            }

            return enabledPanels;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨é¢æ¿å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * ç”Ÿæˆé¢æ¿åˆ—è¡¨HTML
     */
    generatePanelListHtml(enabledPanels) {
        try {
            const panelItems = [];
            let isFirst = true;

            for (const [panelId, panelConfig] of Object.entries(enabledPanels)) {
                // è·å–é¢æ¿æ˜¾ç¤ºä¿¡æ¯
                const panelInfo = this.getPanelDisplayInfo(panelId, panelConfig);

                panelItems.push(`
                    <div class="panel-nav-item ${isFirst ? 'active' : ''}" data-panel="${panelId}">
                        <span class="panel-name">${panelInfo.name}</span>
                        <button class="add-panel-btn" title="æ·»åŠ é¢æ¿">â•</button>
                    </div>
                `);

                isFirst = false;
            }

            return panelItems.join('');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆé¢æ¿åˆ—è¡¨HTMLå¤±è´¥:', error);
            return '';
        }
    }

    /**
     * ç”Ÿæˆå­é¡¹åˆ—è¡¨HTML
     */
    generateSubitemListHtml(panelId, panelConfig) {
        try {
            const panelInfo = this.getPanelDisplayInfo(panelId, panelConfig);
            const subItems = this.getEnabledSubItems(panelId, panelConfig);

            const subItemsHtml = subItems.map(subItem => `
                <div class="subitem-item" data-field="${subItem.key}">
                    <span class="subitem-label">${subItem.displayName}</span>
                    <button class="add-subitem-btn" title="æ·»åŠ å­é¡¹">â•</button>
                </div>
            `).join('');

            return `
                <h4>ğŸ”§ ${panelInfo.name} - å¯ç”¨çš„å­é¡¹ (${subItems.length})</h4>
                <div class="subitem-content">
                    ${subItemsHtml || '<div class="no-subitems">è¯¥é¢æ¿æ²¡æœ‰å¯ç”¨çš„å­é¡¹</div>'}
                </div>
            `;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆå­é¡¹åˆ—è¡¨HTMLå¤±è´¥:', error);
            return '<h4>é”™è¯¯ï¼šæ— æ³•åŠ è½½å­é¡¹</h4><div class="subitem-content"></div>';
        }
    }

    /**
     * è·å–é¢æ¿æ˜¾ç¤ºä¿¡æ¯ï¼ˆå›¾æ ‡å’Œåç§°ï¼‰
     */
    getPanelDisplayInfo(panelId, panelConfig) {
        // åŸºç¡€é¢æ¿çš„é»˜è®¤é…ç½®
        const basicPanelInfo = {
            personal: { icon: 'ğŸ‘¤', name: 'ä¸ªäººä¿¡æ¯' },
            world: { icon: 'ğŸŒ', name: 'ä¸–ç•Œä¿¡æ¯' },
            interaction: { icon: 'ğŸ¤', name: 'äº¤äº’å¯¹è±¡' },
            tasks: { icon: 'ğŸ“‹', name: 'ä»»åŠ¡ä¿¡æ¯' },
            organization: { icon: 'ğŸ¢', name: 'ç»„ç»‡ä¿¡æ¯' },
            news: { icon: 'ğŸ“°', name: 'æ–°é—»äº‹ä»¶' },
            inventory: { icon: 'ğŸ’', name: 'èƒŒåŒ…ç‰©å“' },
            abilities: { icon: 'âš¡', name: 'èƒ½åŠ›æŠ€èƒ½' },
            plot: { icon: 'ğŸ“–', name: 'å‰§æƒ…ä¿¡æ¯' },
            cultivation: { icon: 'ğŸ§˜', name: 'ä¿®ç‚¼ä¿¡æ¯' },
            fantasy: { icon: 'ğŸ‰', name: 'å¥‡å¹»è®¾å®š' },
            modern: { icon: 'ğŸ™ï¸', name: 'ç°ä»£è®¾å®š' },
            historical: { icon: 'ğŸ›ï¸', name: 'å†å²è®¾å®š' },
            magic: { icon: 'ğŸ”®', name: 'é­”æ³•ç³»ç»Ÿ' },
            training: { icon: 'ğŸ¯', name: 'è®­ç»ƒä¿¡æ¯' }
        };

        // å¦‚æœæ˜¯åŸºç¡€é¢æ¿ï¼Œä½¿ç”¨é¢„è®¾ä¿¡æ¯
        if (basicPanelInfo[panelId]) {
            return basicPanelInfo[panelId];
        }

        // è‡ªå®šä¹‰é¢æ¿ä½¿ç”¨é…ç½®ä¸­çš„ä¿¡æ¯
        return {
            icon: panelConfig.icon || 'ğŸ“„',
            name: panelConfig.name || panelId
        };
    }

    /**
     * è·å–é¢æ¿çš„å¯ç”¨å­é¡¹
     */
    getEnabledSubItems(panelId, panelConfig) {
        try {
            const subItems = [];

            // åˆ¤æ–­æ˜¯å¦ä¸ºåŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            if (basicPanelIds.includes(panelId)) {
                // åŸºç¡€é¢æ¿ï¼šå¤„ç†åŸºç¡€è®¾ç½®ä¸­çš„å¤é€‰æ¡†é…ç½®ï¼ˆpanel[key].enabledæ ¼å¼ï¼‰
                const subItemKeys = Object.keys(panelConfig).filter(key =>
                    key !== 'enabled' &&
                    key !== 'subItems' &&     // æ’é™¤è‡ªå®šä¹‰å­é¡¹æ•°ç»„
                    key !== 'description' &&  // æ’é™¤é¢æ¿å±æ€§
                    key !== 'icon' &&
                    key !== 'required' &&
                    key !== 'memoryInject' &&
                    key !== 'prompts' &&
                    typeof panelConfig[key] === 'object' &&
                    panelConfig[key].enabled !== undefined
                );

                const enabledSubItems = subItemKeys.filter(key => panelConfig[key].enabled === true);

                // æ·»åŠ åŸºç¡€è®¾ç½®çš„å­é¡¹
                enabledSubItems.forEach(key => {
                    subItems.push({
                        key: key,
                        displayName: panelConfig[key].name || this.getBasicSubItemDisplayName(panelId, key),
                        source: 'basicSettings'
                    });
                });

                // å¤„ç†åŸºç¡€é¢æ¿çš„è‡ªå®šä¹‰å­é¡¹ï¼ˆä»é¢æ¿ç®¡ç†æ·»åŠ çš„ï¼‰
                if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.enabled !== false) {
                            subItems.push({
                                key: subItem.key,
                                displayName: subItem.displayName || subItem.name,
                                source: 'panelManagement'
                            });
                        }
                    });
                }
            } else {
                // è‡ªå®šä¹‰é¢æ¿ï¼šå¤„ç†è‡ªå®šä¹‰é¢æ¿çš„å­é¡¹
                if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.enabled !== false) {
                            subItems.push({
                                key: subItem.key,
                                displayName: subItem.displayName || subItem.name || subItem.key,
                                source: 'customPanel'
                            });
                        }
                    });
                }
            }

            console.log(`[InfoBarSettings] ğŸ“Š é¢æ¿ ${panelId}: ${subItems.length} ä¸ªå¯ç”¨çš„å­é¡¹`, subItems.map(s => `${s.displayName}(${s.source})`));
            return subItems;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨å­é¡¹å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * è·å–åŸºç¡€å­é¡¹æ˜¾ç¤ºåç§° - ä¸æ•°æ®è¡¨æ ¼å®Œå…¨ä¸€è‡´çš„å®Œæ•´æ˜ å°„
     */
    getBasicSubItemDisplayName(panelId, key) {
        // ä¸DataTable.jså®Œå…¨ä¸€è‡´çš„å®Œæ•´ä¸­æ–‡æ˜ å°„è¡¨
        return this.getDataTableDisplayName(panelId, key);
    }

    /**
     * è·å–æ•°æ®è¡¨æ ¼æ˜¾ç¤ºåç§° - å®Œæ•´çš„ä¸­æ–‡æ˜ å°„å®ç°
     */
    getDataTableDisplayName(panelType, key) {
        const displayNames = this.getCompleteDisplayNameMapping();
        return displayNames[panelType]?.[key] || key;
    }

    /**
     * é¢„åŠ è½½å®Œæ•´çš„æ˜¾ç¤ºåç§°æ˜ å°„è¡¨ - ğŸ”§ æ–°å¢ï¼šé¿å…è¿è¡Œæ—¶é‡å¤ç”Ÿæˆ
     */
    preloadCompleteDisplayNameMapping() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ é¢„åŠ è½½å­—æ®µæ˜ å°„ç¼“å­˜...');
            this.getCompleteDisplayNameMapping();
            console.log('[InfoBarSettings] âœ… å­—æ®µæ˜ å°„ç¼“å­˜é¢„åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ é¢„åŠ è½½å­—æ®µæ˜ å°„ç¼“å­˜å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å®Œæ•´çš„æ˜¾ç¤ºåç§°æ˜ å°„è¡¨ - ğŸ”§ ä¿®å¤ï¼šåŒæ—¶æ”¯æŒè‹±æ–‡å’Œä¸­æ–‡å­—æ®µåæ˜ å°„
     */
    getCompleteDisplayNameMapping() {
        // ğŸ”§ æ–°å¢ï¼šç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤ç”Ÿæˆæ˜ å°„
        if (this._cachedCompleteMapping) {
            return this._cachedCompleteMapping;
        }

        // åŸºç¡€é¢æ¿æ˜ å°„
        const baseMapping = {
            personal: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å§“å', 'age': 'å¹´é¾„', 'gender': 'æ€§åˆ«', 'occupation': 'èŒä¸š',
                'height': 'èº«é«˜', 'weight': 'ä½“é‡', 'bloodType': 'è¡€å‹', 'zodiac': 'æ˜Ÿåº§',
                'birthday': 'ç”Ÿæ—¥', 'birthplace': 'å‡ºç”Ÿåœ°', 'nationality': 'å›½ç±', 'ethnicity': 'æ°‘æ—',
                'hairColor': 'å‘è‰²', 'hairStyle': 'å‘å‹', 'eyeColor': 'çœ¼è‰²', 'skinColor': 'è‚¤è‰²',
                'bodyType': 'ä½“å‹', 'facialFeatures': 'é¢éƒ¨ç‰¹å¾', 'scars': 'ç–¤ç—•', 'tattoos': 'çº¹èº«',
                'accessories': 'é…é¥°', 'clothingStyle': 'ç©¿ç€é£æ ¼', 'appearance': 'å¤–è²Œ', 'voice': 'å£°éŸ³',
                'personality': 'æ€§æ ¼', 'temperament': 'æ€§æƒ…', 'attitude': 'æ€åº¦', 'values': 'ä»·å€¼è§‚',
                'beliefs': 'ä¿¡å¿µ', 'fears': 'ææƒ§', 'dreams': 'æ¢¦æƒ³', 'goals': 'äººç”Ÿç›®æ ‡',
                'intelligence': 'æ™ºåŠ›', 'strength': 'åŠ›é‡', 'charisma': 'é­…åŠ›', 'luck': 'è¿æ°”',
                'perception': 'æ„ŸçŸ¥', 'willpower': 'æ„å¿—åŠ›', 'reactionSpeed': 'ååº”é€Ÿåº¦', 'learningAbility': 'å­¦ä¹ èƒ½åŠ›',
                'familyBackground': 'å®¶åº­èƒŒæ™¯', 'education': 'æ•™è‚²ç»å†', 'workExperience': 'å·¥ä½œç»å†', 'income': 'æ”¶å…¥',
                'socialStatus': 'ç¤¾ä¼šåœ°ä½', 'relationships': 'äººé™…å…³ç³»', 'loveStatus': 'æ‹çˆ±çŠ¶æ€', 'maritalStatus': 'å©šå§»çŠ¶æ€',
                'hobbies': 'çˆ±å¥½', 'sports': 'è¿åŠ¨', 'music': 'éŸ³ä¹', 'art': 'è‰ºæœ¯',
                'reading': 'é˜…è¯»', 'gaming': 'æ¸¸æˆ', 'travel': 'æ—…è¡Œ', 'cooking': 'çƒ¹é¥ª',
                'skills': 'æŠ€èƒ½ç‰¹é•¿', 'languages': 'è¯­è¨€èƒ½åŠ›', 'habits': 'ç”Ÿæ´»ä¹ æƒ¯', 'healthStatus': 'å¥åº·çŠ¶æ€',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å§“å': 'å§“å', 'å¹´é¾„': 'å¹´é¾„', 'æ€§åˆ«': 'æ€§åˆ«', 'èŒä¸š': 'èŒä¸š',
                'èº«é«˜': 'èº«é«˜', 'ä½“é‡': 'ä½“é‡', 'è¡€å‹': 'è¡€å‹', 'æ˜Ÿåº§': 'æ˜Ÿåº§',
                'ç”Ÿæ—¥': 'ç”Ÿæ—¥', 'å‡ºç”Ÿåœ°': 'å‡ºç”Ÿåœ°', 'å›½ç±': 'å›½ç±', 'æ°‘æ—': 'æ°‘æ—',
                'å‘è‰²': 'å‘è‰²', 'å‘å‹': 'å‘å‹', 'çœ¼è‰²': 'çœ¼è‰²', 'è‚¤è‰²': 'è‚¤è‰²',
                'ä½“å‹': 'ä½“å‹', 'é¢éƒ¨ç‰¹å¾': 'é¢éƒ¨ç‰¹å¾', 'ç–¤ç—•': 'ç–¤ç—•', 'çº¹èº«': 'çº¹èº«',
                'é…é¥°': 'é…é¥°', 'ç©¿ç€é£æ ¼': 'ç©¿ç€é£æ ¼', 'å¤–è²Œ': 'å¤–è²Œ', 'å£°éŸ³': 'å£°éŸ³',
                'æ€§æ ¼': 'æ€§æ ¼', 'æ€§æƒ…': 'æ€§æƒ…', 'æ€åº¦': 'æ€åº¦', 'ä»·å€¼è§‚': 'ä»·å€¼è§‚',
                'ä¿¡å¿µ': 'ä¿¡å¿µ', 'ææƒ§': 'ææƒ§', 'æ¢¦æƒ³': 'æ¢¦æƒ³', 'äººç”Ÿç›®æ ‡': 'äººç”Ÿç›®æ ‡',
                'æ™ºåŠ›': 'æ™ºåŠ›', 'åŠ›é‡': 'åŠ›é‡', 'é­…åŠ›': 'é­…åŠ›', 'è¿æ°”': 'è¿æ°”',
                'æ„ŸçŸ¥': 'æ„ŸçŸ¥', 'æ„å¿—åŠ›': 'æ„å¿—åŠ›', 'ååº”é€Ÿåº¦': 'ååº”é€Ÿåº¦', 'å­¦ä¹ èƒ½åŠ›': 'å­¦ä¹ èƒ½åŠ›',
                'å®¶åº­èƒŒæ™¯': 'å®¶åº­èƒŒæ™¯', 'æ•™è‚²ç»å†': 'æ•™è‚²ç»å†', 'å·¥ä½œç»å†': 'å·¥ä½œç»å†', 'æ”¶å…¥': 'æ”¶å…¥',
                'ç¤¾ä¼šåœ°ä½': 'ç¤¾ä¼šåœ°ä½', 'äººé™…å…³ç³»': 'äººé™…å…³ç³»', 'æ‹çˆ±çŠ¶æ€': 'æ‹çˆ±çŠ¶æ€', 'å©šå§»çŠ¶æ€': 'å©šå§»çŠ¶æ€',
                'çˆ±å¥½': 'çˆ±å¥½', 'è¿åŠ¨': 'è¿åŠ¨', 'éŸ³ä¹': 'éŸ³ä¹', 'è‰ºæœ¯': 'è‰ºæœ¯',
                'é˜…è¯»': 'é˜…è¯»', 'æ¸¸æˆ': 'æ¸¸æˆ', 'æ—…è¡Œ': 'æ—…è¡Œ', 'çƒ¹é¥ª': 'çƒ¹é¥ª',
                'æŠ€èƒ½ç‰¹é•¿': 'æŠ€èƒ½ç‰¹é•¿', 'è¯­è¨€èƒ½åŠ›': 'è¯­è¨€èƒ½åŠ›', 'ç”Ÿæ´»ä¹ æƒ¯': 'ç”Ÿæ´»ä¹ æƒ¯', 'å¥åº·çŠ¶æ€': 'å¥åº·çŠ¶æ€',
                'ç§æ—': 'ç§æ—', 'èŒä¸šç±»åˆ«': 'èŒä¸šç±»åˆ«'
            },
            world: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ä¸–ç•Œåç§°', 'type': 'ä¸–ç•Œç±»å‹', 'genre': 'ä¸–ç•Œé£æ ¼', 'theme': 'ä¸–ç•Œä¸»é¢˜',
                'history': 'ä¸–ç•Œå†å²', 'mythology': 'ç¥è¯ä¼ è¯´', 'lore': 'ä¸–ç•Œè®¾å®š',
                'geography': 'åœ°ç†ç¯å¢ƒ', 'climate': 'æ°”å€™æ¡ä»¶', 'terrain': 'åœ°å½¢åœ°è²Œ', 'biomes': 'ç”Ÿç‰©ç¾¤è½',
                'locations': 'é‡è¦åœ°ç‚¹', 'landmarks': 'åœ°æ ‡å»ºç­‘', 'cities': 'åŸå¸‚è®¾å®š', 'dungeons': 'åœ°ä¸‹åŸ',
                'time': 'æ—¶é—´è®¾å®š', 'calendar': 'å†æ³•ç³»ç»Ÿ', 'seasons': 'å­£èŠ‚å˜åŒ–', 'dayNight': 'æ˜¼å¤œå¾ªç¯',
                'weather': 'å¤©æ°”ç³»ç»Ÿ', 'events': 'ä¸–ç•Œäº‹ä»¶', 'festivals': 'èŠ‚æ—¥åº†å…¸', 'disasters': 'è‡ªç„¶ç¾å®³',
                'cultures': 'æ–‡åŒ–è®¾å®š', 'languages': 'è¯­è¨€ç³»ç»Ÿ', 'religions': 'å®—æ•™ä¿¡ä»°', 'customs': 'é£ä¿—ä¹ æƒ¯',
                'politics': 'æ”¿æ²»ä½“ç³»', 'economy': 'ç»æµç³»ç»Ÿ', 'technology': 'ç§‘æŠ€æ°´å¹³', 'magic': 'é­”æ³•ç³»ç»Ÿ',
                'races': 'ç§æ—è®¾å®š', 'creatures': 'ç”Ÿç‰©è®¾å®š', 'monsters': 'æ€ªç‰©è®¾å®š', 'npcs': 'NPCè®¾å®š',
                'factions': 'åŠ¿åŠ›ç»„ç»‡', 'conflicts': 'å†²çªçŸ›ç›¾', 'alliances': 'è”ç›Ÿå…³ç³»', 'wars': 'æˆ˜äº‰å†å²',
                'resources': 'èµ„æºåˆ†å¸ƒ', 'materials': 'ææ–™è®¾å®š', 'artifacts': 'ç¥å™¨æ–‡ç‰©', 'currency': 'è´§å¸ç³»ç»Ÿ',
                'trade': 'è´¸æ˜“ä½“ç³»', 'markets': 'å¸‚åœºè®¾å®š', 'guilds': 'å…¬ä¼šç»„ç»‡', 'transportation': 'äº¤é€šè¿è¾“',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸–ç•Œåç§°': 'ä¸–ç•Œåç§°', 'ä¸–ç•Œç±»å‹': 'ä¸–ç•Œç±»å‹', 'ä¸–ç•Œé£æ ¼': 'ä¸–ç•Œé£æ ¼', 'ä¸–ç•Œä¸»é¢˜': 'ä¸–ç•Œä¸»é¢˜',
                'ä¸–ç•Œæè¿°': 'ä¸–ç•Œæè¿°', 'ä¸–ç•Œå†å²': 'ä¸–ç•Œå†å²', 'ç¥è¯ä¼ è¯´': 'ç¥è¯ä¼ è¯´', 'ä¸–ç•Œè®¾å®š': 'ä¸–ç•Œè®¾å®š',
                'åœ°ç†ç¯å¢ƒ': 'åœ°ç†ç¯å¢ƒ', 'æ°”å€™æ¡ä»¶': 'æ°”å€™æ¡ä»¶', 'åœ°å½¢åœ°è²Œ': 'åœ°å½¢åœ°è²Œ', 'ç”Ÿç‰©ç¾¤è½': 'ç”Ÿç‰©ç¾¤è½',
                'é‡è¦åœ°ç‚¹': 'é‡è¦åœ°ç‚¹', 'åœ°æ ‡å»ºç­‘': 'åœ°æ ‡å»ºç­‘', 'åŸå¸‚è®¾å®š': 'åŸå¸‚è®¾å®š', 'åœ°ä¸‹åŸ': 'åœ°ä¸‹åŸ',
                'æ—¶é—´è®¾å®š': 'æ—¶é—´è®¾å®š', 'å†æ³•ç³»ç»Ÿ': 'å†æ³•ç³»ç»Ÿ', 'å­£èŠ‚å˜åŒ–': 'å­£èŠ‚å˜åŒ–', 'æ˜¼å¤œå¾ªç¯': 'æ˜¼å¤œå¾ªç¯',
                'å¤©æ°”ç³»ç»Ÿ': 'å¤©æ°”ç³»ç»Ÿ', 'ä¸–ç•Œäº‹ä»¶': 'ä¸–ç•Œäº‹ä»¶', 'èŠ‚æ—¥åº†å…¸': 'èŠ‚æ—¥åº†å…¸', 'è‡ªç„¶ç¾å®³': 'è‡ªç„¶ç¾å®³',
                'æ–‡åŒ–è®¾å®š': 'æ–‡åŒ–è®¾å®š', 'è¯­è¨€ç³»ç»Ÿ': 'è¯­è¨€ç³»ç»Ÿ', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'é£ä¿—ä¹ æƒ¯': 'é£ä¿—ä¹ æƒ¯',
                'æ”¿æ²»ä½“ç³»': 'æ”¿æ²»ä½“ç³»', 'ç»æµç³»ç»Ÿ': 'ç»æµç³»ç»Ÿ', 'ç§‘æŠ€æ°´å¹³': 'ç§‘æŠ€æ°´å¹³', 'é­”æ³•ç³»ç»Ÿ': 'é­”æ³•ç³»ç»Ÿ',
                'ç§æ—è®¾å®š': 'ç§æ—è®¾å®š', 'ç”Ÿç‰©è®¾å®š': 'ç”Ÿç‰©è®¾å®š', 'æ€ªç‰©è®¾å®š': 'æ€ªç‰©è®¾å®š', 'NPCè®¾å®š': 'NPCè®¾å®š',
                'åŠ¿åŠ›ç»„ç»‡': 'åŠ¿åŠ›ç»„ç»‡', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾', 'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'æˆ˜äº‰å†å²': 'æˆ˜äº‰å†å²',
                'èµ„æºåˆ†å¸ƒ': 'èµ„æºåˆ†å¸ƒ', 'ææ–™è®¾å®š': 'ææ–™è®¾å®š', 'ç¥å™¨æ–‡ç‰©': 'ç¥å™¨æ–‡ç‰©', 'è´§å¸ç³»ç»Ÿ': 'è´§å¸ç³»ç»Ÿ',
                'è´¸æ˜“ä½“ç³»': 'è´¸æ˜“ä½“ç³»', 'å¸‚åœºè®¾å®š': 'å¸‚åœºè®¾å®š', 'å…¬ä¼šç»„ç»‡': 'å…¬ä¼šç»„ç»‡', 'äº¤é€šè¿è¾“': 'äº¤é€šè¿è¾“',
                'ä½ç½®': 'ä½ç½®', 'ç¯å¢ƒ': 'ç¯å¢ƒ', 'æ°›å›´': 'æ°›å›´', 'å­£èŠ‚': 'å­£èŠ‚',
                'æ–‡åŒ–': 'æ–‡åŒ–'
            },
            interaction: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'å¯¹è±¡åç§°', 'type': 'å¯¹è±¡ç±»å‹', 'status': 'å½“å‰çŠ¶æ€', 'location': 'æ‰€åœ¨ä½ç½®',
                'mood': 'æƒ…ç»ªçŠ¶æ€', 'activity': 'å½“å‰æ´»åŠ¨', 'availability': 'å¯ç”¨æ€§', 'priority': 'ä¼˜å…ˆçº§',
                'relationship': 'å…³ç³»ç±»å‹', 'intimacy': 'äº²å¯†åº¦', 'trust': 'ä¿¡ä»»åº¦', 'friendship': 'å‹è°Šåº¦',
                'romance': 'æµªæ¼«åº¦', 'respect': 'å°Šé‡åº¦', 'dependency': 'ä¾èµ–åº¦', 'conflict': 'å†²çªåº¦',
                'history': 'å†å²è®°å½•', 'frequency': 'äº’åŠ¨é¢‘ç‡', 'duration': 'äº’åŠ¨æ—¶é•¿', 'quality': 'äº’åŠ¨è´¨é‡',
                'topics': 'è¯é¢˜åå¥½', 'emotions': 'æƒ…æ„ŸçŠ¶æ€', 'milestones': 'é‡è¦èŠ‚ç‚¹', 'memories': 'å…±åŒå›å¿†',
                'autoRecord': 'è‡ªåŠ¨è®°å½•', 'notifications': 'é€šçŸ¥è®¾ç½®', 'analysis': 'å…³ç³»åˆ†æ', 'suggestions': 'å»ºè®®æç¤º',
                'network': 'ç¤¾äº¤ç½‘ç»œ', 'groups': 'ç¾¤ä½“å…³ç³»', 'influence': 'å½±å“åŠ›', 'reputation': 'å£°èª‰åº¦',
                'alliances': 'è”ç›Ÿå…³ç³»', 'rivalries': 'ç«äº‰å…³ç³»', 'mentorship': 'å¸ˆå¾’å…³ç³»', 'hierarchy': 'ç­‰çº§å…³ç³»',
                'communicationStyle': 'æ²Ÿé€šé£æ ¼', 'preferredTopics': 'åå¥½è¯é¢˜', 'avoidedTopics': 'å›é¿è¯é¢˜', 'boundaries': 'è¾¹ç•Œè®¾å®š',
                'comfortLevel': 'èˆ’é€‚åº¦', 'energyLevel': 'æ´»è·ƒåº¦', 'responseTime': 'å“åº”æ—¶é—´', 'engagement': 'å‚ä¸åº¦',
                'specialEvents': 'ç‰¹æ®Šäº‹ä»¶', 'achievements': 'æˆå°±è®°å½•', 'challenges': 'æŒ‘æˆ˜ä»»åŠ¡', 'growth': 'æˆé•¿è½¨è¿¹',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¯¹è±¡åç§°': 'å¯¹è±¡åç§°', 'å¯¹è±¡ç±»å‹': 'å¯¹è±¡ç±»å‹', 'å½“å‰çŠ¶æ€': 'å½“å‰çŠ¶æ€', 'æ‰€åœ¨ä½ç½®': 'æ‰€åœ¨ä½ç½®',
                'æƒ…ç»ªçŠ¶æ€': 'æƒ…ç»ªçŠ¶æ€', 'å½“å‰æ´»åŠ¨': 'å½“å‰æ´»åŠ¨', 'å¯ç”¨æ€§': 'å¯ç”¨æ€§', 'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§',
                'å…³ç³»ç±»å‹': 'å…³ç³»ç±»å‹', 'äº²å¯†åº¦': 'äº²å¯†åº¦', 'ä¿¡ä»»åº¦': 'ä¿¡ä»»åº¦', 'å‹è°Šåº¦': 'å‹è°Šåº¦',
                'æµªæ¼«åº¦': 'æµªæ¼«åº¦', 'å°Šé‡åº¦': 'å°Šé‡åº¦', 'ä¾èµ–åº¦': 'ä¾èµ–åº¦', 'å†²çªåº¦': 'å†²çªåº¦',
                'å†å²è®°å½•': 'å†å²è®°å½•', 'äº’åŠ¨é¢‘ç‡': 'äº’åŠ¨é¢‘ç‡', 'äº’åŠ¨æ—¶é•¿': 'äº’åŠ¨æ—¶é•¿', 'äº’åŠ¨è´¨é‡': 'äº’åŠ¨è´¨é‡',
                'è¯é¢˜åå¥½': 'è¯é¢˜åå¥½', 'æƒ…æ„ŸçŠ¶æ€': 'æƒ…æ„ŸçŠ¶æ€', 'é‡è¦èŠ‚ç‚¹': 'é‡è¦èŠ‚ç‚¹', 'å…±åŒå›å¿†': 'å…±åŒå›å¿†',
                'è‡ªåŠ¨è®°å½•': 'è‡ªåŠ¨è®°å½•', 'é€šçŸ¥è®¾ç½®': 'é€šçŸ¥è®¾ç½®', 'å…³ç³»åˆ†æ': 'å…³ç³»åˆ†æ', 'å»ºè®®æç¤º': 'å»ºè®®æç¤º',
                'ç¤¾äº¤ç½‘ç»œ': 'ç¤¾äº¤ç½‘ç»œ', 'ç¾¤ä½“å…³ç³»': 'ç¾¤ä½“å…³ç³»', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å£°èª‰åº¦': 'å£°èª‰åº¦',
                'è”ç›Ÿå…³ç³»': 'è”ç›Ÿå…³ç³»', 'ç«äº‰å…³ç³»': 'ç«äº‰å…³ç³»', 'å¸ˆå¾’å…³ç³»': 'å¸ˆå¾’å…³ç³»', 'ç­‰çº§å…³ç³»': 'ç­‰çº§å…³ç³»',
                'æ²Ÿé€šé£æ ¼': 'æ²Ÿé€šé£æ ¼', 'åå¥½è¯é¢˜': 'åå¥½è¯é¢˜', 'å›é¿è¯é¢˜': 'å›é¿è¯é¢˜', 'è¾¹ç•Œè®¾å®š': 'è¾¹ç•Œè®¾å®š',
                'èˆ’é€‚åº¦': 'èˆ’é€‚åº¦', 'æ´»è·ƒåº¦': 'æ´»è·ƒåº¦', 'å“åº”æ—¶é—´': 'å“åº”æ—¶é—´', 'å‚ä¸åº¦': 'å‚ä¸åº¦',
                'ç‰¹æ®Šäº‹ä»¶': 'ç‰¹æ®Šäº‹ä»¶', 'æˆå°±è®°å½•': 'æˆå°±è®°å½•', 'æŒ‘æˆ˜ä»»åŠ¡': 'æŒ‘æˆ˜ä»»åŠ¡', 'æˆé•¿è½¨è¿¹': 'æˆé•¿è½¨è¿¹',
                'NPCå§“å': 'NPCå§“å', 'NPCæ€§æ ¼': 'NPCæ€§æ ¼', 'NPCçŠ¶æ€': 'NPCçŠ¶æ€',
                'æ€åº¦': 'æ€åº¦', 'å¯¹è¯ä¸»é¢˜': 'å¯¹è¯ä¸»é¢˜', 'äº¤äº’å†å²': 'äº¤äº’å†å²',
                'å¥½æ„Ÿåº¦': 'å¥½æ„Ÿåº¦', 'ç¤¾äº¤èƒŒæ™¯': 'ç¤¾äº¤èƒŒæ™¯'
            },
            tasks: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'creation': 'ä»»åŠ¡åˆ›å»º', 'editing': 'ä»»åŠ¡ç¼–è¾‘', 'deletion': 'ä»»åŠ¡åˆ é™¤', 'completion': 'ä»»åŠ¡å®Œæˆ',
                'priority': 'ä¼˜å…ˆçº§', 'deadline': 'æˆªæ­¢æ—¥æœŸ', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'status': 'çŠ¶æ€ç®¡ç†',
                'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ', 'projects': 'é¡¹ç›®ç®¡ç†', 'milestones': 'é‡Œç¨‹ç¢‘',
                'subtasks': 'å­ä»»åŠ¡', 'dependencies': 'ä¾èµ–å…³ç³»', 'templates': 'ä»»åŠ¡æ¨¡æ¿', 'recurring': 'é‡å¤ä»»åŠ¡',
                'notifications': 'é€šçŸ¥æé†’', 'reminders': 'æé†’è®¾ç½®', 'alerts': 'è­¦æŠ¥é€šçŸ¥', 'dailySummary': 'æ¯æ—¥æ€»ç»“',
                'weeklyReview': 'å‘¨æŠ¥å›é¡¾', 'achievementBadges': 'æˆå°±å¾½ç« ', 'productivityStats': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'timeTracking': 'æ—¶é—´è·Ÿè¸ª',
                'assignment': 'ä»»åŠ¡åˆ†é…', 'collaboration': 'åä½œåŠŸèƒ½', 'comments': 'è¯„è®ºç³»ç»Ÿ', 'attachments': 'é™„ä»¶ç®¡ç†',
                'sharing': 'å…±äº«åŠŸèƒ½', 'permissions': 'æƒé™ç®¡ç†', 'approval': 'å®¡æ‰¹æµç¨‹', 'delegation': 'ä»»åŠ¡å§”æ´¾',
                'listView': 'åˆ—è¡¨è§†å›¾', 'kanbanView': 'çœ‹æ¿è§†å›¾', 'calendarView': 'æ—¥å†è§†å›¾', 'ganttView': 'ç”˜ç‰¹å›¾',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'search': 'æœç´¢åŠŸèƒ½', 'grouping': 'åˆ†ç»„åŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',
                'archive': 'å½’æ¡£ç®¡ç†', 'history': 'å†å²è®°å½•', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶', 'recovery': 'æ¢å¤åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä»»åŠ¡åˆ›å»º': 'ä»»åŠ¡åˆ›å»º', 'ä»»åŠ¡ç¼–è¾‘': 'ä»»åŠ¡ç¼–è¾‘', 'ä»»åŠ¡åˆ é™¤': 'ä»»åŠ¡åˆ é™¤', 'ä»»åŠ¡å®Œæˆ': 'ä»»åŠ¡å®Œæˆ',
                'ä¼˜å…ˆçº§': 'ä¼˜å…ˆçº§', 'æˆªæ­¢æ—¥æœŸ': 'æˆªæ­¢æ—¥æœŸ', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'çŠ¶æ€ç®¡ç†': 'çŠ¶æ€ç®¡ç†',
                'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ', 'é¡¹ç›®ç®¡ç†': 'é¡¹ç›®ç®¡ç†', 'é‡Œç¨‹ç¢‘': 'é‡Œç¨‹ç¢‘',
                'å­ä»»åŠ¡': 'å­ä»»åŠ¡', 'ä¾èµ–å…³ç³»': 'ä¾èµ–å…³ç³»', 'ä»»åŠ¡æ¨¡æ¿': 'ä»»åŠ¡æ¨¡æ¿', 'é‡å¤ä»»åŠ¡': 'é‡å¤ä»»åŠ¡',
                'é€šçŸ¥æé†’': 'é€šçŸ¥æé†’', 'æé†’è®¾ç½®': 'æé†’è®¾ç½®', 'è­¦æŠ¥é€šçŸ¥': 'è­¦æŠ¥é€šçŸ¥', 'æ¯æ—¥æ€»ç»“': 'æ¯æ—¥æ€»ç»“',
                'å‘¨æŠ¥å›é¡¾': 'å‘¨æŠ¥å›é¡¾', 'æˆå°±å¾½ç« ': 'æˆå°±å¾½ç« ', 'ç”Ÿäº§åŠ›ç»Ÿè®¡': 'ç”Ÿäº§åŠ›ç»Ÿè®¡', 'æ—¶é—´è·Ÿè¸ª': 'æ—¶é—´è·Ÿè¸ª',
                'ä»»åŠ¡åˆ†é…': 'ä»»åŠ¡åˆ†é…', 'åä½œåŠŸèƒ½': 'åä½œåŠŸèƒ½', 'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'é™„ä»¶ç®¡ç†': 'é™„ä»¶ç®¡ç†',
                'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'æƒé™ç®¡ç†': 'æƒé™ç®¡ç†', 'å®¡æ‰¹æµç¨‹': 'å®¡æ‰¹æµç¨‹', 'ä»»åŠ¡å§”æ´¾': 'ä»»åŠ¡å§”æ´¾',
                'åˆ—è¡¨è§†å›¾': 'åˆ—è¡¨è§†å›¾', 'çœ‹æ¿è§†å›¾': 'çœ‹æ¿è§†å›¾', 'æ—¥å†è§†å›¾': 'æ—¥å†è§†å›¾', 'ç”˜ç‰¹å›¾': 'ç”˜ç‰¹å›¾',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'æœç´¢åŠŸèƒ½': 'æœç´¢åŠŸèƒ½', 'åˆ†ç»„åŠŸèƒ½': 'åˆ†ç»„åŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½',
                'å½’æ¡£ç®¡ç†': 'å½’æ¡£ç®¡ç†', 'å†å²è®°å½•': 'å†å²è®°å½•', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶', 'æ¢å¤åŠŸèƒ½': 'æ¢å¤åŠŸèƒ½'
            },
            organization: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'name': 'ç»„ç»‡åç§°', 'type': 'ç»„ç»‡ç±»å‹', 'purpose': 'ç»„ç»‡æè¿°', 'history': 'ç»„ç»‡å†å²',
                'founding': 'æˆç«‹èƒŒæ™¯', 'motto': 'ç»„ç»‡æ ¼è¨€', 'values': 'æ ¸å¿ƒä»·å€¼',
                'hierarchy': 'å±‚çº§ç»“æ„', 'departments': 'éƒ¨é—¨è®¾ç½®', 'leadership': 'é¢†å¯¼å±‚', 'council': 'ç†äº‹ä¼š',
                'positions': 'èŒä½è®¾ç½®', 'ranks': 'ç­‰çº§åˆ¶åº¦', 'promotion': 'æ™‹å‡æœºåˆ¶', 'authority': 'æƒé™åˆ†é…',
                'members': 'æˆå‘˜ç®¡ç†', 'recruitment': 'æ‹›å‹Ÿåˆ¶åº¦', 'training': 'åŸ¹è®­ä½“ç³»', 'evaluation': 'è€ƒæ ¸è¯„ä¼°',
                'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šåˆ¶åº¦', 'benefits': 'ç¦åˆ©å¾…é‡', 'retirement': 'é€€ä¼‘åˆ¶åº¦',
                'rules': 'ç»„ç»‡è§„åˆ™', 'code': 'è¡Œä¸ºå‡†åˆ™', 'ethics': 'é“å¾·è§„èŒƒ', 'discipline': 'çºªå¾‹åˆ¶åº¦',
                'procedures': 'æ“ä½œæµç¨‹', 'protocols': 'åè®®è§„èŒƒ', 'standards': 'æ ‡å‡†åˆ¶åº¦', 'compliance': 'åˆè§„ç®¡ç†',
                'allies': 'ç›Ÿå‹å…³ç³»', 'enemies': 'æ•Œå¯¹å…³ç³»', 'neutral': 'ä¸­ç«‹å…³ç³»', 'partnerships': 'åˆä½œä¼™ä¼´',
                'reputation': 'ç»„ç»‡å£°èª‰', 'influence': 'å½±å“åŠ›', 'diplomacy': 'å¤–äº¤å…³ç³»', 'treaties': 'æ¡çº¦åè®®',
                'finances': 'è´¢åŠ¡çŠ¶å†µ', 'assets': 'èµ„äº§ç®¡ç†', 'facilities': 'è®¾æ–½è®¾å¤‡', 'equipment': 'è£…å¤‡å™¨æ',
                'technology': 'æŠ€æœ¯èµ„æº', 'knowledge': 'çŸ¥è¯†åº“', 'archives': 'æ¡£æ¡ˆç®¡ç†', 'secrets': 'æœºå¯†ä¿¡æ¯',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç»„ç»‡åç§°': 'ç»„ç»‡åç§°', 'ç»„ç»‡ç±»å‹': 'ç»„ç»‡ç±»å‹', 'ç»„ç»‡æè¿°': 'ç»„ç»‡æè¿°', 'ç»„ç»‡ç›®æ ‡': 'ç»„ç»‡ç›®æ ‡',
                'ç»„ç»‡å†å²': 'ç»„ç»‡å†å²', 'æˆç«‹èƒŒæ™¯': 'æˆç«‹èƒŒæ™¯', 'ç»„ç»‡æ ¼è¨€': 'ç»„ç»‡æ ¼è¨€', 'æ ¸å¿ƒä»·å€¼': 'æ ¸å¿ƒä»·å€¼',
                'å±‚çº§ç»“æ„': 'å±‚çº§ç»“æ„', 'éƒ¨é—¨è®¾ç½®': 'éƒ¨é—¨è®¾ç½®', 'é¢†å¯¼å±‚': 'é¢†å¯¼å±‚', 'ç†äº‹ä¼š': 'ç†äº‹ä¼š',
                'èŒä½è®¾ç½®': 'èŒä½è®¾ç½®', 'ç­‰çº§åˆ¶åº¦': 'ç­‰çº§åˆ¶åº¦', 'æ™‹å‡æœºåˆ¶': 'æ™‹å‡æœºåˆ¶', 'æƒé™åˆ†é…': 'æƒé™åˆ†é…',
                'æˆå‘˜ç®¡ç†': 'æˆå‘˜ç®¡ç†', 'æ‹›å‹Ÿåˆ¶åº¦': 'æ‹›å‹Ÿåˆ¶åº¦', 'åŸ¹è®­ä½“ç³»': 'åŸ¹è®­ä½“ç³»', 'è€ƒæ ¸è¯„ä¼°': 'è€ƒæ ¸è¯„ä¼°',
                'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šåˆ¶åº¦': 'æƒ©ç½šåˆ¶åº¦', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'é€€ä¼‘åˆ¶åº¦': 'é€€ä¼‘åˆ¶åº¦',
                'ç»„ç»‡è§„åˆ™': 'ç»„ç»‡è§„åˆ™', 'è¡Œä¸ºå‡†åˆ™': 'è¡Œä¸ºå‡†åˆ™', 'é“å¾·è§„èŒƒ': 'é“å¾·è§„èŒƒ', 'çºªå¾‹åˆ¶åº¦': 'çºªå¾‹åˆ¶åº¦',
                'æ“ä½œæµç¨‹': 'æ“ä½œæµç¨‹', 'åè®®è§„èŒƒ': 'åè®®è§„èŒƒ', 'æ ‡å‡†åˆ¶åº¦': 'æ ‡å‡†åˆ¶åº¦', 'åˆè§„ç®¡ç†': 'åˆè§„ç®¡ç†',
                'ç›Ÿå‹å…³ç³»': 'ç›Ÿå‹å…³ç³»', 'æ•Œå¯¹å…³ç³»': 'æ•Œå¯¹å…³ç³»', 'ä¸­ç«‹å…³ç³»': 'ä¸­ç«‹å…³ç³»', 'åˆä½œä¼™ä¼´': 'åˆä½œä¼™ä¼´',
                'ç»„ç»‡å£°èª‰': 'ç»„ç»‡å£°èª‰', 'å½±å“åŠ›': 'å½±å“åŠ›', 'å¤–äº¤å…³ç³»': 'å¤–äº¤å…³ç³»', 'æ¡çº¦åè®®': 'æ¡çº¦åè®®',
                'è´¢åŠ¡çŠ¶å†µ': 'è´¢åŠ¡çŠ¶å†µ', 'èµ„äº§ç®¡ç†': 'èµ„äº§ç®¡ç†', 'è®¾æ–½è®¾å¤‡': 'è®¾æ–½è®¾å¤‡', 'è£…å¤‡å™¨æ': 'è£…å¤‡å™¨æ',
                'æŠ€æœ¯èµ„æº': 'æŠ€æœ¯èµ„æº', 'çŸ¥è¯†åº“': 'çŸ¥è¯†åº“', 'æ¡£æ¡ˆç®¡ç†': 'æ¡£æ¡ˆç®¡ç†', 'æœºå¯†ä¿¡æ¯': 'æœºå¯†ä¿¡æ¯'
            },
            news: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'breaking': 'çªå‘æ–°é—»', 'politics': 'æ”¿æ²»æ–°é—»', 'economy': 'ç»æµæ–°é—»', 'social': 'ç¤¾ä¼šæ–°é—»',
                'military': 'å†›äº‹æ–°é—»', 'technology': 'ç§‘æŠ€æ–°é—»', 'culture': 'æ–‡åŒ–æ–°é—»', 'sports': 'ä½“è‚²æ–°é—»',
                'official': 'å®˜æ–¹å…¬å‘Š', 'media': 'åª’ä½“æŠ¥é“', 'rumors': 'ä¼ è¨€æ¶ˆæ¯', 'insider': 'å†…å¹•æ¶ˆæ¯',
                'witness': 'ç›®å‡»æŠ¥å‘Š', 'intelligence': 'æƒ…æŠ¥ä¿¡æ¯', 'leaked': 'æ³„éœ²æ¶ˆæ¯', 'anonymous': 'åŒ¿åçˆ†æ–™',
                'creation': 'æ–°é—»åˆ›å»º', 'editing': 'æ–°é—»ç¼–è¾‘', 'review': 'æ–°é—»å®¡æ ¸', 'publishing': 'æ–°é—»å‘å¸ƒ',
                'archiving': 'æ–°é—»å½’æ¡£', 'deletion': 'æ–°é—»åˆ é™¤', 'backup': 'å¤‡ä»½ç®¡ç†', 'versioning': 'ç‰ˆæœ¬æ§åˆ¶',
                'broadcast': 'å¹¿æ’­å‘å¸ƒ', 'newsletter': 'æ–°é—»ç®€æŠ¥', 'alerts': 'æ–°é—»è­¦æŠ¥', 'digest': 'æ–°é—»æ‘˜è¦',
                'socialMedia': 'ç¤¾äº¤åª’ä½“', 'forums': 'è®ºå›è®¨è®º', 'messaging': 'æ¶ˆæ¯æ¨é€', 'email': 'é‚®ä»¶é€šçŸ¥',
                'comments': 'è¯„è®ºç³»ç»Ÿ', 'likes': 'ç‚¹èµåŠŸèƒ½', 'sharing': 'åˆ†äº«åŠŸèƒ½', 'bookmarks': 'æ”¶è—åŠŸèƒ½',
                'ratings': 'è¯„åˆ†ç³»ç»Ÿ', 'polls': 'æŠ•ç¥¨è°ƒæŸ¥', 'discussions': 'è®¨è®ºåŒº', 'feedback': 'åé¦ˆç³»ç»Ÿ',
                'analytics': 'æ•°æ®åˆ†æ', 'metrics': 'æŒ‡æ ‡ç»Ÿè®¡', 'trends': 'è¶‹åŠ¿åˆ†æ', 'reports': 'æŠ¥å‘Šç”Ÿæˆ',
                'monitoring': 'ç›‘æ§ç³»ç»Ÿ', 'alertsSystem': 'è­¦æŠ¥ç³»ç»Ÿ', 'automation': 'è‡ªåŠ¨åŒ–', 'aiAnalysis': 'AIåˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'çªå‘æ–°é—»': 'çªå‘æ–°é—»', 'æ”¿æ²»æ–°é—»': 'æ”¿æ²»æ–°é—»', 'ç»æµæ–°é—»': 'ç»æµæ–°é—»', 'ç¤¾ä¼šæ–°é—»': 'ç¤¾ä¼šæ–°é—»',
                'å†›äº‹æ–°é—»': 'å†›äº‹æ–°é—»', 'ç§‘æŠ€æ–°é—»': 'ç§‘æŠ€æ–°é—»', 'æ–‡åŒ–æ–°é—»': 'æ–‡åŒ–æ–°é—»', 'ä½“è‚²æ–°é—»': 'ä½“è‚²æ–°é—»',
                'å®˜æ–¹å…¬å‘Š': 'å®˜æ–¹å…¬å‘Š', 'åª’ä½“æŠ¥é“': 'åª’ä½“æŠ¥é“', 'ä¼ è¨€æ¶ˆæ¯': 'ä¼ è¨€æ¶ˆæ¯', 'å†…å¹•æ¶ˆæ¯': 'å†…å¹•æ¶ˆæ¯',
                'ç›®å‡»æŠ¥å‘Š': 'ç›®å‡»æŠ¥å‘Š', 'æƒ…æŠ¥ä¿¡æ¯': 'æƒ…æŠ¥ä¿¡æ¯', 'æ³„éœ²æ¶ˆæ¯': 'æ³„éœ²æ¶ˆæ¯', 'åŒ¿åçˆ†æ–™': 'åŒ¿åçˆ†æ–™',
                'æ–°é—»åˆ›å»º': 'æ–°é—»åˆ›å»º', 'æ–°é—»ç¼–è¾‘': 'æ–°é—»ç¼–è¾‘', 'æ–°é—»å®¡æ ¸': 'æ–°é—»å®¡æ ¸', 'æ–°é—»å‘å¸ƒ': 'æ–°é—»å‘å¸ƒ',
                'æ–°é—»å½’æ¡£': 'æ–°é—»å½’æ¡£', 'æ–°é—»åˆ é™¤': 'æ–°é—»åˆ é™¤', 'å¤‡ä»½ç®¡ç†': 'å¤‡ä»½ç®¡ç†', 'ç‰ˆæœ¬æ§åˆ¶': 'ç‰ˆæœ¬æ§åˆ¶',
                'å¹¿æ’­å‘å¸ƒ': 'å¹¿æ’­å‘å¸ƒ', 'æ–°é—»ç®€æŠ¥': 'æ–°é—»ç®€æŠ¥', 'æ–°é—»è­¦æŠ¥': 'æ–°é—»è­¦æŠ¥', 'æ–°é—»æ‘˜è¦': 'æ–°é—»æ‘˜è¦',
                'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'è®ºå›è®¨è®º': 'è®ºå›è®¨è®º', 'æ¶ˆæ¯æ¨é€': 'æ¶ˆæ¯æ¨é€', 'é‚®ä»¶é€šçŸ¥': 'é‚®ä»¶é€šçŸ¥',
                'è¯„è®ºç³»ç»Ÿ': 'è¯„è®ºç³»ç»Ÿ', 'ç‚¹èµåŠŸèƒ½': 'ç‚¹èµåŠŸèƒ½', 'åˆ†äº«åŠŸèƒ½': 'åˆ†äº«åŠŸèƒ½', 'æ”¶è—åŠŸèƒ½': 'æ”¶è—åŠŸèƒ½',
                'è¯„åˆ†ç³»ç»Ÿ': 'è¯„åˆ†ç³»ç»Ÿ', 'æŠ•ç¥¨è°ƒæŸ¥': 'æŠ•ç¥¨è°ƒæŸ¥', 'è®¨è®ºåŒº': 'è®¨è®ºåŒº', 'åé¦ˆç³»ç»Ÿ': 'åé¦ˆç³»ç»Ÿ',
                'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'æŒ‡æ ‡ç»Ÿè®¡': 'æŒ‡æ ‡ç»Ÿè®¡', 'è¶‹åŠ¿åˆ†æ': 'è¶‹åŠ¿åˆ†æ', 'æŠ¥å‘Šç”Ÿæˆ': 'æŠ¥å‘Šç”Ÿæˆ',
                'ç›‘æ§ç³»ç»Ÿ': 'ç›‘æ§ç³»ç»Ÿ', 'è­¦æŠ¥ç³»ç»Ÿ': 'è­¦æŠ¥ç³»ç»Ÿ', 'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIåˆ†æ': 'AIåˆ†æ',
                'äº‹ä»¶': 'äº‹ä»¶'
            },
            inventory: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'storage': 'ç‰©å“å­˜å‚¨', 'retrieval': 'ç‰©å“å–å‡º', 'organization': 'ç‰©å“æ•´ç†', 'search': 'ç‰©å“æœç´¢',
                'sorting': 'æ’åºåŠŸèƒ½', 'filtering': 'ç­›é€‰åŠŸèƒ½', 'categories': 'åˆ†ç±»ç®¡ç†', 'tags': 'æ ‡ç­¾ç³»ç»Ÿ',
                'weapons': 'æ­¦å™¨è£…å¤‡', 'armor': 'é˜²å…·è£…å¤‡', 'accessories': 'é¥°å“é…ä»¶', 'consumables': 'æ¶ˆè€—å“',
                'materials': 'ææ–™ç‰©å“', 'tools': 'å·¥å…·å™¨æ¢°', 'books': 'ä¹¦ç±æ–‡çŒ®', 'treasures': 'çå®æ”¶è—',
                'capacity': 'å®¹é‡ç®¡ç†', 'weight': 'é‡é‡é™åˆ¶', 'stacking': 'å †å åŠŸèƒ½', 'expansion': 'æ‰©å®¹å‡çº§',
                'compartments': 'åˆ†éš”ç®¡ç†', 'protection': 'ä¿æŠ¤åŠŸèƒ½', 'durability': 'è€ä¹…åº¦', 'repair': 'ä¿®ç†ç»´æŠ¤',
                'trading': 'äº¤æ˜“åŠŸèƒ½', 'selling': 'å‡ºå”®åŠŸèƒ½', 'buying': 'è´­ä¹°åŠŸèƒ½', 'auction': 'æ‹å–ç³»ç»Ÿ',
                'gifting': 'èµ é€åŠŸèƒ½', 'lending': 'å€Ÿç”¨åŠŸèƒ½', 'sharing': 'å…±äº«åŠŸèƒ½', 'banking': 'é“¶è¡Œå­˜å‚¨',
                'crafting': 'åˆ¶ä½œåŠŸèƒ½', 'recipes': 'é…æ–¹ç®¡ç†', 'enhancement': 'å¼ºåŒ–åŠŸèƒ½', 'enchanting': 'é™„é­”åŠŸèƒ½',
                'upgrading': 'å‡çº§åŠŸèƒ½', 'combining': 'åˆæˆåŠŸèƒ½', 'dismantling': 'æ‹†è§£åŠŸèƒ½', 'recycling': 'å›æ”¶åŠŸèƒ½',
                'automation': 'è‡ªåŠ¨åŒ–', 'aiSorting': 'AIæ•´ç†', 'recommendations': 'æ¨èç³»ç»Ÿ', 'analytics': 'æ•°æ®åˆ†æ',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½', 'security': 'å®‰å…¨ä¿æŠ¤', 'history': 'å†å²è®°å½•',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‰©å“å­˜å‚¨': 'ç‰©å“å­˜å‚¨', 'ç‰©å“å–å‡º': 'ç‰©å“å–å‡º', 'ç‰©å“æ•´ç†': 'ç‰©å“æ•´ç†', 'ç‰©å“æœç´¢': 'ç‰©å“æœç´¢',
                'æ’åºåŠŸèƒ½': 'æ’åºåŠŸèƒ½', 'ç­›é€‰åŠŸèƒ½': 'ç­›é€‰åŠŸèƒ½', 'åˆ†ç±»ç®¡ç†': 'åˆ†ç±»ç®¡ç†', 'æ ‡ç­¾ç³»ç»Ÿ': 'æ ‡ç­¾ç³»ç»Ÿ',
                'æ­¦å™¨è£…å¤‡': 'æ­¦å™¨è£…å¤‡', 'é˜²å…·è£…å¤‡': 'é˜²å…·è£…å¤‡', 'é¥°å“é…ä»¶': 'é¥°å“é…ä»¶', 'æ¶ˆè€—å“': 'æ¶ˆè€—å“',
                'ææ–™ç‰©å“': 'ææ–™ç‰©å“', 'å·¥å…·å™¨æ¢°': 'å·¥å…·å™¨æ¢°', 'ä¹¦ç±æ–‡çŒ®': 'ä¹¦ç±æ–‡çŒ®', 'çå®æ”¶è—': 'çå®æ”¶è—',
                'å®¹é‡ç®¡ç†': 'å®¹é‡ç®¡ç†', 'é‡é‡é™åˆ¶': 'é‡é‡é™åˆ¶', 'å †å åŠŸèƒ½': 'å †å åŠŸèƒ½', 'æ‰©å®¹å‡çº§': 'æ‰©å®¹å‡çº§',
                'åˆ†éš”ç®¡ç†': 'åˆ†éš”ç®¡ç†', 'ä¿æŠ¤åŠŸèƒ½': 'ä¿æŠ¤åŠŸèƒ½', 'è€ä¹…åº¦': 'è€ä¹…åº¦', 'ä¿®ç†ç»´æŠ¤': 'ä¿®ç†ç»´æŠ¤',
                'äº¤æ˜“åŠŸèƒ½': 'äº¤æ˜“åŠŸèƒ½', 'å‡ºå”®åŠŸèƒ½': 'å‡ºå”®åŠŸèƒ½', 'è´­ä¹°åŠŸèƒ½': 'è´­ä¹°åŠŸèƒ½', 'æ‹å–ç³»ç»Ÿ': 'æ‹å–ç³»ç»Ÿ',
                'èµ é€åŠŸèƒ½': 'èµ é€åŠŸèƒ½', 'å€Ÿç”¨åŠŸèƒ½': 'å€Ÿç”¨åŠŸèƒ½', 'å…±äº«åŠŸèƒ½': 'å…±äº«åŠŸèƒ½', 'é“¶è¡Œå­˜å‚¨': 'é“¶è¡Œå­˜å‚¨',
                'åˆ¶ä½œåŠŸèƒ½': 'åˆ¶ä½œåŠŸèƒ½', 'é…æ–¹ç®¡ç†': 'é…æ–¹ç®¡ç†', 'å¼ºåŒ–åŠŸèƒ½': 'å¼ºåŒ–åŠŸèƒ½', 'é™„é­”åŠŸèƒ½': 'é™„é­”åŠŸèƒ½',
                'å‡çº§åŠŸèƒ½': 'å‡çº§åŠŸèƒ½', 'åˆæˆåŠŸèƒ½': 'åˆæˆåŠŸèƒ½', 'æ‹†è§£åŠŸèƒ½': 'æ‹†è§£åŠŸèƒ½', 'å›æ”¶åŠŸèƒ½': 'å›æ”¶åŠŸèƒ½',
                'è‡ªåŠ¨åŒ–': 'è‡ªåŠ¨åŒ–', 'AIæ•´ç†': 'AIæ•´ç†', 'æ¨èç³»ç»Ÿ': 'æ¨èç³»ç»Ÿ', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½', 'å®‰å…¨ä¿æŠ¤': 'å®‰å…¨ä¿æŠ¤', 'å†å²è®°å½•': 'å†å²è®°å½•',
                'é‡‘å¸': 'é‡‘å¸', 'æ­¦å™¨': 'æ­¦å™¨', 'æŠ¤ç”²': 'æŠ¤ç”²', 'é“å…·': 'é“å…·'
            },
            abilities: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'strength': 'åŠ›é‡å±æ€§', 'agility': 'æ•æ·å±æ€§', 'intelligence': 'æ™ºåŠ›å±æ€§', 'constitution': 'ä½“è´¨å±æ€§',
                'wisdom': 'æ™ºæ…§å±æ€§', 'charisma': 'é­…åŠ›å±æ€§', 'luck': 'å¹¸è¿å±æ€§', 'perception': 'æ„ŸçŸ¥å±æ€§',
                'swordsmanship': 'å‰‘æœ¯æŠ€èƒ½', 'archery': 'å°„ç®­æŠ€èƒ½', 'magic': 'é­”æ³•æŠ€èƒ½', 'defense': 'é˜²å¾¡æŠ€èƒ½',
                'martialArts': 'æ­¦æœ¯æŠ€èƒ½', 'stealth': 'æ½œè¡ŒæŠ€èƒ½', 'tactics': 'æˆ˜æœ¯æŠ€èƒ½', 'healing': 'æ²»ç–—æŠ€èƒ½',
                'crafting': 'åˆ¶ä½œæŠ€èƒ½', 'cooking': 'çƒ¹é¥ªæŠ€èƒ½', 'farming': 'å†œä¸šæŠ€èƒ½', 'mining': 'é‡‡çŸ¿æŠ€èƒ½',
                'fishing': 'é’“é±¼æŠ€èƒ½', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'trading': 'è´¸æ˜“æŠ€èƒ½', 'negotiation': 'è°ˆåˆ¤æŠ€èƒ½',
                'research': 'ç ”ç©¶æŠ€èƒ½', 'investigation': 'è°ƒæŸ¥æŠ€èƒ½', 'languages': 'è¯­è¨€æŠ€èƒ½', 'history': 'å†å²çŸ¥è¯†',
                'medicine': 'åŒ»å­¦çŸ¥è¯†', 'alchemy': 'ç‚¼é‡‘æœ¯', 'engineering': 'å·¥ç¨‹å­¦', 'astronomy': 'å¤©æ–‡å­¦',
                'persuasion': 'è¯´æœæŠ€èƒ½', 'deception': 'æ¬ºéª—æŠ€èƒ½', 'intimidation': 'å¨å“æŠ€èƒ½', 'performance': 'è¡¨æ¼”æŠ€èƒ½',
                'leadership': 'é¢†å¯¼èƒ½åŠ›', 'empathy': 'å…±æƒ…èƒ½åŠ›', 'insight': 'æ´å¯Ÿèƒ½åŠ›', 'networking': 'ç¤¾äº¤èƒ½åŠ›',
                'telepathy': 'å¿ƒçµæ„Ÿåº”', 'telekinesis': 'å¿µåŠ¨åŠ›', 'precognition': 'é¢„çŸ¥èƒ½åŠ›', 'shapeshifting': 'å˜å½¢èƒ½åŠ›',
                'invisibility': 'éšèº«èƒ½åŠ›', 'flight': 'é£è¡Œèƒ½åŠ›', 'regeneration': 'å†ç”Ÿèƒ½åŠ›', 'immortality': 'ä¸æœ½èƒ½åŠ›',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŠ›é‡å±æ€§': 'åŠ›é‡å±æ€§', 'æ•æ·å±æ€§': 'æ•æ·å±æ€§', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'ä½“è´¨å±æ€§': 'ä½“è´¨å±æ€§',
                'æ™ºæ…§å±æ€§': 'æ™ºæ…§å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§', 'å¹¸è¿å±æ€§': 'å¹¸è¿å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§',
                'å‰‘æœ¯æŠ€èƒ½': 'å‰‘æœ¯æŠ€èƒ½', 'å°„ç®­æŠ€èƒ½': 'å°„ç®­æŠ€èƒ½', 'é­”æ³•æŠ€èƒ½': 'é­”æ³•æŠ€èƒ½', 'é˜²å¾¡æŠ€èƒ½': 'é˜²å¾¡æŠ€èƒ½',
                'æ­¦æœ¯æŠ€èƒ½': 'æ­¦æœ¯æŠ€èƒ½', 'æ½œè¡ŒæŠ€èƒ½': 'æ½œè¡ŒæŠ€èƒ½', 'æˆ˜æœ¯æŠ€èƒ½': 'æˆ˜æœ¯æŠ€èƒ½', 'æ²»ç–—æŠ€èƒ½': 'æ²»ç–—æŠ€èƒ½',
                'åˆ¶ä½œæŠ€èƒ½': 'åˆ¶ä½œæŠ€èƒ½', 'çƒ¹é¥ªæŠ€èƒ½': 'çƒ¹é¥ªæŠ€èƒ½', 'å†œä¸šæŠ€èƒ½': 'å†œä¸šæŠ€èƒ½', 'é‡‡çŸ¿æŠ€èƒ½': 'é‡‡çŸ¿æŠ€èƒ½',
                'é’“é±¼æŠ€èƒ½': 'é’“é±¼æŠ€èƒ½', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'è´¸æ˜“æŠ€èƒ½': 'è´¸æ˜“æŠ€èƒ½', 'è°ˆåˆ¤æŠ€èƒ½': 'è°ˆåˆ¤æŠ€èƒ½',
                'ç ”ç©¶æŠ€èƒ½': 'ç ”ç©¶æŠ€èƒ½', 'è°ƒæŸ¥æŠ€èƒ½': 'è°ƒæŸ¥æŠ€èƒ½', 'è¯­è¨€æŠ€èƒ½': 'è¯­è¨€æŠ€èƒ½', 'å†å²çŸ¥è¯†': 'å†å²çŸ¥è¯†',
                'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'ç‚¼é‡‘æœ¯': 'ç‚¼é‡‘æœ¯', 'å·¥ç¨‹å­¦': 'å·¥ç¨‹å­¦', 'å¤©æ–‡å­¦': 'å¤©æ–‡å­¦',
                'è¯´æœæŠ€èƒ½': 'è¯´æœæŠ€èƒ½', 'æ¬ºéª—æŠ€èƒ½': 'æ¬ºéª—æŠ€èƒ½', 'å¨å“æŠ€èƒ½': 'å¨å“æŠ€èƒ½', 'è¡¨æ¼”æŠ€èƒ½': 'è¡¨æ¼”æŠ€èƒ½',
                'é¢†å¯¼èƒ½åŠ›': 'é¢†å¯¼èƒ½åŠ›', 'å…±æƒ…èƒ½åŠ›': 'å…±æƒ…èƒ½åŠ›', 'æ´å¯Ÿèƒ½åŠ›': 'æ´å¯Ÿèƒ½åŠ›', 'ç¤¾äº¤èƒ½åŠ›': 'ç¤¾äº¤èƒ½åŠ›',
                'å¿ƒçµæ„Ÿåº”': 'å¿ƒçµæ„Ÿåº”', 'å¿µåŠ¨åŠ›': 'å¿µåŠ¨åŠ›', 'é¢„çŸ¥èƒ½åŠ›': 'é¢„çŸ¥èƒ½åŠ›', 'å˜å½¢èƒ½åŠ›': 'å˜å½¢èƒ½åŠ›',
                'éšèº«èƒ½åŠ›': 'éšèº«èƒ½åŠ›', 'é£è¡Œèƒ½åŠ›': 'é£è¡Œèƒ½åŠ›', 'å†ç”Ÿèƒ½åŠ›': 'å†ç”Ÿèƒ½åŠ›', 'ä¸æœ½èƒ½åŠ›': 'ä¸æœ½èƒ½åŠ›'
            },
            plot: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'mainStory': 'ä¸»çº¿å‰§æƒ…', 'sideQuests': 'æ”¯çº¿ä»»åŠ¡', 'subplots': 'å­å‰§æƒ…', 'backstory': 'èƒŒæ™¯æ•…äº‹',
                'prologue': 'åºç« ', 'epilogue': 'å°¾å£°', 'flashbacks': 'å›å¿†ç‰‡æ®µ', 'foreshadowing': 'ä¼ç¬”é“ºå«',
                'exposition': 'èƒŒæ™¯è¯´æ˜', 'risingAction': 'æƒ…èŠ‚å‘å±•', 'climax': 'é«˜æ½®éƒ¨åˆ†', 'fallingAction': 'æƒ…èŠ‚å›è½',
                'resolution': 'é—®é¢˜è§£å†³', 'denouement': 'ç»“å±€æ”¶å°¾', 'cliffhanger': 'æ‚¬å¿µç»“å°¾', 'twist': 'å‰§æƒ…è½¬æŠ˜',
                'characterArc': 'è§’è‰²æˆé•¿', 'relationships': 'äººç‰©å…³ç³»', 'motivations': 'åŠ¨æœºé©±åŠ¨', 'conflicts': 'å†²çªçŸ›ç›¾',
                'internalConflicts': 'å†…å¿ƒå†²çª', 'externalConflicts': 'å¤–éƒ¨å†²çª', 'moralDilemmas': 'é“å¾·å›°å¢ƒ', 'sacrifices': 'ç‰ºç‰²é€‰æ‹©',
                'dialogue': 'å¯¹è¯ç³»ç»Ÿ', 'narration': 'å™è¿°æå†™', 'monologue': 'ç‹¬ç™½è¡¨è¾¾', 'symbolism': 'è±¡å¾æ„ä¹‰',
                'themes': 'ä¸»é¢˜æ€æƒ³', 'mood': 'æƒ…ç»ªæ°›å›´', 'tone': 'è¯­è°ƒé£æ ¼', 'pacing': 'èŠ‚å¥æ§åˆ¶',
                'choices': 'é€‰æ‹©åˆ†æ”¯', 'consequences': 'åæœå½±å“', 'branching': 'åˆ†æ”¯å‰§æƒ…', 'multipleEndings': 'å¤šé‡ç»“å±€',
                'playerAgency': 'ç©å®¶ä¸»å¯¼', 'emergentNarrative': 'æ¶Œç°å™äº‹', 'proceduralGeneration': 'ç¨‹åºç”Ÿæˆ', 'adaptiveStorytelling': 'è‡ªé€‚åº”å™äº‹',
                'timeline': 'æ—¶é—´çº¿', 'notes': 'å‰§æƒ…ç¬”è®°', 'bookmarks': 'ä¹¦ç­¾æ ‡è®°', 'saveStates': 'å­˜æ¡£çŠ¶æ€',
                'autoSave': 'è‡ªåŠ¨ä¿å­˜', 'export': 'å¯¼å‡ºåŠŸèƒ½', 'import': 'å¯¼å…¥åŠŸèƒ½', 'analytics': 'æ•°æ®åˆ†æ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ä¸»çº¿å‰§æƒ…': 'ä¸»çº¿å‰§æƒ…', 'æ”¯çº¿ä»»åŠ¡': 'æ”¯çº¿ä»»åŠ¡', 'å­å‰§æƒ…': 'å­å‰§æƒ…', 'èƒŒæ™¯æ•…äº‹': 'èƒŒæ™¯æ•…äº‹',
                'åºç« ': 'åºç« ', 'å°¾å£°': 'å°¾å£°', 'å›å¿†ç‰‡æ®µ': 'å›å¿†ç‰‡æ®µ', 'ä¼ç¬”é“ºå«': 'ä¼ç¬”é“ºå«',
                'èƒŒæ™¯è¯´æ˜': 'èƒŒæ™¯è¯´æ˜', 'æƒ…èŠ‚å‘å±•': 'æƒ…èŠ‚å‘å±•', 'é«˜æ½®éƒ¨åˆ†': 'é«˜æ½®éƒ¨åˆ†', 'æƒ…èŠ‚å›è½': 'æƒ…èŠ‚å›è½',
                'é—®é¢˜è§£å†³': 'é—®é¢˜è§£å†³', 'ç»“å±€æ”¶å°¾': 'ç»“å±€æ”¶å°¾', 'æ‚¬å¿µç»“å°¾': 'æ‚¬å¿µç»“å°¾', 'å‰§æƒ…è½¬æŠ˜': 'å‰§æƒ…è½¬æŠ˜',
                'è§’è‰²æˆé•¿': 'è§’è‰²æˆé•¿', 'äººç‰©å…³ç³»': 'äººç‰©å…³ç³»', 'åŠ¨æœºé©±åŠ¨': 'åŠ¨æœºé©±åŠ¨', 'å†²çªçŸ›ç›¾': 'å†²çªçŸ›ç›¾',
                'å†…å¿ƒå†²çª': 'å†…å¿ƒå†²çª', 'å¤–éƒ¨å†²çª': 'å¤–éƒ¨å†²çª', 'é“å¾·å›°å¢ƒ': 'é“å¾·å›°å¢ƒ', 'ç‰ºç‰²é€‰æ‹©': 'ç‰ºç‰²é€‰æ‹©',
                'å¯¹è¯ç³»ç»Ÿ': 'å¯¹è¯ç³»ç»Ÿ', 'å™è¿°æå†™': 'å™è¿°æå†™', 'ç‹¬ç™½è¡¨è¾¾': 'ç‹¬ç™½è¡¨è¾¾', 'è±¡å¾æ„ä¹‰': 'è±¡å¾æ„ä¹‰',
                'ä¸»é¢˜æ€æƒ³': 'ä¸»é¢˜æ€æƒ³', 'æƒ…ç»ªæ°›å›´': 'æƒ…ç»ªæ°›å›´', 'è¯­è°ƒé£æ ¼': 'è¯­è°ƒé£æ ¼', 'èŠ‚å¥æ§åˆ¶': 'èŠ‚å¥æ§åˆ¶',
                'é€‰æ‹©åˆ†æ”¯': 'é€‰æ‹©åˆ†æ”¯', 'åæœå½±å“': 'åæœå½±å“', 'åˆ†æ”¯å‰§æƒ…': 'åˆ†æ”¯å‰§æƒ…', 'å¤šé‡ç»“å±€': 'å¤šé‡ç»“å±€',
                'ç©å®¶ä¸»å¯¼': 'ç©å®¶ä¸»å¯¼', 'æ¶Œç°å™äº‹': 'æ¶Œç°å™äº‹', 'ç¨‹åºç”Ÿæˆ': 'ç¨‹åºç”Ÿæˆ', 'è‡ªé€‚åº”å™äº‹': 'è‡ªé€‚åº”å™äº‹',
                'æ—¶é—´çº¿': 'æ—¶é—´çº¿', 'å‰§æƒ…ç¬”è®°': 'å‰§æƒ…ç¬”è®°', 'ä¹¦ç­¾æ ‡è®°': 'ä¹¦ç­¾æ ‡è®°', 'å­˜æ¡£çŠ¶æ€': 'å­˜æ¡£çŠ¶æ€',
                'è‡ªåŠ¨ä¿å­˜': 'è‡ªåŠ¨ä¿å­˜', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½', 'å¯¼å…¥åŠŸèƒ½': 'å¯¼å…¥åŠŸèƒ½', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ'
            },
            cultivation: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'qiRefining': 'ç‚¼æ°”æœŸ', 'foundation': 'ç­‘åŸºæœŸ', 'goldenCore': 'é‡‘ä¸¹æœŸ', 'nascentSoul': 'å…ƒå©´æœŸ',
                'soulTransformation': 'åŒ–ç¥æœŸ', 'voidRefinement': 'ç‚¼è™šæœŸ', 'bodyIntegration': 'åˆä½“æœŸ', 'mahayana': 'å¤§ä¹˜æœŸ',
                'tribulation': 'æ¸¡åŠ«æœŸ', 'immortal': 'çœŸä»™', 'trueImmortal': 'å¤©ä»™', 'goldenImmortal': 'é‡‘ä»™',
                'breathingTechnique': 'å‘¼å¸æ³•', 'bodyRefining': 'ç‚¼ä½“æœ¯', 'soulCultivation': 'ç¥é­‚ä¿®ç‚¼', 'dualCultivation': 'åŒä¿®åŠŸæ³•',
                'swordCultivation': 'å‰‘ä¿®ä¹‹é“', 'alchemy': 'ç‚¼ä¸¹æœ¯', 'formation': 'é˜µæ³•', 'talisman': 'ç¬¦ç®“',
                'spiritualPower': 'çµåŠ›å€¼', 'spiritualRoot': 'çµæ ¹', 'meridians': 'ç»è„‰', 'dantian': 'ä¸¹ç”°',
                'divineSense': 'ç¥è¯†', 'lifeSpan': 'å¯¿å‘½', 'karma': 'å› æœ', 'heavenlyDao': 'å¤©é“',
                'flyingSword': 'é£å‰‘', 'magicTreasure': 'æ³•å®', 'spiritualArmor': 'çµç”²', 'storageRing': 'å‚¨ç‰©æˆ’',
                'spiritBeast': 'çµå…½', 'puppet': 'å‚€å„¡', 'avatar': 'åŒ–èº«', 'clone': 'åˆ†èº«',
                'spiritStone': 'çµçŸ³', 'spiritHerb': 'çµè‰', 'pill': 'ä¸¹è¯', 'spiritVein': 'çµè„‰',
                'caveMansion': 'æ´åºœ', 'secretRealm': 'ç§˜å¢ƒ', 'inheritance': 'ä¼ æ‰¿', 'opportunity': 'æœºç¼˜',
                'meditation': 'æ‰“å', 'tribulationCrossing': 'æ¸¡åŠ«', 'enlightenment': 'é¡¿æ‚Ÿ', 'breakthrough': 'çªç ´',
                'sect': 'å®—é—¨', 'masterDisciple': 'å¸ˆå¾’', 'daoCompanion': 'é“ä¾£', 'immortalAscension': 'é£å‡',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'ç‚¼æ°”æœŸ': 'ç‚¼æ°”æœŸ', 'ç­‘åŸºæœŸ': 'ç­‘åŸºæœŸ', 'é‡‘ä¸¹æœŸ': 'é‡‘ä¸¹æœŸ', 'å…ƒå©´æœŸ': 'å…ƒå©´æœŸ',
                'åŒ–ç¥æœŸ': 'åŒ–ç¥æœŸ', 'ç‚¼è™šæœŸ': 'ç‚¼è™šæœŸ', 'åˆä½“æœŸ': 'åˆä½“æœŸ', 'å¤§ä¹˜æœŸ': 'å¤§ä¹˜æœŸ',
                'æ¸¡åŠ«æœŸ': 'æ¸¡åŠ«æœŸ', 'çœŸä»™': 'çœŸä»™', 'å¤©ä»™': 'å¤©ä»™', 'é‡‘ä»™': 'é‡‘ä»™',
                'å‘¼å¸æ³•': 'å‘¼å¸æ³•', 'ç‚¼ä½“æœ¯': 'ç‚¼ä½“æœ¯', 'ç¥é­‚ä¿®ç‚¼': 'ç¥é­‚ä¿®ç‚¼', 'åŒä¿®åŠŸæ³•': 'åŒä¿®åŠŸæ³•',
                'å‰‘ä¿®ä¹‹é“': 'å‰‘ä¿®ä¹‹é“', 'ç‚¼ä¸¹æœ¯': 'ç‚¼ä¸¹æœ¯', 'é˜µæ³•': 'é˜µæ³•', 'ç¬¦ç®“': 'ç¬¦ç®“',
                'çµåŠ›å€¼': 'çµåŠ›å€¼', 'çµæ ¹': 'çµæ ¹', 'ç»è„‰': 'ç»è„‰', 'ä¸¹ç”°': 'ä¸¹ç”°',
                'ç¥è¯†': 'ç¥è¯†', 'å¯¿å‘½': 'å¯¿å‘½', 'å› æœ': 'å› æœ', 'å¤©é“': 'å¤©é“',
                'é£å‰‘': 'é£å‰‘', 'æ³•å®': 'æ³•å®', 'çµç”²': 'çµç”²', 'å‚¨ç‰©æˆ’': 'å‚¨ç‰©æˆ’',
                'çµå…½': 'çµå…½', 'å‚€å„¡': 'å‚€å„¡', 'åŒ–èº«': 'åŒ–èº«', 'åˆ†èº«': 'åˆ†èº«',
                'çµçŸ³': 'çµçŸ³', 'çµè‰': 'çµè‰', 'ä¸¹è¯': 'ä¸¹è¯', 'çµè„‰': 'çµè„‰',
                'æ´åºœ': 'æ´åºœ', 'ç§˜å¢ƒ': 'ç§˜å¢ƒ', 'ä¼ æ‰¿': 'ä¼ æ‰¿', 'æœºç¼˜': 'æœºç¼˜',
                'æ‰“å': 'æ‰“å', 'æ¸¡åŠ«': 'æ¸¡åŠ«', 'é¡¿æ‚Ÿ': 'é¡¿æ‚Ÿ', 'çªç ´': 'çªç ´',
                'å®—é—¨': 'å®—é—¨', 'å¸ˆå¾’': 'å¸ˆå¾’', 'é“ä¾£': 'é“ä¾£', 'é£å‡': 'é£å‡'
            },
            fantasy: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'human': 'äººç±»ç§æ—', 'elf': 'ç²¾çµç§æ—', 'dwarf': 'çŸ®äººç§æ—', 'orc': 'å…½äººç§æ—',
                'dragon': 'é¾™æ—', 'demon': 'æ¶é­”', 'angel': 'å¤©ä½¿', 'undead': 'ä¸æ­»æ—',
                'halfling': 'åŠèº«äºº', 'giant': 'å·¨äººæ—', 'fairy': 'ä»™çµ', 'vampire': 'å¸è¡€é¬¼',
                'fireMagic': 'ç«ç³»é­”æ³•', 'waterMagic': 'æ°´ç³»é­”æ³•', 'earthMagic': 'åœŸç³»é­”æ³•', 'airMagic': 'é£ç³»é­”æ³•',
                'lightMagic': 'å…‰ç³»é­”æ³•', 'darkMagic': 'æš—ç³»é­”æ³•', 'natureMagic': 'è‡ªç„¶é­”æ³•', 'spaceMagic': 'ç©ºé—´é­”æ³•',
                'timeMagic': 'æ—¶é—´é­”æ³•', 'necromancy': 'æ­»çµæ³•æœ¯', 'illusionMagic': 'å¹»æœ¯é­”æ³•', 'enchantment': 'é™„é­”æœ¯',
                'warrior': 'æˆ˜å£«èŒä¸š', 'mage': 'æ³•å¸ˆèŒä¸š', 'archer': 'å¼“ç®­æ‰‹', 'rogue': 'ç›—è´¼èŒä¸š',
                'priest': 'ç‰§å¸ˆèŒä¸š', 'paladin': 'åœ£éª‘å£«', 'druid': 'å¾·é²ä¼Š', 'warlock': 'æœ¯å£«èŒä¸š',
                'bard': 'åŸæ¸¸è¯—äºº', 'monk': 'æ­¦åƒ§èŒä¸š', 'ranger': 'æ¸¸ä¾ èŒä¸š', 'assassin': 'åˆºå®¢èŒä¸š',
                'phoenix': 'å‡¤å‡°', 'unicorn': 'ç‹¬è§’å…½', 'griffin': 'ç‹®é¹«', 'pegasus': 'é£é©¬',
                'kraken': 'æµ·æ€ª', 'chimera': 'å¥‡ç¾æ‹‰', 'basilisk': 'è›‡æ€ª', 'hydra': 'ä¹å¤´è›‡',
                'legendaryWeapon': 'ä¼ è¯´æ­¦å™¨', 'magicArmor': 'é­”æ³•æŠ¤ç”²', 'artifact': 'ç¥å™¨', 'relic': 'åœ£ç‰©',
                'magicCrystal': 'é­”æ³•æ°´æ™¶', 'enchantedItem': 'é™„é­”ç‰©å“', 'potion': 'é­”æ³•è¯æ°´', 'scroll': 'é­”æ³•å·è½´',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'äººç±»ç§æ—': 'äººç±»ç§æ—', 'ç²¾çµç§æ—': 'ç²¾çµç§æ—', 'çŸ®äººç§æ—': 'çŸ®äººç§æ—', 'å…½äººç§æ—': 'å…½äººç§æ—',
                'é¾™æ—': 'é¾™æ—', 'æ¶é­”': 'æ¶é­”', 'å¤©ä½¿': 'å¤©ä½¿', 'ä¸æ­»æ—': 'ä¸æ­»æ—',
                'åŠèº«äºº': 'åŠèº«äºº', 'å·¨äººæ—': 'å·¨äººæ—', 'ä»™çµ': 'ä»™çµ', 'å¸è¡€é¬¼': 'å¸è¡€é¬¼',
                'ç«ç³»é­”æ³•': 'ç«ç³»é­”æ³•', 'æ°´ç³»é­”æ³•': 'æ°´ç³»é­”æ³•', 'åœŸç³»é­”æ³•': 'åœŸç³»é­”æ³•', 'é£ç³»é­”æ³•': 'é£ç³»é­”æ³•',
                'å…‰ç³»é­”æ³•': 'å…‰ç³»é­”æ³•', 'æš—ç³»é­”æ³•': 'æš—ç³»é­”æ³•', 'è‡ªç„¶é­”æ³•': 'è‡ªç„¶é­”æ³•', 'ç©ºé—´é­”æ³•': 'ç©ºé—´é­”æ³•',
                'æ—¶é—´é­”æ³•': 'æ—¶é—´é­”æ³•', 'æ­»çµæ³•æœ¯': 'æ­»çµæ³•æœ¯', 'å¹»æœ¯é­”æ³•': 'å¹»æœ¯é­”æ³•', 'é™„é­”æœ¯': 'é™„é­”æœ¯',
                'æˆ˜å£«èŒä¸š': 'æˆ˜å£«èŒä¸š', 'æ³•å¸ˆèŒä¸š': 'æ³•å¸ˆèŒä¸š', 'å¼“ç®­æ‰‹': 'å¼“ç®­æ‰‹', 'ç›—è´¼èŒä¸š': 'ç›—è´¼èŒä¸š',
                'ç‰§å¸ˆèŒä¸š': 'ç‰§å¸ˆèŒä¸š', 'åœ£éª‘å£«': 'åœ£éª‘å£«', 'å¾·é²ä¼Š': 'å¾·é²ä¼Š', 'æœ¯å£«èŒä¸š': 'æœ¯å£«èŒä¸š',
                'åŸæ¸¸è¯—äºº': 'åŸæ¸¸è¯—äºº', 'æ­¦åƒ§èŒä¸š': 'æ­¦åƒ§èŒä¸š', 'æ¸¸ä¾ èŒä¸š': 'æ¸¸ä¾ èŒä¸š', 'åˆºå®¢èŒä¸š': 'åˆºå®¢èŒä¸š',
                'å‡¤å‡°': 'å‡¤å‡°', 'ç‹¬è§’å…½': 'ç‹¬è§’å…½', 'ç‹®é¹«': 'ç‹®é¹«', 'é£é©¬': 'é£é©¬',
                'æµ·æ€ª': 'æµ·æ€ª', 'å¥‡ç¾æ‹‰': 'å¥‡ç¾æ‹‰', 'è›‡æ€ª': 'è›‡æ€ª', 'ä¹å¤´è›‡': 'ä¹å¤´è›‡',
                'ä¼ è¯´æ­¦å™¨': 'ä¼ è¯´æ­¦å™¨', 'é­”æ³•æŠ¤ç”²': 'é­”æ³•æŠ¤ç”²', 'ç¥å™¨': 'ç¥å™¨', 'åœ£ç‰©': 'åœ£ç‰©',
                'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é™„é­”ç‰©å“': 'é™„é­”ç‰©å“', 'é­”æ³•è¯æ°´': 'é­”æ³•è¯æ°´', 'é­”æ³•å·è½´': 'é­”æ³•å·è½´'
            },
            modern: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'city': 'åŸå¸‚ç¯å¢ƒ', 'district': 'åŒºåŸŸè®¾å®š', 'housing': 'ä½æˆ¿æƒ…å†µ', 'transport': 'äº¤é€šå·¥å…·',
                'neighborhood': 'ç¤¾åŒºç¯å¢ƒ', 'facilities': 'è®¾æ–½é…å¥—', 'cost': 'ç”Ÿæ´»æˆæœ¬', 'safety': 'å®‰å…¨çŠ¶å†µ',
                'pollution': 'ç¯å¢ƒæ±¡æŸ“', 'job': 'èŒä¸šå·¥ä½œ', 'company': 'å…¬å¸ä¼ä¸š', 'position': 'èŒä½ç­‰çº§',
                'income': 'æ”¶å…¥æ°´å¹³', 'worktime': 'å·¥ä½œæ—¶é—´', 'benefits': 'ç¦åˆ©å¾…é‡', 'career': 'èŒä¸šå‘å±•',
                'skills': 'æŠ€èƒ½è¦æ±‚', 'education': 'æ•™è‚²èƒŒæ™¯', 'smartphone': 'æ™ºèƒ½æ‰‹æœº', 'computer': 'ç”µè„‘è®¾å¤‡',
                'internet': 'ç½‘ç»œè¿æ¥', 'social': 'ç¤¾äº¤åª’ä½“', 'gaming': 'æ¸¸æˆå¨±ä¹', 'streaming': 'æµåª’ä½“',
                'shopping': 'è´­ç‰©æ¶ˆè´¹', 'payment': 'æ”¯ä»˜æ–¹å¼', 'ai': 'äººå·¥æ™ºèƒ½', 'health': 'å¥åº·ç®¡ç†',
                'fitness': 'å¥èº«è¿åŠ¨', 'diet': 'é¥®é£Ÿä¹ æƒ¯', 'sleep': 'ç¡çœ è´¨é‡', 'medical': 'åŒ»ç–—ä¿å¥',
                'stress': 'å‹åŠ›ç®¡ç†', 'mental': 'å¿ƒç†å¥åº·', 'checkup': 'ä½“æ£€æ£€æŸ¥', 'budget': 'é¢„ç®—ç®¡ç†',
                'brands': 'å“ç‰Œåå¥½', 'fashion': 'æ—¶å°šæ½®æµ', 'luxury': 'å¥¢ä¾ˆæ¶ˆè´¹', 'investment': 'æŠ•èµ„ç†è´¢',
                'saving': 'å‚¨è“„è®¡åˆ’', 'credit': 'ä¿¡ç”¨è®°å½•', 'insurance': 'ä¿é™©ä¿éšœ', 'movies': 'ç”µå½±å¨±ä¹',
                'music': 'éŸ³ä¹æ¬£èµ', 'books': 'é˜…è¯»ä¹ æƒ¯', 'travel': 'æ—…æ¸¸å‡ºè¡Œ', 'sports': 'ä½“è‚²è¿åŠ¨',
                'hobbies': 'å…´è¶£çˆ±å¥½', 'clubs': 'ä¿±ä¹éƒ¨', 'events': 'æ´»åŠ¨å‚ä¸',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'åŸå¸‚ç¯å¢ƒ': 'åŸå¸‚ç¯å¢ƒ', 'åŒºåŸŸè®¾å®š': 'åŒºåŸŸè®¾å®š', 'ä½æˆ¿æƒ…å†µ': 'ä½æˆ¿æƒ…å†µ', 'äº¤é€šå·¥å…·': 'äº¤é€šå·¥å…·',
                'ç¤¾åŒºç¯å¢ƒ': 'ç¤¾åŒºç¯å¢ƒ', 'è®¾æ–½é…å¥—': 'è®¾æ–½é…å¥—', 'ç”Ÿæ´»æˆæœ¬': 'ç”Ÿæ´»æˆæœ¬', 'å®‰å…¨çŠ¶å†µ': 'å®‰å…¨çŠ¶å†µ',
                'ç¯å¢ƒæ±¡æŸ“': 'ç¯å¢ƒæ±¡æŸ“', 'èŒä¸šå·¥ä½œ': 'èŒä¸šå·¥ä½œ', 'å…¬å¸ä¼ä¸š': 'å…¬å¸ä¼ä¸š', 'èŒä½ç­‰çº§': 'èŒä½ç­‰çº§',
                'æ”¶å…¥æ°´å¹³': 'æ”¶å…¥æ°´å¹³', 'å·¥ä½œæ—¶é—´': 'å·¥ä½œæ—¶é—´', 'ç¦åˆ©å¾…é‡': 'ç¦åˆ©å¾…é‡', 'èŒä¸šå‘å±•': 'èŒä¸šå‘å±•',
                'æŠ€èƒ½è¦æ±‚': 'æŠ€èƒ½è¦æ±‚', 'æ•™è‚²èƒŒæ™¯': 'æ•™è‚²èƒŒæ™¯', 'æ™ºèƒ½æ‰‹æœº': 'æ™ºèƒ½æ‰‹æœº', 'ç”µè„‘è®¾å¤‡': 'ç”µè„‘è®¾å¤‡',
                'ç½‘ç»œè¿æ¥': 'ç½‘ç»œè¿æ¥', 'ç¤¾äº¤åª’ä½“': 'ç¤¾äº¤åª’ä½“', 'æ¸¸æˆå¨±ä¹': 'æ¸¸æˆå¨±ä¹', 'æµåª’ä½“': 'æµåª’ä½“',
                'è´­ç‰©æ¶ˆè´¹': 'è´­ç‰©æ¶ˆè´¹', 'æ”¯ä»˜æ–¹å¼': 'æ”¯ä»˜æ–¹å¼', 'äººå·¥æ™ºèƒ½': 'äººå·¥æ™ºèƒ½', 'å¥åº·ç®¡ç†': 'å¥åº·ç®¡ç†',
                'å¥èº«è¿åŠ¨': 'å¥èº«è¿åŠ¨', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'ç¡çœ è´¨é‡': 'ç¡çœ è´¨é‡', 'åŒ»ç–—ä¿å¥': 'åŒ»ç–—ä¿å¥',
                'å‹åŠ›ç®¡ç†': 'å‹åŠ›ç®¡ç†', 'å¿ƒç†å¥åº·': 'å¿ƒç†å¥åº·', 'ä½“æ£€æ£€æŸ¥': 'ä½“æ£€æ£€æŸ¥', 'é¢„ç®—ç®¡ç†': 'é¢„ç®—ç®¡ç†',
                'å“ç‰Œåå¥½': 'å“ç‰Œåå¥½', 'æ—¶å°šæ½®æµ': 'æ—¶å°šæ½®æµ', 'å¥¢ä¾ˆæ¶ˆè´¹': 'å¥¢ä¾ˆæ¶ˆè´¹', 'æŠ•èµ„ç†è´¢': 'æŠ•èµ„ç†è´¢',
                'å‚¨è“„è®¡åˆ’': 'å‚¨è“„è®¡åˆ’', 'ä¿¡ç”¨è®°å½•': 'ä¿¡ç”¨è®°å½•', 'ä¿é™©ä¿éšœ': 'ä¿é™©ä¿éšœ', 'ç”µå½±å¨±ä¹': 'ç”µå½±å¨±ä¹',
                'éŸ³ä¹æ¬£èµ': 'éŸ³ä¹æ¬£èµ', 'é˜…è¯»ä¹ æƒ¯': 'é˜…è¯»ä¹ æƒ¯', 'æ—…æ¸¸å‡ºè¡Œ': 'æ—…æ¸¸å‡ºè¡Œ', 'ä½“è‚²è¿åŠ¨': 'ä½“è‚²è¿åŠ¨',
                'å…´è¶£çˆ±å¥½': 'å…´è¶£çˆ±å¥½', 'ä¿±ä¹éƒ¨': 'ä¿±ä¹éƒ¨', 'æ´»åŠ¨å‚ä¸': 'æ´»åŠ¨å‚ä¸'
            },
            historical: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'dynasty': 'æœä»£èƒŒæ™¯', 'period': 'å†å²æ—¶æœŸ', 'emperor': 'çš‡å¸å›ä¸»', 'capital': 'éƒ½åŸé¦–åºœ',
                'region': 'åœ°åŸŸåˆ†å¸ƒ', 'events': 'å†å²äº‹ä»¶', 'wars': 'æˆ˜äº‰å†²çª', 'politics': 'æ”¿æ²»åˆ¶åº¦',
                'economy': 'ç»æµçŠ¶å†µ', 'class': 'ç¤¾ä¼šé˜¶å±‚', 'title': 'çˆµä½å¤´è¡”', 'family': 'å®¶æ—èƒŒæ™¯',
                'wealth': 'è´¢å¯ŒçŠ¶å†µ', 'land': 'åœŸåœ°è´¢äº§', 'servants': 'ä»†ä»éšä»', 'influence': 'å½±å“åŠ›',
                'reputation': 'åå£°å£°èª‰', 'connections': 'äººè„‰å…³ç³»', 'education': 'æ•™è‚²ç¨‹åº¦', 'poetry': 'è¯—è¯æ–‡å­¦',
                'calligraphy': 'ä¹¦æ³•è‰ºæœ¯', 'music': 'éŸ³ä¹æ‰è‰º', 'chess': 'æ£‹è‰ºæŠ€å·§', 'classics': 'ç»å…¸å­¦é—®',
                'philosophy': 'å“²å­¦æ€æƒ³', 'etiquette': 'ç¤¼ä»ªè§„èŒƒ', 'language': 'è¯­è¨€æ–‡å­—', 'martial': 'æ­¦è‰ºä¿®ä¸º',
                'weapons': 'å…µå™¨ä½¿ç”¨', 'archery': 'å°„ç®­æŠ€è‰º', 'horsemanship': 'éª‘æœ¯æŠ€èƒ½', 'strategy': 'å…µæ³•è°‹ç•¥',
                'bodyguard': 'æŠ¤å«éšä»', 'hunting': 'ç‹©çŒæŠ€èƒ½', 'survival': 'ç”Ÿå­˜æŠ€èƒ½', 'residence': 'å±…ä½ç¯å¢ƒ',
                'clothing': 'æœé¥°é£æ ¼', 'food': 'é¥®é£Ÿä¹ æƒ¯', 'transport': 'å‡ºè¡Œæ–¹å¼', 'entertainment': 'å¨±ä¹æ´»åŠ¨',
                'festivals': 'èŠ‚åº†æ´»åŠ¨', 'religion': 'å®—æ•™ä¿¡ä»°', 'medicine': 'åŒ»å­¦çŸ¥è¯†', 'profession': 'èŒä¸šèº«ä»½',
                'crafts': 'æ‰‹å·¥æŠ€è‰º', 'trade': 'å•†è´¸æ´»åŠ¨', 'farming': 'å†œä¸šç”Ÿäº§', 'administration': 'è¡Œæ”¿ç®¡ç†',
                'teaching': 'æ•™å­¦ä¼ æˆ', 'healing': 'åŒ»ç–—æ•‘æ²»', 'construction': 'å»ºç­‘è¥é€ ',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»£èƒŒæ™¯': 'æœä»£èƒŒæ™¯', 'å†å²æ—¶æœŸ': 'å†å²æ—¶æœŸ', 'çš‡å¸å›ä¸»': 'çš‡å¸å›ä¸»', 'éƒ½åŸé¦–åºœ': 'éƒ½åŸé¦–åºœ',
                'åœ°åŸŸåˆ†å¸ƒ': 'åœ°åŸŸåˆ†å¸ƒ', 'å†å²äº‹ä»¶': 'å†å²äº‹ä»¶', 'æˆ˜äº‰å†²çª': 'æˆ˜äº‰å†²çª', 'æ”¿æ²»åˆ¶åº¦': 'æ”¿æ²»åˆ¶åº¦',
                'ç»æµçŠ¶å†µ': 'ç»æµçŠ¶å†µ', 'ç¤¾ä¼šé˜¶å±‚': 'ç¤¾ä¼šé˜¶å±‚', 'çˆµä½å¤´è¡”': 'çˆµä½å¤´è¡”', 'å®¶æ—èƒŒæ™¯': 'å®¶æ—èƒŒæ™¯',
                'è´¢å¯ŒçŠ¶å†µ': 'è´¢å¯ŒçŠ¶å†µ', 'åœŸåœ°è´¢äº§': 'åœŸåœ°è´¢äº§', 'ä»†ä»éšä»': 'ä»†ä»éšä»', 'å½±å“åŠ›': 'å½±å“åŠ›',
                'åå£°å£°èª‰': 'åå£°å£°èª‰', 'äººè„‰å…³ç³»': 'äººè„‰å…³ç³»', 'æ•™è‚²ç¨‹åº¦': 'æ•™è‚²ç¨‹åº¦', 'è¯—è¯æ–‡å­¦': 'è¯—è¯æ–‡å­¦',
                'ä¹¦æ³•è‰ºæœ¯': 'ä¹¦æ³•è‰ºæœ¯', 'éŸ³ä¹æ‰è‰º': 'éŸ³ä¹æ‰è‰º', 'æ£‹è‰ºæŠ€å·§': 'æ£‹è‰ºæŠ€å·§', 'ç»å…¸å­¦é—®': 'ç»å…¸å­¦é—®',
                'å“²å­¦æ€æƒ³': 'å“²å­¦æ€æƒ³', 'ç¤¼ä»ªè§„èŒƒ': 'ç¤¼ä»ªè§„èŒƒ', 'è¯­è¨€æ–‡å­—': 'è¯­è¨€æ–‡å­—', 'æ­¦è‰ºä¿®ä¸º': 'æ­¦è‰ºä¿®ä¸º',
                'å…µå™¨ä½¿ç”¨': 'å…µå™¨ä½¿ç”¨', 'å°„ç®­æŠ€è‰º': 'å°„ç®­æŠ€è‰º', 'éª‘æœ¯æŠ€èƒ½': 'éª‘æœ¯æŠ€èƒ½', 'å…µæ³•è°‹ç•¥': 'å…µæ³•è°‹ç•¥',
                'æŠ¤å«éšä»': 'æŠ¤å«éšä»', 'ç‹©çŒæŠ€èƒ½': 'ç‹©çŒæŠ€èƒ½', 'ç”Ÿå­˜æŠ€èƒ½': 'ç”Ÿå­˜æŠ€èƒ½', 'å±…ä½ç¯å¢ƒ': 'å±…ä½ç¯å¢ƒ',
                'æœé¥°é£æ ¼': 'æœé¥°é£æ ¼', 'é¥®é£Ÿä¹ æƒ¯': 'é¥®é£Ÿä¹ æƒ¯', 'å‡ºè¡Œæ–¹å¼': 'å‡ºè¡Œæ–¹å¼', 'å¨±ä¹æ´»åŠ¨': 'å¨±ä¹æ´»åŠ¨',
                'èŠ‚åº†æ´»åŠ¨': 'èŠ‚åº†æ´»åŠ¨', 'å®—æ•™ä¿¡ä»°': 'å®—æ•™ä¿¡ä»°', 'åŒ»å­¦çŸ¥è¯†': 'åŒ»å­¦çŸ¥è¯†', 'èŒä¸šèº«ä»½': 'èŒä¸šèº«ä»½',
                'æ‰‹å·¥æŠ€è‰º': 'æ‰‹å·¥æŠ€è‰º', 'å•†è´¸æ´»åŠ¨': 'å•†è´¸æ´»åŠ¨', 'å†œä¸šç”Ÿäº§': 'å†œä¸šç”Ÿäº§', 'è¡Œæ”¿ç®¡ç†': 'è¡Œæ”¿ç®¡ç†',
                'æ•™å­¦ä¼ æˆ': 'æ•™å­¦ä¼ æˆ', 'åŒ»ç–—æ•‘æ²»': 'åŒ»ç–—æ•‘æ²»', 'å»ºç­‘è¥é€ ': 'å»ºç­‘è¥é€ '
            },
            magic: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'evocation': 'å¡‘èƒ½ç³»', 'illusion': 'å¹»æœ¯ç³»', 'enchantment': 'æƒ‘æ§ç³»', 'necromancy': 'æ­»çµç³»',
                'divination': 'é¢„è¨€ç³»', 'transmutation': 'å˜åŒ–ç³»', 'conjuration': 'å’’æ³•ç³»', 'abjuration': 'é˜²æŠ¤ç³»',
                'elemental': 'å…ƒç´ æ³•æœ¯', 'cantrip': 'æˆæ³•æ³•æœ¯', 'level1': 'ä¸€ç¯æ³•æœ¯', 'level2': 'äºŒç¯æ³•æœ¯',
                'level3': 'ä¸‰ç¯æ³•æœ¯', 'level4': 'å››ç¯æ³•æœ¯', 'level5': 'äº”ç¯æ³•æœ¯', 'level6': 'å…­ç¯æ³•æœ¯',
                'level7': 'ä¸ƒç¯æ³•æœ¯', 'level8': 'å…«ç¯æ³•æœ¯', 'level9': 'ä¹ç¯æ³•æœ¯', 'level': 'æ³•æœ¯ç­‰çº§',
                'mana': 'æ³•åŠ›å€¼', 'intelligence': 'æ™ºåŠ›å±æ€§', 'wisdom': 'æ„ŸçŸ¥å±æ€§', 'charisma': 'é­…åŠ›å±æ€§',
                'concentration': 'ä¸“æ³¨èƒ½åŠ›', 'spellpower': 'æ³•æœ¯å¼ºåº¦', 'resistance': 'é­”æ³•æŠ—æ€§', 'regeneration': 'æ³•åŠ›å›å¤',
                'spellbook': 'æ³•æœ¯ä¹¦', 'known': 'å·²çŸ¥æ³•æœ¯', 'prepared': 'å‡†å¤‡æ³•æœ¯', 'slots': 'æ³•æœ¯ä½',
                'components': 'æ–½æ³•ææ–™', 'rituals': 'ä»ªå¼æ³•æœ¯', 'metamagic': 'è¶…é­”ä¸“é•¿', 'scrolls': 'æ³•æœ¯å·è½´',
                'fire': 'ç«å…ƒç´ ', 'water': 'æ°´å…ƒç´ ', 'earth': 'åœŸå…ƒç´ ', 'air': 'é£å…ƒç´ ',
                'lightning': 'é›·ç”µ', 'ice': 'å†°éœœ', 'light': 'å…‰æ˜', 'dark': 'é»‘æš—',
                'staff': 'æ³•æ–', 'wand': 'é­”æ–', 'orb': 'æ³•çƒ', 'robe': 'æ³•è¢',
                'amulet': 'æŠ¤ç¬¦', 'ring': 'é­”æ³•æˆ’æŒ‡', 'crystal': 'é­”æ³•æ°´æ™¶', 'tome': 'é­”æ³•å…¸ç±',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'å¡‘èƒ½ç³»': 'å¡‘èƒ½ç³»', 'å¹»æœ¯ç³»': 'å¹»æœ¯ç³»', 'æƒ‘æ§ç³»': 'æƒ‘æ§ç³»', 'æ­»çµç³»': 'æ­»çµç³»',
                'é¢„è¨€ç³»': 'é¢„è¨€ç³»', 'å˜åŒ–ç³»': 'å˜åŒ–ç³»', 'å’’æ³•ç³»': 'å’’æ³•ç³»', 'é˜²æŠ¤ç³»': 'é˜²æŠ¤ç³»',
                'å…ƒç´ æ³•æœ¯': 'å…ƒç´ æ³•æœ¯', 'æˆæ³•æ³•æœ¯': 'æˆæ³•æ³•æœ¯', 'ä¸€ç¯æ³•æœ¯': 'ä¸€ç¯æ³•æœ¯', 'äºŒç¯æ³•æœ¯': 'äºŒç¯æ³•æœ¯',
                'ä¸‰ç¯æ³•æœ¯': 'ä¸‰ç¯æ³•æœ¯', 'å››ç¯æ³•æœ¯': 'å››ç¯æ³•æœ¯', 'äº”ç¯æ³•æœ¯': 'äº”ç¯æ³•æœ¯', 'å…­ç¯æ³•æœ¯': 'å…­ç¯æ³•æœ¯',
                'ä¸ƒç¯æ³•æœ¯': 'ä¸ƒç¯æ³•æœ¯', 'å…«ç¯æ³•æœ¯': 'å…«ç¯æ³•æœ¯', 'ä¹ç¯æ³•æœ¯': 'ä¹ç¯æ³•æœ¯', 'æ³•æœ¯ç­‰çº§': 'æ³•æœ¯ç­‰çº§',
                'æ³•åŠ›å€¼': 'æ³•åŠ›å€¼', 'æ™ºåŠ›å±æ€§': 'æ™ºåŠ›å±æ€§', 'æ„ŸçŸ¥å±æ€§': 'æ„ŸçŸ¥å±æ€§', 'é­…åŠ›å±æ€§': 'é­…åŠ›å±æ€§',
                'ä¸“æ³¨èƒ½åŠ›': 'ä¸“æ³¨èƒ½åŠ›', 'æ³•æœ¯å¼ºåº¦': 'æ³•æœ¯å¼ºåº¦', 'é­”æ³•æŠ—æ€§': 'é­”æ³•æŠ—æ€§', 'æ³•åŠ›å›å¤': 'æ³•åŠ›å›å¤',
                'æ³•æœ¯ä¹¦': 'æ³•æœ¯ä¹¦', 'å·²çŸ¥æ³•æœ¯': 'å·²çŸ¥æ³•æœ¯', 'å‡†å¤‡æ³•æœ¯': 'å‡†å¤‡æ³•æœ¯', 'æ³•æœ¯ä½': 'æ³•æœ¯ä½',
                'æ–½æ³•ææ–™': 'æ–½æ³•ææ–™', 'ä»ªå¼æ³•æœ¯': 'ä»ªå¼æ³•æœ¯', 'è¶…é­”ä¸“é•¿': 'è¶…é­”ä¸“é•¿', 'æ³•æœ¯å·è½´': 'æ³•æœ¯å·è½´',
                'ç«å…ƒç´ ': 'ç«å…ƒç´ ', 'æ°´å…ƒç´ ': 'æ°´å…ƒç´ ', 'åœŸå…ƒç´ ': 'åœŸå…ƒç´ ', 'é£å…ƒç´ ': 'é£å…ƒç´ ',
                'é›·ç”µ': 'é›·ç”µ', 'å†°éœœ': 'å†°éœœ', 'å…‰æ˜': 'å…‰æ˜', 'é»‘æš—': 'é»‘æš—',
                'æ³•æ–': 'æ³•æ–', 'é­”æ–': 'é­”æ–', 'æ³•çƒ': 'æ³•çƒ', 'æ³•è¢': 'æ³•è¢',
                'æŠ¤ç¬¦': 'æŠ¤ç¬¦', 'é­”æ³•æˆ’æŒ‡': 'é­”æ³•æˆ’æŒ‡', 'é­”æ³•æ°´æ™¶': 'é­”æ³•æ°´æ™¶', 'é­”æ³•å…¸ç±': 'é­”æ³•å…¸ç±'
            },
            training: {
                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…å­˜åœ¨çš„è‹±æ–‡å­—æ®µkeyå€¼åˆ›å»ºæ˜ å°„
                'obedience': 'æœä»è®­ç»ƒ', 'discipline': 'çºªå¾‹è®­ç»ƒ', 'etiquette': 'ç¤¼ä»ªè®­ç»ƒ', 'posture': 'å§¿æ€è®­ç»ƒ',
                'speech': 'è¨€è¯­è®­ç»ƒ', 'behavior': 'è¡Œä¸ºè®­ç»ƒ', 'attention': 'æ³¨æ„åŠ›è®­ç»ƒ', 'patience': 'è€å¿ƒè®­ç»ƒ',
                'focus': 'ä¸“æ³¨è®­ç»ƒ', 'service': 'æœåŠ¡è®­ç»ƒ', 'cooking': 'çƒ¹é¥ªè®­ç»ƒ', 'cleaning': 'æ¸…æ´è®­ç»ƒ',
                'massage': 'æŒ‰æ‘©è®­ç»ƒ', 'entertainment': 'å¨±ä¹è®­ç»ƒ', 'music': 'éŸ³ä¹è®­ç»ƒ', 'dance': 'èˆè¹ˆè®­ç»ƒ',
                'art': 'è‰ºæœ¯è®­ç»ƒ', 'language': 'è¯­è¨€è®­ç»ƒ', 'strength': 'åŠ›é‡è®­ç»ƒ', 'endurance': 'è€åŠ›è®­ç»ƒ',
                'flexibility': 'æŸ”éŸ§è®­ç»ƒ', 'balance': 'å¹³è¡¡è®­ç»ƒ', 'coordination': 'åè°ƒè®­ç»ƒ', 'agility': 'æ•æ·è®­ç»ƒ',
                'stamina': 'ä½“èƒ½è®­ç»ƒ', 'recovery': 'æ¢å¤è®­ç»ƒ', 'confidence': 'è‡ªä¿¡è®­ç»ƒ', 'stress': 'æŠ—å‹è®­ç»ƒ',
                'emotion': 'æƒ…ç»ªè®­ç»ƒ', 'memory': 'è®°å¿†è®­ç»ƒ', 'logic': 'é€»è¾‘è®­ç»ƒ', 'creativity': 'åˆ›é€ è®­ç»ƒ',
                'meditation': 'å†¥æƒ³è®­ç»ƒ', 'mindfulness': 'æ­£å¿µè®­ç»ƒ', 'intensity': 'å¼ºåº¦è®¾ç½®', 'duration': 'æŒç»­æ—¶é—´',
                'frequency': 'è®­ç»ƒé¢‘ç‡', 'progress': 'è¿›åº¦è·Ÿè¸ª', 'rewards': 'å¥–åŠ±æœºåˆ¶', 'punishment': 'æƒ©ç½šæœºåˆ¶',
                'schedule': 'è®­ç»ƒè®¡åˆ’', 'evaluation': 'è¯„ä¼°ç³»ç»Ÿ', 'auto': 'è‡ªåŠ¨è®­ç»ƒ', 'adaptive': 'è‡ªé€‚åº”è®­ç»ƒ',
                'ai': 'AIè¾…åŠ©', 'analytics': 'æ•°æ®åˆ†æ', 'reports': 'è®­ç»ƒæŠ¥å‘Š', 'export': 'å¯¼å‡ºåŠŸèƒ½',
                'backup': 'å¤‡ä»½åŠŸèƒ½', 'sync': 'åŒæ­¥åŠŸèƒ½',

                // ğŸ”§ å®Œæ•´çš„ä¸­æ–‡å­—æ®µåæ˜ å°„ (ä¿æŒä¸å˜)
                'æœä»è®­ç»ƒ': 'æœä»è®­ç»ƒ', 'çºªå¾‹è®­ç»ƒ': 'çºªå¾‹è®­ç»ƒ', 'ç¤¼ä»ªè®­ç»ƒ': 'ç¤¼ä»ªè®­ç»ƒ', 'å§¿æ€è®­ç»ƒ': 'å§¿æ€è®­ç»ƒ',
                'è¨€è¯­è®­ç»ƒ': 'è¨€è¯­è®­ç»ƒ', 'è¡Œä¸ºè®­ç»ƒ': 'è¡Œä¸ºè®­ç»ƒ', 'æ³¨æ„åŠ›è®­ç»ƒ': 'æ³¨æ„åŠ›è®­ç»ƒ', 'è€å¿ƒè®­ç»ƒ': 'è€å¿ƒè®­ç»ƒ',
                'ä¸“æ³¨è®­ç»ƒ': 'ä¸“æ³¨è®­ç»ƒ', 'æœåŠ¡è®­ç»ƒ': 'æœåŠ¡è®­ç»ƒ', 'çƒ¹é¥ªè®­ç»ƒ': 'çƒ¹é¥ªè®­ç»ƒ', 'æ¸…æ´è®­ç»ƒ': 'æ¸…æ´è®­ç»ƒ',
                'æŒ‰æ‘©è®­ç»ƒ': 'æŒ‰æ‘©è®­ç»ƒ', 'å¨±ä¹è®­ç»ƒ': 'å¨±ä¹è®­ç»ƒ', 'éŸ³ä¹è®­ç»ƒ': 'éŸ³ä¹è®­ç»ƒ', 'èˆè¹ˆè®­ç»ƒ': 'èˆè¹ˆè®­ç»ƒ',
                'è‰ºæœ¯è®­ç»ƒ': 'è‰ºæœ¯è®­ç»ƒ', 'è¯­è¨€è®­ç»ƒ': 'è¯­è¨€è®­ç»ƒ', 'åŠ›é‡è®­ç»ƒ': 'åŠ›é‡è®­ç»ƒ', 'è€åŠ›è®­ç»ƒ': 'è€åŠ›è®­ç»ƒ',
                'æŸ”éŸ§è®­ç»ƒ': 'æŸ”éŸ§è®­ç»ƒ', 'å¹³è¡¡è®­ç»ƒ': 'å¹³è¡¡è®­ç»ƒ', 'åè°ƒè®­ç»ƒ': 'åè°ƒè®­ç»ƒ', 'æ•æ·è®­ç»ƒ': 'æ•æ·è®­ç»ƒ',
                'ä½“èƒ½è®­ç»ƒ': 'ä½“èƒ½è®­ç»ƒ', 'æ¢å¤è®­ç»ƒ': 'æ¢å¤è®­ç»ƒ', 'è‡ªä¿¡è®­ç»ƒ': 'è‡ªä¿¡è®­ç»ƒ', 'æŠ—å‹è®­ç»ƒ': 'æŠ—å‹è®­ç»ƒ',
                'æƒ…ç»ªè®­ç»ƒ': 'æƒ…ç»ªè®­ç»ƒ', 'è®°å¿†è®­ç»ƒ': 'è®°å¿†è®­ç»ƒ', 'é€»è¾‘è®­ç»ƒ': 'é€»è¾‘è®­ç»ƒ', 'åˆ›é€ è®­ç»ƒ': 'åˆ›é€ è®­ç»ƒ',
                'å†¥æƒ³è®­ç»ƒ': 'å†¥æƒ³è®­ç»ƒ', 'æ­£å¿µè®­ç»ƒ': 'æ­£å¿µè®­ç»ƒ', 'å¼ºåº¦è®¾ç½®': 'å¼ºåº¦è®¾ç½®', 'æŒç»­æ—¶é—´': 'æŒç»­æ—¶é—´',
                'è®­ç»ƒé¢‘ç‡': 'è®­ç»ƒé¢‘ç‡', 'è¿›åº¦è·Ÿè¸ª': 'è¿›åº¦è·Ÿè¸ª', 'å¥–åŠ±æœºåˆ¶': 'å¥–åŠ±æœºåˆ¶', 'æƒ©ç½šæœºåˆ¶': 'æƒ©ç½šæœºåˆ¶',
                'è®­ç»ƒè®¡åˆ’': 'è®­ç»ƒè®¡åˆ’', 'è¯„ä¼°ç³»ç»Ÿ': 'è¯„ä¼°ç³»ç»Ÿ', 'è‡ªåŠ¨è®­ç»ƒ': 'è‡ªåŠ¨è®­ç»ƒ', 'è‡ªé€‚åº”è®­ç»ƒ': 'è‡ªé€‚åº”è®­ç»ƒ',
                'AIè¾…åŠ©': 'AIè¾…åŠ©', 'æ•°æ®åˆ†æ': 'æ•°æ®åˆ†æ', 'è®­ç»ƒæŠ¥å‘Š': 'è®­ç»ƒæŠ¥å‘Š', 'å¯¼å‡ºåŠŸèƒ½': 'å¯¼å‡ºåŠŸèƒ½',
                'å¤‡ä»½åŠŸèƒ½': 'å¤‡ä»½åŠŸèƒ½', 'åŒæ­¥åŠŸèƒ½': 'åŒæ­¥åŠŸèƒ½'
            }
        };

        // ğŸ”§ æ–°å¢ï¼šåŠ¨æ€æ·»åŠ è‡ªå®šä¹‰é¢æ¿çš„å­—æ®µæ˜ å°„
        try {
            const customPanels = this.getCustomPanels();
            for (const [panelId, panelConfig] of Object.entries(customPanels)) {
                if (panelConfig && panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
                    // ä¸ºæ¯ä¸ªè‡ªå®šä¹‰é¢æ¿åˆ›å»ºå­—æ®µæ˜ å°„
                    const customPanelMapping = {};

                    panelConfig.subItems.forEach(subItem => {
                        if (subItem.key) {
                            // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨displayNameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨nameä½œä¸ºæ˜¾ç¤ºåç§°
                            const displayName = subItem.displayName || subItem.name || subItem.key;

                            // ä½¿ç”¨å­—æ®µçš„keyä½œä¸ºæ˜ å°„é”®
                            customPanelMapping[subItem.key] = displayName;

                            // ğŸ”§ å…¼å®¹æ€§ï¼šåŒæ—¶æ”¯æŒnameå­—æ®µï¼ˆå¦‚æœä¸keyä¸åŒï¼‰
                            if (subItem.name && subItem.name !== subItem.key) {
                                customPanelMapping[subItem.name] = displayName;
                            }
                        }
                    });

                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆå¹¶è‡ªå®šä¹‰é¢æ¿æ˜ å°„ï¼Œä¸è¦è¦†ç›–åŸºç¡€æ˜ å°„ï¼
                    if (Object.keys(customPanelMapping).length > 0) {
                        // ä½¿ç”¨åˆå¹¶è€Œä¸æ˜¯è¦†ç›–ï¼Œç¡®ä¿æ ‡å‡†æ˜ å°„ä¸ä¼šä¸¢å¤±
                        baseMapping[panelId] = {
                            ...(baseMapping[panelId] || {}), // ä¿ç•™å·²æœ‰çš„åŸºç¡€æ˜ å°„
                            ...customPanelMapping              // æ·»åŠ è‡ªå®šä¹‰å­—æ®µæ˜ å°„
                        };
                        // ğŸ”§ ä¿®å¤ï¼šåªåœ¨é¦–æ¬¡ç”Ÿæˆæ—¶è¾“å‡ºæ—¥å¿—ï¼Œé¿å…é‡å¤æ—¥å¿—
                        if (!this._cachedCompleteMapping) {
                            console.log(`[InfoBarSettings] ğŸ“Š æ·»åŠ è‡ªå®šä¹‰é¢æ¿å­—æ®µæ˜ å°„: ${panelId}`, customPanelMapping);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ è‡ªå®šä¹‰é¢æ¿å­—æ®µæ˜ å°„å¤±è´¥:', error);
        }

        // ğŸ”§ æ–°å¢ï¼šç¼“å­˜æ˜ å°„ç»“æœ
        this._cachedCompleteMapping = baseMapping;

        console.log('[InfoBarSettings] âœ… å®Œæ•´æ˜¾ç¤ºåç§°æ˜ å°„ç”Ÿæˆå®Œæˆ:', Object.keys(baseMapping));
        return baseMapping;
    }

    /**
     * æ›´æ–°å­é¡¹åˆ—è¡¨
     */
    updateSubitemList(menu, panelType) {
        try {
            console.log(`[InfoBarSettings] ğŸ”„ æ›´æ–°å­é¡¹åˆ—è¡¨: ${panelType}`);

            const subitemList = menu.querySelector('.subitem-list');
            if (!subitemList) return;

            // åŠ¨æ€è·å–é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            const panelConfig = enabledPanels[panelType];

            if (!panelConfig) {
                console.warn(`[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é¢æ¿é…ç½®: ${panelType}`);
                return;
            }

            // ç”Ÿæˆæ–°çš„å­é¡¹åˆ—è¡¨HTML
            const newSubitemListHtml = this.generateSubitemListHtml(panelType, panelConfig);
            subitemList.innerHTML = newSubitemListHtml;

            // é‡æ–°ç»‘å®šå­é¡¹æŒ‰é’®äº‹ä»¶
            const newAddSubitemBtns = subitemList.querySelectorAll('.add-subitem-btn');
            newAddSubitemBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fieldType = btn.closest('.subitem-item').dataset.field;
                    const area = menu.querySelector('.menu-header h3').textContent.includes('é¡¶éƒ¨') ? 'top' : 'bottom';
                    console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹: ${fieldType} åˆ° ${area}`);
                    this.addSubitemToPreview(fieldType, area, 'new');
                    menu.remove();
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å­é¡¹åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ é¢æ¿åˆ°é¢„è§ˆ
     */
    addPanelToPreview(panelType, area, position) {
        try {
            console.log(`[InfoBarSettings] ğŸ­ æ·»åŠ é¢æ¿åˆ°é¢„è§ˆ: ${panelType} (åŒºåŸŸ: ${area}, ä½ç½®: ${position})`);

            // æ ¹æ®åŒºåŸŸé€‰æ‹©æ­£ç¡®çš„å®¹å™¨
            const containerClass = area === 'top' ? '.top-embedded-panels' : '.bottom-embedded-panels';
            const embeddedPanels = this.modal?.querySelector(containerClass);
            if (!embeddedPanels) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°${area}åŒºåŸŸçš„åµŒå…¥é¢æ¿å®¹å™¨`);
                return;
            }

            // åŠ¨æ€è·å–é¢æ¿é…ç½®
            const enabledPanels = this.getEnabledPanels();
            const panelConfig = enabledPanels[panelType];

            if (!panelConfig) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°é¢æ¿é…ç½®: ${panelType}`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é¢„è§ˆå…ƒç´ åˆ›å»ºé¢æ¿ï¼Œä¿æŒä¸€è‡´æ€§
            const panelButton = this.createPreviewPanelElement(panelType, 'panel');
            if (!panelButton) {
                console.error(`[InfoBarSettings] âŒ åˆ›å»ºé¢æ¿é¢„è§ˆå…ƒç´ å¤±è´¥: ${panelType}`);
                return;
            }

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            panelButton.addEventListener('click', () => {
                this.showDemoPanelPopup(panelType);
            });

            // æ ¹æ®ä½ç½®æ’å…¥
            if (position === 'top') {
                embeddedPanels.insertBefore(panelButton, embeddedPanels.firstChild);
            } else {
                embeddedPanels.appendChild(panelButton);
            }

            // å°†æ·»åŠ çš„é¢æ¿å†™å…¥é…ç½®å¸ƒå±€
            this.persistFrontendLayout({ type: 'panel', id: panelType }, area);

            // è·å–é¢æ¿åç§°ç”¨äºæ—¥å¿—
            const config = this.getPanelDisplayInfo(panelType, panelConfig);
            console.log(`[InfoBarSettings] âœ… é¢æ¿ ${config.name} å·²æ·»åŠ åˆ°é¢„è§ˆ`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿åˆ°é¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­é¡¹åˆ°é¢„è§ˆ
     */
    addSubitemToPreview(fieldType, area, position) {
        try {
            console.log(`[InfoBarSettings] ğŸ”§ æ·»åŠ å­é¡¹åˆ°é¢„è§ˆ: ${fieldType} (åŒºåŸŸ: ${area}, ä½ç½®: ${position})`);

            // æ ¹æ®åŒºåŸŸé€‰æ‹©æ­£ç¡®çš„å®¹å™¨
            const containerClass = area === 'top' ? '.top-embedded-panels' : '.bottom-embedded-panels';
            const embeddedPanels = this.modal?.querySelector(containerClass);
            if (!embeddedPanels) {
                console.error(`[InfoBarSettings] âŒ æœªæ‰¾åˆ°${area}åŒºåŸŸçš„åµŒå…¥é¢æ¿å®¹å™¨`);
                return;
            }

            // åŠ¨æ€è·å–å­é¡¹æ˜¾ç¤ºåç§°
            const displayName = this.getSubitemDisplayName(fieldType);
            const config = {
                field: displayName,
                value: this.getSubitemDemoValue(fieldType, displayName)
            };

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é¢„è§ˆå…ƒç´ åˆ›å»ºå­é¡¹ï¼Œä¿æŒä¸€è‡´æ€§
            const subitemDisplay = this.createPreviewPanelElement(fieldType, 'subitem');
            if (!subitemDisplay) {
                console.error(`[InfoBarSettings] âŒ åˆ›å»ºå­é¡¹é¢„è§ˆå…ƒç´ å¤±è´¥: ${fieldType}`);
                return;
            }

            // æ ¹æ®ä½ç½®æ’å…¥
            if (position === 'top') {
                embeddedPanels.insertBefore(subitemDisplay, embeddedPanels.firstChild);
            } else {
                embeddedPanels.appendChild(subitemDisplay);
            }

            // å°†æ·»åŠ çš„å­é¡¹å†™å…¥é…ç½®å¸ƒå±€
            const resolvedId = this.resolveFieldQualifiedId(fieldType);
            this.persistFrontendLayout({ type: 'subitem', id: resolvedId }, area);

            console.log(`[InfoBarSettings] âœ… å­é¡¹ ${config.field} å·²æ·»åŠ åˆ°é¢„è§ˆ`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­é¡¹åˆ°é¢„è§ˆå¤±è´¥:', error);
        }
    }
    /**
     * è·å–å­é¡¹æ˜¾ç¤ºåç§°
     */
    getSubitemDisplayName(fieldKey) {
        try {
            // ğŸ”§ ä¿®å¤ï¼šå¤„ç†å®Œæ•´IDæ ¼å¼ï¼ˆpanel.fieldï¼‰å’Œç®€å•å­—æ®µå
            let targetPanelId = null;
            let targetFieldKey = fieldKey;

            if (fieldKey.includes('.')) {
                [targetPanelId, targetFieldKey] = fieldKey.split('.');
            }

            const enabledPanels = this.getEnabledPanels();

            // å¦‚æœæŒ‡å®šäº†é¢æ¿IDï¼Œåªåœ¨è¯¥é¢æ¿ä¸­æŸ¥æ‰¾
            if (targetPanelId && enabledPanels[targetPanelId]) {
                const subItems = this.getEnabledSubItems(targetPanelId, enabledPanels[targetPanelId]);
                const foundSubItem = subItems.find(item => item.key === targetFieldKey);

                if (foundSubItem) {
                    return foundSubItem.displayName;
                }

                // å¦‚æœåœ¨æŒ‡å®šé¢æ¿ä¸­æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»å®Œæ•´æ˜ å°„ä¸­è·å–
                const completeMapping = this.getCompleteDisplayNameMapping();
                if (completeMapping[targetPanelId] && completeMapping[targetPanelId][targetFieldKey]) {
                    return completeMapping[targetPanelId][targetFieldKey];
                }
            } else {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šé¢æ¿IDï¼Œåœ¨æ‰€æœ‰é¢æ¿ä¸­æŸ¥æ‰¾
                for (const [panelId, panelConfig] of Object.entries(enabledPanels)) {
                    const subItems = this.getEnabledSubItems(panelId, panelConfig);
                    const foundSubItem = subItems.find(item => item.key === targetFieldKey);

                    if (foundSubItem) {
                        return foundSubItem.displayName;
                    }
                }
            }

            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›å­—æ®µé”®å
            return targetFieldKey;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å­é¡¹æ˜¾ç¤ºåç§°å¤±è´¥:', error);
            return fieldKey;
        }
    }

    /**
     * è·å–å­é¡¹æ¼”ç¤ºå€¼
     */
    getSubitemDemoValue(fieldKey, displayName) {
        // æ ¹æ®å­—æ®µç±»å‹è¿”å›åˆé€‚çš„æ¼”ç¤ºå€¼
        const demoValues = {
            // ä¸ªäººä¿¡æ¯ç›¸å…³
            'name': 'å¼ ä¸‰',
            'age': '25å²',
            'gender': 'ç”·',
            'occupation': 'å†’é™©è€…',
            'level': 'Lv.15',
            'experience': '2847/3000',
            'health': 'è‰¯å¥½',
            'mood': 'æ„‰å¿«',

            // äº¤äº’å¯¹è±¡ç›¸å…³
            'npc_name': 'è‰¾è‰ä¸',
            'relationship': 'æœ‹å‹',
            'attitude': 'å‹å¥½',
            'favorability': '70/100',
            'emotion': 'é«˜å…´',

            // ä¸–ç•Œä¿¡æ¯ç›¸å…³
            'location': 'è‰¾å°”ç™»åŸ',
            'time': 'ä¸Šåˆ10ç‚¹',
            'weather': 'æ™´æœ—',
            'environment': 'åŸå¸‚è¡—é“',
            'atmosphere': 'ç¹å¿™',

            // èƒŒåŒ…ç›¸å…³
            'gold': '1,247æš',
            'weapon': 'é“¶å‰‘',
            'armor': 'çš®ç”²',
            'items': 'ç”Ÿå‘½è¯æ°´ x3',
            'consumables': 'é¢åŒ… x5'
        };

        // å¦‚æœæœ‰é¢„è®¾å€¼ï¼Œä½¿ç”¨é¢„è®¾å€¼
        if (demoValues[fieldKey]) {
            return demoValues[fieldKey];
        }

        // æ ¹æ®æ˜¾ç¤ºåç§°æ¨æµ‹åˆé€‚çš„å€¼
        if (displayName.includes('åç§°') || displayName.includes('å§“å')) {
            return 'ç¤ºä¾‹åç§°';
        } else if (displayName.includes('ç­‰çº§') || displayName.includes('çº§åˆ«')) {
            return 'Lv.1';
        } else if (displayName.includes('æ•°é‡')) {
            return '5';
        } else if (displayName.includes('çŠ¶æ€')) {
            return 'æ­£å¸¸';
        } else {
            return 'ç¤ºä¾‹å€¼';
        }
    }

    /**
     * æ¸…ç©ºé¢„è§ˆå†…å®¹
     */
    clearPreviewContent() {
        try {
            console.log('[InfoBarSettings] ğŸ§¹ æ¸…ç©ºé¢„è§ˆå†…å®¹');

            let totalCleared = 0;

            // æ¸…ç©ºé¡¶éƒ¨åŒºåŸŸ
            const topEmbeddedPanels = this.modal?.querySelector('.top-embedded-panels');
            if (topEmbeddedPanels) {
                const topDynamicElements = topEmbeddedPanels.querySelectorAll('.panel-button:not(.demo), .subitem-display:not(.demo)');
                topDynamicElements.forEach(element => element.remove());
                totalCleared += topDynamicElements.length;
                console.log(`[InfoBarSettings] ğŸ” å·²æ¸…ç©ºé¡¶éƒ¨åŒºåŸŸ ${topDynamicElements.length} ä¸ªåŠ¨æ€å…ƒç´ `);
            }

            // æ¸…ç©ºåº•éƒ¨åŒºåŸŸ
            const bottomEmbeddedPanels = this.modal?.querySelector('.bottom-embedded-panels');
            if (bottomEmbeddedPanels) {
                const bottomDynamicElements = bottomEmbeddedPanels.querySelectorAll('.panel-button:not(.demo), .subitem-display:not(.demo)');
                bottomDynamicElements.forEach(element => element.remove());
                totalCleared += bottomDynamicElements.length;
                console.log(`[InfoBarSettings] ğŸ”½ å·²æ¸…ç©ºåº•éƒ¨åŒºåŸŸ ${bottomDynamicElements.length} ä¸ªåŠ¨æ€å…ƒç´ `);
            }

            console.log(`[InfoBarSettings] âœ… æ€»å…±æ¸…ç©º ${totalCleared} ä¸ªåŠ¨æ€å…ƒç´ `);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸…ç©ºé¢„è§ˆå†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * å°†æ·»åŠ çš„é¢æ¿/å­é¡¹æŒä¹…åŒ–åˆ°å‰ç«¯æ˜¾ç¤ºé…ç½®
     */
    async persistFrontendLayout(item, area) {
        try {
            console.log(`[InfoBarSettings] ğŸ’¾ æŒä¹…åŒ–å‰ç«¯å¸ƒå±€: ${item.type} ${item.id} åˆ° ${area}`);

            // ä½¿ç”¨FrontendDisplayManagerçš„æ ‡å‡†è¯»å–å’Œä¿å­˜æ–¹æ³•ï¼Œç¡®ä¿é…ç½®ä¸€è‡´æ€§
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è¯»å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();
            console.log('[InfoBarSettings] ğŸ“‹ å½“å‰é…ç½®:', currentConfig);

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†æ‰€æœ‰æ•°ç»„ä¸­çš„é‡å¤é¡¹ï¼Œç„¶åæ·»åŠ æ–°é¡¹
            const cleanArray = (arr) => [...new Set(arr || [])];

            // æ ¹æ®ç±»å‹æ·»åŠ åˆ°ç›¸åº”æ•°ç»„
            if (item.type === 'panel') {
                const targetKey = area === 'top' ? 'topPanels' : 'bottomPanels';
                let targetArray = cleanArray(currentConfig[targetKey]);
                if (!targetArray.includes(item.id)) {
                    targetArray.push(item.id);
                    console.log(`[InfoBarSettings] â• æ·»åŠ é¢æ¿ ${item.id} åˆ° ${targetKey}`);
                } else {
                    console.log(`[InfoBarSettings] â„¹ï¸ é¢æ¿ ${item.id} å·²å­˜åœ¨äº ${targetKey}ï¼Œè·³è¿‡æ·»åŠ `);
                }
                currentConfig[targetKey] = targetArray;
            } else if (item.type === 'subitem') {
                const targetKey = area === 'top' ? 'topSubitems' : 'bottomSubitems';
                let targetArray = cleanArray(currentConfig[targetKey]);
                if (!targetArray.includes(item.id)) {
                    targetArray.push(item.id);
                    console.log(`[InfoBarSettings] â• æ·»åŠ å­é¡¹ ${item.id} åˆ° ${targetKey}`);
                } else {
                    console.log(`[InfoBarSettings] â„¹ï¸ å­é¡¹ ${item.id} å·²å­˜åœ¨äº ${targetKey}ï¼Œè·³è¿‡æ·»åŠ `);
                }
                currentConfig[targetKey] = targetArray;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†æ‰€æœ‰é…ç½®æ•°ç»„ä¸­çš„é‡å¤é¡¹
            currentConfig.topPanels = cleanArray(currentConfig.topPanels);
            currentConfig.bottomPanels = cleanArray(currentConfig.bottomPanels);
            currentConfig.topSubitems = cleanArray(currentConfig.topSubitems);
            currentConfig.bottomSubitems = cleanArray(currentConfig.bottomSubitems);

            // ç¡®ä¿å¯ç”¨çŠ¶æ€
            currentConfig.enabled = true;

            // ä¿å­˜å®Œæ•´é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            console.log('[InfoBarSettings] ğŸ’¾ å·²ä¿å­˜å‰ç«¯æ˜¾ç¤ºé…ç½®:', {
                topPanels: currentConfig.topPanels,
                bottomPanels: currentConfig.bottomPanels,
                topSubitems: currentConfig.topSubitems,
                bottomSubitems: currentConfig.bottomSubitems,
                enabled: currentConfig.enabled
            });

            // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤º
            this.updateFrontendDisplayManagerSettings();
            this.refreshFrontendDisplay();

            // ğŸ”§ ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“é¢„è§ˆ
            this.renderFrontendDisplayPreview(currentConfig);

        } catch (e) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜å‰ç«¯æ˜¾ç¤ºé…ç½®å¤±è´¥:', e);
        }
    }

    /**
     * åˆ·æ–°å‰ç«¯æ˜¾ç¤º
     */
    refreshFrontendDisplay() {
        try {
            // è·å–å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (fdm) {
                // æ£€æŸ¥æ˜¯å¦æœ‰åŒ…è£…çš„æ¶ˆæ¯
                const wrappedMessages = document.querySelectorAll('.frontend-message-wrapper');
                if (wrappedMessages.length > 0) {
                    // åªé‡æ–°æ¸²æŸ“æœ€åä¸€ä¸ªåŒ…è£…çš„æ¶ˆæ¯
                    const lastWrapper = wrappedMessages[wrappedMessages.length - 1];
                    const messageElement = lastWrapper.querySelector('.ai-message-container .mes');
                    if (messageElement) {
                        fdm.renderLayoutForMessage(messageElement);
                        console.log('[InfoBarSettings] ğŸ”„ å·²åˆ·æ–°å‰ç«¯æ˜¾ç¤º (ä»…æ¸²æŸ“å¸ƒå±€)');
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰åŒ…è£…çš„æ¶ˆæ¯ï¼Œä½†å‰ç«¯æ˜¾ç¤ºå·²å¯ç”¨ï¼Œåˆ™åˆå§‹åŒ–å‰ç«¯æ˜¾ç¤º
                    if (fdm.enabled) {
                        console.log('[InfoBarSettings] ğŸ”„ æ²¡æœ‰åŒ…è£…æ¶ˆæ¯ï¼Œé‡æ–°åˆå§‹åŒ–å‰ç«¯æ˜¾ç¤º');
                        fdm.initializeFrontendDisplay();
                    } else {
                        console.log('[InfoBarSettings] âš ï¸ å‰ç«¯æ˜¾ç¤ºæœªå¯ç”¨ï¼Œè·³è¿‡åˆ·æ–°');
                    }
                }
            }
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°å‰ç«¯æ˜¾ç¤ºå¤±è´¥:', error);
        }
    }

    /**
     * å°†åŸºç¡€å­—æ®µé”®è¡¥å…¨ä¸º panel.key å½¢å¼
     */
    resolveFieldQualifiedId(fieldKey) {
        try {
            if (fieldKey.includes('.')) return fieldKey;

            // ğŸ”§ ä¿®å¤ï¼šæ™ºèƒ½åŒ¹é…å­—æ®µåˆ°æ­£ç¡®çš„é¢æ¿
            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (fdm) {
                const availableSubItems = fdm.getAvailableSubItems();

                // æŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„å­—æ®µ
                const exactMatch = availableSubItems.find(item =>
                    item.id.endsWith(`.${fieldKey}`)
                );

                if (exactMatch) {
                    console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} åŒ¹é…åˆ°: ${exactMatch.id}`);
                    return exactMatch.id;
                }

                // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•æ ¹æ®å­—æ®µåæ¨æ–­é¢æ¿
                const fieldToPanelMap = {
                    'time': 'world',
                    'listView': 'tasks',
                    'kanbanView': 'tasks',
                    'calendarView': 'tasks',
                    'name': 'personal',
                    'å§“å': 'personal',
                    'å¯¹è±¡åç§°': 'interaction',
                    'location': 'world',
                    'mood': 'interaction'
                };

                const inferredPanel = fieldToPanelMap[fieldKey];
                if (inferredPanel) {
                    const inferredId = `${inferredPanel}.${fieldKey}`;
                    console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} æ¨æ–­ä¸º: ${inferredId}`);
                    return inferredId;
                }
            }

            // å…œåº•ï¼šå°è¯•ä»æ¨¡æ€æ¡†æ ‡é¢˜è·å–é¢æ¿IDï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            const title = this.modal?.querySelector('.subitem-list h4')?.textContent || '';
            const map = [
                { key: 'ä¸ªäººä¿¡æ¯', id: 'personal' },
                { key: 'ä¸–ç•Œä¿¡æ¯', id: 'world' },
                { key: 'äº¤äº’å¯¹è±¡', id: 'interaction' },
                { key: 'ä»»åŠ¡', id: 'tasks' },
                { key: 'ç»„ç»‡', id: 'organization' },
                { key: 'æ–°é—»', id: 'news' },
                { key: 'èƒŒåŒ…', id: 'inventory' },
                { key: 'èƒ½åŠ›', id: 'abilities' },
                { key: 'å‰§æƒ…', id: 'plot' },
                { key: 'ä¿®ç‚¼', id: 'cultivation' },
                { key: 'å¥‡å¹»', id: 'fantasy' },
                { key: 'ç°ä»£', id: 'modern' },
                { key: 'å†å²', id: 'historical' },
                { key: 'é­”æ³•', id: 'magic' },
                { key: 'è®­ç»ƒ', id: 'training' }
            ];
            const found = map.find(m => title.includes(m.key));
            const result = found ? `${found.id}.${fieldKey}` : fieldKey;

            console.log(`[InfoBarSettings] ğŸ¯ å­—æ®µ ${fieldKey} é€šè¿‡æ ‡é¢˜è§£æä¸º: ${result}`);
            return result;
        } catch (e) {
            console.warn(`[InfoBarSettings] âš ï¸ è§£æå­—æ®µIDå¤±è´¥: ${fieldKey}`, e);
            return fieldKey;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šæ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆå†…å®¹
     * æ ¹æ®é…ç½®é‡æ–°æ¸²æŸ“é¢„è§ˆåŒºåŸŸçš„é¢æ¿å’Œå­é¡¹
     */
    renderFrontendDisplayPreview(config) {
        try {
            console.log('[InfoBarSettings] ğŸ¨ æ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆ:', config);

            if (!config) {
                console.warn('[InfoBarSettings] âš ï¸ é…ç½®ä¸ºç©ºï¼Œè·³è¿‡é¢„è§ˆæ¸²æŸ“');
                return;
            }

            // è·å–é¢„è§ˆå®¹å™¨
            const topContainer = this.modal?.querySelector('.top-embedded-panels');
            const bottomContainer = this.modal?.querySelector('.bottom-embedded-panels');

            if (!topContainer || !bottomContainer) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°é¢„è§ˆå®¹å™¨');
                return;
            }

            // æ¸…ç©ºç°æœ‰é¢„è§ˆå†…å®¹
            topContainer.innerHTML = '';
            bottomContainer.innerHTML = '';

            // æ¸²æŸ“é¡¶éƒ¨é¢æ¿
            if (config.topPanels && Array.isArray(config.topPanels)) {
                config.topPanels.forEach(panelId => {
                    const panelElement = this.createPreviewPanelElement(panelId, 'panel');
                    if (panelElement) {
                        topContainer.appendChild(panelElement);
                    }
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šé™åˆ¶é¡¶éƒ¨å­é¡¹æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…é¢„è§ˆè¿‡äºæ‹¥æŒ¤
            if (config.topSubitems && Array.isArray(config.topSubitems)) {
                // åªæ˜¾ç¤ºå‰3ä¸ªå­é¡¹ï¼Œå…¶ä½™ç”¨çœç•¥å·è¡¨ç¤º
                const maxSubitems = 3;
                const subitems = config.topSubitems.slice(0, maxSubitems);

                subitems.forEach(subitemId => {
                    const subitemElement = this.createPreviewPanelElement(subitemId, 'subitem');
                    if (subitemElement) {
                        topContainer.appendChild(subitemElement);
                    }
                });

                // å¦‚æœæœ‰æ›´å¤šå­é¡¹ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
                if (config.topSubitems.length > maxSubitems) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'preview-more-indicator';
                    moreElement.innerHTML = `
                        <span class="preview-item-name">â‹¯ è¿˜æœ‰${config.topSubitems.length - maxSubitems}ä¸ªå­é¡¹</span>
                    `;
                    topContainer.appendChild(moreElement);
                }
            }

            // æ¸²æŸ“åº•éƒ¨é¢æ¿
            if (config.bottomPanels && Array.isArray(config.bottomPanels)) {
                config.bottomPanels.forEach(panelId => {
                    const panelElement = this.createPreviewPanelElement(panelId, 'panel');
                    if (panelElement) {
                        bottomContainer.appendChild(panelElement);
                    }
                });
            }

            // ğŸ”§ ä¿®å¤ï¼šé™åˆ¶åº•éƒ¨å­é¡¹æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…é¢„è§ˆè¿‡äºæ‹¥æŒ¤
            if (config.bottomSubitems && Array.isArray(config.bottomSubitems)) {
                // åªæ˜¾ç¤ºå‰3ä¸ªå­é¡¹ï¼Œå…¶ä½™ç”¨çœç•¥å·è¡¨ç¤º
                const maxSubitems = 3;
                const subitems = config.bottomSubitems.slice(0, maxSubitems);

                subitems.forEach(subitemId => {
                    const subitemElement = this.createPreviewPanelElement(subitemId, 'subitem');
                    if (subitemElement) {
                        bottomContainer.appendChild(subitemElement);
                    }
                });

                // å¦‚æœæœ‰æ›´å¤šå­é¡¹ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
                if (config.bottomSubitems.length > maxSubitems) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'preview-more-indicator';
                    moreElement.innerHTML = `
                        <span class="preview-item-name">â‹¯ è¿˜æœ‰${config.bottomSubitems.length - maxSubitems}ä¸ªå­é¡¹</span>
                    `;
                    bottomContainer.appendChild(moreElement);
                }
            }

            console.log('[InfoBarSettings] âœ… å‰ç«¯æ˜¾ç¤ºé¢„è§ˆæ¸²æŸ“å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¸²æŸ“å‰ç«¯æ˜¾ç¤ºé¢„è§ˆå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šåˆ›å»ºé¢„è§ˆé¢æ¿å…ƒç´ 
     * ä¸ºé¢„è§ˆåŒºåŸŸåˆ›å»ºé¢æ¿æˆ–å­é¡¹çš„æ˜¾ç¤ºå…ƒç´ 
     */
    createPreviewPanelElement(id, type) {
        try {
            const element = document.createElement('div');
            element.className = type === 'panel' ? 'preview-panel' : 'preview-subitem';
            element.dataset.id = id;
            element.dataset.type = type;

            // è·å–æ˜¾ç¤ºåç§°ï¼ˆä¸ä½¿ç”¨å›¾æ ‡ï¼Œå› ä¸ºå‰ç«¯æ˜¯æŒ‰é’®UIï¼‰
            let displayName = id;

            try {
                if (type === 'panel') {
                    // ğŸ”§ ä¿®å¤ï¼šé¢æ¿ä½¿ç”¨æ­£ç¡®çš„getPanelDisplayInfoå‡½æ•°è·å–åç§°
                    const enabledPanels = this.getEnabledPanels();
                    const panelConfig = enabledPanels[id];
                    const panelInfo = this.getPanelDisplayInfo(id, panelConfig);

                    displayName = panelInfo.name || id;

                    console.log(`[InfoBarSettings] ğŸ¨ é¢æ¿é¢„è§ˆå…ƒç´ : ${id} -> ${displayName}`);
                } else {
                    // ğŸ”§ ä¿®å¤ï¼šå­é¡¹éœ€è¦é€šè¿‡é¢æ¿æ˜ å°„æ¥è·å–æ­£ç¡®çš„ä¸­æ–‡åç§°
                    displayName = this.getSubitemDisplayName(id) || id;

                    console.log(`[InfoBarSettings] ğŸ¨ å­é¡¹é¢„è§ˆå…ƒç´ : ${id} -> ${displayName}`);
                }
            } catch (error) {
                console.warn('[InfoBarSettings] âš ï¸ è·å–æ˜¾ç¤ºåç§°å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ID:', error);
                displayName = id;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æŒ‰é’®æ ·å¼çš„é¢„è§ˆï¼Œæ¨¡æ‹ŸçœŸå®å‰ç«¯æ˜¾ç¤º
            element.innerHTML = `
                <span class="preview-item-name">${displayName}</span>
                <button class="remove-preview-item" data-id="${id}" data-type="${type}" title="ç§»é™¤">Ã—</button>
            `;

            // æ·»åŠ ç§»é™¤äº‹ä»¶
            const removeButton = element.querySelector('.remove-preview-item');
            if (removeButton) {
                removeButton.addEventListener('click', () => {
                    this.removePreviewItem(id, type);
                });
            }

            return element;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºé¢„è§ˆå…ƒç´ å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç§»é™¤é¢„è§ˆé¡¹
     * ä»é…ç½®å’Œé¢„è§ˆä¸­ç§»é™¤æŒ‡å®šçš„é¢æ¿æˆ–å­é¡¹
     */
    async removePreviewItem(id, type) {
        try {
            console.log(`[InfoBarSettings] ğŸ—‘ï¸ ç§»é™¤é¢„è§ˆé¡¹: ${type} ${id}`);

            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.error('[InfoBarSettings] âŒ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // è·å–å½“å‰é…ç½®
            const currentConfig = await fdm.getSavedFrontendDisplayConfig();

            // ä»ç›¸åº”æ•°ç»„ä¸­ç§»é™¤é¡¹ç›®
            if (type === 'panel') {
                if (currentConfig.topPanels) {
                    currentConfig.topPanels = currentConfig.topPanels.filter(item => item !== id);
                }
                if (currentConfig.bottomPanels) {
                    currentConfig.bottomPanels = currentConfig.bottomPanels.filter(item => item !== id);
                }
            } else if (type === 'subitem') {
                if (currentConfig.topSubitems) {
                    currentConfig.topSubitems = currentConfig.topSubitems.filter(item => item !== id);
                }
                if (currentConfig.bottomSubitems) {
                    currentConfig.bottomSubitems = currentConfig.bottomSubitems.filter(item => item !== id);
                }
            }

            // ä¿å­˜é…ç½®
            await fdm.saveFrontendDisplayConfig(currentConfig);

            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            this.renderFrontendDisplayPreview(currentConfig);

            // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤º
            this.updateFrontendDisplayManagerSettings();
            this.refreshFrontendDisplay();

            console.log(`[InfoBarSettings] âœ… å·²ç§»é™¤é¢„è§ˆé¡¹: ${type} ${id}`);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç§»é™¤é¢„è§ˆé¡¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šç¡®ä¿AIæ¶ˆæ¯è¢«åŒ…è£…
     * æ£€æŸ¥å¹¶è§¦å‘AIæ¶ˆæ¯åŒ…è£…ï¼Œç”¨äºè®¾ç½®ä¿å­˜åçš„ä¿®å¤
     */
    ensureAIMessagesWrapped() {
        try {
            console.log('[InfoBarSettings] ğŸ” æ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…çŠ¶æ€...');

            const fdm = window.SillyTavernInfobar?.modules?.frontendDisplayManager;
            if (!fdm) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰AIæ¶ˆæ¯
            const aiMessages = document.querySelectorAll('.mes[is_user="false"]');
            console.log(`[InfoBarSettings] ğŸ“‹ æ‰¾åˆ° ${aiMessages.length} æ¡AIæ¶ˆæ¯`);

            if (aiMessages.length === 0) {
                console.log('[InfoBarSettings] â„¹ï¸ æ²¡æœ‰AIæ¶ˆæ¯éœ€è¦åŒ…è£…');
                return;
            }

            // æ£€æŸ¥æœ€åä¸€æ¡AIæ¶ˆæ¯æ˜¯å¦å·²åŒ…è£…
            const lastMessage = aiMessages[aiMessages.length - 1];
            const existingWrapper = lastMessage.previousElementSibling;

            if (existingWrapper && existingWrapper.classList.contains('frontend-message-wrapper')) {
                console.log('[InfoBarSettings] âœ… AIæ¶ˆæ¯å·²æ­£ç¡®åŒ…è£…');
                return;
            }

            // æ²¡æœ‰åŒ…è£…ï¼Œè§¦å‘åŒ…è£…
            console.log('[InfoBarSettings] ğŸ”§ AIæ¶ˆæ¯æœªåŒ…è£…ï¼Œè§¦å‘é‡æ–°åŒ…è£…...');

            if (fdm.wrapExistingMessagesWithRetry) {
                fdm.wrapExistingMessagesWithRetry(0);
            } else if (fdm.wrapExistingMessages) {
                fdm.wrapExistingMessages();
            } else {
                console.warn('[InfoBarSettings] âš ï¸ å‰ç«¯æ˜¾ç¤ºç®¡ç†å™¨ç¼ºå°‘åŒ…è£…æ–¹æ³•');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ£€æŸ¥AIæ¶ˆæ¯åŒ…è£…å¤±è´¥:', error);
        }
    }

    /**
     * è·å–å¯¼å‡ºé€‰é¡¹
     */
    getExportOptions() {
        try {
            const panelConfigs = this.modal.querySelector('#export-panel-configs')?.checked || false;
            const panelRules = this.modal.querySelector('#export-panel-rules')?.checked || false;
            const fieldRules = this.modal.querySelector('#export-field-rules')?.checked || false;
            const themeSettings = this.modal.querySelector('#export-theme-settings')?.checked || false;
            const apiSettings = this.modal.querySelector('#export-api-settings')?.checked || false;
            const allSettings = this.modal.querySelector('#export-all-settings')?.checked || false;

            const hasAnySelection = panelConfigs || panelRules || fieldRules || themeSettings || apiSettings || allSettings;

            return {
                panelConfigs,
                panelRules,
                fieldRules,
                themeSettings,
                apiSettings,
                allSettings,
                hasAnySelection
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯¼å‡ºé€‰é¡¹å¤±è´¥:', error);
            return { hasAnySelection: false };
        }
    }

    /**
     * æ·»åŠ é¢æ¿é…ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addPanelConfigsToExport(exportData) {
        try {
            // è·å–é¢æ¿é…ç½®
            const panelConfigs = await this.configManager.getConfig('panels') || {};

            // è·å–è‡ªå®šä¹‰é¢æ¿
            const customPanels = await this.configManager.getConfig('customPanels') || {};

            // è·å–åŸºç¡€é¢æ¿é…ç½®
            const basicPanelIds = ['personal','world','interaction','tasks','organization','news','inventory','abilities','plot','cultivation','fantasy','modern','historical','magic','training'];
            const basicPanelConfigs = {};

            for (const panelId of basicPanelIds) {
                const config = await this.configManager.getConfig(panelId);
                if (config) {
                    basicPanelConfigs[panelId] = config;
                }
            }

            exportData.configs.panelConfigs = {
                panels: panelConfigs,
                customPanels: customPanels,
                basicPanels: basicPanelConfigs
            };

            console.log('[InfoBarSettings] âœ… é¢æ¿é…ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿é…ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ é¢æ¿è§„åˆ™åˆ°å¯¼å‡ºæ•°æ®
     */
    async addPanelRulesToExport(exportData) {
        try {
            const panelRuleManager = window.SillyTavernInfobar?.modules?.panelRuleManager;
            if (!panelRuleManager) {
                console.warn('[InfoBarSettings] âš ï¸ é¢æ¿è§„åˆ™ç®¡ç†å™¨ä¸å¯ç”¨');
                return;
            }

            // è·å–æ‰€æœ‰é¢æ¿è§„åˆ™
            const panelRulesData = await this.configManager.getData('panel_rules') || {};

            exportData.configs.panelRules = panelRulesData;

            console.log('[InfoBarSettings] âœ… é¢æ¿è§„åˆ™å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ é¢æ¿è§„åˆ™å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ å­—æ®µè§„åˆ™åˆ°å¯¼å‡ºæ•°æ®
     */
    async addFieldRulesToExport(exportData) {
        try {
            const fieldRuleManager = window.SillyTavernInfobar?.modules?.fieldRuleManager;
            if (!fieldRuleManager) {
                console.warn('[InfoBarSettings] âš ï¸ å­—æ®µè§„åˆ™ç®¡ç†å™¨ä¸å¯ç”¨');
                return;
            }

            // è·å–æ‰€æœ‰å­—æ®µè§„åˆ™
            const fieldRulesData = await this.configManager.getData('field_rules') || {};

            exportData.configs.fieldRules = fieldRulesData;

            console.log('[InfoBarSettings] âœ… å­—æ®µè§„åˆ™å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ å­—æ®µè§„åˆ™å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ ä¸»é¢˜è®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addThemeSettingsToExport(exportData) {
        try {
            const themeConfig = await this.configManager.getConfig('theme') || {};

            exportData.configs.themeSettings = themeConfig;

            console.log('[InfoBarSettings] âœ… ä¸»é¢˜è®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ APIè®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addApiSettingsToExport(exportData) {
        try {
            const apiConfig = await this.configManager.getConfig('apiConfig') || {};

            // ç§»é™¤æ•æ„Ÿä¿¡æ¯
            const safeApiConfig = { ...apiConfig };
            if (safeApiConfig.apiKey) {
                safeApiConfig.apiKey = '***REMOVED***';
            }

            exportData.configs.apiSettings = safeApiConfig;

            console.log('[InfoBarSettings] âœ… APIè®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®ï¼ˆå·²ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ APIè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ·»åŠ æ‰€æœ‰è®¾ç½®åˆ°å¯¼å‡ºæ•°æ®
     */
    async addAllSettingsToExport(exportData) {
        try {
            // ä½¿ç”¨ç°æœ‰çš„å¯¼å‡ºæ–¹æ³•
            const fullExportData = await this.configManager.exportConfigs();

            // åˆå¹¶åˆ°å½“å‰å¯¼å‡ºæ•°æ®
            exportData.configs.allSettings = fullExportData.configs;

            console.log('[InfoBarSettings] âœ… æ‰€æœ‰è®¾ç½®å·²æ·»åŠ åˆ°å¯¼å‡ºæ•°æ®');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ·»åŠ æ‰€æœ‰è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * æ‰“å¼€å˜é‡ç®¡ç†å™¨
     */
    openVariableManager() {
        try {
            console.log('[InfoBarSettings] ğŸ”§ åˆ›å»ºå˜é‡ç®¡ç†å™¨ç•Œé¢...');

            // åˆ›å»ºå˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
            const variableModal = this.createVariableManagerModal();
            document.body.appendChild(variableModal);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            variableModal.style.display = 'flex';

            // ç«‹å³åº”ç”¨ä¸€æ¬¡ä¸»é¢˜ï¼ˆç¡®ä¿åˆå§‹å…ƒç´ æ ·å¼æ­£ç¡®ï¼‰
            try {
                const activeThemeCard = this.modal?.querySelector('.theme-preview-card.active');
                const themeId = activeThemeCard?.getAttribute('data-theme');
                const theme = themeId ? this.getThemeById(themeId) : null;
                if (theme) this.applyVariableManagerTheme(theme);
            } catch (e) {
                console.warn('[InfoBarSettings] âš ï¸ æ‰“å¼€å˜é‡ç®¡ç†å™¨æ—¶åº”ç”¨ä¸»é¢˜å¤±è´¥:', e);
            }

            // åŠ è½½ç°æœ‰å˜é‡
            this.loadVariables();

            console.log('[InfoBarSettings] âœ… å˜é‡ç®¡ç†å™¨å·²æ‰“å¼€');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€å˜é‡ç®¡ç†å™¨å¤±è´¥:', error);
            this.showMessage('æ‰“å¼€å˜é‡ç®¡ç†å™¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * åˆ›å»ºå˜é‡ç®¡ç†å™¨æ¨¡æ€æ¡†
     */
    createVariableManagerModal() {
        const modal = document.createElement('div');
        modal.className = 'variable-manager-modal';
        modal.id = 'variable-manager-modal';

        modal.innerHTML = `
            <div class="modal-overlay" onclick="this.closest('.variable-manager-modal').remove()"></div>
            <div class="modal-container">
                <!-- å¤´éƒ¨ -->
                <div class="modal-header">
                    <div class="header-left">
                        <h2><i class="fa fa-code"></i> å˜é‡ç®¡ç†å™¨</h2>
                    </div>
                    <div class="header-right">
                        <button class="modal-close" onclick="this.closest('.variable-manager-modal').remove()">Ã—</button>
                    </div>
                </div>

                <!-- ä¸»ä½“å†…å®¹ -->
                <div class="modal-body">
                    <!-- å˜é‡ç±»å‹å¯¼èˆªæ  -->
                    <div class="variable-nav">
                        <div class="nav-tabs">
                            <button class="nav-tab active" data-scope="global">
                                <i class="fa fa-globe"></i> å…¨å±€å˜é‡
                            </button>
                            <button class="nav-tab" data-scope="chat">
                                <i class="fa fa-comments"></i> èŠå¤©å˜é‡
                            </button>
                        </div>
                    </div>

                    <!-- å·¥å…·æ  -->
                    <div class="variable-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-primary" data-action="add-variable">
                                <i class="fa fa-plus"></i> æ·»åŠ å˜é‡
                            </button>
                            <select class="variable-type-select" id="variable-type-select">
                                <option value="string">å­—ç¬¦ä¸²</option>
                                <option value="number">æ•°å­—</option>
                                <option value="boolean">å¸ƒå°”å€¼</option>
                                <option value="array">æ•°ç»„</option>
                                <option value="object">å¯¹è±¡</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <div class="view-mode-toggle">
                                <button class="btn btn-sm view-mode-btn active" data-view="list" title="åˆ—è¡¨è§†å›¾">
                                    <i class="fa fa-list"></i>
                                </button>
                                <button class="btn btn-sm view-mode-btn" data-view="tree" title="æ ‘çŠ¶è§†å›¾">
                                    <i class="fa fa-sitemap"></i>
                                </button>
                            </div>
                            <input type="text" class="search-input" placeholder="æœç´¢å˜é‡..." id="variable-search">
                            <button class="btn btn-info" data-action="import-variables">
                                <i class="fa fa-upload"></i> å¯¼å…¥
                            </button>
                            <button class="btn btn-info" data-action="export-variables">
                                <i class="fa fa-download"></i> å¯¼å‡º
                            </button>
                            <button class="btn btn-danger" data-action="clear-variables" title="æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡">
                                <i class="fa fa-trash"></i> æ¸…ç©º
                            </button>
                            <button class="btn btn-secondary" data-action="refresh-variables">
                                <i class="fa fa-refresh"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <!-- å˜é‡åˆ—è¡¨ -->
                    <div class="variable-list-container">
                        <div class="variable-list" id="variable-list">
                            <!-- å˜é‡é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæ  -->
                <div class="modal-footer">
                    <div class="footer-left">
                        <span class="variable-count">å˜é‡æ•°é‡: <span id="variable-count">0</span></span>
                        <span class="variable-scope-info" id="variable-scope-info">å…¨å±€å˜é‡</span>
                    </div>
                    <div class="footer-right">
                        <button class="btn-cancel" onclick="this.closest('.variable-manager-modal').remove()">å…³é—­</button>
                        <button class="btn-save" data-action="save-variables">ä¿å­˜å˜é‡</button>
                    </div>
                </div>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        this.bindVariableManagerEvents(modal);

        return modal;
    }

    /**
     * ç»‘å®šå˜é‡ç®¡ç†å™¨äº‹ä»¶
     */
    bindVariableManagerEvents(modal) {
        // åˆå§‹åŒ–å½“å‰ä½œç”¨åŸŸå’Œè§†å›¾æ¨¡å¼
        this.currentVariableScope = 'global';
        this.currentViewMode = 'list';

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
        modal.addEventListener('click', (e) => {
            // é˜²æ­¢é‡å¤å¤„ç†
            if (e.defaultPrevented) return;

            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            // å¤„ç†å¯¼èˆªæ åˆ‡æ¢
            const navTab = e.target.closest('.nav-tab');
            if (navTab) {
                this.switchVariableScope(navTab.dataset.scope);
                return;
            }

            // å¤„ç†è§†å›¾æ¨¡å¼åˆ‡æ¢
            const viewModeBtn = e.target.closest('.view-mode-btn');
            if (viewModeBtn) {
                this.switchViewMode(viewModeBtn.dataset.view);
                return;
            }

            if (action) {
                e.preventDefault();
                e.stopPropagation();
                this.handleVariableAction(action, e, actionElement);
            }
        });

        // æœç´¢åŠŸèƒ½
        const searchInput = modal.querySelector('#variable-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterVariables(e.target.value);
            });
        }


    }

    /**
     * åˆ‡æ¢å˜é‡ä½œç”¨åŸŸ
     */
    switchVariableScope(scope) {
        this.currentVariableScope = scope;

        // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
        const modal = document.querySelector('#variable-manager-modal');
        if (modal) {
            const navTabs = modal.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.scope === scope);
            });

            // æ›´æ–°åº•éƒ¨ä¿¡æ¯
            const scopeInfo = modal.querySelector('#variable-scope-info');
            if (scopeInfo) {
                scopeInfo.textContent = scope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡';
            }
        }

        // é‡æ–°åŠ è½½å˜é‡
        this.loadVariables();

        console.log('[VariableManager] åˆ‡æ¢åˆ°', scope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡');
    }

    /**
     * åˆ‡æ¢è§†å›¾æ¨¡å¼
     */
    switchViewMode(mode) {
        this.currentViewMode = mode;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const modal = document.querySelector('#variable-manager-modal');
        if (modal) {
            const viewModeBtns = modal.querySelectorAll('.view-mode-btn');
            viewModeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });
        }

        // é‡æ–°æ¸²æŸ“å˜é‡åˆ—è¡¨
        this.renderVariableList();

        console.log('[VariableManager] åˆ‡æ¢åˆ°', mode === 'list' ? 'åˆ—è¡¨è§†å›¾' : 'æ ‘çŠ¶è§†å›¾');
    }

    /**
     * å¤„ç†å˜é‡ç®¡ç†å™¨æ“ä½œ
     */
    handleVariableAction(action, event, actionElement) {
        try {
            switch (action) {
                case 'add-variable':
                    this.addNewVariable();
                    break;
                case 'add-macro':
                    this.addNewMacro();
                    break;
                case 'save-variables':
                    this.saveVariables();
                    break;
                case 'export-variables':
                    this.exportVariables();
                    break;
                case 'import-variables':
                    this.importVariables();
                    break;
                case 'clear-variables':
                    this.clearCurrentScopeVariables();
                    break;
                case 'refresh-variables':
                    this.loadVariables();
                    break;
                case 'edit-variable':
                    const variableId = event.target.closest('.variable-item').dataset.variableId;
                    this.editVariable(variableId);
                    break;
                case 'delete-variable':
                    event.preventDefault();
                    event.stopPropagation();
                    const deleteVariableId = event.target.closest('.variable-item').dataset.variableId;
                    this.deleteVariable(deleteVariableId);
                    break;
                case 'save-variable-dialog':
                    const isEdit = actionElement.dataset.isEdit === 'true';
                    const variableKey = actionElement.dataset.variableKey || '';
                    this.saveVariableFromDialog(actionElement, isEdit, variableKey);
                    break;
                case 'toggle-view-mode':
                    this.toggleViewMode();
                    break;
                case 'add-array-item':
                    const arrayVariableId = actionElement.dataset.variableId ||
                                          event.target.closest('.variable-item')?.dataset?.variableId;
                    this.addArrayItem(arrayVariableId);
                    break;
                case 'remove-array-item':
                    const arrayItemIndex = actionElement.dataset.index;
                    const arrayVarId = event.target.closest('.variable-item')?.dataset?.variableId;
                    this.removeArrayItem(arrayVarId, parseInt(arrayItemIndex));
                    break;
                case 'add-object-property':
                    const objectVariableId = actionElement.dataset.variableId ||
                                           event.target.closest('.variable-item')?.dataset?.variableId;
                    this.addObjectProperty(objectVariableId);
                    break;
                case 'remove-object-property':
                    const propertyKey = actionElement.dataset.key;
                    const objectVarId = event.target.closest('.variable-item')?.dataset?.variableId;
                    this.removeObjectProperty(objectVarId, propertyKey);
                    break;
                case 'add-nested-array-item':
                    const addNestedArrayVarId = actionElement.dataset.variableId;
                    const addNestedArrayPath = actionElement.dataset.path;
                    this.addNestedArrayItem(addNestedArrayVarId, addNestedArrayPath);
                    break;
                case 'add-nested-object-property':
                    const addNestedObjectVarId = actionElement.dataset.variableId;
                    const addNestedObjectPath = actionElement.dataset.path;
                    this.addNestedObjectProperty(addNestedObjectVarId, addNestedObjectPath);
                    break;
                case 'remove-nested-array-item':
                    const removeNestedArrayVarId = actionElement.dataset.variableId;
                    const removeNestedArrayIndex = actionElement.dataset.index;
                    const removeNestedArrayLevel = parseInt(actionElement.dataset.level);
                    this.removeNestedArrayItem(removeNestedArrayVarId, removeNestedArrayIndex, removeNestedArrayLevel, event);
                    break;
                case 'remove-nested-object-property':
                    const removeNestedObjVarId = actionElement.dataset.variableId;
                    const removeNestedObjKey = actionElement.dataset.key;
                    const removeNestedObjPath = actionElement.dataset.path;
                    this.removeNestedObjectProperty(removeNestedObjVarId, removeNestedObjKey, removeNestedObjPath);
                    break;
                case 'edit-array-item':
                    const editArrayVarId = actionElement.dataset.variableId;
                    const editArrayIndex = actionElement.dataset.index;
                    const editArrayLevel = parseInt(actionElement.dataset.level || '0');
                    if (editArrayLevel > 0) {
                        // åµŒå¥—æ•°ç»„é¡¹ç¼–è¾‘
                        this.editNestedArrayItem(editArrayVarId, editArrayIndex, editArrayLevel, event);
                    } else {
                        // é¡¶çº§æ•°ç»„é¡¹ç¼–è¾‘
                        this.editArrayItem(editArrayVarId, editArrayIndex);
                    }
                    break;
                case 'edit-object-property':
                    const editObjVarId = actionElement.dataset.variableId;
                    const editObjKey = actionElement.dataset.key;
                    const editObjPath = actionElement.dataset.path;
                    this.editObjectProperty(editObjVarId, editObjKey, editObjPath);
                    break;
                case 'edit-nested-array':
                    const editNestedArrayVarId = actionElement.dataset.variableId;
                    const editNestedArrayIndex = actionElement.dataset.index;
                    const editNestedArrayLevel = parseInt(actionElement.dataset.level);
                    this.editNestedArrayItem(editNestedArrayVarId, editNestedArrayIndex, editNestedArrayLevel, event);
                    break;
                case 'edit-nested-object':
                    const editNestedObjVarId = actionElement.dataset.variableId;
                    const editNestedObjIndex = actionElement.dataset.index;
                    const editNestedObjLevel = parseInt(actionElement.dataset.level);
                    this.editNestedObjectItem(editNestedObjVarId, editNestedObjIndex, editNestedObjLevel, event);
                    break;
                case 'edit-nested-property-array':
                    const editNestedPropArrayVarId = actionElement.dataset.variableId;
                    const editNestedPropArrayKey = actionElement.dataset.key;
                    const editNestedPropArrayPath = actionElement.dataset.path;
                    const editNestedPropArrayLevel = parseInt(actionElement.dataset.level);
                    this.editNestedPropertyArray(editNestedPropArrayVarId, editNestedPropArrayKey, editNestedPropArrayPath, editNestedPropArrayLevel);
                    break;
                case 'edit-nested-property-object':
                    const editNestedPropObjVarId = actionElement.dataset.variableId;
                    const editNestedPropObjKey = actionElement.dataset.key;
                    const editNestedPropObjPath = actionElement.dataset.path;
                    const editNestedPropObjLevel = parseInt(actionElement.dataset.level);
                    this.editNestedPropertyObject(editNestedPropObjVarId, editNestedPropObjKey, editNestedPropObjPath, editNestedPropObjLevel);
                    break;
                case 'save-nested-property-edit':
                    const saveNestedVarId = actionElement.dataset.variableId;
                    const saveNestedKey = actionElement.dataset.key;
                    const saveNestedPath = actionElement.dataset.path;
                    const saveNestedType = actionElement.dataset.type;
                    this.saveNestedPropertyEditFromDialog(actionElement, saveNestedVarId, saveNestedKey, saveNestedPath, saveNestedType);
                    break;
                default:
                    console.log(`[VariableManager] ğŸ”˜ å¤„ç†æ“ä½œ: ${action}`);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ å¤„ç†æ“ä½œå¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½å˜é‡
     */
    async loadVariables() {
        try {
            let variables = {};

            if (this.currentVariableScope === 'global') {
                // åŠ è½½å…¨å±€å˜é‡
                variables = await this.loadGlobalVariables();
            } else {
                // åŠ è½½èŠå¤©å˜é‡
                variables = await this.loadChatVariables();
            }

            this.variables = variables;

            // æ¸²æŸ“å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… å˜é‡åŠ è½½å®Œæˆï¼Œå…±', Object.keys(variables).length, 'ä¸ª',
                this.currentVariableScope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡');
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½å˜é‡å¤±è´¥:', error);
        }
    }

    /**
     * åŠ è½½å…¨å±€å˜é‡
     */
    async loadGlobalVariables() {
        try {
            // å°è¯•ä»SillyTavernè·å–å…¨å±€å˜é‡
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                const extensionSettings = context.extensionSettings || {};

                // ä»æ‰©å±•è®¾ç½®ä¸­è·å–å…¨å±€å˜é‡
                const globalVars = extensionSettings.variables || {};

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                const variables = {};
                Object.entries(globalVars).forEach(([key, value]) => {
                    const detectedType = this.detectVariableType(value);
                    let processedValue = value;

                    // å¦‚æœæ£€æµ‹åˆ°æ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æä¸ºå¯¹è±¡
                    if (detectedType === 'object' || detectedType === 'array') {
                        if (typeof value === 'string' && this.isJsonString(value)) {
                            try {
                                processedValue = JSON.parse(value);
                            } catch (e) {
                                console.warn(`[VariableManager] JSONè§£æå¤±è´¥: ${key}`, e);
                                processedValue = value;
                            }
                        }
                    }

                    variables[key] = {
                        type: detectedType,
                        value: processedValue,
                        scope: 'global',
                        source: 'sillytavern',
                        created: new Date().toISOString()
                    };
                });

                return variables;
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                return await this.configManager.getConfig('globalVariables') || {};
            }
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½å…¨å±€å˜é‡å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * åŠ è½½èŠå¤©å˜é‡
     */
    async loadChatVariables() {
        try {
            // å°è¯•ä»SillyTavernè·å–èŠå¤©å˜é‡
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                const chatMetadata = context.chatMetadata || {};

                // ä»èŠå¤©å…ƒæ•°æ®ä¸­è·å–å˜é‡
                const chatVars = chatMetadata.variables || {};

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                const variables = {};
                Object.entries(chatVars).forEach(([key, value]) => {
                    const detectedType = this.detectVariableType(value);
                    let processedValue = value;

                    // å¦‚æœæ£€æµ‹åˆ°æ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æä¸ºå¯¹è±¡
                    if (detectedType === 'object' || detectedType === 'array') {
                        if (typeof value === 'string' && this.isJsonString(value)) {
                            try {
                                processedValue = JSON.parse(value);
                            } catch (e) {
                                console.warn(`[VariableManager] JSONè§£æå¤±è´¥: ${key}`, e);
                                processedValue = value;
                            }
                        }
                    }

                    variables[key] = {
                        type: detectedType,
                        value: processedValue,
                        scope: 'chat',
                        source: 'sillytavern',
                        created: new Date().toISOString()
                    };
                });

                return variables;
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                return await this.configManager.getConfig('chatVariables') || {};
            }
        } catch (error) {
            console.error('[VariableManager] âŒ åŠ è½½èŠå¤©å˜é‡å¤±è´¥:', error);
            return {};
        }
    }

    /**
     * æ£€æµ‹å˜é‡ç±»å‹
     */
    detectVariableType(value) {
        if (value === null || value === undefined) {
            return 'null';
        }

        if (typeof value === 'string') {
            // å°è¯•æ£€æµ‹JSONå­—ç¬¦ä¸²
            if (this.isJsonString(value)) {
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed)) {
                        return 'array';
                    } else if (typeof parsed === 'object' && parsed !== null) {
                        return 'object';
                    }
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œä»ç„¶æ˜¯å­—ç¬¦ä¸²
                }
            }
            return 'string';
        }

        if (typeof value === 'number') {
            return 'number';
        }

        if (typeof value === 'boolean') {
            return 'boolean';
        }

        if (Array.isArray(value)) {
            return 'array';
        }

        if (typeof value === 'object') {
            return 'object';
        }

        if (typeof value === 'function') {
            return 'function';
        }

        return 'unknown';
    }

    /**
     * æ£€æµ‹æ˜¯å¦ä¸ºJSONå­—ç¬¦ä¸²
     */
    isJsonString(str) {
        if (typeof str !== 'string') {
            return false;
        }

        // ç®€å•çš„JSONæ ¼å¼æ£€æµ‹
        const trimmed = str.trim();
        return (trimmed.startsWith('{') && trimmed.endsWith('}')) ||
               (trimmed.startsWith('[') && trimmed.endsWith(']'));
    }

    /**
     * æ¸²æŸ“å˜é‡åˆ—è¡¨
     */
    renderVariableList() {
        const listContainer = document.querySelector('#variable-list');
        if (!listContainer) return;

        const variables = this.variables || {};
        const variableCount = Object.keys(variables).length;

        // æ›´æ–°å˜é‡æ•°é‡æ˜¾ç¤º
        const countElement = document.querySelector('#variable-count');
        if (countElement) {
            countElement.textContent = variableCount;
        }

        if (variableCount === 0) {
            listContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-code fa-3x"></i>
                    <h3>æš‚æ— å˜é‡</h3>
                    <p>ç‚¹å‡»"æ·»åŠ å˜é‡"å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå˜é‡</p>
                </div>
            `;
            return;
        }

        // æ ¹æ®è§†å›¾æ¨¡å¼æ¸²æŸ“
        if (this.currentViewMode === 'tree') {
            this.renderTreeView(listContainer, variables);
        } else {
            this.renderListView(listContainer, variables);
        }
    }

    /**
     * æ¸²æŸ“åˆ—è¡¨è§†å›¾
     */
    renderListView(container, variables) {
        const variableItems = Object.entries(variables).map(([key, variable]) => {
            return this.createVariableItem(key, variable);
        }).join('');

        container.innerHTML = variableItems;
        container.className = 'variable-list list-view';

        // æ¸²æŸ“åå†æ¬¡åº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜ï¼Œç¡®ä¿åŠ¨æ€èŠ‚ç‚¹ç»§æ‰¿
        try {
            const activeThemeCard = this.modal?.querySelector('.theme-preview-card.active');
            const themeId = activeThemeCard?.getAttribute('data-theme');
            const theme = themeId ? this.getThemeById(themeId) : null;
            if (theme) this.applyVariableManagerTheme(theme);
        } catch (e) {
            console.warn('[InfoBarSettings] âš ï¸ æ¸²æŸ“ååº”ç”¨å˜é‡ç®¡ç†å™¨ä¸»é¢˜å¤±è´¥:', e);
        }
    }

    /**
     * æ¸²æŸ“æ ‘çŠ¶è§†å›¾
     */
    renderTreeView(container, variables) {
        // æŒ‰ç±»å‹åˆ†ç»„å˜é‡
        const groupedVariables = this.groupVariablesByType(variables);

        let treeHTML = '';
        Object.entries(groupedVariables).forEach(([type, vars]) => {
            if (vars.length === 0) return;

            treeHTML += `
                <div class="tree-group">
                    <div class="tree-group-header" data-type="${type}">
                        <i class="fa fa-chevron-down tree-toggle"></i>
                        <i class="fa ${this.getTypeIcon(type)} type-icon"></i>
                        <span class="group-title">${this.getTypeDisplayName(type)}</span>
                        <span class="group-count">(${vars.length})</span>
                    </div>
                    <div class="tree-group-content">
                        ${vars.map(([key, variable]) => this.createTreeVariableItem(key, variable)).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = treeHTML;
        container.className = 'variable-list tree-view';

        // ç»‘å®šæŠ˜å /å±•å¼€äº‹ä»¶
        this.bindTreeEvents(container);
    }

    /**
     * æŒ‰ç±»å‹åˆ†ç»„å˜é‡
     */
    groupVariablesByType(variables) {
        const groups = {
            string: [],
            number: [],
            boolean: [],
            array: [],
            object: [],
            function: [],
            null: [],
            unknown: []
        };

        Object.entries(variables).forEach(([key, variable]) => {
            const type = variable.type || 'unknown';
            if (groups[type]) {
                groups[type].push([key, variable]);
            } else {
                groups.unknown.push([key, variable]);
            }
        });

        return groups;
    }

    /**
     * è·å–ç±»å‹å›¾æ ‡
     */
    getTypeIcon(type) {
        const icons = {
            string: 'fa-quote-left',
            number: 'fa-calculator',
            boolean: 'fa-toggle-on',
            array: 'fa-list-ol',
            object: 'fa-cube',
            function: 'fa-code',
            null: 'fa-circle-o',
            unknown: 'fa-question'
        };
        return icons[type] || 'fa-question';
    }

    /**
     * è·å–ç±»å‹æ˜¾ç¤ºåç§°
     */
    getTypeDisplayName(type) {
        const names = {
            string: 'å­—ç¬¦ä¸²',
            number: 'æ•°å­—',
            boolean: 'å¸ƒå°”å€¼',
            array: 'æ•°ç»„',
            object: 'å¯¹è±¡',
            function: 'å‡½æ•°',
            null: 'ç©ºå€¼',
            unknown: 'æœªçŸ¥ç±»å‹'
        };
        return names[type] || 'æœªçŸ¥ç±»å‹';
    }

    /**
     * åˆ›å»ºæ ‘çŠ¶å˜é‡é¡¹
     */
    createTreeVariableItem(key, variable) {
        const value = variable.value || '';
        const description = variable.description || '';

        return `
            <div class="tree-variable-item" data-variable-id="${key}">
                <div class="tree-variable-header">
                    <div class="tree-variable-info">
                        <span class="tree-variable-name">${key}</span>
                        ${variable.scope ? `<span class="variable-scope ${variable.scope}">${variable.scope === 'global' ? 'å…¨å±€' : 'å±€éƒ¨'}</span>` : ''}
                    </div>
                    <div class="tree-variable-actions">
                        <button class="btn-icon" data-action="edit-variable" title="ç¼–è¾‘">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" data-action="delete-variable" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="tree-variable-content">
                    <div class="tree-variable-value">${this.formatVariableValue(value, variable.type)}</div>
                    ${description ? `<div class="tree-variable-description">${description}</div>` : ''}
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šæ ‘çŠ¶è§†å›¾äº‹ä»¶
     */
    bindTreeEvents(container) {
        container.addEventListener('click', (e) => {
            const groupHeader = e.target.closest('.tree-group-header');
            if (groupHeader) {
                const groupContent = groupHeader.nextElementSibling;
                const toggle = groupHeader.querySelector('.tree-toggle');

                if (groupContent.style.display === 'none') {
                    groupContent.style.display = 'block';
                    toggle.className = 'fa fa-chevron-down tree-toggle';
                } else {
                    groupContent.style.display = 'none';
                    toggle.className = 'fa fa-chevron-right tree-toggle';
                }
            }
        });
    }

    /**
     * åˆ›å»ºå˜é‡é¡¹HTML
     */
    createVariableItem(key, variable) {
        const type = variable.type || 'string';
        const value = variable.value || '';
        const description = variable.description || '';
        const isGlobal = variable.global || false;

        // ä¸ºæ•°ç»„å’Œå¯¹è±¡ç±»å‹æ·»åŠ ç‰¹æ®Šæ“ä½œæŒ‰é’®
        let specialActions = '';
        if (type === 'array') {
            specialActions = `
                <button class="btn-icon btn-special" data-action="add-array-item" data-variable-id="${key}" title="æ·»åŠ æ•°ç»„é¡¹">
                    <i class="fa fa-plus"></i>
                </button>
            `;
        } else if (type === 'object') {
            specialActions = `
                <button class="btn-icon btn-special" data-action="add-object-property" data-variable-id="${key}" title="æ·»åŠ å±æ€§">
                    <i class="fa fa-plus"></i>
                </button>
            `;
        }

        return `
            <div class="variable-item" data-variable-id="${key}" data-variable-type="${type}">
                <div class="variable-header">
                    <div class="variable-info">
                        <span class="variable-name">${key}</span>
                        <span class="variable-type ${type}">${type}</span>
                        ${isGlobal ? '<span class="variable-scope global">å…¨å±€</span>' : '<span class="variable-scope local">å±€éƒ¨</span>'}
                        ${specialActions}
                    </div>
                    <div class="variable-actions">
                        <button class="btn-icon" data-action="edit-variable" title="ç¼–è¾‘">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" data-action="delete-variable" title="åˆ é™¤">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="variable-content">
                    <div class="variable-value">${this.formatVariableValue(value, type)}</div>
                    ${description ? `<div class="variable-description">${description}</div>` : ''}
                    ${this.createVariableContentActions(key, type, value)}
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå˜é‡å†…å®¹æ“ä½œåŒºåŸŸ
     */
    createVariableContentActions(key, type, value) {
        if (type === 'array' && Array.isArray(value)) {
            return `
                <div class="variable-content-actions">
                    <div class="array-items">
                        ${value.map((item, index) => this.createArrayItemElement(key, item, index)).join('')}
                    </div>
                    <button class="btn-add-item" data-action="add-array-item" data-variable-id="${key}">
                        <i class="fa fa-plus"></i> æ·»åŠ é¡¹
                    </button>
                </div>
            `;
        } else if (type === 'object' && typeof value === 'object' && value !== null) {
            return `
                <div class="variable-content-actions">
                    <div class="object-properties">
                        ${Object.entries(value).map(([propKey, propValue]) =>
                            this.createObjectPropertyElement(key, propKey, propValue, 0)
                        ).join('')}
                    </div>
                    <button class="btn-add-item" data-action="add-object-property" data-variable-id="${key}">
                        <i class="fa fa-plus"></i> æ·»åŠ å±æ€§
                    </button>
                </div>
            `;
        }
        return '';
    }

    /**
     * åˆ›å»ºæ•°ç»„é¡¹å…ƒç´ 
     */
    createArrayItemElement(variableId, item, index, level = 0) {
        let content = '';

        if (Array.isArray(item)) {
            content = `
                <div class="array-item nested-array" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-type-indicator">[æ•°ç»„:${item.length}é¡¹]</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-array-item" data-variable-id="${variableId}" data-path="${index}" title="æ·»åŠ å­é¡¹">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-array" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘æ•°ç»„">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-array-item" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${item.map((subItem, subIndex) =>
                        this.createArrayItemElement(variableId, subItem, subIndex, level + 1)
                    ).join('')}
                </div>
            `;
        } else if (typeof item === 'object' && item !== null) {
            content = `
                <div class="array-item nested-object" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-type-indicator">{å¯¹è±¡:${Object.keys(item).length}é”®}</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-object-property" data-variable-id="${variableId}" data-path="${index}" title="æ·»åŠ å±æ€§">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-object" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘å¯¹è±¡">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-array-item" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${Object.entries(item).map(([propKey, propValue]) =>
                        this.createObjectPropertyElement(variableId, propKey, propValue, level + 1, `${index}.${propKey}`)
                    ).join('')}
                </div>
            `;
        } else {
            content = `
                <div class="array-item" data-index="${index}" style="margin-left: ${level * 20}px;">
                    <span class="array-index">[${index}]</span>
                    <span class="array-value">${this.formatArrayItemValue(item)}</span>
                    <button class="btn-icon-small btn-primary" data-action="edit-array-item" data-variable-id="${variableId}" data-index="${index}" data-level="${level}" title="ç¼–è¾‘é¡¹">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="${level > 0 ? 'remove-nested-array-item' : 'remove-array-item'}" data-index="${index}" data-variable-id="${variableId}" data-level="${level}" title="åˆ é™¤é¡¹">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
        }

        return content;
    }

    /**
     * åˆ›å»ºå¯¹è±¡å±æ€§å…ƒç´ 
     */
    createObjectPropertyElement(variableId, propKey, propValue, level = 0, path = '') {
        const fullPath = path ? `${path}` : propKey;
        let content = '';

        if (Array.isArray(propValue)) {
            content = `
                <div class="object-property nested-array" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-type-indicator">[æ•°ç»„:${propValue.length}é¡¹]</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-array-item" data-variable-id="${variableId}" data-path="${fullPath}" title="æ·»åŠ å­é¡¹">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-property-array" data-variable-id="${variableId}" data-key="${propKey}" data-path="${fullPath}" data-level="${level}" title="ç¼–è¾‘æ•°ç»„">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-object-property" data-key="${propKey}" data-variable-id="${variableId}" data-path="${fullPath}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${propValue.map((item, index) =>
                        this.createArrayItemElement(variableId, item, index, level + 1)
                    ).join('')}
                </div>
            `;
        } else if (typeof propValue === 'object' && propValue !== null) {
            content = `
                <div class="object-property nested-object" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-type-indicator">{å¯¹è±¡:${Object.keys(propValue).length}é”®}</span>
                    <button class="btn-icon-small btn-success" data-action="add-nested-object-property" data-variable-id="${variableId}" data-path="${fullPath}" title="æ·»åŠ å±æ€§">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn-icon-small btn-primary" data-action="edit-nested-property-object" data-variable-id="${variableId}" data-key="${propKey}" data-path="${fullPath}" data-level="${level}" title="ç¼–è¾‘å¯¹è±¡">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="remove-nested-object-property" data-key="${propKey}" data-variable-id="${variableId}" data-path="${fullPath}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="nested-items">
                    ${Object.entries(propValue).map(([subKey, subValue]) =>
                        this.createObjectPropertyElement(variableId, subKey, subValue, level + 1, `${fullPath}.${subKey}`)
                    ).join('')}
                </div>
            `;
        } else {
            content = `
                <div class="object-property" data-key="${propKey}" style="margin-left: ${level * 20}px;">
                    <span class="property-key">${propKey}:</span>
                    <span class="property-value">${this.formatArrayItemValue(propValue)}</span>
                    <button class="btn-icon-small btn-primary" data-action="edit-object-property" data-variable-id="${variableId}" data-key="${propKey}" data-path="${path}" data-level="${level}" title="ç¼–è¾‘å±æ€§">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-icon-small btn-danger" data-action="${level > 0 ? 'remove-nested-object-property' : 'remove-object-property'}" data-key="${propKey}" data-variable-id="${variableId}" data-path="${path}" data-level="${level}" title="åˆ é™¤å±æ€§">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
        }

        return content;
    }

    /**
     * æ ¼å¼åŒ–æ•°ç»„é¡¹å€¼
     */
    formatArrayItemValue(value) {
        if (value === null || value === undefined) {
            return '<span class="null-value">null</span>';
        }
        if (typeof value === 'string') {
            return `"${value}"`;
        }
        if (typeof value === 'object') {
            return Array.isArray(value) ? `[æ•°ç»„:${value.length}é¡¹]` : `{å¯¹è±¡:${Object.keys(value).length}é”®}`;
        }
        return String(value);
    }

    /**
     * æ ¼å¼åŒ–å˜é‡å€¼æ˜¾ç¤º
     */
    formatVariableValue(value, type) {
        if (value === null || value === undefined) {
            return '<span class="null-value">null</span>';
        }

        switch (type) {
            case 'string':
                return `"${value}"`;
            case 'number':
                return value.toString();
            case 'boolean':
                return value ? 'true' : 'false';
            case 'array':
                return Array.isArray(value) ? `[${value.length} é¡¹]` : '[]';
            case 'object':
                return typeof value === 'object' ? `{${Object.keys(value).length} é”®}` : '{}';
            case 'function':
                return '<span class="function-value">function</span>';
            default:
                return value.toString();
        }
    }

    /**
     * æ·»åŠ æ–°å˜é‡
     */
    addNewVariable() {
        this.showVariableEditDialog();
    }

    /**
     * æ˜¾ç¤ºå˜é‡ç¼–è¾‘å¯¹è¯æ¡†
     */
    showVariableEditDialog(existingVariable = null, variableKey = null) {
        const isEdit = !!existingVariable;
        const typeSelect = document.querySelector('#variable-type-select');
        const selectedType = typeSelect ? typeSelect.value : 'string';

        // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'variable-edit-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.variable-edit-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘å˜é‡' : 'æ·»åŠ å˜é‡'}</h3>
                    <button class="dialog-close" onclick="this.closest('.variable-edit-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å˜é‡å</label>
                        <input type="text" id="variable-name" value="${existingVariable?.name || variableKey || ''}" ${isEdit ? 'readonly' : ''}>
                    </div>
                    <div class="form-group">
                        <label>å˜é‡ç±»å‹</label>
                        <select id="variable-type" ${isEdit ? 'disabled' : ''}>
                            <option value="string" ${(existingVariable?.type || selectedType) === 'string' ? 'selected' : ''}>å­—ç¬¦ä¸²</option>
                            <option value="number" ${(existingVariable?.type || selectedType) === 'number' ? 'selected' : ''}>æ•°å­—</option>
                            <option value="boolean" ${(existingVariable?.type || selectedType) === 'boolean' ? 'selected' : ''}>å¸ƒå°”å€¼</option>
                            <option value="array" ${(existingVariable?.type || selectedType) === 'array' ? 'selected' : ''}>æ•°ç»„</option>
                            <option value="object" ${(existingVariable?.type || selectedType) === 'object' ? 'selected' : ''}>å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å˜é‡å€¼</label>
                        <textarea id="variable-value" rows="4" placeholder="è¯·è¾“å…¥å˜é‡å€¼...">${this.formatValueForEdit(existingVariable?.value, existingVariable?.type)}</textarea>
                        <div class="value-hint" id="value-hint">
                            ${this.getValueHint(existingVariable?.type || selectedType)}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ä½œç”¨åŸŸ</label>
                        <div class="scope-info">
                            <i class="fa ${this.currentVariableScope === 'global' ? 'fa-globe' : 'fa-comments'}"></i>
                            ${this.currentVariableScope === 'global' ? 'å…¨å±€å˜é‡' : 'èŠå¤©å˜é‡'}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.variable-edit-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-variable-dialog" data-is-edit="${isEdit}" data-variable-key="${variableKey || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶ - ä½¿ç”¨ç®­å¤´å‡½æ•°ä¿æŒthisä¸Šä¸‹æ–‡
        const self = this;
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-variable-dialog') {
                const isEdit = actionElement.dataset.isEdit === 'true';
                const variableKey = actionElement.dataset.variableKey || '';
                console.log('[VariableManager] ğŸ”˜ å¯¹è¯æ¡†ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»');
                self.saveVariableFromDialog(actionElement, isEdit, variableKey);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#variable-type');
        const valueHint = dialog.querySelector('#value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#variable-name');
            if (nameInput && !isEdit) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * æ ¼å¼åŒ–å€¼ç”¨äºç¼–è¾‘
     */
    formatValueForEdit(value, type) {
        if (value === null || value === undefined) {
            return '';
        }

        if (type === 'array' || type === 'object') {
            try {
                return JSON.stringify(value, null, 2);
            } catch (e) {
                return String(value);
            }
        }

        return String(value);
    }

    /**
     * è·å–å€¼æç¤º
     */
    getValueHint(type) {
        switch (type) {
            case 'string':
                return 'è¾“å…¥æ–‡æœ¬å†…å®¹ï¼Œä¾‹å¦‚ï¼šHello World';
            case 'number':
                return 'è¾“å…¥æ•°å­—ï¼Œä¾‹å¦‚ï¼š42 æˆ– 3.14';
            case 'boolean':
                return 'è¾“å…¥ true æˆ– false';
            case 'array':
                return 'è¾“å…¥JSONæ•°ç»„ï¼Œä¾‹å¦‚ï¼š["item1", "item2", "item3"]';
            case 'object':
                return 'è¾“å…¥JSONå¯¹è±¡ï¼Œä¾‹å¦‚ï¼š{"key1": "value1", "key2": "value2"}';
            default:
                return '';
        }
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜å˜é‡
     */
    async saveVariableFromDialog(button, isEdit, existingKey) {
        try {
            const dialog = button.closest('.variable-edit-dialog');
            const name = dialog.querySelector('#variable-name').value.trim();
            const type = dialog.querySelector('#variable-type').value;
            const valueText = dialog.querySelector('#variable-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å˜é‡å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å˜é‡å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜å˜é‡
            await this.saveVariableToSillyTavern(name, value, type, isEdit, existingKey);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.loadVariables();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'å˜é‡:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            alert('ä¿å­˜å˜é‡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * è§£æå˜é‡å€¼
     */
    parseVariableValue(valueText, type) {
        if (!valueText) {
            switch (type) {
                case 'string': return '';
                case 'number': return 0;
                case 'boolean': return false;
                case 'array': return [];
                case 'object': return {};
                default: return '';
            }
        }

        switch (type) {
            case 'string':
                return valueText;
            case 'number':
                const num = Number(valueText);
                if (isNaN(num)) {
                    throw new Error('æ— æ•ˆçš„æ•°å­—æ ¼å¼');
                }
                return num;
            case 'boolean':
                const lower = valueText.toLowerCase();
                if (lower === 'true') return true;
                if (lower === 'false') return false;
                throw new Error('å¸ƒå°”å€¼å¿…é¡»æ˜¯ true æˆ– false');
            case 'array':
            case 'object':
                try {
                    const parsed = JSON.parse(valueText);
                    if (type === 'array' && !Array.isArray(parsed)) {
                        throw new Error('å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„');
                    }
                    if (type === 'object' && (Array.isArray(parsed) || typeof parsed !== 'object')) {
                        throw new Error('å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡');
                    }
                    return parsed;
                } catch (e) {
                    throw new Error('æ— æ•ˆçš„JSONæ ¼å¼: ' + e.message);
                }
            default:
                return valueText;
        }
    }

    /**
     * ä¿å­˜å˜é‡åˆ°SillyTavern
     */
    async saveVariableToSillyTavern(name, value, type, isEdit, existingKey) {
        try {
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();

                if (this.currentVariableScope === 'global') {
                    // ä¿å­˜å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    if (!extensionSettings.variables) {
                        extensionSettings.variables = {};
                    }

                    // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
                    if (isEdit && existingKey && existingKey !== name) {
                        delete extensionSettings.variables[existingKey];
                    }

                    extensionSettings.variables[name] = value;

                    // ä¿å­˜è®¾ç½®
                    if (context.saveSettingsDebounced) {
                        context.saveSettingsDebounced();
                    }
                } else {
                    // ä¿å­˜èŠå¤©å˜é‡
                    const chatMetadata = context.chatMetadata || {};
                    if (!chatMetadata.variables) {
                        chatMetadata.variables = {};
                    }

                    // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
                    if (isEdit && existingKey && existingKey !== name) {
                        delete chatMetadata.variables[existingKey];
                    }

                    chatMetadata.variables[name] = value;

                    // ä¿å­˜å…ƒæ•°æ®
                    if (context.saveMetadata) {
                        await context.saveMetadata();
                    }
                }

                console.log('[VariableManager] âœ… å˜é‡å·²ä¿å­˜åˆ°SillyTavern:', name);
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                const configKey = this.currentVariableScope === 'global' ? 'globalVariables' : 'chatVariables';
                const variables = await this.configManager.getConfig(configKey) || {};

                if (isEdit && existingKey && existingKey !== name) {
                    delete variables[existingKey];
                }

                variables[name] = {
                    type: type,
                    value: value,
                    scope: this.currentVariableScope,
                    created: new Date().toISOString()
                };

                await this.configManager.setConfig(configKey, variables);
                console.log('[VariableManager] âœ… å˜é‡å·²ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨:', name);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä¿å­˜å˜é‡
     */
    async saveVariables() {
        try {
            await this.configManager.setConfig('variables', this.variables || {});
            this.showMessage('å˜é‡ä¿å­˜æˆåŠŸ', 'success');
            console.log('[VariableManager] âœ… å˜é‡ä¿å­˜æˆåŠŸ');
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å˜é‡å¤±è´¥:', error);
            this.showMessage('ä¿å­˜å˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡ï¼ˆå…¨å±€/èŠå¤©ï¼‰
     */
    async clearCurrentScopeVariables() {
        try {
            const scope = this.currentVariableScope || 'global';
            const confirmed = confirm(`ç¡®å®šè¦æ¸…ç©º${scope === 'global' ? 'ã€å…¨å±€å˜é‡ã€‘' : 'ã€èŠå¤©å˜é‡ã€‘'}å†…çš„æ‰€æœ‰å˜é‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (!confirmed) return;

            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                if (scope === 'global') {
                    // æ¸…ç©ºæ‰©å±•è®¾ç½®ä¸­çš„å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    extensionSettings.variables = {};
                    await context.saveSettingsDebounced?.();
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºå…¨å±€å˜é‡');
                } else {
                    // æ¸…ç©ºå½“å‰èŠå¤©çš„å˜é‡ï¼ˆä¿å­˜åœ¨configManagerä¸­ï¼‰
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºèŠå¤©å˜é‡:', configKey);
                }
            } else {
                // å…œåº•ï¼šä»…æ¸…ç©ºå†…å­˜å˜é‡å¹¶ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨
                if (scope === 'global') {
                    await this.configManager.setConfig('variables', {});
                } else {
                    const context = (window.SillyTavern && window.SillyTavern.getContext) ? window.SillyTavern.getContext() : null;
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                }
            }

            // åˆ·æ–°å†…å­˜ä¸UI
            this.variables = {};
            this.renderVariableList();
            this.showMessage('å˜é‡å·²æ¸…ç©º', 'success');
        } catch (error) {
            console.error('[VariableManager] âŒ æ¸…ç©ºå˜é‡å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }
    /**
     * æ¸…ç©ºå½“å‰ä½œç”¨åŸŸå˜é‡ï¼ˆå…¨å±€/èŠå¤©ï¼‰
     */
    async clearCurrentScopeVariables() {
        try {
            const scope = this.currentVariableScope || 'global';
            const confirmed = confirm(`ç¡®å®šè¦æ¸…ç©º${scope === 'global' ? 'ã€å…¨å±€å˜é‡ã€‘' : 'ã€èŠå¤©å˜é‡ã€‘'}å†…çš„æ‰€æœ‰å˜é‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (!confirmed) return;

            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();
                if (scope === 'global') {
                    // æ¸…ç©ºæ‰©å±•è®¾ç½®ä¸­çš„å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    extensionSettings.variables = {};
                    await context.saveSettingsDebounced?.();
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºå…¨å±€å˜é‡');
                } else {
                    // æ¸…ç©ºå½“å‰èŠå¤©çš„å˜é‡ï¼ˆä¿å­˜åœ¨configManagerä¸­ï¼‰
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                    console.log('[VariableManager] ğŸ—‘ï¸ å·²æ¸…ç©ºèŠå¤©å˜é‡:', configKey);
                }
            } else {
                // å…œåº•ï¼šä»…æ¸…ç©ºå†…å­˜å˜é‡å¹¶ä¿å­˜åˆ°é…ç½®ç®¡ç†å™¨
                if (scope === 'global') {
                    await this.configManager.setConfig('variables', {});
                } else {
                    const context = (window.SillyTavern && window.SillyTavern.getContext) ? window.SillyTavern.getContext() : null;
                    const configKey = `chat_${context?.chat?.public_id || 'current'}_variables`;
                    await this.configManager.setConfig(configKey, {});
                }
            }

            // åˆ·æ–°å†…å­˜ä¸UI
            this.variables = {};
            this.renderVariableList();
            this.showMessage('å˜é‡å·²æ¸…ç©º', 'success');
        } catch (error) {
            console.error('[VariableManager] âŒ æ¸…ç©ºå˜é‡å¤±è´¥:', error);
            this.showMessage('æ¸…ç©ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * è¿‡æ»¤å˜é‡
     */
    filterVariables(searchTerm) {
        const variableItems = document.querySelectorAll('.variable-item');
        const term = searchTerm.toLowerCase();

        variableItems.forEach(item => {
            const name = item.querySelector('.variable-name').textContent.toLowerCase();
            const description = item.querySelector('.variable-description')?.textContent?.toLowerCase() || '';

            if (name.includes(term) || description.includes(term)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    /**
     * ç¼–è¾‘å˜é‡
     */
    editVariable(variableId) {
        const variable = this.variables[variableId];
        if (!variable) return;

        // æ˜¾ç¤ºç¼–è¾‘å¯¹è¯æ¡†
        this.showVariableEditDialog(variable, variableId);
    }

    /**
     * åˆ é™¤å˜é‡
     */
    async deleteVariable(variableId) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å˜é‡ "${variableId}" å—ï¼Ÿ`)) return;

        try {
            // ä»SillyTavernåˆ é™¤å˜é‡
            await this.deleteVariableFromSillyTavern(variableId);

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.loadVariables();

            console.log('[VariableManager] âœ… åˆ é™¤å˜é‡:', variableId);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤å˜é‡å¤±è´¥:', error);
            alert('åˆ é™¤å˜é‡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä»SillyTavernåˆ é™¤å˜é‡
     */
    async deleteVariableFromSillyTavern(variableId) {
        try {
            if (window.SillyTavern && window.SillyTavern.getContext) {
                const context = window.SillyTavern.getContext();

                if (this.currentVariableScope === 'global') {
                    // åˆ é™¤å…¨å±€å˜é‡
                    const extensionSettings = context.extensionSettings || {};
                    if (extensionSettings.variables) {
                        delete extensionSettings.variables[variableId];

                        // ä¿å­˜è®¾ç½®
                        if (context.saveSettingsDebounced) {
                            context.saveSettingsDebounced();
                        }
                    }
                } else {
                    // åˆ é™¤èŠå¤©å˜é‡
                    const chatMetadata = context.chatMetadata || {};
                    if (chatMetadata.variables) {
                        delete chatMetadata.variables[variableId];

                        // ä¿å­˜å…ƒæ•°æ®
                        if (context.saveMetadata) {
                            await context.saveMetadata();
                        }
                    }
                }
            } else {
                // å›é€€åˆ°é…ç½®ç®¡ç†å™¨
                const configKey = this.currentVariableScope === 'global' ? 'globalVariables' : 'chatVariables';
                const variables = await this.configManager.getConfig(configKey) || {};
                delete variables[variableId];
                await this.configManager.setConfig(configKey, variables);
            }
        } catch (error) {
            console.error('[VariableManager] âŒ ä»SillyTavernåˆ é™¤å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * å¯¼å‡ºå˜é‡
     */
    exportVariables() {
        try {
            const data = {
                variables: this.variables || {},
                exported: new Date().toISOString(),
                version: '1.0.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `variables_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();

            URL.revokeObjectURL(url);

            this.showMessage('å˜é‡å¯¼å‡ºæˆåŠŸ', 'success');
            console.log('[VariableManager] âœ… å˜é‡å¯¼å‡ºæˆåŠŸ');
        } catch (error) {
            console.error('[VariableManager] âŒ å¯¼å‡ºå˜é‡å¤±è´¥:', error);
            this.showMessage('å¯¼å‡ºå˜é‡å¤±è´¥: ' + error.message, 'error');
        }
    }

    /**
     * å¯¼å…¥å˜é‡
     */
    importVariables() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = async (e) => {
            try {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                const data = JSON.parse(text);

                if (data.variables) {
                    // åˆå¹¶å˜é‡ï¼ˆå¯ä»¥é€‰æ‹©è¦†ç›–æˆ–è·³è¿‡é‡å¤ï¼‰
                    const shouldOverwrite = confirm('æ˜¯å¦è¦†ç›–åŒåå˜é‡ï¼Ÿç‚¹å‡»"ç¡®å®š"è¦†ç›–ï¼Œ"å–æ¶ˆ"è·³è¿‡ã€‚');

                    Object.entries(data.variables).forEach(([key, variable]) => {
                        if (!this.variables[key] || shouldOverwrite) {
                            this.variables[key] = variable;
                        }
                    });

                    this.renderVariableList();
                    this.showMessage('å˜é‡å¯¼å…¥æˆåŠŸ', 'success');
                    console.log('[VariableManager] âœ… å˜é‡å¯¼å…¥æˆåŠŸ');
                } else {
                    throw new Error('æ— æ•ˆçš„å˜é‡æ–‡ä»¶æ ¼å¼');
                }
            } catch (error) {
                console.error('[VariableManager] âŒ å¯¼å…¥å˜é‡å¤±è´¥:', error);
                this.showMessage('å¯¼å…¥å˜é‡å¤±è´¥: ' + error.message, 'error');
            }
        };

        input.click();
    }

    /**
     * æ·»åŠ æ•°ç»„é¡¹
     */
    async addArrayItem(variableId) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            // æ˜¾ç¤ºç®€åŒ–çš„æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
            this.showArrayItemDialog(variableId);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('æ·»åŠ æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºæ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showArrayItemDialog(variableId, existingIndex = null, existingValue = null) {
        const isEdit = existingIndex !== null;

        // åˆ›å»ºç®€åŒ–çš„æ•°ç»„é¡¹å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘æ•°ç»„é¡¹' : 'æ·»åŠ æ•°ç»„é¡¹'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>æ•°ç»„é¡¹å€¼</label>
                        <textarea id="array-item-value" rows="3" placeholder="è¯·è¾“å…¥æ•°ç»„é¡¹å€¼...">${existingValue || ''}</textarea>
                        <div class="value-hint">
                            æ”¯æŒæ–‡æœ¬ã€æ•°å­—ã€JSONå¯¹è±¡ç­‰æ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±æ•°ç»„</label>
                        <div class="scope-info">
                            <i class="fa fa-list"></i>
                            ${variableId}${isEdit ? ` [${existingIndex}]` : ''}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-array-item" data-variable-id="${variableId}" data-is-edit="${isEdit}" data-index="${existingIndex || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-array-item') {
                const variableId = actionElement.dataset.variableId;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const index = actionElement.dataset.index || null;
                this.saveArrayItemFromDialog(actionElement, variableId, isEdit, index);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#array-item-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜æ•°ç»„é¡¹
     */
    async saveArrayItemFromDialog(button, variableId, isEdit, index) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const valueText = dialog.querySelector('#array-item-value').value.trim();

            if (!valueText) {
                alert('è¯·è¾“å…¥æ•°ç»„é¡¹å€¼');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥åˆ™ä½œä¸ºå­—ç¬¦ä¸²
                value = JSON.parse(valueText);
            } catch (e) {
                value = valueText;
            }

            // ä¿å­˜æ•°ç»„é¡¹
            await this.saveArrayItemToVariable(variableId, value, isEdit, index);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'æ•°ç»„é¡¹:', value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ä¿å­˜æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜æ•°ç»„é¡¹åˆ°å˜é‡
     */
    async saveArrayItemToVariable(variableId, value, isEdit, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array') {
                throw new Error('å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹');
            }

            // ç¡®ä¿å˜é‡å€¼æ˜¯æ•°ç»„
            if (!Array.isArray(variable.value)) {
                variable.value = [];
            }

            if (isEdit && index !== null) {
                // ç¼–è¾‘ç°æœ‰é¡¹
                variable.value[parseInt(index)] = value;
            } else {
                // æ·»åŠ æ–°é¡¹
                variable.value.push(value);
            }

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… æ•°ç»„é¡¹å·²ä¿å­˜:', variableId, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜æ•°ç»„é¡¹åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ é™¤æ•°ç»„é¡¹
     */
    async removeArrayItem(variableId, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array' || !Array.isArray(variable.value)) {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°ç»„é¡¹ [${index}] å—ï¼Ÿ`)) return;

            // åˆ é™¤æ•°ç»„é¡¹
            variable.value.splice(index, 1);

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤æ•°ç»„é¡¹:', variableId, index);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('åˆ é™¤æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ·»åŠ å¯¹è±¡å±æ€§
     */
    async addObjectProperty(variableId) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹:', variableId);
                return;
            }

            // æ˜¾ç¤ºæ·»åŠ å±æ€§å¯¹è¯æ¡†
            this.showObjectPropertyDialog(variableId);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('æ·»åŠ å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºå¯¹è±¡å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showObjectPropertyDialog(variableId, existingKey = null, existingProperty = null) {
        const isEdit = !!existingProperty;

        // åˆ›å»ºå±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'object-property-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.object-property-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘å±æ€§' : 'æ·»åŠ å±æ€§'}</h3>
                    <button class="dialog-close" onclick="this.closest('.object-property-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="property-name" value="${existingKey || ''}" ${isEdit ? 'readonly' : ''} placeholder="è¯·è¾“å…¥å±æ€§å">
                    </div>
                    <div class="form-group">
                        <label>å±æ€§ç±»å‹</label>
                        <select id="property-type">
                            <option value="string" ${(existingProperty?.type || 'string') === 'string' ? 'selected' : ''}>å­—ç¬¦ä¸²</option>
                            <option value="number" ${(existingProperty?.type || 'string') === 'number' ? 'selected' : ''}>æ•°å­—</option>
                            <option value="boolean" ${(existingProperty?.type || 'string') === 'boolean' ? 'selected' : ''}>å¸ƒå°”å€¼</option>
                            <option value="array" ${(existingProperty?.type || 'string') === 'array' ? 'selected' : ''}>æ•°ç»„</option>
                            <option value="object" ${(existingProperty?.type || 'string') === 'object' ? 'selected' : ''}>å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å±æ€§å€¼</label>
                        <textarea id="property-value" rows="4" placeholder="è¯·è¾“å…¥å±æ€§å€¼...">${this.formatValueForEdit(existingProperty?.value, existingProperty?.type)}</textarea>
                        <div class="value-hint" id="property-value-hint">
                            ${this.getValueHint(existingProperty?.type || 'string')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±å¯¹è±¡</label>
                        <div class="scope-info">
                            <i class="fa fa-cube"></i>
                            ${variableId}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.object-property-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-object-property" data-variable-id="${variableId}" data-is-edit="${isEdit}" data-existing-key="${existingKey || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-object-property') {
                const variableId = actionElement.dataset.variableId;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const existingKey = actionElement.dataset.existingKey || '';
                this.saveObjectPropertyFromDialog(actionElement, variableId, isEdit, existingKey);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#property-type');
        const valueHint = dialog.querySelector('#property-value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#property-name');
            if (nameInput && !isEdit) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜å¯¹è±¡å±æ€§
     */
    async saveObjectPropertyFromDialog(button, variableId, isEdit, existingKey) {
        try {
            const dialog = button.closest('.object-property-dialog');
            const name = dialog.querySelector('#property-name').value.trim();
            const type = dialog.querySelector('#property-type').value;
            const valueText = dialog.querySelector('#property-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å±æ€§å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜å±æ€§
            await this.saveObjectPropertyToVariable(variableId, name, value, isEdit, existingKey);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'å¯¹è±¡å±æ€§:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ä¿å­˜å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜å¯¹è±¡å±æ€§åˆ°å˜é‡
     */
    async saveObjectPropertyToVariable(variableId, propertyName, propertyValue, isEdit, existingKey) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object') {
                throw new Error('å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹');
            }

            // ç¡®ä¿å˜é‡å€¼æ˜¯å¯¹è±¡
            if (typeof variable.value !== 'object' || variable.value === null) {
                variable.value = {};
            }

            // å¦‚æœæ˜¯ç¼–è¾‘ä¸”é”®åæ”¹å˜ï¼Œåˆ é™¤æ—§é”®
            if (isEdit && existingKey && existingKey !== propertyName) {
                delete variable.value[existingKey];
            }

            // è®¾ç½®æ–°å€¼
            variable.value[propertyName] = propertyValue;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… å¯¹è±¡å±æ€§å·²ä¿å­˜:', variableId, propertyName, propertyValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜å¯¹è±¡å±æ€§åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ é™¤å¯¹è±¡å±æ€§
     */
    async removeObjectProperty(variableId, propertyKey) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'object' || typeof variable.value !== 'object') {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯å¯¹è±¡ç±»å‹:', variableId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤å±æ€§ "${propertyKey}" å—ï¼Ÿ`)) return;

            // åˆ é™¤å±æ€§
            delete variable.value[propertyKey];

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤å¯¹è±¡å±æ€§:', variableId, propertyKey);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('åˆ é™¤å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ·»åŠ åµŒå¥—æ•°ç»„é¡¹
     */
    async addNestedArrayItem(variableId, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ˜¾ç¤ºåµŒå¥—æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
            this.showNestedArrayItemDialog(variableId, path);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('æ·»åŠ åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—æ•°ç»„é¡¹æ·»åŠ å¯¹è¯æ¡†
     */
    showNestedArrayItemDialog(variableId, path, existingIndex = null, existingValue = null) {
        const isEdit = existingIndex !== null;

        // åˆ›å»ºåµŒå¥—æ•°ç»„é¡¹å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>${isEdit ? 'ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹' : 'æ·»åŠ åµŒå¥—æ•°ç»„é¡¹'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>æ•°ç»„é¡¹å€¼</label>
                        <textarea id="array-item-value" rows="3" placeholder="è¯·è¾“å…¥æ•°ç»„é¡¹å€¼...">${existingValue || ''}</textarea>
                        <div class="value-hint">
                            æ”¯æŒæ–‡æœ¬ã€æ•°å­—ã€JSONå¯¹è±¡ç­‰æ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}${isEdit ? ` [${existingIndex}]` : ''}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-array-item" data-variable-id="${variableId}" data-path="${path}" data-is-edit="${isEdit}" data-index="${existingIndex || ''}">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-array-item') {
                const variableId = actionElement.dataset.variableId;
                const path = actionElement.dataset.path;
                const isEdit = actionElement.dataset.isEdit === 'true';
                const index = actionElement.dataset.index || null;
                this.saveNestedArrayItemFromDialog(actionElement, variableId, path, isEdit, index);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#array-item-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—æ•°ç»„é¡¹
     */
    async saveNestedArrayItemFromDialog(button, variableId, path, isEdit, index) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const valueText = dialog.querySelector('#array-item-value').value.trim();

            if (!valueText) {
                alert('è¯·è¾“å…¥æ•°ç»„é¡¹å€¼');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                value = valueText;
            }

            // ä¿å­˜åµŒå¥—æ•°ç»„é¡¹
            await this.saveNestedArrayItemToVariable(variableId, path, value, isEdit, index);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ…', isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ', 'åµŒå¥—æ•°ç»„é¡¹:', value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜åµŒå¥—æ•°ç»„é¡¹åˆ°å˜é‡
     */
    async saveNestedArrayItemToVariable(variableId, path, value, isEdit, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–åµŒå¥—æ•°ç»„çš„å¼•ç”¨
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                throw new Error('ç›®æ ‡ä¸æ˜¯æ•°ç»„');
            }

            if (isEdit && index !== null) {
                // ç¼–è¾‘ç°æœ‰é¡¹
                targetArray[parseInt(index)] = value;
            } else {
                // æ·»åŠ æ–°é¡¹
                targetArray.push(value);
            }

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—æ•°ç»„é¡¹å·²ä¿å­˜:', variableId, path, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—æ•°ç»„é¡¹åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§
     */
    async addNestedObjectProperty(variableId, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ˜¾ç¤ºåµŒå¥—å±æ€§å¯¹è¯æ¡†
            this.showNestedObjectPropertyDialog(variableId, path);

        } catch (error) {
            console.error('[VariableManager] âŒ æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—å¯¹è±¡å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showNestedObjectPropertyDialog(variableId, path) {
        // åˆ›å»ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'object-property-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.object-property-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>æ·»åŠ åµŒå¥—å±æ€§</h3>
                    <button class="dialog-close" onclick="this.closest('.object-property-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="property-name" placeholder="è¯·è¾“å…¥å±æ€§å">
                    </div>
                    <div class="form-group">
                        <label>å±æ€§ç±»å‹</label>
                        <select id="property-type">
                            <option value="string">å­—ç¬¦ä¸²</option>
                            <option value="number">æ•°å­—</option>
                            <option value="boolean">å¸ƒå°”å€¼</option>
                            <option value="array">æ•°ç»„</option>
                            <option value="object">å¯¹è±¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å±æ€§å€¼</label>
                        <textarea id="property-value" rows="4" placeholder="è¯·è¾“å…¥å±æ€§å€¼..."></textarea>
                        <div class="value-hint" id="property-value-hint">
                            ${this.getValueHint('string')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.object-property-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-object-property" data-variable-id="${variableId}" data-path="${path}">æ·»åŠ </button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-object-property') {
                const variableId = actionElement.dataset.variableId;
                const path = actionElement.dataset.path;
                this.saveNestedObjectPropertyFromDialog(actionElement, variableId, path);
            }
        });

        // ç»‘å®šç±»å‹å˜æ›´äº‹ä»¶
        const typeSelectElement = dialog.querySelector('#property-type');
        const valueHint = dialog.querySelector('#property-value-hint');

        typeSelectElement.addEventListener('change', (e) => {
            valueHint.textContent = this.getValueHint(e.target.value);
        });

        // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            const nameInput = dialog.querySelector('#property-name');
            if (nameInput) {
                nameInput.focus();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§
     */
    async saveNestedObjectPropertyFromDialog(button, variableId, path) {
        try {
            const dialog = button.closest('.object-property-dialog');
            const name = dialog.querySelector('#property-name').value.trim();
            const type = dialog.querySelector('#property-type').value;
            const valueText = dialog.querySelector('#property-value').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            // è§£æå€¼
            let value;
            try {
                value = this.parseVariableValue(valueText, type);
            } catch (e) {
                alert('å±æ€§å€¼æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // ä¿å­˜åµŒå¥—å±æ€§
            await this.saveNestedObjectPropertyToVariable(variableId, path, name, value);

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… æ·»åŠ åµŒå¥—å¯¹è±¡å±æ€§:', name);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§åˆ°å˜é‡
     */
    async saveNestedObjectPropertyToVariable(variableId, path, propertyName, propertyValue) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–åµŒå¥—å¯¹è±¡çš„å¼•ç”¨
            const targetObject = this.getNestedValue(variable.value, path);
            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // è®¾ç½®æ–°å€¼
            targetObject[propertyName] = propertyValue;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—å¯¹è±¡å±æ€§å·²ä¿å­˜:', variableId, path, propertyName, propertyValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å¯¹è±¡å±æ€§åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è·å–åµŒå¥—å€¼çš„å¼•ç”¨
     */
    getNestedValue(obj, path) {
        if (!path) return obj;

        const keys = path.split('.');
        let current = obj;

        for (const key of keys) {
            if (current === null || current === undefined) {
                return null;
            }

            // å¤„ç†æ•°ç»„ç´¢å¼•
            if (Array.isArray(current) && /^\d+$/.test(key)) {
                current = current[parseInt(key)];
            } else if (typeof current === 'object') {
                current = current[key];
            } else {
                return null;
            }
        }

        return current;
    }

    /**
     * åˆ é™¤åµŒå¥—æ•°ç»„é¡¹
     */
    async removeNestedArrayItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ åˆ é™¤åµŒå¥—æ•°ç»„é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            if (!confirm(`ç¡®å®šè¦åˆ é™¤åµŒå¥—æ•°ç»„é¡¹ [${index}] å—ï¼Ÿ\nè·¯å¾„: ${variableId}${path ? ' â†’ ' + path : ''}`)) return;

            // è·å–ç›®æ ‡æ•°ç»„
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯æ•°ç»„:', path);
                return;
            }

            // åˆ é™¤æ•°ç»„é¡¹
            targetArray.splice(parseInt(index), 1);

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤åµŒå¥—æ•°ç»„é¡¹:', variableId, path, index);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('åˆ é™¤åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§
     */
    async removeNestedObjectProperty(variableId, key, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§è·¯å¾„:', path, 'é”®:', key);

            if (!confirm(`ç¡®å®šè¦åˆ é™¤åµŒå¥—å±æ€§ "${key}" å—ï¼Ÿ\nè·¯å¾„: ${variableId}${path ? ' â†’ ' + path : ''}`)) return;

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            // åˆ é™¤å±æ€§
            delete targetObject[key];

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            // é‡æ–°æ¸²æŸ“
            this.renderVariableList();

            console.log('[VariableManager] âœ… åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§:', variableId, path, key);
        } catch (error) {
            console.error('[VariableManager] âŒ åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('åˆ é™¤åµŒå¥—å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ„å»ºåµŒå¥—è·¯å¾„
     */
    buildNestedPath(element, level) {
        const pathParts = [];

        // å‘ä¸Šéå†æ‰¾åˆ°æ‰€æœ‰åµŒå¥—å±‚çº§
        let currentElement = element.closest('.array-item, .object-property');
        while (currentElement && level > 0) {
            const parent = currentElement.closest('.nested-items');
            if (parent) {
                const parentItem = parent.previousElementSibling;
                if (parentItem) {
                    if (parentItem.classList.contains('array-item')) {
                        const index = parentItem.dataset.index;
                        if (index !== undefined) {
                            pathParts.unshift(index);
                        }
                    } else if (parentItem.classList.contains('object-property')) {
                        const key = parentItem.dataset.key;
                        if (key !== undefined) {
                            pathParts.unshift(key);
                        }
                    }
                }
                currentElement = parentItem;
                level--;
            } else {
                break;
            }
        }

        return pathParts.join('.');
    }

    /**
     * è·å–çˆ¶è·¯å¾„
     */
    getParentPath(path) {
        if (!path) return '';
        const parts = path.split('.');
        parts.pop(); // ç§»é™¤æœ€åä¸€éƒ¨åˆ†
        return parts.join('.');
    }

    /**
     * ç¼–è¾‘æ•°ç»„é¡¹
     */
    editArrayItem(variableId, index) {
        try {
            const variable = this.variables[variableId];
            if (!variable || variable.type !== 'array' || !Array.isArray(variable.value)) {
                console.error('[VariableManager] å˜é‡ä¸æ˜¯æ•°ç»„ç±»å‹:', variableId);
                return;
            }

            const currentValue = variable.value[parseInt(index)];
            const formattedValue = typeof currentValue === 'string' ? currentValue : JSON.stringify(currentValue);

            this.showArrayItemDialog(variableId, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘å¯¹è±¡å±æ€§
     */
    editObjectProperty(variableId, key, path) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // è·å–å½“å‰å±æ€§å€¼
            let currentValue;
            if (path && path !== key) {
                // åµŒå¥—å±æ€§
                const parentPath = this.getParentPath(path);
                const parentObject = this.getNestedValue(variable.value, parentPath);
                currentValue = parentObject[key];
            } else {
                // é¡¶çº§å±æ€§
                currentValue = variable.value[key];
            }

            // ç¡®å®šå±æ€§ç±»å‹
            let propertyType = 'string';
            if (typeof currentValue === 'number') {
                propertyType = 'number';
            } else if (typeof currentValue === 'boolean') {
                propertyType = 'boolean';
            } else if (Array.isArray(currentValue)) {
                propertyType = 'array';
            } else if (typeof currentValue === 'object' && currentValue !== null) {
                propertyType = 'object';
            }

            const existingProperty = {
                type: propertyType,
                value: currentValue
            };

            this.showObjectPropertyDialog(variableId, key, existingProperty);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘å¯¹è±¡å±æ€§å¤±è´¥:', error);
            alert('ç¼–è¾‘å¯¹è±¡å±æ€§å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹
     */
    editNestedArrayItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            // è·å–ç›®æ ‡æ•°ç»„
            const targetArray = this.getNestedValue(variable.value, path);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯æ•°ç»„:', path);
                return;
            }

            const currentValue = targetArray[parseInt(index)];
            const formattedValue = typeof currentValue === 'string' ? currentValue : JSON.stringify(currentValue);

            this.showNestedArrayItemDialog(variableId, path, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—æ•°ç»„é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹
     */
    editNestedObjectItem(variableId, index, level, event) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            // æ„å»ºåµŒå¥—è·¯å¾„
            const path = this.buildNestedPath(event.target, level);
            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹è·¯å¾„:', path, 'ç´¢å¼•:', index);

            // è·å–ç›®æ ‡æ•°ç»„ï¼ˆå¯¹è±¡åœ¨æ•°ç»„ä¸­ï¼‰
            const parentPath = this.getParentPath(path);
            const targetArray = this.getNestedValue(variable.value, parentPath);
            if (!Array.isArray(targetArray)) {
                console.error('[VariableManager] çˆ¶çº§ä¸æ˜¯æ•°ç»„:', parentPath);
                return;
            }

            const currentValue = targetArray[parseInt(index)];
            if (typeof currentValue !== 'object' || currentValue === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', currentValue);
                return;
            }

            // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå¯¹è±¡ç¼–è¾‘å¯¹è¯æ¡†ï¼Œæš‚æ—¶ç”¨JSONç¼–è¾‘
            const formattedValue = JSON.stringify(currentValue, null, 2);
            this.showNestedArrayItemDialog(variableId, parentPath, index, formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å¯¹è±¡é¡¹å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„
     */
    editNestedPropertyArray(variableId, key, path, level) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„:', path, 'é”®:', key);

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            const currentValue = targetObject[key];
            if (!Array.isArray(currentValue)) {
                console.error('[VariableManager] å±æ€§ä¸æ˜¯æ•°ç»„:', currentValue);
                return;
            }

            // æ˜¾ç¤ºæ•°ç»„ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆJSONæ ¼å¼ï¼‰
            const formattedValue = JSON.stringify(currentValue, null, 2);

            // åˆ›å»ºä¸´æ—¶çš„å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
            this.showNestedPropertyEditDialog(variableId, key, path, 'array', formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å±æ€§æ•°ç»„å¤±è´¥: ' + error.message);
        }
    }

    /**
     * ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡
     */
    editNestedPropertyObject(variableId, key, path, level) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                console.error('[VariableManager] å˜é‡ä¸å­˜åœ¨:', variableId);
                return;
            }

            console.log('[VariableManager] ğŸ”˜ ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡:', path, 'é”®:', key);

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                console.error('[VariableManager] ç›®æ ‡ä¸æ˜¯å¯¹è±¡:', parentPath);
                return;
            }

            const currentValue = targetObject[key];
            if (typeof currentValue !== 'object' || currentValue === null) {
                console.error('[VariableManager] å±æ€§ä¸æ˜¯å¯¹è±¡:', currentValue);
                return;
            }

            // æ˜¾ç¤ºå¯¹è±¡ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆJSONæ ¼å¼ï¼‰
            const formattedValue = JSON.stringify(currentValue, null, 2);

            // åˆ›å»ºä¸´æ—¶çš„å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
            this.showNestedPropertyEditDialog(variableId, key, path, 'object', formattedValue);
        } catch (error) {
            console.error('[VariableManager] âŒ ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡å¤±è´¥:', error);
            alert('ç¼–è¾‘åµŒå¥—å±æ€§å¯¹è±¡å¤±è´¥: ' + error.message);
        }
    }

    /**
     * æ˜¾ç¤ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
     */
    showNestedPropertyEditDialog(variableId, key, path, type, currentValue) {
        // åˆ›å»ºåµŒå¥—å±æ€§ç¼–è¾‘å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'array-item-dialog';
        dialog.innerHTML = `
            <div class="dialog-overlay" onclick="this.closest('.array-item-dialog').remove()"></div>
            <div class="dialog-container">
                <div class="dialog-header">
                    <h3>ç¼–è¾‘åµŒå¥—${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}</h3>
                    <button class="dialog-close" onclick="this.closest('.array-item-dialog').remove()">Ã—</button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>å±æ€§å</label>
                        <input type="text" id="nested-property-key" value="${key}" placeholder="è¯·è¾“å…¥å±æ€§å...">
                        <div class="value-hint">
                            ä¿®æ”¹å±æ€§åå°†é‡å‘½åè¯¥å±æ€§
                        </div>
                    </div>
                    <div class="form-group">
                        <label>${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}å†…å®¹ (JSONæ ¼å¼)</label>
                        <textarea id="nested-property-value" rows="6" placeholder="è¯·è¾“å…¥JSONæ ¼å¼çš„${type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡'}...">${currentValue}</textarea>
                        <div class="value-hint">
                            è¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ ¼å¼
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åµŒå¥—è·¯å¾„</label>
                        <div class="scope-info">
                            <i class="fa fa-sitemap"></i>
                            ${variableId} â†’ ${path}
                        </div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button class="btn-cancel" onclick="this.closest('.array-item-dialog').remove()">å–æ¶ˆ</button>
                    <button class="btn-save" data-action="save-nested-property-edit" data-variable-id="${variableId}" data-key="${key}" data-path="${path}" data-type="${type}">ä¿å­˜</button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
        dialog.addEventListener('click', (e) => {
            const actionElement = e.target.closest('[data-action]');
            const action = actionElement?.dataset?.action;

            if (action === 'save-nested-property-edit') {
                const variableId = actionElement.dataset.variableId;
                const key = actionElement.dataset.key;
                const path = actionElement.dataset.path;
                const type = actionElement.dataset.type;
                this.saveNestedPropertyEditFromDialog(actionElement, variableId, key, path, type);
            }
        });

        // èšç„¦åˆ°å€¼è¾“å…¥æ¡†
        setTimeout(() => {
            const valueInput = dialog.querySelector('#nested-property-value');
            if (valueInput) {
                valueInput.focus();
                valueInput.select();
            }
        }, 100);
    }

    /**
     * ä»å¯¹è¯æ¡†ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘
     */
    async saveNestedPropertyEditFromDialog(button, variableId, key, path, type) {
        try {
            const dialog = button.closest('.array-item-dialog');
            const newKey = dialog.querySelector('#nested-property-key').value.trim();
            const valueText = dialog.querySelector('#nested-property-value').value.trim();

            if (!newKey) {
                alert('è¯·è¾“å…¥å±æ€§å');
                return;
            }

            if (!valueText) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            // è§£æJSONå€¼
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                alert('JSONæ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            // éªŒè¯ç±»å‹
            if (type === 'array' && !Array.isArray(value)) {
                alert('è¾“å…¥çš„å†…å®¹ä¸æ˜¯æ•°ç»„æ ¼å¼');
                return;
            }
            if (type === 'object' && (typeof value !== 'object' || value === null || Array.isArray(value))) {
                alert('è¾“å…¥çš„å†…å®¹ä¸æ˜¯å¯¹è±¡æ ¼å¼');
                return;
            }

            // å¦‚æœå±æ€§åå‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡å‘½åå±æ€§
            if (newKey !== key) {
                await this.renameNestedProperty(variableId, key, newKey, path, value);
            } else {
                // ä¿å­˜åµŒå¥—å±æ€§
                await this.saveNestedPropertyEditToVariable(variableId, key, path, value);
            }

            // å…³é—­å¯¹è¯æ¡†
            dialog.remove();

            // é‡æ–°åŠ è½½å˜é‡åˆ—è¡¨
            this.renderVariableList();

            console.log('[VariableManager] âœ… ç¼–è¾‘åµŒå¥—å±æ€§:', newKey, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘å¤±è´¥:', error);
            alert('ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘å¤±è´¥: ' + error.message);
        }
    }

    /**
     * é‡å‘½ååµŒå¥—å±æ€§
     */
    async renameNestedProperty(variableId, oldKey, newKey, path, newValue) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // åˆ é™¤æ—§å±æ€§ï¼Œæ·»åŠ æ–°å±æ€§
            delete targetObject[oldKey];
            targetObject[newKey] = newValue;

            // ä¿å­˜åˆ°å˜é‡
            await this.saveVariableToSillyTavern(variableId, variable.value);

            console.log('[VariableManager] âœ… é‡å‘½ååµŒå¥—å±æ€§:', oldKey, 'â†’', newKey);
        } catch (error) {
            console.error('[VariableManager] âŒ é‡å‘½ååµŒå¥—å±æ€§å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘åˆ°å˜é‡
     */
    async saveNestedPropertyEditToVariable(variableId, key, path, value) {
        try {
            const variable = this.variables[variableId];
            if (!variable) {
                throw new Error('å˜é‡ä¸å­˜åœ¨');
            }

            // è·å–çˆ¶å¯¹è±¡è·¯å¾„
            const parentPath = this.getParentPath(path);
            const targetObject = this.getNestedValue(variable.value, parentPath);

            if (typeof targetObject !== 'object' || targetObject === null) {
                throw new Error('ç›®æ ‡ä¸æ˜¯å¯¹è±¡');
            }

            // è®¾ç½®æ–°å€¼
            targetObject[key] = value;

            // ä¿å­˜åˆ°SillyTavern
            await this.saveVariableToSillyTavern(variableId, variable.value, variable.type, true, variableId);

            console.log('[VariableManager] âœ… åµŒå¥—å±æ€§ç¼–è¾‘å·²ä¿å­˜:', variableId, path, key, value);
        } catch (error) {
            console.error('[VariableManager] âŒ ä¿å­˜åµŒå¥—å±æ€§ç¼–è¾‘åˆ°å˜é‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨
     */
    openStatusBarEditor() {
        try {
            console.log('[InfoBarSettings] ğŸ¨ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨...');

            // åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨æ¨¡æ€æ¡†
            this.createStatusBarEditorModal();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰“å¼€çŠ¶æ€æ ç¼–è¾‘å™¨å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    openHTMLTemplateEditor() {
        return this.openStatusBarEditor();
    }

    /**
     * åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨æ¨¡æ€æ¡†
     */
    createStatusBarEditorModal() {
        try {
            // ç§»é™¤ç°æœ‰çš„ç¼–è¾‘å™¨æ¨¡æ€æ¡†
            const existingModal = document.querySelector('.status-bar-editor-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            const modalHTML = this.createStatusBarEditorHTML();

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // ç»‘å®šäº‹ä»¶
            this.bindStatusBarEditorEvents();

            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ ç¼–è¾‘å™¨åˆ›å»ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨å¤±è´¥:', error);
            this.handleError(error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createHTMLTemplateEditorModal() {
        return this.createStatusBarEditorModal();
    }

    /**
     * è·å–ä¿¡æ¯æ ä¸»é¢˜é¢œè‰²
     */
    getInfoBarThemeColor(type) {
        try {
            // ä»SillyTavernæ‰©å±•è®¾ç½®è·å–å½“å‰ä¸»é¢˜
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            const configs = extensionSettings['Information bar integration tool'] || {};
            const themeConfig = configs.theme || {};
            const currentThemeId = themeConfig.current || 'default';

            console.log('[InfoBarSettings] ğŸ¨ è·å–ä¸»é¢˜é¢œè‰²:', { currentThemeId, type });

            // ä¿¡æ¯æ ä¸»é¢˜é¢œè‰²é…ç½®
            const themeColors = {
                default: {
                    background: '#1a1a1a',
                    surface: '#2a2a2a',
                    border: '#333',
                    text: '#fff',
                    textSecondary: '#888',
                    accent: '#007bff'
                },
                dark: {
                    background: '#0f0f0f',
                    surface: '#1a1a1a',
                    border: '#2a2a2a',
                    text: '#e0e0e0',
                    textSecondary: '#999',
                    accent: '#4CAF50'
                },
                blue: {
                    background: '#1a1a2e',
                    surface: '#16213e',
                    border: '#0f3460',
                    text: '#e6e6e6',
                    textSecondary: '#94a3b8',
                    accent: '#5eead4'
                },
                purple: {
                    background: '#2d1b69',
                    surface: '#3c2a78',
                    border: '#4a3586',
                    text: '#f0f0f0',
                    textSecondary: '#c4b5fd',
                    accent: '#8b5cf6'
                },
                green: {
                    background: '#0f2027',
                    surface: '#203a43',
                    border: '#2c5530',
                    text: '#e8f5e8',
                    textSecondary: '#a8d8a8',
                    accent: '#4ade80'
                },
                red: {
                    background: '#2d1b1b',
                    surface: '#3c2a2a',
                    border: '#4a3535',
                    text: '#f0e8e8',
                    textSecondary: '#d8a8a8',
                    accent: '#f87171'
                },
                'purple-night': {
                    background: '#1a1a1a',
                    surface: '#2a2a2a',
                    border: '#333',
                    text: '#fff',
                    textSecondary: '#888',
                    accent: '#007bff'
                }
            };

            const theme = themeColors[currentThemeId] || themeColors.default;
            const color = theme[type] || theme.background;

            console.log('[InfoBarSettings] ğŸ¨ è¿”å›é¢œè‰²:', { type, color });
            return color;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸»é¢˜é¢œè‰²å¤±è´¥:', error);
            // è¿”å›é»˜è®¤é¢œè‰²
            const defaults = {
                background: '#1a1a1a',
                surface: '#2a2a2a',
                border: '#333',
                text: '#fff',
                textSecondary: '#888',
                accent: '#007bff'
            };
            return defaults[type] || defaults.background;
        }
    }

    /**
     * åˆ›å»ºçŠ¶æ€æ ç¼–è¾‘å™¨HTML - å…¨æ–°å“åº”å¼è®¾è®¡
     */
    createStatusBarEditorHTML() {
        // é¢„å…ˆè·å–æ‰€æœ‰ä¸»é¢˜é¢œè‰²ï¼Œé¿å…åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­é‡å¤è°ƒç”¨
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="status-bar-editor-modal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            ">
                <div class="status-bar-editor-container" style="
                    width: 100%;
                    height: 100%;
                    max-width: 1600px;
                    max-height: 900px;
                    min-width: 800px;
                    min-height: 600px;
                    background: ${themeColors.background};
                    border-radius: 12px;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
                    border: 1px solid ${themeColors.border};
                    position: relative;
                ">
                    <!-- ç¼–è¾‘å™¨å¤´éƒ¨ - å“åº”å¼è®¾è®¡ -->
                    <div class="editor-header" style="
                        padding: 16px 24px;
                        background: ${themeColors.surface};
                        border-bottom: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                        min-height: 70px;
                    ">
                        <div class="editor-title" style="flex-grow: 1; min-width: 0;">
                            <h3 style="margin: 0; color: ${themeColors.text}; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-edit" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                çŠ¶æ€æ ç¼–è¾‘
                            </h3>
                            <p style="margin: 4px 0 0 0; color: ${themeColors.textSecondary}; font-size: 13px;">
                                æ™ºèƒ½åˆ›å»ºå’Œç¼–è¾‘è‡ªå®šä¹‰çŠ¶æ€æ æ ·å¼ï¼Œæ”¯æŒAIåˆ›ä½œå’Œå®æ—¶é¢„è§ˆ
                            </p>
                        </div>
                        <div class="editor-controls" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                            <button class="btn btn-secondary" data-action="close-status-bar-editor" style="
                                padding: 8px 12px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘å™¨ä¸»ä½“ - å¯è°ƒæ•´çš„å“åº”å¼å¸ƒå±€ -->
                    <div class="editor-body" style="
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        position: relative;
                        min-height: 0;
                    ">
                        <!-- å·¦ä¾§ç¼–è¾‘åŒº - è‡ªé€‚åº”å®½åº¦ -->
                        <div class="editor-left" style="
                            flex: 1;
                            min-width: 400px;
                            display: flex;
                            flex-direction: column;
                            border-right: 1px solid ${themeColors.border};
                            background: ${themeColors.background};
                        ">
                            <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
                            <div class="editor-toolbar" style="
                                display: flex;
                                align-items: center;
                                padding: 8px 16px;
                                background: ${themeColors.surface};
                                border-bottom: 1px solid ${themeColors.border};
                                gap: 12px;
                                flex-shrink: 0;
                            ">
                                <div class="editor-tabs" style="display: flex; gap: 4px;">
                                <button class="editor-tab active" data-tab="html" style="
                                        padding: 6px 12px;
                                        background: ${themeColors.accent};
                                    border: none;
                                        color: ${themeColors.background};
                                    cursor: pointer;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">ç¼–è¾‘å™¨</button>
                                <button class="editor-tab" data-tab="preview" style="
                                        padding: 6px 12px;
                                        background: transparent;
                                        border: 1px solid ${themeColors.border};
                                    color: ${themeColors.textSecondary};
                                    cursor: pointer;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        transition: all 0.2s ease;
                                    ">é¢„è§ˆ</button>
                            </div>
                                <div class="editor-tools" style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                                    <span class="editor-info" style="font-size: 11px; color: ${themeColors.textSecondary};">
                                        <i class="fas fa-info-circle"></i> è¡Œ: <span class="line-count">1</span>, åˆ—: <span class="col-count">1</span>
                                    </span>
                                    <button class="editor-tool-btn" data-action="toggle-wrap" style="
                                        padding: 4px 8px;
                                        background: transparent;
                                        border: 1px solid ${themeColors.border};
                                        color: ${themeColors.textSecondary};
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 11px;
                                    ">
                                        <i class="fas fa-text-width"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="editor-content" style="flex: 1; position: relative; overflow: hidden;">
                                <!-- ä»£ç ç¼–è¾‘å™¨ -->
                                <div class="code-editor-container" style="
                                    width: 100%;
                                    height: 100%;
                                    position: relative;
                                    background: ${themeColors.background};
                                ">
                                <textarea class="html-template-textarea" style="
                                    width: 100%;
                                    height: 100%;
                                    background: ${themeColors.background};
                                    color: ${themeColors.text};
                                    border: none;
                                    padding: 20px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        font-size: 13px;
                                        line-height: 1.6;
                                    resize: none;
                                    outline: none;
                                        box-sizing: border-box;
                                        tab-size: 2;
                                        white-space: pre;
                                        overflow-wrap: normal;
                                        word-break: normal;
                                " placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„HTMLæ¨¡æ¿ä»£ç ...

ğŸš€ å¿«é€Ÿå¼€å§‹ï¼š
<div class='status-card'>
    <div class='status-header'>
    <h3>{{data.name}}</h3>
        <span class='status-badge'>{{data.status}}</span>
    </div>
    <div class='status-content'>
        <div class='progress-bar'>
            <div class='progress-fill' style='width: {{computed.healthPercentage}}%'></div>
    </div>
    <p>ç”Ÿå‘½å€¼: {{data.health}}/{{data.maxHealth}}</p>
    </div>
</div>

ğŸ’¡ æç¤ºï¼šä½¿ç”¨å³ä¾§é¢æ¿æŸ¥çœ‹å¯ç”¨æ•°æ®å­—æ®µå’Œè¯­æ³•å¸®åŠ©"></textarea>

                                    <!-- è¯­æ³•é«˜äº®å±‚ -->
                                    <div class="syntax-highlight-layer" style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        pointer-events: none;
                                        z-index: 1;
                                        background: transparent;
                                        padding: 20px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        font-size: 13px;
                                        line-height: 1.6;
                                        box-sizing: border-box;
                                        overflow: hidden;
                                        white-space: pre;
                                        color: transparent;
                                    "></div>
                                </div>

                                <!-- é¢„è§ˆå®¹å™¨ -->
                                <div class="preview-container" style="
                                    width: 100%;
                                    height: 100%;
                                    background: ${themeColors.background};
                                    padding: 20px;
                                    overflow: auto;
                                    display: none;
                                    box-sizing: border-box;
                                    border: 1px solid ${themeColors.border};
                                    border-radius: 8px;
                                    margin: 10px;
                                    width: calc(100% - 20px);
                                    height: calc(100% - 20px);
                                ">
                                    <div class="preview-content"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å¯è°ƒæ•´åˆ†éš”æ¡ -->
                        <div class="editor-resizer" style="
                            width: 4px;
                            background: ${themeColors.border};
                            cursor: col-resize;
                            position: relative;
                            transition: background 0.2s ease;
                            flex-shrink: 0;
                        "
                        onmouseover="this.style.background='${themeColors.accent}'"
                        onmouseout="this.style.background='${themeColors.border}'">
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                width: 2px;
                                height: 30px;
                                background: ${themeColors.textSecondary};
                                border-radius: 1px;
                            "></div>
                        </div>

                        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ - è‡ªé€‚åº”å®½åº¦ -->
                        <div class="editor-right" style="
                            width: 420px;
                            min-width: 300px;
                            max-width: 600px;
                            background: ${themeColors.surface};
                            display: flex;
                            flex-direction: column;
                            border-left: 1px solid ${themeColors.border};
                        ">
                            <!-- çŠ¶æ€æ åˆ›ä½œä¸­å¿ƒ -->
                            <div class="status-bar-creation-center" style="
                                display: flex;
                                background: ${themeColors.background};
                                border-bottom: 1px solid ${themeColors.border};
                                padding: 12px 16px;
                                align-items: center;
                                gap: 12px;
                                flex-shrink: 0;
                            ">
                                <div class="creation-center-title" style="
                                    color: ${themeColors.text};
                                    font-size: 14px;
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-magic" style="color: ${themeColors.accent};"></i>
                                    çŠ¶æ€æ åˆ›ä½œä¸­å¿ƒ
                                </div>
                                <div class="creation-actions" style="
                                    display: flex;
                                    gap: 8px;
                                    margin-left: auto;
                                ">

                                    <button class="btn btn-sm btn-outline-secondary data-info-btn" data-action="show-data-info" style="
                                        padding: 6px 12px;
                                        font-size: 12px;
                                        border: 1px solid ${themeColors.border};
                                        background: transparent;
                                        color: ${themeColors.textSecondary};
                                        border-radius: 6px;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='${themeColors.border}'; this.style.color='${themeColors.text}'"
                                       onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                        <i class="fas fa-info-circle"></i> æ•°æ®ä¿¡æ¯
                                    </button>
                                </div>
                            </div>
                            <div class="info-content" style="
                                flex: 1;
                                padding: 16px;
                                overflow-y: auto;
                                color: ${themeColors.text};
                                font-size: 12px;
                                line-height: 1.5;
                                min-height: 0;
                            ">
                                ${this.createStatusBarPromptEditor()}
                            </div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘å™¨åº•éƒ¨çŠ¶æ€æ  - å“åº”å¼è®¾è®¡ -->
                    <div class="editor-footer" style="
                        padding: 12px 24px;
                        background: ${themeColors.surface};
                        border-top: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                        min-height: 50px;
                        gap: 16px;
                    ">
                        <div class="editor-status" style="display: flex; align-items: center; gap: 16px; flex-grow: 1;">
                            <span class="status-indicator" style="
                                display: flex;
                                align-items: center;
                                gap: 6px;
                                color: ${themeColors.textSecondary};
                                font-size: 11px;
                            ">
                                <i class="fas fa-circle" style="color: #4CAF50; font-size: 8px;"></i>
                                å°±ç»ª
                            </span>
                            <span class="template-size" style="color: ${themeColors.textSecondary}; font-size: 11px;">
                                å¤§å°: <span class="size-value">0</span> å­—ç¬¦
                            </span>
                            <span class="validation-status" style="color: ${themeColors.textSecondary}; font-size: 11px;">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i> è¯­æ³•æ­£ç¡®
                            </span>
                        </div>
                        <div class="editor-actions" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-outline-secondary" data-action="load-template" style="
                                padding: 6px 12px;
                                font-size: 11px;
                                border: 1px solid ${themeColors.border};
                                background: transparent;
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-folder-open"></i> åŠ è½½
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-action="save-template" style="
                                padding: 6px 12px;
                                font-size: 11px;
                                border: 1px solid ${themeColors.border};
                                background: transparent;
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-save"></i> ä¿å­˜
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="apply-template" style="
                                padding: 6px 16px;
                                font-size: 11px;
                                background: ${themeColors.accent};
                                color: ${themeColors.background};
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: 500;
                                box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
                                transition: all 0.2s ease;
                            ">
                                <i class="fas fa-check"></i> åº”ç”¨æ¨¡æ¿
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ åˆ›å»ºçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨
     */
    createStatusBarPromptEditor() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="status-bar-prompt-editor">
                <!-- AIæç¤ºè¯ç¼–è¾‘åŒºåŸŸ -->
                <div class="prompt-editor-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                ">
                    <h4 style="margin: 0 0 12px 0; color: ${themeColors.accent}; font-size: 14px; font-weight: 600;">
                        <i class="fas fa-robot"></i> AIåˆ›ä½œæç¤ºè¯
                    </h4>
                    <textarea class="prompt-textarea" placeholder="æè¿°æ‚¨æƒ³è¦çš„çŠ¶æ€æ æ ·å¼ï¼Œä¾‹å¦‚ï¼š
â€¢ ç²‰è‰²ä¸»é¢˜è§’è‰²å¡ç‰‡ï¼Œæ˜¾ç¤ºå¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
â€¢ ç®€çº¦ç‰©å“æ ï¼Œç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºé“å…·
â€¢ æŠ€èƒ½é¢æ¿å¸¦è¿›åº¦æ¡å’Œç­‰çº§æ˜¾ç¤º
â€¢ ç°ä»£åŒ–è®¾è®¡ï¼Œæ¸å˜èƒŒæ™¯åœ†è§’å¡ç‰‡
â€¢ å…¶ä»–åˆ›æ„éœ€æ±‚..." style="
                        width: 100%;
                        height: 120px;
                        background: ${themeColors.surface};
                        color: ${themeColors.text};
                        border: 1px solid ${themeColors.border};
                        border-radius: 6px;
                        padding: 12px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        font-size: 13px;
                        line-height: 1.5;
                        resize: vertical;
                        box-sizing: border-box;
                    "></textarea>
                    <div class="prompt-actions" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 12px;
                    ">
                        <div class="prompt-templates" style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="prompt-template-btn" data-template="character" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                è§’è‰²å¡ç‰‡
                            </button>
                            <button class="prompt-template-btn" data-template="inventory" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç‰©å“æ 
                            </button>
                            <button class="prompt-template-btn" data-template="stats" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                å±æ€§é¢æ¿
                            </button>
                            <button class="prompt-template-btn" data-template="modern" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç°ä»£é£æ ¼
                            </button>
                            <button class="prompt-template-btn" data-template="minimal" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid ${themeColors.border};
                                color: ${themeColors.textSecondary};
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                               onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                                ç®€çº¦é£æ ¼
                            </button>
                        </div>
                        <button class="use-prompt-btn" data-action="use-custom-prompt" style="
                            padding: 6px 12px;
                            background: ${themeColors.accent};
                            color: ${themeColors.background};
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 500;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <i class="fas fa-robot"></i> AIç”Ÿæˆ
                        </button>
                    </div>
                </div>

                <!-- æ•°æ®å­—æ®µå‚è€ƒ -->
                <div class="data-reference-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 8px;
                    padding: 16px;
                ">
                    <h4 style="margin: 0 0 12px 0; color: ${themeColors.accent}; font-size: 14px; font-weight: 600;">
                        <i class="fas fa-database"></i> å¯ç”¨æ•°æ®å­—æ®µ
                    </h4>
                    <div class="data-fields-list" style="
                        max-height: 200px;
                        overflow-y: auto;
                        border: 1px solid ${themeColors.border};
                        border-radius: 6px;
                        padding: 2px;
                        background: ${themeColors.surface};
                    ">
                        <div class="loading-fields" style="
                            text-align: center;
                            padding: 20px;
                            color: ${themeColors.textSecondary};
                        ">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½æ•°æ®å­—æ®µ...
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createAdvancedDataSourceInfo() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="advanced-data-source-info">
                <!-- å¿«é€Ÿæ’å…¥åŒºåŸŸ -->
                <div class="quick-insert-section" style="
                    background: ${themeColors.background};
                    border: 1px solid ${themeColors.border};
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 16px;
                ">
                    <h4 style="margin: 0 0 8px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-bolt"></i> å¿«é€Ÿæ’å…¥
                </h4>
                    <div class="quick-insert-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button class="quick-insert-btn" data-insert="{{data.name}}" style="
                            padding: 4px 8px; background: transparent; border: 1px solid ${themeColors.border};
                            color: ${themeColors.text}; border-radius: 3px; cursor: pointer; font-size: 10px;
                        ">å§“å</button>
                        <button class="quick-insert-btn" data-insert="{{data.health}}" style="
                            padding: 4px 8px; background: transparent; border: 1px solid ${themeColors.border};
                            color: ${themeColors.text}; border-radius: 3px; cursor: pointer; font-size: 10px;
                        ">ç”Ÿå‘½å€¼</button>
                    </div>
                </div>

                <!-- å½“å‰å¯ç”¨é¢æ¿ -->
                <div class="enabled-panels-section">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-database"></i> å½“å‰å¯ç”¨çš„æ•°æ®é¢æ¿
                </h4>
                    <div class="enabled-panels-list" id="enabled-panels-list" style="
                        background: ${themeColors.background}; border: 1px solid ${themeColors.border};
                        border-radius: 4px; padding: 10px; margin-bottom: 16px; min-height: 80px;
                        max-height: 120px; overflow-y: auto;
                    ">
                        <div style="color: ${themeColors.textSecondary}; font-size: 11px;">æ­£åœ¨åŠ è½½æ•°æ®é¢æ¿...</div>
                    </div>
                </div>

                <!-- å¯ç”¨æ•°æ®å­—æ®µ -->
                <div class="available-fields-section">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-tags"></i> å¯ç”¨æ•°æ®å­—æ®µ
                </h4>
                    <div class="available-fields-list" id="available-fields-list" style="
                        background: ${themeColors.background}; border: 1px solid ${themeColors.border};
                        border-radius: 4px; padding: 8px; min-height: 120px; max-height: 200px;
                        overflow-y: auto; font-size: 11px;
                    ">
                        <div style="color: ${themeColors.textSecondary}; font-size: 11px;">æ­£åœ¨åŠ è½½å­—æ®µåˆ—è¡¨...</div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ç»‘å®šçŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶ - å…¨æ–°å“åº”å¼ç‰ˆæœ¬
     */
    bindStatusBarEditorEvents() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            // å…³é—­ç¼–è¾‘å™¨
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('[data-action="close-status-bar-editor"]')) {
                    console.log('[InfoBarSettings] ğŸ”’ å…³é—­çŠ¶æ€æ ç¼–è¾‘å™¨');
                    modal.remove();
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
            const closeBtn = modal.querySelector('[data-action="close-status-bar-editor"]');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[InfoBarSettings] ğŸ”’ å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
                    modal.remove();
                });
            }

            // é˜»æ­¢ç‚¹å‡»ç¼–è¾‘å™¨å®¹å™¨æ—¶å…³é—­æ¨¡æ€æ¡†
            modal.querySelector('.status-bar-editor-container')?.addEventListener('click', (e) => {
                e.stopPropagation();
            });



            // æ ‡ç­¾é¡µåˆ‡æ¢ - ç¼–è¾‘å™¨æ ‡ç­¾
            modal.querySelectorAll('.editor-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    this.switchEditorTab(tab.dataset.tab);
                });
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢ - ä¿¡æ¯é¢æ¿æ ‡ç­¾
            modal.querySelectorAll('.info-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    this.switchInfoTab(tab.dataset.infoTab);
                });
            });

            // ğŸš€ æ–°å¢ï¼šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶
            this.bindPromptEditorEvents(modal);





            // ğŸš€ æ–°å¢ï¼šæ˜¾ç¤ºæ•°æ®ä¿¡æ¯
            modal.querySelector('[data-action="show-data-info"]')?.addEventListener('click', () => {
                this.showDataInfoPanel();
            });

            // å…¶ä»–æŒ‰é’®äº‹ä»¶
            modal.querySelector('[data-action="load-template"]')?.addEventListener('click', () => {
                this.loadHTMLTemplate();
            });

            modal.querySelector('[data-action="save-template"]')?.addEventListener('click', () => {
                this.saveHTMLTemplate();
            });

            modal.querySelector('[data-action="apply-template"]')?.addEventListener('click', () => {
                this.applyHTMLTemplate();
            });

            // ğŸš€ æ–°å¢ï¼šç¼–è¾‘å™¨å·¥å…·æŒ‰é’®
            modal.querySelector('[data-action="toggle-wrap"]')?.addEventListener('click', () => {
                this.toggleWordWrap();
            });

            // å®æ—¶é¢„è§ˆå’Œè¯­æ³•æ£€æŸ¥
            const textarea = modal.querySelector('.html-template-textarea');
            if (textarea) {
                // è¾“å…¥äº‹ä»¶ - å®æ—¶é¢„è§ˆ
                textarea.addEventListener('input', () => {
                    this.updateTemplatePreview();
                    this.updateEditorStatus();
                    this.validateTemplateSyntax();
                });

                // ğŸš€ æ–°å¢ï¼šå…‰æ ‡ä½ç½®è·Ÿè¸ª
                textarea.addEventListener('selectionchange', () => {
                    this.updateCursorPosition();
                });

                textarea.addEventListener('keyup', () => {
                    this.updateCursorPosition();
                });

                textarea.addEventListener('click', () => {
                    this.updateCursorPosition();
                });

                // ğŸš€ æ–°å¢ï¼šé”®ç›˜å¿«æ·é”®
                textarea.addEventListener('keydown', (e) => {
                    this.handleEditorKeydown(e);
                });
            }

            // ğŸš€ æ–°å¢ï¼šå¯è°ƒæ•´åˆ†éš”æ¡æ‹–æ‹½åŠŸèƒ½
            this.initEditorResizer(modal);

            // ğŸš€ æ–°å¢ï¼šçª—å£å¤§å°å˜åŒ–æ—¶çš„å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                this.adjustEditorLayout();
            });

            // åŠ è½½æ•°æ®ä¿¡æ¯
            this.loadAdvancedDataInfo();

            // è‡ªåŠ¨åŠ è½½HTMLæ¨¡æ¿
            this.loadHTMLTemplate();

            // ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–è¯­æ³•é«˜äº®
            this.initSyntaxHighlight();

            // ğŸš€ æ–°å¢ï¼šåŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨
            this.loadDataFieldsToPromptEditor();

            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®šå®Œæˆ (å“åº”å¼ç‰ˆæœ¬)');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šçŠ¶æ€æ ç¼–è¾‘å™¨äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    bindHTMLTemplateEditorEvents() {
        return this.bindStatusBarEditorEvents();
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–å¯è°ƒæ•´åˆ†éš”æ¡
     */
    initEditorResizer(modal) {
        try {
            const resizer = modal.querySelector('.editor-resizer');
            const leftPanel = modal.querySelector('.editor-left');
            const rightPanel = modal.querySelector('.editor-right');

            if (!resizer || !leftPanel || !rightPanel) return;

            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startLeftWidth = leftPanel.offsetWidth;
                startRightWidth = rightPanel.offsetWidth;

                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const containerWidth = leftPanel.parentElement.offsetWidth;
                const newLeftWidth = startLeftWidth + deltaX;
                const newRightWidth = startRightWidth - deltaX;

                // é™åˆ¶æœ€å°å®½åº¦
                if (newLeftWidth >= 300 && newRightWidth >= 250) {
                    leftPanel.style.flex = 'none';
                    leftPanel.style.width = `${newLeftWidth}px`;
                    rightPanel.style.width = `${newRightWidth}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                }
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–åˆ†éš”æ¡å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ’å…¥æ¨¡æ¿æ–‡æœ¬
     */
    insertTemplateText(text) {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentValue = textarea.value;

            const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
            textarea.value = newValue;

            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥æ–‡æœ¬ä¹‹å
            const newCursorPos = start + text.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();

            // è§¦å‘æ›´æ–°äº‹ä»¶
            this.updateTemplatePreview();
            this.updateEditorStatus();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ’å…¥æ¨¡æ¿æ–‡æœ¬å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ ¼å¼åŒ–æ¨¡æ¿
     */
    formatTemplate() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const code = textarea.value;
            if (!code.trim()) return;

            // ç®€å•çš„HTMLæ ¼å¼åŒ–
            const formatted = this.formatHTML(code);
            textarea.value = formatted;

            // è§¦å‘æ›´æ–°
            this.updateTemplatePreview();
            this.updateEditorStatus();

            console.log('[InfoBarSettings] âœ… æ¨¡æ¿æ ¼å¼åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ ¼å¼åŒ–æ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šHTMLæ ¼å¼åŒ–
     */
    formatHTML(html) {
        try {
            let formatted = html;
            let indent = 0;
            const indentSize = 2;

            // ç§»é™¤å¤šä½™çš„ç©ºç™½
            formatted = formatted.replace(/\s+/g, ' ').trim();

            // æ·»åŠ æ¢è¡Œå’Œç¼©è¿›
            formatted = formatted.replace(/</g, '\n<');
            formatted = formatted.replace(/>/g, '>\n');

            const lines = formatted.split('\n').filter(line => line.trim());
            const result = [];

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // å‡å°‘ç¼©è¿›ï¼ˆé—­åˆæ ‡ç­¾ï¼‰
                if (trimmed.startsWith('</')) {
                    indent = Math.max(0, indent - indentSize);
                }

                // æ·»åŠ ç¼©è¿›
                result.push(' '.repeat(indent) + trimmed);

                // å¢åŠ ç¼©è¿›ï¼ˆå¼€æ”¾æ ‡ç­¾ï¼‰
                if (trimmed.startsWith('<') && !trimmed.startsWith('</') && !trimmed.endsWith('/>')) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªé—­åˆæ ‡ç­¾
                    const tagName = trimmed.match(/<([^>\s]+)/)?.[1];
                    const selfClosingTags = ['input', 'img', 'br', 'hr', 'meta', 'link'];
                    if (!selfClosingTags.includes(tagName)) {
                        indent += indentSize;
                    }
                }
            }

            return result.join('\n');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ HTMLæ ¼å¼åŒ–å¤±è´¥:', error);
            return html;
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ›´æ–°å…‰æ ‡ä½ç½®æ˜¾ç¤º
     */
    updateCursorPosition() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const lineCount = document.querySelector('.line-count');
            const colCount = document.querySelector('.col-count');

            if (!textarea || !lineCount || !colCount) return;

            const text = textarea.value.substring(0, textarea.selectionStart);
            const lines = text.split('\n');
            const currentLine = lines.length;
            const currentCol = lines[lines.length - 1].length + 1;

            lineCount.textContent = currentLine;
            colCount.textContent = currentCol;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°å…‰æ ‡ä½ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€
     */
    updateEditorStatus() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const sizeValue = document.querySelector('.size-value');

            if (!textarea || !sizeValue) return;

            const charCount = textarea.value.length;
            sizeValue.textContent = charCount.toLocaleString();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šéªŒè¯æ¨¡æ¿è¯­æ³•
     */
    validateTemplateSyntax() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            const validationStatus = document.querySelector('.validation-status');

            if (!textarea || !validationStatus) return;

            const template = textarea.value;
            const errors = this.checkTemplateSyntax(template);

            if (errors.length === 0) {
                validationStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i> è¯­æ³•æ­£ç¡®';
            } else {
                validationStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #FF5722;"></i> ${errors.length} ä¸ªé”™è¯¯`;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ éªŒè¯æ¨¡æ¿è¯­æ³•å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥æ¨¡æ¿è¯­æ³•
     */
    checkTemplateSyntax(template) {
        const errors = [];

        try {
            // æ£€æŸ¥HTMLæ ‡ç­¾åŒ¹é…
            const htmlErrors = this.checkHTMLSyntax(template);
            errors.push(...htmlErrors);

            // æ£€æŸ¥æ¨¡æ¿è¯­æ³•
            const templateErrors = this.checkTemplateBindingSyntax(template);
            errors.push(...templateErrors);

        } catch (error) {
            errors.push('è¯­æ³•æ£€æŸ¥å™¨å†…éƒ¨é”™è¯¯');
        }

        return errors;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥HTMLè¯­æ³•
     */
    checkHTMLSyntax(html) {
        const errors = [];

        try {
            // ç®€å•çš„æ ‡ç­¾åŒ¹é…æ£€æŸ¥
            const openTags = [];
            const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/g;
            let match;

            while ((match = tagRegex.exec(html)) !== null) {
                const tag = match[1].toLowerCase();
                const isClosing = match[0].startsWith('</');
                const isSelfClosing = match[0].endsWith('/>');

                if (isSelfClosing) continue;

                if (isClosing) {
                    const lastOpen = openTags.pop();
                    if (!lastOpen || lastOpen !== tag) {
                        errors.push(`æ ‡ç­¾ä¸åŒ¹é…: </${tag}>`);
                    }
                } else {
                    // è‡ªé—­åˆæ ‡ç­¾ä¸éœ€è¦åŒ¹é…
                    const selfClosingTags = ['input', 'img', 'br', 'hr', 'meta', 'link'];
                    if (!selfClosingTags.includes(tag)) {
                        openTags.push(tag);
                    }
                }
            }

            // æ£€æŸ¥æœªé—­åˆçš„æ ‡ç­¾
            openTags.forEach(tag => {
                errors.push(`æœªé—­åˆçš„æ ‡ç­¾: <${tag}>`);
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ HTMLè¯­æ³•æ£€æŸ¥å¤±è´¥:', error);
        }

        return errors;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šæ£€æŸ¥æ¨¡æ¿ç»‘å®šè¯­æ³•
     */
    checkTemplateBindingSyntax(template) {
        const errors = [];

        try {
            // æ£€æŸ¥æœªé—­åˆçš„æ¨¡æ¿æ ‡ç­¾
            const openPatterns = [
                { regex: /\{\{#if\s+[^}]+\}\}/g, close: '{{/if}}', name: 'if' },
                { regex: /\{\{#each\s+[^}]+\}\}/g, close: '{{/each}}', name: 'each' }
            ];

            for (const pattern of openPatterns) {
                const opens = [...template.matchAll(pattern.regex)];
                const closes = [...template.matchAll(new RegExp(pattern.close.replace(/[{}]/g, '\\$&'), 'g'))];

                if (opens.length !== closes.length) {
                    errors.push(`${pattern.name} æ ‡ç­¾æ•°é‡ä¸åŒ¹é…`);
                }
            }

            // æ£€æŸ¥æ— æ•ˆçš„ç»‘å®šè¯­æ³•
            const invalidBindings = template.match(/\{\{[^}]*\{\{|\}\}[^{]*\}\}/g);
            if (invalidBindings) {
                errors.push('æ£€æµ‹åˆ°æ— æ•ˆçš„ç»‘å®šè¯­æ³•');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ¿ç»‘å®šè¯­æ³•æ£€æŸ¥å¤±è´¥:', error);
        }

        return errors;
    }

    /**
     * åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾é¡µ - æ›´æ–°ç‰ˆæœ¬
     */
    switchEditorTab(tabName) {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const themeColors = {
                background: this.getInfoBarThemeColor('background'),
                accent: this.getInfoBarThemeColor('accent'),
                textSecondary: this.getInfoBarThemeColor('textSecondary')
            };

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            modal.querySelectorAll('.editor-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.background = themeColors.accent;
                    tab.style.color = themeColors.background;
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'transparent';
                    tab.style.color = themeColors.textSecondary;
                    tab.style.border = '1px solid ' + this.getInfoBarThemeColor('border');
                }
            });

            // åˆ‡æ¢å†…å®¹
            const codeEditor = modal.querySelector('.code-editor-container');
            const preview = modal.querySelector('.preview-container');

            if (tabName === 'html') {
                if (codeEditor) codeEditor.style.display = 'block';
                if (preview) preview.style.display = 'none';
            } else if (tabName === 'preview') {
                if (codeEditor) codeEditor.style.display = 'none';
                if (preview) preview.style.display = 'block';
                this.updateTemplatePreview();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾é¡µå¤±è´¥:', error);
        }
    }

    /**
     * åˆ‡æ¢ä¿¡æ¯æ ‡ç­¾é¡µ
     */
    switchInfoTab(tabName) {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            modal.querySelectorAll('.info-tab').forEach(tab => {
                if (tab.dataset.infoTab === tabName) {
                    tab.classList.add('active');
                    tab.style.color = 'var(--SmartThemeBodyColor, #fff)';
                    tab.style.borderBottomColor = 'var(--SmartThemeQuoteColor, #007bff)';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = 'var(--SmartThemeQuoteColor, #888)';
                    tab.style.borderBottomColor = 'transparent';
                }
            });

            // æ›´æ–°å†…å®¹
            const infoContent = modal.querySelector('.info-content');
            if (infoContent) {
                switch (tabName) {
                    case 'data-source':
                        infoContent.innerHTML = this.createAdvancedDataSourceInfo();
                        this.loadAdvancedDataInfo();
                        break;
                    case 'syntax-help':
                        infoContent.innerHTML = this.createSyntaxHelpInfo();
                        this.bindSyntaxHelpEvents();
                        break;
                    case 'templates':
                        infoContent.innerHTML = this.createTemplateLibraryInfo();
                        this.loadTemplateLibrary();
                        break;
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢ä¿¡æ¯æ ‡ç­¾é¡µå¤±è´¥:', error);
        }
    }

    /**
     * åˆ›å»ºè¯­æ³•å¸®åŠ©ä¿¡æ¯
     */
    createSyntaxHelpInfo() {
        return `
            <div class="syntax-help-info">
                <h4 style="margin: 0 0 10px 0; color: var(--SmartThemeQuoteColor, #007bff);">
                    <i class="fas fa-book"></i> æ¨¡æ¿è¯­æ³•è¯´æ˜
                </h4>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">æ•°æ®ç»‘å®š</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px;">{{data.fieldName}}</code>
                    <p style="margin: 5px 0; font-size: 12px;">ç»‘å®šæ•°æ®å­—æ®µï¼Œå¦‚ {{data.name}}ã€{{data.health}}</p>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">è®¡ç®—å­—æ®µ</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px;">{{computed.fieldName}}</code>
                    <p style="margin: 5px 0; font-size: 12px;">ä½¿ç”¨è®¡ç®—å­—æ®µï¼Œå¦‚ {{computed.healthPercentage}}</p>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">æ¡ä»¶æ¸²æŸ“</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px; display: block; margin: 5px 0;">
                        {{#if data.health > 50}}<br>
                        &nbsp;&nbsp;å¥åº·çŠ¶æ€è‰¯å¥½<br>
                        {{/if}}
                    </code>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">å¾ªç¯æ¸²æŸ“</h5>
                    <code style="background: var(--SmartThemeBodyColor, #333); padding: 2px 5px; border-radius: 3px; display: block; margin: 5px 0;">
                        {{#each data.items}}<br>
                        &nbsp;&nbsp;&lt;div&gt;{{this.name}}&lt;/div&gt;<br>
                        {{/each}}
                    </code>
                </div>

                <div class="syntax-section">
                    <h5 style="color: var(--SmartThemeBodyColor, #fff); margin: 15px 0 5px 0;">å¸¸ç”¨è®¡ç®—å­—æ®µ</h5>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                        <li>{{computed.healthPercentage}} - ç”Ÿå‘½å€¼ç™¾åˆ†æ¯”</li>
                        <li>{{computed.timestamp}} - å½“å‰æ—¶é—´æˆ³</li>
                    </ul>
                </div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºæ¨¡æ¿åº“ä¿¡æ¯
     */
    createTemplateLibraryInfo() {
        return `
            <div class="template-library-info">
                <h4 style="margin: 0 0 10px 0; color: var(--SmartThemeQuoteColor, #007bff);">
                    <i class="fas fa-layer-group"></i> æ¨¡æ¿åº“
                </h4>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="character-card">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">è§’è‰²å¡ç‰‡</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">æ˜¾ç¤ºè§’è‰²åŸºæœ¬ä¿¡æ¯å’ŒçŠ¶æ€</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="status-bar">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">çŠ¶æ€æ </h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">ç®€æ´çš„ç”Ÿå‘½å€¼å’ŒçŠ¶æ€æ˜¾ç¤º</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="inventory-grid">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">ç‰©å“ç½‘æ ¼</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">ç½‘æ ¼å¼ç‰©å“å±•ç¤ºç•Œé¢</p>
                </div>

                <div class="template-item" style="margin: 10px 0; padding: 10px; background: var(--SmartThemeBodyColor, #333); border-radius: 5px; cursor: pointer;" data-template="rpg-dashboard">
                    <h6 style="margin: 0 0 5px 0; color: var(--SmartThemeBodyColor, #fff);">RPGä»ªè¡¨æ¿</h6>
                    <p style="margin: 0; font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">å®Œæ•´çš„RPGæ¸¸æˆç•Œé¢</p>
                </div>

                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" data-action="import-template">
                    <i class="fas fa-upload"></i> å¯¼å…¥è‡ªå®šä¹‰æ¨¡æ¿
                </button>
            </div>
        `;
    }

    /**
     * æ›´æ–°æ¨¡æ¿é¢„è§ˆ
     */
    updateTemplatePreview() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const textarea = modal.querySelector('.html-template-textarea');
            const preview = modal.querySelector('.preview-container');

            if (!textarea || !preview) return;

            const template = textarea.value;

            // è·å–ç¤ºä¾‹æ•°æ®
            const sampleData = this.getSampleData();

            // ä½¿ç”¨HTMLæ¨¡æ¿è§£æå™¨æ¸²æŸ“é¢„è§ˆ
            const infoBarTool = window.SillyTavernInfobar?.modules?.infoBarTool;
            if (infoBarTool && infoBarTool.htmlTemplateParser) {
                const renderedHTML = infoBarTool.htmlTemplateParser.parseTemplate(template, sampleData);
                preview.innerHTML = renderedHTML;
            } else {
                // ç®€å•çš„é¢„è§ˆæ¸²æŸ“
                preview.innerHTML = this.simpleTemplateRender(template, sampleData);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°æ¨¡æ¿é¢„è§ˆå¤±è´¥:', error);
            const preview = document.querySelector('.status-bar-editor-modal .preview-container');
            if (preview) {
                preview.innerHTML = `<div style="color: red; padding: 10px;">é¢„è§ˆé”™è¯¯: ${error.message}</div>`;
            }
        }
    }

    /**
     * è·å–ç¤ºä¾‹æ•°æ®
     */
    getSampleData() {
        return {
            data: {
                name: 'å½±ä¹‹åˆƒ',
                health: 1240,
                maxHealth: 1580,
                energy: 320,
                maxEnergy: 450,
                level: 42,
                class: 'æš—å½±åˆºå®¢',
                location: 'æš—å½±æ£®æ—',
                mood: 'è­¦è§‰',
                items: [
                    { name: 'æš—å½±ä¹‹ç‰™', type: 'æ­¦å™¨', quantity: 1 },
                    { name: 'æ²»ç–—è¯æ°´', type: 'æ¶ˆè€—å“', quantity: 8 },
                    { name: 'å›åŸå·è½´', type: 'é“å…·', quantity: 3 }
                ]
            },
            computed: {
                healthPercentage: 78,
                energyPercentage: 71,
                timestamp: new Date().toLocaleString()
            }
        };
    }

    /**
     * ğŸš€ å¢å¼ºçš„æ¨¡æ¿æ¸²æŸ“ - æ”¯æŒå¤æ‚æ•°æ®è·¯å¾„å’ŒCSSæ ·å¼
     */
    simpleTemplateRender(template, data) {
        try {
            let result = template;

            // ğŸ”§ ä¿®å¤ï¼šæ”¯æŒå¤æ‚çš„æ•°æ®è·¯å¾„ï¼Œå¦‚ {{data.personal.name}}
            result = result.replace(/\{\{data\.([^}]+)\}\}/g, (match, path) => {
                try {
                    const keys = path.split('.');
                    let value = data.data;

                    for (const key of keys) {
                        if (value && typeof value === 'object' && key in value) {
                            value = value[key];
                        } else {
                            return ''; // å¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
                        }
                    }

                    return String(value || '');
                } catch (e) {
                    console.warn('[InfoBarSettings] æ•°æ®è·¯å¾„è§£æå¤±è´¥:', path, e);
                    return '';
                }
            });

            // å¤„ç†è®¡ç®—å­—æ®µ
            result = result.replace(/\{\{computed\.([^}]+)\}\}/g, (match, field) => {
                try {
                    const keys = field.split('.');
                    let value = data.computed;

                    for (const key of keys) {
                        if (value && typeof value === 'object' && key in value) {
                            value = value[key];
                        } else {
                            return '';
                        }
                    }

                    return String(value || '');
                } catch (e) {
                    console.warn('[InfoBarSettings] è®¡ç®—å­—æ®µè§£æå¤±è´¥:', field, e);
                    return '';
                }
            });

            // ğŸš€ æ–°å¢ï¼šå¤„ç†æ¡ä»¶æ¸²æŸ“ {{#if condition}}...{{/if}}
            result = result.replace(/\{\{#if\s+([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, content) => {
                try {
                    // ç®€å•çš„æ¡ä»¶åˆ¤æ–­
                    let conditionValue = false;

                    if (condition.startsWith('data.')) {
                        const path = condition.substring(5).split('.');
                        let value = data.data;
                        for (const key of path) {
                            if (value && typeof value === 'object' && key in value) {
                                value = value[key];
                            } else {
                                value = null;
                                break;
                            }
                        }
                        conditionValue = Boolean(value);
                    }

                    return conditionValue ? content : '';
                } catch (e) {
                    console.warn('[InfoBarSettings] æ¡ä»¶æ¸²æŸ“è§£æå¤±è´¥:', condition, e);
                    return '';
                }
            });

            // ğŸš€ æ–°å¢ï¼šå¤„ç†å¾ªç¯æ¸²æŸ“ {{#each array}}...{{/each}}
            result = result.replace(/\{\{#each\s+([^}]+)\}\}([\s\S]*?)\{\{\/each\}\}/g, (match, arrayPath, itemTemplate) => {
                try {
                    let arrayValue = [];

                    if (arrayPath.startsWith('data.')) {
                        const path = arrayPath.substring(5).split('.');
                        let value = data.data;
                        for (const key of path) {
                            if (value && typeof value === 'object' && key in value) {
                                value = value[key];
                            } else {
                                value = null;
                                break;
                            }
                        }
                        if (Array.isArray(value)) {
                            arrayValue = value;
                        }
                    }

                    return arrayValue.map((item, index) => {
                        let itemHtml = itemTemplate;
                        // æ›¿æ¢ {{this}} ä¸ºå½“å‰é¡¹
                        itemHtml = itemHtml.replace(/\{\{this\}\}/g, String(item || ''));
                        // æ›¿æ¢ {{@index}} ä¸ºç´¢å¼•
                        itemHtml = itemHtml.replace(/\{\{@index\}\}/g, String(index));
                        return itemHtml;
                    }).join('');
                } catch (e) {
                    console.warn('[InfoBarSettings] å¾ªç¯æ¸²æŸ“è§£æå¤±è´¥:', arrayPath, e);
                    return '';
                }
            });

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿CSSæ ·å¼æ­£ç¡®ä¿ç•™
            // ç§»é™¤å¯èƒ½ç ´åCSSçš„è½¬ä¹‰
            result = result.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');

            console.log('[InfoBarSettings] âœ… æ¨¡æ¿æ¸²æŸ“å®Œæˆï¼Œç»“æœé•¿åº¦:', result.length);
            return result;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ¨¡æ¿æ¸²æŸ“å¤±è´¥:', error);
            return `<div style="color: red; padding: 10px; border: 1px solid red; border-radius: 4px; background: #ffe6e6;">
                <strong>æ¸²æŸ“é”™è¯¯:</strong> ${error.message}
                <br><small>è¯·æ£€æŸ¥æ¨¡æ¿è¯­æ³•æ˜¯å¦æ­£ç¡®</small>
            </div>`;
        }
    }

    /**
     * åŠ è½½å½“å‰æ•°æ®ä¿¡æ¯
     */
    async loadCurrentDataInfo() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanelsList = modal.querySelector('#enabled-panels-list');
            const availableFieldsList = modal.querySelector('#available-fields-list');

            if (enabledPanelsList) {
                const enabledPanels = this.getEnabledPanels();
                if (Object.keys(enabledPanels).length > 0) {
                    enabledPanelsList.innerHTML = Object.entries(enabledPanels)
                        .map(([panelId, config]) => `
                            <div style="margin: 5px 0; padding: 5px; background: var(--SmartThemeBodyColor, #333); border-radius: 3px;">
                                <strong>${config.name || panelId}</strong>
                                <div style="font-size: 11px; color: var(--SmartThemeQuoteColor, #888);">
                                    å­—æ®µ: ${(config.fields || []).join(', ') || 'æ— '}
                                </div>
                            </div>
                        `).join('');
                } else {
                    enabledPanelsList.innerHTML = '<p style="color: var(--SmartThemeQuoteColor, #888);">æš‚æ— å¯ç”¨çš„é¢æ¿</p>';
                }
            }

            if (availableFieldsList) {
                try {
                    // è·å–å½“å‰æ•°æ®å­—æ®µ
                    const fields = await this.getCurrentDataFields();

                    if (Object.keys(fields).length > 0) {
                        availableFieldsList.innerHTML = Object.entries(fields)
                            .map(([panelId, fieldList]) => `
                                <div style="margin: 5px 0;">
                                    <strong>${panelId}:</strong>
                                    <div style="font-size: 11px; margin-left: 10px;">
                                        ${fieldList.map(field => `<code style="background: ${this.getInfoBarThemeColor('surface')}; padding: 1px 3px; margin: 1px; border-radius: 2px; color: ${this.getInfoBarThemeColor('accent')};">{{data.${field}}}</code>`).join(' ')}
                                    </div>
                                </div>
                            `).join('');
                    } else {
                        availableFieldsList.innerHTML = `<p style="color: ${this.getInfoBarThemeColor('textSecondary')};">æš‚æ— å¯ç”¨æ•°æ®å­—æ®µ</p>`;
                    }
                } catch (error) {
                    console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®å­—æ®µå¤±è´¥:', error);
                    availableFieldsList.innerHTML = `<p style="color: ${this.getInfoBarThemeColor('textSecondary')};">åŠ è½½æ•°æ®å­—æ®µå¤±è´¥</p>`;
                }
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å½“å‰æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†AIä¿®æ”¹æ¨¡æ¿
     */
    async handleAIModifyTemplate() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            if (!modal) return;

            const textarea = modal.querySelector('.html-template-textarea');
            const aiButton = modal.querySelector('[data-action="ai-modify-template"]');

            if (!textarea) return;

            const userTemplate = textarea.value.trim();
            if (!userTemplate) {
                alert('è¯·å…ˆè¾“å…¥HTMLæ¨¡æ¿ä»£ç ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIå¤„ç†ä¸­...';
            aiButton.disabled = true;

            // è°ƒç”¨AIåŠ©æ‰‹ - ä½¿ç”¨è‡ªå®šä¹‰API
            try {
                // è·å–å½“å‰å¯ç”¨çš„é¢æ¿ä¿¡æ¯
                const enabledPanels = this.getEnabledPanels();
                const availableFields = await this.getCurrentDataFields();

                // æ„å»ºAIæç¤ºè¯
                const prompt = this.buildAIModifyPrompt(userTemplate, enabledPanels, availableFields);

                // è°ƒç”¨è‡ªå®šä¹‰API
                const modifiedTemplate = await this.callCustomAI(prompt);

                textarea.value = modifiedTemplate;
                this.updateTemplatePreview();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showNotification('AIä¿®æ”¹å®Œæˆï¼', 'success');
            } catch (error) {
                console.error('[InfoBarSettings] âŒ AIä¿®æ”¹å¤±è´¥:', error);
                throw new Error(`AIä¿®æ”¹å¤±è´¥: ${error.message}`);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ AIä¿®æ”¹æ¨¡æ¿å¤±è´¥:', error);
            this.showNotification(`AIä¿®æ”¹å¤±è´¥: ${error.message}`, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const aiButton = document.querySelector('.html-template-editor-modal [data-action="ai-modify-template"]');
            if (aiButton) {
                aiButton.innerHTML = '<i class="fas fa-magic"></i> AIä¸€é”®ä¿®æ”¹';
                aiButton.disabled = false;
            }
        }
    }

    /**
     * æ˜¾ç¤ºé€šçŸ¥
     */
    showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white;
            border-radius: 5px;
            z-index: 10001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 300px;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    /**
     * åŠ è½½HTMLæ¨¡æ¿
     */
    loadHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] ğŸ“‚ åŠ è½½HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            // è·å–ä¿å­˜çš„è‡ªå®šä¹‰HTMLæ¨¡æ¿
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            const configs = extensionSettings['Information bar integration tool'] || {};
            const customTemplate = configs.customHTMLTemplate;

            if (customTemplate) {
                console.log('[InfoBarSettings] âœ… åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰æ¨¡æ¿');
                textarea.value = customTemplate;
            } else {
                console.log('[InfoBarSettings] ğŸ“ åŠ è½½é»˜è®¤çŠ¶æ€æ æ¨¡æ¿');
                // åŠ è½½ä½ æä¾›çš„çŠ¶æ€æ æ¨¡æ¿
                textarea.value = this.getDefaultStatusBarTemplate();
            }

            // æ›´æ–°é¢„è§ˆ
            this.updateTemplatePreview();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * è·å–é»˜è®¤çŠ¶æ€æ æ¨¡æ¿
     */
    getDefaultStatusBarTemplate() {
        return `<div class="container" style="
    display: flex;
    max-width: 1200px;
    width: 100%;
    background: rgba(15, 23, 42, 0.85);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(94, 234, 212, 0.2);
    backdrop-filter: blur(10px);
    margin: 10px auto;
">
    <!-- è§’è‰²ä¿¡æ¯é¢æ¿ -->
    <div class="character-panel" style="
        flex: 1;
        padding: 20px;
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
        border-right: 1px solid rgba(94, 234, 212, 0.2);
        position: relative;
    ">
        <div class="character-header" style="
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        ">
            <div class="character-avatar" style="
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: linear-gradient(45deg, #5eead4, #06b6d4);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 15px;
                box-shadow: 0 4px 15px rgba(94, 234, 212, 0.3);
            ">
                <i class="fas fa-user" style="color: #0f172a; font-size: 20px;"></i>
            </div>
            <div class="character-info">
                <h3 class="character-name" style="
                    margin: 0;
                    color: #5eead4;
                    font-size: 18px;
                    font-weight: 600;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                ">{{data.character.name || 'æµ‹è¯•è§’è‰²'}}</h3>
                <p class="character-class" style="
                    margin: 2px 0 0 0;
                    color: #94a3b8;
                    font-size: 14px;
                ">{{data.character.class || 'æ³•å¸ˆ'}} - Lv.{{data.character.level || 30}}</p>
            </div>
        </div>

        <!-- ç”Ÿå‘½å€¼æ¡ -->
        <div class="stat-bar health-bar" style="margin-bottom: 12px;">
            <div class="stat-label" style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 12px;
                color: #cbd5e1;
            ">
                <span><i class="fas fa-heart" style="color: #ef4444; margin-right: 5px;"></i>ç”Ÿå‘½å€¼</span>
                <span>{{data.character.health || 850}}/{{data.character.maxHealth || 1000}}</span>
            </div>
            <div class="progress-bar" style="
                width: 100%;
                height: 8px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 4px;
                overflow: hidden;
                border: 1px solid rgba(239, 68, 68, 0.3);
            ">
                <div class="progress-fill" style="
                    width: {{computed.healthPercentage || 85}}%;
                    height: 100%;
                    background: linear-gradient(90deg, #ef4444, #f87171);
                    transition: width 0.3s ease;
                    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
                "></div>
            </div>
        </div>

        <!-- é­”æ³•å€¼æ¡ -->
        <div class="stat-bar mana-bar" style="margin-bottom: 12px;">
            <div class="stat-label" style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 12px;
                color: #cbd5e1;
            ">
                <span><i class="fas fa-magic" style="color: #3b82f6; margin-right: 5px;"></i>é­”æ³•å€¼</span>
                <span>{{data.character.energy || 320}}/{{data.character.maxEnergy || 450}}</span>
            </div>
            <div class="progress-bar" style="
                width: 100%;
                height: 8px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 4px;
                overflow: hidden;
                border: 1px solid rgba(59, 130, 246, 0.3);
            ">
                <div class="progress-fill" style="
                    width: {{computed.energyPercentage || 71}}%;
                    height: 100%;
                    background: linear-gradient(90deg, #3b82f6, #60a5fa);
                    transition: width 0.3s ease;
                    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                "></div>
            </div>
        </div>

        <!-- é‡‘å¸ -->
        <div class="gold-info" style="
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        ">
            <i class="fas fa-coins" style="color: #fbbf24; margin-right: 8px;"></i>
            <span style="color: #fbbf24; font-weight: 500;">{{data.character.gold || 2847}} é‡‘å¸</span>
        </div>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯é¢æ¿ -->
    <div class="status-panel" style="
        flex: 1;
        padding: 20px;
        background: linear-gradient(135deg, rgba(20, 30, 48, 0.9), rgba(15, 23, 42, 0.9));
        position: relative;
    ">
        <h4 style="
            margin: 0 0 15px 0;
            color: #5eead4;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
        ">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            çŠ¶æ€ä¿¡æ¯
        </h4>

        <div class="status-grid" style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        ">
            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">ä½ç½®</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.location || 'ç¥ç§˜æ£®æ—'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">å¿ƒæƒ…</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.mood || 'ä¸“æ³¨'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">æ—¶é—´</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.time || 'é»„æ˜'}}</div>
            </div>

            <div class="status-item" style="
                padding: 10px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                border: 1px solid rgba(94, 234, 212, 0.1);
            ">
                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 3px;">å¤©æ°”</div>
                <div style="color: #e2e8f0; font-size: 13px; font-weight: 500;">{{data.status.weather || 'æ™´æœ—'}}</div>
            </div>
        </div>

        <!-- è£…é¥°æ€§å…ƒç´  -->
        <div style="
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(94, 234, 212, 0.2), transparent);
            animation: pulse 2s infinite;
        "></div>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

.container:hover {
    transform: translateY(-2px);
    transition: transform 0.3s ease;
}

.stat-bar:hover .progress-fill {
    filter: brightness(1.2);
}

.status-item:hover {
    background: rgba(30, 41, 59, 0.7) !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}
</style>`;
    }

    /**
     * ä¿å­˜HTMLæ¨¡æ¿
     */
    saveHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] ğŸ’¾ ä¿å­˜HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            const templateContent = textarea.value.trim();
            if (!templateContent) {
                console.warn('[InfoBarSettings] âš ï¸ æ¨¡æ¿å†…å®¹ä¸ºç©º');
                return;
            }

            // ä¿å­˜åˆ°SillyTavernæ‰©å±•è®¾ç½®
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            extensionSettings['Information bar integration tool'].customHTMLTemplate = templateContent;

            // ä½¿ç”¨æ­£ç¡®çš„ä¿å­˜æ–¹æ³•
            context.saveSettingsDebounced();

            // ğŸ”§ éªŒè¯ä¿å­˜çš„å®Œæ•´æ€§
            setTimeout(() => {
                const savedTemplate = extensionSettings['Information bar integration tool'].customHTMLTemplate;
                if (savedTemplate && savedTemplate.length === templateContent.length) {
                    console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿ä¿å­˜æˆåŠŸï¼Œé•¿åº¦éªŒè¯é€šè¿‡:', templateContent.length);
                } else {
                    console.error('[InfoBarSettings] âŒ HTMLæ¨¡æ¿ä¿å­˜å¯èƒ½ä¸å®Œæ•´:', {
                        åŸå§‹é•¿åº¦: templateContent.length,
                        ä¿å­˜åé•¿åº¦: savedTemplate?.length || 0
                    });
                }
            }, 100);

            console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿ä¿å­˜æˆåŠŸ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * åº”ç”¨HTMLæ¨¡æ¿
     */
    applyHTMLTemplate() {
        try {
            console.log('[InfoBarSettings] âœ… åº”ç”¨HTMLæ¨¡æ¿...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.html-template-textarea');

            if (!textarea) {
                console.error('[InfoBarSettings] âŒ æ‰¾ä¸åˆ°æ¨¡æ¿æ–‡æœ¬åŒºåŸŸ');
                return;
            }

            const templateContent = textarea.value.trim();
            if (!templateContent) {
                console.warn('[InfoBarSettings] âš ï¸ æ¨¡æ¿å†…å®¹ä¸ºç©º');
                return;
            }

            // å…ˆä¿å­˜æ¨¡æ¿
            this.saveHTMLTemplate();

            // æ›´æ–°ä¿¡æ¯æ è®¾ç½®ï¼Œå¯ç”¨è‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼
            const context = SillyTavern.getContext();
            const extensionSettings = context?.extensionSettings || {};
            if (!extensionSettings['Information bar integration tool']) {
                extensionSettings['Information bar integration tool'] = {};
            }

            // æ­£ç¡®è®¾ç½®ä¸ºè‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼
            extensionSettings['Information bar integration tool'].style = {
                current: 'custom-html',
                lastUpdated: new Date().toISOString()
            };

            // ä½¿ç”¨æ­£ç¡®çš„ä¿å­˜æ–¹æ³•
            context.saveSettingsDebounced();

            // å…³é—­ç¼–è¾‘å™¨
            modal.remove();

            // åˆ·æ–°ä¿¡æ¯æ æ˜¾ç¤º
            if (this.infoBarTool && this.infoBarTool.messageInfoBarRenderer) {
                this.infoBarTool.messageInfoBarRenderer.refreshAllInfoBars();
            }

            console.log('[InfoBarSettings] âœ… HTMLæ¨¡æ¿åº”ç”¨æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°è‡ªå®šä¹‰HTMLæ¨¡æ¿é£æ ¼');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åº”ç”¨HTMLæ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * æ„å»ºAIä¿®æ”¹æç¤ºè¯
     */
    buildAIModifyPrompt(userTemplate, enabledPanels, availableFields) {
        // ğŸš€ æ„å»ºç®€åŒ–çš„æ ¸å¿ƒä¿¡æ¯ï¼Œé¿å…tokenè¶…é™
        const coreFieldsInfo = this.buildCoreFieldsInfo(enabledPanels, availableFields);

        // ğŸ”§ æ£€æµ‹æ¨¡æ¿å¤§å°ï¼Œå†³å®šå¤„ç†ç­–ç•¥
        const templateLength = userTemplate.length;
        console.log('[InfoBarSettings] ğŸ“ æ¨¡æ¿é•¿åº¦æ£€æµ‹:', templateLength, 'å­—ç¬¦');

        if (templateLength > 20000) {
            // è¶…å¤§æ¨¡æ¿ï¼šåªæä¾›ç»“æ„ä¼˜åŒ–å»ºè®®
            return `æ‚¨çš„HTMLæ¨¡æ¿è¿‡å¤§(${templateLength}å­—ç¬¦)ï¼Œæ— æ³•å®Œæ•´å¤„ç†ã€‚è¯·é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

## ğŸ¯ ç®€åŒ–å»ºè®®
1. ç§»é™¤å¤§é‡CSSæ ·å¼ï¼Œæ”¹ç”¨å¤–éƒ¨æ ·å¼è¡¨
2. åˆ é™¤å¤æ‚çš„JavaScriptä»£ç 
3. ç®€åŒ–HTMLç»“æ„ï¼Œä¸“æ³¨æ ¸å¿ƒå†…å®¹

## ğŸ“Š å¯ç”¨æ•°æ®å­—æ®µ
${coreFieldsInfo}

## ğŸ”§ æ•°æ®ç»‘å®šè¯­æ³•
- åŸºæœ¬ç»‘å®š: {{data.personal.name}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯åˆ—è¡¨: {{#each data.array}}{{this}}{{/each}}

è¯·æ‰‹åŠ¨ä¸ºå…³é”®å…ƒç´ æ·»åŠ æ•°æ®ç»‘å®šï¼Œç„¶åé‡æ–°ä½¿ç”¨AIä¼˜åŒ–ã€‚

## ğŸ“ æ¨¡æ¿ç‰‡æ®µç¤ºä¾‹
\`\`\`html
<div class="player-info">
    <h2><i class="fas fa-user"></i> {{data.personal.name}}</h2>
    {{#if data.personal.level}}
    <p>ç­‰çº§: {{data.personal.level}}</p>
    {{/if}}
</div>
\`\`\``;
        } else if (templateLength > 10000) {
            // å¤§æ¨¡æ¿ï¼šç²¾ç®€å¤„ç†
            const templatePreview = userTemplate.substring(0, 5000) + '\n\n[æ¨¡æ¿è¿‡é•¿ï¼Œå·²æˆªæ–­...]';
            return `ä¼˜åŒ–HTMLæ¨¡æ¿(ç®€åŒ–ç‰ˆï¼ŒåŸé•¿åº¦${templateLength}å­—ç¬¦)ï¼š

## ğŸ“Š æ•°æ®å­—æ®µ
${coreFieldsInfo}

## ğŸ”§ è¯­æ³•
- {{data.panel.field}} - æ•°æ®ç»‘å®š
- {{#if data.field}}{{/if}} - æ¡ä»¶æ˜¾ç¤º

## ğŸ“ ç”¨æˆ·æ¨¡æ¿(å‰5000å­—ç¬¦)
${templatePreview}

## è¦æ±‚
ä»…ä¸ºå…³é”®å…ƒç´ æ·»åŠ æ•°æ®ç»‘å®šï¼Œä¿æŒåŸç»“æ„ï¼Œæ·»åŠ å¿…è¦çš„Font Awesomeå›¾æ ‡ã€‚è¿”å›å®Œæ•´HTMLï¼š`;
        } else {
            // æ­£å¸¸å¤§å°æ¨¡æ¿ï¼šå®Œæ•´å¤„ç†
            return `ä¼˜åŒ–ä»¥ä¸‹HTMLæ¨¡æ¿ï¼Œæ·»åŠ æ•°æ®ç»‘å®šå’Œç°ä»£åŒ–æ ·å¼ï¼š

## å¯ç”¨æ•°æ®å­—æ®µ
${coreFieldsInfo}

## è¯­æ³•è§„åˆ™
- æ•°æ®ç»‘å®š: {{data.panelName.fieldName}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯æ•°ç»„: {{#each data.array}}{{this}}{{/each}}

## ç”¨æˆ·æ¨¡æ¿
${userTemplate}

## è¦æ±‚
1. ä¿æŒåŸæœ‰å¸ƒå±€ç»“æ„
2. æ·»åŠ æ‰€æœ‰å¯ç”¨æ•°æ®å­—æ®µçš„ç»‘å®š
3. ä½¿ç”¨ç°ä»£CSSæ ·å¼ï¼Œæ”¯æŒæ·±è‰²ä¸»é¢˜
4. æ·»åŠ é€‚å½“çš„Font Awesomeå›¾æ ‡
5. ç¡®ä¿å“åº”å¼è®¾è®¡
6. ä¸ºå¯é€‰æ•°æ®æ·»åŠ æ¡ä»¶åˆ¤æ–­

ç›´æ¥è¿”å›å®Œæ•´çš„HTMLä»£ç ï¼ŒåŒ…å«å†…è”CSSï¼š`;
        }
    }

    /**
     * ğŸ”§ æ„å»ºæ ¸å¿ƒæ•°æ®å­—æ®µä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œé¿å…tokenè¶…é™ï¼‰
     */
    buildCoreFieldsInfo(enabledPanels, availableFields) {
        let info = '';

        if (enabledPanels && typeof enabledPanels === 'object') {
            const panelCount = Object.keys(enabledPanels).length;
            info += `å¯ç”¨é¢æ¿(${panelCount}ä¸ª): `;

            const panelNames = Object.entries(enabledPanels)
                .slice(0, 8) // åªæ˜¾ç¤ºå‰8ä¸ªé¢æ¿ï¼Œé¿å…è¿‡é•¿
                .map(([panelId, config]) => `${panelId}`)
                .join(', ');

            info += panelNames;
            if (panelCount > 8) info += `, ...ç­‰${panelCount}ä¸ª`;
            info += '\n\n';
        }

        // ç®€åŒ–çš„å­—æ®µç¤ºä¾‹
        info += `æ•°æ®è®¿é—®ç¤ºä¾‹:\n`;
        info += `- è§’è‰²ä¿¡æ¯: {{data.personal.name}}, {{data.personal.age}}\n`;
        info += `- ç»Ÿè®¡æ•°æ®: {{data.stats.health}}, {{data.stats.level}}\n`;
        info += `- ç‰©å“é“å…·: {{data.inventory.items}}\n`;
        info += `- ä»»åŠ¡ä¿¡æ¯: {{data.tasks.current}}\n`;
        info += `- ä½ç½®ä¿¡æ¯: {{data.world.location}}\n`;

        return info;
    }

    /**
     * ğŸš€ æ„å»ºè¯¦ç»†çš„æ•°æ®å­—æ®µä¿¡æ¯
     */
    buildDetailedFieldsInfo(enabledPanels, availableFields) {
        let info = '';

        if (enabledPanels && typeof enabledPanels === 'object') {
            const panelCount = Object.keys(enabledPanels).length;
            info += `### å¯ç”¨çš„æ•°æ®é¢æ¿ (${panelCount}ä¸ª)ï¼š\n\n`;

            Object.entries(enabledPanels).forEach(([panelId, panelConfig]) => {
                const panelName = this.getPanelDisplayName(panelId);
                const fieldsCount = this.countEnabledFields(panelConfig);

                info += `#### ğŸ“Š ${panelName} (${panelId})\n`;
                info += `- çŠ¶æ€: ${panelConfig.enabled !== false ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}\n`;
                info += `- å­—æ®µæ•°é‡: ${fieldsCount}ä¸ª\n`;
                info += `- è®¿é—®è¯­æ³•: \`{{data.${panelId}.fieldName}}\`\n\n`;
            });
        }

        if (availableFields && typeof availableFields === 'object') {
            const totalFields = Object.keys(availableFields).length;
            info += `### å¯ç”¨æ•°æ®å­—æ®µ (${totalFields}ä¸ª)ï¼š\n\n`;

            Object.entries(availableFields).forEach(([panelId, fields]) => {
                if (fields && typeof fields === 'object') {
                    const fieldList = Object.keys(fields);
                    if (fieldList.length > 0) {
                        info += `#### ğŸ·ï¸ ${this.getPanelDisplayName(panelId)}é¢æ¿å­—æ®µ:\n`;
                        fieldList.forEach(field => {
                            const fieldValue = fields[field];
                            const fieldType = typeof fieldValue;
                            info += `- \`{{data.${panelId}.${field}}}\` (${fieldType}) - ç¤ºä¾‹: "${fieldValue}"\n`;
                        });
                        info += '\n';
                    }
                }
            });
        }

        return info || 'æš‚æ— å¯ç”¨çš„æ•°æ®å­—æ®µä¿¡æ¯';
    }

    /**
     * ğŸ¯ è·å–æ¨¡æ¿è¯­æ³•æŒ‡å—
     */
    getTemplateSyntaxGuide() {
        return `### åŸºç¡€è¯­æ³•ï¼š
- \`{{data.fieldName}}\` - è¾“å‡ºå­—æ®µå€¼
- \`{{#if data.field}}\`å†…å®¹\`{{/if}}\` - æ¡ä»¶æ¸²æŸ“
- \`{{#each data.array}}\`é¡¹ç›®å†…å®¹\`{{/each}}\` - å¾ªç¯æ¸²æŸ“
- \`{{#unless data.field}}\`å¤‡ç”¨å†…å®¹\`{{/unless}}\` - åå‘æ¡ä»¶

### é¢æ¿è®¿é—®ï¼š
- \`{{data.character.name}}\` - è§’è‰²é¢æ¿çš„nameå­—æ®µ
- \`{{data.stats.health}}\` - ç»Ÿè®¡é¢æ¿çš„healthå­—æ®µ
- \`{{data.inventory.items}}\` - ç‰©å“é¢æ¿çš„itemsæ•°ç»„

### é«˜çº§ç”¨æ³•ï¼š
- \`{{data.stats.health}}/{{data.stats.maxHealth}}\` - ç»„åˆæ˜¾ç¤º
- æ”¯æŒåµŒå¥—å¯¹è±¡å’Œæ•°ç»„è®¿é—®
- è‡ªåŠ¨å¤„ç†undefinedå’Œnullå€¼`;
    }

    /**
     * ğŸ’¡ è·å–æ•°æ®ç»‘å®šç¤ºä¾‹
     */
    getDataBindingExamples() {
        return `### åŸºç¡€æ•°æ®æ˜¾ç¤ºï¼š
\`\`\`html
<div class="character-info">
    <h3>{{data.character.name}}</h3>
    <p>ç­‰çº§: {{data.character.level}}</p>
</div>
\`\`\`

### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹ï¼š
\`\`\`html
{{#if data.stats.health}}
<div class="health-bar">
    <span>ç”Ÿå‘½å€¼: {{data.stats.health}}/{{data.stats.maxHealth}}</span>
    <div class="progress-bar">
        <div style="width: {{data.stats.healthPercent}}%"></div>
    </div>
</div>
{{/if}}
\`\`\`

### æ•°ç»„å¾ªç¯ç¤ºä¾‹ï¼š
\`\`\`html
{{#if data.inventory.items}}
<ul class="inventory-list">
    {{#each data.inventory.items}}
    <li class="item">
        <i class="fas fa-box"></i>
        <span>{{this.name}} (x{{this.quantity}})</span>
    </li>
    {{/each}}
</ul>
{{/if}}
\`\`\``;
    }

    /**
     * è°ƒç”¨è‡ªå®šä¹‰AI API
     */
    async callCustomAI(prompt) {
        try {
            // è·å–APIé…ç½®
            const apiConfig = this.getAPIConfig();

            if (!apiConfig.enabled) {
                throw new Error('AI APIæœªå¯ç”¨ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®API');
            }

            if (!apiConfig.apiKey) {
                throw new Error('APIå¯†é’¥æœªé…ç½®ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­æ·»åŠ APIå¯†é’¥');
            }

            if (!apiConfig.endpoint) {
                throw new Error('APIç«¯ç‚¹æœªé…ç½®ï¼Œè¯·åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®APIç«¯ç‚¹');
            }

            console.log('[InfoBarSettings] ğŸ¤– è°ƒç”¨è‡ªå®šä¹‰AI API...', {
                provider: apiConfig.provider,
                model: apiConfig.model,
                endpoint: apiConfig.endpoint,
                maxTokens: apiConfig.maxTokens,
                temperature: apiConfig.temperature,
                hasApiKey: !!apiConfig.apiKey
            });

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ç«¯ç‚¹æ­£ç¡®
            if (!apiConfig.endpoint) {
                console.error('[InfoBarSettings] âŒ APIç«¯ç‚¹ä¸ºç©º:', apiConfig);
                throw new Error('APIç«¯ç‚¹æœªé…ç½®ï¼Œè¯·æ£€æŸ¥æ‰©å±•è®¾ç½®');
            }

            let requestBody, headers;

            // æ ¹æ®ä¸åŒçš„APIæä¾›å•†æ„å»ºè¯·æ±‚
            if (apiConfig.provider === 'gemini') {
                headers = {
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiConfig.apiKey,
                    ...apiConfig.headers
                };
                requestBody = {
                    contents: [{
                        parts: [{
                            text: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HTMLæ¨¡æ¿å¼€å‘åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·è¦æ±‚ä¼˜åŒ–HTMLæ¨¡æ¿ï¼Œæ·»åŠ æ•°æ®ç»‘å®šã€‚\n\n${prompt}`
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: Math.min(apiConfig.maxTokens || 4000, 8000), // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®ï¼Œæœ€å¤§é™åˆ¶8000é¿å…è¶…é™
                        temperature: apiConfig.temperature || 0.7, // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æ¸©åº¦
                        topP: 0.8,
                        topK: 20
                    }
                };
            } else {
                // ğŸ”§ ä¿®å¤ï¼šOpenAIæ ¼å¼ï¼Œä½¿ç”¨ç”¨æˆ·é…ç½®çš„å‚æ•°
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`,
                    ...apiConfig.headers
                };
                requestBody = {
                    model: apiConfig.model, // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„æ¨¡å‹
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HTMLæ¨¡æ¿å¼€å‘åŠ©æ‰‹ï¼Œä¸“æ³¨äºç”Ÿæˆé«˜è´¨é‡ã€è¯­ä¹‰åŒ–çš„HTMLä»£ç ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: Math.min(apiConfig.maxTokens || 4000, 8000), // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æœ€å¤§ä»¤ç‰Œæ•°ï¼Œæœ€å¤§é™åˆ¶8000
                    temperature: apiConfig.temperature || 0.7 // ğŸ”§ ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æ¸©åº¦
                };

                // ğŸ”§ æ·»åŠ å…¶ä»–å¯é€‰å‚æ•°ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†ï¼‰
                if (apiConfig.topP !== undefined) {
                    requestBody.top_p = apiConfig.topP;
                }
                if (apiConfig.frequencyPenalty !== undefined) {
                    requestBody.frequency_penalty = apiConfig.frequencyPenalty;
                }
                if (apiConfig.presencePenalty !== undefined) {
                    requestBody.presence_penalty = apiConfig.presencePenalty;
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶

            let response;
            let retryCount = 0;
            const maxRetries = apiConfig.retryCount || 2;

            while (retryCount <= maxRetries) {
                try {
                    console.log(`[InfoBarSettings] ğŸŒ å‘é€APIè¯·æ±‚ (å°è¯• ${retryCount + 1}/${maxRetries + 1})`);

                    response = await fetch(apiConfig.endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        break; // æˆåŠŸï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                    } else if (response.status >= 500 && retryCount < maxRetries) {
                        // æœåŠ¡å™¨é”™è¯¯ï¼Œå¯ä»¥é‡è¯•
                        console.warn(`[InfoBarSettings] âš ï¸ æœåŠ¡å™¨é”™è¯¯ ${response.status}ï¼Œ${2 ** retryCount}ç§’åé‡è¯•...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** retryCount)));
                        retryCount++;
                        continue;
                    } else {
                        // å®¢æˆ·ç«¯é”™è¯¯æˆ–é‡è¯•æ¬¡æ•°ç”¨å®Œ
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    clearTimeout(timeoutId);

                    if (error.name === 'AbortError') {
                        throw new Error('APIè¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                    } else if (retryCount < maxRetries && (error.message.includes('fetch') || error.message.includes('network'))) {
                        console.warn(`[InfoBarSettings] âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œ${2 ** retryCount}ç§’åé‡è¯•:`, error.message);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** retryCount)));
                        retryCount++;
                        continue;
                    } else {
                        throw error;
                    }
                }
            }

            const data = await response.json();

            // ğŸ”§ å¢åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­APIè¿”å›æ ¼å¼
            console.log('[InfoBarSettings] ğŸ“‹ APIè¿”å›æ•°æ®ç»“æ„:', JSON.stringify(data, null, 2));

            let result;
            if (apiConfig.provider === 'gemini') {
                // ğŸš€ å¢å¼ºGemini APIæ ¼å¼å¤„ç†
                try {
                    if (!data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
                        console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— candidates:', data);
                        throw new Error(`Gemini APIè¿”å›æ ¼å¼é”™è¯¯: æ— candidateså­—æ®µæˆ–ä¸ºç©ºæ•°ç»„`);
                    }

                    const candidate = data.candidates[0];
                    if (!candidate) {
                        console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— candidate:', candidate);
                        throw new Error('Gemini APIè¿”å›æ ¼å¼é”™è¯¯: candidateä¸ºç©º');
                    }

                    // ğŸš€ æ£€æŸ¥æ˜¯å¦å› ä¸ºMAX_TOKENSå¯¼è‡´å“åº”è¢«æˆªæ–­
                    if (candidate.finishReason === 'MAX_TOKENS') {
                        console.warn('[InfoBarSettings] âš ï¸ Geminiå“åº”è¢«æˆªæ–­ - MAX_TOKENSï¼Œå°è¯•æå–éƒ¨åˆ†å†…å®¹:', candidate);

                        // ğŸ”§ å°è¯•è·å–æˆªæ–­å‰çš„éƒ¨åˆ†å†…å®¹
                        let partialContent = '';
                        if (candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                            const part = candidate.content.parts[0];
                            if (part && typeof part.text === 'string') {
                                partialContent = part.text.trim();
                            }
                        }

                        if (partialContent) {
                            console.log('[InfoBarSettings] ğŸ”„ è·å–åˆ°éƒ¨åˆ†å†…å®¹ï¼Œé•¿åº¦:', partialContent.length);

                            // ğŸ¯ æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„HTMLå†…å®¹
                            if (partialContent.includes('<html') || partialContent.includes('<!DOCTYPE') || partialContent.includes('<div')) {
                                console.log('[InfoBarSettings] âœ… æ£€æµ‹åˆ°æœ‰æ•ˆHTMLå†…å®¹ï¼Œä½¿ç”¨éƒ¨åˆ†ç»“æœ');
                                result = partialContent + '\n\n<!-- âš ï¸ å†…å®¹è¢«æˆªæ–­ï¼Œå»ºè®®ç®€åŒ–æ¨¡æ¿åé‡æ–°ç”Ÿæˆ -->';
                            } else {
                                // å¦‚æœä¸æ˜¯HTMLå†…å®¹ï¼Œè¿”å›å»ºè®®
                                result = partialContent + '\n\nâš ï¸ AIå»ºè®®ï¼šæ‚¨çš„æ¨¡æ¿è¿‡å¤§ï¼Œè¯·æŒ‰ç…§ä¸Šè¿°å»ºè®®ç®€åŒ–åé‡æ–°å°è¯•ã€‚';
                            }
                        } else {
                            throw new Error('AIå“åº”è¢«æˆªæ–­ä¸”æ— å¯ç”¨å†…å®¹ï¼Œè¯·å¤§å¹…ç®€åŒ–HTMLæ¨¡æ¿æˆ–å‡å°‘æç¤ºè¯é•¿åº¦ã€‚');
                        }
                    }

                    // ğŸ”§ å¦‚æœä¸æ˜¯MAX_TOKENSæˆªæ–­ï¼Œè¿›è¡Œæ­£å¸¸å†…å®¹å¤„ç†
                    if (candidate.finishReason !== 'MAX_TOKENS') {
                        if (!candidate.content) {
                            console.error('[InfoBarSettings] âŒ Geminiè¿”å›æ ¼å¼é”™è¯¯ - æ— content:', candidate);
                            throw new Error('Gemini APIè¿”å›æ ¼å¼é”™è¯¯: candidateæ— contentå­—æ®µ');
                        }

                        // ğŸ”§ å¤„ç†ä¸åŒçš„contentæ ¼å¼
                        let textContent = '';

                        if (candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                            // æ ‡å‡†æ ¼å¼ï¼šæœ‰partsæ•°ç»„
                            const part = candidate.content.parts[0];
                            if (part && typeof part.text === 'string') {
                                textContent = part.text.trim();
                            }
                        } else if (candidate.content.text && typeof candidate.content.text === 'string') {
                            // å¤‡ç”¨æ ¼å¼ï¼šç›´æ¥åŒ…å«textå­—æ®µ
                            textContent = candidate.content.text.trim();
                        } else if (typeof candidate.content === 'string') {
                            // å¤‡ç”¨æ ¼å¼ï¼šcontentç›´æ¥æ˜¯å­—ç¬¦ä¸²
                            textContent = candidate.content.trim();
                        }

                        if (!textContent) {
                            console.error('[InfoBarSettings] âŒ Geminiè¿”å›å†…å®¹ä¸ºç©º:', candidate.content);
                            throw new Error('Gemini APIè¿”å›çš„å†…å®¹ä¸ºç©ºï¼Œå¯èƒ½æ˜¯å› ä¸ºæç¤ºè¯å¤ªé•¿æˆ–å…¶ä»–APIé™åˆ¶');
                        }

                        result = textContent;
                        console.log('[InfoBarSettings] âœ… æˆåŠŸè§£æGeminiè¿”å›å†…å®¹ï¼Œé•¿åº¦:', result.length);
                    }

                } catch (parseError) {
                    console.error('[InfoBarSettings] âŒ è§£æGeminiè¿”å›å†…å®¹å¤±è´¥:', parseError);
                    console.error('[InfoBarSettings] ğŸ“‹ åŸå§‹è¿”å›æ•°æ®:', data);

                    // ğŸ”§ å°è¯•å…¶ä»–å¯èƒ½çš„æ ¼å¼
                    if (data.text) {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ç›´æ¥ä½¿ç”¨data.text');
                        result = data.text.trim();
                    } else if (data.content && typeof data.content === 'string') {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ä½¿ç”¨data.content');
                        result = data.content.trim();
                    } else if (typeof data === 'string') {
                        console.log('[InfoBarSettings] ğŸ”„ å°è¯•ç›´æ¥ä½¿ç”¨dataå­—ç¬¦ä¸²');
                        result = data.trim();
                    } else {
                        throw parseError;
                    }
                }
            } else {
                // OpenAIæ ¼å¼
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('AI APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                result = data.choices[0].message.content.trim();
            }

            // æ¸…ç†è¿”å›çš„ä»£ç 
            return this.cleanAIResponse(result);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è‡ªå®šä¹‰AI APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è·å–APIé…ç½®
     */
    getAPIConfig() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è·å–æ‰©å±•è®¾ç½®
            let apiConfig = {};

            // æ–¹æ³•1ï¼šä»å…¨å±€æ‰©å±•è®¾ç½®è·å–
            if (window.extension_settings && window.extension_settings['Information bar integration tool']) {
                apiConfig = window.extension_settings['Information bar integration tool'].apiConfig || {};
            }
            // æ–¹æ³•2ï¼šä»SillyTavernä¸Šä¸‹æ–‡è·å–ï¼ˆå¤‡ç”¨ï¼‰
            else if (typeof SillyTavern !== 'undefined' && SillyTavern.getContext) {
                const context = SillyTavern.getContext();
                const extensionSettings = context?.extensionSettings || {};
                const configs = extensionSettings['Information bar integration tool'] || {};
                apiConfig = configs.apiConfig || {};
            }
            // æ–¹æ³•3ï¼šä»æœ¬åœ°å­˜å‚¨è·å–ï¼ˆæœ€åå¤‡ç”¨ï¼‰
            else {
                try {
                    const stored = localStorage.getItem('InfoBarSettings_apiConfig');
                    if (stored) {
                        apiConfig = JSON.parse(stored);
                    }
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ ä»æœ¬åœ°å­˜å‚¨è·å–APIé…ç½®å¤±è´¥:', e);
                }
            }

            console.log('[InfoBarSettings] ğŸ“Š è·å–APIé…ç½®:', {
                enabled: apiConfig.enabled,
                provider: apiConfig.provider,
                model: apiConfig.model,
                maxTokens: apiConfig.maxTokens,
                temperature: apiConfig.temperature,
                hasApiKey: !!apiConfig.apiKey,
                endpoint: apiConfig.endpoint,
                baseUrl: apiConfig.baseUrl, // ğŸ”§ æ·»åŠ baseUrlè°ƒè¯•
                rawEndpoint: apiConfig.endpoint
            });

            // ğŸ”§ ä¿®å¤ï¼šæ„å»ºæ­£ç¡®çš„ç«¯ç‚¹URLï¼Œæ”¯æŒbaseUrlå’Œendpoint
            let endpoint = apiConfig.endpoint || apiConfig.baseUrl;

            // ğŸ”§ ä¿®å¤ï¼šå¯¹äºè‡ªå®šä¹‰providerï¼Œå¤„ç†baseUrlå’Œendpoint
            if (apiConfig.provider === 'custom') {
                if (!endpoint) {
                    console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰APIæä¾›å•†æœªé…ç½®ç«¯ç‚¹ï¼Œå°†åœ¨è°ƒç”¨æ—¶æ£€æŸ¥');
                    // ä¸åœ¨è¿™é‡ŒæŠ›é”™ï¼Œè€Œæ˜¯åœ¨å®é™…è°ƒç”¨æ—¶æ£€æŸ¥
                } else {
                    // ğŸ”§ ä¿®å¤ï¼šæ„å»ºå®Œæ•´çš„chat completionsç«¯ç‚¹
                    if (!endpoint.includes('/chat/completions')) {
                        // å¦‚æœæ˜¯baseUrlæ ¼å¼ï¼Œæ·»åŠ chat/completionsè·¯å¾„
                        if (endpoint.endsWith('/v1') || endpoint.endsWith('/v1/')) {
                            endpoint = endpoint.replace(/\/v1\/?$/, '/v1/chat/completions');
                        } else if (endpoint.includes('/models')) {
                            endpoint = endpoint.replace('/models', '/chat/completions');
                        } else if (!endpoint.includes('/chat/completions')) {
                            // å¦‚æœæ²¡æœ‰å…·ä½“è·¯å¾„ï¼Œæ·»åŠ é»˜è®¤è·¯å¾„
                            endpoint = endpoint.replace(/\/$/, '') + '/chat/completions';
                        }
                        console.log('[InfoBarSettings] ğŸ”§ æ„å»ºå®Œæ•´ç«¯ç‚¹:', endpoint);
                    }
                }
            } else if (apiConfig.provider === 'gemini') {
                // ğŸ”§ ä¿®å¤ï¼šGeminiéœ€è¦ç‰¹æ®Šçš„ç«¯ç‚¹æ ¼å¼
                const model = apiConfig.model || 'gemini-pro';
                if (!endpoint || endpoint === 'https://generativelanguage.googleapis.com' || !endpoint.includes(':generateContent')) {
                    endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                    console.log('[InfoBarSettings] ğŸ”§ æ„å»ºGeminiç«¯ç‚¹:', endpoint);
                }
            } else if (!endpoint) {
                try {
                    endpoint = this.getDefaultEndpoint(apiConfig.provider);
                } catch (e) {
                    console.warn('[InfoBarSettings] âš ï¸ è·å–é»˜è®¤ç«¯ç‚¹å¤±è´¥:', e.message);
                    endpoint = ''; // è®¾ä¸ºç©ºï¼Œåœ¨è°ƒç”¨æ—¶å†æ£€æŸ¥
                }
            }

            return {
                enabled: apiConfig.enabled || false,
                endpoint: endpoint,
                apiKey: apiConfig.apiKey || '',
                model: apiConfig.model || 'gpt-3.5-turbo',
                provider: apiConfig.provider || 'openai',
                headers: apiConfig.headers || {},
                // ğŸ”§ æ·»åŠ ç¼ºå¤±çš„é…ç½®å­—æ®µ
                maxTokens: apiConfig.maxTokens || 4000, // ä»ç”¨æˆ·è®¾ç½®æˆ–é»˜è®¤4000
                temperature: apiConfig.temperature || 0.7,
                retryCount: apiConfig.retryCount || 3,
                format: apiConfig.format || 'native'
            };
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–APIé…ç½®å¤±è´¥:', error);
            console.error('[InfoBarSettings] é”™è¯¯å †æ ˆ:', error.stack);
            console.error('[InfoBarSettings] é”™è¯¯å‘ç”Ÿä½ç½®ï¼ŒåŸå§‹é…ç½®:', {
                hasExtensionSettings: !!window.extension_settings,
                hasInfoBarConfig: !!(window.extension_settings && window.extension_settings['Information bar integration tool']),
                hasSillyTavern: typeof SillyTavern !== 'undefined'
            });
            return { enabled: false };
        }
    }

    /**
     * è·å–é»˜è®¤APIç«¯ç‚¹
     */
    getDefaultEndpoint(provider) {
        const endpoints = {
            openai: 'https://api.openai.com/v1/chat/completions',
            anthropic: 'https://api.anthropic.com/v1/messages',
            gemini: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤customçš„é»˜è®¤ç«¯ç‚¹ï¼Œcustomå¿…é¡»ç”±ç”¨æˆ·é…ç½®
        };

        // ğŸ”§ ä¿®å¤ï¼šcustom providerè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸æŠ›é”™
        if (provider === 'custom') {
            console.warn('[InfoBarSettings] âš ï¸ è‡ªå®šä¹‰provideréœ€è¦ç”¨æˆ·é…ç½®ç«¯ç‚¹');
            return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯æŠ›é”™
        }

        return endpoints[provider] || endpoints.openai;
    }

    /**
     * ğŸš€ å¢å¼ºçš„AIå“åº”æ¸…ç†
     */
    cleanAIResponse(response) {
        if (!response || typeof response !== 'string') {
            console.warn('[InfoBarSettings] âš ï¸ AIå“åº”ä¸ºç©ºæˆ–éå­—ç¬¦ä¸²:', typeof response);
            return '';
        }

        console.log('[InfoBarSettings] ğŸ§¹ å¼€å§‹æ¸…ç†AIå“åº”ï¼ŒåŸé•¿åº¦:', response.length);

        let cleaned = response;

        // ğŸ”§ ç§»é™¤å„ç§ä»£ç å—æ ‡è®°
        cleaned = cleaned.replace(/```html\s*\n?/gi, '');
        cleaned = cleaned.replace(/```css\s*\n?/gi, '');
        cleaned = cleaned.replace(/```javascript\s*\n?/gi, '');
        cleaned = cleaned.replace(/```js\s*\n?/gi, '');
        cleaned = cleaned.replace(/```\s*\n?/g, '');

        // ğŸ”§ ç§»é™¤å¯èƒ½çš„markdownæ ¼å¼
        cleaned = cleaned.replace(/^#+\s+.*$/gm, ''); // ç§»é™¤æ ‡é¢˜
        cleaned = cleaned.replace(/^\*\*.*\*\*$/gm, ''); // ç§»é™¤ç²—ä½“è¡Œ
        cleaned = cleaned.replace(/^[-*]\s+.*$/gm, ''); // ç§»é™¤åˆ—è¡¨é¡¹

        // ğŸ”§ ç§»é™¤AIå¯èƒ½æ·»åŠ çš„è¯´æ˜æ–‡å­—
        const removePatterns = [
            /^(è¿™é‡Œæ˜¯|ä»¥ä¸‹æ˜¯|è¿™æ˜¯ä¸€ä¸ª|ä¿®æ”¹åçš„|ä¼˜åŒ–åçš„).*HTML.*$/gim,
            /^.*å®Œæ•´.*HTML.*ä»£ç .*$/gim,
            /^.*ä¿®æ”¹.*æ¨¡æ¿.*$/gim,
            /^.*ä¼˜åŒ–.*å»ºè®®.*$/gim,
            /^.*æ³¨æ„äº‹é¡¹.*$/gim,
            /^.*è¯´æ˜.*$/gim,
            /^.*è§£é‡Š.*$/gim
        ];

        removePatterns.forEach(pattern => {
            cleaned = cleaned.replace(pattern, '');
        });

        // ğŸ”§ æŸ¥æ‰¾å¹¶æå–HTMLå†…å®¹
        const htmlMatch = cleaned.match(/<[^>]+>/);
        if (htmlMatch) {
            // æ‰¾åˆ°HTMLæ ‡ç­¾çš„èµ·å§‹ä½ç½®
            const htmlStart = cleaned.indexOf(htmlMatch[0]);
            if (htmlStart > 0) {
                // ç§»é™¤HTMLä¹‹å‰çš„æ‰€æœ‰è¯´æ˜æ–‡å­—
                cleaned = cleaned.substring(htmlStart);
                console.log('[InfoBarSettings] âœ‚ï¸ ç§»é™¤äº†HTMLä¹‹å‰çš„è¯´æ˜æ–‡å­—');
            }
        }

        // ğŸ”§ ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
        cleaned = cleaned.replace(/\n\s*\n\s*\n+/g, '\n\n');
        cleaned = cleaned.replace(/^\s*\n+/g, ''); // ç§»é™¤å¼€å¤´ç©ºè¡Œ
        cleaned = cleaned.replace(/\n+\s*$/g, ''); // ç§»é™¤ç»“å°¾ç©ºè¡Œ

        // ğŸ”§ åŸºæœ¬HTMLéªŒè¯
        const result = cleaned.trim();

        if (!result) {
            console.error('[InfoBarSettings] âŒ æ¸…ç†åAIå“åº”ä¸ºç©º');
            throw new Error('AIè¿”å›çš„å†…å®¹æ¸…ç†åä¸ºç©º');
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«åŸºæœ¬HTMLç»“æ„
        const hasHTMLTags = /<[^>]+>/.test(result);
        if (!hasHTMLTags) {
            console.warn('[InfoBarSettings] âš ï¸ æ¸…ç†åçš„å†…å®¹å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„HTML');
        }

        console.log('[InfoBarSettings] âœ… AIå“åº”æ¸…ç†å®Œæˆï¼Œæœ€ç»ˆé•¿åº¦:', result.length);
        console.log('[InfoBarSettings] ğŸ“‹ æ¸…ç†åå†…å®¹é¢„è§ˆ:', result.substring(0, 200) + '...');

        return result;
    }

    /**
     * ğŸ”§ åˆ é™¤ï¼šé‡å¤çš„getEnabledPanelsæ–¹æ³•å·²åˆ é™¤
     * åŸå› ï¼šè¯¥æ–¹æ³•ä¸ç¬¬ä¸€ä¸ªgetEnabledPanelsæ–¹æ³•é‡å¤ï¼Œä¸”è¿”å›é”™è¯¯çš„é¢æ¿ID
     * ä¿®å¤ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªæ­£ç¡®çš„getEnabledPanelsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨æ ‡å‡†é¢æ¿ID
     */

    /**
     * è·å–å½“å‰æ•°æ®å­—æ®µ
     */
    async getCurrentDataFields() {
        try {
            // ä»ç»Ÿä¸€æ•°æ®æ ¸å¿ƒè·å–å½“å‰æ•°æ®ç»“æ„
            const infoBarTool = window.SillyTavernInfobar?.modules?.infoBarTool;
            if (infoBarTool && infoBarTool.dataCore) {
                // ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•è·å–æ‰€æœ‰é¢æ¿æ•°æ®
                const allPanelData = await infoBarTool.dataCore.getAllPanelData();
                if (allPanelData && Object.keys(allPanelData).length > 0) {
                    const fields = {};
                    Object.entries(allPanelData).forEach(([panelId, panelData]) => {
                        fields[panelId] = Object.keys(panelData || {});
                    });
                    return fields;
                }

                // å°è¯•è·å–èŠå¤©æ•°æ®
                const chatData = await infoBarTool.dataCore.getAllData('chat');
                if (chatData) {
                    const fields = {};
                    // æŸ¥æ‰¾é¢æ¿æ•°æ®
                    Object.entries(chatData).forEach(([key, value]) => {
                        if (key.startsWith('panels.') && value) {
                            const panelId = key.split('.').pop();
                            fields[panelId] = Object.keys(value);
                        }
                    });
                    if (Object.keys(fields).length > 0) {
                        return fields;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰å®é™…æ•°æ®ï¼Œè¿”å›ç¤ºä¾‹å­—æ®µ
            return {
                character: ['name', 'class', 'level', 'health', 'maxHealth', 'energy', 'maxEnergy'],
                status: ['location', 'mood', 'time', 'weather'],
                inventory: ['items', 'gold', 'gems'],
                skills: ['skills', 'experience']
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å½“å‰æ•°æ®å­—æ®µå¤±è´¥:', error);
            // è¿”å›ç¤ºä¾‹å­—æ®µä½œä¸ºå›é€€
            return {
                character: ['name', 'class', 'level', 'health', 'maxHealth', 'energy', 'maxEnergy'],
                status: ['location', 'mood', 'time', 'weather'],
                inventory: ['items', 'gold', 'gems'],
                skills: ['skills', 'experience']
            };
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½é«˜çº§æ•°æ®ä¿¡æ¯
     */
    loadAdvancedDataInfo() {
        try {
            // åŠ è½½å½“å‰å¯ç”¨çš„é¢æ¿
            this.loadEnabledPanelsList();

            // åŠ è½½å¯ç”¨å­—æ®µ
            this.loadAvailableFieldsList();

            // ç»‘å®šå¿«é€Ÿæ’å…¥æŒ‰é’®äº‹ä»¶
            this.bindQuickInsertEvents();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½é«˜çº§æ•°æ®ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½å½“å‰å¯ç”¨çš„é¢æ¿åˆ—è¡¨
     */
    async loadEnabledPanelsList() {
        try {
            const panelsList = document.querySelector('#enabled-panels-list');
            if (!panelsList) return;

            console.log('[InfoBarSettings] ğŸ“Š åŠ è½½å¯ç”¨çš„é¢æ¿åˆ—è¡¨...');

            // è·å–å½“å‰å¯ç”¨çš„é¢æ¿
            const enabledPanels = this.getEnabledPanels(); // ç§»é™¤awaitï¼Œå› ä¸ºè¿™æ˜¯åŒæ­¥æ–¹æ³•

            if (enabledPanels && Object.keys(enabledPanels).length > 0) {
                const themeColors = {
                    text: this.getInfoBarThemeColor('text'),
                    textSecondary: this.getInfoBarThemeColor('textSecondary'),
                    accent: this.getInfoBarThemeColor('accent'),
                    background: this.getInfoBarThemeColor('background'),
                    border: this.getInfoBarThemeColor('border')
                };

                // ğŸ”§ ä¿®å¤ï¼šå°†é¢æ¿å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„è¿›è¡Œå¤„ç†
                const panelsHTML = Object.entries(enabledPanels).map(([panelId, panelConfig]) => `
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 6px 8px;
                        margin-bottom: 4px;
                        background: ${themeColors.background};
                        border: 1px solid ${themeColors.border};
                        border-radius: 3px;
                        color: ${themeColors.text};
                        font-size: 11px;
                    ">
                        <i class="${this.getPanelIcon(panelId)}" style="
                            color: ${themeColors.accent};
                            margin-right: 6px;
                            font-size: 10px;
                        "></i>
                        <span style="flex-grow: 1;">${this.getPanelDisplayName(panelId)}</span>
                        <span style="
                            color: ${themeColors.textSecondary};
                            font-size: 9px;
                        ">${this.countEnabledFields(panelConfig)}ä¸ªå­—æ®µ</span>
                    </div>
                `).join('');

                panelsList.innerHTML = panelsHTML;
            } else {
                panelsList.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        color: ${this.getInfoBarThemeColor('textSecondary')};
                        font-size: 11px;
                    ">
                        <i class="fas fa-info-circle" style="margin-bottom: 8px; display: block; font-size: 16px;"></i>
                        æš‚æ— å¯ç”¨çš„æ•°æ®é¢æ¿<br>
                        <small style="font-size: 9px;">è¯·å…ˆåœ¨é¢æ¿ç®¡ç†ä¸­å¯ç”¨æ•°æ®é¢æ¿</small>
                    </div>
                `;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å¯ç”¨é¢æ¿åˆ—è¡¨å¤±è´¥:', error);
            const panelsList = document.querySelector('#enabled-panels-list');
            if (panelsList) {
                panelsList.innerHTML = `
                    <div style="color: #FF5722; font-size: 11px; text-align: center; padding: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè®¡ç®—é¢æ¿ä¸­å¯ç”¨çš„å­—æ®µæ•°é‡
     */
    countEnabledFields(panelConfig) {
        if (!panelConfig || typeof panelConfig !== 'object') return 0;

        let count = 0;
        // è®¡ç®—åŸºæœ¬å­—æ®µ
        Object.entries(panelConfig).forEach(([key, value]) => {
            if (key !== 'enabled' && key !== 'name' && key !== 'subItems' && value && value.enabled !== false) {
                count++;
            }
        });

        // è®¡ç®—å­é¡¹
        if (panelConfig.subItems && Array.isArray(panelConfig.subItems)) {
            count += panelConfig.subItems.filter(item => item.enabled).length;
        }

        return count;
    }

    /**
     * ğŸ”§ æ–°å¢ï¼šè·å–é¢æ¿å›¾æ ‡
     */
    getPanelIcon(panelId) {
        const iconMap = {
            'character': 'fas fa-user',
            'stats': 'fas fa-chart-bar',
            'inventory': 'fas fa-box',
            'location': 'fas fa-map-marker-alt',
            'relationship': 'fas fa-heart',
            'story': 'fas fa-book',
            'custom': 'fas fa-layer-group',
            'custom1': 'fas fa-cube',
            'custom2': 'fas fa-puzzle-piece',
            'custom3': 'fas fa-star'
        };

        // æ£€æŸ¥panelIdæ˜¯å¦åŒ¹é…è‡ªå®šä¹‰é¢æ¿æ ¼å¼
        if (panelId && panelId.toLowerCase().startsWith('custom')) {
            if (panelId === 'custom') return iconMap['custom'];
            // å¤„ç† custom_xxxxx æ ¼å¼
            if (panelId.includes('_')) {
                return iconMap['custom'];
            }
            // å¤„ç† Custom1, Custom2 ç­‰æ ¼å¼
            const customMatch = panelId.match(/^custom(\d+)$/i);
            if (customMatch) {
                const num = parseInt(customMatch[1]);
                return iconMap[`custom${Math.min(num, 3)}`] || iconMap['custom'];
            }
        }

        return iconMap[panelId] || 'fas fa-layer-group';
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨
     */
    async loadAvailableFieldsList() {
        try {
            const fieldsList = document.querySelector('#available-fields-list');
            if (!fieldsList) return;

            console.log('[InfoBarSettings] ğŸ·ï¸ åŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨...');

            // è·å–å½“å‰æ•°æ®å­—æ®µ
            const dataFields = await this.getCurrentDataFields();

            if (dataFields && Object.keys(dataFields).length > 0) {
                const themeColors = {
                    text: this.getInfoBarThemeColor('text'),
                    textSecondary: this.getInfoBarThemeColor('textSecondary'),
                    accent: this.getInfoBarThemeColor('accent'),
                    background: this.getInfoBarThemeColor('background'),
                    border: this.getInfoBarThemeColor('border')
                };

                let fieldsHTML = '';

                Object.entries(dataFields).forEach(([panelId, fields]) => {
                    if (fields && fields.length > 0) {
                        fieldsHTML += `
                            <div style="margin-bottom: 12px;">
                                <div style="
                                    font-weight: 600;
                                    color: ${themeColors.accent};
                                    font-size: 11px;
                                    margin-bottom: 6px;
                                    padding-bottom: 3px;
                                    border-bottom: 1px solid ${themeColors.border};
                                ">
                                    ${this.getPanelDisplayName(panelId)}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                        `;

                        fields.forEach(field => {
                            fieldsHTML += `
                                <button class="field-insert-btn"
                                        data-insert="{{data.${field}}}"
                                        style="
                                    padding: 2px 6px;
                                    background: transparent;
                                    border: 1px solid ${themeColors.border};
                                    color: ${themeColors.text};
                                    border-radius: 2px;
                                    cursor: pointer;
                                    font-size: 9px;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='${themeColors.accent}'; this.style.color='${themeColors.background}'"
                                   onmouseout="this.style.background='transparent'; this.style.color='${themeColors.text}'">
                                    ${field}
                                </button>
                            `;
                        });

                        fieldsHTML += `
                                </div>
                            </div>
                        `;
                    }
                });

                fieldsList.innerHTML = fieldsHTML;

                // ç»‘å®šå­—æ®µæ’å…¥æŒ‰é’®äº‹ä»¶
                fieldsList.querySelectorAll('.field-insert-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.insertTemplateText(btn.dataset.insert);
                    });
                });

            } else {
                fieldsList.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 20px;
                        color: ${this.getInfoBarThemeColor('textSecondary')};
                        font-size: 11px;
                    ">
                        <i class="fas fa-database" style="margin-bottom: 8px; display: block; font-size: 16px;"></i>
                        æš‚æ— å¯ç”¨æ•°æ®å­—æ®µ<br>
                        <small style="font-size: 9px;">è¯·å…ˆå‘é€AIæ¶ˆæ¯ç”Ÿæˆæ•°æ®</small>
                    </div>
                `;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨å¤±è´¥:', error);
            const fieldsList = document.querySelector('#available-fields-list');
            if (fieldsList) {
                fieldsList.innerHTML = `
                    <div style="color: #FF5722; font-size: 11px; text-align: center; padding: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šè·å–é¢æ¿æ˜¾ç¤ºåç§°
     */
    getPanelDisplayName(panelId) {
        const panelNames = {
            character: 'ğŸ§™â€â™‚ï¸ è§’è‰²ä¿¡æ¯',
            status: 'ğŸ’– çŠ¶æ€æ˜¾ç¤º',
            inventory: 'ğŸ’ ç‰©å“èƒŒåŒ…',
            skills: 'âš¡ æŠ€èƒ½èƒ½åŠ›',
            world: 'ğŸŒ ä¸–ç•Œä¿¡æ¯',
            tasks: 'ğŸ“‹ ä»»åŠ¡ç®¡ç†',
            relationships: 'ğŸ‘¥ äººé™…å…³ç³»',
            lore: 'ğŸ“š ä¼ è¯´å…¸æ•…',
            combat: 'âš”ï¸ æˆ˜æ–—çŠ¶æ€',
            progress: 'ğŸ“ˆ è¿›åº¦è¿½è¸ª'
        };

        return panelNames[panelId] || `ğŸ“Š ${panelId}`;
    }

    /**
     * ğŸš€ æ–°å¢ï¼šç»‘å®šå¿«é€Ÿæ’å…¥äº‹ä»¶
     */
    bindQuickInsertEvents() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // é‡æ–°ç»‘å®šå¿«é€Ÿæ’å…¥æŒ‰é’®
            modal.querySelectorAll('.quick-insert-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.insertTemplateText(btn.dataset.insert);
                });
            });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šå¿«é€Ÿæ’å…¥äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–è¯­æ³•é«˜äº®
     */
    initSyntaxHighlight() {
        try {
            // ç®€å•çš„è¯­æ³•é«˜äº®å®ç°
            console.log('[InfoBarSettings] ğŸ¨ è¯­æ³•é«˜äº®åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è¯­æ³•é«˜äº®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆ‡æ¢è‡ªåŠ¨æ¢è¡Œ
     */
    toggleWordWrap() {
        try {
            const textarea = document.querySelector('.html-template-textarea');
            if (!textarea) return;

            const isWrapped = textarea.style.whiteSpace === 'pre-wrap';
            textarea.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
            textarea.style.overflowWrap = isWrapped ? 'normal' : 'break-word';

            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨æ¢è¡Œå·²', isWrapped ? 'å…³é—­' : 'å¼€å¯');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ‡æ¢è‡ªåŠ¨æ¢è¡Œå¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šå¤„ç†ç¼–è¾‘å™¨é”®ç›˜äº‹ä»¶
     */
    handleEditorKeydown(e) {
        try {
            // Ctrl+S ä¿å­˜
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                this.saveHTMLTemplate();
                return;
            }

            // Ctrl+Shift+F æ ¼å¼åŒ–
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                this.formatTemplate();
                return;
            }

            // Tab é”®æ’å…¥ç©ºæ ¼
            if (e.key === 'Tab') {
                e.preventDefault();
                const textarea = e.target;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;

                textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + 2;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é”®ç›˜äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šè°ƒæ•´ç¼–è¾‘å™¨å¸ƒå±€
     */
    adjustEditorLayout() {
        try {
            const modal = document.querySelector('.html-template-editor-modal');
            if (!modal) return;

            // å“åº”å¼å¸ƒå±€è°ƒæ•´é€»è¾‘
            const container = modal.querySelector('.html-template-editor-container');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (windowWidth < 1200) {
                // å°å±å¹•ä¼˜åŒ–
                container.style.minWidth = '90vw';
                container.style.maxWidth = '95vw';
            } else {
                // æ¢å¤æ­£å¸¸å°ºå¯¸
                container.style.minWidth = '800px';
                container.style.maxWidth = '1600px';
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è°ƒæ•´ç¼–è¾‘å™¨å¸ƒå±€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šç»‘å®šè¯­æ³•å¸®åŠ©äº‹ä»¶
     */
    bindSyntaxHelpEvents() {
        try {
            // è¯­æ³•å¸®åŠ©ç›¸å…³äº‹ä»¶ç»‘å®š
            console.log('[InfoBarSettings] âœ… è¯­æ³•å¸®åŠ©äº‹ä»¶ç»‘å®šå®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šè¯­æ³•å¸®åŠ©äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåŠ è½½æ¨¡æ¿åº“
     */
    loadTemplateLibrary() {
        try {
            // æ¨¡æ¿åº“åŠ è½½é€»è¾‘
            console.log('[InfoBarSettings] âœ… æ¨¡æ¿åº“åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ¨¡æ¿åº“å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ–°å¢ï¼šåˆ›å»ºæ¨¡æ¿åº“ä¿¡æ¯
     */
    createTemplateLibraryInfo() {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        return `
            <div class="template-library-info">
                <div class="template-categories">
                    <h4 style="margin: 0 0 10px 0; color: ${themeColors.accent}; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-layer-group"></i> æ¨¡æ¿åˆ†ç±»
                    </h4>
                    <div style="color: ${themeColors.textSecondary}; font-size: 11px;">
                        æ¨¡æ¿åº“åŠŸèƒ½å¼€å‘ä¸­...
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ å¤„ç†AIåˆ›ä½œçŠ¶æ€æ 
     */
    async handleAICreateStatusBar() {
        try {
            console.log('[InfoBarSettings] ğŸ¤– å¼€å§‹AIåˆ›ä½œçŠ¶æ€æ ...');

            const modal = document.querySelector('.status-bar-editor-modal');
            const aiButton = modal?.querySelector('[data-action="ai-create-status-bar"]');

            if (!aiButton) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = aiButton.innerHTML;
            aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIåˆ›ä½œä¸­...';
            aiButton.disabled = true;

            try {
                // è·å–å½“å‰å¯ç”¨çš„é¢æ¿å’Œæ•°æ®è·å–æ–¹å¼
                const enabledPanels = await this.getEnabledPanelsForAI();
                const dataAccessMethods = await this.generateDataAccessMethods(enabledPanels);

                // æ„å»ºAIåˆ›ä½œæç¤ºè¯
                const prompt = this.buildAICreateStatusBarPrompt(enabledPanels, dataAccessMethods);

                // è°ƒç”¨AIç”ŸæˆçŠ¶æ€æ 
                const generatedStatusBar = await this.callAIForStatusBarCreation(prompt);

                // å°†ç”Ÿæˆçš„çŠ¶æ€æ æ’å…¥åˆ°ç¼–è¾‘å™¨
                const textarea = modal?.querySelector('.html-template-textarea');
                if (textarea && generatedStatusBar) {
                    textarea.value = generatedStatusBar;

                    // æ›´æ–°é¢„è§ˆ
                    this.updateTemplatePreview();
                    this.updateEditorStatus();

                    console.log('[InfoBarSettings] âœ… AIçŠ¶æ€æ åˆ›ä½œå®Œæˆ');
                    this.showNotification('AIçŠ¶æ€æ åˆ›ä½œå®Œæˆï¼', 'success');
                }

            } catch (error) {
                console.error('[InfoBarSettings] âŒ AIåˆ›ä½œçŠ¶æ€æ å¤±è´¥:', error);
                this.showNotification(`AIåˆ›ä½œå¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                aiButton.innerHTML = originalText;
                aiButton.disabled = false;
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIåˆ›ä½œçŠ¶æ€æ å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯ï¼ˆç”¨äºAIï¼‰
     */
    async getEnabledPanelsForAI() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š è·å–å¯ç”¨é¢æ¿ä¿¡æ¯...');

            // ä½¿ç”¨SmartPromptSystemçš„æ–¹æ³•è·å–å¯ç”¨é¢æ¿
            const smartPromptSystem = window.SillyTavernInfobar?.modules?.smartPromptSystem;
            if (smartPromptSystem && typeof smartPromptSystem.getEnabledPanels === 'function') {
                const panels = await smartPromptSystem.getEnabledPanels();
                const enabledPanels = panels.map(panel => ({
                    id: panel.id,
                    name: panel.name || this.getPanelDisplayName(panel.id),
                    config: panel,
                    subItems: (panel.subItems || []).map(subItem => ({
                        key: subItem.key,
                        name: subItem.name || this.getSubItemDisplayName(panel.id, subItem.key),
                        config: subItem
                    }))
                }));

                console.log('[InfoBarSettings] âœ… è·å–åˆ°å¯ç”¨é¢æ¿:', enabledPanels.length, 'ä¸ª');
                return enabledPanels;
            }

            // ğŸ”§ ä¿®å¤ï¼šå¤‡ç”¨æ–¹æ³•ï¼Œä½¿ç”¨ä¸SmartPromptSystemç›¸åŒçš„é€»è¾‘
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            const enabledPanels = [];

            // åŸºç¡€é¢æ¿
            const basicPanelIds = [
                'personal', 'world', 'interaction', 'tasks', 'organization',
                'news', 'inventory', 'abilities', 'plot', 'cultivation',
                'fantasy', 'modern', 'historical', 'magic', 'training'
            ];

            for (const panelId of basicPanelIds) {
                if (configs[panelId]) {
                    const panel = configs[panelId];
                    const isEnabled = panel.enabled !== false; // é»˜è®¤ä¸ºtrueï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse

                    if (isEnabled) {
                        // ğŸ”§ ä¿®å¤ï¼šåŒæ—¶å¤„ç†åŸºç¡€è®¾ç½®å¤é€‰æ¡†å’Œé¢æ¿ç®¡ç†è‡ªå®šä¹‰å­é¡¹
                        const allSubItems = [];

                        // 1. å¤„ç†åŸºç¡€è®¾ç½®ä¸­çš„å¤é€‰æ¡†é…ç½®ï¼ˆpanel[key].enabledæ ¼å¼ï¼‰
                        const subItemKeys = Object.keys(panel).filter(key =>
                            key !== 'enabled' &&
                            key !== 'subItems' &&     // æ’é™¤è‡ªå®šä¹‰å­é¡¹æ•°ç»„
                            key !== 'description' &&  // æ’é™¤é¢æ¿å±æ€§
                            key !== 'icon' &&
                            key !== 'required' &&
                            key !== 'memoryInject' &&
                            key !== 'prompts' &&
                            typeof panel[key] === 'object' &&
                            panel[key].enabled !== undefined
                        );
                        const enabledSubItems = subItemKeys.filter(key => panel[key].enabled === true);

                        // æ·»åŠ åŸºç¡€è®¾ç½®çš„å­é¡¹
                        enabledSubItems.forEach(key => {
                            allSubItems.push({
                                key: key,
                                name: panel[key].name || this.getSubItemDisplayName(panelId, key),
                                enabled: true,
                                value: panel[key].value || '',
                                source: 'basicSettings'
                            });
                        });

                        // 2. å¤„ç†é¢æ¿ç®¡ç†ä¸­çš„è‡ªå®šä¹‰å­é¡¹ï¼ˆpanel.subItemsæ•°ç»„æ ¼å¼ï¼‰
                        let enabledCustomSubItems = [];
                        if (panel.subItems && Array.isArray(panel.subItems)) {
                            enabledCustomSubItems = panel.subItems.filter(subItem => subItem.enabled !== false);

                            // åˆ›å»ºé”®åé›†åˆï¼Œé¿å…é‡å¤æ·»åŠ 
                            const existingKeys = new Set(allSubItems.map(item => item.key));

                            enabledCustomSubItems.forEach(subItem => {
                                const key = subItem.key || subItem.name.toLowerCase().replace(/\s+/g, '_');

                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤
                                if (!existingKeys.has(key)) {
                                    allSubItems.push({
                                        key: key,
                                        name: subItem.displayName || subItem.name,
                                        enabled: true,
                                        value: subItem.value || '',
                                        source: 'panelManagement'
                                    });
                                    existingKeys.add(key);
                                }
                            });
                        }

                        if (allSubItems.length > 0) {
                            enabledPanels.push({
                                id: panelId,
                                name: this.getPanelDisplayName(panelId),
                                config: panel,
                                subItems: allSubItems
                            });
                        }
                    }
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥è‡ªå®šä¹‰é¢æ¿ï¼Œä½¿ç”¨ä¸SmartPromptSystemç›¸åŒçš„é€»è¾‘
            if (configs.customPanels) {
                for (const [panelId, panelConfig] of Object.entries(configs.customPanels)) {
                    if (panelConfig && panelConfig.enabled !== false) { // é»˜è®¤å¯ç”¨ï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºfalse
                        const allSubItems = panelConfig.subItems || [];
                        // åªç»Ÿè®¡å¯ç”¨çš„å­é¡¹
                        const enabledSubItems = allSubItems.filter(subItem => subItem.enabled !== false);

                        // å¤„ç†å¯ç”¨çš„å­é¡¹
                        const processedSubItems = enabledSubItems.map(subItem => {
                            // å¤„ç†ä¸åŒçš„å­é¡¹æ ¼å¼
                            if (typeof subItem === 'string') {
                                return {
                                    key: subItem,
                                    name: subItem,
                                    enabled: true,
                                    value: ''
                                };
                            } else if (subItem && typeof subItem === 'object') {
                                return {
                                    key: subItem.key || subItem.name || subItem.id,
                                    name: subItem.name || subItem.displayName || subItem.key || subItem.id,
                                    enabled: subItem.enabled !== false,
                                    value: subItem.value || ''
                                };
                            }
                            return null;
                        }).filter(Boolean);

                        enabledPanels.push({
                            id: panelId,
                            key: panelConfig.key || panelId, // æ·»åŠ keyå±æ€§
                            type: 'custom',
                            name: panelConfig.name || 'æœªå‘½åé¢æ¿',
                            config: panelConfig,
                            subItems: processedSubItems
                        });
                    }
                }
            }

            console.log('[InfoBarSettings] âœ… è·å–åˆ°å¯ç”¨é¢æ¿:', enabledPanels.length, 'ä¸ª');
            return enabledPanels;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–å¯ç”¨é¢æ¿ä¿¡æ¯å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸš€ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼è¯´æ˜
     */
    async generateDataAccessMethods(enabledPanels) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼è¯´æ˜...');

            const accessMethods = [];

            enabledPanels.forEach(panel => {
                const panelAccess = {
                    panelId: panel.id,
                    panelName: panel.name,
                    accessSyntax: `{{data.${panel.id}.fieldName}}`,
                    availableFields: [],
                    examples: []
                };

                // ä¸ºæ¯ä¸ªå­é¡¹ç”Ÿæˆè®¿é—®ç¤ºä¾‹
                panel.subItems.forEach(subItem => {
                    panelAccess.availableFields.push({
                        key: subItem.key,
                        name: subItem.name,
                        syntax: `{{data.${panel.id}.${subItem.key}}}`
                    });

                    // ç”Ÿæˆç¤ºä¾‹
                    panelAccess.examples.push(
                        `<span class="${panel.id}-${subItem.key}">{{data.${panel.id}.${subItem.key}}}</span>`
                    );
                });

                accessMethods.push(panelAccess);
            });

            console.log('[InfoBarSettings] âœ… æ•°æ®è·å–æ–¹å¼ç”Ÿæˆå®Œæˆ');
            return accessMethods;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆæ•°æ®è·å–æ–¹å¼å¤±è´¥:', error);
            return [];
        }
    }

    /**
     * ğŸš€ æ„å»ºAIåˆ›ä½œçŠ¶æ€æ æç¤ºè¯
     */
    buildAICreateStatusBarPrompt(enabledPanels, dataAccessMethods) {
        const panelSummary = enabledPanels.map(panel =>
            `${panel.name}(${panel.subItems.length}ä¸ªå­—æ®µ)`
        ).join('ã€');

        const dataExamples = dataAccessMethods.map(method => {
            const fieldExamples = method.availableFields.slice(0, 4).map(field =>
                `  ${field.syntax} // ${field.name}`
            ).join('\n');

            return `### ${method.panelName}\n${fieldExamples}`;
        }).join('\n\n');

        return `# çŠ¶æ€æ HTMLç”Ÿæˆä»»åŠ¡

## ä»»åŠ¡ç›®æ ‡
åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„HTMLçŠ¶æ€æ ï¼ŒåŒ…å«CSSæ ·å¼å’Œæ•°æ®ç»‘å®šã€‚

## å¯ç”¨çš„æ•°æ®é¢æ¿
${panelSummary}

## å¯ç”¨æ•°æ®å­—æ®µ
${dataExamples}

## HTMLæ ¼å¼è¦æ±‚
1. **å®Œæ•´HTMLæ–‡æ¡£ç»“æ„**ï¼š
   - å¿…é¡»åŒ…å« <!DOCTYPE html>
   - åŒ…å« <html>, <head>, <body> æ ‡ç­¾
   - åœ¨ <head> ä¸­å®šä¹‰æ‰€æœ‰CSSæ ·å¼

2. **CSSæ ·å¼è§„èŒƒ**ï¼š
   - æ‰€æœ‰æ ·å¼å¿…é¡»å†™åœ¨ <head> å†…çš„ <style> æ ‡ç­¾ä¸­
   - ä¸è¦ä½¿ç”¨å†…è”æ ·å¼ (style="...")
   - ä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸»é¢˜è‰²å½©
   - æ”¯æŒå“åº”å¼è®¾è®¡

3. **æ•°æ®ç»‘å®šè¯­æ³•**ï¼š
   - ä½¿ç”¨ {{data.é¢æ¿å.å­—æ®µå}} æ ¼å¼
   - æ¡ä»¶æ˜¾ç¤ºï¼š{{#if data.å­—æ®µ}}å†…å®¹{{/if}}
   - å¾ªç¯ï¼š{{#each data.æ•°ç»„}}{{this}}{{/each}}

## CSSé¢œè‰²è¦æ±‚
**é‡è¦ï¼šå¿…é¡»ä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼ï¼Œä¸è¦ä½¿ç”¨CSSå˜é‡**
- èƒŒæ™¯æ¸å˜ï¼šlinear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)
- å¡ç‰‡èƒŒæ™¯ï¼šrgba(255, 255, 255, 0.6)
- ä¸»æ–‡å­—è‰²ï¼š#5c2a52
- å¼ºè°ƒè‰²ï¼š#d9538d
- é˜´å½±ï¼š0 8px 32px 0 rgba(240, 128, 128, 0.3)

## è®¾è®¡é£æ ¼
- ç°ä»£åŒ–å¡ç‰‡å¼å¸ƒå±€ï¼Œ16pxåœ†è§’
- ç²‰è‰²ä¸»é¢˜ï¼šä½¿ç”¨ç²‰è‰²ç³»æ¸å˜å’ŒåŠé€æ˜æ•ˆæœ
- å“åº”å¼ç½‘æ ¼å¸ƒå±€
- æ‚¬åœæ•ˆæœï¼štransform: translateY(-8px)
- ä¸è¦ä½¿ç”¨var(--å˜é‡å)ï¼Œç›´æ¥å†™å…·ä½“é¢œè‰²å€¼

## è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºå®Œæ•´çš„HTMLä»£ç ï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ã€‚ä»£ç å¿…é¡»åŒ…å«ï¼š
1. å®Œæ•´çš„HTMLæ–‡æ¡£ç»“æ„
2. <head> ä¸­çš„CSSæ ·å¼å®šä¹‰
3. <body> ä¸­çš„å†…å®¹ç»“æ„
4. æ‰€æœ‰å¯ç”¨é¢æ¿çš„æ•°æ®ç»‘å®š`;
    }

    /**
     * ğŸš€ è°ƒç”¨AIè¿›è¡ŒçŠ¶æ€æ åˆ›ä½œ
     */
    async callAIForStatusBarCreation(prompt) {
        try {
            console.log('[InfoBarSettings] ğŸ¤– è°ƒç”¨AIè¿›è¡ŒçŠ¶æ€æ åˆ›ä½œ...');

            // å¤ç”¨ç°æœ‰çš„AIè°ƒç”¨é€»è¾‘
            const result = await this.callCustomAI(prompt);

            // æ¸…ç†AIè¿”å›çš„å†…å®¹
            const cleanedResult = this.cleanAIResponse(result);

            console.log('[InfoBarSettings] âœ… AIçŠ¶æ€æ åˆ›ä½œå®Œæˆ');
            return cleanedResult;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ AIçŠ¶æ€æ åˆ›ä½œå¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸš€ æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿
     */
    async showDataInfoPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ“Š æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿...');

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanels = await this.getEnabledPanelsForAI();

            // åˆ›å»ºæ•°æ®ä¿¡æ¯å¼¹çª—
            const dataInfoHTML = this.createDataInfoPopup(enabledPanels);

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', dataInfoHTML);

            // ç»‘å®šå…³é—­äº‹ä»¶
            const popup = document.querySelector('.data-info-popup');
            if (popup) {
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        popup.remove();
                    }
                });

                // å…³é—­æŒ‰é’®
                const closeBtn = popup.querySelector('.popup-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        popup.remove();
                    });
                }

                // ESCé”®å…³é—­
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        popup.remove();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
            }

            console.log('[InfoBarSettings] âœ… æ•°æ®ä¿¡æ¯é¢æ¿æ˜¾ç¤ºå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ˜¾ç¤ºæ•°æ®ä¿¡æ¯é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ åˆ›å»ºæ•°æ®ä¿¡æ¯å¼¹çª—
     */
    createDataInfoPopup(enabledPanels) {
        const themeColors = {
            background: this.getInfoBarThemeColor('background'),
            surface: this.getInfoBarThemeColor('surface'),
            border: this.getInfoBarThemeColor('border'),
            text: this.getInfoBarThemeColor('text'),
            textSecondary: this.getInfoBarThemeColor('textSecondary'),
            accent: this.getInfoBarThemeColor('accent')
        };

        // ç”Ÿæˆé¢æ¿ä¿¡æ¯å†…å®¹
        let panelsHTML = '';
        if (enabledPanels.length === 0) {
            panelsHTML = `
                <div style="text-align: center; padding: 40px; color: ${themeColors.textSecondary};">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>å½“å‰æ²¡æœ‰å¯ç”¨çš„é¢æ¿</p>
                    <p style="font-size: 12px;">è¯·å…ˆåœ¨è®¾ç½®ä¸­å¯ç”¨ä¸€äº›é¢æ¿</p>
                </div>
            `;
        } else {
            panelsHTML = enabledPanels.map(panel => {
                const subItemsHTML = panel.subItems.map(subItem => `
                    <div class="data-field-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 12px;
                        background: ${themeColors.surface};
                        border-radius: 6px;
                        margin-bottom: 6px;
                        border: 1px solid ${themeColors.border};
                    ">
                        <div class="field-info">
                            <div class="field-name" style="color: ${themeColors.text}; font-weight: 500;">
                                ${subItem.name}
                            </div>
                            <div class="field-syntax" style="
                                color: ${themeColors.textSecondary};
                                font-size: 11px;
                                font-family: 'Consolas', 'Monaco', monospace;
                                margin-top: 2px;
                            ">
                                {{data.${panel.id}.${subItem.key}}}
                            </div>
                        </div>
                        <button class="copy-syntax-btn" data-syntax="{{data.${panel.id}.${subItem.key}}}" style="
                            background: ${themeColors.accent};
                            color: ${themeColors.background};
                            border: none;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 10px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `).join('');

                return `
                    <div class="panel-section" style="margin-bottom: 24px;">
                        <div class="panel-header" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid ${themeColors.border};
                        ">
                            <h4 style="
                                margin: 0;
                                color: ${themeColors.text};
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <i class="fas fa-database" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                ${panel.name}
                            </h4>
                            <span style="
                                margin-left: auto;
                                background: ${themeColors.accent};
                                color: ${themeColors.background};
                                padding: 2px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: 500;
                            ">
                                ${panel.subItems.length} ä¸ªå­—æ®µ
                            </span>
                        </div>
                        <div class="panel-fields">
                            ${subItemsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }

        return `
            <div class="data-info-popup" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
            ">
                <div class="popup-container" style="
                    width: 100%;
                    max-width: 800px;
                    max-height: 80vh;
                    background: ${themeColors.background};
                    border-radius: 12px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    border: 1px solid ${themeColors.border};
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                ">
                    <div class="popup-header" style="
                        padding: 20px 24px;
                        background: ${themeColors.surface};
                        border-bottom: 1px solid ${themeColors.border};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <h3 style="margin: 0; color: ${themeColors.text}; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-info-circle" style="margin-right: 8px; color: ${themeColors.accent};"></i>
                                æ•°æ®å­—æ®µä¿¡æ¯
                            </h3>
                            <p style="margin: 4px 0 0 0; color: ${themeColors.textSecondary}; font-size: 13px;">
                                å½“å‰å¯ç”¨çš„é¢æ¿å’Œå¯ç”¨æ•°æ®å­—æ®µ
                            </p>
                        </div>
                        <button class="popup-close-btn" style="
                            background: transparent;
                            border: 1px solid ${themeColors.border};
                            color: ${themeColors.textSecondary};
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='${themeColors.surface}'; this.style.color='${themeColors.text}'"
                           onmouseout="this.style.background='transparent'; this.style.color='${themeColors.textSecondary}'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="popup-body" style="
                        flex: 1;
                        padding: 20px 24px;
                        overflow-y: auto;
                    ">
                        ${panelsHTML}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * ğŸš€ è·å–å­é¡¹æ˜¾ç¤ºåç§°
     */
    getSubItemDisplayName(panelId, subItemKey) {
        // ä½¿ç”¨ç°æœ‰çš„å­—æ®µæ˜ å°„é€»è¾‘
        const fieldMappings = this.getFieldMappings();
        const panelMappings = fieldMappings[panelId];

        if (panelMappings && panelMappings[subItemKey]) {
            return panelMappings[subItemKey];
        }

        // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œè¿”å›æ ¼å¼åŒ–çš„key
        return subItemKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    }

    /**
     * ğŸš€ ç»‘å®šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶
     */
    bindPromptEditorEvents(modal) {
        try {
            // ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶
            if (modal.dataset.promptEventsbound === 'true') {
                console.log('[InfoBarSettings] âš ï¸ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }

            // æç¤ºè¯æ¨¡æ¿æŒ‰é’®
            modal.querySelectorAll('.prompt-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.insertPromptTemplate(btn.dataset.template);
                });
            });

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æŒ‰é’® - æ·»åŠ é˜²é‡å¤ç‚¹å‡»
            const usePromptBtn = modal.querySelector('[data-action="use-custom-prompt"]');
            if (usePromptBtn) {
                usePromptBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // ğŸ”§ é˜²æ­¢é‡å¤ç‚¹å‡»
                    if (usePromptBtn.disabled || usePromptBtn.dataset.processing === 'true') {
                        console.log('[InfoBarSettings] âš ï¸ AIç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                        return;
                    }

                    await this.useCustomPrompt();
                });
            }

            // æ ‡è®°äº‹ä»¶å·²ç»‘å®š
            modal.dataset.promptEventsbound = 'true';
            console.log('[InfoBarSettings] âœ… çŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šçŠ¶æ€æ æç¤ºè¯ç¼–è¾‘å™¨äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ’å…¥æç¤ºè¯æ¨¡æ¿
     */
    insertPromptTemplate(templateType) {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const textarea = modal?.querySelector('.prompt-textarea');
            if (!textarea) return;

            const templates = {
                character: 'åˆ›å»ºè§’è‰²çŠ¶æ€æ ï¼šå¤´åƒã€å§“åã€ç­‰çº§ã€ç”Ÿå‘½å€¼ï¼Œä½¿ç”¨ç²‰è‰²æ¸å˜èƒŒæ™¯#fff0f5åˆ°#ffe4e1ï¼Œå¡ç‰‡èƒŒæ™¯rgba(255,255,255,0.6)ï¼Œæ–‡å­—è‰²#5c2a52',
                inventory: 'è®¾è®¡ç‰©å“æ ç•Œé¢ï¼šç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºç‰©å“å›¾æ ‡ã€åç§°ã€æ•°é‡ï¼Œä½¿ç”¨å…·ä½“é¢œè‰²å€¼ä¸ç”¨CSSå˜é‡ï¼Œç²‰è‰²ä¸»é¢˜',
                stats: 'åˆ¶ä½œå±æ€§é¢æ¿ï¼šåŠ›é‡ã€æ•æ·ã€æ™ºåŠ›ç­‰æ•°å€¼ï¼Œå¸¦è¿›åº¦æ¡ï¼Œä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼#d9538dä½œä¸ºå¼ºè°ƒè‰²',
                modern: 'ç°ä»£åŒ–çŠ¶æ€æ ï¼šæ¸å˜èƒŒæ™¯linear-gradient(135deg,#fff0f5,#ffe4e1)ï¼Œåœ†è§’16pxï¼Œé˜´å½±rgba(240,128,128,0.3)ï¼Œä¸ä½¿ç”¨var()å˜é‡',
                minimal: 'ç®€çº¦çŠ¶æ€æ ï¼šæ¸…çˆ½å¸ƒå±€ï¼Œç›´æ¥ä½¿ç”¨å…·ä½“é¢œè‰²å€¼ï¼ŒèƒŒæ™¯#fff0f5ï¼Œæ–‡å­—#5c2a52ï¼Œå¼ºè°ƒè‰²#d9538d'
            };

            const template = templates[templateType];
            if (template) {
                textarea.value = template;
                textarea.focus();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ’å…¥æç¤ºè¯æ¨¡æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯è¿›è¡ŒAIåˆ›ä½œ
     */
    async useCustomPrompt() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const promptTextarea = modal?.querySelector('.prompt-textarea');
            const usePromptBtn = modal?.querySelector('[data-action="use-custom-prompt"]');

            if (!promptTextarea || !usePromptBtn) {
                console.warn('[InfoBarSettings] âš ï¸ æœªæ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šå¼ºåŒ–é˜²é‡å¤ç‚¹å‡»æœºåˆ¶
            if (usePromptBtn.disabled || usePromptBtn.dataset.processing === 'true') {
                console.log('[InfoBarSettings] âš ï¸ AIç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                return;
            }

            const customPrompt = promptTextarea.value.trim();
            if (!customPrompt) {
                this.showNotification('è¯·è¾“å…¥æç¤ºè¯å†…å®¹', 'warning');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®å¤„ç†çŠ¶æ€æ ‡è®°
            usePromptBtn.dataset.processing = 'true';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = usePromptBtn.innerHTML;
            usePromptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIç”Ÿæˆä¸­...';
            usePromptBtn.disabled = true;

            console.log('[InfoBarSettings] ğŸš€ å¼€å§‹AIç”Ÿæˆï¼Œæç¤ºè¯é•¿åº¦:', customPrompt.length);

            try {
                // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
                const enabledPanels = await this.getEnabledPanelsForAI();
                const dataAccessMethods = await this.generateDataAccessMethods(enabledPanels);

                // æ„å»ºå¢å¼ºçš„AIæç¤ºè¯
                const enhancedPrompt = this.buildEnhancedAIPrompt(customPrompt, enabledPanels, dataAccessMethods);

                // è°ƒç”¨AIç”ŸæˆçŠ¶æ€æ 
                const generatedStatusBar = await this.callAIForStatusBarCreation(enhancedPrompt);

                // å°†ç”Ÿæˆçš„çŠ¶æ€æ æ’å…¥åˆ°ç¼–è¾‘å™¨
                const htmlTextarea = modal?.querySelector('.html-template-textarea');
                if (htmlTextarea && generatedStatusBar) {
                    htmlTextarea.value = generatedStatusBar;

                    // æ›´æ–°é¢„è§ˆ
                    this.updateTemplatePreview();
                    this.updateEditorStatus();

                    console.log('[InfoBarSettings] âœ… è‡ªå®šä¹‰æç¤ºè¯AIåˆ›ä½œå®Œæˆ');
                    this.showNotification('AIçŠ¶æ€æ åˆ›ä½œå®Œæˆï¼', 'success');
                }

            } catch (error) {
                console.error('[InfoBarSettings] âŒ è‡ªå®šä¹‰æç¤ºè¯AIåˆ›ä½œå¤±è´¥:', error);

                // ğŸ”§ ä¿®å¤ï¼šæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = error.message;
                if (error.message.includes('APIè¯·æ±‚å¤±è´¥')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®';
                } else if (error.message.includes('æœªå¯ç”¨') || error.message.includes('æœªé…ç½®')) {
                    errorMessage = 'è¯·å…ˆåœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®AI API';
                }

                this.showNotification(`AIç”Ÿæˆå¤±è´¥: ${errorMessage}`, 'error');
            } finally {
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿çŠ¶æ€å®Œå…¨æ¢å¤
                if (usePromptBtn) {
                    usePromptBtn.innerHTML = originalText;
                    usePromptBtn.disabled = false;
                    usePromptBtn.dataset.processing = 'false';
                }
                console.log('[InfoBarSettings] ğŸ”„ AIç”Ÿæˆæµç¨‹ç»“æŸï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ æ„å»ºå¢å¼ºçš„AIæç¤ºè¯
     */
    buildEnhancedAIPrompt(userPrompt, enabledPanels, dataAccessMethods) {
        const panelSummary = enabledPanels.map(panel =>
            `${panel.name}(${panel.subItems.length}ä¸ªå­—æ®µ)`
        ).join('ã€');

        const dataExamples = dataAccessMethods.map(method => {
            const fieldExamples = method.availableFields.slice(0, 4).map(field =>
                `  ${field.syntax} // ${field.name}`
            ).join('\n');

            return `### ${method.panelName}\n${fieldExamples}`;
        }).join('\n\n');

        return `# è‡ªå®šä¹‰çŠ¶æ€æ HTMLç”Ÿæˆ

## ç”¨æˆ·éœ€æ±‚
${userPrompt}

## å¯ç”¨æ•°æ®é¢æ¿
${panelSummary}

## æ•°æ®å­—æ®µè¯­æ³•
${dataExamples}

## HTMLç»“æ„è¦æ±‚
1. **å®Œæ•´HTMLæ–‡æ¡£**ï¼š
   - åŒ…å« <!DOCTYPE html>, <html>, <head>, <body>
   - æ‰€æœ‰CSSå†™åœ¨ <head> çš„ <style> æ ‡ç­¾å†…
   - ä¸ä½¿ç”¨å†…è”æ ·å¼

2. **CSSé¢œè‰²è§„èŒƒ**ï¼š
   **ç¦æ­¢ä½¿ç”¨CSSå˜é‡ï¼Œå¿…é¡»ä½¿ç”¨ç¡¬ç¼–ç é¢œè‰²å€¼**
   - èƒŒæ™¯ï¼šlinear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)
   - å¡ç‰‡ï¼šrgba(255, 255, 255, 0.6)
   - æ–‡å­—ï¼š#5c2a52
   - å¼ºè°ƒï¼š#d9538d
   - é˜´å½±ï¼šrgba(240, 128, 128, 0.3)

3. **æ•°æ®ç»‘å®š**ï¼š
   - {{data.é¢æ¿å.å­—æ®µå}}
   - {{#if data.å­—æ®µ}}æ¡ä»¶å†…å®¹{{/if}}

## è®¾è®¡é£æ ¼
- ç²‰è‰²ä¸»é¢˜å¡ç‰‡å¸ƒå±€ï¼Œ16pxåœ†è§’
- ç›´æ¥ä½¿ç”¨å…·ä½“é¢œè‰²å€¼ï¼Œä¸ç”¨var()
- å“åº”å¼ç½‘æ ¼å¸ƒå±€
- æ‚¬åœæ•ˆæœï¼štranslateY(-8px)

ç›´æ¥è¾“å‡ºå®Œæ•´HTMLä»£ç ï¼Œæ— éœ€è§£é‡Šã€‚

## ğŸ”§ æŠ€æœ¯è§„èŒƒ
- ä½¿ç”¨å†…è”CSSæ ·å¼
- æ•°æ®ç»‘å®šè¯­æ³•: {{data.panelId.fieldName}}
- æ¡ä»¶æ˜¾ç¤º: {{#if data.field}}å†…å®¹{{/if}}
- å¾ªç¯æ¸²æŸ“: {{#each data.array}}{{this}}{{/each}}
- å›¾æ ‡ç±»å: fas fa-icon-name

## ğŸ“ è¾“å‡ºè¦æ±‚
è¯·ç›´æ¥è¾“å‡ºå®Œæ•´çš„HTMLä»£ç ï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„HTMLç»“æ„
- å†…è”CSSæ ·å¼
- æ‰€æœ‰å¯ç”¨é¢æ¿çš„æ•°æ®ç»‘å®š
- ç°ä»£åŒ–çš„è§†è§‰è®¾è®¡
- å“åº”å¼å¸ƒå±€

ä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ–‡å­—ï¼Œç›´æ¥è¾“å‡ºHTMLä»£ç ã€‚`;
    }

    /**
     * ğŸš€ åŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨
     */
    async loadDataFieldsToPromptEditor() {
        try {
            const modal = document.querySelector('.status-bar-editor-modal');
            const fieldsList = modal?.querySelector('.data-fields-list');
            if (!fieldsList) return;

            // è·å–å¯ç”¨çš„é¢æ¿ä¿¡æ¯
            const enabledPanels = await this.getEnabledPanelsForAI();

            if (enabledPanels.length === 0) {
                fieldsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #aaa);">
                        <i class="fas fa-info-circle" style="margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>å½“å‰æ²¡æœ‰å¯ç”¨çš„é¢æ¿</p>
                    </div>
                `;
                return;
            }

            // ç”Ÿæˆå­—æ®µåˆ—è¡¨HTML
            const fieldsHTML = enabledPanels.map(panel => {
                const fieldsItems = panel.subItems.map(subItem => `
                    <div class="field-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0px 4px;
                        margin-bottom: 0px;
                        border-radius: 2px;
                        background: var(--theme-surface, #2a2a2a);
                        border: 1px solid var(--theme-border, #444);
                        min-height: 16px;
                        line-height: 1.0;
                        height: 16px;
                    ">
                        <span style="color: var(--theme-text, #fff); font-size: 9px; line-height: 1.0;">
                            ${subItem.name}
                        </span>
                        <code style="
                            color: var(--theme-accent, #007bff);
                            font-size: 8px;
                            font-family: 'Consolas', 'Monaco', monospace;
                            line-height: 1.0;
                        ">
                            {{data.${panel.id}.${subItem.key}}}
                        </code>
                    </div>
                `).join('');

                return `
                    <div class="panel-group" style="margin-bottom: 1px;">
                        <div class="panel-title" style="
                            color: var(--theme-accent, #007bff);
                            font-size: 10px;
                            font-weight: 600;
                            margin-bottom: 0px;
                            padding: 0px 4px;
                            background: var(--theme-background, #1a1a1a);
                            border-radius: 3px;
                            line-height: 1.1;
                            height: 16px;
                            display: flex;
                            align-items: center;
                        ">
                            <i class="fas fa-database" style="margin-right: 3px; font-size: 10px;"></i>
                            ${panel.name}
                        </div>
                        ${fieldsItems}
                    </div>
                `;
            }).join('');

            fieldsList.innerHTML = fieldsHTML;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æ•°æ®å­—æ®µåˆ°æç¤ºè¯ç¼–è¾‘å™¨å¤±è´¥:', error);
            const fieldsList = document.querySelector('.data-fields-list');
            if (fieldsList) {
                fieldsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-secondary, #aaa);">
                        <i class="fas fa-exclamation-triangle" style="margin-bottom: 8px; color: #ff6b6b;"></i>
                        <p>åŠ è½½æ•°æ®å­—æ®µå¤±è´¥</p>
                    </div>
                `;
            }
        }
    }

    /**
     * @deprecated ä¿æŒå‘åå…¼å®¹æ€§
     */
    createHTMLTemplateEditorHTML() {
        return this.createStatusBarEditorHTML();
    }

    // ==================== ğŸ†• ä¸–ç•Œä¹¦é…ç½®ç›¸å…³æ–¹æ³• ====================

    /**
     * åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿
     */
    async initWorldBookConfigPanel() {
        try {
            console.log('[InfoBarSettings] ğŸ“š åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿...');

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
            if (this.worldBookConfigPanelInitialized) {
                console.log('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦é…ç½®é¢æ¿å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }

            // è·å–ä¸–ç•Œä¹¦ç®¡ç†å™¨å¼•ç”¨
            this.worldBookManager = window.SillyTavernInfobar?.modules?.worldBookManager;
            this.worldBookConfigPanel = window.SillyTavernInfobar?.modules?.worldBookConfigPanel;

            if (!this.worldBookManager || !this.worldBookConfigPanel) {
                console.warn('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦ç®¡ç†å™¨æˆ–é…ç½®é¢æ¿æœªæ‰¾åˆ°');
                return;
            }

            // è·å–ä¸–ç•Œä¹¦é…ç½®å®¹å™¨
            const container = this.modal.querySelector('#worldbook-config-container');
            if (!container) {
                console.warn('[InfoBarSettings] âš ï¸ ä¸–ç•Œä¹¦é…ç½®å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šæ¸…ç†å®¹å™¨å†…å®¹ï¼Œé¿å…é‡å¤æ¸²æŸ“
            container.innerHTML = '';

            // æ¸²æŸ“ä¸–ç•Œä¹¦é…ç½®é¢æ¿
            await this.worldBookConfigPanel.render(container);

            // ç»‘å®šä¸–ç•Œä¹¦å¤é€‰æ¡†äº‹ä»¶
            this.bindWorldBookEvents();

            // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
            this.worldBookConfigPanelInitialized = true;

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦é…ç½®é¢æ¿åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–ä¸–ç•Œä¹¦é…ç½®é¢æ¿å¤±è´¥:', error);
        }
    }

    /**
     * ç»‘å®šä¸–ç•Œä¹¦ç›¸å…³äº‹ä»¶
     */
    bindWorldBookEvents() {
        try {
            // ç»‘å®šä¸–ç•Œä¹¦å¯ç”¨å¤é€‰æ¡†äº‹ä»¶
            const worldBookCheckbox = this.modal.querySelector('#api-include-worldbook');
            if (worldBookCheckbox) {
                worldBookCheckbox.addEventListener('change', (e) => {
                    this.handleWorldBookToggle(e.target.checked);
                });

                // åˆå§‹çŠ¶æ€æ£€æŸ¥
                this.handleWorldBookToggle(worldBookCheckbox.checked);
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šä¸–ç•Œä¹¦äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†ä¸–ç•Œä¹¦å¯ç”¨/ç¦ç”¨åˆ‡æ¢
     */
    handleWorldBookToggle(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ“š ä¸–ç•Œä¹¦åŠŸèƒ½', enabled ? 'å¯ç”¨' : 'ç¦ç”¨');

            // æ˜¾ç¤º/éšè—ä¸–ç•Œä¹¦é…ç½®é¢æ¿
            const configSection = this.modal.querySelector('.worldbook-config-section');
            if (configSection) {
                configSection.style.display = enabled ? 'block' : 'none';
            }

            // å¦‚æœå¯ç”¨ä¸–ç•Œä¹¦ï¼Œç¡®ä¿é…ç½®é¢æ¿å·²åˆå§‹åŒ–
            if (enabled && this.worldBookConfigPanel) {
                this.worldBookConfigPanel.show();
            } else if (this.worldBookConfigPanel) {
                this.worldBookConfigPanel.hide();
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ä¸–ç•Œä¹¦åˆ‡æ¢å¤±è´¥:', error);
        }
    }

    /**
     * è·å–ä¸–ç•Œä¹¦é…ç½®çŠ¶æ€
     */
    getWorldBookConfigStatus() {
        try {
            if (!this.worldBookManager || !this.worldBookConfigPanel) {
                return {
                    available: false,
                    enabled: false,
                    error: 'ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåˆå§‹åŒ–'
                };
            }

            const worldBookCheckbox = this.modal.querySelector('#api-include-worldbook');
            const enabled = worldBookCheckbox ? worldBookCheckbox.checked : false;

            return {
                available: true,
                enabled: enabled,
                config: this.worldBookManager.config,
                panelStatus: this.worldBookConfigPanel.getStatus()
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦é…ç½®çŠ¶æ€å¤±è´¥:', error);
            return {
                available: false,
                enabled: false,
                error: error.message
            };
        }
    }

    /**
     * æ›´æ–°ä¸–ç•Œä¹¦é…ç½®
     */
    async updateWorldBookConfig(config) {
        try {
            console.log('[InfoBarSettings] ğŸ“š æ›´æ–°ä¸–ç•Œä¹¦é…ç½®...');

            if (!this.worldBookManager) {
                throw new Error('ä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }

            // æ›´æ–°é…ç½®
            Object.assign(this.worldBookManager.config, config);

            // ä¿å­˜é…ç½®
            await this.worldBookManager.saveConfig();

            // åˆ·æ–°é…ç½®é¢æ¿
            if (this.worldBookConfigPanel) {
                await this.worldBookConfigPanel.refreshData();
            }

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦é…ç½®æ›´æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°ä¸–ç•Œä¹¦é…ç½®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ğŸš€ å¤„ç†AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleAIMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—AIè®°å¿†é€‰é¡¹
            const aiMemoryOptions = this.modal.querySelectorAll('.ai-memory-options');
            aiMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    enabled: enabled
                });
            }

            this.showMessage(
                enabled ? 'âœ… AIè®°å¿†æ€»ç»“å·²å¯ç”¨' : 'âŒ AIè®°å¿†æ€»ç»“å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†AIè®°å¿†æ€»ç»“å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†æ¶ˆæ¯çº§åˆ«æ€»ç»“å˜åŒ–
     */
    handleAIMessageLevelChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ“ æ¶ˆæ¯çº§åˆ«æ€»ç»“çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    messageLevelSummary: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ¶ˆæ¯çº§åˆ«æ€»ç»“å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†é‡è¦æ€§é˜ˆå€¼å˜åŒ–
     */
    handleAIImportanceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ é‡è¦æ€§é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-ai-importance-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°AIè®°å¿†æ€»ç»“å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            if (summaryManager && summaryManager.aiMemorySummarizer) {
                summaryManager.aiMemorySummarizer.updateSettings({
                    importanceThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é‡è¦æ€§é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†ç­›é€‰æ ‡ç­¾ç‚¹å‡»
     */
    handleFilterTabClick(filter) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç­›é€‰æ ‡ç­¾ç‚¹å‡»:', filter);

            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            const filterTabs = this.modal.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                    tab.style.color = 'var(--SmartThemeEmColor, #ff6b6b)';
                    tab.style.borderBottomColor = 'var(--SmartThemeEmColor, #ff6b6b)';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = 'var(--SmartThemeQuoteColor, #888)';
                    tab.style.borderBottomColor = 'transparent';
                }
            });

            // ç­›é€‰æ€»ç»“å†å²
            this.filterSummaryHistory(filter);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç­›é€‰æ ‡ç­¾ç‚¹å‡»å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ç­›é€‰æ€»ç»“å†å²
     */
    async filterSummaryHistory(filter) {
        try {
            console.log('[InfoBarSettings] ğŸ” ç­›é€‰æ€»ç»“å†å²:', filter);

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                console.warn('[InfoBarSettings] âš ï¸ SummaryManageræœªæ‰¾åˆ°');
                return;
            }

            // è·å–å¢å¼ºçš„æ€»ç»“å†å²
            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            console.log('[InfoBarSettings] ğŸ“š è·å–åˆ°æ€»ç»“å†å²:', allSummaries.length, 'æ¡');

            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤
            let filteredSummaries = allSummaries;
            if (filter !== 'all') {
                filteredSummaries = allSummaries.filter(summary => {
                    // æ ¹æ®ä¸åŒçš„ç­›é€‰æ¡ä»¶è¿›è¡Œè¿‡æ»¤
                    switch (filter) {
                        case 'traditional':
                            // ä¼ ç»Ÿæ€»ç»“ï¼šåŒ…æ‹¬å°æ€»ç»“ã€å¤§æ€»ç»“ã€æ‰‹åŠ¨æ€»ç»“ã€è‡ªåŠ¨æ€»ç»“
                            return summary.source === 'traditional' ||
                                   summary.type === 'small' ||
                                   summary.type === 'large' ||
                                   summary.type === 'manual' ||
                                   summary.type === 'auto' ||
                                   !summary.source; // æ²¡æœ‰sourceå­—æ®µçš„é»˜è®¤ä¸ºä¼ ç»Ÿæ€»ç»“
                        case 'ai_memory':
                            // AIè®°å¿†æ€»ç»“ï¼šæ¥è‡ªAIè®°å¿†æ€»ç»“å™¨çš„æ€»ç»“
                            return summary.source === 'ai_memory_summarizer' ||
                                   summary.type === 'ai_memory';
                        default:
                            return true;
                    }
                });
            }

            console.log('[InfoBarSettings] ğŸ” ç­›é€‰åçš„æ€»ç»“:', filteredSummaries.length, 'æ¡');

            // æ›´æ–°æ˜¾ç¤º
            this.renderSummaryHistory(filteredSummaries);

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç­›é€‰æ€»ç»“å†å²å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶
     */
    bindWorldBookUploadEvents() {
        try {
            console.log('[InfoBarSettings] ğŸ”— ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶...');

            // æ¡ç›®å‘½åæ ¼å¼å˜åŒ–äº‹ä»¶
            const entryFormatSelect = this.modal.querySelector('#worldbook-entry-format');
            const customNameRow = this.modal.querySelector('#worldbook-custom-name-row');

            if (entryFormatSelect && customNameRow) {
                entryFormatSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        customNameRow.style.display = 'block';
                    } else {
                        customNameRow.style.display = 'none';
                    }
                });
            }

            // æ‰¹é‡ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            const batchUploadBtn = this.modal.querySelector('#worldbook-batch-upload-btn');
            if (batchUploadBtn) {
                batchUploadBtn.addEventListener('click', async () => {
                    await this.handleBatchUploadToWorldBook();
                });
            }

            console.log('[InfoBarSettings] âœ… ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸš€ å¤„ç†å•ä¸ªæ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦
     */
    async handleUploadSummaryToWorldBook() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¤„ç†å•ä¸ªæ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦...');

            // è·å–é€‰ä¸­çš„æ€»ç»“ID
            const historySelect = this.modal.querySelector('#content-summary-history-select');
            const summaryId = historySelect?.value;

            if (!summaryId) {
                this.showNotification('è¯·å…ˆé€‰æ‹©ä¸€æ¡æ€»ç»“è®°å½•', 'info');
                return;
            }

            // è·å–ä¸Šä¼ é…ç½®
            const uploadOptions = this.getWorldBookUploadOptions();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.showNotification('æ­£åœ¨ä¸Šä¼ æ€»ç»“åˆ°ä¸–ç•Œä¹¦...', 'info');

            // è·å–SummaryManager
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('SummaryManageræœªåˆå§‹åŒ–');
            }

            // æ‰§è¡Œä¸Šä¼ 
            const result = await summaryManager.uploadSummaryToWorldBook(summaryId, uploadOptions);

            if (result.success) {
                this.showNotification(`âœ… ${result.message}`, 'success');

                // åˆ·æ–°æ€»ç»“å†å²æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                await this.loadSummaryHistory();

                // é‡æ–°é€‰ä¸­å½“å‰æ€»ç»“
                if (historySelect) {
                    historySelect.value = summaryId;
                    this.showSummaryContent(summaryId);
                }
            } else {
                this.showNotification(`âŒ ${result.message}`, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¸Šä¼ æ€»ç»“åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
            this.showNotification(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    /**
     * ğŸš€ å¤„ç†æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦
     */
    async handleBatchUploadToWorldBook() {
        try {
            console.log('[InfoBarSettings] ğŸ“¤ å¤„ç†æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦...');

            // ç¡®è®¤æ“ä½œ
            const confirmed = confirm('ç¡®å®šè¦å°†å½“å‰èŠå¤©çš„æ‰€æœ‰æ€»ç»“ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦å—ï¼Ÿ\n\nè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');
            if (!confirmed) {
                return;
            }

            // è·å–æ‰€æœ‰æ€»ç»“
            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;

            if (!summaryManager) {
                throw new Error('SummaryManageræœªåˆå§‹åŒ–');
            }

            const allSummaries = await summaryManager.getEnhancedSummaryHistory();
            if (!allSummaries || allSummaries.length === 0) {
                this.showNotification('å½“å‰èŠå¤©æ²¡æœ‰æ€»ç»“è®°å½•', 'info');
                return;
            }

            // è·å–ä¸Šä¼ é…ç½®
            const uploadOptions = this.getWorldBookUploadOptions();

            // æ˜¾ç¤ºè¿›åº¦
            this.showNotification(`å¼€å§‹æ‰¹é‡ä¸Šä¼  ${allSummaries.length} æ¡æ€»ç»“...`, 'info');

            // æå–æ‰€æœ‰æ€»ç»“ID
            const summaryIds = allSummaries.map(s => s.id);

            // æ‰§è¡Œæ‰¹é‡ä¸Šä¼ 
            const result = await summaryManager.batchUploadSummariesToWorldBook(summaryIds, uploadOptions);

            if (result.success) {
                const { success, failed, total } = result.results;
                this.showNotification(`âœ… æ‰¹é‡ä¸Šä¼ å®Œæˆ: ${success.length}/${total} æˆåŠŸ${failed.length > 0 ? `, ${failed.length} å¤±è´¥` : ''}`, 'success');

                // åˆ·æ–°æ€»ç»“å†å²
                await this.loadSummaryHistory();
            } else {
                this.showNotification(`âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥: ${result.message}`, 'error');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ‰¹é‡ä¸Šä¼ åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
            this.showNotification(`âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    /**
     * ğŸ”§ è·å–ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®é€‰é¡¹
     */
    getWorldBookUploadOptions() {
        try {
            const entryFormat = this.modal.querySelector('#worldbook-entry-format')?.value || 'auto';
            const customName = this.modal.querySelector('#worldbook-custom-name')?.value || '';
            const addTimestamp = this.modal.querySelector('#worldbook-add-timestamp')?.checked !== false;
            const useContentTags = this.modal.querySelector('#worldbook-use-tags')?.checked !== false;

            return {
                autoCreateWorldBook: true,
                bindToChatLore: true,
                entryNameFormat: entryFormat,
                customEntryName: entryFormat === 'custom' ? customName : null,
                addTimestamp: addTimestamp,
                useContentTags: useContentTags
            };

        } catch (error) {
            console.error('[InfoBarSettings] âŒ è·å–ä¸–ç•Œä¹¦ä¸Šä¼ é…ç½®å¤±è´¥:', error);
            return {
                autoCreateWorldBook: true,
                bindToChatLore: true,
                entryNameFormat: 'auto',
                customEntryName: null,
                addTimestamp: true,
                useContentTags: true
            };
        }
    }

    /**
     * ğŸ” å¤„ç†å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleVectorizedMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ” å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—å‘é‡åŒ–è®°å¿†é€‰é¡¹
            const vectorizedMemoryOptions = this.modal.querySelectorAll('.vectorized-memory-options');
            vectorizedMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    enabled: enabled
                });
            }

            this.showMessage(
                enabled ? 'âœ… è¯­ä¹‰æœç´¢å·²å¯ç”¨' : 'âŒ è¯­ä¹‰æœç´¢å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡åŒ–è®°å¿†æ£€ç´¢å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ” å¤„ç†å‘é‡åŒ–å¼•æ“å˜åŒ–
     */
    handleVectorEngineChange(engine) {
        try {
            console.log('[InfoBarSettings] ğŸš€ å‘é‡åŒ–å¼•æ“å˜åŒ–:', engine);

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    vectorEngine: engine
                });
            }

            this.showMessage(
                `âœ… å‘é‡åŒ–å¼•æ“å·²åˆ‡æ¢ä¸º: ${engine === 'transformers' ? 'Transformers.js (æœ¬åœ°)' : 'OpenAI (åœ¨çº¿)'}`,
                'success'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†å‘é‡åŒ–å¼•æ“å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ” å¤„ç†ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–
     */
    handleSimilarityThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-similarity-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    similarityThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†ç›¸ä¼¼åº¦é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ” å¤„ç†æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–
     */
    handleMaxSearchResultsChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ“Š æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–:', value);

            // æ›´æ–°å‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿè®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const vectorizedMemoryRetrieval = infoBarTool?.modules?.vectorizedMemoryRetrieval;
            if (vectorizedMemoryRetrieval) {
                vectorizedMemoryRetrieval.updateSettings({
                    maxResults: parseInt(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æœ€å¤§æœç´¢ç»“æœæ•°é‡å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleDeepMemoryEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—æ·±åº¦è®°å¿†é€‰é¡¹
            const deepMemoryOptions = this.modal.querySelectorAll('.deep-memory-options');
            deepMemoryOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    enabled: enabled
                });
            }

            this.showMessage(
                enabled ? 'âœ… æ·±åº¦è®°å¿†ç®¡ç†å·²å¯ç”¨' : 'âŒ æ·±åº¦è®°å¿†ç®¡ç†å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ·±åº¦è®°å¿†ç®¡ç†å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è‡ªåŠ¨è®°å¿†è¿ç§»å˜åŒ–
     */
    handleAutoMemoryMigrationChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”„ è‡ªåŠ¨è®°å¿†è¿ç§»çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    autoMemoryMigration: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªåŠ¨è®°å¿†è¿ç§»å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–
     */
    handleMemoryImportanceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-memory-importance-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    shortTermToLongTermThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†é‡è¦æ€§é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†å†²çªè§£å†³å˜åŒ–
     */
    handleMemoryConflictResolutionChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ”§ è®°å¿†å†²çªè§£å†³çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    memoryConflictResolution: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†å†²çªè§£å†³å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¤„ç†è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–
     */
    handleMemoryCapacityChange(inputId, value) {
        try {
            console.log('[InfoBarSettings] ğŸ“Š è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–:', inputId, value);

            const capacityMap = {
                'content-sensory-capacity': 'sensoryMemoryCapacity',
                'content-short-term-capacity': 'shortTermMemoryCapacity',
                'content-long-term-capacity': 'longTermMemoryCapacity',
                'content-deep-archive-capacity': 'deepArchiveCapacity'
            };

            const settingKey = capacityMap[inputId];
            if (!settingKey) return;

            // æ›´æ–°æ·±åº¦è®°å¿†ç®¡ç†å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const deepMemoryManager = infoBarTool?.modules?.deepMemoryManager;
            if (deepMemoryManager) {
                deepMemoryManager.updateSettings({
                    [settingKey]: parseInt(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è®°å¿†å®¹é‡è®¾ç½®å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–
     */
    handleIntelligentClassifierEnabledChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–:', enabled);

            // æ˜¾ç¤º/éšè—æ™ºèƒ½åˆ†ç±»å™¨é€‰é¡¹
            const intelligentClassifierOptions = this.modal.querySelectorAll('.intelligent-classifier-options');
            intelligentClassifierOptions.forEach(option => {
                option.style.display = enabled ? 'block' : 'none';
            });

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    enabled: enabled
                });
            }

            this.showMessage(
                enabled ? 'âœ… æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å·²å¯ç”¨' : 'âŒ æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å·²ç¦ç”¨',
                enabled ? 'success' : 'info'
            );

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨å¯ç”¨çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†è¯­ä¹‰èšç±»åˆ†æå˜åŒ–
     */
    handleSemanticClusteringChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ” è¯­ä¹‰èšç±»åˆ†æçŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    semanticClustering: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è¯­ä¹‰èšç±»åˆ†æå˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†æ—¶åºæ¨¡å¼è¯†åˆ«å˜åŒ–
     */
    handleTemporalPatternRecognitionChange(enabled) {
        try {
            console.log('[InfoBarSettings] â° æ—¶åºæ¨¡å¼è¯†åˆ«çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    temporalPatternRecognition: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æ—¶åºæ¨¡å¼è¯†åˆ«å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†é‡è¦æ€§é¢„æµ‹å˜åŒ–
     */
    handleImportancePredictionChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ é‡è¦æ€§é¢„æµ‹çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    importancePrediction: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†é‡è¦æ€§é¢„æµ‹å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–
     */
    handleClassificationConfidenceThresholdChange(value) {
        try {
            console.log('[InfoBarSettings] ğŸ¯ åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–:', value);

            // æ›´æ–°æ˜¾ç¤ºå€¼
            const valueDisplay = this.modal.querySelector('#content-classification-confidence-value');
            if (valueDisplay) {
                valueDisplay.textContent = `${Math.round(value * 100)}%`;
            }

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    classificationConfidenceThreshold: parseFloat(value)
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†åˆ†ç±»ç½®ä¿¡åº¦é˜ˆå€¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¤– å¤„ç†è‡ªé€‚åº”å­¦ä¹ å˜åŒ–
     */
    handleAdaptiveLearningChange(enabled) {
        try {
            console.log('[InfoBarSettings] ğŸ§  è‡ªé€‚åº”å­¦ä¹ çŠ¶æ€å˜åŒ–:', enabled);

            // æ›´æ–°æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const infoBarTool = window.SillyTavernInfobar;
            const intelligentMemoryClassifier = infoBarTool?.modules?.intelligentMemoryClassifier;
            if (intelligentMemoryClassifier) {
                intelligentMemoryClassifier.updateSettings({
                    adaptationEnabled: enabled
                });
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†è‡ªé€‚åº”å­¦ä¹ å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶
     */
    bindMemoryEnhancementEvents() {
        try {
            // ğŸ¯ çŠ¶æ€åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshStatusBtn = this.modal.querySelector('#refresh-memory-status');
            if (refreshStatusBtn) {
                refreshStatusBtn.addEventListener('click', () => {
                    this.refreshMemoryStatus();
                });
            }

            // AIè®°å¿†æ€»ç»“äº‹ä»¶
            const memoryAiMemoryEnabled = this.modal.querySelector('#memory-ai-memory-enabled');
            if (memoryAiMemoryEnabled) {
                memoryAiMemoryEnabled.addEventListener('change', (e) => {
                    this.handleAIMemoryEnabledChange(e.target.checked);
                });
            }

            const memoryAiMessageLevel = this.modal.querySelector('#memory-ai-message-level-summary');
            if (memoryAiMessageLevel) {
                memoryAiMessageLevel.addEventListener('change', (e) => {
                    this.handleAIMessageLevelChange(e.target.checked);
                });
            }

            // è¯­ä¹‰æœç´¢äº‹ä»¶
            const memoryVectorizedEnabled = this.modal.querySelector('#memory-vectorized-memory-enabled');
            if (memoryVectorizedEnabled) {
                memoryVectorizedEnabled.addEventListener('change', (e) => {
                    this.handleVectorizedMemoryEnabledChange(e.target.checked);
                });
            }

            const memoryVectorEngine = this.modal.querySelector('#memory-vector-engine');
            if (memoryVectorEngine) {
                memoryVectorEngine.addEventListener('change', (e) => {
                    this.handleVectorEngineChange(e.target.value);
                });
            }

            // æ·±åº¦è®°å¿†ç®¡ç†äº‹ä»¶
            const memoryDeepMemoryEnabled = this.modal.querySelector('#memory-deep-memory-enabled');
            if (memoryDeepMemoryEnabled) {
                memoryDeepMemoryEnabled.addEventListener('change', (e) => {
                    this.handleDeepMemoryEnabledChange(e.target.checked);
                });
            }

            const memoryAutoMemoryMigration = this.modal.querySelector('#memory-auto-memory-migration');
            if (memoryAutoMemoryMigration) {
                memoryAutoMemoryMigration.addEventListener('change', (e) => {
                    this.handleAutoMemoryMigrationChange(e.target.checked);
                });
            }

            const memoryMemoryConflictResolution = this.modal.querySelector('#memory-memory-conflict-resolution');
            if (memoryMemoryConflictResolution) {
                memoryMemoryConflictResolution.addEventListener('change', (e) => {
                    this.handleMemoryConflictResolutionChange(e.target.checked);
                });
            }

            // æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨äº‹ä»¶
            const memoryIntelligentClassifierEnabled = this.modal.querySelector('#memory-intelligent-classifier-enabled');
            if (memoryIntelligentClassifierEnabled) {
                memoryIntelligentClassifierEnabled.addEventListener('change', (e) => {
                    this.handleIntelligentClassifierEnabledChange(e.target.checked);
                });
            }

            const memorySemanticClustering = this.modal.querySelector('#memory-semantic-clustering');
            if (memorySemanticClustering) {
                memorySemanticClustering.addEventListener('change', (e) => {
                    this.handleSemanticClusteringChange(e.target.checked);
                });
            }

            const memoryTemporalPatternRecognition = this.modal.querySelector('#memory-temporal-pattern-recognition');
            if (memoryTemporalPatternRecognition) {
                memoryTemporalPatternRecognition.addEventListener('change', (e) => {
                    this.handleTemporalPatternRecognitionChange(e.target.checked);
                });
            }

            const memoryImportancePrediction = this.modal.querySelector('#memory-importance-prediction');
            if (memoryImportancePrediction) {
                memoryImportancePrediction.addEventListener('change', (e) => {
                    this.handleImportancePredictionChange(e.target.checked);
                });
            }

            const memoryAdaptiveLearning = this.modal.querySelector('#memory-adaptive-learning');
            if (memoryAdaptiveLearning) {
                memoryAdaptiveLearning.addEventListener('change', (e) => {
                    this.handleAdaptiveLearningChange(e.target.checked);
                });
            }

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶ç»‘å®šå®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åŠ è½½è®°å¿†å¢å¼ºé¢æ¿è®¾ç½®ï¼ˆæ”¯æŒæ¨¡å—è®¾ç½®ä¸æ‰©å±•è®¾ç½®åŒæ¥æºï¼‰
     */
    async loadMemoryEnhancementSettings() {
        try {
            console.log('[InfoBarSettings] ğŸ“¥ åŠ è½½è®°å¿†å¢å¼ºè®¾ç½®...');

            const infoBarTool = window.SillyTavernInfobar;
            const summaryManager = infoBarTool?.modules?.summaryManager;
            const context = SillyTavern.getContext();
            const extCfg = context?.extensionSettings?.['Information bar integration tool'] || {};
            const savedMem = extCfg.memoryEnhancement || {};

            // ğŸš€ AIè®°å¿†æ€»ç»“è®¾ç½®
            const aiSettings = summaryManager?.aiMemorySummarizer?.settings || savedMem.ai || {};
            const aiEnabledEl = this.modal.querySelector('#memory-ai-memory-enabled');
            const aiMsgLevelEl = this.modal.querySelector('#memory-ai-message-level-summary');
            const aiThresholdEl = this.modal.querySelector('#memory-ai-importance-threshold');
            const aiThresholdVal = this.modal.querySelector('#memory-ai-importance-value');
            if (aiEnabledEl) aiEnabledEl.checked = !!aiSettings.enabled;
            if (aiMsgLevelEl) aiMsgLevelEl.checked = !!aiSettings.messageLevelSummary;
            if (aiThresholdEl) {
                const v = typeof aiSettings.importanceThreshold === 'number' ? aiSettings.importanceThreshold : parseFloat(aiThresholdEl.value) || 0.6;
                aiThresholdEl.value = v;
                if (aiThresholdVal) aiThresholdVal.textContent = `${Math.round(v * 100)}%`;
            }
            // æ˜¾ç¤º/éšè—AIè®°å¿†é€‰é¡¹
            this.modal.querySelectorAll('.ai-memory-options').forEach(opt => {
                opt.style.display = aiSettings.enabled ? 'block' : 'none';
            });

            // ğŸ” è¯­ä¹‰æœç´¢è®¾ç½®
            const vectorSettings = summaryManager?.vectorizedMemoryRetriever?.settings || savedMem.vector || {};
            const vecEnabledEl = this.modal.querySelector('#memory-vectorized-memory-enabled');
            const vecEngineEl = this.modal.querySelector('#memory-vector-engine');
            const vecSimEl = this.modal.querySelector('#memory-similarity-threshold');
            const vecSimVal = this.modal.querySelector('#memory-similarity-value');
            const vecMaxEl = this.modal.querySelector('#memory-max-search-results');
            if (vecEnabledEl) vecEnabledEl.checked = !!vectorSettings.enabled;
            if (vecEngineEl && vectorSettings.vectorEngine) vecEngineEl.value = vectorSettings.vectorEngine;
            if (vecSimEl) {
                const v = typeof vectorSettings.similarityThreshold === 'number' ? vectorSettings.similarityThreshold : parseFloat(vecSimEl.value) || 0.7;
                vecSimEl.value = v;
                if (vecSimVal) vecSimVal.textContent = `${Math.round(v * 100)}%`;
            }
            if (vecMaxEl && typeof vectorSettings.maxResults === 'number') vecMaxEl.value = vectorSettings.maxResults;
            this.modal.querySelectorAll('.vectorized-memory-options').forEach(opt => {
                opt.style.display = vectorSettings.enabled ? 'block' : 'none';
            });

            // ğŸ§  æ·±åº¦è®°å¿†ç®¡ç†è®¾ç½®
            const deepManager = infoBarTool?.modules?.deepMemoryManager;
            const deepSettings = deepManager?.settings || savedMem.deep || {};
            const deepEnabledEl = this.modal.querySelector('#memory-deep-memory-enabled');
            if (deepEnabledEl) deepEnabledEl.checked = !!deepSettings.enabled;
            this.modal.querySelectorAll('.deep-memory-options').forEach(opt => {
                opt.style.display = deepSettings.enabled ? 'block' : 'none';
            });
            const autoMigEl = this.modal.querySelector('#memory-auto-memory-migration');
            const memImpEl = this.modal.querySelector('#memory-memory-importance-threshold');
            const memImpVal = this.modal.querySelector('#memory-memory-importance-value');
            const confResEl = this.modal.querySelector('#memory-memory-conflict-resolution');
            const capSens = this.modal.querySelector('#memory-sensory-capacity');
            const capShort = this.modal.querySelector('#memory-short-term-capacity');
            const capLong = this.modal.querySelector('#memory-long-term-capacity');
            const capArchive = this.modal.querySelector('#memory-deep-archive-capacity');
            if (autoMigEl) autoMigEl.checked = !!deepSettings.autoMemoryMigration;
            if (memImpEl) {
                const v = typeof deepSettings.memoryImportanceThreshold === 'number' ? deepSettings.memoryImportanceThreshold : parseFloat(memImpEl.value) || 0.6;
                memImpEl.value = v;
                if (memImpVal) memImpVal.textContent = `${Math.round(v * 100)}%`;
            }
            if (confResEl) confResEl.checked = !!deepSettings.memoryConflictResolution;
            if (capSens && deepSettings.capacities?.sensory) capSens.value = deepSettings.capacities.sensory;
            if (capShort && deepSettings.capacities?.shortTerm) capShort.value = deepSettings.capacities.shortTerm;
            if (capLong && deepSettings.capacities?.longTerm) capLong.value = deepSettings.capacities.longTerm;
            if (capArchive && deepSettings.capacities?.deepArchive) capArchive.value = deepSettings.capacities.deepArchive;

            // ğŸ¤– æ™ºèƒ½è®°å¿†åˆ†ç±»å™¨è®¾ç½®
            const clf = infoBarTool?.modules?.intelligentMemoryClassifier;
            const clfSettings = clf?.settings || savedMem.classifier || {};
            const clfEnabledEl = this.modal.querySelector('#memory-intelligent-classifier-enabled');
            if (clfEnabledEl) clfEnabledEl.checked = !!clfSettings.enabled;
            this.modal.querySelectorAll('.intelligent-classifier-options').forEach(opt => {
                opt.style.display = clfSettings.enabled ? 'block' : 'none';
            });
            const semClus = this.modal.querySelector('#memory-semantic-clustering');
            const tmpRec = this.modal.querySelector('#memory-temporal-pattern-recognition');
            const impPred = this.modal.querySelector('#memory-importance-prediction');
            const clfConf = this.modal.querySelector('#memory-classification-confidence-threshold');
            const clfConfVal = this.modal.querySelector('#memory-classification-confidence-value');
            const adapLearn = this.modal.querySelector('#memory-adaptive-learning');
            if (semClus) semClus.checked = !!clfSettings.semanticClustering;
            if (tmpRec) tmpRec.checked = !!clfSettings.temporalPatternRecognition;
            if (impPred) impPred.checked = !!clfSettings.importancePrediction;
            if (clfConf) {
                const v = typeof clfSettings.classificationConfidenceThreshold === 'number' ? clfSettings.classificationConfidenceThreshold : parseFloat(clfConf.value) || 0.7;
                clfConf.value = v;
                if (clfConfVal) clfConfVal.textContent = `${Math.round(v * 100)}%`;
            }
            if (adapLearn) adapLearn.checked = !!clfSettings.adaptationEnabled;

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºè®¾ç½®åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½è®°å¿†å¢å¼ºè®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹
     */
    initMemoryEnhancementPanelContent() {
        try {
            console.log('[InfoBarSettings] ğŸ§  åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool) {
                console.warn('[InfoBarSettings] âš ï¸ InfoBarå·¥å…·æœªæ‰¾åˆ°');
                return;
            }

            // åŠ è½½å½“å‰è®¾ç½®
            this.loadMemoryEnhancementSettings();

            // ç»‘å®šè®°å¿†å¢å¼ºé¢æ¿äº‹ä»¶
            this.bindMemoryEnhancementEvents();

            // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
            this.refreshMemoryStatus();

            console.log('[InfoBarSettings] âœ… è®°å¿†å¢å¼ºé¢æ¿å†…å®¹åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆå§‹åŒ–è®°å¿†å¢å¼ºé¢æ¿å†…å®¹å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
     */
    async refreshMemoryStatus() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€...');

            const infoBarTool = window.SillyTavernInfobar;
            if (!infoBarTool) {
                console.warn('[InfoBarSettings] âš ï¸ InfoBarå·¥å…·æœªæ‰¾åˆ°');
                return;
            }

            // è·å–å„æ¨¡å—çŠ¶æ€
            const deepMemoryManager = infoBarTool.modules?.deepMemoryManager;
            const aiMemorySummarizer = infoBarTool.modules?.summaryManager?.aiMemorySummarizer;
            const vectorizedMemoryRetrieval = infoBarTool.modules?.vectorizedMemoryRetrieval;
            const intelligentMemoryClassifier = infoBarTool.modules?.intelligentMemoryClassifier;
            const aiMemoryDatabaseInjector = infoBarTool.modules?.aiMemoryDatabaseInjector;

            // æ›´æ–°å››å±‚è®°å¿†æ¶æ„çŠ¶æ€
            if (deepMemoryManager) {
                const status = deepMemoryManager.getStatus();
                this.updateMemoryLayerStatus('sensory', status);
                this.updateMemoryLayerStatus('shortTerm', status);
                this.updateMemoryLayerStatus('longTerm', status);
                this.updateMemoryLayerStatus('deepArchive', status);
            }

            // æ›´æ–°æ¨¡å—çŠ¶æ€
            if (aiMemorySummarizer) {
                const status = aiMemorySummarizer.getStatus();
                this.updateModuleStatus('aiSummarizer', status);
            }

            if (vectorizedMemoryRetrieval) {
                const status = vectorizedMemoryRetrieval.getStatus();
                this.updateModuleStatus('vectorSearch', status);
            }

            if (intelligentMemoryClassifier) {
                const status = intelligentMemoryClassifier.getStatus();
                this.updateModuleStatus('classifier', status);
            }

            if (aiMemoryDatabaseInjector) {
                const status = aiMemoryDatabaseInjector.getStatus();
                this.updateModuleStatus('injector', status);
            }

            console.log('[InfoBarSettings] âœ… è®°å¿†ç³»ç»ŸçŠ¶æ€åˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°è®°å¿†ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ¯ æ›´æ–°è®°å¿†å±‚çŠ¶æ€æ˜¾ç¤º
     */
    updateMemoryLayerStatus(layerName, status) {
        try {
            const layerData = status.memoryLayers?.[layerName];
            const stats = status.stats || {};
            const settings = status.settings || {};

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector(`#${layerName === 'shortTerm' ? 'shortterm' : layerName === 'longTerm' ? 'longterm' : layerName === 'deepArchive' ? 'archive' : layerName}-status`);
            if (statusElement) {
                const isActive = status.initialized && !status.isProcessing;
                statusElement.className = `layer-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°å…·ä½“æ•°æ®
            switch (layerName) {
                case 'sensory':
                    this.updateElement('#sensory-count', layerData || 0);
                    this.updateElement('#sensory-capacity', `${layerData || 0}/${settings.sensoryMemoryCapacity || 100}`);
                    break;
                case 'shortTerm':
                    this.updateElement('#shortterm-count', layerData || 0);
                    this.updateElement('#shortterm-importance', `${Math.round((stats.averageImportance || 0) * 100)}%`);
                    break;
                case 'longTerm':
                    this.updateElement('#longterm-count', layerData || 0);
                    this.updateElement('#longterm-migrations', stats.memoryMigrations || 0);
                    break;
                case 'deepArchive':
                    this.updateElement('#archive-count', layerData || 0);
                    this.updateElement('#archive-compression', `${Math.round((stats.compressionRatio || 0) * 100)}%`);
                    break;
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°è®°å¿†å±‚çŠ¶æ€å¤±è´¥ (${layerName}):`, error);
        }
    }

    /**
     * ğŸ¯ æ›´æ–°æ¨¡å—çŠ¶æ€æ˜¾ç¤º
     */
    updateModuleStatus(moduleName, status) {
        try {
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusElement = this.modal.querySelector(`#${moduleName === 'aiSummarizer' ? 'ai-summarizer' : moduleName === 'vectorSearch' ? 'vector-search' : moduleName}-status`);
            if (statusElement) {
                const isActive = status.initialized && !status.isProcessing;
                statusElement.className = `module-status ${isActive ? 'active' : status.errorCount > 0 ? 'error' : 'inactive'}`;
            }

            // æ›´æ–°å…·ä½“æ•°æ®
            switch (moduleName) {
                case 'aiSummarizer':
                    this.updateElement('#ai-summarizer-queue', status.queueLength || 0);
                    this.updateElement('#ai-summarizer-cache', status.cacheSize || 0);
                    break;
                case 'vectorSearch':
                    this.updateElement('#vector-search-index', status.indexSize || 0);
                    // ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—å‘½ä¸­ç‡
                    let hitRate = 0;
                    if (status.stats) {
                        const cacheHits = status.stats.cacheHits || 0;
                        const cacheMisses = status.stats.cacheMisses || 0;
                        const totalRequests = cacheHits + cacheMisses;
                        hitRate = totalRequests > 0 ? Math.round((cacheHits / totalRequests) * 100) : 0;
                    }
                    this.updateElement('#vector-search-hitrate', `${hitRate}%`);
                    break;
                case 'classifier':
                    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                    this.updateElement('#classifier-count', status.stats?.totalClassifications || 0);
                    this.updateElement('#classifier-confidence', `${Math.round((status.stats?.averageConfidence || 0) * 100)}%`);
                    break;
                case 'injector':
                    this.updateElement('#injector-count', status.stats?.totalInjections || 0);
                    this.updateElement('#injector-errors', status.errorCount || 0);
                    break;
            }

        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°æ¨¡å—çŠ¶æ€å¤±è´¥ (${moduleName}):`, error);
        }
    }

    /**
     * ğŸ¯ æ›´æ–°DOMå…ƒç´ å†…å®¹
     */
    updateElement(selector, value) {
        try {
            const element = this.modal.querySelector(selector);
            if (element) {
                element.textContent = value;
            }
        } catch (error) {
            console.error(`[InfoBarSettings] âŒ æ›´æ–°å…ƒç´ å¤±è´¥ (${selector}):`, error);
        }
    }

    /**
     * ğŸ§  å¤„ç†æç¤ºè¯æ¨¡å¼å˜åŒ–
     */
    handlePromptModeChange(mode) {
        try {
            console.log('[InfoBarSettings] ğŸ§  æç¤ºè¯æ¨¡å¼å˜åŒ–:', mode);

            const smartConfig = this.modal.querySelector('#smart-prompt-config');
            const customConfig = this.modal.querySelector('#custom-prompt-config');

            if (mode === 'smart') {
                // æ˜¾ç¤ºæ™ºèƒ½æç¤ºè¯é…ç½®ï¼Œéšè—è‡ªå®šä¹‰æç¤ºè¯é…ç½®
                if (smartConfig) smartConfig.style.display = 'block';
                if (customConfig) customConfig.style.display = 'none';

                // å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                this.enableSmartPromptSystem();

                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°æ™ºèƒ½æç¤ºè¯æ¨¡å¼');
            } else if (mode === 'custom') {
                // éšè—æ™ºèƒ½æç¤ºè¯é…ç½®ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºè¯é…ç½®
                if (smartConfig) smartConfig.style.display = 'none';
                if (customConfig) customConfig.style.display = 'block';

                // ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                this.disableSmartPromptSystem();

                console.log('[InfoBarSettings] âœ… å·²åˆ‡æ¢åˆ°è‡ªå®šä¹‰æç¤ºè¯æ¨¡å¼');
            }

            // ä¿å­˜è®¾ç½®
            this.savePromptSettings();

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¤„ç†æç¤ºè¯æ¨¡å¼å˜åŒ–å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
     */
    enableSmartPromptSystem() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (smartPromptSystem) {
                // é‡æ–°å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                smartPromptSystem.enabled = true;
                console.log('[InfoBarSettings] âœ… æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå·²å¯ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ å¯ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
     */
    disableSmartPromptSystem() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (smartPromptSystem) {
                // ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ
                smartPromptSystem.enabled = false;
                console.log('[InfoBarSettings] âš ï¸ æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå·²ç¦ç”¨');
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç¦ç”¨æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿå¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  æ›´æ–°è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡ä¿¡æ¯
     */
    updateCustomPromptStats() {
        try {
            const textarea = this.modal.querySelector('#custom-prompt-content');
            if (!textarea) return;

            const content = textarea.value;
            const charCount = content.length;
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lineCount = content.split('\n').length;

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            const charCountSpan = this.modal.querySelector('#custom-prompt-char-count');
            const wordCountSpan = this.modal.querySelector('#custom-prompt-word-count');
            const lineCountSpan = this.modal.querySelector('#custom-prompt-line-count');

            if (charCountSpan) charCountSpan.textContent = charCount;
            if (wordCountSpan) wordCountSpan.textContent = wordCount;
            if (lineCountSpan) lineCountSpan.textContent = lineCount;

        } catch (error) {
            console.error('[InfoBarSettings] âŒ æ›´æ–°è‡ªå®šä¹‰æç¤ºè¯ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åˆ·æ–°æç¤ºè¯é¢„è§ˆ
     */
    async refreshPromptPreview() {
        try {
            console.log('[InfoBarSettings] ğŸ”„ åˆ·æ–°æç¤ºè¯é¢„è§ˆ...');

            const previewContainer = this.modal.querySelector('#prompt-preview');
            const statusSpan = this.modal.querySelector('#preview-status');

            if (!previewContainer) return;

            // æ›´æ–°çŠ¶æ€
            if (statusSpan) statusSpan.textContent = 'ç”Ÿæˆä¸­...';

            // è·å–å½“å‰æç¤ºè¯æ¨¡å¼
            const modeRadio = this.modal.querySelector('input[name="promptSettings.mode"]:checked');
            const mode = modeRadio ? modeRadio.value : 'smart';

            let previewContent = '';

            if (mode === 'smart') {
                // ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆ
                previewContent = await this.generateSmartPromptPreview();
            } else {
                // è·å–è‡ªå®šä¹‰æç¤ºè¯å†…å®¹
                const customContent = this.modal.querySelector('#custom-prompt-content')?.value || '';
                previewContent = customContent || 'æš‚æ— è‡ªå®šä¹‰æç¤ºè¯å†…å®¹';
            }

            // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
            previewContainer.innerHTML = `
                <div class="prompt-preview-content">
                    <pre>${this.escapeXML(previewContent)}</pre>
                </div>
            `;

            // æ›´æ–°çŠ¶æ€
            if (statusSpan) statusSpan.textContent = 'é¢„è§ˆå·²æ›´æ–°';

            console.log('[InfoBarSettings] âœ… æç¤ºè¯é¢„è§ˆåˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åˆ·æ–°æç¤ºè¯é¢„è§ˆå¤±è´¥:', error);

            const statusSpan = this.modal.querySelector('#preview-status');
            if (statusSpan) statusSpan.textContent = 'é¢„è§ˆå¤±è´¥';
        }
    }

    /**
     * ğŸ§  ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆï¼ˆä¸åŒ…å«æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼‰
     */
    async generateSmartPromptPreview() {
        try {
            const infoBarTool = window.SillyTavernInfobar;
            const smartPromptSystem = infoBarTool?.modules?.smartPromptSystem;

            if (!smartPromptSystem) {
                return 'æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿæœªåˆå§‹åŒ–';
            }

            // ç”Ÿæˆå®Œæ•´çš„æ™ºèƒ½æç¤ºè¯
            const fullSmartPrompt = await smartPromptSystem.generateSmartPrompt();

            if (fullSmartPrompt) {
                // ç§»é™¤æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼Œåªæ˜¾ç¤ºæç¤ºè¯æ¨¡æ¿
                const previewPrompt = this.removeDataStatusFromPrompt(fullSmartPrompt);
                return previewPrompt || 'æ™ºèƒ½æç¤ºè¯æ¨¡æ¿ï¼ˆä¸åŒ…å«æ•°æ®çŠ¶æ€éƒ¨åˆ†ï¼‰';
            } else {
                return 'æš‚æ— æ™ºèƒ½æç¤ºè¯å†…å®¹ï¼ˆå¯èƒ½æ²¡æœ‰å¯ç”¨çš„é¢æ¿æˆ–æ•°æ®ï¼‰';
            }

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆå¤±è´¥:', error);
            return 'ç”Ÿæˆæ™ºèƒ½æç¤ºè¯é¢„è§ˆæ—¶å‡ºé”™: ' + error.message;
        }
    }

    /**
     * ğŸ§  ä»æç¤ºè¯ä¸­ç§»é™¤åœ¨é¢„è§ˆä¸­ä¸æ˜¾ç¤ºçš„éšè—éƒ¨åˆ†
     * - ã€ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç»Ÿä¸€è¡Œè§†å›¾ï¼‰ã€‘...ã€ğŸ¤– AIç”ŸæˆæŒ‡å¯¼ã€‘ï¼ˆAIè®°å¿†å¢å¼ºæ•°æ®æ•´ä½“å—ï¼‰
     * - ğŸ” ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨ï¼ˆå¿…é¡»è¡¥å……ï¼‰ å—
     */
    removeDataStatusFromPrompt(fullPrompt) {
        try {
            let result = fullPrompt;

            // 1) ç§»é™¤ AIè®°å¿†å¢å¼ºæ•°æ®æ•´ä½“å—ï¼ˆåŒ…å«æ•°æ®çŠ¶æ€ã€å†å²/æŒä¹…åŒ–/ä¸Šä¸‹æ–‡è®°å¿†ç­‰ï¼‰
            const dataStatusStart = result.indexOf('ã€ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€ï¼ˆç»Ÿä¸€è¡Œè§†å›¾ï¼‰ã€‘');
            if (dataStatusStart !== -1) {
                // å¯»æ‰¾AIè®°å¿†å¢å¼ºå—çš„ç»“æŸä½ç½®ï¼ˆåŒ…æ‹¬ã€ğŸ¤– AIç”ŸæˆæŒ‡å¯¼ã€‘ä¹‹åçš„å†…å®¹ï¼‰
                const possibleEnds = [
                    'ğŸ” **ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨',
                    'ã€ğŸ”„ å¢é‡æ•°æ®è¡¥å…… - é‡è¦ã€‘',
                    'ã€ğŸ“‹ è¾“å‡ºå®Œæ•´æ€§æ£€æŸ¥æ¸…å•ã€‘',
                    'ğŸ’¥ğŸ’¥ğŸ’¥ **æœ€ç»ˆæ‰§è¡Œæ£€æŸ¥æ¸…å•**',
                    'ã€å½“å‰è¡Œç´¢å¼•æç¤ºã€‘',
                    '\n\nã€', // ä¸‹ä¸€ä¸ªå¤§æ ‡é¢˜
                ];

                let endIndex = -1;
                for (const endMarker of possibleEnds) {
                    const idx = result.indexOf(endMarker, dataStatusStart);
                    if (idx !== -1) {
                        if (endIndex === -1 || idx < endIndex) {
                            endIndex = idx;
                        }
                    }
                }

                if (endIndex !== -1) {
                    const beforeData = result.substring(0, dataStatusStart);
                    const afterData = result.substring(endIndex);
                    result = (beforeData + afterData).trim();
                } else {
                    result = result.substring(0, dataStatusStart).trim();
                }
            }

            // 2) é¢å¤–ç§»é™¤ â€œç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨ï¼ˆå¿…é¡»è¡¥å……ï¼‰â€ å—
            const missingTitle = 'ç¼ºå¤±å­—æ®µè¯¦ç»†åˆ—è¡¨';
            let missingStart = result.indexOf(missingTitle);
            if (missingStart !== -1) {
                // å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯èƒ½çš„åˆ†æ®µèµ·å§‹æ ‡è®°ï¼ˆä¸‹ä¸€ä¸ªå¤§æ ‡é¢˜/åŒºå—ï¼‰
                const markers = [
                    '\nã€', // ä¸‹ä¸€æ®µä»¥ã€ å¼€å¤´çš„å¤§æ ‡é¢˜
                    'ã€',   // å…œåº•ï¼šä»»æ„ã€ å¼€å¤´
                    'ğŸ’¥ğŸ’¥ğŸ’¥', // æœ€ç»ˆæ£€æŸ¥æ¸…å•æ ‡é¢˜
                    'ã€ğŸ“‹ è¾“å‡ºå®Œæ•´æ€§æ£€æŸ¥æ¸…å•ã€‘',
                    '\n\nã€',
                ];
                let nextIndex = -1;
                for (const m of markers) {
                    const idx = result.indexOf(m, missingStart + 1);
                    if (idx !== -1) {
                        if (nextIndex === -1 || idx < nextIndex) nextIndex = idx;
                    }
                }

                if (nextIndex !== -1) {
                    result = (result.substring(0, missingStart) + result.substring(nextIndex)).trim();
                } else {
                    // æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªåˆ†æ®µæ ‡è®°ï¼Œåˆ™æˆªæ–­åˆ°æœ«å°¾
                    result = result.substring(0, missingStart).trim();
                }
            }

            return result;
        } catch (error) {
            console.error('[InfoBarSettings] âŒ è¿‡æ»¤é¢„è§ˆéšè—éƒ¨åˆ†å¤±è´¥:', error);
            return fullPrompt;
        }
    }

    /**
     * ğŸ§  ä¿å­˜æç¤ºè¯è®¾ç½®
     */
    async savePromptSettings() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};

            // è·å–å½“å‰è®¾ç½®
            const modeRadio = this.modal.querySelector('input[name="promptSettings.mode"]:checked');
            const mode = modeRadio ? modeRadio.value : 'smart';
            const customContent = this.modal.querySelector('#custom-prompt-content')?.value || '';

            // ä¿å­˜è®¾ç½®
            configs.promptSettings = {
                mode: mode,
                customContent: customContent
            };

            // ä¿å­˜åˆ°SillyTavern
            extensionSettings['Information bar integration tool'] = configs;

            // ä½¿ç”¨configManagerä¿å­˜é…ç½®
            if (this.configManager && typeof this.configManager.setConfig === 'function') {
                await this.configManager.setConfig('promptSettings', configs.promptSettings);
            }

            // ä½¿ç”¨SillyTavernçš„ä¿å­˜æœºåˆ¶
            if (typeof saveSettingsDebounced === 'function') {
                saveSettingsDebounced();
            }

            console.log('[InfoBarSettings] âœ… æç¤ºè¯è®¾ç½®å·²ä¿å­˜:', { mode, customContentLength: customContent.length });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ ä¿å­˜æç¤ºè¯è®¾ç½®å¤±è´¥:', error);
        }
    }

    /**
     * ğŸ§  åŠ è½½æç¤ºè¯è®¾ç½®
     */
    async loadPromptSettings() {
        try {
            const context = SillyTavern.getContext();
            const extensionSettings = context.extensionSettings;
            const configs = extensionSettings['Information bar integration tool'] || {};
            const promptSettings = configs.promptSettings || {};

            // è®¾ç½®é»˜è®¤å€¼
            const mode = promptSettings.mode || 'smart';
            const customContent = promptSettings.customContent || '';

            // æ›´æ–°UI
            const smartRadio = this.modal.querySelector('#smart-prompt-mode');
            const customRadio = this.modal.querySelector('#custom-prompt-mode');
            const customTextarea = this.modal.querySelector('#custom-prompt-content');

            if (smartRadio && customRadio) {
                if (mode === 'smart') {
                    smartRadio.checked = true;
                } else {
                    customRadio.checked = true;
                }
            }

            if (customTextarea) {
                customTextarea.value = customContent;
            }

            // è§¦å‘æ¨¡å¼å˜åŒ–å¤„ç†
            this.handlePromptModeChange(mode);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            this.updateCustomPromptStats();

            console.log('[InfoBarSettings] âœ… æç¤ºè¯è®¾ç½®å·²åŠ è½½:', { mode, customContentLength: customContent.length });

        } catch (error) {
            console.error('[InfoBarSettings] âŒ åŠ è½½æç¤ºè¯è®¾ç½®å¤±è´¥:', error);
        }
    }
}